<!DOCTYPE html>












  


<html class="theme-next muse use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>
<link href="//cdn.bootcss.com/pace/1.0.2/themes/pink/pace-theme-flash.css" rel="stylesheet">
<style>
    .pace .pace-progress {
        background: #1E92FB; /*进度条颜色*/
        height: 3px;
    }
    .pace .pace-progress-inner {
         box-shadow: 0 0 10px #1E92FB, 0 0 5px     #1E92FB; /*阴影颜色*/
    }
    .pace .pace-activity {
        border-top-color: #1E92FB;    /*上边框颜色*/
        border-left-color: #1E92FB;    /*左边框颜色*/
    }
</style>
<meta name="theme-color" content="#222">




  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link rel="stylesheet" href="/lib/pace/pace-theme-pace-theme-minimal.min.css?v=1.0.2">



















<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.7.0">

<link rel="stylesheet" href="/css/main.css?v=7.2.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.2.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.2.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.2.0">


  <link rel="mask-icon" href="/images/logo.svg?v=7.2.0" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '7.2.0',
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":false},
    copycode: {"enable":false,"show_result":false,"style":null},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    translation: {
      copy_button: '复制',
      copy_success: '复制成功',
      copy_failure: '复制失败'
    }
  };
</script>

  <meta property="og:type" content="website">
<meta property="og:title" content="itw">
<meta property="og:url" content="http://aiwhs.github.io/index.html">
<meta property="og:site_name" content="itw">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="itw">



  <link rel="alternate" href="/atom.xml" title="itw" type="application/atom+xml">



  
  
  <link rel="canonical" href="http://aiwhs.github.io/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  
  <title>itw</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>
    <a href="https://github.com/aiwhs" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewbox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; left: 0; transform: scale(-1, 1);" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"/><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"/><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"/></svg><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style></a>
	
    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">itw</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home menu-item-active">

    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>

  </li>

      
      
    </ul>
  

  
    

  

  
</nav>



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://aiwhs.github.io/2019/03/03/CentOS 7.6+NFS+Heartbeat+DRBD/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="itw">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="itw">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/03/03/CentOS 7.6+NFS+Heartbeat+DRBD/" class="post-title-link" itemprop="url">CentOS 7.6+NFS+Heartbeat+DRBD</a>
              
            
          </h1>
        

        <div class="post-meta">

          
          
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-03-03 08:15:57" itemprop="dateCreated datePublished" datetime="2019-03-03T08:15:57+08:00">2019-03-03</time>
            </span>
          

          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-07-17 21:24:00" itemprop="dateModified" datetime="2019-07-17T21:24:00+08:00">2019-07-17</time>
              </span>
            
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Linux运维/" itemprop="url" rel="index"><span itemprop="name">Linux运维</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          <br>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <a id="more"></a>



<h2 id="理论概述"><a href="#理论概述" class="headerlink" title="理论概述"></a>理论概述</h2><p><strong>本案例只是，为搭建MySQL集群做准备，并无MySQL</strong></p>
<h3 id="DRBD"><a href="#DRBD" class="headerlink" title="DRBD"></a>DRBD</h3><p><strong>DRBD（distributed replicated block device分布式复制块设备）是一个基于软件实现的、无共享的、服务器之间镜像块设备内容的存储复制解决方案。DRBD是镜像块设备，是按数据位镜像成一样的数据块</strong></p>
<p>DRBD可以部署在如下类的底层设备上：</p>
<p> 1、一个磁盘，或者是磁盘的某一个分区；</p>
<p> 2、一个soft raid 设备；</p>
<p> 3、一个LVM的逻辑卷；</p>
<p> 4、一个EVMS（Enterprise Volume Management System，企业卷管理系统）的卷；</p>
<p> 5、其他任何的块设备。</p>
<p><strong>工作原理</strong></p>
<p><img src="../../img/19051714132885.jpg" alt="CentOS 7.6数据库架构之NFS+Heartbeat+DRBD实测"></p>
<p>DRBD需要运行在各个节点上，且是运行在节点主机的内核中，所以DRBD是内核模块，在Linux2.6.33版本起开始整合进内核。</p>
<p><strong>DRBD工作的位置在文件系统的buffer Cache和磁盘调度器之间</strong></p>
<p>如上图左节点为活跃节点实线箭头，有节点为备用节点虚线箭头。 左节点接收到数据法网内核的数据通路，DRBD在数据通路中注册钩子检查数据（类似ipvs）当检测到接收的数据是发往自己管理的存储位置，程序会复制另一份，一份存储到本机的DRBD存储设备，另一份就发给TCP/IP协议栈，通过网络传输到另一台节点上TCP/IP协议栈；另一台节点上运行的DRBD模块同样在数据通路上监测数据，当检测到传输过来的数据时，运行存储机制，存储到本机DRBD存储设备的对应位置。</p>
<p><strong>如果左节点宕机，在高可用集群中右节点成为活跃节点，并且会接收到左节点宕机的信号，接受数据先保存到本地，左节点恢复上线之后，再把左节点宕机后右节点变动的 数据镜像到左节点。 每个设备（drbd 提供了不止一个设备）都有一个状态，可能是‘主’状态或‘从’态。在主节点上，应用程序应能运行和访问drbd设备（/dev/drbd）。每次写入会发往本地磁盘设备和从节点设备中。从节点只能简单地把数据写入它的磁盘设上。 读取数据通常在本地进行。如果主节点发生故障，心跳（heartbeat或corosync）将会把从节点转换到主状态，并启动其上的应用程序。（如果您将它和无日志FS 一起使用，则需要运行fsck）。如果发生故障的节点恢复工作，它就会成为新的从节点，而且必须使自己的内容与主节点的内容保持同步。</strong></p>
<p><strong>复制模式</strong> 镜像过程完成之后还需要返回成功或失败的回应信息。回应信息可以在传输过程中的不同位置返回，如上图A/B/C三处， 可以分为三种复制模式：</p>
<blockquote>
<p><strong>特点： 实时复制：一段修改之后马上复制过去 透明的传输：程序不需要检测到这个数据存储在多个主机上 同步或者异步：同步镜像：程序写操作完成后会通知所有已经连接的主机；异步同步：程序会在本地写完之前通知其它的主机。</strong></p>
</blockquote>
<blockquote>
<p>A:一旦本地磁盘写入已经完成，数据包已在发送队列中，则写操作被认为是完成的 。在一个节点发生故障时，可能发生数据丢失，因为被写入到远程节点上的数据可能仍在发送队列。尽管，在故障转移节点上的数据是一致的，但没有及时更新。这通常是用于地理上分开的节点。</p>
<p>  B:一旦本地磁盘写入已完成且复制数据包达到了对等节点则认为写操作在主节点上被认为是完成的。数据丢失可能发生在参加的两个节点同时故障的情况下，因为在飞行中的数据可能不会被提交到磁盘。 </p>
<p>  C:只有在本地和远程节点的磁盘已经确认了写操作完成，写才被认为完成。没有任何数据丢失，所以这是一个群集节点的流行模式，但I/O吞吐量依赖于网络带宽。 A 数据一旦写入磁盘并发送到网络中就认为完成了写入操作。 B 收到接收确认就认为完成了写入操作。 C 收到写入确认就认为完成了写入操作。 就目前而言应用最多和应用最广泛的为协议C。</p>
</blockquote>
<h3 id="架构"><a href="#架构" class="headerlink" title="架构"></a>架构</h3><p><strong>MySQL+heartbeat+drbd+lvs是一套成熟的集群解决方案在现在多数企业里面，通过heartbeat+DRBD完成MySQL的主节点写操作的高可用性，通过MySQL+lvs实现MySQL数据库的主从复制和MySQL读写的负载均衡。这个方案在读写方面进行了分离，融合了写操作的高可用和读操作的负载均衡。</strong></p>
<h3 id="NFS"><a href="#NFS" class="headerlink" title="NFS"></a>NFS</h3><p><strong>NFS作为业界常用的共享存储方案，被众多公司采用。使用NFS作为共享存储，为前端WEB server提供服务，主要存储网页代码以及其他文件。</strong></p>
<ul>
<li>常用同步技术</li>
</ul>
<ol>
<li>rsync+inotify实现文件同步</li>
<li>借助DRBD，实现文件同步<br>但是以上方案都没有实现高可用，只是实现了两者数据同步。但是业务要求NFS服务器必须是高可用，所以我们在第二种同步方案的基础上，在结合heartbeat来实现高可用。</li>
</ol>
<h2 id="架构部署"><a href="#架构部署" class="headerlink" title="架构部署"></a>架构部署</h2><p>采用MySQL读写分离的方案；而读写之间的数据同步采用MySQL的单项或者双向复制技术实现。 MySQL写操作采用基于heartbeat+DRBD+MySQL搭建高可用集群；读操作普遍采用基于LVS+keepalived搭建高可用扩展集群方案</p>
<p><strong>本案例中暂时没部署MySQL，实现思路：ct74和ct75两台机器，分别安装nfs，heartbeat，ct74，DRBD。</strong></p>
<ul>
<li>nfs可以另找一台服务器搭建专门用为共享存储。</li>
<li>nfs的控制权交给了heartbeat。</li>
</ul>
<p>架构拓扑</p>
<p><img src="../../img/19051714146047.png" alt="CentOS 7.6数据库架构之NFS+Heartbeat+DRBD实测"></p>
<p><strong>环境</strong> 全部都是CentOS7.6 系统</p>
<table>
<thead>
<tr>
<th>主机名</th>
<th>IP</th>
<th align="center">担任角色</th>
</tr>
</thead>
<tbody><tr>
<td>ct74</td>
<td>192.168.137.74</td>
<td align="center">drbd主，nfs server，heartbeat主</td>
</tr>
<tr>
<td>ct75</td>
<td>192.168.137.75</td>
<td align="center">drbd被，heartbeat被</td>
</tr>
<tr>
<td>VIP</td>
<td>192.168.137.82</td>
<td align="center"></td>
</tr>
<tr>
<td>nfs客户端</td>
<td>192.168.137.61</td>
<td align="center">挂载VIP共享的目录测试</td>
</tr>
</tbody></table>
<h3 id="部署DRBD"><a href="#部署DRBD" class="headerlink" title="部署DRBD"></a>部署DRBD</h3><ol>
<li>所有主机配置hosts并且改为对应的主机名</li>
<li>所有主机保持网络状况的良好通信</li>
<li>所有主机安装最新的epel源</li>
<li>DRBD这两台各自分别添加了1GB硬盘供DRBD使用</li>
<li>同步时间</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root@ct74 ~]# vim /etc/hosts</span><br><span class="line">192.168.137.74 ct74</span><br><span class="line">192.168.137.75 ct75</span><br><span class="line"></span><br><span class="line">[root@ct74 ~]# ssh-keygen -q -t rsa -N &apos;&apos; -f ~/.ssh/id_rsa</span><br><span class="line">[root@ct74 ~]# ssh-copy-id root@ct75</span><br><span class="line">#ssh免密认证</span><br><span class="line"></span><br><span class="line">[root@ct74 ~]# uname -r</span><br><span class="line">3.10.0-957.21.3.el7.x86_64</span><br><span class="line">#要是这个957版本以后的,若不是,请升级(yum update kernel* -y)然后reboot</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@ct75 ~]# yum install https://www.elrepo.org/elrepo-release-7.0-3.el7.elrepo.noarch.rpm -y</span><br><span class="line"></span><br><span class="line">[root@ct75 ~]# yum -y install drbd84-utils kmod-drbd84</span><br><span class="line">#安装DRBD</span><br><span class="line">[root@ct75 ~]# modprobe drbd</span><br><span class="line">#不出意外这样就OK了</span><br><span class="line">echo &quot;modprobe drbd&quot;&gt;&gt;/etc/rc.local    # 加入开机自启动</span><br><span class="line">chmod +x /etc/rc.d/rc.local</span><br><span class="line">[root@ct75 ~]# lsmod |grep -i drbd</span><br><span class="line">drbd                  397041  0 </span><br><span class="line">libcrc32c              12644  4 xfs,drbd,nf_nat,nf_conntrack</span><br></pre></td></tr></table></figure>

<ul>
<li>分区</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[root@ct75 ~]# fdisk /dev/sdb</span><br><span class="line">欢迎使用 fdisk (util-linux 2.23.2)。</span><br><span class="line"></span><br><span class="line">更改将停留在内存中，直到您决定将更改写入磁盘。</span><br><span class="line">使用写入命令前请三思。</span><br><span class="line"></span><br><span class="line">Device does not contain a recognized partition table</span><br><span class="line">使用磁盘标识符 0x7ce5781e 创建新的 DOS 磁盘标签。</span><br><span class="line"></span><br><span class="line">命令(输入 m 获取帮助)：n</span><br><span class="line">Partition type:</span><br><span class="line">   p   primary (0 primary, 0 extended, 4 free)</span><br><span class="line">   e   extended</span><br><span class="line">Select (default p): p</span><br><span class="line">分区号 (1-4，默认 1)：</span><br><span class="line">起始 扇区 (2048-2097151，默认为 2048)：</span><br><span class="line">将使用默认值 2048</span><br><span class="line">Last 扇区, +扇区 or +size&#123;K,M,G&#125; (2048-2097151，默认为 2097151)：</span><br><span class="line">将使用默认值 2097151</span><br><span class="line">分区 1 已设置为 Linux 类型，大小设为 1023 MiB</span><br><span class="line"></span><br><span class="line">命令(输入 m 获取帮助)：w</span><br><span class="line">The partition table has been altered!</span><br><span class="line"></span><br><span class="line">Calling ioctl() to re-read partition table.</span><br><span class="line">正在同步磁盘。</span><br><span class="line">[root@ct75 ~]# partprobe /dev/sdb</span><br><span class="line">#以上关于DRBD和分区的操作在2台机器上重复操作，master和backup分区大小一致。</span><br></pre></td></tr></table></figure>

<ul>
<li>修改配置文件</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">[root@ct74 ~]# vim /etc/drbd.conf</span><br><span class="line">#include &quot;drbd.d/global_common.conf&quot;; </span><br><span class="line">#注释掉这行，避免和我们自己写的配置产生冲突。</span><br><span class="line">    include &quot;drbd.d/*.res&quot;;</span><br><span class="line">    include &quot;drbd.d/*.cfg&quot;;</span><br><span class="line">[root@ct74 ~]# vim /etc/drbd.d/drbd_basic.cfg</span><br><span class="line">global &#123;</span><br><span class="line">    usage-count yes;</span><br><span class="line">#是否参与DRBD使用者统计，默认为yes，yes or no都无所谓 </span><br><span class="line">&#125;</span><br><span class="line">common &#123;</span><br><span class="line">    syncer &#123; rate 100M; &#125;</span><br><span class="line">&#125;</span><br><span class="line">#设置主备节点同步的网络速率最大值，默认单位是字节，我们可以设定为兆</span><br><span class="line">resource r0 &#123;</span><br><span class="line">#r0为资源名，我们在初始化磁盘的时候就可以使用资源名来初始化。</span><br><span class="line">    protocol C;</span><br><span class="line">#使用 C 协议。</span><br><span class="line">    handlers &#123;</span><br><span class="line">        pri-on-incon-degr &quot;echo o &gt; /proc/sysrq-trigger ; halt -f &quot;;  </span><br><span class="line">        pri-lost-after-sb &quot;echo o &gt; /proc/sysrq-trigger ; halt &quot;;</span><br><span class="line">        local-io-error &quot;echo o &gt; /proc/sysrq-trigger ; halt -f&quot;;</span><br><span class="line">        fence-peer &quot;/usr/lib4/heartbeat/drbd-peer-outdater -t 5&quot;;</span><br><span class="line">        pri-lost &quot;echo pri-lst. Have a look at the log file.mail -s &apos;Drbd Alert&apos; root&quot;;</span><br><span class="line">        split-brain &quot;/usr/lib/drbd/notify-split-brain.sh root&quot;;</span><br><span class="line">        out-of-sync &quot;/usr/lib/drbd/notify-out-of-sync.sh root&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">    net &#123;</span><br><span class="line">        cram-hmac-alg &quot;sha1&quot;;</span><br><span class="line">        shared-secret &quot;MySQL-HA&quot;;</span><br><span class="line">#drbd同步时使用的验证方式和密码信息</span><br><span class="line">    &#125;</span><br><span class="line">    disk &#123;</span><br><span class="line">        on-io-error detach;</span><br><span class="line">        fencing resource-only;</span><br><span class="line"># 使用DOPD（drbd outdate-peer deamon）功能保证数据不同步的时候不进行切换。</span><br><span class="line">    &#125;</span><br><span class="line">    startup &#123;</span><br><span class="line">        wfc-timeout 120;</span><br><span class="line">        degr-wfc-timeout 120;</span><br><span class="line">    &#125;</span><br><span class="line">    device /dev/drbd0;</span><br><span class="line">#这里/dev/drbd0是用户挂载时的设备名字，由DRBD进程创建</span><br><span class="line">    on ct74 &#123;</span><br><span class="line">#每个主机名的说明以on开头，后面是hostname（必须在/etc/hosts可解析）</span><br><span class="line">        disk /dev/sdb1;</span><br><span class="line">#使用这个磁盘作为drbd的磁盘/dev/drbd0。</span><br><span class="line">        address 192.168.137.74:7788;</span><br><span class="line">#设置DRBD的监听端口，用于与另一台主机通信</span><br><span class="line">        meta-disk internal;</span><br><span class="line">#drbd的元数据存放方式</span><br><span class="line">    &#125;</span><br><span class="line">    on ct75 &#123;</span><br><span class="line">        disk /dev/sdb1;</span><br><span class="line">        address 192.168.137.75:7788;</span><br><span class="line">        meta-disk internal;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[root@dbmaster ~]# dd if=/dev/zero of=/dev/sdb1 bs=1M count=1</span><br><span class="line">记录了1+0 的读入</span><br><span class="line">记录了1+0 的写出</span><br><span class="line">1048576字节(1.0 MB)已复制，0.00339429 秒，309 MB/秒</span><br><span class="line">[root@ct74 ~]# drbdadm create-md r0</span><br><span class="line">  --==  Thank you for participating in the global usage survey  ==--</span><br><span class="line">The server&apos;s response is:</span><br><span class="line"></span><br><span class="line">you are the 14097th user to install this version</span><br><span class="line">WARN:</span><br><span class="line">  You are using the &apos;drbd-peer-outdater&apos; as fence-peer program.</span><br><span class="line">  If you use that mechanism the dopd heartbeat plugin program needs</span><br><span class="line">  to be able to call drbdsetup and drbdmeta with root privileges.</span><br><span class="line"></span><br><span class="line">  You need to fix this with these commands:</span><br><span class="line">  chgrp haclient /lib/drbd/drbdsetup-84</span><br><span class="line">  chmod o-x /lib/drbd/drbdsetup-84</span><br><span class="line">  chmod u+s /lib/drbd/drbdsetup-84</span><br><span class="line"></span><br><span class="line">  chgrp haclient /usr/sbin/drbdmeta</span><br><span class="line">  chmod o-x /usr/sbin/drbdmeta</span><br><span class="line">  chmod u+s /usr/sbin/drbdmeta</span><br><span class="line"></span><br><span class="line">initializing activity log</span><br><span class="line">initializing bitmap (32 KB) to all zero</span><br><span class="line">Writing meta data...</span><br><span class="line">New drbd meta data block successfully created.</span><br><span class="line">success</span><br><span class="line">#使用dd命令清空，然后再执行</span><br></pre></td></tr></table></figure>

<ul>
<li>进一步配置</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[root@ct74 ~]# drbdadm up all</span><br><span class="line">[root@ct74 ~]# systemctl start drbd.service</span><br><span class="line">[root@ct75 ~]# systemctl enable drbd.service </span><br><span class="line">#启动服务</span><br><span class="line"></span><br><span class="line">#如报错，试试如下，不报错跳过这步</span><br><span class="line">groupadd haclient</span><br><span class="line">chgrp haclient /lib/drbd/drbdsetup-84</span><br><span class="line">chmod o-x /lib/drbd/drbdsetup-84</span><br><span class="line">chmod u+s /lib/drbd/drbdsetup-84</span><br><span class="line">chgrp haclient /usr/sbin/drbdmeta</span><br><span class="line">chmod o-x /usr/sbin/drbdmeta</span><br><span class="line">chmod u+s /usr/sbin/drbdmeta</span><br><span class="line">#以上这几个操作，找了很多资料都没有提到要做，还特意提醒不用做，可能环境不同吧，不做一直报错</span><br><span class="line"></span><br><span class="line">[root@ct74 ~]# drbdadm primary --force r0</span><br><span class="line">#仅在主上操作</span><br><span class="line">[root@ct74 ~]# drbdadm role r0</span><br><span class="line">Primary/Secondary</span><br><span class="line">#查看状态</span><br><span class="line">[root@ct74 ~]# watch -n1 -x cat /proc/drbd</span><br><span class="line"></span><br><span class="line">[root@ct75 ~]# drbdadm role r0</span><br><span class="line">Secondary/Primary</span><br><span class="line">#backup机器查看状态</span><br><span class="line"></span><br><span class="line">[root@ct75 ~]# drbdadm dstate r0</span><br><span class="line">UpToDate/UpToDate</span><br><span class="line">#查看数据同步状态，如上为一致，还有Inconsistent状态为数据不一致正在同步</span><br></pre></td></tr></table></figure>

<ul>
<li>挂载DRBD磁盘</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">现在ct74上操作</span><br><span class="line">[root@ct74 ~]# mkfs.ext4 /dev/drbd0 </span><br><span class="line">mke2fs 1.42.9 (28-Dec-2013)</span><br><span class="line">文件系统标签=</span><br><span class="line">OS type: Linux</span><br><span class="line">块大小=4096 (log=2)</span><br><span class="line">分块大小=4096 (log=2)</span><br><span class="line">Stride=0 blocks, Stripe width=0 blocks</span><br><span class="line">65536 inodes, 261871 blocks</span><br><span class="line">13093 blocks (5.00%) reserved for the super user</span><br><span class="line">第一个数据块=0</span><br><span class="line">Maximum filesystem blocks=268435456</span><br><span class="line">8 block groups</span><br><span class="line">32768 blocks per group, 32768 fragments per group</span><br><span class="line">8192 inodes per group</span><br><span class="line">Superblock backups stored on blocks: </span><br><span class="line">    32768, 98304, 163840, 229376</span><br><span class="line"></span><br><span class="line">Allocating group tables: 完成                            </span><br><span class="line">正在写入inode表: 完成                            </span><br><span class="line">Creating journal (4096 blocks): 完成</span><br><span class="line">Writing superblocks and filesystem accounting information: 完成</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@ct74 ~]# mkdir /nfs</span><br><span class="line">[root@ct74 ~]# mount /dev/drbd0 /nfs</span><br><span class="line">[root@ct74 ~]# df -Th</span><br><span class="line">Filesystem     Type      Size  Used Avail Use% Mounted on</span><br><span class="line">/dev/sda3      ext4       46G  1.7G   42G   4% /</span><br><span class="line">devtmpfs       devtmpfs  749M     0  749M   0% /dev</span><br><span class="line">tmpfs          tmpfs     759M     0  759M   0% /dev/shm</span><br><span class="line">tmpfs          tmpfs     759M  8.8M  750M   2% /run</span><br><span class="line">tmpfs          tmpfs     759M     0  759M   0% /sys/fs/cgroup</span><br><span class="line">/dev/sda1      ext4      477M  124M  325M  28% /boot</span><br><span class="line">tmpfs          tmpfs     152M     0  152M   0% /run/user/0</span><br><span class="line">/dev/drbd0     ext4      991M  2.6M  922M   1% /nfs</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">现在是ct75上操作，主要是检测备端是否能够正常挂载和使用：</span><br><span class="line"></span><br><span class="line">[root@ct74 ~]# umount /nfs</span><br><span class="line">#主上将设备卸载</span><br><span class="line">[root@ct74 ~]# drbdadm secondary all</span><br><span class="line">#切换为被状态</span><br><span class="line"></span><br><span class="line">[root@ct75 ~]# drbdadm primary r0</span><br><span class="line">#被设为主状态</span><br><span class="line">[root@ct75 ~]# mkdir /nfs</span><br><span class="line">[root@ct75 ~]# mount /dev/drbd0 /nfs</span><br><span class="line"></span><br><span class="line">[root@ct75 ~]# df -Th</span><br><span class="line">Filesystem     Type      Size  Used Avail Use% Mounted on</span><br><span class="line">/dev/sda3      ext4       46G  1.7G   42G   4% /</span><br><span class="line">devtmpfs       devtmpfs  749M     0  749M   0% /dev</span><br><span class="line">tmpfs          tmpfs     759M     0  759M   0% /dev/shm</span><br><span class="line">tmpfs          tmpfs     759M  8.8M  750M   2% /run</span><br><span class="line">tmpfs          tmpfs     759M     0  759M   0% /sys/fs/cgroup</span><br><span class="line">/dev/sda1      ext4      477M  124M  325M  28% /boot</span><br><span class="line">tmpfs          tmpfs     152M     0  152M   0% /run/user/0</span><br><span class="line">/dev/drbd0     ext4      991M  2.6M  922M   1% /nfs</span><br><span class="line"></span><br><span class="line">再按相同的方法将状态切换回来</span><br></pre></td></tr></table></figure>

<p><strong>好的，这下简单测试了下，先告一段落</strong></p>
<h3 id="部署heartbeat"><a href="#部署heartbeat" class="headerlink" title="部署heartbeat"></a>部署heartbeat</h3><ul>
<li>安装cluster-glue</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">yum install gcc gcc-c++ flex autoconf automake libtool glib2-devel libxml2-devel bzip2 bzip2-devel e2fsprogs-devel libxslt-devel libtool-ltdl-devel asciidoc -y</span><br><span class="line">#两机同样操作安装依赖</span><br><span class="line"></span><br><span class="line">groupadd haclient</span><br><span class="line">useradd -g haclient hacluster -s /sbin/nologin</span><br><span class="line"></span><br><span class="line">安装包下载</span><br><span class="line">下载软件包：Reusable-Components-glue、resource-agents、heartbeat</span><br><span class="line">cd /opt</span><br><span class="line">wget http://hg.linux-ha.org/heartbeat-STABLE_3_0/archive/958e11be8686.tar.bz2</span><br><span class="line">wget http://hg.linux-ha.org/glue/archive/0a7add1d9996.tar.bz2</span><br><span class="line">wget https://github.com/ClusterLabs/resource-agents/archive/v3.9.6.tar.gz</span><br><span class="line"></span><br><span class="line">tar xf 0a7add1d9996.tar.bz2</span><br><span class="line">cd Reusable-Cluster-Components-glue--0a7add1d9996/</span><br><span class="line">./autogen.sh</span><br><span class="line">./configure --prefix=/usr/local/heartbeat --with-daemon-user=hacluster --with-daemon-group=haclient --enable-fatal-warnings=no LIBS=&apos;/lib64/libuuid.so.1&apos;</span><br><span class="line">make &amp;&amp; make install</span><br><span class="line">echo $?</span><br><span class="line">cd ..</span><br></pre></td></tr></table></figure>

<ul>
<li>安装resource-agents</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">tar xf v3.9.6.tar.gz</span><br><span class="line">cd resource-agents-3.9.6/</span><br><span class="line">./autogen.sh </span><br><span class="line">./configure --prefix=/usr/local/heartbeat --with-daemon-user=hacluster --with-daemon-group=haclient --enable-fatal-warnings=no LIBS=&apos;/lib64/libuuid.so.1&apos;</span><br><span class="line">make &amp;&amp; make install</span><br><span class="line">echo $?</span><br><span class="line">cd ..</span><br></pre></td></tr></table></figure>

<ul>
<li>安装heartbeat</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">tar xf 958e11be8686.tar.bz2</span><br><span class="line">cd Heartbeat-3-0-958e11be8686/</span><br><span class="line">./bootstrap</span><br><span class="line">export CFLAGS=&quot;$CFLAGS -I/usr/local/heartbeat/include -L/usr/local/heartbeat/lib&quot; </span><br><span class="line">./configure --prefix=/usr/local/heartbeat --with-daemon-user=hacluster --with-daemon-group=haclient --enable-fatal-warnings=no LIBS=&apos;/lib64/libuuid.so.1&apos;</span><br><span class="line">make &amp;&amp; make install</span><br><span class="line">echo $?</span><br><span class="line"></span><br><span class="line">mkdir -pv /usr/local/heartbeat/usr/lib/ocf/lib/heartbeat/</span><br><span class="line">cp -R /usr/lib/ocf/lib/heartbeat/ocf-* /usr/local/heartbeat/usr/lib/ocf/lib/heartbeat/</span><br><span class="line">cp -R /opt/Heartbeat-3-0-958e11be8686/doc/&#123;ha.cf,haresources,authkeys&#125; /usr/local/heartbeat/etc/ha.d/</span><br><span class="line">#拷贝配置文件</span><br><span class="line"></span><br><span class="line">chmod 600 /usr/local/heartbeat/etc/ha.d/authkeys</span><br><span class="line">#该权限必须为600</span><br><span class="line">#以上安装两台机器一样</span><br></pre></td></tr></table></figure>

<ul>
<li>配置文件</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">[root@ct74 ~]# vim /usr/local/heartbeat/etc/ha.d/haresources</span><br><span class="line">#末尾添加如下</span><br><span class="line">ct74 IPaddr::192.168.137.82/24/eth0 drbddisk::r0 Filesystem::/dev/drbd0::/nfs::ext4 killnfsd</span><br><span class="line">#ct74 IPaddr::192.168.137.82/24/eth0主机名 后跟虚拟IP地址、接口</span><br><span class="line">#drbddisk::r0管理drbd资源的名称</span><br><span class="line">#Filesystem::/dev/drbd0::/nfs::ext4 renfsd文件系统::挂载的目录及格式::后跟renfsd资源脚本</span><br><span class="line"></span><br><span class="line">cp -R /etc/ha.d/resource.d/drbddisk /usr/local/heartbeat/etc/ha.d/resource.d/</span><br><span class="line">#两台一样</span><br><span class="line"></span><br><span class="line">echo &quot;pkill -9 nfs; systemctl restart nfs; exit 0&quot; &gt; /usr/local/heartbeat/etc/ha.d/resource.d/killnfsd</span><br><span class="line">#编辑nfs脚本文件killnfsd ，killnfsd 脚本文件的作用，</span><br><span class="line">#drbd主备切换时，若nfs没有启动，则此脚本会把nfs启动</span><br><span class="line">#drbd主备切换时，若nfs已启动，则此脚本会重启nfs服务，因为NFS服务切换后，必须重新mount一下nfs共享出来的目录，否则会出现stale NFS file handle的错误</span><br><span class="line"></span><br><span class="line">chmod +x /usr/local/heartbeat/etc/ha.d/resource.d/drbddisk</span><br><span class="line">chmod +x /usr/local/heartbeat/etc/ha.d/resource.d/killnfsd </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@ct74 resource.d]# pwd</span><br><span class="line">/usr/local/heartbeat/etc/ha.d/resource.d</span><br><span class="line">[root@ct74 resource.d]#  ll drbddisk Filesystem killnfsd IPaddr </span><br><span class="line">-rwxr-xr-x 1 root root 3162 5月  14 15:43 drbddisk</span><br><span class="line">-rwxr-xr-x 1 root root 1923 5月  14 10:15 Filesystem</span><br><span class="line">-rwxr-xr-x 1 root root 2297 5月  14 10:15 IPaddr</span><br><span class="line">-rwxr-xr-x 1 root root   57 5月  14 15:41 killnfsd</span><br><span class="line">#必须要有这四个脚本，有的是自带，有的是复制，有的自己写，上面已经说明而且必须要有执行权限。</span><br><span class="line">[root@ct74 ~]# vim  /usr/local/heartbeat/etc/ha.d/ha.cf</span><br><span class="line">#修改主配置文件（去掉注释或修改值）</span><br><span class="line">debugfile /var/log/ha-debug</span><br><span class="line">logfile /var/log/ha-log</span><br><span class="line">#指定heartbeat日志文件的位置</span><br><span class="line">logfacility     local0</span><br><span class="line">#利用系统日志打印日志</span><br><span class="line">keepalive 1</span><br><span class="line"># 心跳发送时间间隔</span><br><span class="line">deadtime 5</span><br><span class="line"> # 备用节点5s内没有检测到master机的心跳，确认对方故障</span><br><span class="line">warntime 2</span><br><span class="line"># 警告2次</span><br><span class="line">initdead 10</span><br><span class="line"># 守护进程启动30s后，启动服务资源。</span><br><span class="line">udpport 694</span><br><span class="line">#设定集群节点间的通信协议及端口为udp694监听端口（该端口可以修改）</span><br><span class="line">ucast eth0 192.168.137.75</span><br><span class="line"># 另一台主机节点eth0的地址，注意是另一台。</span><br><span class="line">auto_failback off</span><br><span class="line">#当primary节点切换到secondary节点之后，primary节点恢复正常，不进行切回操作，因为切换一次mysql master成本很高。</span><br><span class="line">node    ct74</span><br><span class="line">node    ct75</span><br><span class="line"># 定义两个节点的主机名，一行写一个。</span><br><span class="line">ping 192.168.137.1</span><br><span class="line">#两个IP的网关</span><br><span class="line">respawn hacluster /usr/local/heartbeat/libexec/heartbeat/ipfail </span><br><span class="line">#使用这个脚本去侦听对方是否还活着（使用的是ICMP报文检测）</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@ct74 ~]# vim /usr/local/heartbeat/etc/ha.d/authkeys</span><br><span class="line">#认证文件</span><br><span class="line">auth 1</span><br><span class="line">#表示使用id为2的验证 下边需要定义一个2的验证算法</span><br><span class="line">1 sha1 HA_DB</span><br><span class="line">#口令（HISHA1）随便给 主从配置相同即可</span><br></pre></td></tr></table></figure>

<p>dbdackup也是同样的安装方法，配置文件直接scp过去就可以了，然后修改</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@ct74 ~]# scp -r /usr/local/heartbeat/etc/ha.d/&#123;authkeys,haresources,ha.cf&#125; root@ct75:/usr/local/heartbeat/etc/ha.d/</span><br><span class="line">[root@ct75 ha.d]# vim /usr/local/heartbeat/etc/ha.d/ha.cf </span><br><span class="line">ucast eth0 192.168.137.74</span><br><span class="line">#把backup节点上ha.cf配置文件中ucast中IP改为对方</span><br><span class="line"></span><br><span class="line">[root@ct74 ~]# ln -svf /usr/local/heartbeat/lib64/heartbeat/plugins/RAExec/* /usr/local/heartbeat/lib/heartbeat/plugins/RAExec/</span><br><span class="line"></span><br><span class="line">[root@ct74 ~]# ln -svf /usr/local/heartbeat/lib64/heartbeat/plugins/* /usr/local/heartbeat/lib/heartbeat/plugins/</span><br><span class="line">#2机器将这些库文件链接过去，要不启动报错</span><br><span class="line">May 13 13:09:27 ct74 heartbeat: [86183]: ERROR: Illegal directive [ucast] in /usr/local/heartbeat/etc/ha.d/ha.cf</span><br></pre></td></tr></table></figure>

<h3 id="部署NFS及配合heartbeat"><a href="#部署NFS及配合heartbeat" class="headerlink" title="部署NFS及配合heartbeat"></a>部署NFS及配合heartbeat</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[root@ct75 ~]# yum -y install nfs-utils nfs-utils-lib nfs4-acl-tools rpcbind</span><br><span class="line">#ct74和ct75安装</span><br><span class="line">[root@ct74 ~]# vim /etc/exports</span><br><span class="line">/nfs 192.168.137.0/24(rw,sync,no_root_squash)</span><br><span class="line">#设置nfs共享目录，权限，网段</span><br><span class="line">[root@ct74 ~]# systemctl restart rpcbind</span><br><span class="line"></span><br><span class="line">#启动顺序一定是rpcbind-&gt;nfs，否则有可能出现错误</span><br><span class="line">#在这里nfs不需要启动，它由heartbeat控制</span><br><span class="line"></span><br><span class="line">[root@ct74 ~]# systemctl start heartbeat</span><br><span class="line">[root@ct74 ~]# systemctl enable heartbeat</span><br><span class="line">#最多等一两分钟VIP肯定出来，否则查看日志</span><br><span class="line">[root@ct74 ~]# ip a | grep inet</span><br><span class="line">#主上查看</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">    inet6 ::1/128 scope host </span><br><span class="line">    inet 192.168.137.74/24 brd 192.168.137.255 scope global noprefixroute eth0</span><br><span class="line">    inet 192.168.137.82/24 brd 192.168.137.255 scope global secondary eth0:0</span><br><span class="line">    inet6 fe80::20c:29ff:fec3:1a39/64 scope link</span><br><span class="line">#到了这，VIP肯定要出来，可以稍等会，观察下日志。如果出错，上面可能哪一步没有到位</span><br><span class="line">[root@ct74 ~]# mount | grep drbd</span><br><span class="line">/dev/drbd0 on /nfs type ext4 (rw,relatime,data=ordered)</span><br><span class="line">#这个也已经根据配置自动挂载</span><br><span class="line"></span><br><span class="line">[root@ct75 ~]# showmount -e 192.168.137.82</span><br><span class="line">Export list for 192.168.137.82</span><br><span class="line">/nfs 192.168.137.82/24</span><br><span class="line">#查看VIP共享的目录</span><br></pre></td></tr></table></figure>

<ul>
<li>配置nfs自动挂载</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# mkdir /nfs</span><br><span class="line">[root@localhost ~]# mount 192.168.137.82:/nfs/ /nfs/</span><br><span class="line">#客户端测试</span><br><span class="line">[root@localhost ~]# echo &quot;192.168.137.82:/nfs /nfs nfs defaults,soft,intr 0 0&quot; &gt;&gt; /etc/fstab </span><br><span class="line">[root@localhost ~]# tail -1 /etc/fstab </span><br><span class="line">192.168.137.82:/nfs /nfs nfs defaults,soft,intr 0 0</span><br><span class="line">#Nfs是类型</span><br><span class="line">#soft参数是为了向用户输出错误信息</span><br><span class="line">#intr参数为了解决当网络出现故障时，我们可以通过按下ctrl+c组合键来终止操作</span><br></pre></td></tr></table></figure>

<ul>
<li>验证：接下来我们在主上把nfs服务关掉，模拟故障，看VIP是否切换主机</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@ct74 ~]# systemctl stop nfs</span><br><span class="line">[root@ct74 ~]# systemctl status nfs</span><br><span class="line">● nfs-server.service - NFS server and services</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/nfs-server.service; disabled; vendor preset: disabled)</span><br><span class="line">  Drop-In: /run/systemd/generator/nfs-server.service.d</span><br><span class="line">           └─order-with-mounts.conf</span><br><span class="line">   Active: inactive (dead) since 二 2019-05-14 18:21:09 CST; 6s ago</span><br><span class="line">  Process: 61802 ExecStopPost=/usr/sbin/exportfs -f (code=exited, status=0/SUCCESS)</span><br><span class="line">  Process: 61799 ExecStopPost=/usr/sbin/exportfs -au (code=exited, status=0/SUCCESS)</span><br><span class="line">  Process: 61797 ExecStop=/usr/sbin/rpc.nfsd 0 (code=exited, status=0/SUCCESS)</span><br><span class="line"> Main PID: 60625 (code=exited, status=0/SUCCESS)</span><br><span class="line"></span><br><span class="line">5月 14 16:35:58 ct74 systemd[1]: Starting NFS server and services...</span><br><span class="line">5月 14 16:35:58 ct74 systemd[1]: Started NFS server and services.</span><br><span class="line">5月 14 18:21:09 ct74 systemd[1]: Stopping NFS server and services...</span><br><span class="line">5月 14 18:21:09 ct74 systemd[1]: Stopped NFS server and services.</span><br></pre></td></tr></table></figure>

<p>我在主被两台机器上查看debug日志，没有任何变动</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@ct75 ~]# cd /nfs</span><br><span class="line"></span><br><span class="line">#我在挂载了VIP的机器上查看共享目录能否使用，卡死终端</span><br></pre></td></tr></table></figure>

<p>总结下原因：heartbeat没有监控到nfs的服务状态，它自身想当然的认为，只有heartbeat服务出故障，才切VIP。</p>
<p>解决：我们将nfs，和heartbeat服务做一个捆绑，类似于事物性质。即nfs出问题，heartbeat也要宕掉。这里通过脚本实现。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[root@ct74 ~]# vim /opt/monitornfs.sh</span><br><span class="line"></span><br><span class="line">while true</span><br><span class="line">do</span><br><span class="line">    drbdstatus=`cat /proc/drbd 2&gt; /dev/null  | grep ro | tail -n1 | awk -F&apos;:&apos; &apos;&#123;print $4&#125;&apos; | awk -F&apos;/&apos; &apos;&#123;print $1&#125;&apos;`</span><br><span class="line">    nfsstatus=`systemctl status nfs&amp;&gt;/dev/null ; echo $?`</span><br><span class="line"></span><br><span class="line">    if [ -z  $drbdstatus ];then</span><br><span class="line">        sleep 10</span><br><span class="line">        continue</span><br><span class="line">    elif [ $drbdstatus == &apos;Primary&apos; ];then</span><br><span class="line">        if [ $nfsstatus -ne 0 ];then</span><br><span class="line">            systemctl start nfs &amp;&gt; /dev/null</span><br><span class="line">            newnfsstatus=`systemctl status nfs&amp;&gt;/dev/null ; echo $?`</span><br><span class="line">            if [ $newnfsstatus -ne 0 ];then</span><br><span class="line">            systemctl stop heartbeat</span><br><span class="line">            #尝试开启之后若还是不行,则关掉heartbeat</span><br><span class="line">            fi</span><br><span class="line">        fi</span><br><span class="line">    fi</span><br><span class="line">    sleep 5</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line">[root@ct74 ~]# chmod +x /opt/monitornfs.sh </span><br><span class="line">[root@ct74 ~]# nohup /opt/monitornfs.sh &amp;</span><br><span class="line">echo &quot;nohup /opt/monitornfs.sh &amp;&quot; &gt;&gt;/etc/rc.local</span><br><span class="line">#以上关于脚本操作，在ct75上重复</span><br></pre></td></tr></table></figure>

<ul>
<li>测试</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@ct74 ~]# systemctl stop nfs</span><br><span class="line">#主节点关掉nfs服务</span><br><span class="line"></span><br><span class="line">#但是后台的脚本又给他开启了</span><br><span class="line">[root@ct74 ~]# systemctl stop heartbeat</span><br><span class="line">#VIP切换到备机了</span><br></pre></td></tr></table></figure>

<p><strong>但是nfs客户端的使用并不影响，切换的时候会有轻微的延迟。</strong></p>
<h4 id="nfs切记要挂载到别的机器上不要为了省事，省机器"><a href="#nfs切记要挂载到别的机器上不要为了省事，省机器" class="headerlink" title="nfs切记要挂载到别的机器上不要为了省事，省机器"></a>nfs切记要挂载到别的机器上不要为了省事，省机器</h4>
          
        
      
    </div>

    

    

    
    
    

    

    
      
    
    

    
	
	  <div>
        
      </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://aiwhs.github.io/2019/03/02/keepalived高可用/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="itw">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="itw">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/03/02/keepalived高可用/" class="post-title-link" itemprop="url">keepalived</a>
              
            
          </h1>
        

        <div class="post-meta">

          
          
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-03-02 08:15:57" itemprop="dateCreated datePublished" datetime="2019-03-02T08:15:57+08:00">2019-03-02</time>
            </span>
          

          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-07-17 20:49:37" itemprop="dateModified" datetime="2019-07-17T20:49:37+08:00">2019-07-17</time>
              </span>
            
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Linux运维/" itemprop="url" rel="index"><span itemprop="name">Linux运维</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          <br>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <a id="more"></a>



<h2 id="1-keepalived简介"><a href="#1-keepalived简介" class="headerlink" title="1. keepalived简介"></a>1. keepalived简介</h2><h3 id="1-1-keepalived是什么？"><a href="#1-1-keepalived是什么？" class="headerlink" title="1.1 keepalived是什么？"></a>1.1 keepalived是什么？</h3><p>Keepalived 软件起初是专为LVS负载均衡软件设计的，用来管理并监控LVS集群系统中各个服务节点的状态，后来又加入了可以实现高可用的VRRP功能。因此，Keepalived除了能够管理LVS软件外，还可以作为其他服务（例如：Nginx、Haproxy、MySQL等）的高可用解决方案软件。</p>
<p>Keepalived软件主要是通过VRRP协议实现高可用功能的。VRRP是Virtual Router RedundancyProtocol(虚拟路由器冗余协议）的缩写，VRRP出现的目的就是为了解决静态路由单点故障问题的，它能够保证当个别节点宕机时，整个网络可以不间断地运行。</p>
<p>所以，Keepalived 一方面具有配置管理LVS的功能，同时还具有对LVS下面节点进行健康检查的功能，另一方面也可实现系统网络服务的高可用功能。</p>
<p>keepalived<a href="http://www.keepalived.org/" target="_blank" rel="noopener">官网</a></p>
<h3 id="1-2-keepalived的重要功能"><a href="#1-2-keepalived的重要功能" class="headerlink" title="1.2 keepalived的重要功能"></a>1.2 keepalived的重要功能</h3><p>keepalived 有三个重要的功能，分别是：</p>
<ul>
<li>管理LVS负载均衡软件</li>
<li>实现LVS集群节点的健康检查</li>
<li>作为系统网络服务的高可用性（failover）</li>
</ul>
<h3 id="1-3-keepalived高可用故障转移的原理"><a href="#1-3-keepalived高可用故障转移的原理" class="headerlink" title="1.3 keepalived高可用故障转移的原理"></a>1.3 keepalived高可用故障转移的原理</h3><p>Keepalived 高可用服务之间的故障切换转移，是通过 VRRP (Virtual Router Redundancy Protocol ,虚拟路由器冗余协议）来实现的。</p>
<p>在 Keepalived 服务正常工作时，主 Master 节点会不断地向备节点发送（多播的方式）心跳消息，用以告诉备 Backup 节点自己还活看，当主 Master 节点发生故障时，就无法发送心跳消息，备节点也就因此无法继续检测到来自主 Master 节点的心跳了，于是调用自身的接管程序，接管主 Master 节点的 IP 资源及服务。而当主 Master 节点恢复时，备 Backup 节点又会释放主节点故障时自身接管的IP资源及服务，恢复到原来的备用角色。</p>
<p>那么，什么是VRRP呢？<br>VRRP ,全 称 Virtual Router Redundancy Protocol ,中文名为虚拟路由冗余协议 ，VRRP的出现就是为了解决静态踣甶的单点故障问题，VRRP是通过一种竞选机制来将路由的任务交给某台VRRP路由器的。</p>
<h3 id="1-4-keepalived原理"><a href="#1-4-keepalived原理" class="headerlink" title="1.4 keepalived原理"></a>1.4 keepalived原理</h3><h4 id="1-4-1-keepalived高可用架构图"><a href="#1-4-1-keepalived高可用架构图" class="headerlink" title="1.4.1 keepalived高可用架构图"></a>1.4.1 keepalived高可用架构图</h4><p><img src="../../img/keepalived_yuanli.png" alt="img"></p>
<h4 id="1-4-2-keepalived工作原理描述"><a href="#1-4-2-keepalived工作原理描述" class="headerlink" title="1.4.2 keepalived工作原理描述"></a>1.4.2 keepalived工作原理描述</h4><p>Keepalived高可用对之间是通过VRRP通信的，因此，我们从 VRRP开始了解起：<br>1) VRRP,全称 Virtual Router Redundancy Protocol,中文名为虚拟路由冗余协议，VRRP的出现是为了解决静态路由的单点故障。<br>2) VRRP是通过一种竟选协议机制来将路由任务交给某台 VRRP路由器的。<br>3) VRRP用 IP多播的方式（默认多播地址（224.0_0.18))实现高可用对之间通信。<br>4) 工作时主节点发包，备节点接包，当备节点接收不到主节点发的数据包的时候，就启动接管程序接管主节点的开源。备节点可以有多个，通过优先级竞选，但一般 Keepalived系统运维工作中都是一对。<br>5) VRRP使用了加密协议加密数据，但Keepalived官方目前还是推荐用明文的方式配置认证类型和密码。</p>
<p>介绍完 VRRP,接下来我再介绍一下 Keepalived服务的工作原理：</p>
<blockquote>
<p>Keepalived高可用是通过 VRRP 进行通信的， VRRP是通过竞选机制来确定主备的，主的优先级高于备，因此，工作时主会优先获得所有的资源，备节点处于等待状态，当主挂了的时候，备节点就会接管主节点的资源，然后顶替主节点对外提供服务。</p>
<p>在 Keepalived 服务之间，只有作为主的服务器会一直发送 VRRP 广播包,告诉备它还活着，此时备不会枪占主，当主不可用时，即备监听不到主发送的广播包时，就会启动相关服务接管资源，保证业务的连续性.接管速度最快可以小于1秒。</p>
</blockquote>
<h2 id="2-keepalived配置文件讲解"><a href="#2-keepalived配置文件讲解" class="headerlink" title="2. keepalived配置文件讲解"></a>2. keepalived配置文件讲解</h2><h3 id="2-1-keepalived默认配置文件"><a href="#2-1-keepalived默认配置文件" class="headerlink" title="2.1 keepalived默认配置文件"></a>2.1 keepalived默认配置文件</h3><p>keepalived 的主配置文件是 <code>/etc/keepalived/keepalived.conf</code>。其内容如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# cat /etc/keepalived/keepalived.conf</span><br><span class="line">! Configuration File for keepalived</span><br><span class="line"></span><br><span class="line">global_defs &#123;       //全局配置</span><br><span class="line">   notification_email &#123;     //定义报警收件人邮件地址</span><br><span class="line">     acassen@firewall.loc</span><br><span class="line">     failover@firewall.loc</span><br><span class="line">     sysadmin@firewall.loc</span><br><span class="line">   &#125;</span><br><span class="line">   notification_email_from Alexandre.Cassen@firewall.loc    //定义报警发件人邮箱</span><br><span class="line">   smtp_server 192.168.200.1    //邮箱服务器地址</span><br><span class="line">   smtp_connect_timeout 30      //定义邮箱超时时间</span><br><span class="line">   router_id LVS_DEVEL          //定义路由标识信息，同局域网内唯一</span><br><span class="line">   vrrp_skip_check_adv_addr</span><br><span class="line">   vrrp_strict</span><br><span class="line">   vrrp_garp_interval 0</span><br><span class="line">   vrrp_gna_interval 0</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;        //定义实例</span><br><span class="line">    state MASTER            //指定keepalived节点的初始状态，可选值为MASTER|BACKUP</span><br><span class="line">    interface eth0          //VRRP实例绑定的网卡接口，用户发送VRRP包</span><br><span class="line">    virtual_router_id 51    //虚拟路由的ID，同一集群要一致</span><br><span class="line">    priority 100            //定义优先级，按优先级来决定主备角色，优先级越大越优先</span><br><span class="line">    nopreempt               //设置不抢占</span><br><span class="line">    advert_int 1            //主备通讯时间间隔</span><br><span class="line">    authentication &#123;        //配置认证</span><br><span class="line">        auth_type PASS      //认证方式，此处为密码</span><br><span class="line">        auth_pass 1111      //同一集群中的keepalived配置里的此处必须一致，推荐使用8位随机数</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;     //配置要使用的VIP地址</span><br><span class="line">        192.168.200.16</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">virtual_server 10.10.10.2 1358 &#123;    //配置虚拟服务器</span><br><span class="line">    delay_loop 6        //健康检查的时间间隔</span><br><span class="line">    lb_algo rr          //lvs调度算法</span><br><span class="line">    lb_kind NAT         //lvs模式</span><br><span class="line">    persistence_timeout 50      //持久化超时时间，单位是秒</span><br><span class="line">    protocol TCP        //4层协议</span><br><span class="line"></span><br><span class="line">    sorry_server 192.168.200.200 1358   //定义备用服务器，当所有RS都故障时用sorry_server来响应客户端</span><br><span class="line"></span><br><span class="line">    real_server 192.168.200.2 1358 &#123;    //定义真实处理请求的服务器</span><br><span class="line">        weight 1    //给服务器指定权重，默认为1</span><br><span class="line">        HTTP_GET &#123;</span><br><span class="line">            url &#123;</span><br><span class="line">              path /testurl/test.jsp    //指定要检查的URL路径</span><br><span class="line">              digest 640205b7b0fc66c1ea91c463fac6334d   //摘要信息</span><br><span class="line">            &#125;</span><br><span class="line">            url &#123;</span><br><span class="line">              path /testurl2/test.jsp</span><br><span class="line">              digest 640205b7b0fc66c1ea91c463fac6334d</span><br><span class="line">            &#125;</span><br><span class="line">            url &#123;</span><br><span class="line">              path /testurl3/test.jsp</span><br><span class="line">              digest 640205b7b0fc66c1ea91c463fac6334d</span><br><span class="line">            &#125;</span><br><span class="line">            connect_timeout 3       //连接超时时间</span><br><span class="line">            nb_get_retry 3          //get尝试次数</span><br><span class="line">            delay_before_retry 3    //在尝试之前延迟多长时间</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    real_server 192.168.200.3 1358 &#123;</span><br><span class="line">        weight 1</span><br><span class="line">        HTTP_GET &#123;</span><br><span class="line">            url &#123;</span><br><span class="line">              path /testurl/test.jsp</span><br><span class="line">              digest 640205b7b0fc66c1ea91c463fac6334c</span><br><span class="line">            &#125;</span><br><span class="line">            url &#123;</span><br><span class="line">              path /testurl2/test.jsp</span><br><span class="line">              digest 640205b7b0fc66c1ea91c463fac6334c</span><br><span class="line">            &#125;</span><br><span class="line">            connect_timeout 3</span><br><span class="line">            nb_get_retry 3</span><br><span class="line">            delay_before_retry 3</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-2-定制主配置文件"><a href="#2-2-定制主配置文件" class="headerlink" title="2.2 定制主配置文件"></a>2.2 定制主配置文件</h3><p><strong>vrrp_instance段配置</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">nopreempt   //设置为不抢占。默认是抢占的，当高优先级的机器恢复后，会抢占低优先 \</span><br><span class="line">级的机器成为MASTER，而不抢占，则允许低优先级的机器继续成为MASTER，即使高优先级 \</span><br><span class="line">的机器已经上线。如果要使用这个功能，则初始化状态必须为BACKUP。</span><br><span class="line"></span><br><span class="line">preempt_delay   //设置抢占延迟。单位是秒，范围是0---1000，默认是0.发现低优先 \</span><br><span class="line">级的MASTER后多少秒开始抢占。</span><br></pre></td></tr></table></figure>

<p><strong>vrrp_script段配置</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">作用：添加一个周期性执行的脚本。脚本的退出状态码会被调用它的所有的VRRP Instance记录。</span><br><span class="line">注意：至少有一个VRRP实例调用它并且优先级不能为0.优先级范围是1-254.</span><br><span class="line">vrrp_script &lt;SCRIPT_NAME&gt; &#123;</span><br><span class="line">          ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">选项说明：</span><br><span class="line">script &quot;/path/to/somewhere&quot;      //指定要执行的脚本的路径。</span><br><span class="line">interval &lt;INTEGER&gt;              //指定脚本执行的间隔。单位是秒。默认为1s。</span><br><span class="line">timeout &lt;INTEGER&gt;               //指定在多少秒后，脚本被认为执行失败。</span><br><span class="line">weight &lt;-254 --- 254&gt;           //调整优先级。默认为2.</span><br><span class="line">rise &lt;INTEGER&gt;                  //执行成功多少次才认为是成功。</span><br><span class="line">fall &lt;INTEGER&gt;                  //执行失败多少次才认为失败。</span><br><span class="line">user &lt;USERNAME&gt; [GROUPNAME]     //运行脚本的用户和组。</span><br><span class="line">init_fail                       //假设脚本初始状态是失败状态。</span><br><span class="line"></span><br><span class="line">weight说明： </span><br><span class="line">1. 如果脚本执行成功(退出状态码为0)，weight大于0，则priority增加。</span><br><span class="line">2. 如果脚本执行失败(退出状态码为非0)，weight小于0，则priority减少。</span><br><span class="line">3. 其他情况下，priority不变。</span><br></pre></td></tr></table></figure>

<p><strong>real_server段配置</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">weight &lt;INT&gt;            //给服务器指定权重。默认是1</span><br><span class="line">inhibit_on_failure      //当服务器健康检查失败时，将其weight设置为0， \</span><br><span class="line">                        而不是从Virtual Server中移除</span><br><span class="line">notify_up &lt;STRING&gt;      //当服务器健康检查成功时，执行的脚本</span><br><span class="line">notify_down &lt;STRING&gt;    //当服务器健康检查失败时，执行的脚本</span><br><span class="line">uthreshold &lt;INT&gt;        //到这台服务器的最大连接数</span><br><span class="line">lthreshold &lt;INT&gt;        //到这台服务器的最小连接数</span><br></pre></td></tr></table></figure>

<p><strong>tcp_check段配置</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">connect_ip &lt;IP ADDRESS&gt;     //连接的IP地址。默认是real server的ip地址</span><br><span class="line">connect_port &lt;PORT&gt;         //连接的端口。默认是real server的端口</span><br><span class="line">bindto &lt;IP ADDRESS&gt;         //发起连接的接口的地址。</span><br><span class="line">bind_port &lt;PORT&gt;            //发起连接的源端口。</span><br><span class="line">connect_timeout &lt;INT&gt;       //连接超时时间。默认是5s。</span><br><span class="line">fwmark &lt;INTEGER&gt;            //使用fwmark对所有出去的检查数据包进行标记。</span><br><span class="line">warmup &lt;INT&gt;    //指定一个随机延迟，最大为N秒。可防止网络阻塞。如果为0，则关闭该功能。</span><br><span class="line">retry &lt;INIT&gt;                //重试次数。默认是1次。</span><br><span class="line">delay_before_retry &lt;INT&gt;    //默认是1秒。在重试之前延迟多少秒。</span><br></pre></td></tr></table></figure>

<h3 id="2-3-实例"><a href="#2-3-实例" class="headerlink" title="2.3 实例"></a>2.3 实例</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">global_defs &#123;</span><br><span class="line">    router_id LVS_Server</span><br><span class="line">&#125;</span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state BACKUP</span><br><span class="line">    interface ens33</span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    priority 150</span><br><span class="line">    nopreempt</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass itwhs</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;  </span><br><span class="line">        172.16.137.250 dev ens192</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">virtual_server 172.16.137.250 80 &#123;</span><br><span class="line">    delay_loop 3</span><br><span class="line">    lvs_sched rr</span><br><span class="line">    lvs_method DR</span><br><span class="line">    protocol TCP</span><br><span class="line">    real_server 172.16.137.11 80 &#123;</span><br><span class="line">        weight 1</span><br><span class="line">        TCP_CHECK &#123;</span><br><span class="line">            connect_port 80</span><br><span class="line">            connect_timeout 3</span><br><span class="line">            nb_get_retry 3</span><br><span class="line">            delay_before_retry 3</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    real_server 172.16.137.12 8080 &#123;</span><br><span class="line">        weight 1</span><br><span class="line">        TCP_CHECK &#123;</span><br><span class="line">            connect_port 8080</span><br><span class="line">            connect_timeout 3</span><br><span class="line">            nb_get_retry 3</span><br><span class="line">            delay_before_retry 3</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="3-脑裂"><a href="#3-脑裂" class="headerlink" title="3 脑裂"></a>3 脑裂</h2><p>在高可用（HA）系统中，当联系2个节点的“心跳线”断开时，本来为一整体、动作协调的HA系统，就分裂成为2个独立的个体。由于相互失去了联系，都以为是对方出了故障。两个节点上的HA软件像“裂脑人”一样，争抢“共享资源”、争起“应用服务”，就会发生严重后果——或者共享资源被瓜分、2边“服务”都起不来了；或者2边“服务”都起来了，但同时读写“共享存储”，导致数据损坏（常见如数据库轮询着的联机日志出错）。</p>
<p>对付HA系统“裂脑”的对策，目前达成共识的的大概有以下几条：</p>
<ul>
<li>添加冗余的心跳线，例如：双线条线（心跳线也HA），尽量减少“裂脑”发生几率；</li>
<li>启用磁盘锁。正在服务一方锁住共享磁盘，“裂脑”发生时，让对方完全“抢不走”共享磁盘资源。但使用锁磁盘也会有一个不小的问题，如果占用共享盘的一方不主动“解锁”，另一方就永远得不到共享磁盘。现实中假如服务节点突然死机或崩溃，就不可能执行解锁命令。后备节点也就接管不了共享资源和应用服务。于是有人在HA中设计了“智能”锁。即：正在服务的一方只在发现心跳线全部断开（察觉不到对端）时才启用磁盘锁。平时就不上锁了。</li>
<li>设置仲裁机制。例如设置参考IP（如网关IP），当心跳线完全断开时，2个节点都各自ping一下参考IP，不通则表明断点就出在本端。不仅“心跳”、还兼对外“服务”的本端网络链路断了，即使启动（或继续）应用服务也没有用了，那就主动放弃竞争，让能够ping通参考IP的一端去起服务。更保险一些，ping不通参考IP的一方干脆就自我重启，以彻底释放有可能还占用着的那些共享资源</li>
</ul>
<h3 id="3-1-脑裂产生的原因"><a href="#3-1-脑裂产生的原因" class="headerlink" title="3.1 脑裂产生的原因"></a>3.1 脑裂产生的原因</h3><p>一般来说，脑裂的发生，有以下几种原因：</p>
<ul>
<li>高可用服务器对之间心跳线链路发生故障，导致无法正常通信<ul>
<li>因心跳线坏了（包括断了，老化）</li>
<li>因网卡及相关驱动坏了，ip配置及冲突问题（网卡直连）</li>
<li>因心跳线间连接的设备故障（网卡及交换机）</li>
<li>因仲裁的机器出问题（采用仲裁的方案）</li>
</ul>
</li>
<li>高可用服务器上开启了 iptables防火墙阻挡了心跳消息传输</li>
<li>高可用服务器上心跳网卡地址等信息配置不正确，导致发送心跳失败</li>
<li>其他服务配置不当等原因，如心跳方式不同，心跳广插冲突、软件Bug等</li>
</ul>
<p><strong>注意：</strong></p>
<blockquote>
<p>Keepalived配置里同一 VRRP实例如果 virtual_router_id两端参数配置不一致也会导致裂脑问题发生。</p>
</blockquote>
<h3 id="3-2-脑裂的常见解决方案"><a href="#3-2-脑裂的常见解决方案" class="headerlink" title="3.2 脑裂的常见解决方案"></a>3.2 脑裂的常见解决方案</h3><p>在实际生产环境中，我们可以从以下几个方面来防止裂脑问题的发生：</p>
<ul>
<li><p>同时使用串行电缆和以太网电缆连接，同时用两条心跳线路，这样一条线路坏了，另一个还是好的，依然能传送心跳消息</p>
</li>
<li><p>当检测到裂脑时强行关闭一个心跳节点（这个功能需特殊设备支持，如Stonith、feyce）。相当于备节点接收不到心跳消患，通过单独的线路发送关机命令关闭主节点的电源</p>
</li>
<li><p>做好对裂脑的监控报警（如邮件及手机短信等或值班）.在问题发生时人为第一时间介入仲裁，降低损失。例如，百度的监控报警短倍就有上行和下行的区别。报警消息发送到管理员手机上，管理员可以通过手机回复对应数字或简单的字符串操作返回给服务器.让服务器根据指令自动处理相应故障，这样解决故障的时间更短.</p>
</li>
</ul>
<p>当然，在实施高可用方案时，要根据业务实际需求确定是否能容忍这样的损失。对于一般的网站常规业务.这个损失是可容忍的</p>
<h3 id="3-3-对脑裂进行监控"><a href="#3-3-对脑裂进行监控" class="headerlink" title="3.3 对脑裂进行监控"></a>3.3 对脑裂进行监控</h3><p>对脑裂的监控应在备用服务器上进行，通过添加zabbix自定义监控进行。<br>监控什么信息呢？监控备上有无VIP地址</p>
<p>备机上出现VIP有两种情况：</p>
<ul>
<li>发生了脑裂</li>
<li>正常的主备切换</li>
</ul>
<p>监控只是监控发生脑裂的可能性，不能保证一定是发生了脑裂，因为正常的主备切换VIP也是会到备上的。</p>
<p>监控脚本如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@slave ~]# mkdir -p /scripts &amp;&amp; cd /scripts</span><br><span class="line">[root@slave scripts]# vim check_keepalived.sh</span><br><span class="line">#!/bin/bash</span><br><span class="line"></span><br><span class="line">while true</span><br><span class="line">do</span><br><span class="line">if [ `ip a show ens33 |grep 172.16.137.250|wc -l` -ne 0 ]</span><br><span class="line">then</span><br><span class="line">    echo &quot;keepalived is error!&quot;</span><br><span class="line">else</span><br><span class="line">    echo &quot;keepalived is OK !&quot;</span><br><span class="line">fi</span><br><span class="line">done</span><br></pre></td></tr></table></figure>

<p>编写脚本时要注意，网卡要改成你自己的网卡名称，VIP也要改成你自己的VIP，最后不要忘了给脚本赋予执行权限，且要修改/scripts目录的属主属组为zabbix</p>
<h2 id="4-keepalived实现nginx负载均衡机高可用"><a href="#4-keepalived实现nginx负载均衡机高可用" class="headerlink" title="4. keepalived实现nginx负载均衡机高可用"></a>4. keepalived实现nginx负载均衡机高可用</h2><p><strong>环境说明</strong></p>
<table>
<thead>
<tr>
<th align="center">系统信息</th>
<th align="left">主机名</th>
<th align="left">IP</th>
</tr>
</thead>
<tbody><tr>
<td align="center">centos7.6</td>
<td align="left">master</td>
<td align="left">172.16.137.11</td>
</tr>
<tr>
<td align="center">centos7.6</td>
<td align="left">slave</td>
<td align="left">172.16.137.12</td>
</tr>
</tbody></table>
<p>本次高可用虚拟IP（VIP）地址暂定为 172.16.137.250</p>
<h3 id="4-1-keepalived安装"><a href="#4-1-keepalived安装" class="headerlink" title="4.1 keepalived安装"></a>4.1 keepalived安装</h3><p><strong>配置主keepalived</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">关闭防火墙与SELINUX</span><br><span class="line">[root@master ~]# systemctl stop firewalld</span><br><span class="line">[root@master ~]# systemctl disable firewalld</span><br><span class="line">Removed symlink /etc/systemd/system/multi-user.target.wants/firewalld.service.</span><br><span class="line">Removed symlink /etc/systemd/system/dbus-org.fedoraproject.FirewallD1.service.</span><br><span class="line">[root@master ~]# setenforce 0</span><br><span class="line">[root@master ~]# sed -ri &apos;s/^(SELINUX=).*/\1disabled/g&apos; /etc/selinux/config</span><br><span class="line"></span><br><span class="line">配置网络源</span><br><span class="line">[root@master ~]# curl -o /etc/yum.repos.d/CentOS7-Base-163.repo http://mirrors.163.com/.help/CentOS7-Base-163.repo</span><br><span class="line">[root@master ~]# sed -i &apos;s/\$releasever/7/g&apos; /etc/yum.repos.d/CentOS7-Base-163.repo</span><br><span class="line">[root@master ~]# sed -i &apos;s/^enabled=.*/enabled=1/g&apos; /etc/yum.repos.d/CentOS7-Base-163.repo</span><br><span class="line">[root@master ~]# yum -y install epel-release vim wget gcc gcc-c++</span><br><span class="line">安装过程略.....</span><br><span class="line"></span><br><span class="line">安装keepalived</span><br><span class="line">[root@master ~]# yum -y install keepalived</span><br><span class="line"></span><br><span class="line">查看安装生成的文件</span><br><span class="line">[root@master ~]# rpm -ql keepalived</span><br><span class="line">/etc/keepalived     //配置目录</span><br><span class="line">/etc/keepalived/keepalived.conf     //此为主配置文件</span><br><span class="line">/etc/sysconfig/keepalived</span><br><span class="line">/usr/bin/genhash</span><br><span class="line">/usr/lib/systemd/system/keepalived.service      //此为服务控制文件</span><br><span class="line">/usr/libexec/keepalived</span><br><span class="line">/usr/sbin/keepalived</span><br><span class="line">.....此处省略N行</span><br></pre></td></tr></table></figure>

<p><strong>用同样的方法在备服务器上安装keepalived</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">关闭防火墙与SELINUX</span><br><span class="line">[root@slave ~]# systemctl stop firewalld</span><br><span class="line">[root@slave ~]# systemctl disable firewalld</span><br><span class="line">Removed symlink /etc/systemd/system/multi-user.target.wants/firewalld.service.</span><br><span class="line">Removed symlink /etc/systemd/system/dbus-org.fedoraproject.FirewallD1.service.</span><br><span class="line">[root@slave ~]# setenforce 0</span><br><span class="line">[root@slave ~]# sed -ri &apos;s/^(SELINUX=).*/\1disabled/g&apos; /etc/selinux/config</span><br><span class="line"></span><br><span class="line">配置网络源</span><br><span class="line">[root@slave ~]# curl -o /etc/yum.repos.d/CentOS7-Base-163.repo http://mirrors.163.com/.help/CentOS7-Base-163.repo</span><br><span class="line">[root@slave ~]# sed -i &apos;s/\$releasever/7/g&apos; /etc/yum.repos.d/CentOS7-Base-163.repo</span><br><span class="line">[root@slave ~]# sed -i &apos;s/^enabled=.*/enabled=1/g&apos; /etc/yum.repos.d/CentOS7-Base-163.repo</span><br><span class="line">[root@slave ~]# yum -y install epel-release vim wget gcc gcc-c++</span><br><span class="line">安装过程略.....</span><br><span class="line"></span><br><span class="line">安装keepalived</span><br><span class="line">[root@slave ~]# yum -y install keepalived</span><br></pre></td></tr></table></figure>

<h3 id="4-2-在主备机上分别安装nginx"><a href="#4-2-在主备机上分别安装nginx" class="headerlink" title="4.2 在主备机上分别安装nginx"></a>4.2 在主备机上分别安装nginx</h3><p><strong>在master上安装nginx</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# yum -y install nginx</span><br><span class="line">[root@master ~]# cd /usr/share/nginx/html/</span><br><span class="line">[root@master html]# ls</span><br><span class="line">404.html  50x.html  index.html  nginx-logo.png  poweredby.png</span><br><span class="line">[root@master html]# mv index.html&#123;,.bak&#125;</span><br><span class="line">[root@master html]# echo &apos;master&apos; &gt; index.html</span><br><span class="line">[root@master html]# ls</span><br><span class="line">404.html  50x.html  index.html  index.html.bak  nginx-logo.png  poweredby.png</span><br><span class="line">[root@master html]# systemctl start nginx</span><br><span class="line">[root@master html]# systemctl enable nginx</span><br><span class="line">[root@master html]# ss -antl</span><br><span class="line">State       Recv-Q Send-Q Local Address:Port               Peer Address:Port</span><br><span class="line">LISTEN      0      128              *:80                           *:*</span><br><span class="line">LISTEN      0      128              *:22                           *:*</span><br><span class="line">LISTEN      0      100      127.0.0.1:25                           *:*</span><br><span class="line">LISTEN      0      128             :::80                          :::*</span><br><span class="line">LISTEN      0      128             :::22                          :::*</span><br><span class="line">LISTEN      0      100            ::1:25                          :::*</span><br></pre></td></tr></table></figure>

<p><strong>在slave上安装nginx</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@slave ~]# yum -y install nginx</span><br><span class="line">[root@slave ~]# cd /usr/share/nginx/html/</span><br><span class="line">[root@slave html]# ls</span><br><span class="line">404.html  50x.html  index.html  nginx-logo.png  poweredby.png</span><br><span class="line">[root@slave html]# mv index.html&#123;,.bak&#125;</span><br><span class="line">[root@slave html]# echo &apos;slave&apos; &gt; index.html</span><br><span class="line">[root@slave html]# ls</span><br><span class="line">404.html  50x.html  index.html  index.html.bak  nginx-logo.png  poweredby.png</span><br><span class="line">[root@slave html]# systemctl start nginx</span><br><span class="line">[root@slave html]# systemctl enable nginx</span><br></pre></td></tr></table></figure>

<p><strong>在浏览器上访问试试，确保master上的nginx服务能够正常访问</strong></p>
<h3 id="4-3-keepalived配置"><a href="#4-3-keepalived配置" class="headerlink" title="4.3 keepalived配置"></a>4.3 keepalived配置</h3><h4 id="4-3-1-配置主keepalived"><a href="#4-3-1-配置主keepalived" class="headerlink" title="4.3.1 配置主keepalived"></a>4.3.1 配置主keepalived</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# vim /etc/keepalived/keepalived.conf</span><br><span class="line">! Configuration File for keepalived</span><br><span class="line"></span><br><span class="line">global_defs &#123;</span><br><span class="line">   router_id lb01</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state MASTER</span><br><span class="line">    interface ens33</span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    priority 100</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass itwhs</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        172.16.137.250</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">virtual_server 172.16.137.250 80 &#123;</span><br><span class="line">    delay_loop 6</span><br><span class="line">    lb_algo rr</span><br><span class="line">    lb_kind DR</span><br><span class="line">    persistence_timeout 50</span><br><span class="line">    protocol TCP</span><br><span class="line"></span><br><span class="line">    real_server 172.16.137.11 80 &#123;</span><br><span class="line">        weight 1</span><br><span class="line">        TCP_CHECK &#123;</span><br><span class="line">            connect_port 80</span><br><span class="line">            connect_timeout 3</span><br><span class="line">            nb_get_retry 3</span><br><span class="line">            delay_before_retry 3</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    real_server 172.16.137.12 80 &#123;</span><br><span class="line">        weight 1</span><br><span class="line">        TCP_CHECK &#123;</span><br><span class="line">            connect_port 80</span><br><span class="line">            connect_timeout 3</span><br><span class="line">            nb_get_retry 3</span><br><span class="line">            delay_before_retry 3</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@master ~]# systemctl start keepalived</span><br><span class="line">[root@master ~]# systemctl enable keepalived</span><br></pre></td></tr></table></figure>

<h4 id="4-3-2-配置备keepalived"><a href="#4-3-2-配置备keepalived" class="headerlink" title="4.3.2 配置备keepalived"></a>4.3.2 配置备keepalived</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">[root@slave ~]# vim /etc/keepalived/keepalived.conf</span><br><span class="line">! Configuration File for keepalived</span><br><span class="line"></span><br><span class="line">global_defs &#123;</span><br><span class="line">   router_id lb02</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state BACKUP</span><br><span class="line">    interface eth0</span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    priority 90</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass itwhs</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        172.16.137.250</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">virtual_server 172.16.137.250 80 &#123;</span><br><span class="line">    delay_loop 6</span><br><span class="line">    lb_algo rr</span><br><span class="line">    lb_kind DR</span><br><span class="line">    persistence_timeout 50</span><br><span class="line">    protocol TCP</span><br><span class="line"></span><br><span class="line">    real_server 172.16.137.11 80 &#123;</span><br><span class="line">        weight 1</span><br><span class="line">        TCP_CHECK &#123;</span><br><span class="line">            connect_port 80</span><br><span class="line">            connect_timeout 3</span><br><span class="line">            nb_get_retry 3</span><br><span class="line">            delay_before_retry 3</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    real_server 172.16.137.12 80 &#123;</span><br><span class="line">        weight 1</span><br><span class="line">        TCP_CHECK &#123;</span><br><span class="line">            connect_port 80</span><br><span class="line">            connect_timeout 3</span><br><span class="line">            nb_get_retry 3</span><br><span class="line">            delay_before_retry 3</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@slave ~]# systemctl start keepalived</span><br><span class="line">[root@slave ~]# systemctl enable keepalived</span><br></pre></td></tr></table></figure>

<h4 id="4-3-3-查看VIP在哪里"><a href="#4-3-3-查看VIP在哪里" class="headerlink" title="4.3.3 查看VIP在哪里"></a>4.3.3 查看VIP在哪里</h4><p><strong>在MASTER上查看</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# ip a</span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN qlen 1</span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 ::1/128 scope host</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: ens192: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP qlen 1000</span><br><span class="line">    link/ether 00:0c:29:c0:ed:3b brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.16.137.11/24 brd 172.16.137.255 scope global ens192</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet 172.16.137.250/32 scope global ens192        //可以看到此处有VIP</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::20c:29ff:fec0:ed3b/64 scope link</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure>

<p><strong>在SLAVE上查看</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@slave ~]# ip a</span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN qlen 1</span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 ::1/128 scope host</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP qlen 1000</span><br><span class="line">    link/ether 00:0c:29:b5:38:80 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.16.137.12/24 brd 172.16.137.255 scope global dynamic eth0</span><br><span class="line">       valid_lft 1303sec preferred_lft 1303sec</span><br><span class="line">    inet6 fe80::20c:29ff:feb5:3880/64 scope link</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure>

<h3 id="4-4-修改内核参数，开启监听VIP功能"><a href="#4-4-修改内核参数，开启监听VIP功能" class="headerlink" title="4.4 修改内核参数，开启监听VIP功能"></a>4.4 修改内核参数，开启监听VIP功能</h3><p><strong>此步可做可不做，该功能可用于仅监听VIP的时候</strong>(有bug,好像已失效)</p>
<p><strong>在master上修改内核参数</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# echo &apos;net.ipv4.ip_nonlocal_bind = 1&apos; &gt;&gt;/etc/sysctl.conf</span><br><span class="line">[root@master ~]# sysctl -p</span><br><span class="line">net.ipv4.ip_nonlocal_bind = 1</span><br><span class="line">[root@master ~]# cat /proc/sys/net/ipv4/ip_nonlocal_bind</span><br><span class="line">1</span><br></pre></td></tr></table></figure>

<p><strong>在slave上修改内核参数</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@slave ~]# echo &apos;net.ipv4.ip_nonlocal_bind = 1&apos; &gt;&gt;/etc/sysctl.conf</span><br><span class="line">[root@slave ~]# sysctl -p</span><br><span class="line">net.ipv4.ip_nonlocal_bind = 1</span><br><span class="line">[root@slave ~]# cat /proc/sys/net/ipv4/ip_nonlocal_bind</span><br><span class="line">1</span><br></pre></td></tr></table></figure>

<h3 id="4-5-让keepalived监控nginx负载均衡机"><a href="#4-5-让keepalived监控nginx负载均衡机" class="headerlink" title="4.5 让keepalived监控nginx负载均衡机"></a>4.5 让keepalived监控nginx负载均衡机</h3><p>keepalived通过脚本来监控nginx负载均衡机的状态</p>
<p><strong>在master上编写脚本</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# mkdir /scripts</span><br><span class="line">[root@master ~]# cd /scripts/</span><br><span class="line">[root@master scripts]# vim check_n.sh</span><br><span class="line">#!/bin/bash</span><br><span class="line">nginx_status=$(ps -ef|grep -Ev &quot;grep|$0&quot;|grep &apos;\bnginx\b&apos;|wc -l)</span><br><span class="line">if [ $nginx_status -lt 1 ];then</span><br><span class="line">    systemctl stop keepalived</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">[root@master scripts]# chmod +x check_n.sh</span><br><span class="line">[root@master scripts]# ll</span><br><span class="line">total 4</span><br><span class="line">-rwxr-xr-x 1 root root 168 Oct 19 23:38 check_n.sh</span><br><span class="line"></span><br><span class="line">[root@master scripts]# vim notify.sh</span><br><span class="line">#!/bin/bash</span><br><span class="line">VIP=$2</span><br><span class="line">sendmail ()&#123;</span><br><span class="line">        subject=&quot;$&#123;VIP&#125;&apos;s server keepalived state is translate&quot;</span><br><span class="line">        content=&quot;`date +&apos;%F %T&apos;`: `hostname`&apos;s state change to master&quot;</span><br><span class="line">        echo $content | mail -s &quot;$subject&quot; 邮箱地址</span><br><span class="line">&#125;</span><br><span class="line">case &quot;$1&quot; in</span><br><span class="line">  master)</span><br><span class="line">        nginx_status=$(ps -ef|grep -Ev &quot;grep|$0&quot;|grep &apos;\bnginx\b&apos;|wc -l)</span><br><span class="line">        if [ $nginx_status -lt 1 ];then</span><br><span class="line">            systemctl start nginx</span><br><span class="line">        fi</span><br><span class="line">        sendmail</span><br><span class="line">  ;;</span><br><span class="line">  backup)</span><br><span class="line">        nginx_status=$(ps -ef|grep -Ev &quot;grep|$0&quot;|grep &apos;\bnginx\b&apos;|wc -l)</span><br><span class="line">        if [ $nginx_status -gt 0 ];then</span><br><span class="line">            systemctl stop nginx</span><br><span class="line">        fi</span><br><span class="line">  ;;</span><br><span class="line">  *)</span><br><span class="line">        echo &quot;Usage:$0 master|backup VIP&quot;</span><br><span class="line">  ;;</span><br><span class="line">esac</span><br><span class="line"></span><br><span class="line">[root@master scripts]# chmod +x notify.sh</span><br><span class="line">[root@master scripts]# ll</span><br><span class="line">total 8</span><br><span class="line">-rwxr-xr-x 1 root root 168 Oct 19 23:38 check_n.sh</span><br><span class="line">-rwxr-xr-x 1 root root 594 Oct 20 03:24 notify.sh</span><br></pre></td></tr></table></figure>

<p><strong>在slave上编写脚本</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">[root@slave ~]# mkdir /scripts</span><br><span class="line">[root@slave ~]# cd /scripts/</span><br><span class="line">[root@slave scripts]# vim notify.sh</span><br><span class="line">#!/bin/bash</span><br><span class="line">VIP=$2</span><br><span class="line">sendmail ()&#123;</span><br><span class="line">        subject=&quot;$&#123;VIP&#125;&apos;s server keepalived state is translate&quot;</span><br><span class="line">        content=&quot;`date +&apos;%F %T&apos;`: `hostname`&apos;s state change to master&quot;</span><br><span class="line">        echo $content | mail -s &quot;$subject&quot; 邮箱地址</span><br><span class="line">&#125;</span><br><span class="line">case &quot;$1&quot; in</span><br><span class="line">  master)</span><br><span class="line">        nginx_status=$(ps -ef|grep -Ev &quot;grep|$0&quot;|grep &apos;\bnginx\b&apos;|wc -l)</span><br><span class="line">        if [ $nginx_status -lt 1 ];then</span><br><span class="line">            systemctl start nginx</span><br><span class="line">        fi</span><br><span class="line">        sendmail</span><br><span class="line">  ;;</span><br><span class="line">  backup)</span><br><span class="line">        nginx_status=$(ps -ef|grep -Ev &quot;grep|$0&quot;|grep &apos;\bnginx\b&apos;|wc -l)</span><br><span class="line">        if [ $nginx_status -gt 0 ];then</span><br><span class="line">            systemctl stop nginx</span><br><span class="line">        fi</span><br><span class="line">  ;;</span><br><span class="line">  *)</span><br><span class="line">        echo &quot;Usage:$0 master|backup VIP&quot;</span><br><span class="line">  ;;</span><br><span class="line">esac</span><br><span class="line"></span><br><span class="line">[root@slave scripts]# chmod +x notify.sh</span><br><span class="line">[root@slave scripts]# ll</span><br><span class="line">total 8</span><br><span class="line">-rwxr-xr-x 1 root root 168 Oct 19 23:38 check_n.sh</span><br><span class="line">-rwxr-xr-x 1 root root 594 Oct 20 03:24 notify.sh</span><br></pre></td></tr></table></figure>

<p><strong>此处的脚本名称应避免与服务名相同，推荐用服务名的首字母代替，如check_n，不要给脚本起名check_nginx</strong></p>
<h3 id="4-6-配置keepalived加入监控脚本的配置"><a href="#4-6-配置keepalived加入监控脚本的配置" class="headerlink" title="4.6 配置keepalived加入监控脚本的配置"></a>4.6 配置keepalived加入监控脚本的配置</h3><p><strong>配置主keepalived</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# vim /etc/keepalived/keepalived.conf</span><br><span class="line">! Configuration File for keepalived</span><br><span class="line"></span><br><span class="line">global_defs &#123;</span><br><span class="line">   router_id lb01</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_script nginx_check &#123;</span><br><span class="line">    script &quot;/scripts/check_n.sh&quot;</span><br><span class="line">    interval 1</span><br><span class="line">    weight -20</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state MASTER</span><br><span class="line">    interface ens33</span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    priority 100</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass itwhs</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        172.16.137.250</span><br><span class="line">    &#125;</span><br><span class="line">    track_script &#123;</span><br><span class="line">        nginx_check</span><br><span class="line">    &#125;</span><br><span class="line">    notify_master &quot;/scripts/notify.sh master 172.16.137.250&quot;</span><br><span class="line">    notify_backup &quot;/scripts/notify.sh backup 172.16.137.250&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">virtual_server 172.16.137.250 80 &#123;</span><br><span class="line">    delay_loop 6</span><br><span class="line">    lb_algo rr</span><br><span class="line">    lb_kind DR</span><br><span class="line">    persistence_timeout 50</span><br><span class="line">    protocol TCP</span><br><span class="line"></span><br><span class="line">    real_server 172.16.137.11 80 &#123;</span><br><span class="line">        weight 1</span><br><span class="line">        TCP_CHECK &#123;</span><br><span class="line">            connect_port 80</span><br><span class="line">            connect_timeout 3</span><br><span class="line">            nb_get_retry 3</span><br><span class="line">            delay_before_retry 3</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    real_server 172.16.137.12 80 &#123;</span><br><span class="line">        weight 1</span><br><span class="line">        TCP_CHECK &#123;</span><br><span class="line">            connect_port 80</span><br><span class="line">            connect_timeout 3</span><br><span class="line">            nb_get_retry 3</span><br><span class="line">            delay_before_retry 3</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@master ~]# systemctl restart keepalived</span><br></pre></td></tr></table></figure>

<p><strong>配置备keepalived</strong></p>
<blockquote>
<p>backup无需检测nginx是否正常，当升级为MASTER时启动nginx，当降级为BACKUP时关闭</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">[root@slave ~]# vim /etc/keepalived/keepalived.conf</span><br><span class="line">! Configuration File for keepalived</span><br><span class="line"></span><br><span class="line">global_defs &#123;</span><br><span class="line">   router_id lb02</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state BACKUP</span><br><span class="line">    interface eth0</span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    priority 90</span><br><span class="line">    nopreempt</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass itwhs</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        172.16.137.250</span><br><span class="line">    &#125;</span><br><span class="line">    notify_master &quot;/scripts/notify.sh master 172.16.137.250&quot;</span><br><span class="line">    notify_backup &quot;/scripts/notify.sh backup 172.16.137.250&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">virtual_server 172.16.137.250 80 &#123;</span><br><span class="line">    delay_loop 6</span><br><span class="line">    lb_algo rr</span><br><span class="line">    lb_kind DR</span><br><span class="line">    persistence_timeout 50</span><br><span class="line">    protocol TCP</span><br><span class="line"></span><br><span class="line">    real_server 172.16.137.11 80 &#123;</span><br><span class="line">        weight 1</span><br><span class="line">        TCP_CHECK &#123;</span><br><span class="line">            connect_port 80</span><br><span class="line">            connect_timeout 3</span><br><span class="line">            nb_get_retry 3</span><br><span class="line">            delay_before_retry 3</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    real_server 172.16.137.12 80 &#123;</span><br><span class="line">        weight 1</span><br><span class="line">        TCP_CHECK &#123;</span><br><span class="line">            connect_port 80</span><br><span class="line">            connect_timeout 3</span><br><span class="line">            nb_get_retry 3</span><br><span class="line">            delay_before_retry 3</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@slave ~]# systemctl restart keepalived</span><br></pre></td></tr></table></figure>
          
        
      
    </div>

    

    

    
    
    

    

    
      
    
    

    
	
	  <div>
        
      </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://aiwhs.github.io/2019/02/24/LVS 负载均衡器总结/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="itw">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="itw">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/02/24/LVS 负载均衡器总结/" class="post-title-link" itemprop="url">LVS</a>
              
            
          </h1>
        

        <div class="post-meta">

          
          
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-02-24 08:15:57" itemprop="dateCreated datePublished" datetime="2019-02-24T08:15:57+08:00">2019-02-24</time>
            </span>
          

          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-07-17 20:42:04" itemprop="dateModified" datetime="2019-07-17T20:42:04+08:00">2019-07-17</time>
              </span>
            
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Linux运维/" itemprop="url" rel="index"><span itemprop="name">Linux运维</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          <br>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <a id="more"></a>



<h2 id="负载均衡和高可用的简单介绍"><a href="#负载均衡和高可用的简单介绍" class="headerlink" title="负载均衡和高可用的简单介绍"></a>负载均衡和高可用的简单介绍</h2><h3 id="1-LB-LoadBalancer-负载均衡-或称为调度器"><a href="#1-LB-LoadBalancer-负载均衡-或称为调度器" class="headerlink" title="1.LB(LoadBalancer)负载均衡,或称为调度器"></a>1.LB(LoadBalancer)负载均衡,或称为调度器</h3><ul>
<li>硬件：<ul>
<li>F5 Big-IP </li>
<li>Citrix(思杰) Netscaler 最常用</li>
<li>A10</li>
<li>Array</li>
<li>Redware</li>
</ul>
</li>
<li>软件：<ul>
<li><strong>LVS(4层)</strong>：根据套接字来负载均衡。 套接字=IP + 端口 </li>
<li><strong>Nginx(7层) ：更适合http，smtp，pop3，imap的负载均衡</strong></li>
<li><strong>Haproxy(7层)</strong> :根据用户请求的内容来调度。<ul>
<li>它支持4层和7层的负载均衡，其更适合http，tcp(如：mysql，smtp)</li>
</ul>
</li>
<li>ats</li>
<li>perlbal</li>
</ul>
</li>
<li>LB集群主要以提高并发能力为根本<ul>
<li>LB的功能：<ul>
<li>监控主服务器的存活情况</li>
<li>故障切换时，完成挂载存储，启动服务，抢占VIP</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="2-HA-HighAvailability-高可用集群"><a href="#2-HA-HighAvailability-高可用集群" class="headerlink" title="2. HA(HighAvailability) 高可用集群"></a>2. HA(HighAvailability) 高可用集群</h3><p>在线时间/(在线时间 + 故障恢复时间)</p>
<p>RHCS,heartbeat,pacemaker,<strong>rose(windows),PowerHA(AIX)：目前这些使用都不多了。</strong></p>
<p><strong>主流是：Keepalived,目前官方也非常活跃,更新版本为2.x。</strong></p>
<p>高可用指标：99％, 99.9%, 99.99%, 99.999%</p>
<p>HA集群主要解决提高服务在线时间为根本</p>
<h3 id="3-HPC-High-Performance-Computing-高性能计算【HPC集群主要解决大任务计算的问题】"><a href="#3-HPC-High-Performance-Computing-高性能计算【HPC集群主要解决大任务计算的问题】" class="headerlink" title="3.HPC(High-Performance Computing):高性能计算【HPC集群主要解决大任务计算的问题】"></a>3.HPC(High-Performance Computing):高性能计算【HPC集群主要解决大任务计算的问题】</h3><ul>
<li>MapReduce</li>
<li>追踪任务完成的状态</li>
<li>Hadoop</li>
</ul>
<p><strong>LVS的工作原理:</strong></p>
<p>LVS的两大组件：</p>
<ul>
<li><p>用户空间： ipvsadm</p>
</li>
<li><p>内核空间： ipvs</p>
</li>
</ul>
<p>当用户请求被网卡收到，该请求将最先来到PREROUTING链，接着进入INPUT链，当请求进入INPUT链后，ipvs将监听<br>到这个连接请求，并将该连接请求重定向到自己，接着根据内部调度规则进行匹配，若没有匹配到则将该请求原封不动的转交给INPUT链，最终被INPUT链转发给监听在指定套接字(IP+Port)的应用程序。若匹配调度规则，则ipvs将修改该请求的相关地址(NAT模型：修改VIP–&gt;RIP; DR模型：修改目的MAC为RealSRV的MAC)后，重定向到POSTROUTING链上，最终转发到后端的Real Server上。</p>
<p>　　　　<img src="../../img/922925-20190524174631961-779300426.png" alt="img"></p>
<h3 id="LVS的四种工作模式介绍："><a href="#LVS的四种工作模式介绍：" class="headerlink" title="LVS的四种工作模式介绍："></a>LVS的四种工作模式介绍：</h3><ul>
<li><p>Virtual server via NAT（VS-NAT）</p>
<ul>
<li>优点：集群中的物理服务器可以使用任何支持TCP/IP操作系统，物理服务器可以分配Internet的保留私有地址，只有负载均衡器需要一个合法的IP地址。</li>
</ul>
</li>
<li><p>缺点：扩展性有限。当服务器节点（普通PC服务器）数据增长到20个或更多时,负载均衡器将成为整个系统的瓶颈，因为所有的请求包和应答包都需要经过负载均衡器。假使TCP包的平均长度是536字节的话，平均每个包重新构建,延迟时间大约为60us（在Pentium处理器上计算的，采用更快的处理器将使得这个延迟时间变短），负载均衡器的最大容许能力为8.93M/s，假定每台物理服务器的平台容许能力为400K/s来计算，负载均衡器能为22台物理服务器提供计算。</p>
</li>
</ul>
<p>解决办法：即使是是负载均衡器成为整个系统的瓶颈，如果是这样也有两种方法来解决它。一种是混合处理: 如果采用混合处理的方法，将需要许多同属单一的RR(DNS的资源记录) DNS域。另一种是采用Virtual Server via IP tunneling(即:Tunl模型)或Virtual Server via direct routing(即:DR模型) :若使用此方式可以获得更好的可扩展性；也可以嵌套使用负载均衡器，在最前端的是VS-Tunneling或<br>VS-DR的负载均衡器，然后后面采用VS-NAT的负载均衡器。</p>
<ul>
<li>Virtual server via IP tunneling（VS-TUN）</li>
</ul>
<p>我们发现，许多Internet服务（例如WEB服务器）的请求包很短小，而应答包通常很大。</p>
<pre><code>- 优点：负载均衡器只负责将请求包分发给物理服务器，而物理服务器将应答包直接发给用户。所以，负载均衡器能处理很巨大的请求量，这种方式，一台负载均衡能为超过100台的物理服务器服务，负载均衡器不再是系统的瓶颈。使用VS-TUN方式，如果你的负载均衡器拥有100M的全双工网卡的话，就能使得整个Virtual Server能达到1G的吞吐量。

- 缺点：但是，这种方式需要所有的服务器支持&quot;IP Tunneling&quot;(IP Encapsulation)协议，我仅在Linux系统上实现了这个，目前其它操作系统的支持还在探索之中。</code></pre><ul>
<li><p>Virtual Server via Direct Routing（VS-DR）</p>
<ul>
<li>优点：和VS－TUN一样，负载均衡器也只是分发请求，应答包通过单独的路由方法返回给客户端。与VS-TUN相比，VS-DR这种实现方式不需要隧道结构，因此可以使用大多数操作系统做为物理服务器，其中包括：Linux、Solaris 、FreeBSD 、windows、IRIX 6.5；HPUX11等。</li>
<li>缺点：要求负载均衡器的网卡必须与物理网卡在一个物理段上。</li>
</ul>
</li>
<li><p>LVS-FullNAT</p>
</li>
</ul>
<p>通过同时修改请求报文的源IP地址和目标IP地址进行转发（CIP –&gt; DIP, VIP –&gt; RIP ）此模式在跨机房，跨多个不同网络时,FullNAT模式也可实现调度。因为此时实际是将IP包的源和目标都修改了,就好象调度器直接去访问远端RealServer,远端RealServer只需要按照自己本地路由,找到网关,将包回应给远端调度器，远端调度器再次将回应包，返回给用户。</p>
<p>(1) VIP是公网地址，RIP和DIP是私网地址，且通常不在同一IP网络；因此，RIP的网关一般不会指向DIP</p>
<p>(2) RS收到的请求报文源地址是DIP，因此，只需响应给DIP；但Director还要将其发往Client</p>
<p>(3) 请求和响应报文都经由Director</p>
<p>(4) 支持端口映射</p>
<p><strong>注意</strong>：此类型kernel默认不支持</p>
<p>此中使用场景较少,仅阿里云内部的SLB使用此种模式.</p>
<p><strong>对上面三种IP负载均衡技术的优缺点比较:</strong></p>
<table>
<thead>
<tr>
<th>杂项</th>
<th>VS/NAT</th>
<th>VS/TUN</th>
<th>VS/DR</th>
</tr>
</thead>
<tbody><tr>
<td>服务器操作系统</td>
<td>任意</td>
<td>支持隧道</td>
<td>多数(支持Non-arp )</td>
</tr>
<tr>
<td>服务器网络</td>
<td>私有网络</td>
<td>局域网/广域网</td>
<td>局域网</td>
</tr>
<tr>
<td>服务器数目(100M网络)</td>
<td>10-20</td>
<td>100</td>
<td>多(100)</td>
</tr>
<tr>
<td>服务器网关</td>
<td>负载均衡器</td>
<td>自己的路由</td>
<td>自己的路由</td>
</tr>
<tr>
<td>效率</td>
<td>一般</td>
<td>高</td>
<td>最高</td>
</tr>
</tbody></table>
<h4 id="LVS的调度算法介绍："><a href="#LVS的调度算法介绍：" class="headerlink" title="LVS的调度算法介绍："></a>LVS的调度算法介绍：</h4><h5 id="1-轮叫调度（Round-Robin）-简称rr"><a href="#1-轮叫调度（Round-Robin）-简称rr" class="headerlink" title="1.轮叫调度（Round Robin）(简称rr)"></a>1.轮叫调度（Round Robin）(简称rr)</h5><p>不考虑RealServer实际连接数,系统负载,只是轮流给每个RealServer分配请求.</p>
<h5 id="2-加权轮叫（Weighted-Round-Robin）（简称wrr"><a href="#2-加权轮叫（Weighted-Round-Robin）（简称wrr" class="headerlink" title="2.加权轮叫（Weighted Round Robin）（简称wrr)"></a>2.加权轮叫（Weighted Round Robin）（简称wrr)</h5><p>根据实际RealServer的主机配置,将主机配置强的RealServer更大的权重,让调度器分配更多请求给它处理,<br>同时调度器可自动询问RealServer的负载请求,并动态调整其权重值.</p>
<h5 id="3-最少链接（Least-Connections）-LC"><a href="#3-最少链接（Least-Connections）-LC" class="headerlink" title="3.最少链接（Least Connections）(LC) :"></a>3.最少链接（Least Connections）(LC) :</h5><p>将新的链接请求分配到当前链接数最小的服务器上.<br>调度器需要记录每个Server已经建立链接的数目,当调度器给A调度一个请求,则将A的总链接数+1,当链接中止/超时,则总链接-1。</p>
<p><strong>缺陷</strong>：</p>
<pre><code>- Server性能相同：可平滑分发负载，但不能将长链接的请求发向同一Server.

-  Server性能不同：该算法并不理会。</code></pre><p>因为TCP连接处理请求后会进入TIME_WAIT状态,TCP的TIME_WAIT一般为2分钟,此时连接还占用服务器的资源,所以会出现这样情形,性能高的服务器已处理所收到的连接,连接处于TIME_WAIT状态,而性能低的服务器已经忙于处理所收到的连接,还不断地收到新的连接请求。</p>
<p>4.加权最少链接（Weighted Least Connections）(WLC)</p>
<p>在集群系统中的服务器性能差异较大的情况下，调度器采用“加权最少链接”调度算法优化负载均衡性能，具有较高权值的服务器将承受较大比例的活动连接负载。调度器可以自动问询真实服务器的负载情况，并动态地调整其权值。</p>
<h5 id="5-目标地址散列（Destination-Hashing）-DH"><a href="#5-目标地址散列（Destination-Hashing）-DH" class="headerlink" title="5.目标地址散列（Destination Hashing）(DH)"></a>5.目标地址散列（Destination Hashing）(DH)</h5><p>“目标地址散列”调度算法根据请求的目标IP地址，作为散列键（Hash Key）从静态分配的散列表找出对应的服务器，若该服务器是可用的且未超载，将请求发送到该服务器，否则返回空。</p>
<p><strong>补充</strong>：目标地址散列调度(Destination Hashing Scheduling)算法,是针对目标IP地址的负载均衡,它是一种静态映射算法,<br>通过一个散列函数将一个目标IP地址映射为一台服务器。目标地址散列算法会先根据请求的目标IP,计算散列哈希(hash key),从静态分配的散列表找出对应的服务器,<br>若该服务器是可用且未超载，则将请求发给该服务器，否则返回空,重新调度。</p>
<p><strong>哈希散列表可理解如下</strong>：</p>
<p>　　　　　　<img src="../../img/922925-20190524165257607-95485930.png" alt="img"></p>
<p>在此算法中,默认它使用256个哈希桶来将目标IP的哈希值前1个字节划分,平均分成256份，每一份就是一个范围,这样我只要计算出目标IP的哈希值,马上就能确定它应该在那个桶中,然后定位到该桶，这样在做小范围表扫描，速度就非常快。另外还需要注意：在此算法中它类似于一致性哈希算法，它会事先将所有可用服务器均匀循环分布到每个桶中，更简单理解就是本来就是一张有256条记录的大表,<br>该表中事先将所有可用服务器全部顺序循环插入到每一行记录中,然后将这张大表拆分成多个小表,并按前面的方法,将一个范围值作为进入该小表的条件，这样就可以最大限度均匀每一台服务器的负载。</p>
<h5 id="6-源地址散列（Source-Hashing）-SH"><a href="#6-源地址散列（Source-Hashing）-SH" class="headerlink" title="6.源地址散列（Source Hashing）(SH)"></a>6.源地址散列（Source Hashing）(SH)</h5><p>“源地址散列”调度算法根据请求的源IP地址，作为散列键（Hash Key）从静态分配的散列表找出对应的服务器,若该服务器是可用的且未超载，将请求发送到该服务器，否则返回空。</p>
<h5 id="7-基于局部性的最少链接（Locality-Based-Least-Connections）-LBLC"><a href="#7-基于局部性的最少链接（Locality-Based-Least-Connections）-LBLC" class="headerlink" title="7.基于局部性的最少链接（Locality-Based Least Connections）(LBLC)"></a>7.基于局部性的最少链接（Locality-Based Least Connections）(LBLC)</h5><p>“基于局部性的最少链接”调度算法是针对目标IP地址的负载均衡，目前主要用于Cache集群系统。该算法根据请求的目标IP地址找出该目标IP地址最近使用的服务器，若该服务器是可用的且没有超载，将请求发送到该服务器；若服务器不存在，或者该服务器超载且有服务器处于一半的工作负载，则用“最少链接” 的原则选出一个可用的服务器，将请求发送到该服务器。</p>
<h5 id="8-带复制的基于局部性最少链接（Locality-Based-Least-Connections-with-Replication）-LBLCR"><a href="#8-带复制的基于局部性最少链接（Locality-Based-Least-Connections-with-Replication）-LBLCR" class="headerlink" title="8.带复制的基于局部性最少链接（Locality-Based Least Connections with Replication）(LBLCR)"></a>8.带复制的基于局部性最少链接（Locality-Based Least Connections with Replication）(LBLCR)</h5><p>　　　　<img src="../../img/922925-20190524165433339-926454398.png" alt="img"></p>
<p> “带复制的基于局部性最少链接”调度算法也是针对目标IP地址的负载均衡，目前主要用于Cache集群系统。<br>它与LBLC算法的不同之处是它要维护从一个目标 IP地址到一组服务器的映射，而LBLC算法维护从一个目标IP地址到一台服务器的映射。该算法根据请求的目标IP地址找出该目标IP地址对应的服务器组，按“最小连接”原则从服务器组中选出一台服务器，若服务器没有超载，将请求发送到该服务器；</p>
<p>若所选服务器超载（超负载的标准是:该服务器正在处理的连接总数 &gt; 其权重值的2倍），则按“最小连接”原则从这个集群中选出一台服务器，将该服务器加入到服务器组中，将请求发送到该服务器。同时，当该所选服务器组有一段时间没有被修改过,则所选服务器加入新缓存复制组后,很可能导致复制流量大量增加，因此将最忙的服务器从服务器组中删除，以降低复制流量的程度。</p>
<h5 id="9-最短的期望的延迟（Shortest-Expected-Delay-Scheduling-SED）-SED"><a href="#9-最短的期望的延迟（Shortest-Expected-Delay-Scheduling-SED）-SED" class="headerlink" title="9.最短的期望的延迟（Shortest Expected Delay Scheduling SED）(SED)"></a>9.最短的期望的延迟（Shortest Expected Delay Scheduling SED）(SED)</h5><p>基于wlc算法。这个必须举例来说了</p>
<p>ABC三台机器分别权重1，2，3 ，连接数也分别是1，2，3。那么如果使用WLC算法的话一个新请求进入时<br>它可能会分给ABC中的任意一个，使用sed算法后会进行这样一个运算</p>
<ul>
<li><p>A：(1+1)/1 = 2</p>
</li>
<li><p>B：(1+2)/2 = 1.5</p>
</li>
<li><p>C：(1+3)/3 = 1.3334</p>
</li>
</ul>
<p>根据运算结果，把连接交给C，因为C的处理延时最小 。</p>
<h5 id="10-最少队列调度（Never-Queue-Scheduling-NQ）-NQ"><a href="#10-最少队列调度（Never-Queue-Scheduling-NQ）-NQ" class="headerlink" title="10.最少队列调度（Never Queue Scheduling NQ）(NQ)"></a>10.最少队列调度（Never Queue Scheduling NQ）(NQ)</h5><p>无需队列。如果有台 realserver的连接数＝0就直接分配过去，不需要在进行sed运算。</p>
<h4 id="下面对三种模式做示例配置说明"><a href="#下面对三种模式做示例配置说明" class="headerlink" title="下面对三种模式做示例配置说明:"></a>下面对三种模式做示例配置说明:</h4><h5 id="1-LVS-NAT模型："><a href="#1-LVS-NAT模型：" class="headerlink" title="1.LVS-NAT模型："></a>1.LVS-NAT模型：</h5><p>简单的来说，LVS的NAT模型如下图：</p>
<p>　</p>
<p><img src="../../img/mmexport1560403332206.jpg" alt="NAT"></p>
<p>　　</p>
<p>本质是多目标IP的DNAT，通过将请求报文中的目标地址和目标端口修改为通过调度算法挑出的RS的RIP和PORT实现转发。</p>
<p>LVS-NAT模型:</p>
<p>（1）RealServer和调度器应在同一个IP网络，且应使用私网地址；RealServer的网关要指向调度器的IP</p>
<p>（2）调度器(Director)是RealServer的网关, 因此请求和响应报文都将由调度器转发,因此调度器容易成为系统瓶颈.</p>
<p>（3）支持端口映射，可修改请求报文的目标PORT</p>
<p>（4）LVS必须是Linux系统，RS可以是任意OS系统</p>
<p>上面拓扑图的配置如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">Cip:192.168.161.226/24    GW:公网网关</span><br><span class="line">Vip:192.168.161.184/24    GW:公网网关</span><br><span class="line">Dip:192.168.153.136/24    GW:没设</span><br><span class="line">Rip1:192.168.153.137/24   GW:Dip</span><br><span class="line">Rip2:192.168.153.138/24   GW:Dip</span><br><span class="line">Director LVS:</span><br><span class="line">[root@director ~]# systemctl stop firewalld</span><br><span class="line">[root@director ~]# echo &quot;net.ipv4.ip_forward = 1&quot; &gt;&gt; /etc/sysctl.conf</span><br><span class="line">[root@director ~]# sysctl -p</span><br><span class="line">net.ipv4.ip_forward = 1</span><br><span class="line">[root@director ~]# yum install -y ipvsadm</span><br><span class="line">[root@director ~]# ipvsadm -A -t 192.168.161.184:80 -s wrr</span><br><span class="line">[root@director ~]# ipvsadm -a -t 192.168.161.184:80 -r 192.168.153.137:80 -m -w 5</span><br><span class="line">[root@director ~]# ipvsadm -a -t 192.168.161.184:80 -r 192.168.153.138:80 -m -w 4</span><br><span class="line">[root@director ~]# ipvsadm -a -t 192.168.161.184:80 -r 192.168.153.137:800 -m -w 3</span><br><span class="line">[root@director ~]# ipvsadm -a -t 192.168.161.184:80 -r 192.168.153.138:800 -m -w 2</span><br><span class="line">[root@director ~]# ipvsadm -a -t 192.168.161.184:80 -r 192.168.153.137:8080 -m</span><br><span class="line">[root@director ~]# ipvsadm -a -t 192.168.161.184:80 -r 192.168.153.138:8080 -m</span><br></pre></td></tr></table></figure>

<p>　　　　　　<img src="../../img/1560498709039.png" alt="1560498709039"></p>
<p>三台RealServer上只需配置IP把DIP设置成RS的网关,并安装nginx软件，然后启动即可.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">firewall-cmd --add-port=80/tcp --permanent; firewall-cmd --reload</span><br><span class="line">firewall-cmd --add-port=800/tcp --permanent; firewall-cmd --reload</span><br><span class="line">firewall-cmd --add-port=8080/tcp --permanent; firewall-cmd --reload</span><br></pre></td></tr></table></figure>

<p>在任意一台上查看nginx的日志:</p>
<p>　　　　<img src="../../img/1560502049280.png" alt="1560502049280"></p>
<p>可以看到CIP是ISP上的IP,即客户端的默认网关外网接口的IP.</p>
<p>验证:</p>
<p><img src="../../img/20190614_170030.gif" alt></p>
<h5 id="2-LVS-DR模型"><a href="#2-LVS-DR模型" class="headerlink" title="2.LVS-DR模型"></a>2.LVS-DR模型</h5><p>实验拓扑说明：这个拓扑中必须有一个独立的网关，因为用户请求发来时，GW将请求发给VIP，而VIP只有调度器会响应，GW将请求发给调度器，【注意：调度器的VIP,尽量使用32位掩码，这非必须】，在DR模式下，调度器上与GW连接的接口上有两个IP，一个是VIP(Virtual IP)，一个是DIP(Director IP)； 当调度器收到来自GW的包后,发现目标是VIP,并且访问的服务与自身定义的虚拟服务一样，接着调度器将数据包中的源MAC修改为自己的MAC，而目的MAC的修改是 根据调度算法，选择一台Real Server后，将该Real Server的MAC填写在目的MAC上，接着将包发给后端服务器，如此例为Real Server 1，RIP1收到后将解包发现其IP是本地loopback的接口IP，因此RIP1继续解包，最终将包送给上层服务，如本例是Web服务；Web开始进行响应，最终封包时，将源MAC写为自己，目的MAC写为GW，源IP写VIP，目的IP写Client IP，并发给GW出去响应。</p>
<p>（1）DIP, RIP 和 VIP : 可在同一网段，也可不在同一网段 ，但他们必须在同一个交换网络。</p>
<p>（2）Director(调度器)和RealServer他们的网关都必须指向真实网关(Firewall)，并且都要配置VIP.</p>
<p>（3）Director可以响应ARP查询VIP的MAC，但RealServer一律都不回应查询VIP的ARP请求.　　　</p>
<p><img src="../../img/lvs-dr.jpg" alt></p>
<p>以上拓扑图的配置如下:　　         </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">Cip:192.168.161.12/24    GW:公网网关(这里设的内网网关)</span><br><span class="line">Vip:192.168.161.184/24    GW:公网网关(这里设的内网网关)</span><br><span class="line">Dip:10.203.0.11/24    GW:内网网关</span><br><span class="line">Rip1:10.203.0.12/24   GW:内网网关   网页内容:137:80</span><br><span class="line">Rip2:10.203.0.12/24   GW:内网网关   网页内容:138:80</span><br><span class="line">此时,内网在同一网段,不用网关即可互通</span><br><span class="line">Director LVS:</span><br><span class="line">[root@director ~]# systemctl stop firewalld</span><br><span class="line">[root@director ~]# echo &quot;net.ipv4.ip_forward = 1&quot; &gt;&gt; /etc/sysctl.conf</span><br><span class="line">[root@director ~]# sysctl -p</span><br><span class="line">net.ipv4.ip_forward = 1</span><br><span class="line">[root@director ~]# nmtui设置ens32自动获取ip ,并添加一个子接口192168.161.184</span><br><span class="line">[root@director ~]# ip a show ens32</span><br><span class="line">2: ens32: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000</span><br><span class="line">    link/ether 00:0c:29:68:ea:96 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 10.203.0.11/21 brd 10.203.7.255 scope global noprefixroute dynamic ens32</span><br><span class="line">       valid_lft 5898sec preferred_lft 5898sec</span><br><span class="line">    inet 192.168.161.184/24 brd 192.168.161.255 scope global noprefixroute ens32</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::20c:29ff:fe68:ea96/64 scope link </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">[root@director ~]# route -n</span><br><span class="line">Kernel IP routing table</span><br><span class="line">Destination     Gateway         Genmask         Flags Metric Ref    Use Iface</span><br><span class="line">0.0.0.0         10.203.7.254    0.0.0.0         UG    100    0        0 ens32</span><br><span class="line">10.203.0.0      0.0.0.0         255.255.248.0   U     100    0        0 ens32</span><br><span class="line">192.168.161.0   0.0.0.0         255.255.255.0   U     100    0        0 ens32</span><br><span class="line">[root@director ~]# yum install -y ipvsadm</span><br><span class="line">[root@director ~]# ipvsadm -A -t 192.168.161.184:80 -s wrr</span><br><span class="line">[root@director ~]# ipvsadm -a -t 192.168.161.184:80 -r 10.203.0.12:80 -g -w 3</span><br><span class="line">[root@director ~]# ipvsadm -a -t 192.168.161.184:80 -r 10.203.0.13:80 -g -w 2</span><br><span class="line">[root@director ~]# ipvsadm -ln</span><br><span class="line">IP Virtual Server version 1.2.1 (size=4096)</span><br><span class="line">Prot LocalAddress:Port Scheduler Flags</span><br><span class="line">  -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn</span><br><span class="line">TCP  192.168.161.184:80 wrr</span><br><span class="line">  -&gt; 10.203.0.12:80               Route   3      90         0         </span><br><span class="line">  -&gt; 10.203.0.13:80               Route   2      60         0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">RSs(都做这个操作):</span><br><span class="line">[root@realserver1 ~]# echo &quot;net.ipv4.conf.all.arp_ignore = 1&quot; &gt;&gt; /etc/sysctl.conf</span><br><span class="line">[root@realserver1 ~]# echo &quot;net.ipv4.conf.all.arp_announce = 2&quot; &gt;&gt; /etc/sysctl.conf</span><br><span class="line">[root@realserver1 ~]# echo &quot;net.ipv4.conf.lo.arp_ignore = 1&quot; &gt;&gt; /etc/sysctl.conf </span><br><span class="line">[root@realserver1 ~]# echo &quot;net.ipv4.conf.lo.arp_announce = 2&quot; &gt;&gt; /etc/sysctl.conf</span><br><span class="line">[root@realserver1 ~]# sysctl -p</span><br><span class="line">net.ipv4.conf.all.arp_ignore = 1</span><br><span class="line">net.ipv4.conf.all.arp_announce = 2</span><br><span class="line">net.ipv4.conf.lo.arp_ignore = 1</span><br><span class="line">net.ipv4.conf.lo.arp_announce = 2</span><br><span class="line">[root@realserver1 ~]# firewall-cmd --add-port=80/tcp --permanent; firewall-cmd --reload</span><br><span class="line">[root@realserver1 ~]# nmtui设置ens32自动获取ip ,并添加一个子接口192168.161.184</span><br><span class="line">[root@realserver1 ~]# ip a show ens32</span><br><span class="line">2: ens32: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000</span><br><span class="line">    link/ether 00:0c:29:60:75:ab brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 10.203.0.12/21 brd 10.203.7.255 scope global noprefixroute dynamic ens32</span><br><span class="line">       valid_lft 7002sec preferred_lft 7002sec</span><br><span class="line">    inet 192.168.161.184/24 brd 192.168.161.255 scope global noprefixroute ens32</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::20c:29ff:fe60:75ab/64 scope link </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">[root@realserver1 ~]# route -n</span><br><span class="line">Kernel IP routing table</span><br><span class="line">Destination     Gateway         Genmask         Flags Metric Ref    Use Iface</span><br><span class="line">0.0.0.0         10.203.7.254    0.0.0.0         UG    100    0        0 ens32</span><br><span class="line">10.203.0.0      0.0.0.0         255.255.248.0   U     100    0        0 ens32</span><br><span class="line">192.168.161.0   0.0.0.0         255.255.255.0   U     100    0        0 ens32</span><br><span class="line">然后配置nginx,测试验证</span><br></pre></td></tr></table></figure>

<p><img src="../../img/1560676691848.png" alt="1560676691848"></p>
<h5 id="3-LVS-Tunnel模式"><a href="#3-LVS-Tunnel模式" class="headerlink" title="3.LVS Tunnel模式"></a>3.LVS Tunnel模式</h5><p>拓扑：</p>
<p>　　　　　　<img src="../../img/922925-20190524172334043-1110633750.png" alt="img"></p>
<p>LVS Tunnel模式配置要点：</p>
<p>(1) LVS调度节点、RealServer节点、VIP都必须是公网IP</p>
<p>(2) LVS调度节点、RealServer节点都必须配置VIP</p>
<p>(3) 调度节点 与 RS间必须打通一条隧道</p>
<p>(4) 客户端请求发往调度节点，调度节点通过隧道将请求报文封装起来发给RS,<br>RS在隧道另一端去掉GRE封装,发现是去往VIP的,随即转给tunl0处理,最终Tunl0<br>将响应报文从RS的默认路由发出。</p>
<p>(5) 调度节点要在所有设备上启用 只接收网关发送的ICMP的重定向报文。</p>
<p>(6) 调度节点 和 RS上都必须关闭路由转发(ip_forward), RS上关闭ARP响应和返回路径过滤<br>(即:源是A口,要从B口出,B口不丢该包).</p>
<p>LVS Tunnel环境搭建</p>
<p>(1) 路由器模拟:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">echo 1 &gt; /proc/sys/net/ipv4/ip_forward</span><br><span class="line"></span><br><span class="line">ifconfig eth0 20.0.0.254/24 up</span><br><span class="line"></span><br><span class="line">ifconfig eth1 30.0.0.254/24 up</span><br><span class="line"></span><br><span class="line">ifconfig eth2 40.0.0.254/24 up</span><br><span class="line"></span><br><span class="line">ifconfig eth3 192.168.10.254/24 up</span><br><span class="line"></span><br><span class="line">iptables -t nat -A POSTROUTING -s 192.168.10.0/24 ! -d 192.168.10.0/24 -j SNAT --to 192.168.10.254</span><br></pre></td></tr></table></figure>

<p>(2) LVS调度节点</p>
<p>关闭路由转发（默认是关闭.）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo 0 &gt; /proc/sys/net/ipv4/ip_forward</span><br></pre></td></tr></table></figure>

<p>在所有接口、默认接口、eth0上都打开 仅接收来自网关的ICMP重定向.</p>
<p>注：默认应该是打开的,从抓包和分析上看,ICMP重定向是必须,因为客户端访问的调度器的子接口,</p>
<p>而调度器的主接口IP是20.0.0.1,子(次)接口IP20.0.0.2,网关通过ARP发现,客户端访问的VIP20.0.0.2</p>
<p>是在调度器接口上，因此,将去往20.0.0.2的请求重定向给调度器。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">echo 1 &gt; /proc/sys/net/ipv4/conf/all/send_redirects</span><br><span class="line"></span><br><span class="line">echo 1 &gt; /proc/sys/net/ipv4/conf/default/send_redirects</span><br><span class="line"></span><br><span class="line">echo 1 &gt; /proc/sys/net/ipv4/conf/eth0/send_redirects</span><br></pre></td></tr></table></figure>

<p>先关闭所有接口,用到那个激活那个。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">service network stop</span><br><span class="line"></span><br><span class="line">ifconfig eth0 20.0.0.1/24 up</span><br><span class="line"></span><br><span class="line">ifconfig eth0:0 20.0.0.2 broadcast 20.0.0.2 netmask 255.255.255.255 up</span><br><span class="line"></span><br><span class="line">ip tunnel add tun1 mode gre remote 30.0.0.1 local 20.0.0.1</span><br><span class="line"></span><br><span class="line">ifconfig tun1 10.0.0.1/30 up</span><br><span class="line"></span><br><span class="line">ip tunnel add tun2 mode gre remote 40.0.0.1 local 20.0.0.1</span><br><span class="line"></span><br><span class="line">ifconfig tun2 10.0.0.5/30 up</span><br></pre></td></tr></table></figure>

<p>#注：</p>
<p>GRE(通用路由封装) ： <a href="https://blog.csdn.net/taozpwater/article/details/9774123" target="_blank" rel="noopener">https://blog.csdn.net/taozpwater/article/details/9774123</a></p>
<p>简单理解: GRE就是在将原始IP包,再次封装在GRE内部, 接着在再次将GRE包封装到新IP包中,然后在加入如链路层帧头,最后发出去.其实GRE,VxLAN,NVGRE,IPSec都可认为是一种VPN.</p>
<p>MAC帧[IP头[GRE头【IP头[TCP头[应用协议数据]]】]]</p>
<p>注意：</p>
<p>GRE封装后,若后端是调度器,则该调度器将永远只能看到一个IP来访问自己,因此要注意使用调度算法.</p>
<p>添加默认路由</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">route add default gw 20.0.0.254</span><br></pre></td></tr></table></figure>

<p>添加主机路由,以便Linux收到去往20.0.0.2的报文后,知道转到那个接口上。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">route add -host 20.0.0.2 dev eth0:0</span><br><span class="line"></span><br><span class="line">yum install ipvsadm</span><br><span class="line"></span><br><span class="line">ipvsadm -A -t 20.0.0.2:80 -s rr</span><br><span class="line"></span><br><span class="line">ipvsadm -a -t 20.0.0.2:80 -r 10.0.0.2 -i</span><br></pre></td></tr></table></figure>

<p>注意:这里必须使用tunnel模式,即“-i”</p>
<p>ipvsadm -a -t 20.0.0.2:80 -r 10.0.0.6 -i</p>
<p>(2) RealServer1的配置:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ifconfig eth0 30.0.0.1/24 up</span><br><span class="line"></span><br><span class="line">ifconfig tunl0 20.0.0.2 broadcast 20.0.0.2 netmask 255.255.255.255 up</span><br></pre></td></tr></table></figure>

<p>注意：一定要添加一条主机路由,否则Linux的tun0接口收到GRE封包后,</p>
<p>解开发现是一个去往20.0.0.2的IP报文,查本机转发表若没有找到,就可能丢弃该报文.</p>
<p>那么客户端可能就打不开网页了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">route add -host 20.0.0.2 dev tunl0</span><br><span class="line"></span><br><span class="line">ip tunnel add tun0 mode gre remote 20.0.0.1 local 30.0.0.1</span><br><span class="line"></span><br><span class="line">ifconfig tun0 10.0.0.2/30 up</span><br></pre></td></tr></table></figure>

<p>关闭路由转发</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo 0 &gt; /proc/sys/net/ipv4/ip_forward</span><br></pre></td></tr></table></figure>

<p>#arp_ignore: 定义接收到ARP请求时的响应级别；</p>
<p>#　　 0：只要本地配置的有相应地址，就给予响应；</p>
<p>#　　 1：仅响应目的IP配置在此接口上的ARP广播请求</p>
<p>#arp_announce: 定义将自己的地址向外通告时的通告级别(此行为仅发生在网络设备刚接入网络时)</p>
<p>#　　 0：将本地任何接口上的任何地址向外通告；</p>
<p># 　　 1：试图仅向目标网络通告与其网络匹配的地址；</p>
<p># 　　 2：仅向与本地接口上地址匹配的网络进行通告；</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">echo 1 &gt; /proc/sys/net/ipv4/conf/tunl0/arp_ignore</span><br><span class="line"></span><br><span class="line">echo 2 &gt; /proc/sys/net/ipv4/conf/tunl0/arp_announce</span><br><span class="line"></span><br><span class="line">echo 1 &gt; /proc/sys/net/ipv4/conf/all/arp_ignore</span><br><span class="line"></span><br><span class="line">echo 2 &gt; /proc/sys/net/ipv4/conf/all/arp_announce</span><br></pre></td></tr></table></figure>

<p>关闭tunl0、eth0上返回路径过滤</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">echo 0 &gt; /proc/sys/net/ipv4/conf/tunl0/rp_filter</span><br><span class="line"></span><br><span class="line">echo 0 &gt; /proc/sys/net/ipv4/conf/eth0/rp_filter</span><br><span class="line"></span><br><span class="line">echo 0 &gt; /proc/sys/net/ipv4/conf/all/rp_filter</span><br></pre></td></tr></table></figure>

<p>(2) RealServer2的配置:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ifconfig eth0 40.0.0.1/24 up</span><br><span class="line"></span><br><span class="line">ifconfig tunl0 20.0.0.2 broadcast 20.0.0.2 netmask 255.255.255.255 up</span><br></pre></td></tr></table></figure>

<p>注意：一定要添加一条主机路由,否则Linux的tun0接口收到GRE封包后,</p>
<p>解开发现是一个去往20.0.0.2的IP报文,查本机转发表若没有找到,就可能丢弃该报文.</p>
<p>那么客户端可能就打不开网页了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">route add -host 20.0.0.2 dev tunl0</span><br><span class="line"></span><br><span class="line">ip tunnel add tun0 mode gre remote 20.0.0.1 local 40.0.0.1</span><br><span class="line"></span><br><span class="line">ifconfig tun0 10.0.0.6/30 up</span><br></pre></td></tr></table></figure>

<p>关闭路由转发</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">echo 0 &gt; /proc/sys/net/ipv4/ip_forward</span><br><span class="line"></span><br><span class="line">echo 1 &gt; /proc/sys/net/ipv4/conf/tunl0/arp_ignore</span><br><span class="line"></span><br><span class="line">echo 2 &gt; /proc/sys/net/ipv4/conf/tunl0/arp_announce</span><br><span class="line"></span><br><span class="line">echo 1 &gt; /proc/sys/net/ipv4/conf/all/arp_ignore</span><br><span class="line"></span><br><span class="line">echo 2 &gt; /proc/sys/net/ipv4/conf/all/arp_announce</span><br></pre></td></tr></table></figure>

<p>关闭tunl0、eth0上返回路径过滤</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">echo 0 &gt; /proc/sys/net/ipv4/conf/tunl0/rp_filter</span><br><span class="line"></span><br><span class="line">echo 0 &gt; /proc/sys/net/ipv4/conf/eth0/rp_filter</span><br><span class="line"></span><br><span class="line">echo 0 &gt; /proc/sys/net/ipv4/conf/all/rp_filter</span><br></pre></td></tr></table></figure>

<p>LVS调度器收到来客户端的访问报文：</p>
<p>先重定向</p>
<p>　　　　　　<img src="../../img/922925-20190524173007227-440916154.png" alt="img2"></p>
<p>调度后发送的报文，注意每个IP报文内部的内容,在该IP报文看来都仅仅是数据而已。</p>
<p>　　　　　　<img src="../../img/922925-20190524173042011-2018947801.png" alt="img3"></p>
<p>RealServer2收到GRE报文解封装后，将该报文发给tun0接口后：</p>
<p>　　　　　　<img src="../../img/922925-20190524173113024-1143857962.png" alt="img4"></p>
<p>RealServer2的tun0接口去掉IP层后，发现还是IP报文,随机转发给tunl0接口:</p>
<p>　　　　　　<img src="../../img/922925-20190524173158304-1642108484.png" alt="img5"></p>
<p>回应</p>
<p>　　　　　　<img src="../../img/922925-20190524173226213-1195581363.png" alt="img6"></p>

          
        
      
    </div>

    

    

    
    
    

    

    
      
    
    

    
	
	  <div>
        
      </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://aiwhs.github.io/2019/02/23/kvm虚拟化/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="itw">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="itw">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/02/23/kvm虚拟化/" class="post-title-link" itemprop="url">Kvm</a>
              
            
          </h1>
        

        <div class="post-meta">

          
          
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-02-23 08:15:57" itemprop="dateCreated datePublished" datetime="2019-02-23T08:15:57+08:00">2019-02-23</time>
            </span>
          

          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-07-17 20:18:21" itemprop="dateModified" datetime="2019-07-17T20:18:21+08:00">2019-07-17</time>
              </span>
            
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Linux运维/" itemprop="url" rel="index"><span itemprop="name">Linux运维</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          <br>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <a id="more"></a>



<h2 id="1-虚拟化介绍"><a href="#1-虚拟化介绍" class="headerlink" title="1. 虚拟化介绍"></a>1. 虚拟化介绍</h2><p>虚拟化是云计算的基础。简单的说，虚拟化使得在一台物理的服务器上可以跑多台虚拟机，虚拟机共享物理机的 CPU、内存、IO 硬件资源，但逻辑上虚拟机之间是相互隔离的。</p>
<p>物理机我们一般称为宿主机（Host），宿主机上面的虚拟机称为客户机（Guest）。</p>
<p>那么 Host 是如何将自己的硬件资源虚拟化，并提供给 Guest 使用的呢？<br>这个主要是通过一个叫做 Hypervisor 的程序实现的。</p>
<p>根据 Hypervisor 的实现方式和所处的位置，虚拟化又分为两种：</p>
<ul>
<li>全虚拟化</li>
<li>半虚拟化</li>
</ul>
<p><strong>全虚拟化：</strong><br>Hypervisor 直接安装在物理机上，多个虚拟机在 Hypervisor 上运行。Hypervisor 实现方式一般是一个特殊定制的 Linux 系统。Xen 和 VMWare 的 ESXi 都属于这个类型</p>
<p><img src="../../img/full_virtual.png" alt="img"></p>
<p><strong>半虚拟化：</strong><br>物理机上首先安装常规的操作系统，比如 Redhat、Ubuntu 和 Windows。Hypervisor 作为 OS 上的一个程序模块运行，并对管理虚拟机进行管理。KVM、VirtualBox 和 VMWare Workstation 都属于这个类型</p>
<p><img src="../../img/half_virtual.png" alt="img"></p>
<p><strong>理论上讲：</strong><br>全虚拟化一般对硬件虚拟化功能进行了特别优化，性能上比半虚拟化要高；<br>半虚拟化因为基于普通的操作系统，会比较灵活，比如支持虚拟机嵌套。嵌套意味着可以在KVM虚拟机中再运行KVM。</p>
<h2 id="2-kvm介绍"><a href="#2-kvm介绍" class="headerlink" title="2. kvm介绍"></a>2. kvm介绍</h2><p>kVM 全称是 Kernel-Based Virtual Machine。也就是说 KVM 是基于 Linux 内核实现的。<br>KVM有一个内核模块叫 kvm.ko，只用于管理虚拟 CPU 和内存。</p>
<p>那 IO 的虚拟化，比如存储和网络设备则是由 Linux 内核与Qemu来实现。</p>
<p>作为一个 Hypervisor，KVM 本身只关注虚拟机调度和内存管理这两个方面。IO 外设的任务交给 Linux 内核和 Qemu。</p>
<p>大家在网上看 KVM 相关文章的时候肯定经常会看到 Libvirt 这个东西。</p>
<p>Libvirt 就是 KVM 的管理工具。</p>
<p>其实，Libvirt 除了能管理 KVM 这种 Hypervisor，还能管理 Xen，VirtualBox 等。</p>
<p>Libvirt 包含 3 个东西：后台 daemon 程序 libvirtd、API 库和命令行工具 virsh</p>
<ul>
<li>libvirtd是服务程序，接收和处理 API 请求；</li>
<li>API 库使得其他人可以开发基于 Libvirt 的高级工具，比如 virt-manager，这是个图形化的 KVM 管理工具；</li>
<li>virsh 是我们经常要用的 KVM 命令行工具</li>
</ul>
<h2 id="3-kvm部署"><a href="#3-kvm部署" class="headerlink" title="3. kvm部署"></a>3. kvm部署</h2><p><strong>环境说明：</strong></p>
<table>
<thead>
<tr>
<th align="left">系统类型</th>
<th align="left">IP</th>
</tr>
</thead>
<tbody><tr>
<td align="left">centos7.6</td>
<td align="left">172.16.137.12</td>
</tr>
</tbody></table>
<h3 id="3-1-kvm安装"><a href="#3-1-kvm安装" class="headerlink" title="3.1 kvm安装"></a>3.1 kvm安装</h3><p>部署前请确保你的CPU虚拟化功能已开启。分为两种情况：</p>
<ul>
<li>虚拟机要关机设置CPU虚拟化</li>
<li>物理机要在BIOS里开启CPU虚拟化</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line">关闭防火墙与SELINUX</span><br><span class="line">[root@kvm ~]# systemctl stop firewalld</span><br><span class="line">[root@kvm ~]# systemctl disable firewalld</span><br><span class="line">Removed symlink /etc/systemd/system/multi-user.target.wants/firewalld.service.</span><br><span class="line">Removed symlink /etc/systemd/system/dbus-org.fedoraproject.FirewallD1.service.</span><br><span class="line">[root@kvm ~]# setenforce 0</span><br><span class="line">[root@kvm ~]# sed -ri &apos;s/^(SELINUX=).*/\1disabled/g&apos; /etc/selinux/config</span><br><span class="line">[root@localhost ~]# reboot</span><br><span class="line"></span><br><span class="line">配置网络源</span><br><span class="line">[root@kvm yum.repos.d]# curl -o /etc/yum.repos.d/CentOS7-Base-163.repo http://mirrors.163.com/.help/CentOS7-Base-163.repo</span><br><span class="line">[root@kvm ~]# sed -i &apos;s/\$releasever/7/g&apos; /etc/yum.repos.d/CentOS7-Base-163.repo</span><br><span class="line">[root@kvm ~]# sed -i &apos;s/^enabled=.*/enabled=1/g&apos; /etc/yum.repos.d/CentOS7-Base-163.repo</span><br><span class="line">[root@kvm ~]# yum -y install epel-release vim wget net-tools unzip zip gcc gcc-c++</span><br><span class="line">安装过程略.....</span><br><span class="line"></span><br><span class="line">验证CPU是否支持KVM；如果结果中有vmx（Intel）或svm(AMD)字样，就说明CPU的支持的</span><br><span class="line">[root@kvm ~]# egrep -o &apos;vmx|svm&apos; /proc/cpuinfo</span><br><span class="line">vmx</span><br><span class="line">vmx</span><br><span class="line">vmx</span><br><span class="line">vmx</span><br><span class="line"></span><br><span class="line">kvm安装</span><br><span class="line">[root@kvm ~]# yum -y install qemu-kvm qemu-kvm-tools qemu-img virt-manager libvirt libvirt-python libvirt-client virt-install virt-viewer bridge-utils libguestfs-tools</span><br><span class="line">安装过程略......</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">因为虚拟机中网络，我们一般都是和公司的其他服务器是同一个网段，所以我们需要把 \</span><br><span class="line">KVM服务器的网卡配置成桥接模式。这样的话KVM的虚拟机就可以通过该桥接网卡和公司内部 \</span><br><span class="line">其他服务器处于同一网段</span><br><span class="line">此处我的网卡是ens33，所以用br0来桥接ens33网卡</span><br><span class="line">[root@kvm ~]# cd /etc/sysconfig/network-scripts/</span><br><span class="line">[root@kvm network-scripts]# ls</span><br><span class="line">ifcfg-ens33  ifdown-isdn      ifup          ifup-plip      ifup-tunnel</span><br><span class="line">ifcfg-lo     ifdown-post      ifup-aliases  ifup-plusb     </span><br><span class="line">.....此处内容省略</span><br><span class="line">[root@kvm network-scripts]# cp ifcfg-ens33 ifcfg-br0</span><br><span class="line">[root@kvm network-scripts]# cat ifcfg-br0</span><br><span class="line">TYPE=Bridge</span><br><span class="line">DEVICE=br0</span><br><span class="line">NM_CONTROLLED=no</span><br><span class="line">BOOTPROTO=static</span><br><span class="line">NAME=br0</span><br><span class="line">ONBOOT=yes</span><br><span class="line">IPADDR=192.168.160.109</span><br><span class="line">NETMASK=255.255.255.0</span><br><span class="line">GATEWAY=192.168.160.1</span><br><span class="line">DNS1=114.114.114.114</span><br><span class="line">DNS2=8.8.8.8</span><br><span class="line">[root@kvm network-scripts]# cat ifcfg-ens33</span><br><span class="line">TYPE=Ethernet</span><br><span class="line">BOOTPROTO=static</span><br><span class="line">NAME=ens33</span><br><span class="line">DEVICE=ens33</span><br><span class="line">ONBOOT=yes</span><br><span class="line">BRIDGE=br0</span><br><span class="line">NM_CONTROLLED=no</span><br><span class="line"></span><br><span class="line">重启网络</span><br><span class="line">[root@kvm ~]# systemctl restart network</span><br><span class="line">[root@kvm ~]# ip a</span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN qlen 1</span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 ::1/128 scope host</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: ens33: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast master br0 state UP qlen 1000</span><br><span class="line">    link/ether 00:0c:29:4c:50:b4 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">3: virbr0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN qlen 1000</span><br><span class="line">    link/ether 52:54:00:60:a8:ea brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 192.168.122.1/24 brd 192.168.122.255 scope global virbr0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">4: virbr0-nic: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc pfifo_fast master virbr0 state DOWN qlen 1000</span><br><span class="line">    link/ether 52:54:00:60:a8:ea brd ff:ff:ff:ff:ff:ff</span><br><span class="line">5: br0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP qlen 1000</span><br><span class="line">    link/ether 72:63:57:0a:ca:76 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 192.168.160.109/24 brd 192.168.160.255 scope global br0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::7063:57ff:fe0a:ca76/64 scope link</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">       </span><br><span class="line"></span><br><span class="line">启动服务</span><br><span class="line">[root@kvm ~]# systemctl start libvirtd</span><br><span class="line">[root@kvm ~]# systemctl enable libvirtd</span><br><span class="line"></span><br><span class="line">验证安装结果</span><br><span class="line">[root@kvm ~]# lsmod|grep kvm</span><br><span class="line">kvm_intel             170086  0</span><br><span class="line">kvm                   566340  1 kvm_intel</span><br><span class="line">irqbypass              13503  1 kvm</span><br><span class="line"></span><br><span class="line">测试并验证安装结果</span><br><span class="line">[root@kvm ~]# virsh -c qemu:///system list</span><br><span class="line"> Id    Name                           State</span><br><span class="line">----------------------------------------------------</span><br><span class="line">[root@kvm ~]# virsh --version</span><br><span class="line">3.9.0</span><br><span class="line">[root@kvm ~]# virt-install --version</span><br><span class="line">1.4.3</span><br><span class="line">[root@kvm ~]# ln -s /usr/libexec/qemu-kvm /usr/bin/qemu-kvm</span><br><span class="line">[root@kvm ~]# ll /usr/bin/qemu-kvm</span><br><span class="line">lrwxrwxrwx 1 root root 21 Oct 18 10:57 /usr/bin/qemu-kvm -&gt; /usr/libexec/qemu-kvm</span><br><span class="line">[root@kvm ~]# lsmod |grep kvm</span><br><span class="line">kvm_intel             170086  0</span><br><span class="line">kvm                   566340  1 kvm_intel</span><br><span class="line">irqbypass              13503  1 kvm</span><br><span class="line"></span><br><span class="line">查看网桥信息</span><br><span class="line">[root@kvm ~]# brctl show</span><br><span class="line">bridge name     bridge id               STP enabled     interfaces</span><br><span class="line">br0             8000.000c294c50b4       no              ens33</span><br><span class="line">virbr0          8000.52540060a8ea       yes             virbr0-nic</span><br></pre></td></tr></table></figure>

<h3 id="3-2-kvm-web管理界面安装"><a href="#3-2-kvm-web管理界面安装" class="headerlink" title="3.2 kvm web管理界面安装"></a>3.2 kvm web管理界面安装</h3><p>kvm 的 web 管理界面是由 webvirtmgr 程序提供的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br></pre></td><td class="code"><pre><span class="line">安装依赖包</span><br><span class="line">[root@kvm ~]# yum -y install git python-pip libvirt-python libxml2-python python-websockify supervisor nginx python-devel</span><br><span class="line"></span><br><span class="line">升级pip</span><br><span class="line">[root@kvm ~]# pip install --upgrade pip</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">从github上下载webvirtmgr代码</span><br><span class="line">[root@kvm ~]# cd /usr/local/src/</span><br><span class="line">[root@kvm src]# git clone git://github.com/retspen/webvirtmgr.git</span><br><span class="line">Cloning into &apos;webvirtmgr&apos;...</span><br><span class="line">remote: Enumerating objects: 5730, done.</span><br><span class="line">remote: Total 5730 (delta 0), reused 0 (delta 0), pack-reused 5730</span><br><span class="line">Receiving objects: 100% (5730/5730), 3.01 MiB | 39.00 KiB/s, done.</span><br><span class="line">Resolving deltas: 100% (3688/3688), done.</span><br><span class="line"></span><br><span class="line">安装webvirtmgr</span><br><span class="line">[root@kvm src]# cd webvirtmgr/</span><br><span class="line">[root@kvm webvirtmgr]# pip install -r requirements.txt</span><br><span class="line">Collecting django==1.5.5 (from -r requirements.txt (line 1))</span><br><span class="line">  Downloading https://files.pythonhosted.org/packages/38/49/93511c5d3367b6b21fc2995a0e53399721afc15e4cd6eb57be879ae13ad4/Django-1.5.5.tar.gz (8.1MB)</span><br><span class="line">    57% |██████████████████▌             | 4.7MB 38kB/s eta 0:01:28 </span><br><span class="line">.....此处省略安装步骤</span><br><span class="line"></span><br><span class="line">检查sqlite3是否安装</span><br><span class="line">[root@kvm webvirtmgr]# python</span><br><span class="line">Python 2.7.5 (default, May  3 2017, 07:55:04)</span><br><span class="line">[GCC 4.8.5 20150623 (Red Hat 4.8.5-14)] on linux2</span><br><span class="line">Type &quot;help&quot;, &quot;copyright&quot;, &quot;credits&quot; or &quot;license&quot; for more information.</span><br><span class="line">&gt;&gt;&gt; import sqlite3</span><br><span class="line">&gt;&gt;&gt; exit()</span><br><span class="line"></span><br><span class="line">初始化帐号信息</span><br><span class="line">[root@kvm webvirtmgr]# python manage.py syncdb</span><br><span class="line">WARNING:root:No local_settings file found.</span><br><span class="line">Creating tables ...</span><br><span class="line">Creating table auth_permission</span><br><span class="line">Creating table auth_group_permissions</span><br><span class="line">Creating table auth_group</span><br><span class="line">Creating table auth_user_groups</span><br><span class="line">Creating table auth_user_user_permissions</span><br><span class="line">Creating table auth_user</span><br><span class="line">Creating table django_content_type</span><br><span class="line">Creating table django_session</span><br><span class="line">Creating table django_site</span><br><span class="line">Creating table servers_compute</span><br><span class="line">Creating table instance_instance</span><br><span class="line">Creating table create_flavor</span><br><span class="line"></span><br><span class="line">You just installed Django&apos;s auth system, which means you don&apos;t have any superusers defined.</span><br><span class="line">Would you like to create one now? (yes/no): yes     //问你是否创建超级管理员帐号</span><br><span class="line">Username (leave blank to use &apos;root&apos;):   //指定超级管理员帐号用户名，默认留空为root</span><br><span class="line">Email address: sean1002@126.com     //设置超级管理员邮箱</span><br><span class="line">Password:       //设置超级管理员密码</span><br><span class="line">Password (again):       //再次输入超级管理员密码</span><br><span class="line">Superuser created successfully.</span><br><span class="line">Installing custom SQL ...</span><br><span class="line">Installing indexes ...</span><br><span class="line">Installed 6 object(s) from 1 fixture(s)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">拷贝web网页至指定目录</span><br><span class="line">[root@kvm webvirtmgr]# mkdir /var/www</span><br><span class="line">[root@kvm webvirtmgr]# cp -r /usr/local/src/webvirtmgr /var/www/</span><br><span class="line">[root@kvm webvirtmgr]# chown -R nginx.nginx /var/www/webvirtmgr/</span><br><span class="line"></span><br><span class="line">生成密钥</span><br><span class="line">[root@kvm ~]# ssh-keygen -t rsa</span><br><span class="line">Generating public/private rsa key pair.</span><br><span class="line">Enter file in which to save the key (/root/.ssh/id_rsa):</span><br><span class="line">Created directory &apos;/root/.ssh&apos;.</span><br><span class="line">Enter passphrase (empty for no passphrase):</span><br><span class="line">Enter same passphrase again:</span><br><span class="line">Your identification has been saved in /root/.ssh/id_rsa.</span><br><span class="line">Your public key has been saved in /root/.ssh/id_rsa.pub.</span><br><span class="line">The key fingerprint is:</span><br><span class="line">SHA256:CQoZtso2M5Uo39lKvjZboncqakQ69iJt5wnjiJKZNhw root@kvm</span><br><span class="line">The key&apos;s randomart image is:</span><br><span class="line">+---[RSA 2048]----+</span><br><span class="line">|  o              |</span><br><span class="line">| ..+.            |</span><br><span class="line">|..+o  .          |</span><br><span class="line">|o+.o + . .       |</span><br><span class="line">|+*. = . S        |</span><br><span class="line">|+E+o .           |</span><br><span class="line">|+*= + .          |</span><br><span class="line">|BO+===.          |</span><br><span class="line">|Oo=**=           |</span><br><span class="line">+----[SHA256]-----+</span><br><span class="line">由于这里webvirtmgr和kvm服务部署在同一台机器，所以这里本地信任。如果kvm部署在其他机器，那么这个是它的ip</span><br><span class="line">[root@kvm ~]# ssh-copy-id 192.168.160.109</span><br><span class="line">/usr/bin/ssh-copy-id: INFO: Source of key(s) to be installed: &quot;/root/.ssh/id_rsa.pub&quot;</span><br><span class="line">The authenticity of host &apos;192.168.160.109 (192.168.160.109)&apos; can&apos;t be established.</span><br><span class="line">ECDSA key fingerprint is SHA256:UszC1ZeHM7xw/uefVkJoXW6XgRw+Jl51tAXLjFERclE.</span><br><span class="line">ECDSA key fingerprint is MD5:b3:f1:02:b8:01:8e:53:a7:87:09:c0:75:24:4c:ad:88.</span><br><span class="line">Are you sure you want to continue connecting (yes/no)? yes</span><br><span class="line">/usr/bin/ssh-copy-id: INFO: attempting to log in with the new key(s), to filter out any that are already installed</span><br><span class="line">/usr/bin/ssh-copy-id: INFO: 1 key(s) remain to be installed -- if you are prompted now it is to install the new keys</span><br><span class="line">root@192.168.160.109&apos;s password:</span><br><span class="line"></span><br><span class="line">Number of key(s) added: 1</span><br><span class="line"></span><br><span class="line">Now try logging into the machine, with:   &quot;ssh &apos;192.168.160.109&apos;&quot;</span><br><span class="line">and check to make sure that only the key(s) you wanted were added.</span><br><span class="line">配置端口转发</span><br><span class="line">[root@kvm ~]# ssh 192.168.160.109 -L localhost:8000:localhost:8000 -L localhost:6080:localhost:60</span><br><span class="line">Last login: Thu Oct 18 08:26:40 2018 from 192.168.160.36</span><br><span class="line">[root@kvm ~]# ss -antl</span><br><span class="line">State       Recv-Q Send-Q Local Address:Port               Peer Address:Port</span><br><span class="line">LISTEN      0      128              *:111                          *:*</span><br><span class="line">LISTEN      0      5      192.168.122.1:53                           *:*</span><br><span class="line">LISTEN      0      128              *:22                           *:*</span><br><span class="line">LISTEN      0      100      127.0.0.1:25                           *:*</span><br><span class="line">LISTEN      0      128      127.0.0.1:6080                         *:*</span><br><span class="line">LISTEN      0      128      127.0.0.1:8000                         *:*</span><br><span class="line">LISTEN      0      128             :::111                         :::*</span><br><span class="line">LISTEN      0      128             :::22                          :::*</span><br><span class="line">LISTEN      0      100            ::1:25                          :::*</span><br><span class="line">LISTEN      0      128            ::1:6080                        :::*</span><br><span class="line">LISTEN      0      128            ::1:8000                        :::* </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">配置nginx</span><br><span class="line">[root@kvm ~]# vim /etc/nginx/nginx.conf</span><br><span class="line">user nginx;</span><br><span class="line">worker_processes auto;</span><br><span class="line">error_log /var/log/nginx/error.log;</span><br><span class="line">pid /run/nginx.pid;</span><br><span class="line"></span><br><span class="line">include /usr/share/nginx/modules/*.conf;</span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections 1024;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    log_format  main  &apos;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &apos;</span><br><span class="line">                      &apos;$status $body_bytes_sent &quot;$http_referer&quot; &apos;</span><br><span class="line">                      &apos;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&apos;;</span><br><span class="line"></span><br><span class="line">    access_log  /var/log/nginx/access.log  main;</span><br><span class="line"></span><br><span class="line">    sendfile            on;</span><br><span class="line">    tcp_nopush          on;</span><br><span class="line">    tcp_nodelay         on;</span><br><span class="line">    keepalive_timeout   65;</span><br><span class="line">    types_hash_max_size 2048;</span><br><span class="line"></span><br><span class="line">    include             /etc/nginx/mime.types;</span><br><span class="line">    default_type        application/octet-stream;</span><br><span class="line"></span><br><span class="line">    include /etc/nginx/conf.d/*.conf;</span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line">        listen       80;</span><br><span class="line">        server_name  localhost;</span><br><span class="line"></span><br><span class="line">        include /etc/nginx/default.d/*.conf;</span><br><span class="line"></span><br><span class="line">        location / &#123;</span><br><span class="line">            root html;</span><br><span class="line">            index index.html index.htm;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        error_page 404 /404.html;</span><br><span class="line">            location = /40x.html &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        error_page 500 502 503 504 /50x.html;</span><br><span class="line">            location = /50x.html &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@kvm ~]# vim /etc/nginx/conf.d/webvirtmgr.conf</span><br><span class="line">server &#123;</span><br><span class="line">    listen 80 default_server;</span><br><span class="line"></span><br><span class="line">    server_name $hostname;</span><br><span class="line">    #access_log /var/log/nginx/webvirtmgr_access_log;</span><br><span class="line"></span><br><span class="line">    location /static/ &#123;</span><br><span class="line">        root /var/www/webvirtmgr/webvirtmgr;</span><br><span class="line">        expires max;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        proxy_pass http://127.0.0.1:8000;</span><br><span class="line">        proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">        proxy_set_header X-Forwarded-for $proxy_add_x_forwarded_for;</span><br><span class="line">        proxy_set_header Host $host:$server_port;</span><br><span class="line">        proxy_set_header X-Forwarded-Proto $remote_addr;</span><br><span class="line">        proxy_connect_timeout 600;</span><br><span class="line">        proxy_read_timeout 600;</span><br><span class="line">        proxy_send_timeout 600;</span><br><span class="line">        client_max_body_size 1024M;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">确保bind绑定的是本机的8000端口</span><br><span class="line">[root@kvm ~]# vim /var/www/webvirtmgr/conf/gunicorn.conf.py</span><br><span class="line">.....此处省略N行</span><br><span class="line">bind = &apos;0.0.0.0:8000&apos;     //确保此处绑定的是本机的8000端口，这个在nginx配置中定义了，被代理的端口</span><br><span class="line">backlog = 2048</span><br><span class="line">.....此处省略N行</span><br><span class="line"></span><br><span class="line">重启nginx</span><br><span class="line">[root@kvm ~]# systemctl restart nginx</span><br><span class="line">[root@kvm ~]# ss -antl</span><br><span class="line">State       Recv-Q Send-Q Local Address:Port               Peer Address:Port</span><br><span class="line">LISTEN      0      128              *:111                          *:*</span><br><span class="line">LISTEN      0      128              *:80                           *:*</span><br><span class="line">LISTEN      0      5      192.168.122.1:53                           *:*</span><br><span class="line">LISTEN      0      128              *:22                           *:*</span><br><span class="line">LISTEN      0      100      127.0.0.1:25                           *:*</span><br><span class="line">LISTEN      0      128      127.0.0.1:6080                         *:*</span><br><span class="line">LISTEN      0      128      127.0.0.1:8000                         *:*</span><br><span class="line">LISTEN      0      128             :::111                         :::*</span><br><span class="line">LISTEN      0      128             :::22                          :::*</span><br><span class="line">LISTEN      0      100            ::1:25                          :::*</span><br><span class="line">LISTEN      0      128            ::1:6080                        :::*</span><br><span class="line">LISTEN      0      128            ::1:8000                        :::*</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">设置supervisor</span><br><span class="line">[root@kvm ~]# vim /etc/supervisord.conf</span><br><span class="line">.....此处省略上面的内容，在文件最后加上以下内容</span><br><span class="line">[program:webvirtmgr]</span><br><span class="line">command=/usr/bin/python2 /var/www/webvirtmgr/manage.py run_gunicorn -c /var/www/webvirtmgr/conf/gunicorn.conf.py</span><br><span class="line">directory=/var/www/webvirtmgr</span><br><span class="line">autostart=true</span><br><span class="line">autorestart=true</span><br><span class="line">logfile=/var/log/supervisor/webvirtmgr.log</span><br><span class="line">log_stderr=true</span><br><span class="line">user=nginx</span><br><span class="line"></span><br><span class="line">[program:webvirtmgr-console]</span><br><span class="line">command=/usr/bin/python2 /var/www/webvirtmgr/console/webvirtmgr-console</span><br><span class="line">directory=/var/www/webvirtmgr</span><br><span class="line">autostart=true</span><br><span class="line">autorestart=true</span><br><span class="line">stdout_logfile=/var/log/supervisor/webvirtmgr-console.log</span><br><span class="line">redirect_stderr=true</span><br><span class="line">user=nginx</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">启动supervisor并设置开机自启</span><br><span class="line">[root@kvm ~]# systemctl start supervisord</span><br><span class="line">[root@kvm ~]# systemctl enable supervisord</span><br><span class="line">Created symlink from /etc/systemd/system/multi-user.target.wants/supervisord.service to /usr/lib/systemd/system/supervisord.service.</span><br><span class="line">[root@kvm ~]# systemctl status supervisord</span><br><span class="line">● supervisord.service - Process Monitoring and Control Daemon</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/supervisord.service; enabled; vendor preset: disabled)</span><br><span class="line">   Active: active (running) since Thu 2018-10-18 11:59:33 CST; 25s ago</span><br><span class="line"> Main PID: 17918 (supervisord)</span><br><span class="line">   CGroup: /system.slice/supervisord.service</span><br><span class="line">           └─17918 /usr/bin/python /usr/bin/supervisord -c /etc/supervisord.conf</span><br><span class="line"></span><br><span class="line">Oct 18 11:59:33 kvm systemd[1]: Starting Process Monitoring and Control Daemon...</span><br><span class="line">Oct 18 11:59:33 kvm systemd[1]: Started Process Monitoring and Control Daemon.</span><br><span class="line"></span><br><span class="line">[root@kvm webvirtmgr]# ss -antl</span><br><span class="line">State       Recv-Q Send-Q Local Address:Port               Peer Address:Port</span><br><span class="line">LISTEN      0      128              *:111                          *:*</span><br><span class="line">LISTEN      0      128              *:80                           *:*</span><br><span class="line">LISTEN      0      5      192.168.122.1:53                           *:*</span><br><span class="line">LISTEN      0      128              *:22                           *:*</span><br><span class="line">LISTEN      0      100      127.0.0.1:25                           *:*</span><br><span class="line">LISTEN      0      128              *:8000                         *:*</span><br><span class="line">LISTEN      0      100              *:6080                         *:*</span><br><span class="line">LISTEN      0      128             :::111                         :::*</span><br><span class="line">LISTEN      0      128             :::22                          :::*</span><br><span class="line">LISTEN      0      100            ::1:25                          :::*</span><br><span class="line"></span><br><span class="line">配置nginx用户</span><br><span class="line">[root@kvm home]# su - nginx -s /bin/bash</span><br><span class="line">-bash-4.2$ ssh-keygen -t rsa</span><br><span class="line">Generating public/private rsa key pair.</span><br><span class="line">Enter file in which to save the key (/var/lib/nginx/.ssh/id_rsa):</span><br><span class="line">Created directory &apos;/var/lib/nginx/.ssh&apos;.</span><br><span class="line">Enter passphrase (empty for no passphrase):</span><br><span class="line">Enter same passphrase again:</span><br><span class="line">Your identification has been saved in /var/lib/nginx/.ssh/id_rsa.</span><br><span class="line">Your public key has been saved in /var/lib/nginx/.ssh/id_rsa.pub.</span><br><span class="line">The key fingerprint is:</span><br><span class="line">SHA256:rdbmW/YIXxAJBzPsd9q9eKHPjWtSZ5EQC5li3tkczYI nginx@localhost.localdomain</span><br><span class="line">The key&apos;s randomart image is:</span><br><span class="line">+---[RSA 2048]----+</span><br><span class="line">|         .=o=.+  |</span><br><span class="line">|         o.E.=.o |</span><br><span class="line">|        o.o *.+ .|</span><br><span class="line">|         o.o.+.o |</span><br><span class="line">|        S ...+ ..|</span><br><span class="line">|         o  ..o.+|</span><br><span class="line">|        o + o.+oo|</span><br><span class="line">|       . o =.*o+.|</span><br><span class="line">|          o.oo*+.|</span><br><span class="line">+----[SHA256]-----+</span><br><span class="line"></span><br><span class="line">-bash-4.2$ touch ~/.ssh/config &amp;&amp; echo -e &quot;StrictHostKeyChecking=no\nUserKnownHostsFile=/dev/null&quot; &gt;&gt; ~/.ssh/config</span><br><span class="line">-bash-4.2$ chmod 0600 ~/.ssh/config</span><br><span class="line"></span><br><span class="line">-bash-4.2$ ssh-copy-id root@192.168.160.109</span><br><span class="line">/bin/ssh-copy-id: INFO: Source of key(s) to be installed: &quot;/var/lib/nginx/.ssh/id_rsa.pub&quot;</span><br><span class="line">/bin/ssh-copy-id: INFO: attempting to log in with the new key(s), to filter out any that are already installed</span><br><span class="line">/bin/ssh-copy-id: INFO: 1 key(s) remain to be installed -- if you are prompted now it is to install the new keys</span><br><span class="line">Warning: Permanently added &apos;192.168.160.109&apos; (ECDSA) to the list of known hosts.</span><br><span class="line">root@192.168.160.109&apos;s password:</span><br><span class="line"></span><br><span class="line">Number of key(s) added: 1</span><br><span class="line"></span><br><span class="line">Now try logging into the machine, with:   &quot;ssh &apos;root@192.168.160.109&apos;&quot;</span><br><span class="line">and check to make sure that only the key(s) you wanted were added.</span><br><span class="line"></span><br><span class="line">-bash-4.2$ exit</span><br><span class="line">logout</span><br><span class="line"></span><br><span class="line">[root@kvm ~]# vim /etc/polkit-1/localauthority/50-local.d/50-libvirt-remote-access.pkla</span><br><span class="line">[Remote libvirt SSH access]</span><br><span class="line">Identity=unix-user:root</span><br><span class="line">Action=org.libvirt.unix.manage</span><br><span class="line">ResultAny=yes</span><br><span class="line">ResultInactive=yes</span><br><span class="line">ResultActive=yes</span><br><span class="line"></span><br><span class="line">[root@kvm ~]# chown -R root.root /etc/polkit-1/localauthority/50-local.d/50-libvirt-remote-access.pkla</span><br><span class="line">[root@kvm ~]# systemctl restart nginx</span><br><span class="line">[root@kvm ~]# systemctl restart libvirtd</span><br></pre></td></tr></table></figure>

<h3 id="3-3-kvm-web界面管理"><a href="#3-3-kvm-web界面管理" class="headerlink" title="3.3 kvm web界面管理"></a>3.3 kvm web界面管理</h3><p>通过ip地址在浏览器上访问kvm，例如我这里就是：<code>http://192.168.160.109/login</code></p>
<p><img src="../../img/kvm_index1.png" alt="img"></p>
<h4 id="3-3-1-kvm连接管理"><a href="#3-3-1-kvm连接管理" class="headerlink" title="3.3.1 kvm连接管理"></a>3.3.1 kvm连接管理</h4><p><strong>创建SSH连接：</strong></p>
<p><img src="../../img/kvm_connection.png" alt="img"></p>
<p><img src="../../img/kvm_ssh_connect.png" alt="img"></p>
<p><img src="../../img/kvm_ip.png" alt="img"></p>
<h4 id="3-3-2-kvm存储管理"><a href="#3-3-2-kvm存储管理" class="headerlink" title="3.3.2 kvm存储管理"></a>3.3.2 kvm存储管理</h4><p><strong>创建存储：</strong></p>
<p><img src="../../img/kvm_storage.png" alt="img"></p>
<p><img src="../../img/kvm_storage_create.png" alt="img"></p>
<p><strong>进入存储：</strong></p>
<p><img src="../../img/kvm_into_storage.png" alt="img"></p>
<p><img src="../../img/kvm_storage_detail.png" alt="img"></p>
<p><strong>通过远程连接软件上传ISO镜像文件至存储目录/var/lib/libvirt/images/</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@kvm ~]# cd /var/lib/libvirt/images/</span><br><span class="line">[root@kvm images]# ls</span><br><span class="line">[root@kvm images]#</span><br><span class="line"></span><br><span class="line">Upload SCP</span><br><span class="line">CentOS-7-x86_64-DVD-1804.iso          (4263.00 MB, 8:45 min = 8.12 MB/sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@kvm images]# ls</span><br><span class="line">CentOS-7-x86_64-DVD-1804.iso</span><br></pre></td></tr></table></figure>

<p><strong>在 web 界面查看ISO镜像是否存在</strong></p>
<p><img src="../../img/kvm_show_storage.png" alt="img"></p>
<p><strong>创建系统安装镜像</strong></p>
<p><img src="../../img/kvm_img_add.png" alt="img"></p>
<p><img src="../../img/kvm_img_add1.png" alt="img"></p>
<p><strong>添加成功如下图所示</strong></p>
<p><img src="../../img/kvm_img_add2.png" alt="img"></p>
<h4 id="3-3-3-kvm网络管理"><a href="#3-3-3-kvm网络管理" class="headerlink" title="3.3.3 kvm网络管理"></a>3.3.3 kvm网络管理</h4><p><strong>添加桥接网络</strong></p>
<p><img src="../../img/kvm_network_add.png" alt="img"></p>
<p><img src="../../img/kvm_network_create_bridge1.png" alt="img"></p>
<p><img src="../../img/kvm_network_show.png" alt="img"></p>
<h4 id="3-3-4-实例管理"><a href="#3-3-4-实例管理" class="headerlink" title="3.3.4 实例管理"></a>3.3.4 实例管理</h4><p><strong>实例(虚拟机)创建</strong></p>
<p><img src="../../img/kvm_instance_add.png" alt="img"></p>
<p><img src="../../img/kvm_instance_custom.png" alt="img"></p>
<p><img src="../../img/kvm_instance_config.png" alt="img"></p>
<p><strong>虚拟机插入光盘</strong></p>
<p><img src="../../img/kvm_instance_cdrom.png" alt="img"></p>
<p><strong>设置在 web 上访问虚拟机的密码</strong></p>
<p><img src="../../img/kvm_console_setpasswd.png" alt="img"></p>
<p><strong>启动虚拟机</strong></p>
<p><img src="../../img/kvm_instance_start.png" alt="img"></p>
<p><img src="../../img/kvm_virtualhost_start.png" alt="img"></p>
<p><strong>虚拟机安装</strong></p>
<p><img src="../../img/kvm_virtualhost_install.png" alt="img"></p>
<p>虚拟机安装步骤就是安装系统的步骤，此处就不再赘述</p>
<h2 id="4-故障案例"><a href="#4-故障案例" class="headerlink" title="4.故障案例"></a>4.故障案例</h2><h3 id="4-1-案例1"><a href="#4-1-案例1" class="headerlink" title="4.1 案例1"></a>4.1 案例1</h3><p>web界面配置完成后可能会出现以下错误界面</p>
<p><img src="../../img/15523585024461.jpg" alt="img"><br>解决方法是安装novnc并通过novnc_server启动一个vnc</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# ll /etc/rc.local</span><br><span class="line">lrwxrwxrwx. 1 root root 13 Aug  6  2018 /etc/rc.local -&gt; rc.d/rc.local</span><br><span class="line">[root@localhost ~]# ll /etc/rc.d/rc.local</span><br><span class="line">-rw-r--r-- 1 root root 513 Mar 11 22:35 /etc/rc.d/rc.local</span><br><span class="line">[root@localhost ~]# chmod +x /etc/rc.d/rc.local</span><br><span class="line">[root@localhost ~]# ll /etc/rc.d/rc.local</span><br><span class="line">-rwxr-xr-x 1 root root 513 Mar 11 22:35 /etc/rc.d/rc.local</span><br><span class="line"></span><br><span class="line">[root@localhost ~]# vim /etc/rc.d/rc.local</span><br><span class="line">......此处省略N行</span><br><span class="line"># that this script will be executed during boot.</span><br><span class="line"></span><br><span class="line">touch /var/lock/subsys/local</span><br><span class="line">nohup novnc_server 172.16.12.128:5920 &amp;</span><br><span class="line"></span><br><span class="line">[root@localhost ~]# . /etc/rc.d/rc.local</span><br></pre></td></tr></table></figure>

<p>做完以上操作后再次访问即可正常访问</p>
<p><img src="../../img/15523588093971.jpg" alt="img"></p>
<h3 id="4-2-案例2"><a href="#4-2-案例2" class="headerlink" title="4.2 案例2"></a>4.2 案例2</h3><p>第一次通过web访问kvm时可能会一直访问不了，一直转圈，而命令行界面一直报错(too many open files)</p>
<p>此时需要对nginx进行配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# vim /etc/nginx/nginx.conf</span><br><span class="line">....此处省略N行</span><br><span class="line">user nginx;</span><br><span class="line">worker_processes auto;</span><br><span class="line">error_log /var/log/nginx/error.log;</span><br><span class="line">pid /run/nginx.pid;</span><br><span class="line">worker_rlimit_nofile 655350;    //添加此行配置</span><br><span class="line"></span><br><span class="line"># Load dynamic modules. See /usr/share/nginx/README.dynamic.</span><br><span class="line">....此处省略N行</span><br><span class="line"></span><br><span class="line">[root@localhost ~]# systemctl restart nginx</span><br></pre></td></tr></table></figure>

<p>然后对系统参数进行设置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# vim /etc/security/limits.conf</span><br><span class="line">....此处省略N行</span><br><span class="line"># End of file</span><br><span class="line">* soft nofile 655350</span><br><span class="line">* hard nofile 655350</span><br></pre></td></tr></table></figure>

<p>到此问题即可解决</p>

          
        
      
    </div>

    

    

    
    
    

    

    
      
    
    

    
	
	  <div>
        
      </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://aiwhs.github.io/2019/01/13/Zabbix监控MySQL主从/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="itw">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="itw">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/01/13/Zabbix监控MySQL主从/" class="post-title-link" itemprop="url">zabbix监控MySQL</a>
              
            
          </h1>
        

        <div class="post-meta">

          
          
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-01-13 08:15:57" itemprop="dateCreated datePublished" datetime="2019-01-13T08:15:57+08:00">2019-01-13</time>
            </span>
          

          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-07-17 20:10:45" itemprop="dateModified" datetime="2019-07-17T20:10:45+08:00">2019-07-17</time>
              </span>
            
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Linux运维/" itemprop="url" rel="index"><span itemprop="name">Linux运维</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          <br>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <a id="more"></a>



<h2 id="实验环境"><a href="#实验环境" class="headerlink" title="实验环境:"></a>实验环境:</h2><p>mysql主从配置参考 <a href="https://blog.csdn.net/wenhs5479/article/details/90240226" target="_blank" rel="noopener">mysql主从</a></p>
<p>关闭防火墙和selinux<br>安装zabbix，zabbix是基于lamp环境下的，先搭建lamp架构</p>
<p><a href="https://blog.csdn.net/wenhs5479/article/details/90267202" target="_blank" rel="noopener">安装zabbix</a>监控mysql主从</p>
<table>
<thead>
<tr>
<th align="center">主机系统</th>
<th align="center">IP</th>
<th align="center">角色</th>
</tr>
</thead>
<tbody><tr>
<td align="center">centos7.6最小化</td>
<td align="center">192.168.2.158</td>
<td align="center">zabbix-server<br>lamp</td>
</tr>
<tr>
<td align="center">centos7.6最小化</td>
<td align="center">192.168.2.229</td>
<td align="center">zabbix-agentd<br>MySQL-slave</td>
</tr>
<tr>
<td align="center">centos7.6最小化</td>
<td align="center">192.168.2.157</td>
<td align="center">zabbix-agentd<br>MySQL-server</td>
</tr>
</tbody></table>
<p><a href="https://blog.csdn.net/wenhs5479/article/details/90514799" target="_blank" rel="noopener">ZABBIX的自定义监控</a>续章扩展,</p>
<h3 id="实验一-监控MySQL主从同步状态"><a href="#实验一-监控MySQL主从同步状态" class="headerlink" title="实验一:监控MySQL主从同步状态"></a>实验一:监控MySQL主从同步状态</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[root@itwhs ~]# egrep -v &quot;#|^$&quot; /usr/local/etc/zabbix_agentd.conf</span><br><span class="line">LogFile=/tmp/zabbix_agentd.log</span><br><span class="line">Server=192.168.2.158</span><br><span class="line">ServerActive=192.168.2.158</span><br><span class="line">Hostname=itwhs</span><br><span class="line">UnsafeUserParameters=1    //设1为开启</span><br><span class="line">UserParameter=ckproc[*],/usr/bin/bash /scripts/proc.sh $1</span><br><span class="line">UserParameter=cklog[*],/usr/bin/python /scripts/log.py $1 $2 $3</span><br><span class="line"></span><br><span class="line">配置免密登录</span><br><span class="line">[root@itwhs ~]# head -4 /etc/my.cnf</span><br><span class="line">[client]</span><br><span class="line">host=localhost</span><br><span class="line">user=root</span><br><span class="line">password=itwhsgithubio</span><br><span class="line"></span><br><span class="line">添加一个key</span><br><span class="line">[root@itwhs ~]# vim /usr/local/etc/zabbix_agentd.conf</span><br><span class="line">UserParameter=ckmysqlms,mysql -e &quot;show slave status\G&quot; | grep &quot;Running&quot; |awk &apos;&#123;print $NF&#125;&apos; | grep -c &quot;Yes&quot;</span><br><span class="line"></span><br><span class="line">重启服务</span><br><span class="line">[root@itwhs ~]# pkill zabbix</span><br><span class="line">[root@itwhs ~]# zabbix_agentd</span><br></pre></td></tr></table></figure>

<p>服务端验证:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@zabbix ~]# zabbix_get -s 192.168.2.229 -k ckmysqlms</span><br><span class="line">2</span><br><span class="line">#抓取mysql-slave端的键值，如果返回数值2.则表明IO和SQL线程状态都为yes状态，则表明主从正常</span><br></pre></td></tr></table></figure>

<p><strong>【Zabbix-server-web端配置】</strong></p>
<p><strong>创建一个监控项作为mysql主从</strong></p>
<p><img src="../../img/2019-05-25_154837.png" alt></p>
<p>【创建触发器，实现主从异常报警】</p>
<p><img src="../../img/2019-05-25_155244.png" alt></p>
<p>手动触发测试:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@itwhs ~]# mysql -e &quot;stop slave;&quot;</span><br><span class="line">[root@itwhs ~]# mysql -e &quot;start slave;&quot;</span><br></pre></td></tr></table></figure>

<p><img src="../../img/2019-05-25_163141.png" alt></p>
<p><img src="../../img/Screenshot_20190525-163620.jpg" alt></p>
<h3 id="实验二-监控MySQL主从延迟"><a href="#实验二-监控MySQL主从延迟" class="headerlink" title="实验二:监控MySQL主从延迟"></a>实验二:监控MySQL主从延迟</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">添加key</span><br><span class="line">[root@itwhs ~]# vim /usr/local/etc/zabbix_agentd.conf</span><br><span class="line">UserParameter=mysql.delay,mysql -e &quot;show slave status\G&quot; 2&gt;/dev/null|egrep &apos;Seconds_Behind_Master&apos;|awk &apos;&#123;print $2&#125;&apos;</span><br><span class="line"></span><br><span class="line">重启服务</span><br><span class="line">[root@itwhs ~]# pkill zabbix</span><br><span class="line">[root@itwhs ~]# zabbix_agentd</span><br></pre></td></tr></table></figure>

<p>服务端验证:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@zabbix ~]# zabbix_get -s 192.168.2.229 -k mysql.delay</span><br><span class="line">0</span><br><span class="line">说明没有延迟</span><br></pre></td></tr></table></figure>

<p><strong>【Zabbix-server-web端配置】</strong></p>
<p><strong>创建一个监控项作为mysql延迟</strong></p>
<p><img src="../../img/2019-05-25_165508.png" alt></p>
<p>【创建触发器，实现主从异常报警】</p>
<p><img src="../../img/2019-05-25_170010.png" alt></p>
<p>手动测试</p>
<p>插入几百到几千万条数据,才能看出延迟,方法在<a href="https://blog.csdn.net/wenhs5479/article/details/90320220" target="_blank" rel="noopener">gtid主从</a>那一章</p>
<p>结果:</p>
<p><img src="../../img/2019-05-25_171201.png" alt></p>
<p><img src="../../img/Screenshot_20190525-171536.jpg" alt></p>

          
        
      
    </div>

    

    

    
    
    

    

    
      
    
    

    
	
	  <div>
        
      </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://aiwhs.github.io/2019/01/12/zabbix告警之微信和钉钉/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="itw">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="itw">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/01/12/zabbix告警之微信和钉钉/" class="post-title-link" itemprop="url">zabbix之微信钉钉告警</a>
              
            
          </h1>
        

        <div class="post-meta">

          
          
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-01-12 08:15:57" itemprop="dateCreated datePublished" datetime="2019-01-12T08:15:57+08:00">2019-01-12</time>
            </span>
          

          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-07-17 20:07:49" itemprop="dateModified" datetime="2019-07-17T20:07:49+08:00">2019-07-17</time>
              </span>
            
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Linux运维/" itemprop="url" rel="index"><span itemprop="name">Linux运维</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          <br>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <a id="more"></a>



<h2 id="一-zabbix配置WeChat报警"><a href="#一-zabbix配置WeChat报警" class="headerlink" title="一,zabbix配置WeChat报警"></a>一,zabbix配置WeChat报警</h2><p>写先声明:本人完全python小白,脚本内容有许多看不懂,这都不影响接下来的操作,写这个就是为了复习记忆,也多谢<a href="https://www.zabbix.com/cn/integrations/wechat" target="_blank" rel="noopener">官网</a>推荐的,用于WeChat报警的python脚本,主要是图文教程,配合作者<a href="https://github.com/X-Mars/Zabbix-Alert-WeChat" target="_blank" rel="noopener">火星小刘</a>的README和脚本,更容易学习.</p>
<p>注意事项等,作者<a href="https://github.com/X-Mars/Zabbix-Alert-WeChat" target="_blank" rel="noopener">火星小刘</a>的README中有,下面开始教程正文</p>
<h3 id="需要具备一下条件"><a href="#需要具备一下条件" class="headerlink" title="需要具备一下条件"></a>需要具备一下条件</h3><ul>
<li>注册微信企业号 <a href="https://qy.weixin.qq.com/" target="_blank" rel="noopener">点击注册</a>   或    注册企业号微信  [点击注册](<a href="https://work.weixin.qq.com/）" target="_blank" rel="noopener">https://work.weixin.qq.com/）</a></li>
</ul>
<p><img src="../../img/1558582852920.png" alt="1558582852920"></p>
<p>信息不要求,无需认证</p>
<h4 id="安装组件"><a href="#安装组件" class="headerlink" title="安装组件"></a>安装组件</h4><ol>
<li>安装方法一</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">yum -y install python-pip python-wheel python-setuptools</span><br><span class="line">yum upgrade python-setuptools</span><br><span class="line">pip install requests</span><br><span class="line">pip install --upgrade requests</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>安装方法二</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">wget https://pypi.python.org/packages/c3/38/d95ddb6cc8558930600be088e174a2152261a1e0708a18bf91b5b8c90b22/requests-2.18.3.tar.gz</span><br><span class="line">tar zxvf requests-2.18.3.tar.gz</span><br><span class="line">cd requests-2.18.3</span><br><span class="line">python setup.py build</span><br><span class="line">python setup.py install</span><br></pre></td></tr></table></figure>

<h4 id="下载安装脚本"><a href="#下载安装脚本" class="headerlink" title="下载安装脚本"></a>下载安装脚本</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/X-Mars/Zabbix-Alert-WeChat.git  </span><br><span class="line">cp Zabbix-Alert-WeChat/wechat.py /etc/zabbix/alertscripts  </span><br><span class="line">chmod +x /usr/local/etc/scripts/wechat.py  </span><br><span class="line">chown zabbix.zabbix /usr/local/etc/scripts/wechat.py</span><br></pre></td></tr></table></figure>

<h3 id="微信企业号设置"><a href="#微信企业号设置" class="headerlink" title="微信企业号设置"></a>微信企业号设置</h3><h4 id="通讯录设置"><a href="#通讯录设置" class="headerlink" title="通讯录设置"></a>通讯录设置</h4><p>登陆微信企业号控制台  </p>
<p><img src="../../img/1558583445317.png" alt="1558583445317"></p>
<p>点击左侧“通讯录”，新增部门（技术部）与子部门（运维部），并添加用户 </p>
<p><img src="../../img/1558583950181.png" alt="1558583950181"></p>
<p>点击（运维部）后方的三角，修改部门，记录<strong>部门ID</strong>  </p>
<p><img src="../../img/1558584006786.png" alt="1558584006786"></p>
<h4 id="创建应用"><a href="#创建应用" class="headerlink" title="创建应用"></a>创建应用</h4><p>点击左侧“应用中心”，新建消息型应用，应用名称“自己随便取” </p>
<p><img src="../../img/1558584148515.png" alt="1558584148515"></p>
<p>“应用可见范围”，添加刚刚新建的子部门（运维部）  </p>
<p><img src="../../img/1558584304526.png" alt="1558584304526"></p>
<p>点击“自己随便取的应用”，记录<strong>应用ID</strong></p>
<h4 id="应用权限设置"><a href="#应用权限设置" class="headerlink" title="应用权限设置"></a>应用权限设置</h4><p>点击左侧“设置”，权限管理，新建普通管理组，名称填写“zabbix报警组”<br>点击修改“通讯录权限”，勾选（技术部）后方的管理<br>点击修改“应用权限”，勾选刚刚创建的“zabbix报警”  </p>
<p><img src="../../img/1558584738682.png" alt="1558584738682"></p>
<p>点击刚刚创建的“zabbix报警组”，记录左侧的<strong>CorpID与Secret</strong>(个人创建的没有,问题不大)</p>
<h4 id="收集微信相关信息"><a href="#收集微信相关信息" class="headerlink" title="收集微信相关信息"></a>收集微信相关信息</h4><ol>
<li>记录<strong>应用ID</strong></li>
</ol>
<p><img src="../../img/1558587645603.png" alt="1558587645603"></p>
<ol start="2">
<li>记录<strong>CorpID与Secret</strong></li>
</ol>
<p><img src="../../img/1558587536574.png" alt="1558587536574"></p>
<ol start="3">
<li>记录<strong>子部门（运维部）ID</strong></li>
</ol>
<p><img src="../../img/1558587727154.png" alt="1558587727154"></p>
<p>这时,就可以填写脚本却的参数了:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/python2.7</span><br><span class="line">#_*_coding:utf-8 _*_</span><br><span class="line">#auther:火星小刘(出自这位大佬的GitHub库,链接在开头)</span><br><span class="line"></span><br><span class="line">import requests,sys,json</span><br><span class="line">import urllib3</span><br><span class="line">urllib3.disable_warnings()</span><br><span class="line"></span><br><span class="line">reload(sys)</span><br><span class="line">sys.setdefaultencoding(&apos;utf-8&apos;)</span><br><span class="line"></span><br><span class="line">def GetTokenFromServer(Corpid,Secret):</span><br><span class="line">    Url = &quot;https://qyapi.weixin.qq.com/cgi-bin/gettoken&quot;</span><br><span class="line">    Data = &#123;</span><br><span class="line">        &quot;corpid&quot;:Corpid,</span><br><span class="line">        &quot;corpsecret&quot;:Secret</span><br><span class="line">    &#125;</span><br><span class="line">    r = requests.get(url=Url,params=Data,verify=False)</span><br><span class="line">    print(r.json())</span><br><span class="line">    if r.json()[&apos;errcode&apos;] != 0:</span><br><span class="line">        return False</span><br><span class="line">    else:</span><br><span class="line">        Token = r.json()[&apos;access_token&apos;]</span><br><span class="line">        file = open(&apos;/tmp/zabbix_wechat_config.json&apos;, &apos;w&apos;)</span><br><span class="line">        file.write(r.text)</span><br><span class="line">        file.close()</span><br><span class="line">        return Token</span><br><span class="line"></span><br><span class="line">def SendMessage(User,Agentid,Subject,Content):</span><br><span class="line">    try:</span><br><span class="line">        file = open(&apos;/tmp/zabbix_wechat_config.json&apos;, &apos;r&apos;)</span><br><span class="line">        Token = json.load(file)[&apos;access_token&apos;]</span><br><span class="line">        file.close()</span><br><span class="line">    except:</span><br><span class="line">        Token = GetTokenFromServer(Corpid, Secret)</span><br><span class="line"></span><br><span class="line">    n = 0</span><br><span class="line">    Url = &quot;https://qyapi.weixin.qq.com/cgi-bin/message/send?access_token=%s&quot; % Token</span><br><span class="line">    Data = &#123;</span><br><span class="line">        &quot;touser&quot;: User,          # 企业号中的用户帐号，在zabbix用户Media中配置，如果配置不正常，将按部门发送。</span><br><span class="line">        &quot;totag&quot;: Tagid,          # 企业号中的标签id，群发使用（推荐）</span><br><span class="line">        &quot;toparty&quot;: Partyid,      # 企业号中的部门id，群发时使用。</span><br><span class="line">        &quot;msgtype&quot;: &quot;text&quot;,       # 消息类型。</span><br><span class="line">        &quot;agentid&quot;: Agentid,      # 企业号中的应用id。</span><br><span class="line">        &quot;text&quot;: &#123;</span><br><span class="line">            &quot;content&quot;: Subject + &apos;\n&apos; + Content</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;safe&quot;: &quot;0&quot;</span><br><span class="line">    &#125;</span><br><span class="line">    r = requests.post(url=Url,data=json.dumps(Data),verify=False)</span><br><span class="line">    while r.json()[&apos;errcode&apos;] != 0 and n &lt; 4:</span><br><span class="line">        n+=1</span><br><span class="line">        Token = GetTokenFromServer(Corpid, Secret)</span><br><span class="line">        if Token:</span><br><span class="line">            Url = &quot;https://qyapi.weixin.qq.com/cgi-bin/message/send?access_token=%s&quot; % Token</span><br><span class="line">            r = requests.post(url=Url,data=json.dumps(Data),verify=False)</span><br><span class="line">            print(r.json())</span><br><span class="line"></span><br><span class="line">    return r.json()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if __name__ == &apos;__main__&apos;:</span><br><span class="line">    User = sys.argv[1]               # zabbix传过来的第一个参数&#123;ALERT.SENDTO&#125;</span><br><span class="line">    Subject = str(sys.argv[2])       # zabbix传过来的第二个参数&#123;ALERT.SUBJECT&#125;</span><br><span class="line">    Content = str(sys.argv[3])       # zabbix传过来的第三个参数&#123;ALERT.MESSAGE&#125;</span><br><span class="line"></span><br><span class="line">    Corpid = &quot;企业Id&quot;         # CorpID是企业号的标识</span><br><span class="line">    Secret = &quot;在应用里面&quot;      # Secret是管理组凭证密钥</span><br><span class="line">    Tagid = &quot;zabbix&quot;         # 通讯录标签ID(这个没搞懂,随便写的通讯录标签名)</span><br><span class="line">    Agentid = &quot;自己修改&quot;      # 应用ID</span><br><span class="line">    Partyid = &quot;2&quot;            # 部门ID,如果是1,则是技术部,那么技术部下面的,都可以收到告警,显然不合适</span><br><span class="line"></span><br><span class="line">    Status = SendMessage(User,Agentid,Subject,Content)</span><br><span class="line">    print Status</span><br></pre></td></tr></table></figure>

<h3 id="zabbix设置"><a href="#zabbix设置" class="headerlink" title="zabbix设置"></a>zabbix设置</h3><ol>
<li>添加示警媒介  </li>
</ol>
<p><img src="../../img/1558587849221.png" alt="1558587849221"></p>
<h4 id="管理–-gt-示警媒介"><a href="#管理–-gt-示警媒介" class="headerlink" title="管理–&gt;示警媒介"></a>管理–&gt;示警媒介</h4><p>名称填写<strong>微信报警</strong>，类型选择<strong>脚本</strong>，脚本名称填写<strong>wechat.py</strong>  </p>
<h4 id="管理–-gt-用户–-gt-示警媒介"><a href="#管理–-gt-用户–-gt-示警媒介" class="headerlink" title="管理–&gt;用户–&gt;示警媒介"></a>管理–&gt;用户–&gt;示警媒介</h4><p>类型选择<strong>微信报警</strong>，收件人添加<strong>微信企业号通讯录内的，用户帐号</strong></p>
<p><img src="../../img/1558587981394.png" alt="1558587981394"></p>
<p>添加到动作,具体方法,如下图所示</p>
<p><img src="../../img/1558588246133.png" alt="1558588246133"></p>
<p>测试一:</p>
<p><img src="../../img/1558588591326.png" alt="1558588591326"></p>
<p>结果一:</p>
<p><img src="../../img/Screenshot_20190523-132529__01.jpg" alt></p>
<p>测试二:手动触发</p>
<p><img src="../../img/1558589480439.png" alt="1558589480439"></p>
<p>结果二:</p>
<p><img src="../../img/Screenshot_20190523-133330__01.jpg" alt></p>
<h2 id="二-钉钉告警"><a href="#二-钉钉告警" class="headerlink" title="二,钉钉告警"></a>二,钉钉告警</h2><p><strong>下载钉钉后创建群组</strong></p>
<p><strong>添加机器人实现报警</strong></p>
<p> <img src="../../img/1558609475491.png" alt="1558609475491"></p>
<p><strong>添加完成</strong></p>
<p>创建告警脚本</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">简洁版一:</span><br><span class="line">#!/usr/bin/python</span><br><span class="line"># -*- coding: utf-8 -*-</span><br><span class="line"></span><br><span class="line">import requests</span><br><span class="line">import json</span><br><span class="line">import sys</span><br><span class="line">import os</span><br><span class="line">headers = &#123;&apos;Content-Type&apos;: &apos;application/json;charset=utf-8&apos;&#125;</span><br><span class="line">#api_url后跟告警机器人的webhook</span><br><span class="line">api_url = &quot;上图中的webhook的链接&quot;</span><br><span class="line">def msg(text):</span><br><span class="line">   json_text= &#123;</span><br><span class="line">    &quot;msgtype&quot;: &quot;text&quot;,</span><br><span class="line">    &quot;text&quot;: &#123;</span><br><span class="line">        &quot;content&quot;: text</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;at&quot;: &#123;</span><br><span class="line">        &quot;atMobiles&quot;: [</span><br><span class="line">            &quot;手机号&quot;    #@群里的一个人</span><br><span class="line">        ],</span><br><span class="line">        &quot;isAtAll&quot;: False  #@所有人为True,</span><br><span class="line">    &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   print(requests.post(api_url,json.dumps(json_text),headers=headers).content)</span><br><span class="line">if __name__ == &apos;__main__&apos;:</span><br><span class="line">   text = sys.argv[1]</span><br><span class="line">   msg(text)</span><br><span class="line">   </span><br><span class="line">   </span><br><span class="line">脚本二:</span><br><span class="line">#!/usr/bin/env python</span><br><span class="line">#coding:utf-8</span><br><span class="line">#zabbix钉钉报警</span><br><span class="line">import requests,json,sys,os,datetime</span><br><span class="line">webhook=&quot;https://oapi.dingtalk.com/robot/send?access_token=8ea7abd3db4b49a9e898e911920d4899c526ae78f5794c977cfca8b6c0b77fdf&quot;</span><br><span class="line">user=sys.argv[1]</span><br><span class="line">text=sys.argv[3]</span><br><span class="line">data=&#123;</span><br><span class="line">    &quot;msgtype&quot;: &quot;text&quot;,</span><br><span class="line">    &quot;text&quot;: &#123;</span><br><span class="line">        &quot;content&quot;: text</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;at&quot;: &#123;</span><br><span class="line">        &quot;atMobiles&quot;: [</span><br><span class="line">            user</span><br><span class="line">        ],</span><br><span class="line">        &quot;isAtAll&quot;: False</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">headers = &#123;&apos;Content-Type&apos;: &apos;application/json&apos;&#125;</span><br><span class="line">x=requests.post(url=webhook,data=json.dumps(data),headers=headers)</span><br><span class="line">if os.path.exists(&quot;/tmp/ding.log&quot;):</span><br><span class="line">    f=open(&quot;/tmp/ding.log&quot;,&quot;a+&quot;)</span><br><span class="line">else:</span><br><span class="line">    f=open(&quot;tmp/ding.log&quot;,&quot;w+&quot;)</span><br><span class="line">f.write(&quot;\n&quot;+&quot;--&quot;*30)</span><br><span class="line">if x.json()[&quot;errcode&quot;] == 0:</span><br><span class="line">    f.write(&quot;\n&quot;+str(datetime.datetime.now())+&quot;    &quot;+str(user)+&quot;    &quot;+&quot;发送成功&quot;+&quot;\n&quot;+str(text))</span><br><span class="line">    f.close()</span><br><span class="line">else:</span><br><span class="line">    f.write(&quot;\n&quot;+str(datetime.datetime.now()) + &quot;    &quot; + str(user) + &quot;    &quot; + &quot;发送失败&quot; + &quot;\n&quot; + str(text))</span><br><span class="line">    f.close()</span><br></pre></td></tr></table></figure>

<p>赋予执行权限</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">chown zabbix.zabbix ding.py</span><br><span class="line"></span><br><span class="line">chmod +x ding.py</span><br></pre></td></tr></table></figure>

<p>测试</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@zabbix scripts]# ./ding.py 这是测试</span><br><span class="line">&#123;&quot;errcode&quot;:0,&quot;errmsg&quot;:&quot;ok&quot;&#125;</span><br><span class="line">[root@zabbix scripts]# ./ding.py 这是测试</span><br><span class="line">&#123;&quot;errcode&quot;:0,&quot;errmsg&quot;:&quot;ok&quot;&#125;</span><br></pre></td></tr></table></figure>

<p><img src="../../img/1558610185107.png" alt="1558610185107"></p>
<p>如果想知道消息内容中宏，可参考<a href="https://www.zabbix.com/documentation/4.2/manual/appendix/macros/supported_by_location" target="_blank" rel="noopener">官网宏的使用场景</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">服务器:&#123;HOST.NAME&#125;发生: &#123;TRIGGER.NAME&#125;故障!</span><br><span class="line">&#123;</span><br><span class="line">告警主机:&#123;HOST.NAME&#125;</span><br><span class="line">告警地址:&#123;HOST.IP&#125;</span><br><span class="line">监控项目:&#123;ITEM.NAME&#125;</span><br><span class="line">监控取值:&#123;ITEM.LASTVALUE&#125;</span><br><span class="line">告警等级:&#123;TRIGGER.SEVERITY&#125;</span><br><span class="line">当前状态:&#123;TRIGGER.STATUS&#125;</span><br><span class="line">告警信息:&#123;TRIGGER.NAME&#125;</span><br><span class="line">告警时间:&#123;EVENT.DATE&#125; &#123;EVENT.TIME&#125;</span><br><span class="line">事件ID:&#123;EVENT.ID&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">服务器:&#123;HOST.NAME&#125;: &#123;TRIGGER.NAME&#125;已恢复!</span><br><span class="line">&#123;</span><br><span class="line">告警主机:&#123;HOST.NAME&#125;</span><br><span class="line">告警地址:&#123;HOST.IP&#125;</span><br><span class="line">监控项目:&#123;ITEM.NAME&#125;</span><br><span class="line">监控取值:&#123;ITEM.LASTVALUE&#125;</span><br><span class="line">告警等级:&#123;TRIGGER.SEVERITY&#125;</span><br><span class="line">当前状态:&#123;TRIGGER.STATUS&#125;</span><br><span class="line">告警信息:&#123;TRIGGER.NAME&#125;</span><br><span class="line">告警时间:&#123;EVENT.DATE&#125; &#123;EVENT.TIME&#125;</span><br><span class="line">恢复时间:&#123;EVENT.RECOVERY.DATE&#125; &#123;EVENT.RECOVERY.TIME&#125;</span><br><span class="line">持续时间:&#123;EVENT.AGE&#125;</span><br><span class="line">事件ID:&#123;EVENT.ID&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">服务器:&#123;HOST.NAME&#125;: 报警确认</span><br><span class="line">&#123;</span><br><span class="line">确认人:&#123;USER.FULLNAME&#125; </span><br><span class="line">时间:&#123;ACK.DATE&#125; &#123;ACK.TIME&#125; </span><br><span class="line">确认信息如下:</span><br><span class="line">&quot;&#123;ACK.MESSAGE&#125;&quot;</span><br><span class="line">问题服务器IP:&#123;HOSTNAME1&#125;</span><br><span class="line">问题ID:&#123;EVENT.ID&#125;</span><br><span class="line">当前的问题是: &#123;TRIGGER.NAME&#125;</span><br><span class="line">&#125;</span><br><span class="line">分别填在下面3个操作</span><br></pre></td></tr></table></figure>

<p><img src="../../img/1558611240781.png" alt="1558611240781"></p>
<p>创建报警媒介   </p>
<p><img src="../../img/1558610599068.png" alt="1558610599068"></p>
<p>脚本二需要3个脚本参数：ALERT.SENDTO      ALERT.SUBJECT      ALERT.MESSAGE</p>
<p><img src="../../img/1558688875988.png" alt="1558688875988"></p>
<p>用户设置媒介(收件人py脚本写死了,这随便写)</p>
<p><img src="../../img/1558610665901.png" alt="1558610665901"></p>
<p>脚本二:</p>
<p><img src="../../img/1558689127326.png" alt="1558689127326"></p>
<p>添加动作(和上方WeChat方法一样,改一个通知介质),这里就不截屏了</p>
<p>最后测试附图:</p>
<p><img src="../../img/1558611032763.png" alt="1558611032763"></p>

          
        
      
    </div>

    

    

    
    
    

    

    
      
    
    

    
	
	  <div>
        
      </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://aiwhs.github.io/2019/01/06/Zabbix监控组件及流程/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="itw">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="itw">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/01/06/Zabbix监控组件及流程/" class="post-title-link" itemprop="url">Zabbix监控组件及流程</a>
              
            
          </h1>
        

        <div class="post-meta">

          
          
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-01-06 08:15:57" itemprop="dateCreated datePublished" datetime="2019-01-06T08:15:57+08:00">2019-01-06</time>
            </span>
          

          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-07-17 20:00:34" itemprop="dateModified" datetime="2019-07-17T20:00:34+08:00">2019-07-17</time>
              </span>
            
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Linux运维/" itemprop="url" rel="index"><span itemprop="name">Linux运维</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          <br>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <a id="more"></a>



<h2 id="Zabbix监控组件及流程"><a href="#Zabbix监控组件及流程" class="headerlink" title="Zabbix监控组件及流程"></a><strong>Zabbix监控组件及流程</strong></h2><p>Zabbix监控组件主要包括：Zabbix Server、Zabbix Proxy、Zabbix Agent；其中Zabbix Server包括：WEB GUI、Database、Zabbix Server。</p>
<h3 id="每个模块工作职责："><a href="#每个模块工作职责：" class="headerlink" title="每个模块工作职责："></a>每个模块工作职责：</h3><ul>
<li>Zabbix Server：负责接收agent发送的报告信息的核心组件，所有配置，统计数据及操作数据均由其组织进行；</li>
<li>Database Storage：用户存储所有配置信息，以及存储由Zabbix Server收集到的数据；</li>
<li>Web Interface：Zabbix的GUI接口，通常与Server运行在同一台主机上；</li>
<li>Zabbix Proxy：常用于分布监控环境中，代理Server收集部分被监控的监控数据并统一发往Server端；（通常大于500台主机需要使用）</li>
<li>Zabbix Agent：部署在被监控主机上，负责收集本地数据发往Server端或Proxy端；</li>
</ul>
<h2 id="Zabbix监控系统具体监控流程："><a href="#Zabbix监控系统具体监控流程：" class="headerlink" title="Zabbix监控系统具体监控流程："></a>Zabbix监控系统具体监控流程：</h2><p><img src="../../img/01.jpg" alt="Zabbix监控组件介绍、工作原理、监控方式、监控概念 linux服务搭建1"></p>
<h2 id="Zabbix监控原理："><a href="#Zabbix监控原理：" class="headerlink" title="Zabbix监控原理："></a><strong>Zabbix监控原理：</strong></h2><p>Agentd安装在被监控的主机上，Agent负责定期收集客户端本地各项数据，并发送至Zabbix Server端，Zabbix Server收到数据，将数据存储到数据库中，用户基于Zabbix WEB可以看到数据在前端展现图像。当Zabbix监控某个具体的项目，改项目会设置一个触发器阈值，当被监控的指标超过该触发器设定的阈值，会进行一些必要的动作，动作包括：发送信息（邮件、微信、短信）、发送命令（SHELL 命令、Reboot、Restart、Install等）。</p>
<h2 id="Zabbix监控常见的五个程序及功能"><a href="#Zabbix监控常见的五个程序及功能" class="headerlink" title="Zabbix监控常见的五个程序及功能"></a>Zabbix监控常见的五个程序及功能</h2><ul>
<li>zabbix server：zabbix服务端守护进程，其中zabbix_agentd、zabbix_get、zabbix_sender、zabbix_proxy的数据最终都提交给zabbix server；</li>
<li>zabbix agentd：客户端守护进程，负责收集客户端数据，例如：收集cpu负载、内存、硬盘使用情况等；</li>
<li>zabbix proxy：zabbix分布式代理守护进程，通过大于500台主机，需要进行分布式监控架构部署；</li>
<li>zabbix get：zabbix数据接收工具，单独使用的命令，通常在server或者proxy端执行获取远程客户端信息的命令；</li>
<li>zabbix sender：zabbix数据发送工具，用户发送数据给server或proxy端，通常用户耗时比较长的检查。</li>
</ul>
<h2 id="Zabbix三种监控方式：Agent、SNMP、IPMI"><a href="#Zabbix三种监控方式：Agent、SNMP、IPMI" class="headerlink" title="Zabbix三种监控方式：Agent、SNMP、IPMI"></a><strong>Zabbix三种监控方式：Agent、SNMP、IPMI</strong></h2><p>Agent：Zabbix可以基于自身zabbix_agent客户端插件监控OS的状态，例如CPU、内存、硬盘、网卡、文件等。</p>
<p>SNMP：Zabbix通过简单网络管理协议（Simple Network Management Protocol）监控网络设备或windows主机等。通过设定SNMP的参数将相关监控数据传送至服务端，交换机、防火墙等网络设备一般都支持SNMP协议。</p>
<p>IPMI：智能平台管理接口（Intelligent Platform Management Interface，IPMI）即主要应用于设备的物理特性，包括：温度、电压、电扇工作状态，电源供应以及机箱入侵等。IPMI最大的优势在于无论OS的开机还是关机状态下，只要接通电源就可以实现对服务器的监控。</p>
<h2 id="主动监控与被动监控"><a href="#主动监控与被动监控" class="headerlink" title="主动监控与被动监控"></a>主动监控与被动监控</h2><ul>
<li>Zabbix监控客户端分为主动监控与被动监控，主被动模式以客户端为参照，Zabbix监控客户端默认为被动模式，可以修改为主动模式，只需要在客户端配置文件中添加 StartAgents=0。主被动监控模式如下：</li>
<li>Zabbix主动模式：Agent主动请求server获取主动的监控项列表，并主动将监控项内需要检测的数据提交给server/proxy，zabbix agent首先向ServerActive配置的IP请求获取active items，获取并提交active items数据至server/proxy。</li>
<li>Zabbix被动模式：Server向agent请求获取监控项的数据，agent返回数据，server打开一个TCP连接，Server发送请求agent.ping，Agent接收到请求并且响应，Server处理接收到的数据。</li>
</ul>
<h2 id="Zabbix监控概念"><a href="#Zabbix监控概念" class="headerlink" title="Zabbix监控概念"></a><strong>Zabbix监控概念</strong></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">主机（host）：                             被监控的网络设备，可以写IP或者DNS；</span><br><span class="line">主机组（host group）：             主机组用于管理主机，可以批量设置权限；</span><br><span class="line">监控项（item）：                        具体监控项，items值由独立的keys进行识别；</span><br><span class="line">触发器（trigger）：                    为某个items设置触发器，达到触发器会执行action动作；</span><br><span class="line">事件（event）：                          例如达到某个触发器，称之为一个事件；</span><br><span class="line">动作（action）：                         对于特定事件事先定义的处理方法，默认可以发送信息及发送命令；</span><br><span class="line">报警升级（escalation）：         发送警报或执行远程命令的自定义方案，如隔5分钟发送一次警报，共发送5次等。</span><br><span class="line">媒介（media）：                        发送通知的方式，可以支持Mail、SMS、Scripts等；</span><br><span class="line">通知（notification）：               通过设置的媒介向用户发送的有关某事件的信息；</span><br><span class="line">远程命令 ：                                   达到触发器，可以在被监控端执行命令；</span><br><span class="line">模板（template）：                    可以快速监控被监控端，模块包含：item、trigger、graph、screen、application；</span><br><span class="line">web场景（web scennario）       用于检测web站点可用性，监控HTTP关键词；</span><br><span class="line">web前端（frontend）：             Zabbix的web接口；</span><br><span class="line">图形（graph）：                          监控图像；</span><br><span class="line">屏幕（screens）：                       屏幕显示；</span><br><span class="line">幻灯（slide show）：                  幻灯显示</span><br></pre></td></tr></table></figure>

<h2 id="在WEB界面主机配置的步骤"><a href="#在WEB界面主机配置的步骤" class="headerlink" title="在WEB界面主机配置的步骤"></a>在WEB界面主机配置的步骤</h2><ul>
<li>创建主机群组(按照项目分类,按照系统类型分类,按照应用类型分类)</li>
<li>添加主机(注意配置文件参数和web对应)</li>
<li>创建应用集(或者添加模板)</li>
<li>添加监控项</li>
<li>给监控项添加触发器</li>
<li>设置报警类型(发邮件,打电话,发短信,微信推送,脚本)</li>
<li>配置用户报警方式</li>
<li>添加针对触发器指定的动作</li>
<li>测试</li>
</ul>
<h2 id="以监控-etc-passwd为例"><a href="#以监控-etc-passwd为例" class="headerlink" title="以监控/etc/passwd为例"></a>以监控/etc/passwd为例</h2><h3 id="创建主机群组"><a href="#创建主机群组" class="headerlink" title="创建主机群组"></a>创建主机群组</h3><p>点击配置——主机群组——创建主机群组，页面如下</p>
<p><img src="../../img/2019-05-22_101757.png" alt></p>
<p>说明：</p>
<ul>
<li>每个主机都需要在一个主机群组中，在创建主机时需要指定。</li>
</ul>
<h3 id="添加主机"><a href="#添加主机" class="headerlink" title="添加主机"></a>添加主机</h3><ul>
<li>点击配置——主机——创建主机，页面配置如下</li>
</ul>
<p><img src="../../img/2019-05-22_102120.png" alt="2019-05-22_102120"></p>
<h3 id="创建应用集"><a href="#创建应用集" class="headerlink" title="创建应用集"></a>创建应用集</h3><ul>
<li>配置——主机——应用集——创建应用集，页面如下</li>
</ul>
<p><img src="../../img/2019-05-22_104131.png" alt></p>
<h3 id="添加监控项"><a href="#添加监控项" class="headerlink" title="添加监控项"></a>添加监控项</h3><ul>
<li>配置——主机——监控项——创建监控项页，页面配置如下</li>
</ul>
<p><img src="../../img/2019-05-22_110610.png" alt></p>
<ul>
<li>查看监控是否可以监控到数据，点击检测中——最新数据，页面配置如下</li>
</ul>
<p><img src="../../img/2019-05-22_111027.png" alt></p>
<ul>
<li>监控到的数据，点击查看</li>
</ul>
<p><img src="../../img/2019-05-22_111223.png" alt></p>
<h3 id="给监控项添加触发器"><a href="#给监控项添加触发器" class="headerlink" title="给监控项添加触发器"></a>给监控项添加触发器</h3><ul>
<li>配置——主机——触发器——创建触发器，页面配置如下</li>
</ul>
<p><img src="../../img/2019-05-22_111829.png" alt></p>
<p><img src="../../img/2019-05-22_112100.png" alt></p>
<ul>
<li>需要验证触发器的正确性，在client端中，修改/etc/passwd文件，看能否触发，点击<strong>监测——仪表板</strong>，问题仪表盘中有<strong>闪烁</strong>项表示触发器<strong>生效</strong>，反之不生效</li>
</ul>
<p><img src="../../img/2019-05-22_112344.png" alt></p>
<h3 id="电子邮件报警"><a href="#电子邮件报警" class="headerlink" title="电子邮件报警"></a>电子邮件报警</h3><p><img src="../../img/TIM%E5%9B%BE%E7%89%8720190522180228.jpg" alt></p>
<ul>
<li>先要在服务端安装mailx；</li>
<li>重新启动postfix服务；</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@server ~]# systemctl restart postfix</span><br></pre></td></tr></table></figure>

<ul>
<li>测试手动发送邮件；</li>
</ul>
<p><img src="../../img/2019-05-22_112855.png" alt></p>
<p><img src="../../img/2019-05-22_112728.png" alt></p>
<ul>
<li>添加报警媒介内容（可以选择默认的E-mail方式或者手动创建媒介类型）；<ul>
<li>默认的E-mail方式；</li>
<li>点击管理——报警媒介类型——选择Email，页面设置如下</li>
</ul>
</li>
</ul>
<p><img src="../../img/2019-05-22_113721.png" alt></p>
<ul>
<li>注：手动添加方式与上图一样，若没有邮箱可用或者邮箱反垃圾系统会将邮件过滤掉可以使用linux系统自带邮箱，设置方法如下图</li>
</ul>
<p><img src="../../img/2019-05-22_115821.png" alt></p>
<ul>
<li><p>配置用户发送的警告方式</p>
</li>
<li><p>管理——用户——选择Admin（或者其他用户）——报警媒介，页面设置如下</p>
</li>
</ul>
<p><img src="../../img/2019-05-22_120335.png" alt></p>
<ul>
<li><p>配置触发器的动作</p>
</li>
<li><p>点击配置——动作——创建动作，第一页面添加名称,——点击操作，页面如下</p>
</li>
</ul>
<p><img src="../../img/2019-05-22_120935.png" alt></p>
<ul>
<li>修改/etc/passwd文件查看验证</li>
</ul>
<p><img src="../../img/1558506541852.png" alt="1558506541852"></p>
<h3 id="脚本报警"><a href="#脚本报警" class="headerlink" title="脚本报警"></a>脚本报警</h3><ul>
<li>安装mailx</li>
<li>重启postfix服务</li>
<li>测试手动发送邮件</li>
<li>添加告警媒介<ul>
<li>点击配置——报警媒介类型——创建媒介类型，页面配置如下</li>
</ul>
</li>
</ul>
<p><img src="../../img/2019-05-22_180501.png" alt></p>
<ul>
<li>配置用户的警告方式</li>
</ul>
<p><img src="../../img/2019-05-22_181033.png" alt></p>
<p>点击更新</p>
<ul>
<li>配置触发器的动作</li>
<li>点击配置——动作——创建动作，页面如图一——操作，页面如图二</li>
</ul>
<p><img src="../../img/2019-05-22_181310.png" alt></p>
<ul>
<li><p>在服务端上写发送告警信息脚本</p>
</li>
<li><p>在服务端创建存放脚本的目录并写如下图脚本，将目录以及脚本的属主和属组设置为zabbix，并给脚本执行权限</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@server ~]# mkdir /usr/local/etc/scripts</span><br><span class="line">[root@server scripts]# vim sendmail.sh</span><br><span class="line">#!/bin/bash</span><br><span class="line">subject=$(echo $2 |tr &quot;\r\n&quot; &quot;\n&quot;)</span><br><span class="line">message=$(echo $3 |tr &quot;\r\n&quot; &quot;\n&quot;)</span><br><span class="line">echo &quot;$message&quot; | /usr/bin/mail -s &quot;$subject&quot; $1 &amp;&gt;/tmp/sm.log</span><br><span class="line"></span><br><span class="line">[root@server scripts]# cd ..</span><br><span class="line">[root@server etc]# chown -R zabbix.zabbix scripts</span><br><span class="line">[root@server etc]# chmod +x scripts/sendmail.sh</span><br></pre></td></tr></table></figure>



<ul>
<li>修改/usr/local/etc/zabbix_server.conf，修改如下</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AlertScriptsPath=/usr/local/etc/scripts</span><br></pre></td></tr></table></figure>

<ul>
<li>重启服务</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@server ~]# pkill zabbix</span><br><span class="line">[root@server ~]# zabbix_server </span><br><span class="line">[root@server ~]# zabbix_agentd </span><br><span class="line">[root@server ~]# ss -ntl</span><br><span class="line">State       Recv-Q Send-Q               Local Address:Port                 Peer Address:Port </span><br><span class="line">LISTEN      0      128                             *:10050                           *:*     </span><br><span class="line">LISTEN      0      128                              *:10051</span><br></pre></td></tr></table></figure>

<ul>
<li>修改配置文件查看验证</li>
</ul>
<p><img src="../../img/1558521078432.png" alt="1558521078432"></p>
<p><img src="../../img/1558521155686.png" alt="1558521155686"></p>
<h3 id="通过zabbix用户发送邮件"><a href="#通过zabbix用户发送邮件" class="headerlink" title="通过zabbix用户发送邮件"></a>通过zabbix用户发送邮件</h3><ul>
<li>在服务端安装mailx、postfix</li>
<li>重新启动postfix</li>
<li>添加邮箱白名单<a href="mailto:zabbix@zabbix.server.com" target="_blank" rel="noopener">zabbix@zabbix.server.com</a></li>
<li>修改主机名</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# hostnamectl set-hostname zabbix.server.com</span><br></pre></td></tr></table></figure>

<ul>
<li>修改/etc/hosts文件,添加如下</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1	zabbix.com</span><br></pre></td></tr></table></figure>

<ul>
<li>重启postfix服务</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@server etc]# systemctl restart postfix</span><br></pre></td></tr></table></figure>

<ul>
<li>添加告警媒介</li>
</ul>
<p><img src="../../img/1558523235561.png" alt="02"></p>
<ul>
<li>添加告警用户</li>
</ul>
<p><img src="../../img/1558523538073.png" alt="1558523538073"></p>
<ul>
<li>添加动作</li>
</ul>
<p><img src="../../img/1558523604822.png" alt="1558523604822"></p>
<ul>
<li>修改配置文件进行验证</li>
</ul>
<p><img src="../../img/1558523472639.png" alt="1558523472639"></p>

          
        
      
    </div>

    

    

    
    
    

    

    
      
    
    

    
	
	  <div>
        
      </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://aiwhs.github.io/2019/01/05/Zabbix的自定义监控/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="itw">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="itw">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/01/05/Zabbix的自定义监控/" class="post-title-link" itemprop="url">zabbix自定义监控</a>
              
            
          </h1>
        

        <div class="post-meta">

          
          
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-01-05 08:15:57" itemprop="dateCreated datePublished" datetime="2019-01-05T08:15:57+08:00">2019-01-05</time>
            </span>
          

          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-07-17 19:50:13" itemprop="dateModified" datetime="2019-07-17T19:50:13+08:00">2019-07-17</time>
              </span>
            
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Linux运维/" itemprop="url" rel="index"><span itemprop="name">Linux运维</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          <br>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <a id="more"></a>



<h3 id="进程和日志"><a href="#进程和日志" class="headerlink" title="进程和日志"></a>进程和日志</h3><ul>
<li><p>有的时候zabbix提供的监控项目，不能满足我们生产环境下的监控需求，此时我们就要按照zabbix的规范自定义监控项目，达到监控的目的</p>
</li>
<li><p>zabbix_get:模拟zabbix_server和agent获取数据</p>
</li>
<li><p>相关概念</p>
</li>
<li><p>item: Items是从agnet主机里面获取的所有数据。通常情况下我叫itme为监控项,item由key+参数组成</p>
</li>
<li><p>Key：我们可以理解为key是item的唯一标识，在agent端有很多监控项，zabbix-server根据key区分不同的监控项</p>
</li>
<li><p>trigger：触发器是建立在item数据上的，具有阈值触发事件的功能</p>
<blockquote>
<p>  基本格式: :.()}</p>
<p>  server:agent名称，加入主机时配置的</p>
<p>  key：就是上面说的key</p>
<p>  function：对阈值进行操作的函数，以下函数</p>
<p>  operate：表达式</p>
<p>  constant：常量</p>
</blockquote>
</li>
</ul>
<p>例如：{docker02:proc.mysql.last()}&lt;&gt;1</p>
<ul>
<li>不用担心trigger表达式不好写，在定义好item后，在zabbix点点就自动生成了</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">zabbix_get -s 192.168.161.67 -k ckproc[postfix]</span><br><span class="line">3</span><br><span class="line"># -s:指定agent地址</span><br><span class="line"># -p：agent端口</span><br><span class="line"># -k：指定item的key</span><br><span class="line"># [postfix]:向脚本传递的参数(用逗号分隔)</span><br></pre></td></tr></table></figure>

<hr>
<h4 id="下面以监控postfix服务进程为例，做了自定义监控"><a href="#下面以监控postfix服务进程为例，做了自定义监控" class="headerlink" title="下面以监控postfix服务进程为例，做了自定义监控"></a>下面以监控postfix服务进程为例，做了自定义监控</h4><hr>
<h3 id="1-zabbix-server与zabbix-agent"><a href="#1-zabbix-server与zabbix-agent" class="headerlink" title="1. zabbix_server与zabbix_agent"></a>1. zabbix_server与zabbix_agent</h3><p><img src="../../img/064b243ede8a779a7b1695560d109dfc_461x224.png" alt="img"></p>
<ul>
<li>zabbix_server通过发送key给zabbix_agent,然后agent端口根据key，把所要监控的item的最新数据返回给server端</li>
</ul>
<hr>
<h3 id="2-自定义监控项"><a href="#2-自定义监控项" class="headerlink" title="2. 自定义监控项"></a>2. 自定义监控项</h3><ul>
<li>自定义脚本格式</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">key[*],[command|sh]</span><br><span class="line"># &lt;key[参数]&gt;，&lt;命令或者脚本&gt;</span><br><span class="line"># [*]：固定格式，表示server端是否传过来参数，在命令或者脚本中用$1,23...引用，shell脚本中的引用$$1,2,3..引用，</span><br><span class="line"># 如果server端不传参数，[*]可以不写</span><br></pre></td></tr></table></figure>

<h4 id="2-1-修改agent端配置文件，自定义key"><a href="#2-1-修改agent端配置文件，自定义key" class="headerlink" title="2.1 修改agent端配置文件，自定义key"></a>2.1 修改agent端配置文件，自定义key</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/etc/zabbix_agentd.conf</span><br></pre></td></tr></table></figure>

<ul>
<li>做以下修改</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">UnsafeUserParameters=1 # 默认为0，表示不允许自定义key</span><br><span class="line"># 监控*进程是否存在，[*]是server端传递参数，是服务名称</span><br><span class="line">UserParameter=ckproc[*],/usr/bin/bash /scripts/proc.sh $1</span><br></pre></td></tr></table></figure>

<p>然后写脚本</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mkdir /scripts</span><br><span class="line">vim /scripts/proc.sh</span><br><span class="line">#!/bin/bash</span><br><span class="line">proc_count=$(ps -ef|grep -Ev &quot;grep|$0&quot; |grep -c $1)</span><br><span class="line">echo $proc_count</span><br><span class="line">chown -R zabbix.zabbix /scripts/</span><br><span class="line">chmod +x /scripts/*</span><br></pre></td></tr></table></figure>

<h4 id="2-2-web页面配置，加入自定义监控项"><a href="#2-2-web页面配置，加入自定义监控项" class="headerlink" title="2.2 web页面配置，加入自定义监控项"></a>2.2 web页面配置，加入自定义监控项</h4><p> 1.【配置】-&gt;【主机】,点击所要监控的主机</p>
<p> 2.点击【监控项】</p>
<p> 3.点击右上角【创建监控项】</p>
<p> 4.创建监控项</p>
<ul>
<li>这里的key值对应我们在agent端自定义的key</li>
</ul>
<p><img src="../../img/2019-05-24_103000.png" alt></p>
<ul>
<li>重启agent服务</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pkill zabbix</span><br><span class="line">zabbix_agentd</span><br></pre></td></tr></table></figure>

<h4 id="2-3-查看返回的数据：【检测中】-gt-【最新数据】"><a href="#2-3-查看返回的数据：【检测中】-gt-【最新数据】" class="headerlink" title="2.3 查看返回的数据：【检测中】-&gt;【最新数据】"></a>2.3 查看返回的数据：【检测中】-&gt;【最新数据】</h4><p>最新数据是zabbix所有监控项的收集的数据的概览，从这可以看到监控项最新的监控值</p>
<p><img src="../../img/2019-05-24_104141.png" alt></p>
<blockquote>
<p>从图中可以看到，postfix监控项返回的数值是3，说明postfix的进程数为3，代表postfix运行正常，如果想要可以邮件报警，可以给这个自定义的添加触发器，参考“Zabbix监控组件及流程”一章</p>
</blockquote>
<hr>
<h4 id="2-4-测试结果"><a href="#2-4-测试结果" class="headerlink" title="2.4 测试结果:"></a>2.4 测试结果:</h4><p><img src="../../img/Screenshot_20190524-104950__01.jpg" alt></p>
<hr>
<h4 id="下面是以监控日志，做了自定义监控"><a href="#下面是以监控日志，做了自定义监控" class="headerlink" title="下面是以监控日志，做了自定义监控"></a>下面是以监控日志，做了自定义监控</h4><hr>
<p>注：监控日志用shell脚本难以实现记录之前已经看过的日志，为了解决这个问题，我们用python来监控</p>
<ul>
<li><p>编写Python程序，可以点击<a href="https://github.com/chendao2015/pyscripts/blob/master/log.py" target="_blank" rel="noopener">查看</a></p>
</li>
<li><p>说明：第一个参数为日志文件名（必须有，相对路径、绝对路径均可）</p>
</li>
<li><p>第二个参数为“记录之前所看位置”的文件路径（可选项，若不设置则默认为/tmp/logseek文件。相对路径、绝对路径均可）</p>
</li>
<li><p>第三个参数为搜索关键字，默认为 Error</p>
</li>
<li><p>将脚本文件下载后上传到/scripts/目录下，将文件赋予执行权限并将属主和属组改为zabbix</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line">放脚本路径和上一个例子一样,如果不做上一个例子,自行创建目录,更改属主属组</span><br><span class="line">vim /scripts/log.py</span><br><span class="line">#!/usr/bin/env python3</span><br><span class="line">import sys</span><br><span class="line">import re</span><br><span class="line"></span><br><span class="line">def prePos(seekfile):</span><br><span class="line">    global curpos</span><br><span class="line">    try:</span><br><span class="line">        cf = open(seekfile)</span><br><span class="line">    except IOError:</span><br><span class="line">        curpos = 0</span><br><span class="line">        return curpos</span><br><span class="line">    except FileNotFoundError:</span><br><span class="line">        curpos = 0</span><br><span class="line">        return curpos</span><br><span class="line">    else:</span><br><span class="line">        try:</span><br><span class="line">            curpos = int(cf.readline().strip())</span><br><span class="line">        except ValueError:</span><br><span class="line">            curpos = 0</span><br><span class="line">            cf.close()</span><br><span class="line">            return curpos</span><br><span class="line">        cf.close()</span><br><span class="line">    return curpos</span><br><span class="line"></span><br><span class="line">def lastPos(filename):</span><br><span class="line">    with open(filename) as lfile:</span><br><span class="line">        if lfile.readline():</span><br><span class="line">            lfile.seek(0,2)</span><br><span class="line">        else:</span><br><span class="line">            return 0</span><br><span class="line">        lastPos = lfile.tell()</span><br><span class="line">    return lastPos</span><br><span class="line"></span><br><span class="line">def getSeekFile():</span><br><span class="line">    try:</span><br><span class="line">        seekfile = sys.argv[2]</span><br><span class="line">    except IndexError:</span><br><span class="line">        seekfile = &apos;/tmp/logseek&apos;</span><br><span class="line">    return seekfile</span><br><span class="line"></span><br><span class="line">def getKey():</span><br><span class="line">    try:</span><br><span class="line">        tagKey = str(sys.argv[3])</span><br><span class="line">    except IndexError:</span><br><span class="line">        tagKey = &apos;Error&apos;</span><br><span class="line">    return tagKey</span><br><span class="line"></span><br><span class="line">def getResult(filename,seekfile,tagkey):</span><br><span class="line">    destPos = prePos(seekfile)</span><br><span class="line">    curPos = lastPos(filename)</span><br><span class="line"></span><br><span class="line">    if curPos &lt; destPos:</span><br><span class="line">        curpos = 0</span><br><span class="line"></span><br><span class="line">    try:</span><br><span class="line">        f = open(filename)</span><br><span class="line">    except IOError:</span><br><span class="line">        print(&apos;Could not open file: %s&apos; % filename)</span><br><span class="line">    except FileNotFoundError:</span><br><span class="line">        print(&apos;Could not open file: %s&apos; % filename)</span><br><span class="line">    else:</span><br><span class="line">        f.seek(destPos)</span><br><span class="line"></span><br><span class="line">        while curPos != 0 and f.tell() &lt; curPos:</span><br><span class="line">            rresult = f.readline().strip()</span><br><span class="line">            global result</span><br><span class="line">            if re.search(tagkey, rresult):</span><br><span class="line">                result = 1</span><br><span class="line">                break</span><br><span class="line">            else:</span><br><span class="line">                result = 0</span><br><span class="line"></span><br><span class="line">        with open(seekfile,&apos;w&apos;) as sf:</span><br><span class="line">            sf.write(str(curPos))</span><br><span class="line">    finally:</span><br><span class="line">        f.close()</span><br><span class="line">    return result</span><br><span class="line"></span><br><span class="line">if __name__ == &quot;__main__&quot;:</span><br><span class="line">    result = 0</span><br><span class="line">    curpos = 0</span><br><span class="line">    tagkey = getKey()</span><br><span class="line">    seekfile = getSeekFile()</span><br><span class="line">    result = getResult(sys.argv[1],seekfile,tagkey)</span><br><span class="line">    print(result)</span><br><span class="line"></span><br><span class="line">chmod +x /scripts/log.py</span><br><span class="line">chown zabbix.zabbix log.py</span><br></pre></td></tr></table></figure>

<ul>
<li>修改客户端/usr/locla/etc/zabbix_agentd.conf文件</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">UnsafeUserParameters=1</span><br><span class="line">UserParameter=cklog[*],/usr/bin/python /scripts/log.py $1 $2 $3</span><br></pre></td></tr></table></figure>

<ul>
<li>创建日志文件（有，则不需要创建），创建存放读取记录的目录并设置属主和属组为zabbix</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;&gt; /tmp/zabbix_agentd.log &lt;&lt; EOF</span><br><span class="line">sklfs</span><br><span class="line">sfkfnkslf</span><br><span class="line">error</span><br><span class="line">errorksdm</span><br><span class="line">Error</span><br><span class="line">failed</span><br><span class="line">failed</span><br><span class="line">whs</span><br><span class="line">itwhs</span><br><span class="line">qwszc</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<ul>
<li>重新启动服务</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pkill zabbix</span><br><span class="line">zabbix_agentd</span><br></pre></td></tr></table></figure>

<ul>
<li>在服务端手动执行脚本</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">zabbix_get -s 192.168.161.67 -k cklog[/tmp/zabbix_agentd.log,/tmp/itwhs,failed]</span><br><span class="line">1</span><br></pre></td></tr></table></figure>

<ul>
<li>添加主机监控项</li>
</ul>
<p><img src="../../img/2019-05-24_114655.png" alt></p>
<ul>
<li>给监控项添加触发器</li>
</ul>
<p><img src="../../img/2019-05-24_115026.png" alt></p>
<ul>
<li>添加报警媒(介参考“Zabbix监控组件及流程”一章)</li>
<li>添加用户报警类型(介参考“Zabbix监控组件及流程”一章)</li>
<li>添加动作(介参考“Zabbix监控组件及流程”一章)</li>
</ul>
<p>测试结果:</p>
<p><img src="../../img/2019-05-24_114150.png" alt></p>
<p><img src="../../img/Screenshot_20190524-114340__01.jpg" alt></p>

          
        
      
    </div>

    

    

    
    
    

    

    
      
    
    

    
	
	  <div>
        
      </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://aiwhs.github.io/2018/12/30/部署zabbix监控服务/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="itw">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="itw">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2018/12/30/部署zabbix监控服务/" class="post-title-link" itemprop="url">zabbix部署</a>
              
            
          </h1>
        

        <div class="post-meta">

          
          
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-12-30 08:15:57" itemprop="dateCreated datePublished" datetime="2018-12-30T08:15:57+08:00">2018-12-30</time>
            </span>
          

          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-07-17 19:43:14" itemprop="dateModified" datetime="2019-07-17T19:43:14+08:00">2019-07-17</time>
              </span>
            
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Linux运维/" itemprop="url" rel="index"><span itemprop="name">Linux运维</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          <br>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <a id="more"></a>


<h2 id="1-zabbix介绍"><a href="#1-zabbix介绍" class="headerlink" title="1. zabbix介绍"></a>1. zabbix介绍</h2><p><code>zabbix</code>是一个基于WEB界面的提供分布式系统监视以及网络监视功能的企业级的开源解决方案。</p>
<p><code>zabbix</code>能监视各种网络参数，保证服务器系统的安全运营；并提供灵活的通知机制以让系统管理员快速定位/解决存在的各种问题。</p>
<p><code>zabbix</code>由2部分构成，<code>zabbix server</code>与可选组件<code>zabbix agent</code>。</p>
<p><code>zabbix server</code>可以通过<code>SNMP</code>，<code>zabbix agent</code>，<code>ping</code>，端口监视等方法提供对远程服务器/网络状态的监视，数据收集等功能，它可以运行在Linux，Ubuntu，Solaris，HP-UX，AIX，Free BSD，Open BSD，OS X等平台上。</p>
<p><code>zabbix agent</code>需要安装在被监视的目标服务器上，它主要完成对硬件信息或与操作系统有关的内存，CPU等信息的收集。</p>
<p><code>zabbix server</code>可以单独监视远程服务器的服务状态；同时也可以与<code>zabbix agent</code>配合，可以轮询<code>zabbix agent</code>主动接收监视数据（agent方式），同时还可被动接收<code>zabbix agent</code>发送的数据（trapping方式）。<br>另外<code>zabbix server</code>还支持SNMP (v1,v2)，可以与SNMP软件(例如：net-snmp)等配合使用。</p>
<h2 id="2-什么是zabbix及优缺点（对比cacti和nagios）"><a href="#2-什么是zabbix及优缺点（对比cacti和nagios）" class="headerlink" title="2.什么是zabbix及优缺点（对比cacti和nagios）"></a>2.什么是zabbix及优缺点（对比cacti和nagios）</h2><p>Zabbix能监视各种网络参数，保证服务器系统的安全运营；并提供灵活的通知机制以让系统管理员快速定位/解决存在的各种问题。是一个基于WEB界面的提供分布式系统监视以及网络监视功能的企业级的开源解决方案。</p>
<ul>
<li><p>agent端：主机通过安装agent方式采集数据。</p>
</li>
<li><p>server端：通过收集agent发送的数据，写入数据库（MySQL，ORACLE等），再通过php+apache在web前端展示.</p>
</li>
<li><p>zabbix = cacti + nagios</p>
</li>
<li><p>优点：基于两款工具优点于一身并更强大，实现企业级分布式监控。</p>
</li>
<li><p>缺点：2.2版本带宽占用大但是升级到2.4版本后更节省了带宽资源，其它再无发现。</p>
</li>
</ul>
<h2 id="3-zabbix特点"><a href="#3-zabbix特点" class="headerlink" title="3. zabbix特点"></a>3. zabbix特点</h2><p>zabbix的主要特点：</p>
<ul>
<li>安装与配置简单，学习成本低</li>
<li>支持多语言（包括中文）</li>
<li>免费开源</li>
<li>自动发现服务器与网络设备</li>
<li>分布式监视以及WEB集中管理功能</li>
<li>可以无agent监视</li>
<li>用户安全认证和柔软的授权方式</li>
<li>通过WEB界面设置或查看监视结果</li>
<li>email等通知功能</li>
</ul>
<p>Zabbix主要功能：</p>
<ul>
<li>CPU负荷</li>
<li>内存使用</li>
<li>磁盘使用</li>
<li>网络状况</li>
<li>端口监视</li>
<li>日志监视</li>
</ul>
<h2 id="4-工作原理"><a href="#4-工作原理" class="headerlink" title="4.工作原理"></a>4.工作原理</h2><p>一个监控系统运行的大概的流程是这样的：</p>
<p>zabbix agent需要安装到被监控的主机上，它负责定期收集各项数据，并发送到zabbix server端，zabbix server将数据存储到数据库中，zabbix web根据数据在前端进行展现和绘图。这里agent收集数据分为主动和被动两种模式：</p>
<p>主动：agent请求server获取主动的监控项列表，并主动将监控项内需要检测的数据提交给server/proxy</p>
<p>被动：server向agent请求获取监控项的数据，agent返回数据。</p>
<h3 id="5-zabbix的组件及进程"><a href="#5-zabbix的组件及进程" class="headerlink" title="5.zabbix的组件及进程"></a>5.zabbix的组件及进程</h3><h4 id="1：重要组件"><a href="#1：重要组件" class="headerlink" title="1：重要组件"></a>1：重要组件</h4><p>zabbix由以下几个组件部分构成：</p>
<ol>
<li>Zabbix Server：负责接收agent发送的报告信息的核心组件，所有配置，统计数据及操作数据均由其组织进行；</li>
<li>Database Storage：专用于存储所有配置信息，以及由zabbix收集的数据；</li>
<li>Web interface：zabbix的GUI接口，通常与Server运行在同一台主机上；</li>
<li>Proxy：可选组件，常用于分布监控环境中，代理Server收集部分被监控端的监控数据并统一发往Server端；</li>
<li>Agent：部署在被监控主机上，负责收集本地数据并发往Server端或Proxy端；</li>
</ol>
<p>注：zabbix node也是 zabbix server的一种 。</p>
<h4 id="2：常见进程"><a href="#2：常见进程" class="headerlink" title="2：常见进程"></a>2：常见进程</h4><p>默认情况下zabbix包含5个程序：zabbix_agentd、zabbix_get、zabbix_proxy、zabbix_sender、zabbix_server，另外一个zabbix_java_gateway是可选，这个需要另外安装。下面来分别介绍下他们各自的作用。</p>
<h5 id="（1）zabbix-agentd："><a href="#（1）zabbix-agentd：" class="headerlink" title="（1）zabbix_agentd："></a>（1）zabbix_agentd：</h5><p>客户端守护进程，此进程收集客户端数据，例如cpu负载、内存、硬盘使用情况等。</p>
<h5 id="（2）zabbix-get"><a href="#（2）zabbix-get" class="headerlink" title="（2）zabbix_get"></a>（2）zabbix_get</h5><p>zabbix工具，单独使用的命令，通常在server或者proxy端执行获取远程客户端信息的命令。通常用户排错。例如在server端获取不到客户端的内存数据，我们可以使用zabbix_get获取客户端的内容的方式来做故障排查。</p>
<h5 id="（3）zabbix-sender"><a href="#（3）zabbix-sender" class="headerlink" title="（3）zabbix_sender"></a>（3）zabbix_sender</h5><p>zabbix工具，用于发送数据给server或者proxy，通常用于耗时比较长的检查。很多检查非常耗时间，导致zabbix超时。于是我们在脚本执行完毕之后，使用sender主动提交数据。</p>
<h5 id="（4）zabbix-server"><a href="#（4）zabbix-server" class="headerlink" title="（4）zabbix_server"></a>（4）zabbix_server</h5><p>zabbix服务端守护进程。zabbix_agentd、zabbix_get、zabbix_sender、zabbix_proxy、zabbix_java_gateway的数据最终都是提交到server</p>
<p>备注：当然不是数据都是主动提交给zabbix_server,也有的是server主动去取数据。</p>
<h5 id="（5）zabbix-proxy"><a href="#（5）zabbix-proxy" class="headerlink" title="（5）zabbix_proxy"></a>（5）zabbix_proxy</h5><p>zabbix代理守护进程。功能类似server，唯一不同的是它只是一个中转站，它需要把收集到的数据提交/被提交到server里。为什么要用代理？代理是做什么的？卖个关子，请继续关注运维生存时间zabbix教程系列。</p>
<h5 id="（6）zabbix-java-gateway"><a href="#（6）zabbix-java-gateway" class="headerlink" title="（6）zabbix_java_gateway"></a>（6）zabbix_java_gateway</h5><p>zabbix2.0之后引入的一个功能。顾名思义：Java网关，类似agentd，但是只用于Java方面。需要特别注意的是，它只能主动去获取数据，而不能被动获取数据。它的数据最终会给到server或者proxy。</p>
<h2 id="6-zabbix监控环境中基本概念"><a href="#6-zabbix监控环境中基本概念" class="headerlink" title="6.zabbix监控环境中基本概念"></a>6.zabbix监控环境中基本概念</h2><ol>
<li>主机（host）：要监控的网络设备，可由IP或DNS名称指定；</li>
<li>主机组（host group）：主机的逻辑容器，可以包含主机和模板，但同一个组织内的主机和模板不能互相链接；主机组通常在给用户或用户组指派监控权限时使用；</li>
<li>监控项（item）：一个特定监控指标的相关的数据；这些数据来自于被监控对象；item是zabbix进行数据收集的核心，相对某个监控对象，每个item都由”key”标识；</li>
<li>触发器（trigger）：一个表达式，用于评估某监控对象的特定item内接收到的数据是否在合理范围内，也就是阈值；接收的数据量大于阈值时，触发器状态将从”OK”转变为”Problem”，当数据再次恢复到合理范围，又转变为”OK”；</li>
<li>事件（event）：触发一个值得关注的事情，比如触发器状态转变，新的agent或重新上线的agent的自动注册等；</li>
<li>动作（action）：指对于特定事件事先定义的处理方法，如发送通知，何时执行操作；</li>
<li>报警升级（escalation）：发送警报或者执行远程命令的自定义方案，如每隔5分钟发送一次警报，共发送5次等；</li>
<li>媒介（media）：发送通知的手段或者通道，如Email、Jabber或者SMS等；</li>
<li>通知（notification）：通过选定的媒介向用户发送的有关某事件的信息；</li>
<li>远程命令（remote command）：预定义的命令，可在被监控主机处于某特定条件下时自动执行；</li>
<li>模板（template）：用于快速定义被监控主机的预设条目集合，通常包含了item、trigger、graph、screen、appication以及low-level discovery rule；模板可以直接链接至某个主机；</li>
<li>应用（application）：一组item的集合；</li>
<li>web场景（web scennario）：用于检测web站点可用性的一个活多个HTTP请求；</li>
<li>前端（frontend）：Zabbix的web接口；</li>
</ol>
<h2 id="7-zabbix的监控架构"><a href="#7-zabbix的监控架构" class="headerlink" title="7.zabbix的监控架构"></a>7.zabbix的监控架构</h2><p>在实际监控架构中，zabbix根据网络环境、监控规模等 分了三种架构： server-client 、master-node-client、server-proxy-client三种 。</p>
<h4 id="1：server-client架构"><a href="#1：server-client架构" class="headerlink" title="1：server-client架构"></a>1：server-client架构</h4><p>也是zabbix的最简单的架构，监控机和被监控机之间不经过任何代理 ，直接由zabbix server和zabbix agentd之间进行数据交互。适用于网络比较简单，设备比较少的监控环境 。</p>
<h4 id="2：server-proxy-client架构"><a href="#2：server-proxy-client架构" class="headerlink" title="2：server-proxy-client架构"></a>2：server-proxy-client架构</h4><p>其中proxy是server、client之间沟通的一个桥梁，proxy本身没有前端，而且其本身并不存放数据，只是将agentd发来的数据暂时存放，而后再提交给server 。该架构经常是和master-node-client架构做比较的架构 ，一般适用于跨机房、跨网络的中型网络架构的监控。</p>
<h4 id="3：master-node-client架构"><a href="#3：master-node-client架构" class="headerlink" title="3：master-node-client架构"></a>3：master-node-client架构</h4><p>该架构是zabbix最复杂的监控架构，适用于跨网络、跨机房、设备较多的大型环境 。每个node同时也是一个server端，node下面可以接proxy，也可以直接接client 。node有自已的配置文件和数据库，其要做的是将配置信息和监控数据向master同步，master的故障或损坏对node其下架构的完整性。</p>
<p>其实zabbix做的还是挺人性化的，给了我们下载地址：<a href="http://repo.zabbix.com/" target="_blank" rel="noopener">http://repo.zabbix.com/</a> 里面可以选很多版本，但这里就给大家提供一个目前最新版本4.2的部署及添加客户端方式。</p>
<h2 id="8-zabbix配置文件"><a href="#8-zabbix配置文件" class="headerlink" title="8. zabbix配置文件"></a>8. zabbix配置文件</h2><p>zabbix配置文件有两种：</p>
<ul>
<li>服务器端配置文件(/usr/local/etc/zabbix_server.conf)</li>
<li>客户端配置文件(/usr/local/etc/zabbix_agentd.conf)</li>
<li>zabbix代理配置文件(/usr/local/etc/zabbix_proxy.conf)</li>
</ul>
<p><strong>服务器端配置文件zabbix_server.conf常用配置参数：</strong></p>
<table>
<thead>
<tr>
<th align="left">参数</th>
<th align="left">作用</th>
</tr>
</thead>
<tbody><tr>
<td align="left">LogFile</td>
<td align="left">设置服务端日志文件存放路径</td>
</tr>
<tr>
<td align="left">ListenIP</td>
<td align="left">设置服务端监听IP</td>
</tr>
<tr>
<td align="left">ListenPort</td>
<td align="left">设置服务端监听的端口号</td>
</tr>
<tr>
<td align="left">PidFile</td>
<td align="left">设置服务端进程号文件存放路径</td>
</tr>
<tr>
<td align="left">DBHost</td>
<td align="left">指定zabbix的数据库服务器IP</td>
</tr>
<tr>
<td align="left">DBName</td>
<td align="left">指定zabbix使用的数据库库名</td>
</tr>
<tr>
<td align="left">DBUser</td>
<td align="left">指定zabbix数据库登录用户</td>
</tr>
<tr>
<td align="left">DBPassword</td>
<td align="left">指定zabbix数据库登录密码</td>
</tr>
<tr>
<td align="left">DBPort</td>
<td align="left">指定zabbix数据库端口号</td>
</tr>
<tr>
<td align="left">User</td>
<td align="left">设置zabbix以什么用户的身份运行</td>
</tr>
<tr>
<td align="left">AlertScriptsPath</td>
<td align="left">设置告警脚本存放路径</td>
</tr>
<tr>
<td align="left">ExternalScripts</td>
<td align="left">外部脚本存放路径</td>
</tr>
</tbody></table>
<p><strong>客户端配置文件zabbix_agentd.conf常用配置参数：</strong></p>
<p>如果是默认值，可以不用声明，即不要删除注释，需要更改特殊值时才修改，下面为了讲解，每个选项基本都取消注释了，但是有注明默认值是多少的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">LogFile=/usr/local/zabbix/log/zabbix_agentd.log    #日志</span><br><span class="line"></span><br><span class="line">Server=10.10.88.20    # zabbix server IP，此种表示被动监听。可以有多个IP，以逗号分隔，如 Server=123.56.178.128,192.168.0.41</span><br><span class="line"></span><br><span class="line">ListenPort=10050    # agent 监听端口。默认也是10050</span><br><span class="line"></span><br><span class="line">ListenIP=0.0.0.0    # agent监听的网络接口。0.0.0.0表示监听所有IP</span><br><span class="line"></span><br><span class="line">StartAgents=3    #处理被动检查的预启动的zabbix_agent进程。默认值为3</span><br><span class="line"></span><br><span class="line">ServerActive=10.10.88.20:10051    #主动模式。主动检查zabbix server的端口，如果没有指明端口，则默认为10051</span><br><span class="line"></span><br><span class="line">Hostname=slave2    # 该项需要主动检查，并且必须与服务器上服务器上配置的主机名一致。如果未定义，则从HostnameItem获取值。</span><br><span class="line"> How often list of active checks is refreshed, in seconds.</span><br><span class="line"></span><br><span class="line">RefreshActiveChecks=120    # 主动模式下，agent主动检查监控项的刷新频率（隔多久从server获取一次item），单位s，默认120s</span><br><span class="line"></span><br><span class="line">BufferSend=5    #数据在缓冲区的保留时间。默认只保留5秒</span><br><span class="line"></span><br><span class="line">BufferSize=100    #内存缓冲区中的最大值。 如果缓冲区已满，代理将发送所有收集的数据到Zabbix Server或Proxy。默认值为100</span><br><span class="line"></span><br><span class="line">Timeout=30    # 处理超时时间。默认30秒为超时</span><br><span class="line"></span><br><span class="line">AllowRoot=0    # 是否允许agent以 root用户运行。0表示不允许，1表示允许，默认值为0</span><br><span class="line"></span><br><span class="line">User=zabbix    #</span><br><span class="line"></span><br><span class="line">Include=xxx    # 包含的配置文件，默认没有值。如Include=/usr/local/etc/zabbix_agentd.conf.d/*.conf</span><br><span class="line"></span><br><span class="line">UserParameter=xxx    # 用户自定义监控项，即自定义key。如</span><br></pre></td></tr></table></figure>

<h2 id="9-部署zabbix"><a href="#9-部署zabbix" class="headerlink" title="9. 部署zabbix"></a>9. 部署zabbix</h2><p><strong>环境说明：</strong></p>
<table>
<thead>
<tr>
<th align="left">环境</th>
<th align="left">IP</th>
<th align="left">要安装的应用</th>
</tr>
</thead>
<tbody><tr>
<td align="left">服务器</td>
<td align="left">192.168.161.130</td>
<td align="left">lamp架构 <br>zabbix server<br> zabbix agent</td>
</tr>
<tr>
<td align="left">客户端</td>
<td align="left">192.168.161.167</td>
<td align="left">zabbix agent</td>
</tr>
</tbody></table>
<p><strong>因为zabbix是用php语言开发的，所以必须先部署lamp架构，使其能够支持运行php网页</strong></p>
<h3 id="9-1-zabbix服务端安装"><a href="#9-1-zabbix服务端安装" class="headerlink" title="9.1 zabbix服务端安装"></a>9.1 zabbix服务端安装</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">安装依赖包</span><br><span class="line">[root@localhost ~]# yum -y install net-snmp-devel libevent-devel libxml2-devel curl-devel pcre*</span><br><span class="line"></span><br><span class="line">下载zabbix</span><br><span class="line">[root@localhost ~]# cd /usr/src/</span><br><span class="line">[root@localhost src]# wget https://nchc.dl.sourceforge.net/project/zabbix/ZABBIX%20Latest%20Stable/4.2.1/zabbix-4.2.1.tar.gz</span><br><span class="line">--2019-05-16 14:25:00--  https://nchc.dl.sourceforge.net/project/zabbix/ZABBIX%20Latest%20Stable/4.2.1/zabbix-4.2.1.tar.gz</span><br><span class="line">正在解析主机 nchc.dl.sourceforge.net (nchc.dl.sourceforge.net)... 211.79.60.17, 2001:e10:ffff:1f02::17</span><br><span class="line">正在连接 nchc.dl.sourceforge.net (nchc.dl.sourceforge.net)|211.79.60.17|:443... 已连接。</span><br><span class="line">已发出 HTTP 请求，正在等待回应... 200 OK</span><br><span class="line">长度：18284589 (17M) [application/x-gzip]</span><br><span class="line">正在保存至: “zabbix-4.2.1.tar.gz”</span><br><span class="line">    [                         &lt;=&gt;               ] 16,789,873   327KB/s 用时 57s    </span><br><span class="line">2019-05-16 13:45:44 (287 KB/s) - “zabbix-4.2.1.tar.gz” 已保存 [16789873]</span><br><span class="line"></span><br><span class="line">解压</span><br><span class="line">[root@localhost src]# tar xf zabbix-4.2.1.tar.gz</span><br><span class="line"></span><br><span class="line">创建zabbix用户和组</span><br><span class="line">[root@localhost ~]# groupadd -r zabbix</span><br><span class="line">[root@localhost ~]# useradd -r -g zabbix -M -s /sbin/nologin zabbix</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">配置zabbix数据库</span><br><span class="line">[root@localhost ~]# mysql -uroot -pjbgsn123!</span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 2</span><br><span class="line">Server version: 5.7.22 MySQL Community Server (GPL)</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2018, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type &apos;help;&apos; or &apos;\h&apos; for help. Type &apos;\c&apos; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">mysql&gt; create database zabbix character set utf8 collate utf8_bin;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; grant all privileges on zabbix.* to zabbix@localhost identified by &apos;zabbix123!&apos;;</span><br><span class="line">Query OK, 0 rows affected, 2 warnings (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; flush privileges;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; exit</span><br><span class="line">Bye</span><br><span class="line">[root@localhost ~]# cd /usr/src/zabbix-4.2.1/database/mysql/</span><br><span class="line">[root@localhost mysql]# ls</span><br><span class="line">data.sql  images.sql  Makefile.am  Makefile.in  schema.sql</span><br><span class="line">[root@localhost mysql]# mysql -uzabbix -pzabbix123! zabbix &lt; schema.sql</span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">[root@localhost mysql]# mysql -uzabbix -pzabbix123! zabbix &lt; images.sql</span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">[root@localhost mysql]# mysql -uzabbix -pzabbix123! zabbix &lt; data.sql</span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">编译安装zabbix</span><br><span class="line">[root@localhost ~]# cd /usr/src/zabbix-4.2.1    </span><br><span class="line">[root@localhost zabbix-4.2.1]# ./configure --enable-server --enable-agent --with-mysql --with-net-snmp --with-libcurl --with-libxml2</span><br><span class="line"></span><br><span class="line">[root@localhost zabbix-4.2.1]# make install</span><br></pre></td></tr></table></figure>

<h3 id="9-2-zabbix服务端配置"><a href="#9-2-zabbix服务端配置" class="headerlink" title="9.2 zabbix服务端配置"></a>9.2 zabbix服务端配置</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# ls /usr/local/etc/</span><br><span class="line">zabbix_agentd.conf  zabbix_agentd.conf.d  zabbix_server.conf  zabbix_server.conf.d</span><br><span class="line"></span><br><span class="line">修改服务端配置文件</span><br><span class="line">设置数据库信息</span><br><span class="line">[root@localhost ~]# vim /usr/local/etc/zabbix_server.conf</span><br><span class="line">....</span><br><span class="line">DBPassword=zabbix123!       //设置zabbix数据库连接密码</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">启动zabbix_server和zabbix_agentd</span><br><span class="line">[root@localhost ~]# zabbix_server</span><br><span class="line">[root@localhost ~]# zabbix_agentd</span><br><span class="line">[root@localhost ~]# ss -antl</span><br><span class="line">State       Recv-Q Send-Q Local Address:Port               Peer Address:Port              </span><br><span class="line">LISTEN      0      128     127.0.0.1:9000                        *:*                  </span><br><span class="line">LISTEN      0      128             *:22                          *:*                  </span><br><span class="line">LISTEN      0      100     127.0.0.1:25                          *:*                  </span><br><span class="line">LISTEN      0      128             *:10050                       *:*                  </span><br><span class="line">LISTEN      0      128             *:10051                       *:*                  </span><br><span class="line">LISTEN      0      80             :::3306                       :::*                  </span><br><span class="line">LISTEN      0      128            :::80                         :::*                  </span><br><span class="line">LISTEN      0      128            :::22                         :::*                  </span><br><span class="line">LISTEN      0      100           ::1:25                         :::*</span><br></pre></td></tr></table></figure>

<h3 id="9-3-zabbix服务端web界面安装与配置"><a href="#9-3-zabbix服务端web界面安装与配置" class="headerlink" title="9.3 zabbix服务端web界面安装与配置"></a>9.3 zabbix服务端web界面安装与配置</h3><h4 id="9-3-1-zabbix-web界面安装前配置"><a href="#9-3-1-zabbix-web界面安装前配置" class="headerlink" title="9.3.1 zabbix web界面安装前配置"></a>9.3.1 zabbix web界面安装前配置</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">修改/etc/php.ini的配置并重启php-fpm</span><br><span class="line">[root@localhost ~]# sed -ri &apos;s/(post_max_size =).*/\1 16M/g&apos; /etc/php.ini</span><br><span class="line">[root@localhost ~]# sed -ri &apos;s/(max_execution_time =).*/\1 300/g&apos; /etc/php.ini</span><br><span class="line">[root@localhost ~]# sed -ri &apos;s/(max_input_time =).*/\1 300/g&apos; /etc/php.ini</span><br><span class="line">[root@localhost ~]# sed -i &apos;/;date.timezone/a date.timezone = Asia/Shanghai&apos; /etc/php.ini</span><br><span class="line">[root@localhost ~]# service php-fpm restart</span><br><span class="line">Gracefully shutting down php-fpm . done</span><br><span class="line">Starting php-fpm  done</span><br><span class="line"></span><br><span class="line">[root@localhost ~]# cd /usr/src/zabbix-4.2.1</span><br><span class="line">[root@localhost zabbix-4.2.1]# ls</span><br><span class="line">aclocal.m4  compile        config.sub    depcomp     m4           misc     src</span><br><span class="line">AUTHORS     conf           configure     frontends   Makefile     missing</span><br><span class="line">bin         config.guess   configure.ac  include     Makefile.am  NEWS</span><br><span class="line">build       config.log     COPYING       INSTALL     Makefile.in  README</span><br><span class="line">ChangeLog   config.status  database      install-sh  man          sass</span><br><span class="line">[root@localhost zabbix-4.2.1]# mkdir /usr/local/apache/htdocs/zabbix</span><br><span class="line">[root@localhost zabbix-4.2.1]# cp -a frontends/php/* /usr/local/apache/htdocs/zabbix/</span><br><span class="line">[root@localhost zabbix-4.2.1]# groupadd -r apache</span><br><span class="line">[root@localhost zabbix-4.2.1]# useradd -r -g apache -M -s /sbin/nologin apache</span><br><span class="line">[root@localhost zabbix-4.2.1]# chown -R apache.apache /usr/local/apache/htdocs</span><br><span class="line"></span><br><span class="line">配置apache虚拟主机</span><br><span class="line">[root@localhost ~]# vim /etc/httpd/httpd.conf</span><br><span class="line">在配置文件的末尾加如下内容</span><br><span class="line">ServerName zabbix.wenhs.com:80</span><br><span class="line">&lt;VirtualHost *:80&gt;</span><br><span class="line">    DocumentRoot &quot;/usr/local/apache/htdocs/zabbix&quot;</span><br><span class="line">    ServerName zabbix.wenhs.com</span><br><span class="line">    ProxyRequests Off</span><br><span class="line">    ProxyPassMatch ^/(.*\.php)$ fcgi://127.0.0.1:9000/usr/local/apache/htdocs/zabbix/$1</span><br><span class="line">    &lt;Directory &quot;/usr/local/apache/htdocs/zabbix&quot;&gt;</span><br><span class="line">        Options none</span><br><span class="line">        AllowOverride none</span><br><span class="line">        Require all granted</span><br><span class="line">    &lt;/Directory&gt;</span><br><span class="line">&lt;/VirtualHost&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">设置zabbix/conf目录的权限，让zabbix有权限生成配置文件zabbix.conf.php</span><br><span class="line">[root@localhost ~]# chmod 777 /usr/local/apache/htdocs/zabbix/conf</span><br><span class="line">[root@localhost ~]# ll -d /usr/local/apache/htdocs/zabbix/conf</span><br><span class="line">drwxrwsrwx 2 apache apache 81 4月  18 17:26 /usr/local/apache/htdocs/zabbix/conf</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">重启apache</span><br><span class="line">[root@localhost ~]# apachectl -t</span><br><span class="line">Syntax OK</span><br><span class="line">[root@localhost ~]# apachectl stop</span><br><span class="line">[root@localhost ~]# apachectl start</span><br><span class="line">[root@localhost ~]# ss -antl</span><br><span class="line">State       Recv-Q Send-Q Local Address:Port               Peer Address:Port              </span><br><span class="line">LISTEN      0      128     127.0.0.1:9000                        *:*                  </span><br><span class="line">LISTEN      0      128             *:22                          *:*                  </span><br><span class="line">LISTEN      0      100     127.0.0.1:25                          *:*                  </span><br><span class="line">LISTEN      0      128             *:10050                       *:*                  </span><br><span class="line">LISTEN      0      128             *:10051                       *:*                  </span><br><span class="line">LISTEN      0      80             :::3306                       :::*                  </span><br><span class="line">LISTEN      0      128            :::80                         :::*                  </span><br><span class="line">LISTEN      0      128            :::22                         :::*                  </span><br><span class="line">LISTEN      0      100           ::1:25                         :::*</span><br></pre></td></tr></table></figure>

<h4 id="9-3-2-安装zabbix-web界面"><a href="#9-3-2-安装zabbix-web界面" class="headerlink" title="9.3.2 安装zabbix web界面"></a>9.3.2 安装zabbix web界面</h4><ul>
<li>修改/etc/hosts文件，添加域名与IP的映射</li>
<li>在浏览器上访问域名，本文设置的域名为zabbix.wenhs.com，你需要修改成你自己的域名</li>
<li>恢复zabbix/conf目录的权限为755</li>
</ul>
<p>在浏览器上访问域名进行安装：</p>
<p><img src="../../img/1557990954228.png" alt="img1"></p>
<p><img src="../../img/1557991001839.png" alt="img2"></p>
<p><img src="../../img/1557991134277.png" alt="img3"></p>
<p><img src="../../img/1557991230631.png" alt="img4"></p>
<p><img src="../../img/1557991264039.png" alt="img5"></p>
<p><img src="../../img/1557991290886.png" alt="img6"></p>
<p><img src="../../img/1557991341715.png" alt="img6"></p>
<p>恢复zabbix/conf目录的权限为755：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# chmod 755 /usr/local/apache/htdocs/zabbix/conf</span><br><span class="line">[root@localhost ~]# ll -d /usr/local/apache/htdocs/zabbix/conf</span><br><span class="line">drwxr-sr-x 2 apache apache 104 5月  16 15:21 /usr/local/apache/htdocs/zabbix/conf</span><br></pre></td></tr></table></figure>

<h3 id="9-4-登录zabbix"><a href="#9-4-登录zabbix" class="headerlink" title="9.4 登录zabbix"></a>9.4 登录zabbix</h3><p><strong>zabbix默认登录用户名和密码：</strong></p>
<table>
<thead>
<tr>
<th align="left">用户名</th>
<th align="left">密码</th>
</tr>
</thead>
<tbody><tr>
<td align="left">Admin</td>
<td align="left">zabbix</td>
</tr>
</tbody></table>
<h2 id="10-汉化zabbix"><a href="#10-汉化zabbix" class="headerlink" title="10.汉化zabbix"></a>10.汉化zabbix</h2><h5 id="zabbix-自带多种语言包，也包括中文。登陆zabbix-web控制台默认是英文，可切换中文版本"><a href="#zabbix-自带多种语言包，也包括中文。登陆zabbix-web控制台默认是英文，可切换中文版本" class="headerlink" title="zabbix 自带多种语言包，也包括中文。登陆zabbix web控制台默认是英文，可切换中文版本"></a>zabbix 自带多种语言包，也包括中文。登陆zabbix web控制台默认是英文，可切换中文版本</h5><p>1.默认登陆界面(英文版)</p>
<p><img src="../../img/1557991450914.png" alt="img7"></p>
<p>  点击右上角小人图标,切换语言</p>
<p><img src="../../img/1557991583049.png" alt="img8"></p>
<p>  汉化后界面如下</p>
<p><img src="../../img/1557992321097.png" alt="img9"></p>
<h5 id="解决中文乱码"><a href="#解决中文乱码" class="headerlink" title="解决中文乱码"></a>解决中文乱码</h5><p>  上传本地字体</p>
<p>  找到本地C:\Windows\Fonts\STXINWEI.TTF(华文新魏)上传到/usr/share/zabbix/fonts</p>
<p><img src="../../img/1557984849451.png" alt="img10"></p>
<p> 重命名字体名称</p>
<p> 将zabbix服务器正在使用字体备份</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# mv /usr/local/apache/htdocs/zabbix/fonts/DejaVuSans.ttf&#123;,.bak&#125;</span><br><span class="line"> 将刚刚上传的字体替换</span><br><span class="line"></span><br><span class="line">$ scp STXINWEI.TTF root@192.168.161.130:/usr/local/apache/htdocs/zabbix/fo nts/DejaVuSans.ttf                                                         root@192.168.161.130&apos;s password:                                           STXINWEI.TTF                             100% 3956KB   1.3MB/s   00:03</span><br></pre></td></tr></table></figure>

<p>再次查看界面</p>
<p><img src="../../img/1557992833068.png" alt="img11"></p>
<h2 id="11-客户端配置"><a href="#11-客户端配置" class="headerlink" title="11.客户端配置"></a>11.客户端配置</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">安装依赖包</span><br><span class="line">[root@wenhs5479 ~]# yum -y install net-snmp-devel libevent-devel libxml2-devel curl-devel pcre*</span><br><span class="line"></span><br><span class="line">下载zabbix</span><br><span class="line">[root@wenhs5479 ~]# cd /usr/src/</span><br><span class="line">[root@wenhs5479 src]# scp 192.168.161.130:/usr/src/zabbix-4.2.1.tar.gz .</span><br><span class="line">root@192.168.161.130&apos;s password: </span><br><span class="line">zabbix-4.2.1.tar.gz                               100%   17MB  61.7MB/s   00:00    </span><br><span class="line">[root@wenhs5479 src]# tar xf zabbix-4.2.1.tar.gz</span><br><span class="line"></span><br><span class="line">创建zabbix用户和组</span><br><span class="line">[root@wenhs5479 ~]# groupadd -r zabbix</span><br><span class="line">[root@wenhs5479 ~]# useradd -r -g zabbix -M -s /sbin/nologin zabbix</span><br><span class="line"></span><br><span class="line">编译安装zabbix</span><br><span class="line">[root@wenhs5479 ~]# cd /usr/src/zabbix-4.2.1    </span><br><span class="line">[root@wenhs5479 zabbix-4.2.1]# ./configure --enable-agent</span><br><span class="line">[root@wenhs5479 zabbix-4.2.1]# make install</span><br><span class="line">[root@wenhs5479 zabbix-4.2.1]# ls /usr/local/etc/</span><br><span class="line">zabbix_agentd.conf  zabbix_agentd.conf.d </span><br><span class="line"></span><br><span class="line">修改服务端配置文件</span><br><span class="line">设置数据库信息</span><br><span class="line">[root@wenhs5479 zabbix-4.2.1]# vim /usr/local/etc/zabbix_agentd.conf</span><br><span class="line">Server=192.168.161.130</span><br><span class="line">ServerActive=192.168.161.130</span><br><span class="line">Hostname=167</span><br><span class="line">启动zabbix_agentd</span><br><span class="line">[root@wenhs5479 zabbix-4.2.1]# zabbix_agentd</span><br><span class="line">[root@wenhs5479 zabbix-4.2.1]# ss -antl</span><br><span class="line">State      Recv-Q Send-Q Local Address:Port               Peer Address:Port              </span><br><span class="line">LISTEN     0      128            *:111                        *:*                  </span><br><span class="line">LISTEN     0      5      192.168.122.1:53                         *:*                  </span><br><span class="line">LISTEN     0      128            *:22                         *:*                  </span><br><span class="line">LISTEN     0      128    127.0.0.1:631                        *:*                  </span><br><span class="line">LISTEN     0      100    127.0.0.1:25                         *:*                  </span><br><span class="line">LISTEN     0      128    127.0.0.1:6010                       *:*                  </span><br><span class="line">LISTEN     0      128            *:10050                      *:*                  </span><br><span class="line">LISTEN     0      128           :::111                       :::*                  </span><br><span class="line">LISTEN     0      128           :::22                        :::*                  </span><br><span class="line">LISTEN     0      128          ::1:631                       :::*                  </span><br><span class="line">LISTEN     0      100          ::1:25                        :::*                  </span><br><span class="line">LISTEN     0      128          ::1:6010                      :::*</span><br></pre></td></tr></table></figure>

<p><img src="../../img/1557994936761.png" alt="img12"></p>
<p><img src="../../img/1557995112055.png" alt="img13"></p>
<p><img src="../../img/1557995259971.png" alt="img14"></p>
<p><img src="../../img/1557996138901.png" alt="img15"></p>

          
        
      
    </div>

    

    

    
    
    

    

    
      
    
    

    
	
	  <div>
        
      </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://aiwhs.github.io/2018/12/29/版本控制GitLab/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="itw">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="itw">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2018/12/29/版本控制GitLab/" class="post-title-link" itemprop="url">Gitlab</a>
              
            
          </h1>
        

        <div class="post-meta">

          
          
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-12-29 08:15:57" itemprop="dateCreated datePublished" datetime="2018-12-29T08:15:57+08:00">2018-12-29</time>
            </span>
          

          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-07-17 19:34:13" itemprop="dateModified" datetime="2019-07-17T19:34:13+08:00">2019-07-17</time>
              </span>
            
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Linux运维/" itemprop="url" rel="index"><span itemprop="name">Linux运维</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          <br>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <a id="more"></a>



<h2 id="1-版本控制介绍"><a href="#1-版本控制介绍" class="headerlink" title="1.版本控制介绍"></a>1.版本控制介绍</h2><p>版本控制是指对软件开发过程中各种程序代码，配置文件及说明文档等文件变更的管理，是软件配置管理的核心思想之一。</p>
<p>版本控制最主要的功能就是追踪文件的变更。它将什么时候，什么人更改了文件的什么内容等信息忠实地了记录下来。每一次文件的改变，文件的版本号都将增加。除了记录版本变更外，版本控制的另一个重要功能是并行开发。软件开发往往是多人协同作业，版本控制可以有效地解决版本的同步以及不同开发者之间的开发通信问题，提高协同开发的效率并行。开发中最常见的不同版本软件的错误（错误）修正问题也可以通过版本控制中分支与合并的方法有效地解决。<br>具体来说，在每一项开发任务中，都需要首先设定开发基线，确定各个配置项的开发初始版本，在开发过程中，开发人员基于开发基线的版本，开发出所需的目标版本。当发生需求变更时，通过对变更的评估，确定变更的影响范围，对被影响的配置项的版本进行修改，根据变更的性质使配置 的版本树继续延伸或产生新的分支，形成新的目标版本，而对于不受变更影响的配置项则不应发产生变动。同时，应能够将变更所产生的对版本的影响进行记录和跟踪。必要时还可以回退到以前的版本。例如当开发需求或需求变更被取消时，就需要有能力将版本回退到开发基线版本。在曾经出现过的季度升级包拆包和重新组包的过程中，其实就是将部分配置项的版本回退到开发基线，将对应不同需求的不同分支重新组合归并，形成新的升级包版本。<br>版本控制是软件配置管理的核心功能。所有置于配置库中的元素都应自动予以版本的标识，并保证版本命名的唯一性。版本在生成过程中，自动依照设定的使用模型自动分支，演进。除了系统自动记录的版本信息以外，为了配合软件开发流程的各个阶段。还需要定义，收集一些元数据来记录版本的辅助信息和规范开发流程，并为今后对软件过程的度量做好准备。当然如果选用的工具支持，这些辅助数据将能直接统计出过程数据，从而方便软件过程改进活动的进行。对于配置库中的各个基线控制项，应该根据其基线的位置和状态来设置相应的访问权限。一般来说，对于基线版本之前的各个版本都应处于被锁定的状态，如需要对它们进行变更，则应按照变更控制的流程来进行操作。</p>
<p>常用的版本控制工具：</p>
<ul>
<li>gitlab</li>
<li>颠覆</li>
</ul>
<h2 id="2-gitlab部署"><a href="#2-gitlab部署" class="headerlink" title="2. gitlab部署"></a>2. gitlab部署</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line">配置yum源</span><br><span class="line">[root@localhost ~]# cd /etc/yum.repos.d/</span><br><span class="line">[root@localhost yum.repos.d]# wget http://mirrors.163.com/.help/CentOS7-Base-163.repo</span><br><span class="line">[root@localhost ~]# sed -i &apos;s/\$releasever/7/g&apos; /etc/yum.repos.d/CentOS7-Base-163.repo</span><br><span class="line">[root@localhost ~]# sed -i &apos;s/^enabled=.*/enabled=1/g&apos; /etc/yum.repos.d/CentOS7-Base-163.repo</span><br><span class="line"></span><br><span class="line">安装git</span><br><span class="line">[root@localhost ~]# yum -y install epel-release git</span><br><span class="line">安装过程略</span><br><span class="line"></span><br><span class="line">安装依赖包</span><br><span class="line">[root@localhost ~]# yum -y install curl openssh-server openssh-clients postfix cronie policycoreutils-python</span><br><span class="line">安装过程略....</span><br><span class="line"></span><br><span class="line">启动postfix服务并设置开机自启</span><br><span class="line">[root@localhost ~]# systemctl restart postfix</span><br><span class="line">[root@localhost ~]# systemctl enable postfix</span><br><span class="line"></span><br><span class="line">下载gitlab的rpm包</span><br><span class="line">[root@localhost ~]# cd /usr/src/</span><br><span class="line">[root@localhost src]# ls</span><br><span class="line">debug  kernels</span><br><span class="line">[root@localhost src]# wget https://mirrors.tuna.tsinghua.edu.cn/gitlab-ce/yum/el7/gitlab-ce-11.2.1-ce.0.el7.x86_64.rpm</span><br><span class="line">......</span><br><span class="line">HTTP request sent, awaiting response... 200 OK</span><br><span class="line">Length: 444944490 (424M) [application/x-redhat-package-manager]</span><br><span class="line">Saving to: ‘gitlab-ce-11.2.1-ce.0.el7.x86_64.rpm’</span><br><span class="line"></span><br><span class="line">[root@localhost src]# ls</span><br><span class="line">debug  gitlab-ce-11.2.1-ce.0.el7.x86_64.rpm  kernels</span><br><span class="line"></span><br><span class="line">安装gitlab</span><br><span class="line">[root@localhost src]# rpm -ivh gitlab-ce-11.2.1-ce.0.el7.x86_64.rpm</span><br><span class="line">warning: gitlab-ce-11.2.1-ce.0.el7.x86_64.rpm: Header V4 RSA/SHA1 Signature, key ID f27eab47: NOKEY</span><br><span class="line">Preparing...                                                            (1################################# [100%]</span><br><span class="line">Updating / installing...</span><br><span class="line">   1:gitlab-ce-11.2.1-ce.0.el7                                          (</span><br><span class="line">################################# [100%]</span><br><span class="line">It looks like GitLab has not been configured yet; skipping the upgrade script.</span><br><span class="line"></span><br><span class="line">       *.                  *.</span><br><span class="line">      ***                 ***</span><br><span class="line">     *****               *****</span><br><span class="line">    .******             *******</span><br><span class="line">    ********            ********</span><br><span class="line">   ,,,,,,,,,***********,,,,,,,,,</span><br><span class="line">  ,,,,,,,,,,,*********,,,,,,,,,,,</span><br><span class="line">  .,,,,,,,,,,,*******,,,,,,,,,,,,</span><br><span class="line">      ,,,,,,,,,*****,,,,,,,,,.</span><br><span class="line">         ,,,,,,,****,,,,,,</span><br><span class="line">            .,,,***,,,,</span><br><span class="line">                ,*,.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">     _______ __  __          __</span><br><span class="line">    / ____(_) /_/ /   ____ _/ /_</span><br><span class="line">   / / __/ / __/ /   / __ `/ __ \</span><br><span class="line">  / /_/ / / /_/ /___/ /_/ / /_/ /</span><br><span class="line">  \____/_/\__/_____/\__,_/_.___/</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Thank you for installing GitLab!</span><br><span class="line">GitLab was unable to detect a valid hostname for your instance.</span><br><span class="line">Please configure a URL for your GitLab instance by setting `external_url`</span><br><span class="line">configuration in /etc/gitlab/gitlab.rb file.</span><br><span class="line">Then, you can start your GitLab instance by running the following command:</span><br><span class="line">  sudo gitlab-ctl reconfigure</span><br><span class="line"></span><br><span class="line">For a comprehensive list of configuration options please see the Omnibus GitLab readme</span><br><span class="line">https://gitlab.com/gitlab-org/omnibus-gitlab/blob/master/README.md</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">修改配置文件</span><br><span class="line">[root@localhost ~]# vim /etc/gitlab/gitlab.rb</span><br><span class="line">......  //此处为省略内容</span><br><span class="line">external_url &apos;http://172.16.137.11&apos;     //将此处设为gitlab的服务器ip地址亦或域名</span><br><span class="line">......  //此处为省略内容</span><br><span class="line"></span><br><span class="line">重载配置文件并重启gitlab</span><br><span class="line">[root@localhost ~]# gitlab-ctl reconfigure</span><br><span class="line">[root@localhost ~]# gitlab-ctl restart</span><br><span class="line">ok: run: alertmanager: (pid 17305) 0s</span><br><span class="line">ok: run: gitaly: (pid 17318) 0s</span><br><span class="line">ok: run: gitlab-monitor: (pid 17331) 0s</span><br><span class="line">ok: run: gitlab-workhorse: (pid 17335) 0s</span><br><span class="line">ok: run: logrotate: (pid 17363) 1s</span><br><span class="line">ok: run: nginx: (pid 17369) 0s</span><br><span class="line">ok: run: node-exporter: (pid 17380) 1s</span><br><span class="line">ok: run: postgres-exporter: (pid 17386) 0s</span><br><span class="line">ok: run: postgresql: (pid 17396) 1s</span><br><span class="line">ok: run: prometheus: (pid 17405) 0s</span><br><span class="line">ok: run: redis: (pid 17420) 0s</span><br><span class="line">ok: run: redis-exporter: (pid 17425) 0s</span><br><span class="line">ok: run: sidekiq: (pid 17510) 0s</span><br><span class="line">ok: run: unicorn: (pid 17523) 0s</span><br><span class="line"></span><br><span class="line">查看当前的gitlab版本</span><br><span class="line">[root@localhost ~]# head -1 /opt/gitlab/version-manifest.txt</span><br><span class="line">gitlab-ce 11.2.1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">设置管理员密码</span><br><span class="line">[root@localhost ~]# gitlab-rails console production</span><br><span class="line">-------------------------------------------------------------------------------------</span><br><span class="line"> GitLab:       11.2.1 (2d6c1c6)</span><br><span class="line"> GitLab Shell: 8.1.1</span><br><span class="line"> postgresql:   9.6.8</span><br><span class="line">-------------------------------------------------------------------------------------</span><br><span class="line">Loading production environment (Rails 4.2.10)</span><br><span class="line">irb(main):001:0&gt; user = User.where(id: 1).first     //id为1的是超级管理员</span><br><span class="line">=&gt; #&lt;User id:1 @root&gt;</span><br><span class="line">irb(main):002:0&gt; user.password = &apos;itwhs123!&apos;     //密码必须至少8个字符</span><br><span class="line">=&gt; &quot;itwhs123!&quot;</span><br><span class="line">irb(main):003:0&gt; user.save!     //保存修改，若无问题将返回true</span><br><span class="line">Enqueued ActionMailer::DeliveryJob (Job ID: 7feb0464-15aa-4151-be94-2e657a65494e) to Sidekiq(mailers) with arguments: &quot;DeviseMailer&quot;, &quot;password_change&quot;, &quot;deliver_now&quot;, gid://gitlab/User/1</span><br><span class="line">=&gt; true</span><br><span class="line">irb(main):004:0&gt; exit   //退出</span><br></pre></td></tr></table></figure>

<h2 id="3-gitlab管理"><a href="#3-gitlab管理" class="headerlink" title="3. gitlab管理"></a>3. gitlab管理</h2><p>在浏览器中使用gitlab服务器的IP访问，如下页面所示图产品</p>
<p><img src="../../img/gitlab_login.png" alt="img1"><br>主页如下图产品所示</p>
<p><img src="../../img/gitlab_zhuye.jpg" alt="img2"><br>管理页面如下图产品所示</p>
<p><img src="../../img/gitlab_manager.png" alt="img3"></p>
<p><strong>gitlab常用管理操作</strong></p>
<ul>
<li>项目管理（通常只是创建新项目）</li>
<li>创建成员组（针对某个项目创建一个成员组）</li>
<li>用户管理（此用户乃gitlab用户而非系统用户）<ul>
<li>来了新员工，为其添加gitlab用户</li>
<li>员工离职，将其gitlab用户禁用或删除</li>
</ul>
</li>
</ul>

          
        
      
    </div>

    

    

    
    
    

    

    
      
    
    

    
	
	  <div>
        
      </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/6/">6</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <div class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">

          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  
  <p class="site-author-name" itemprop="name">itw</p>
  <div class="site-description motion-element" itemprop="description"></div>
</div>


  <nav class="site-state motion-element">
    
      <div class="site-state-item site-state-posts">
        
          <a href="/archives/">
        
          <span class="site-state-item-count">51</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
    

    
      
      
      <div class="site-state-item site-state-categories">
        
        
        
          
        
        <span class="site-state-item-count">1</span>
        <span class="site-state-item-name">分类</span>
        
      </div>
    

    
      
      
      <div class="site-state-item site-state-tags">
        
        
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
        <span class="site-state-item-count">28</span>
        <span class="site-state-item-name">标签</span>
        
      </div>
    
  </nav>



  <div class="feed-link motion-element">
    <a href="/atom.xml" rel="alternate">
      <i class="fa fa-rss"></i>RSS
    </a>
  </div>











          
          
        </div>
      </div>

      

      

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">itw</span>

  

  
</div>


<div class="powered-by">
<i class="fa fa-user-md"></i><span id="busuanzi_container_site_uv">
  本站访客数:<span id="busuanzi_value_site_uv"></span>
</span>
</div>
<!-- <div class="powered-by">由 <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v3.9.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> v7.2.0</div>
-->



<div class="theme-info">
  <div class="powered-by"></div>
  <span class="post-count">博客全站共183.1k字</span>
</div>

        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>










  
  













  
  <script src="/lib/jquery/index.js?v=3.4.1"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>




  <script src="/js/utils.js?v=7.2.0"></script>

  <script src="/js/motion.js?v=7.2.0"></script>



  
  


  <script src="/js/schemes/muse.js?v=7.2.0"></script>



  

  <script src="/js/next-boot.js?v=7.2.0"></script>

  

  

  

  

  



  




  

  

  

  

  

  

  

  

  

  

  

  

  


  

   <canvas class="fireworks" style="position: fixed;left: 0;top: 0;z-index: 1; pointer-events: none;"></canvas> 
   <script type="text/javascript" src="//cdn.bootcss.com/animejs/2.2.0/anime.min.js"></script> 
   <script type="text/javascript" src="/js/fireworks.js"></script>

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>
</html>

<!DOCTYPE html>












  


<html class="theme-next muse use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>
<link href="//cdn.bootcss.com/pace/1.0.2/themes/pink/pace-theme-flash.css" rel="stylesheet">
<style>
    .pace .pace-progress {
        background: #1E92FB; /*进度条颜色*/
        height: 3px;
    }
    .pace .pace-progress-inner {
         box-shadow: 0 0 10px #1E92FB, 0 0 5px     #1E92FB; /*阴影颜色*/
    }
    .pace .pace-activity {
        border-top-color: #1E92FB;    /*上边框颜色*/
        border-left-color: #1E92FB;    /*左边框颜色*/
    }
</style>
<meta name="theme-color" content="#222">




  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link rel="stylesheet" href="/lib/pace/pace-theme-pace-theme-minimal.min.css?v=1.0.2">



















<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.7.0">

<link rel="stylesheet" href="/css/main.css?v=7.2.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.2.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.2.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.2.0">


  <link rel="mask-icon" href="/images/logo.svg?v=7.2.0" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '7.2.0',
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":false},
    copycode: {"enable":false,"show_result":false,"style":null},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    translation: {
      copy_button: '复制',
      copy_success: '复制成功',
      copy_failure: '复制失败'
    }
  };
</script>

  <meta property="og:type" content="website">
<meta property="og:title" content="itw">
<meta property="og:url" content="http://aiwhs.github.io/page/3/index.html">
<meta property="og:site_name" content="itw">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="itw">



  <link rel="alternate" href="/atom.xml" title="itw" type="application/atom+xml">



  
  
  <link rel="canonical" href="http://aiwhs.github.io/page/3/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  
  <title>itw</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>
    <a href="https://github.com/aiwhs" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewbox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; left: 0; transform: scale(-1, 1);" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"/><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"/><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"/></svg><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style></a>
	
    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">itw</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>

  </li>

      
      
    </ul>
  

  
    

  

  
</nav>



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://aiwhs.github.io/2018/11/18/rsync/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="itw">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="itw">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2018/11/18/rsync/" class="post-title-link" itemprop="url">Rsync</a>
              
            
          </h1>
        

        <div class="post-meta">

          
          
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-11-18 08:15:57" itemprop="dateCreated datePublished" datetime="2018-11-18T08:15:57+08:00">2018-11-18</time>
            </span>
          

          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-07-12 15:08:12" itemprop="dateModified" datetime="2019-07-12T15:08:12+08:00">2019-07-12</time>
              </span>
            
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Linux运维/" itemprop="url" rel="index"><span itemprop="name">Linux运维</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          <br>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <a id="more"></a>

<h1 id="1-rsync简介"><a href="#1-rsync简介" class="headerlink" title="1. rsync简介"></a>1. rsync简介</h1><p><code>rsync</code>是<code>linux</code>系统下的数据镜像备份工具。使用快速增量备份工具<code>Remote Sync</code>可以远程同步，支持本地复制，或者与其他<code>SSH</code>、<code>rsync</code>主机同步。</p>
<h1 id="2-rsync特性"><a href="#2-rsync特性" class="headerlink" title="2. rsync特性"></a>2. rsync特性</h1><p><code>rsync</code>支持很多特性：</p>
<ul>
<li>可以镜像保存整个目录树和文件系统</li>
<li>可以很容易做到保持原来文件的权限、时间、软硬链接等等</li>
<li>无须特殊权限即可安装</li>
<li>快速：第一次同步时<code>rsync</code>会复制全部内容，但在下一次只传输修改过的文件。<code>rsync</code>在传输数据的过程中可以实行压缩及解压缩操作，因此可以使用更少的带宽</li>
<li>安全：可以使用<code>scp</code>、<code>ssh</code>等方式来传输文件，当然也可以通过直接的socket连接</li>
<li>支持匿名传输，以方便进行网站镜象</li>
</ul>
<p>注意:rsync不要用来同步大文件,因为它同步占用的是网络,多数用来同步小文件,大文件要想同步建议使用nfs,然后备份整个物理硬盘</p>
<h1 id="3-rsync的ssh认证协议"><a href="#3-rsync的ssh认证协议" class="headerlink" title="3. rsync的ssh认证协议"></a>3. rsync的ssh认证协议</h1><p><code>rsync</code>命令来同步系统文件之前要先登录<code>remote</code>主机认证，认证过程中用到的协议有2种：</p>
<ul>
<li><p>ssh协议</p>
</li>
<li><p>rsync协议</p>
</li>
</ul>
<blockquote>
<p><code>rsync server</code>端不用启动<code>rsync</code>的<code>daemon</code>进程，只要获取<code>remote host</code>的用户名和密码就可以直接<code>rsync</code>同步文件</p>
<p><code>rsync server</code>端因为不用启动<code>daemon</code>进程，所以也不用配置文件<code>/etc/rsyncd.conf</code></p>
</blockquote>
<p><code>ssh</code>认证协议跟<code>scp</code>的原理是一样的，如果在同步过程中不想输入密码就用<code>ssh-keygen -t rsa</code>打通通道</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">这种方式默认是省略了 -e ssh 的，与下面等价：</span><br><span class="line">rsync -avz /SRC -e ssh root@192.168.161.189:/DEST </span><br><span class="line">    -a  	文件宿主变化，时间戳不变</span><br><span class="line">    -z  	压缩数据传输</span><br><span class="line"> </span><br><span class="line">当遇到要修改端口的时候，我们可以：</span><br><span class="line">rsync -avz /SRC -e &quot;ssh -p2222&quot; root@192.168.161.189:/DEST  </span><br><span class="line">修改了ssh 协议的端口，默认是22</span><br></pre></td></tr></table></figure>

<h1 id="4-rsync命令"><a href="#4-rsync命令" class="headerlink" title="4. rsync命令"></a>4. rsync命令</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">Rsync的命令格式常用的有以下三种：</span><br><span class="line">    rsync [OPTION]... SRC DEST</span><br><span class="line">    rsync [OPTION]... SRC [USER@]HOST:DEST</span><br><span class="line">    rsync [OPTION]... [USER@]HOST:SRC DEST</span><br><span class="line">　　</span><br><span class="line">对应于以上三种命令格式，rsync有三种不同的工作模式：</span><br><span class="line">1）拷贝本地文件。当SRC和DES路径信息都不包含有单个冒号&quot;:&quot;分隔符时就启动这种工作模式。</span><br><span class="line"></span><br><span class="line">2）使用一个远程shell程序(如rsh、ssh)来实现将本地机器的内容拷贝到远程机器。当DST路径地址包含单个冒号&quot;:&quot;分隔符时启动该模式。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">3）使用一个远程shell程序(如rsh、ssh)来实现将远程机器的内容拷贝到本地机器。当SRC地址路径包含单个冒号&quot;:&quot;分隔符时启动该模式。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">rsync常用选项：</span><br><span class="line">    -a, --archive       //归档</span><br><span class="line">    -v, --verbose       //啰嗦模式</span><br><span class="line">    -q, --quiet         //静默模式</span><br><span class="line">    -r, --recursive     //递归</span><br><span class="line">    -p, --perms         //保持原有的权限属性</span><br><span class="line">    -z, --compress      //在传输时压缩，节省带宽，加快传输速度</span><br><span class="line">    --delete            //在源服务器上做的删除操作也会在目标服务器上同步</span><br></pre></td></tr></table></figure>

<h1 id="5-rsync-inotify"><a href="#5-rsync-inotify" class="headerlink" title="5. rsync+inotify"></a>5. rsync+inotify</h1><p><code>rsync</code>与传统的<code>cp</code>、<code>tar</code>备份方式相比，<code>rsync</code>具有安全性高、备份迅速、支持增量备份等优点，通过<code>rsync</code>可以解决对实时性要求不高的数据备份需求，例如定期的备份文件服务器数据到远端服务器，对本地磁盘定期做数据镜像等。</p>
<p>随着应用系统规模的不断扩大，对数据的安全性和可靠性也提出的更好的要求，<code>rsync</code>在高端业务系统中也逐渐暴露出了很多不足，首先，<code>rsync</code>同步数据时，需要扫描所有文件后进行比对，进行差量传输。如果文件数量达到了百万甚至千万量级，扫描所有文件将是非常耗时的。而且正在发生变化的往往是其中很少的一部分，这是非常低效的方式。其次，<code>rsync</code>不能实时的去监测、同步数据，虽然它可以通过<code>linux</code>守护进程的方式进行触发同步，但是两次触发动作一定会有时间差，这样就导致了服务端和客户端数据可能出现不一致，无法在应用故障时完全的恢复数据。基于以上原因，<code>rsync+inotify</code>组合出现了！</p>
<p><code>Inotify</code>是一种强大的、细粒度的、异步的文件系统事件监控机制，<code>linux</code>内核从<code>2.6.13</code>起，加入了<code>Inotify</code>支持，通过<code>Inotify</code>可以监控文件系统中添加、删除，修改、移动等各种细微事件，利用这个内核接口，第三方软件就可以监控文件系统下文件的各种变化情况，而<code>inotify-tools</code>就是这样的一个第三方软件。</p>
<p>在前面有讲到，<code>rsync</code>可以实现触发式的文件同步，但是通过<code>crontab</code>守护进程方式进行触发，同步的数据和实际数据会有差异，而<code>inotify</code>可以监控文件系统的各种变化，当文件有任何变动时，就触发<code>rsync</code>同步，这样刚好解决了同步数据的实时性问题。</p>
<p><strong>环境说明：</strong></p>
<table>
<thead>
<tr>
<th>服务器类型</th>
<th>IP地址</th>
<th>应用</th>
<th>操作系统</th>
</tr>
</thead>
<tbody><tr>
<td>源服务器<br>wenhs5479</td>
<td>192.168.161.188</td>
<td>rsync<br>inotify-tools<br>脚本</td>
<td>centos7/redhat7</td>
</tr>
<tr>
<td>目标服务器<br>wenhs-docker-ce</td>
<td>192.168.161.189</td>
<td>rsync</td>
<td>centos7/redhat7</td>
</tr>
</tbody></table>
<p><strong>需求：</strong></p>
<ul>
<li>把源服务器上/etc目录实时同步到目标服务器的/NAME/下。这里的NAME是指你的名字，比如你叫tom，则要把/etc目录同步至目标服务器的/tom/下。</li>
</ul>
<p><strong>在目标服务器上做以下操作：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line">关闭防火墙与SELINUX</span><br><span class="line">[root@wenhs-docker-ce ~]# systemctl stop firewalld</span><br><span class="line">[root@wenhs-docker-ce ~]# systemctl disable firewalld</span><br><span class="line">[root@wenhs-docker-ce ~]# getenforce</span><br><span class="line">Enforcing</span><br><span class="line">[root@wenhs-docker-ce ~]# setenforce 0</span><br><span class="line">[root@wenhs-docker-ce ~]# sed -ri &apos;s/^(SELINUX=).*/\1disabled/g&apos; /etc/sysconfig/selinux</span><br><span class="line"></span><br><span class="line">安装rsync服务端软件</span><br><span class="line">[root@wenhs-docker-ce ~]# yum -y install rsync</span><br><span class="line">已加载插件：fastestmirror, langpacks</span><br><span class="line">Loading mirror speeds from cached hostfile</span><br><span class="line">正在解决依赖关系</span><br><span class="line">.......</span><br><span class="line">已安装:</span><br><span class="line">  rsync.x86_64 0:3.1.2-4.el7                                                                   </span><br><span class="line">完毕！</span><br><span class="line"></span><br><span class="line">设置rsyncd.conf配置文件</span><br><span class="line">[root@wenhs-docker-ce ~]# cat &gt;&gt;/etc/rsyncd.conf &lt;&lt;EOF</span><br><span class="line">&gt; log file = /var/log/rsyncd.log    #日志文件位置，启动rsync后自动产生这个文件，无需提前创建#</span><br><span class="line">&gt; pidfile = /var/run/rsyncd.pid     #pid文件的存放位置#</span><br><span class="line">&gt; lock file = /var/run/rsync.lock   #支持max connections参数的锁文件#</span><br><span class="line">&gt; secrets file = /etc/rsync.pass    #用户认证配置文件，里面保存用户名称和密码，必须手动创建这个文件#</span><br><span class="line">&gt; </span><br><span class="line">&gt; [etc_from_client]     #自定义同步名称#</span><br><span class="line">&gt; path = /wenhs/          #rsync服务端数据存放路径，客户端的数据将同步至此目录#</span><br><span class="line">&gt; comment = sync etc from client</span><br><span class="line">&gt; uid = root        #设置rsync运行权限为root#</span><br><span class="line">&gt; gid = root        #设置rsync运行权限为root#</span><br><span class="line">&gt; port = 873        #默认端口#</span><br><span class="line">&gt; ignore errors     #表示出现错误忽略错误#</span><br><span class="line">&gt; use chroot = no       #默认为true，修改为no，增加对目录文件软连接的备份#</span><br><span class="line">&gt; read only = no    #设置rsync服务端为读写权限#</span><br><span class="line">&gt; list = no     #不显示rsync服务端资源列表#</span><br><span class="line">&gt; max connections = 200     #最大连接数#</span><br><span class="line">&gt; timeout = 600     #设置超时时间#</span><br><span class="line">&gt; auth users = admin        #执行数据同步的用户名，可以设置多个，用英文状态下逗号隔开#</span><br><span class="line">&gt; hosts allow = 192.168.161.188   #允许进行数据同步的客户端IP地址，可以设置多个，用英文状态下逗号隔开#</span><br><span class="line">&gt; hosts deny = 192.168.1.1      #禁止数据同步的客户端IP地址，可以设置多个，用英文状态下逗号隔开#</span><br><span class="line">&gt; EOF</span><br><span class="line">注意:配置文件里面这些中文注释禁止写入,否则会报配置文件错误</span><br><span class="line">@ERROR: auth failed on module etc_from_client</span><br><span class="line">rsync error: error starting client-server protocol (code 5) at main.c(1648) [sender=3.1.2]</span><br><span class="line"></span><br><span class="line">创建用户认证文件</span><br><span class="line">[root@wenhs-docker-ce ~]# echo &apos;admin:123456&apos; &gt; /etc/rsync.pass</span><br><span class="line">[root@wenhs-docker-ce ~]# cat /etc/rsync.pass</span><br><span class="line">admin:123456</span><br><span class="line"></span><br><span class="line">创建共享目录</span><br><span class="line">[root@wenhs-docker-ce ~]# mkdir /wenhs</span><br><span class="line">不创建这个目录,会报---&gt;@ERROR: chdir failed</span><br><span class="line"></span><br><span class="line">设置文件权限</span><br><span class="line">[root@wenhs-docker-ce ~]# chmod 600 /etc/rsync.pass </span><br><span class="line">[root@wenhs-docker-ce ~]# ll /etc/rsync*</span><br><span class="line">-rw-r--r-- 1 root root 1863 4月  25 15:31 /etc/rsyncd.conf</span><br><span class="line">-rw------- 1 root root   13 4月  25 15:33 /etc/rsync.pass</span><br><span class="line"></span><br><span class="line">启动rsync服务并设置开机自启动</span><br><span class="line">[root@wenhs-docker-ce ~]# systemctl start rsyncd</span><br><span class="line">[root@wenhs-docker-ce ~]# systemctl enable rsyncd</span><br><span class="line">Created symlink from /etc/systemd/system/multi-user.target.wants/rsyncd.service to /usr/lib/systemd/system/rsyncd.service.</span><br><span class="line">[root@wenhs-docker-ce ~]# ss -antl</span><br><span class="line">Netid State      Recv-Q Send-Q Local Address:Port               Peer Address:Port                      </span><br><span class="line">tcp   LISTEN     0      5                 *:873                           *:*                  </span><br><span class="line">tcp   LISTEN     0      128               *:111                           *:*                  </span><br><span class="line">tcp   LISTEN     0      5      192.168.122.1:53                            *:*                  </span><br><span class="line">tcp   LISTEN     0      128               *:22                            *:*                  </span><br><span class="line">tcp   LISTEN     0      128       127.0.0.1:631                           *:*                  </span><br><span class="line">tcp   LISTEN     0      100       127.0.0.1:25                            *:*                  </span><br><span class="line">tcp   LISTEN     0      128       127.0.0.1:6010                          *:*                  </span><br><span class="line">tcp   LISTEN     0      5                :::873                          :::*                  </span><br><span class="line">tcp   LISTEN     0      128              :::111                          :::*                  </span><br><span class="line">tcp   LISTEN     0      128              :::22                           :::*                  </span><br><span class="line">tcp   LISTEN     0      128             ::1:631                          :::*                  </span><br><span class="line">tcp   LISTEN     0      100             ::1:25                           :::*                  </span><br><span class="line">tcp   LISTEN     0      128             ::1:6010                         :::*</span><br></pre></td></tr></table></figure>

<p><strong>在源服务器上做以下操作：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br></pre></td><td class="code"><pre><span class="line">关闭防火墙与SELINUX</span><br><span class="line">[root@wenhs5479 ~]# systemctl stop firewalld</span><br><span class="line">[root@wenhs5479 ~]# systemctl disable firewalld</span><br><span class="line">[root@wenhs5479 ~]# getenforce</span><br><span class="line">Enforcing</span><br><span class="line">[root@wenhs5479 ~]# setenforce 0</span><br><span class="line">[root@wenhs5479 ~]# sed -ri &apos;s/^(SELINUX=).*/\1disabled/g&apos; /etc/sysconfig/selinux</span><br><span class="line"></span><br><span class="line">配置yum源</span><br><span class="line">[root@wenhs5479 ~]# cd /etc/yum.repos.d/</span><br><span class="line">[root@wenhs5479 yum.repos.d]# wget http://mirrors.163.com/.help/CentOS7-Base-163.repo</span><br><span class="line">--2019-04-25 15:41:23--  http://mirrors.163.com/.help/CentOS7-Base-163.repo</span><br><span class="line">正在解析主机 mirrors.163.com (mirrors.163.com)... 59.111.0.251</span><br><span class="line">正在连接 mirrors.163.com (mirrors.163.com)|59.111.0.251|:80... 已连接。</span><br><span class="line">已发出 HTTP 请求，正在等待回应... 200 OK</span><br><span class="line">长度：1572 (1.5K) [application/octet-stream]</span><br><span class="line">正在保存至: “CentOS7-Base-163.repo”</span><br><span class="line"></span><br><span class="line">100%[=====================================================&gt;] 1,572       --.-K/s 用时 0s      </span><br><span class="line"></span><br><span class="line">2019-04-25 15:41:23 (185 MB/s) - 已保存 “CentOS7-Base-163.repo” [1572/1572])</span><br><span class="line"></span><br><span class="line">[root@wenhs5479 yum.repos.d]# sed -i &apos;s/\$releasever/7/g&apos; /etc/yum.repos.d/CentOS7-Base-163.repo</span><br><span class="line">[root@wenhs5479 yum.repos.d]# sed -i &apos;s/^enabled=.*/enabled=1/g&apos; /etc/yum.repos.d/CentOS7-Base-163.repo</span><br><span class="line">[root@wenhs5479 yum.repos.d]# yum -y install epel-release</span><br><span class="line">已加载插件：fastestmirror, langpacks</span><br><span class="line">Determining fastest mirrors</span><br><span class="line"> * base: mirrors.huaweicloud.com</span><br><span class="line"> * extras: mirrors.huaweicloud.com</span><br><span class="line"> * updates: mirrors.huaweicloud.com</span><br><span class="line">正在解决依赖关系</span><br><span class="line">--&gt; 正在检查事务</span><br><span class="line">---&gt; 软件包 epel-release.noarch.0.7-11 将被 安装</span><br><span class="line">--&gt; 解决依赖关系完成</span><br><span class="line">.......</span><br><span class="line">已安装:</span><br><span class="line">  epel-release.noarch 0:7-11                                                                   </span><br><span class="line">完毕！</span><br><span class="line"></span><br><span class="line">安装rsync服务端软件，只需要安装，不要启动，不需要配置</span><br><span class="line">[root@wenhs5479 ~]# yum -y install rsync</span><br><span class="line">已加载插件：fastestmirror, langpacks</span><br><span class="line">Loading mirror speeds from cached hostfile</span><br><span class="line"> * base: mirrors.huaweicloud.com</span><br><span class="line"> * epel: mirrors.njupt.edu.cn</span><br><span class="line"> * extras: mirrors.huaweicloud.com</span><br><span class="line"> * updates: mirrors.huaweicloud.com</span><br><span class="line">正在解决依赖关系</span><br><span class="line">--&gt; 正在检查事务</span><br><span class="line">---&gt; 软件包 rsync.x86_64.0.3.1.2-4.el7 将被 安装</span><br><span class="line">--&gt; 解决依赖关系完成</span><br><span class="line">.......</span><br><span class="line">Transaction test succeeded</span><br><span class="line">Running transaction</span><br><span class="line">  正在安装    : rsync-3.1.2-4.el7.x86_64                                                   1/1 </span><br><span class="line">  验证中      : rsync-3.1.2-4.el7.x86_64                                                   1/1 </span><br><span class="line">已安装:</span><br><span class="line">  rsync.x86_64 0:3.1.2-4.el7                                                                   </span><br><span class="line">完毕！</span><br><span class="line"></span><br><span class="line">创建认证密码文件</span><br><span class="line">[root@wenhs5479 ~]# echo &apos;123456&apos; &gt; /etc/rsync.pass</span><br><span class="line">[root@wenhs5479 ~]# cat /etc/rsync.pass </span><br><span class="line">123456</span><br><span class="line"></span><br><span class="line">设置文件权限，只设置文件所有者具有读取、写入权限即可</span><br><span class="line">[root@wenhs5479 ~]# chmod 600 /etc/rsync.pass </span><br><span class="line">[root@wenhs5479 ~]# ll /etc/rsync*</span><br><span class="line">-rw-r--r--. 1 root root 458 4月  11 2018 /etc/rsyncd.conf</span><br><span class="line">-rw-------. 1 root root   7 4月  25 15:52 /etc/rsync.pass</span><br><span class="line"></span><br><span class="line">在源服务器上创建测试目录，然后在源服务器运行以下命令</span><br><span class="line">[root@wenhs5479 ~]# rsync -avH --port 873 --progress --delete /root/etc/ admin@192.168.161.189::etc_from_client --password-file=/etc/rsync.pass</span><br><span class="line">sending incremental file list</span><br><span class="line">deleting wen/</span><br><span class="line">./</span><br><span class="line">test/</span><br><span class="line"></span><br><span class="line">sent 77 bytes  received 35 bytes  224.00 bytes/sec</span><br><span class="line">total size is 0  speedup is 0.00</span><br><span class="line">运行完成后，在目标服务器上查看，在/tmp目录下有test目录，说明数据同步成功</span><br><span class="line">[root@wenhs-docker-ce ~]# ll /wenhs/</span><br><span class="line">总用量 0</span><br><span class="line">drwxr-xr-x 2 root root 6 4月  25 16:30 test</span><br><span class="line"></span><br><span class="line">安装inotify-tools工具，实时触发rsync进行同步</span><br><span class="line"></span><br><span class="line">查看服务器内核是否支持inotify</span><br><span class="line">[root@wenhs5479 ~]# ll /proc/sys/fs/inotify/</span><br><span class="line">总用量 0</span><br><span class="line">-rw-r--r--. 1 root root 0 4月  25 16:33 max_queued_events</span><br><span class="line">-rw-r--r--. 1 root root 0 4月  25 16:33 max_user_instances</span><br><span class="line">-rw-r--r--. 1 root root 0 4月  15 15:14 max_user_watches</span><br><span class="line"></span><br><span class="line">安装inotify-tools</span><br><span class="line">[root@wenhs5479 ~]# yum -y install make gcc gcc-c++ inotify-tools</span><br><span class="line">Loading mirror speeds from cached hostfile</span><br><span class="line"> * base: mirrors.huaweicloud.com</span><br><span class="line"> * epel: mirrors.njupt.edu.cn</span><br><span class="line"> * extras: mirrors.huaweicloud.com</span><br><span class="line"> * updates: mirrors.huaweicloud.com</span><br><span class="line">软件包 1:make-3.82-23.el7.x86_64 已安装并且是最新版本</span><br><span class="line">软件包 gcc-4.8.5-36.el7_6.1.x86_64 已安装并且是最新版本</span><br><span class="line">软件包 gcc-c++-4.8.5-36.el7_6.1.x86_64 已安装并且是最新版本</span><br><span class="line">正在解决依赖关系</span><br><span class="line">........</span><br><span class="line">inotify-tools-3.14-8.el7.x86_64.rpm                                     |  50 kB  00:00:15     </span><br><span class="line">从 file:///etc/pki/rpm-gpg/RPM-GPG-KEY-EPEL-7 检索密钥</span><br><span class="line">导入 GPG key 0x352C64E5:</span><br><span class="line"> 用户ID     : &quot;Fedora EPEL (7) &lt;epel@fedoraproject.org&gt;&quot;</span><br><span class="line"> 指纹       : 91e9 7d7c 4a5e 96f1 7f3e 888f 6a2f aea2 352c 64e5</span><br><span class="line"> 软件包     : epel-release-7-11.noarch (@extras)</span><br><span class="line"> 来自       : /etc/pki/rpm-gpg/RPM-GPG-KEY-EPEL-7</span><br><span class="line">....... </span><br><span class="line">已安装:</span><br><span class="line">  inotify-tools.x86_64 0:3.14-8.el7                                                            </span><br><span class="line">完毕！</span><br><span class="line"></span><br><span class="line">写同步脚本，此步乃最最重要的一步，请慎之又慎。让脚本自动去检测我们制定的目录下 \</span><br><span class="line">文件发生的变化，然后再执行rsync的命令把它同步到我们的服务器端去</span><br><span class="line">[root@wenhs5479 ~]# mkdir /scripts</span><br><span class="line">[root@wenhs5479 ~]# touch /scripts/inotify.sh</span><br><span class="line">[root@wenhs5479 ~]# chmod 755 /scripts/inotify.sh</span><br><span class="line">[root@wenhs5479 ~]# ll /scripts/inotify.sh</span><br><span class="line">-rwxr-xr-x. 1 root root 0 4月  25 16:36 /scripts/inotify.sh</span><br><span class="line">[root@wenhs5479 ~]# vim /scripts/inotify.sh</span><br><span class="line">#!/bin/bash</span><br><span class="line">#目标服务器的ip(备份服务器)</span><br><span class="line">host=192.168.161.189</span><br><span class="line">#在源服务器上所要监控的备份目录（此处可以自定义，但是要保证存在）</span><br><span class="line">src=/etc</span><br><span class="line">#自定义的模块名，需要与目标服务器上定义的同步名称一致</span><br><span class="line">des=etc_from_client</span><br><span class="line">#执行数据同步的密码文件</span><br><span class="line">password=/etc/rsync.pass</span><br><span class="line">#执行数据同步的用户名</span><br><span class="line">user=admin</span><br><span class="line">inotifywait=/usr/bin/inotifywait</span><br><span class="line"></span><br><span class="line">$inotifywait -mrq --timefmt &apos;%Y%m%d %H:%M&apos; --format &apos;%T %w%f%e&apos; -e modify,delete,create,attrib $src \</span><br><span class="line">| while read files ;do</span><br><span class="line">    rsync -avzP --delete  --timeout=100 --password-file=$&#123;password&#125; $src $user@$host::$des</span><br><span class="line">    echo &quot;$&#123;files&#125; was rsynced&quot; &gt;&gt;/tmp/rsync.log 2&gt;&amp;1</span><br><span class="line">done</span><br><span class="line">注意:写脚本所有的标点符号为英文符号,否则报错,另外src这个变量,要在目录下,所以要加/</span><br><span class="line"></span><br><span class="line">启动脚本</span><br><span class="line">[root@wenhs5479 ~]# nohup bash /scripts/inotify.sh &amp;</span><br><span class="line">[1] 33126</span><br><span class="line">[root@wenhs5479 ~]# nohup: ignoring input and appending output to ‘nohup.out’</span><br><span class="line"></span><br><span class="line">[root@wenhs5479 ~]# ps -ef|grep inotify</span><br><span class="line">root      33290  22106  0 16:51 pts/1    00:00:00 bash /scripts/inotify.sh</span><br><span class="line">root      33291  33290  0 16:51 pts/1    00:00:00 /usr/bin/inotifywait -mrq --timefmt %Y%m%d %H:%M --format %T %w%f%e -e modify,delete,create,attrib /etc/</span><br><span class="line">root      33292  33290  0 16:51 pts/1    00:00:00 bash /scripts/inotify.sh</span><br><span class="line">root      33330  22106  0 16:53 pts/1    00:00:00 bash /scripts/inotify.sh</span><br><span class="line"></span><br><span class="line">在源服务器上生成一个新文件</span><br><span class="line">[root@wenhs5479 ~]# ls /etc/httpd/</span><br><span class="line">alias  conf  conf.d  conf.modules.d  logs  modules  run</span><br><span class="line">[root@wenhs5479 ~]# echo &apos;hello word&apos; &gt;/etc/httpd/test</span><br><span class="line"></span><br><span class="line">查看inotify生成的日志</span><br><span class="line">[root@wenhs5479 ~]# tail /tmp/rsync.log</span><br><span class="line">20190425 17:06 /etc/httpd/testCREATE was rsynced</span><br><span class="line">20190425 17:06 /etc/httpd/testCREATE was rsynced</span><br><span class="line">20190425 17:06 /etc/httpd/testMODIFY was rsynced</span><br><span class="line">20190425 17:06 /etc/httpd/testMODIFY was rsynced</span><br><span class="line">20190425 17:06 /etc/httpd/testCREATE was rsynced</span><br><span class="line">20190425 17:06 /etc/httpd/testCREATE was rsynced</span><br><span class="line">20190425 17:06 /etc/httpd/testMODIFY was rsynced</span><br><span class="line">20190425 17:06 /etc/httpd/testMODIFY was rsynced</span><br><span class="line">从日志上可以看到，我们生成了一个test文件，并且添加了内容到其里面</span><br></pre></td></tr></table></figure>

<p><strong>设置脚本开机自动启动：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@wenhs5479 ~]# chmod +x /etc/rc.d/rc.local</span><br><span class="line">[root@wenhs5479 ~]# ll /etc/rc.d/rc.local</span><br><span class="line">-rwxr-xr-x. 1 root root 473 2月  20 01:35 /etc/rc.d/rc.local</span><br><span class="line">[root@wenhs5479 ~]# echo &apos;nohup /bin/bash /scripts/inotify.sh&apos; &gt;&gt; /etc/rc.d/rc.local</span><br><span class="line">[root@wenhs5479 ~]# tail /etc/rc.d/rc.local</span><br><span class="line"># to run scripts during boot instead of using this file.</span><br><span class="line">#</span><br><span class="line"># In contrast to previous versions due to parallel execution during boot</span><br><span class="line"># this script will NOT be run after all other services.</span><br><span class="line">#</span><br><span class="line"># Please note that you must run &apos;chmod +x /etc/rc.d/rc.local&apos; to ensure</span><br><span class="line"># that this script will be executed during boot.</span><br><span class="line"></span><br><span class="line">touch /var/lock/subsys/local</span><br><span class="line">nohup /bin/bash /scripts/inotify.sh</span><br></pre></td></tr></table></figure>

<p><strong>到目标服务器上去查看是否把新生成的文件自动传上去了：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@wenhs-docker-ce wenhs]# pwd</span><br><span class="line">/wenhs</span><br><span class="line">[root@wenhs-docker-ce wenhs]# ls</span><br><span class="line">aaaaa                       hostname                  popt.d</span><br><span class="line">abrt                        hosts                     portreserve</span><br><span class="line">adjtime                     hosts.allow               postfix</span><br><span class="line">akonadi                     hosts.deny                ppp</span><br><span class="line">aliases                     hp                        prelink.conf.d</span><br><span class="line">aliases.db                  httpd                     printcap</span><br><span class="line">...</span><br><span class="line">[root@wenhs-docker-ce wenhs]# ls /wenhs/httpd/</span><br><span class="line">alias  conf  conf.d  conf.modules.d  logs  modules  run  test</span><br><span class="line">由此可见，已将源服务器的/etc目录整个同步到了目标服务器，且新增的test文件也自动同步了</span><br></pre></td></tr></table></figure>
          
        
      
    </div>

    

    

    
    
    

    

    
      
    
    

    
	
	  <div>
        
      </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://aiwhs.github.io/2018/11/18/nginx/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="itw">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="itw">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2018/11/18/nginx/" class="post-title-link" itemprop="url">nginx详解</a>
              
            
          </h1>
        

        <div class="post-meta">

          
          
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-11-18 08:15:57" itemprop="dateCreated datePublished" datetime="2018-11-18T08:15:57+08:00">2018-11-18</time>
            </span>
          

          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-07-12 14:48:29" itemprop="dateModified" datetime="2019-07-12T14:48:29+08:00">2019-07-12</time>
              </span>
            
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Linux运维/" itemprop="url" rel="index"><span itemprop="name">Linux运维</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          <br>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <a id="more"></a>

<h2 id="1-nginx简介"><a href="#1-nginx简介" class="headerlink" title="1. nginx简介"></a>1. nginx简介</h2><p><code>nginx</code>（发音同engine x）是一款轻量级的Web服务器/反向代理服务器及电子邮件（IMAP/POP3）代理服务器，并在一个BSD-like协议下发行。</p>
<p><code>nginx</code>由俄罗斯的程序设计师Igor Sysoev所开发，最初供俄国大型的入口网站及搜寻引擎Rambler使用。</p>
<p>第一个公开版本0.1.0发布于2004年10月4日。其将源代码以类BSD许可证的形式发布，因它的稳定性、丰富的功能集、示例配置文件和低系统资源的消耗而闻名。2011年6月1日，nginx 1.0.4发布。</p>
<p><code>nginx</code>的特点是占有内存少，并发能力强，事实上<code>nginx</code>的并发能力确实在同类型的网页服务器中表现较好，中国大陆使用<code>nginx</code>网站用户有：百度、京东、新浪、网易、腾讯、淘宝等。</p>
<h2 id="2-nginx的特性与优点"><a href="#2-nginx的特性与优点" class="headerlink" title="2. nginx的特性与优点"></a>2. nginx的特性与优点</h2><h3 id="2-1-nginx的特性"><a href="#2-1-nginx的特性" class="headerlink" title="2.1 nginx的特性"></a>2.1 nginx的特性</h3><p><code>nginx</code>是一个很牛的高性能Web和反向代理服务器，它具有很多非常优越的特性：</p>
<ul>
<li>在高连接并发的情况下，nginx是Apache服务器不错的替代品，能够支持高达50000个并发连接数的响应</li>
<li>使用epoll and kqueue作为开发模型</li>
<li>nginx作为负载均衡服务器：nginx既可在内部直接支持和PHP程序对外进行服务，也可支持作为HTTP代理服务器对外进行服务</li>
<li>nginx采用C进行编写，不论系统资源开销还是CPU使用效率都比Perlbal要好很多</li>
</ul>
<h3 id="2-2-nginx的优点"><a href="#2-2-nginx的优点" class="headerlink" title="2.2 nginx的优点"></a>2.2 nginx的优点</h3><ul>
<li>高并发连接：官方测试能够支撑5万并发连接，在实际生产环境中跑到2-3万并发连接数</li>
<li>内存消耗少：在3万并发连接下，开启的10个nginx进程才消耗150M内存（15M*10=150M）</li>
<li>配置文件非常简单：风格跟程序一样通俗易懂</li>
<li>成本低廉：nginx为开源软件，可以免费使用。而购买F5 BIG-IP、NetScaler等硬件负载均衡交换机则需要十多万至几十万人民币</li>
<li>支持Rewrite重写规则：能够根据域名、URL的不同，将HTTP请求分到不同的后端服务器群组</li>
<li>内置的健康检查功能：如果Nginx Proxy后端的某台Web服务器宕机了，不会影响前端访问</li>
<li>节省带宽：支持GZIP压缩，可以添加浏览器本地缓存的Header头</li>
<li>稳定性高：用于反向代理，宕机的概率微乎其微</li>
<li>模块化设计：模块可以动态编译</li>
<li>外围支持好：文档全，二次开发和模块较多</li>
<li>支持热部署：可以不停机重载配置文件</li>
<li>支持事件驱动、AIO（AsyncIO，异步IO）、mmap（Memory Map，内存映射）等性能优化</li>
</ul>
<h2 id="3-nginx的功能及应用类别"><a href="#3-nginx的功能及应用类别" class="headerlink" title="3. nginx的功能及应用类别"></a>3. nginx的功能及应用类别</h2><h3 id="3-1-nginx的基本功能"><a href="#3-1-nginx的基本功能" class="headerlink" title="3.1 nginx的基本功能"></a>3.1 nginx的基本功能</h3><ul>
<li>静态资源的web服务器，能缓存打开的文件描述符</li>
<li>http、smtp、pop3协议的反向代理服务器</li>
<li>缓存加速、负载均衡</li>
<li>支持FastCGI（fpm，LNMP），uWSGI（Python）等</li>
<li>模块化（非DSO机制），过滤器zip、SSI及图像的大小调整</li>
<li>支持SSL</li>
</ul>
<h3 id="3-2-nginx的扩展功能"><a href="#3-2-nginx的扩展功能" class="headerlink" title="3.2 nginx的扩展功能"></a>3.2 nginx的扩展功能</h3><ul>
<li>基于名称和IP的虚拟主机</li>
<li>支持keepalive</li>
<li>支持平滑升级</li>
<li>定制访问日志、支持使用日志缓冲区提高日志存储性能</li>
<li>支持URL重写</li>
<li>支持路径别名</li>
<li>支持基于IP及用户的访问控制</li>
<li>支持速率限制，支持并发数限制</li>
</ul>
<h3 id="3-3-nginx的应用类别"><a href="#3-3-nginx的应用类别" class="headerlink" title="3.3 nginx的应用类别"></a>3.3 nginx的应用类别</h3><ul>
<li>使用nginx结合FastCGI运行PHP、JSP、Perl等程序</li>
<li>使用nginx作反向代理、负载均衡、规则过滤</li>
<li>使用nginx运行静态HTML网页、图片</li>
<li>nginx与其他新技术的结合应用</li>
</ul>
<h2 id="4-nginx的模块与工作原理"><a href="#4-nginx的模块与工作原理" class="headerlink" title="4. nginx的模块与工作原理"></a>4. nginx的模块与工作原理</h2><p><code>nginx</code>由内核和模块组成。其中，内核的设计非常微小和简洁，完成的工作也非常简单，仅仅通过查找配置文件将客户端请求映射到一个location block（location是nginx配置中的一个指令，用于URL匹配），而在这个location中所配置的每个指令将会启动不同的模块去完成相应的工作。</p>
<h3 id="4-1-nginx的模块分类"><a href="#4-1-nginx的模块分类" class="headerlink" title="4.1 nginx的模块分类"></a>4.1 nginx的模块分类</h3><p>nginx的模块从结构上分为核心模块、基础模块和第三方模块</p>
<ul>
<li>HTTP模块、EVENT模块和MAIL模块等属于核心模块</li>
<li>HTTP Access模块、HTTP FastCGI模块、HTTP Proxy模块和HTTP Rewrite模块属于基本模块</li>
<li>HTTP Upstream模块、Request Hash模块、Notice模块和HTTP Access Key模块属于第三方模块</li>
</ul>
<p><strong>用户根据自己的需要开发的模块都属于第三方模块。正是有了如此多模块的支撑，nginx的功能才会如此强大</strong></p>
<p>nginx模块从功能上分为三类，分别是：</p>
<ul>
<li>Handlers（处理器模块）。此类模块直接处理请求，并进行输出内容和修改headers信息等操作。handlers处理器模块一般只能有一个</li>
<li>Filters（过滤器模块）。此类模块主要对其他处理器模块输出的内容进行修改操作，最后由nginx输出</li>
<li>Proxies（代理器模块）。就是nginx的HTTP Upstream之类的模块，这些模块主要与后端一些服务比如fastcgi等操作交互，实现服务代理和负载均衡等功能</li>
</ul>
<p>nginx模块分为：核心模块、事件模块、标准Http模块、可选Http模块、邮件模块、第三方模块和补丁等</p>
<ul>
<li>nginx基本模块：所谓基本模块，指的是nginx默认的功能模块，它们提供的指令，允许你使用定义nginx基本功能的变量，在编译时不能被禁用，包括：</li>
<li>核心模块：基本功能和指令，如进程管理和安全。常见的核心模块指令，大部分是放置在配置文件的顶部</li>
<li>事件模块：在Nginx内配置网络使用的能力。常见的events（事件）模块指令，大部分是放置在配置文件的顶部</li>
<li>配置模块：提供包含机制</li>
</ul>
<p>具体的指令，请参考<code>nginx</code>的<a href="http://nginx.org/en/docs/ngx_core_module.html" target="_blank" rel="noopener">官方文档</a></p>
<h3 id="4-2-nginx的工作原理"><a href="#4-2-nginx的工作原理" class="headerlink" title="4.2 nginx的工作原理"></a>4.2 nginx的工作原理</h3><p><code>nginx</code>的模块直接被编译进<code>nginx</code>，因此属于静态编译方式。</p>
<p>启动<code>nginx</code>后，<code>nginx</code>的模块被自动加载，与<code>Apache</code>不一样，首先将模块编译为一个so文件，然后在配置文件中指定是否进行加载。</p>
<p>在解析配置文件时，<code>nginx</code>的每个模块都有可能去处理某个请求，但是同一个处理请求只能由一个模块来完成。</p>
<p><strong>nginx的进程架构：</strong></p>
<p>启动<code>nginx</code>时，会启动一个<code>Master</code>进程，这个进程不处理任何客户端的请求，主要用来产生<code>worker</code>线程，一个<code>worker</code>线程用来处理n个<code>request</code>。</p>
<p><img src="../../img/nginx_process.jpg" alt="img"></p>
<p>下图展示了<code>nginx</code>模块一次常规的HTTP请求和响应的过程</p>
<p><img src="../../img/nginx_process_02.jpg" alt="img"></p>
<p>下图展示了基本的WEB服务请求步骤</p>
<p><img src="../../img/nginx_process_01.jpg" alt="img"></p>
<h2 id="5-nginx的安装与配置"><a href="#5-nginx的安装与配置" class="headerlink" title="5. nginx的安装与配置"></a>5. nginx的安装与配置</h2><h3 id="5-1-nginx的安装"><a href="#5-1-nginx的安装" class="headerlink" title="5.1 nginx的安装"></a>5.1 <a href="https://github.com/itwhs/zabbix/blob/master/zabbix/nginx.sh" target="_blank" rel="noopener">nginx</a>的<a href="https://blog.csdn.net/wenhs5479/article/details/88536361" target="_blank" rel="noopener">安装</a></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">logdir=/var/log/nginx</span><br><span class="line">nginxdir=/usr/local/nginx</span><br><span class="line">cores=$(grep &apos;core id&apos; /proc/cpuinfo | sort -u | wc -l)</span><br><span class="line">log=/root/nginxinstall.log</span><br><span class="line">#安装依赖包</span><br><span class="line">yum -y install pcre-devel openssl openssl-devel gd-devel zlib-devel gcc gcc-c++</span><br><span class="line">#创建日志存放目录</span><br><span class="line">id nginx 2&gt;$log</span><br><span class="line">if [ $? != 0 ];then</span><br><span class="line">useradd -r -M -s /sbin/nologin nginx</span><br><span class="line">fi</span><br><span class="line">mkdir -p $logdir</span><br><span class="line">chown -R nginx.nginx $logdir</span><br><span class="line">[ ! -f Package/nginx-1.16.0.tar.gz ] &amp;&amp; wget http://nginx.org/download/nginx-1.16.0.tar.gz</span><br><span class="line">[ ! -d /nginx-1.16.0 ] &amp;&amp; tar xf nginx-1.16.0.tar.gz -C /usr/src/</span><br><span class="line">cd /usr/src/nginx-1.16.0</span><br><span class="line">./configure --prefix=$nginxdir --user=nginx --group=nginx --with-debug --with-http_ssl_module --with-http_realip_module --with-http_image_filter_module --with-http_gunzip_module --with-http_gzip_static_module --with-http_stub_status_module --http-log-path=$logdir/access.log --error-log-path=$logdir/error.log --with-pcre</span><br><span class="line">make -j$cores 2&gt;$log &amp;&amp; make install</span><br><span class="line">#添加服务控制脚本</span><br><span class="line">cat &gt;&gt;/etc/init.d/nginx &lt;&lt;&apos;EOF&apos;</span><br><span class="line">#!/bin/bash</span><br><span class="line">nginx=&quot;/usr/local/nginx/sbin/nginx&quot;</span><br><span class="line">NGINX_CONF_FILE=&quot;/usr/local/nginx/conf/nginx.conf&quot;</span><br><span class="line">pid=&quot;/usr/local/nginx/logs/nginx.pid&quot;</span><br><span class="line">case $1 in</span><br><span class="line">	start)</span><br><span class="line">		$nginx -c $NGINX_CONF_FILE</span><br><span class="line">		;;</span><br><span class="line">	stop)</span><br><span class="line">		$nginx -s stop</span><br><span class="line">		;;</span><br><span class="line">	restart)</span><br><span class="line">		$nginx -s stop</span><br><span class="line">		sleep 1</span><br><span class="line">		$nginx -c $NGINX_CONF_FILE</span><br><span class="line">		;;</span><br><span class="line">	reload)</span><br><span class="line">		$nginx -s reload</span><br><span class="line">		;;</span><br><span class="line">	status)</span><br><span class="line">		if [ -f $pid ];then</span><br><span class="line">		    echo &quot;nginx is running&quot;</span><br><span class="line">        else</span><br><span class="line">		    echo &quot;nginx is stoped&quot;</span><br><span class="line">	    fi</span><br><span class="line">		;;</span><br><span class="line">	*)</span><br><span class="line">		echo $&quot;Usage: $0 &#123;start|stop|status|restart|reload&#125;&quot;</span><br><span class="line">		exit 2</span><br><span class="line">		;;</span><br><span class="line">esac</span><br><span class="line">EOF</span><br><span class="line">chmod +x /etc/init.d/nginx</span><br><span class="line">##添加环境变量</span><br><span class="line">echo &quot;export PATH=$nginxdir/sbin:\$PATH&quot; &gt;/etc/profile.d/nginx.sh</span><br><span class="line">echo &quot;请执行 : source /etc/profile.d/nginx.sh 来添加环境变量&quot;</span><br><span class="line">echo  &quot;安装完成&quot;</span><br><span class="line">echo &quot;启动服务方法:service nginx start|stop|status|restart|reload &quot;</span><br></pre></td></tr></table></figure>

<h3 id="5-2-nginx安装后配置"><a href="#5-2-nginx安装后配置" class="headerlink" title="5.2 nginx安装后配置"></a>5.2 nginx安装后配置</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">//服务控制方式，使用nginx命令</span><br><span class="line">    -t  //检查配置文件语法</span><br><span class="line">    -v  //输出nginx的版本</span><br><span class="line">    -c  //指定配置文件的路径</span><br><span class="line">    -s  //发送服务控制信号，可选值有&#123;stop|quit|reopen|reload&#125;</span><br><span class="line">  (这里reopen是重启,但是一般不用,效果不好,要么reload重读配置文件,要么stop后在nginx启动)</span><br><span class="line">  </span><br><span class="line">//启动nginx</span><br><span class="line">[root@localhost ~]# nginx</span><br><span class="line">[root@localhost ~]# ss -antl</span><br><span class="line">State      Recv-Q Send-Q   Local Address:Port                  Peer Address:Port</span><br><span class="line">LISTEN     0      128                  *:80                               *:*</span><br><span class="line">LISTEN     0      128                  *:22                               *:*</span><br><span class="line">LISTEN     0      100          127.0.0.1:25                               *:*</span><br><span class="line">LISTEN     0      128                 :::22                              :::*</span><br><span class="line">LISTEN     0      100                ::1:25                              :::*</span><br></pre></td></tr></table></figure>

<h2 id="6-nginx的配置文件详解"><a href="#6-nginx的配置文件详解" class="headerlink" title="6 nginx的配置文件详解"></a>6 nginx的配置文件详解</h2><p>主配置文件：/usr/local/nginx/conf/nginx.conf</p>
<ul>
<li>默认启动nginx时，使用的配置文件是：安装路径/conf/nginx.conf文件</li>
<li>可以在启动nginx时通过-c选项来指定要读取的配置文件</li>
</ul>
<p><strong>nginx常见的配置文件及其作用</strong></p>
<table>
<thead>
<tr>
<th>配置文件</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td>nginx.conf</td>
<td>nginx的基本配置文件</td>
</tr>
<tr>
<td>mime.types</td>
<td>MIME类型关联的扩展文件</td>
</tr>
<tr>
<td>fastcgi.conf</td>
<td>与fastcgi相关的配置</td>
</tr>
<tr>
<td>proxy.conf</td>
<td>与proxy相关的配置</td>
</tr>
<tr>
<td>sites.conf</td>
<td>配置nginx提供的网站，包括虚拟主机</td>
</tr>
</tbody></table>
<h3 id="6-1-nginx-conf配置详解"><a href="#6-1-nginx-conf配置详解" class="headerlink" title="6.1 nginx.conf配置详解"></a>6.1 nginx.conf配置详解</h3><p>nginx.conf的内容分为以下几段：</p>
<ul>
<li>main配置段：全局配置段。其中main配置段中可能包含event配置段</li>
<li>event {}：定义event模型工作特性</li>
<li>http {}：定义http协议相关的配置</li>
</ul>
<p>配置指令：要以分号结尾，语法格式如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">derective value1 [value2 ...]</span><br></pre></td></tr></table></figure>

<p>支持使用变量：</p>
<ul>
<li>内置变量：模块会提供内建变量定义</li>
<li>自定义变量：<code>set var_name value</code></li>
</ul>
<h3 id="6-2-用于调试、定位问题的配置参数"><a href="#6-2-用于调试、定位问题的配置参数" class="headerlink" title="6.2 用于调试、定位问题的配置参数"></a>6.2 用于调试、定位问题的配置参数</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">daemon &#123;on|off&#125;;    //是否以守护进程方式运行nginx，调试时应设置为off</span><br><span class="line">master_process &#123;on|off&#125;;    //是否以master/worker模型来运行nginx，调试时可以设置为off</span><br><span class="line">error_log 位置 级别;    //配置错误日志</span><br></pre></td></tr></table></figure>

<p>error_log里的位置和级别能有以下可选项：</p>
<table>
<thead>
<tr>
<th>位置</th>
<th>级别</th>
</tr>
</thead>
<tbody><tr>
<td>file stderr syslog:server=address[,parameter=value] memory:size</td>
<td>debug：若要使用debug级别，需要在编译nginx时使用–with-debug选项 info notice warn error crit alert emerg</td>
</tr>
</tbody></table>
<h3 id="6-3-正常运行必备的配置参数"><a href="#6-3-正常运行必备的配置参数" class="headerlink" title="6.3 正常运行必备的配置参数"></a>6.3 正常运行必备的配置参数</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">user USERNAME [GROUPNAME];    //指定运行worker进程的用户和组</span><br><span class="line">pid /path/to/pid_file;    //指定nginx守护进程的pid文件</span><br><span class="line">worker_rlimit_nofile number;    //设置所有worker进程最大可以打开的文件数，默认为1024(最大65535,这里设置了65535后,并不能就可以打开65535个了,还要设置/etc/security/limits.conf文件里面的参数nofile,让nginx可以打开65535个文件,也就是说,这里设置的数字会比系统限制小,要想大,就先加大系统限制)</span><br><span class="line">worker_rlimit_core size;    //指明所有worker进程所能够使用的总体的最大核心文件大小，保持默认即可</span><br></pre></td></tr></table></figure>

<h3 id="6-4-优化性能的配置参数"><a href="#6-4-优化性能的配置参数" class="headerlink" title="6.4 优化性能的配置参数"></a>6.4 优化性能的配置参数</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">worker_processes n;    //启动n个worker进程，这里的n为了避免上下文切换，通常设置为cpu总核心数减1或等于总核心数</span><br><span class="line">worker_cpu_affinity cpumask ...;    //将进程绑定到某cpu中，避免频繁刷新缓存</span><br><span class="line">//cpumask：使用8位二进制表示cpu核心，如：</span><br><span class="line">    0000 0001   //第一颗cpu核心</span><br><span class="line">    0000 0010   //第二颗cpu核心</span><br><span class="line">    0000 0100   //第三颗cpu核心</span><br><span class="line">    0000 1000   //第四颗cpu核心</span><br><span class="line">    0001 0000   //第五颗cpu核心</span><br><span class="line">    0010 0000   //第六颗cpu核心</span><br><span class="line">    0100 0000   //第七颗cpu核心</span><br><span class="line">    1000 0000   //第八颗cpu核心</span><br><span class="line">timer_resolution interval;    //计时器解析度。降低此值，可减少gettimeofday()系统调用的次数</span><br><span class="line">worker_priority number;    //指明worker进程的nice值(-20到19,一般是0)</span><br></pre></td></tr></table></figure>

<h3 id="6-5-事件相关的配置：event-段中的配置参数"><a href="#6-5-事件相关的配置：event-段中的配置参数" class="headerlink" title="6.5 事件相关的配置：event{}段中的配置参数"></a>6.5 事件相关的配置：event{}段中的配置参数</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">accept_mutex &#123;off|on&#125;;    //master调度用户请求至各worker进程时使用的负载均衡锁；on表示能让多个worker轮流地、序列化地去响应新请求,要启动on配置则要设置下面这个锁文件</span><br><span class="line">lock_file file;    //accept_mutex用到的互斥锁锁文件路径(这个参数要放前面的全局配置段,否则语法错误)</span><br><span class="line">use [epoll | rtsig | select | poll];    //指明使用的事件模型，建议让nginx自行选择</span><br><span class="line">worker_connections #;    //每个进程能够接受的最大连接数(看worker数量,例如最大5万链接,有4个worker,则这里可以设置5120-10240,总量也就是2万到4万链接,不要满负载运行)</span><br></pre></td></tr></table></figure>

<h3 id="6-6-网络连接相关的配置参数"><a href="#6-6-网络连接相关的配置参数" class="headerlink" title="6.6 网络连接相关的配置参数"></a>6.6 网络连接相关的配置参数</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">keepalive_timeout number;    //长连接的超时时长，默认为65s(问题:请求资源过大,还没传输完,时间超时,断开链接,如此重复.解决方法:提高带宽,压缩资源,加长超时时长)</span><br><span class="line">keepalive_requests number;    //在一个长连接上所能够允许请求的最大资源数</span><br><span class="line">keepalive_disable [msie6|safari|none];    //为指定类型的UserAgeng禁用长连接(列出来才会禁用)</span><br><span class="line">tcp_nodelay on|off;    //是否对长连接使用TCP_NODELAY选项，为了提升用户体验，通常设为on(也就是不延迟)</span><br><span class="line">client_header_timeout number;    //读取http请求报文首部的超时时长</span><br><span class="line">client_body_timeout number;    //读取http请求报文body部分的超时时长</span><br><span class="line">send_timeout number;    //发送响应报文的超时时长</span><br></pre></td></tr></table></figure>

<h3 id="6-7-fastcgi的相关配置参数"><a href="#6-7-fastcgi的相关配置参数" class="headerlink" title="6.7 fastcgi的相关配置参数"></a>6.7 fastcgi的相关配置参数</h3><p>LNMP：php要启用fpm模型<br>配置示例如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">location ~ \.php$ &#123;</span><br><span class="line">  root html;</span><br><span class="line">  fastcgi_pass 127.0.0.1:9000;      //定义反向代理</span><br><span class="line">  fastcgi_index index.php;</span><br><span class="line">  fastcgi_param SCRIPT_FILENAME /scripts$fastcgi_script_name;</span><br><span class="line">  include fastcgi_params;</span><br><span class="line">&#125;</span><br><span class="line">这里的/scripts一般改成$document_root也就是网站默认家目录(变量名字做到见名知义)</span><br><span class="line">开头是只匹配.php结尾的文件</span><br></pre></td></tr></table></figure>

<h3 id="6-8-常需要进行调整的参数"><a href="#6-8-常需要进行调整的参数" class="headerlink" title="6.8 常需要进行调整的参数"></a>6.8 常需要进行调整的参数</h3><ul>
<li>worker_processes</li>
<li>worker_connections</li>
<li>worker_cpu_affinity</li>
<li>worker_priority</li>
</ul>
<h3 id="6-9-nginx作为web服务器时使用的配置：http-段的配置参数"><a href="#6-9-nginx作为web服务器时使用的配置：http-段的配置参数" class="headerlink" title="6.9 nginx作为web服务器时使用的配置：http{}段的配置参数"></a>6.9 nginx作为web服务器时使用的配置：http{}段的配置参数</h3><p>http{…}：配置http相关，由ngx_http_core_module模块引入。nginx的HTTP配置主要包括四个区块，结构如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">http &#123;//协议级别,这个配置文件只有一个http&#123;&#125;,所以,想配置虚拟主机,可以&apos;sed -ri /^http/a&quot;\ \ \ \ include\ \ \ \ \ \ \ vhost.types;&quot; /usr/local/nginx/conf/nginx.conf&apos;在同级目录下加一个vhost.types写虚拟主机配置</span><br><span class="line">  include mime.types;</span><br><span class="line">  default_type application/octet-stream;</span><br><span class="line">  keepalive_timeout 65;</span><br><span class="line">  gzipon;</span><br><span class="line">  upstream &#123;//负载均衡配置</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line">  server &#123;//服务器级别，每个server类似于httpd中的一个&lt;VirtualHost&gt;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name localhost;</span><br><span class="line">    location / &#123;//请求级别，类似于httpd中的&lt;Location&gt;，用于定义URL与本地文件系统的映射关系</span><br><span class="line">      root html;(这里的html是&apos;location /&apos;的&apos;/&apos;,要理清路径关系,比如要访问html/haha则可写成location /haha&#123;root html;...&#125;)</span><br><span class="line">      index index.html index.htm;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>http{}段配置指令：</strong></p>
<p>server {}：定义一个虚拟主机，示例如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">  listen 80;(必须有的参数,也可以放在http&#123;里面&#125;,这样的话,http里面的主机都监听Listen的端口) </span><br><span class="line">  server_name itw.design;</span><br><span class="line">  root &quot;/vhosts/web&quot;;(这里用的绝对路径)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>listen：指定监听的地址和端口</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">listen address[:port];</span><br><span class="line">listen port;</span><br></pre></td></tr></table></figure>

<p><code>server_name NAME [...];</code> 后面可跟多个主机，名称可使用正则表达式或通配符</p>
<p><strong>当有多个server时，匹配顺序如下(相当于匹配优先级)：</strong></p>
<ol>
<li>先做精确匹配检查</li>
<li>左侧通配符匹配检查，如<code>*.design</code></li>
<li>右侧通配符匹配检查，如<code>mail.*</code></li>
<li>正则表达式匹配检查，如<code>~ ^.*\.design$</code></li>
<li>default_server</li>
</ol>
<p><code>root path;</code> 设置资源路径映射，用于指明请求的URL所对应的资源所在的文件系统上的起始路径</p>
<p><code>alias path;</code> 用于location配置段，定义路径别名,要写全路径(用于没有修饰符的情况下)</p>
<p><code>index file;</code> 默认主页面</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">index index.php index.html;</span><br><span class="line">error_page code [...] [=code] URI | @name` 根据http响应状态码来指明特用的错误页面，例如 `error_page 404 /404_customed.html</span><br><span class="line">这个错误网页放在默认网页根下,也就是html下</span><br></pre></td></tr></table></figure>

<p>[=code]：以指定的响应码进行响应，而不是默认的原来的响应，默认表示以新资源的响应码为其响应码，例如 <code>error_page 404 =200 /404_customed.html</code></p>
<p><code>log_format</code> 定义日志格式</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">log_format  main  &apos;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &apos;</span><br><span class="line">                    &apos;$status $body_bytes_sent &quot;$http_referer&quot; &apos;</span><br><span class="line">                    &apos;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&apos;;</span><br><span class="line">access_log  logs/access.log  main;</span><br><span class="line"></span><br><span class="line">//注意：此处可用变量为nginx各模块内建变量,内建变量可自行百度</span><br></pre></td></tr></table></figure>

<p><strong>location区段，通过指定模式来与客户端请求的URI相匹配</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">//功能：允许根据用户请求的URI来匹配定义的各location，匹配到时，此请求将被相应的location配置块中的配置所处理，例如做访问控制等功能</span><br><span class="line"></span><br><span class="line">//语法：location [ 修饰符 ] pattern &#123;......&#125;</span><br></pre></td></tr></table></figure>

<p><strong>常用修饰符说明：</strong></p>
<table>
<thead>
<tr>
<th>修饰符</th>
<th>功能</th>
</tr>
</thead>
<tbody><tr>
<td>=</td>
<td>精确匹配</td>
</tr>
<tr>
<td>~</td>
<td>正则表达式模式匹配，区分大小写</td>
</tr>
<tr>
<td>~*</td>
<td>匹配文件后缀名称</td>
</tr>
<tr>
<td>^~</td>
<td>前缀匹配，类似于无修饰符的行为，也是以指定模块开始，不同的是，如果模式匹配，那么就停止搜索其他模式了，不支持正则表达式</td>
</tr>
<tr>
<td>@</td>
<td>定义命名location区段，这些区段客户端不能访问，只可以由内部产生的请求来访问，如try_files或error_page等</td>
</tr>
</tbody></table>
<p><strong>没有修饰符表示必须以指定模式开始</strong>，如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">  server_name itw.design;</span><br><span class="line">  location /abc &#123;</span><br><span class="line">    ......</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>那么如下内容就可正确匹配：</p>
<ul>
<li><a href="http://itw.design/abc" target="_blank" rel="noopener">http://itw.design/abc</a></li>
<li><a href="http://itw.design/abc?p1=11&amp;p2=22" target="_blank" rel="noopener">http://itw.design/abc?p1=11&amp;p2=22</a></li>
<li><a href="http://itw.design/abc/" target="_blank" rel="noopener">http://itw.design/abc/</a></li>
</ul>
<p><strong>=：表示必须与指定的模式精确匹配</strong>，如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">  server_name itw.design;</span><br><span class="line">  location = /abc &#123;</span><br><span class="line">    ......</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>那么如下内容就可正确匹配：</p>
<ul>
<li><a href="http://itw.design/abc" target="_blank" rel="noopener">http://itw.design/abc</a></li>
<li><a href="http://itw.design/abc?p1=11&amp;p2=22" target="_blank" rel="noopener">http://itw.design/abc?p1=11&amp;p2=22</a></li>
</ul>
<p>如下内容则无法匹配：</p>
<ul>
<li><p><a href="http://itw.design/abc/" target="_blank" rel="noopener">http://itw.design/abc/</a></p>
</li>
<li><p><a href="http://itw.design/abc/abcde" target="_blank" rel="noopener">http://itw.design/abc/abcde</a></p>
</li>
</ul>
<p><strong>~：表示指定的正则表达式要区分大小写</strong>，如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">  server_name itw.design;</span><br><span class="line">  location ~ ^/abc$ &#123;</span><br><span class="line">  ......</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>那么如下内容就可正确匹配：</p>
<ul>
<li><a href="http://itw.design/abc" target="_blank" rel="noopener">http://itw.design/abc</a></li>
<li><a href="http://itw.design/abc?p1=11&amp;p2=22" target="_blank" rel="noopener">http://itw.design/abc?p1=11&amp;p2=22</a></li>
</ul>
<p>如下内容则无法匹配：</p>
<ul>
<li><a href="http://itw.design/abc/" target="_blank" rel="noopener">http://itw.design/abc/</a></li>
<li><a href="http://itw.design/ABC" target="_blank" rel="noopener">http://itw.design/ABC</a></li>
<li><a href="http://itw.design/abcde" target="_blank" rel="noopener">http://itw.design/abcde</a></li>
</ul>
<p><strong>~*：表示指定的正则表达式不区分大小写</strong>，如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">  server_name itw.design;</span><br><span class="line">  location ~* ^/*.jpg$ &#123;</span><br><span class="line">    ......</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>那么如下内容就可正确匹配：</p>
<ul>
<li><a href="http://itw.design/1.jpg" target="_blank" rel="noopener">http://itw.design/1.jpg</a></li>
</ul>
<p>如下内容则无法匹配：</p>
<ul>
<li><a href="http://itw.design/abc/" target="_blank" rel="noopener">http://itw.design/abc/</a></li>
<li><a href="http://itw.design/abcde" target="_blank" rel="noopener">http://itw.design/abcde</a></li>
</ul>
<p><strong>~：类似于无修饰符的行为，也是以指定模式开始，不同的是，如果模式匹配，则停止搜索其他模式</strong></p>
<p><strong>查找顺序和优先级：由高到底依次为</strong></p>
<ol>
<li>带有<code>=</code>的精确匹配优先</li>
<li>正则表达式按照他们在配置文件中定义的顺序</li>
<li>带有<code>^~</code>修饰符的，开头匹配</li>
<li>带有<code>~</code>或<code>~*</code>修饰符的，如果正则表达式与URI匹配</li>
<li>没有修饰符的精确匹配</li>
</ol>
<p><strong>优先级次序如下：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">( location = 路径 ) --&gt; ( location ^~ 路径 ) --&gt; ( location ~ 正则 ) --&gt; ( location ~* 正则 ) --&gt; ( location 路径 )</span><br></pre></td></tr></table></figure>

<h3 id="6-10-访问控制"><a href="#6-10-访问控制" class="headerlink" title="6.10 访问控制"></a>6.10 访问控制</h3><p><strong>用于location段</strong></p>
<p>allow：设定允许哪台或哪些主机访问，多个参数间用空格隔开<br>deny：设定禁止哪台或哪些主机访问，多个参数间用空格隔开<br>示例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">allow 192.168.1.1/32 172.16.0.0/16;</span><br><span class="line">deny all;</span><br></pre></td></tr></table></figure>

<h3 id="6-11-基于用户认证"><a href="#6-11-基于用户认证" class="headerlink" title="6.11 基于用户认证"></a>6.11 基于用户认证</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">auth_basic &quot;欢迎信息&quot;;</span><br><span class="line">auth_basic_user_file &quot;/path/to/user_auth_file&quot;</span><br></pre></td></tr></table></figure>

<p>user_auth_file内容格式为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">username:password</span><br></pre></td></tr></table></figure>

<p>这里的密码为加密后的密码串，建议用htpasswd来创建此文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">htpasswd -c -m /path/to/.user_auth_file USERNAME</span><br></pre></td></tr></table></figure>

<h3 id="6-12-https配置"><a href="#6-12-https配置" class="headerlink" title="6.12 https配置"></a>6.12 https配置</h3><p>生成私钥，生成证书签署请求并获得证书，然后在nginx.conf中配置如下内容：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">  listen       443 ssl;</span><br><span class="line">  server_name  itw.design;</span><br><span class="line">  ssl_certificate      /etc/nginx/ssl/nginx.crt;(可用绝对路径,也可相对路径)</span><br><span class="line">  ssl_certificate_key  /etc/nginx/ssl/nginx.key;</span><br><span class="line">  ssl_session_cache    shared:SSL:1m;</span><br><span class="line">  ssl_session_timeout  5m;</span><br><span class="line">  ssl_ciphers  HIGH:!aNULL:!MD5;</span><br><span class="line">  ssl_prefer_server_ciphers  on;</span><br><span class="line">  location / &#123;</span><br><span class="line">    root   html;</span><br><span class="line">    index  index.html index.htm;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="6-13-开启状态界面"><a href="#6-13-开启状态界面" class="headerlink" title="6.13 开启状态界面"></a>6.13 开启状态界面</h3><p>开启status：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">location /status &#123;</span><br><span class="line">  stub_status &#123;on | off&#125;;</span><br><span class="line">  allow 192.168.0.0/16;最好是只允许自己主机访问:ip/32掩码</span><br><span class="line">  deny all;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">自定义监控取驻留连接值(越小越好):curl -s http://server_ip/status|awk &apos;NR==4 &#123;print $NF&#125;&apos;</span><br><span class="line">例如:</span><br><span class="line">[root@localhost ~]# curl -s http://192.168.153.130/status</span><br><span class="line">Active connections: 1 </span><br><span class="line">server accepts handled requests</span><br><span class="line"> 32 32 62 </span><br><span class="line">Reading: 0 Writing: 1 Waiting: 0 </span><br><span class="line">[root@localhost ~]# curl -s http://192.168.153.130/status|awk &apos;NR==4 &#123;print $NF&#125;&apos;</span><br><span class="line">0</span><br></pre></td></tr></table></figure>

<p>访问状态页面的方式：<code>http://server_ip/status</code></p>
<p><img src="../../img/1560156311954.png" alt="1560156311954"></p>
<p><a href="https://blog.csdn.net/wenhs5479/article/details/90514799" target="_blank" rel="noopener">添加自定义监控</a></p>
<p>修改/usr/local/etc/zabbix_agentd.conf配置文件</p>
<p><img src="../../img/1560160474474.png" alt="1560160474474"></p>
<p>然后配置主机监控项,添加触发器,和告警媒介,最后再选择用户配置媒介选项,实现下图告警</p>
<p><img src="../../img/1560161618173.png" alt="1560161618173"></p>
<p><img src="../../img/1560161322272.png" alt="1560161322272"></p>
<p><strong>状态页面信息详解：</strong></p>
<table>
<thead>
<tr>
<th align="center">状态码</th>
<th align="left">表示的意义</th>
</tr>
</thead>
<tbody><tr>
<td align="center">Active connections</td>
<td align="left">当前所有处于打开状态的连接数</td>
</tr>
<tr>
<td align="center">accepts</td>
<td align="left">总共处理了多少个连接</td>
</tr>
<tr>
<td align="center">handled</td>
<td align="left">成功创建多少握手</td>
</tr>
<tr>
<td align="center">requests</td>
<td align="left">总共处理了多少个请求</td>
</tr>
<tr>
<td align="center">Reading</td>
<td align="left">nginx读取到客户端的Header信息数，表示正处于接收请求状态的连接数</td>
</tr>
<tr>
<td align="center">Writing</td>
<td align="left">nginx返回给客户端的Header信息数，表示请求已经接收完成， 且正处于处理请求或发送响应的过程中的连接数</td>
</tr>
<tr>
<td align="center">Waiting</td>
<td align="left">开启keep-alive的情况下，这个值等于active - (reading + writing)， 意思就是Nginx已处理完正在等候下一次请求指令的驻留连接</td>
</tr>
</tbody></table>
<h3 id="6-14-rewrite"><a href="#6-14-rewrite" class="headerlink" title="6.14 rewrite"></a>6.14 rewrite</h3><p>语法：<code>rewrite regex replacement flag;</code></p>
<p>案例1：原访问地址<a href="http://server_ip/images/1.jpg,但是个别原因,这个images要更名为img,这时有以下几种方法,解决客户访问原地址,仍然访问正确资源[此处的$1用于引用(.*.jpg)匹配到的内容]" target="_blank" rel="noopener">http://server_ip/images/1.jpg,但是个别原因,这个images要更名为img,这时有以下几种方法,解决客户访问原地址,仍然访问正确资源[此处的$1用于引用(.*.jpg)匹配到的内容]</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">在nginx.conf添加下列定位</span><br><span class="line">location /images &#123;</span><br><span class="line">                rewrite ^/images/(.*\.jpg)$ /img/$1 break;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p><img src="../../img/1560163229362.png" alt="1560163229362"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">在nginx.conf添加下列定位(这个会重写客户端的url)</span><br><span class="line">location /images &#123;</span><br><span class="line">                rewrite ^/images/(.*\.jpg)$ http://192.168.153.130/img/$1 break;</span><br><span class="line">        &#125;</span><br><span class="line">location /img &#123;</span><br><span class="line">                root html;</span><br><span class="line">        &#125;</span><br><span class="line">一开始访问http://192.168.153.130/images/1.jpg,自动跳转到http://192.168.153.130/img/1.jpg</span><br></pre></td></tr></table></figure>

<p><img src="../../img/1560163656438.png" alt="1560163656438"></p>
<p>案例2:某公司域名太长或不容易记,便可借别人短域名,做一个短网址</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">在nginx.conf添加下列定位(这个会重写客户端的url)</span><br><span class="line">location /blog &#123;</span><br><span class="line">                rewrite ^/blog/(.*)$ https://itwhs.github.io/index.html redirect;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p>如上例所示，replacement可以是某个路径，也可以是某个URL</p>
<p><img src="../../img/1560164873261.png" alt="1560164873261"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">在nginx.conf添加下列定位(这个会重写客户端的url)</span><br><span class="line">location /blog &#123;</span><br><span class="line">                rewrite ^/blog/(.*)$ https://itwhs.github.io/index.html redirect;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p><img src="../../img/1560165070278.png" alt="1560165070278"></p>
<p><strong>常见的flag</strong></p>
<table>
<thead>
<tr>
<th align="center">flag</th>
<th align="left">作用</th>
</tr>
</thead>
<tbody><tr>
<td align="center">last</td>
<td align="left">基本上都用这个flag，表示当前的匹配结束，继续下一个匹配，最多匹配10个到20个 一旦此rewrite规则重写完成后，就不再被后面其它的rewrite规则进行处理 而是由UserAgent重新对重写后的URL再一次发起请求，并从头开始执行类似的过程</td>
</tr>
<tr>
<td align="center">break</td>
<td align="left">中止Rewrite，不再继续匹配 一旦此rewrite规则重写完成后，由UserAgent对新的URL重新发起请求， 且不再会被当前location内的任何rewrite规则所检查</td>
</tr>
<tr>
<td align="center">redirect</td>
<td align="left">以临时重定向的HTTP状态302返回新的URL</td>
</tr>
<tr>
<td align="center">permanent</td>
<td align="left">以永久重定向的HTTP状态301返回新的URL</td>
</tr>
</tbody></table>
<p>rewrite模块的作用是用来执行URL重定向。这个机制有利于去掉恶意访问的url，也有利于搜索引擎优化（SEO）</p>
<p>nginx使用的语法源于Perl兼容正则表达式（PCRE）库，基本语法如下：</p>
<table>
<thead>
<tr>
<th align="center">标识符</th>
<th align="left">意义</th>
</tr>
</thead>
<tbody><tr>
<td align="center">^</td>
<td align="left">必须以^后的实体开头</td>
</tr>
<tr>
<td align="center">$</td>
<td align="left">必须以$前的实体结尾</td>
</tr>
<tr>
<td align="center">.</td>
<td align="left">匹配任意字符</td>
</tr>
<tr>
<td align="center">[]</td>
<td align="left">匹配指定字符集内的任意字符</td>
</tr>
<tr>
<td align="center">[^]</td>
<td align="left">匹配任何不包括在指定字符集内的任意字符串</td>
</tr>
<tr>
<td align="center">|</td>
<td align="left">匹配 | 之前或之后的实体</td>
</tr>
<tr>
<td align="center">()</td>
<td align="left">分组，组成一组用于匹配的实体，通常会有 | 来协助</td>
</tr>
</tbody></table>
<p>捕获子表达式，可以捕获放在()之间的任何文本，比如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">^(hi|sir)$       //字符串为“hi sir”捕获的结果：$1=hi$2=sir</span><br><span class="line"></span><br><span class="line">//这些被捕获的数据，在后面就可以当变量一样使用了</span><br></pre></td></tr></table></figure>

<p>不写last和break - 那么流程就是依次执行这些rewrite</p>
<p><strong>使用last和break实现URI重写，浏览器地址栏不变</strong></p>
<ul>
<li>break - url重写后，直接使用当前资源，不再执行location里余下的语句，完成本次请求，地址栏url不变</li>
<li>last - url重写后，马上发起一个新的请求，再次进入server块，重试location匹配，超过10次匹配不到报500错误，地址栏url不变。牢记：使用last会对server标签重新发起请求</li>
</ul>
<p>使用redirect 和permanent 实现URI重写，浏览器以返回的新地址重新发起请求</p>
<ul>
<li>redirect – 返回302临时重定向，地址栏显示重定向后的url，爬虫不会更新url（因为是临时）</li>
<li>permanent – 返回301永久重定向, 地址栏显示重定向后的url，爬虫更新url</li>
</ul>
<h4 id="last-和-break-总结如下："><a href="#last-和-break-总结如下：" class="headerlink" title="last 和 break 总结如下："></a>last 和 break 总结如下：</h4><p><strong>1、last 和 break 当出现在location 之外时，两者的作用是一致的没有任何差异</strong>。</p>
<p>注意一点就是，他们会跳过所有的在他们之后的rewrite 模块中的指令，去选择自己匹配的location</p>
<p>rewrite url1 url2 last; ①</p>
<p>rewrite url3 url4 last; ②</p>
<p>rewrite url5 url6 last; ③</p>
<p>location ~ url2 ④</p>
<p>location ~ url4 ⑤</p>
<p>location ~ url6 ⑥</p>
<p>当① 这条rewrite 规则生效后，它后面的②和③ 将被跳过不做判断，而去直接选择 后面的location。</p>
<p>这里可能有一个疑问，那些指令输入rewrite 模块中的指令呢？ 若是使用nginx本身，你就要到官网上去查询了。</p>
<p>但如果你使用的是tengine ，可以使用tengine -V 。会将你想要的信息列举出来。</p>
<p>放在server块rewrite语句前面 ：如果是直接请求某个真实存在的文件,则用break语句停止rewrite检查</p>
<p>if (-f $request_filename) {</p>
<p>break;</p>
<p>}</p>
<p><strong>2、last 和 break 当出现在location 内部时，两者就存在了差异。</strong></p>
<p>last: 使用了last 指令，rewrite 后会跳出location 作用域，重新开始再走一次刚刚的行为break: 使用了break 指令，rewrite后不会跳出location 作用域。它的生命也在这个location中终结。</p>
<p>rewrite xxx1 yyy last; ⑦</p>
<p>rewrite xxx2 yyy last; ⑧</p>
<p>rewrite xxx3 yyy last; ⑨</p>
<p>rewrite xxx4 yyy last; ⑩</p>
<p>location ~ url1 {</p>
<p>rewrite url1 url2 last; ①</p>
<p>}</p>
<p>location ~ url2 {</p>
<p>rewrite url3 url4 break; ②</p>
<p>fastcgi_pass 127.0.0.1:9000;</p>
<p>}</p>
<p>以上事例：</p>
<p>第一个location 中的 rewrite 指令处理完成之后，会跳出location ，再重新判断rewrite 7 ~ 9 的规则。</p>
<p>第二个location 中的 rewrite 指令处理完成之后，不会跳出location， 更不会重新判断rewrite 7 ~ 9 的规则。而只能将</p>
<p>信息传递给后面的fastcgi_pass 或者proxy_pass 等指令</p>
<p>牢记：使用last会对server标签重新发起请求</p>
<ul>
<li>如果location中rewrite后是对静态资源的请求，不需要再进行其他匹配，一般要使用break或不写，直接使用当前location中的数据源，完成本次请求</li>
<li>如果location中rewrite后，还需要进行其他处理，如动态fastcgi请求(.php,.jsp)等，要用last继续发起新的请求</li>
<li>使用alias指定源：必须使用last</li>
<li>使用proxy_pass指令时，需要使用break标记。</li>
</ul>
<h4 id="permanent-和-redirect-总结如下："><a href="#permanent-和-redirect-总结如下：" class="headerlink" title="permanent 和 redirect 总结如下："></a>permanent 和 redirect 总结如下：</h4><p><strong>permanent</strong>: 大家公认的信息 ，永久性重定向。请求日志中的状态码为301</p>
<p><strong>redirect</strong>： 大家公认的信息 ，临时重定向。请求日志中的状态码为302</p>
<p>从实现功能的角度上去看，permanent 和 redirect 是一样的。不存在哪里好，哪里坏。也不存在什么性能上的问题。</p>
<p>但从SEO(或者是百度爬你的网站时)。 类似于这样的东西，会对你到底是永久性重定向还是临时重定向感兴趣。了解不到，需要深入，就google 吧。</p>
<h4 id="last-和-break-VS-permanent-和-redirect"><a href="#last-和-break-VS-permanent-和-redirect" class="headerlink" title="last 和 break VS permanent 和 redirect"></a>last 和 break VS permanent 和 redirect</h4><p>在 permanent 和 redirect 中提到了 状态码 301 和 302。 那么last 和 break 想对于的访问日志的请求状态码又是多少呢？</p>
<p>答案为： 200</p>
<p>这两类关键字，我们能够眼睛看到的差异是什么呢？ 我举个例子说明吧：</p>
<p>当你打开一个网页，同时打开debug 模式时，会发现301 和 302 时的行为是这样的。第一个请求301 或者 302 后，浏览器重新获取了一个新的URL ，然后会对这个新的URL 重新进行访问。所以当你配置的是permanent 和 redirect ,你对一个URL 的访问请求，落到服务器上至少为2次。</p>
<p>而当你配置了last 或者是break 时，你最终的URL 确定下来后，不会将这个URL返回给浏览器，而是将其扔给了fastcgi_pass或者是proxy_pass指令去处理。请求一个URL ，落到服务器上的次数就为1次。</p>
<h3 id="6-15-if"><a href="#6-15-if" class="headerlink" title="6.15 if"></a>6.15 if</h3><p>语法：<code>if (condition) {...}</code></p>
<p>应用场景：</p>
<ul>
<li>server段</li>
<li>location段</li>
</ul>
<p><strong>常见的condition</strong></p>
<ul>
<li>变量名（变量值为空串，或者以“0”开始，则为false，其它的均为true）</li>
<li>以变量为操作数构成的比较表达式（可使用=，!=类似的比较操作符进行测试）</li>
<li>正则表达式的模式匹配操作<ul>
<li>~：区分大小写的模式匹配检查</li>
<li>~*：不区分大小写的模式匹配检查</li>
<li>!<del>和!</del>*：对上面两种测试取反</li>
</ul>
</li>
<li>测试指定路径为文件的可能性（-f，!-f)</li>
<li>测试指定路径为目录的可能性（-d，!-d）</li>
<li>测试文件的存在性（-e，!-e）</li>
<li>检查文件是否有执行权限（-x，!-x）</li>
</ul>
<h4 id="6-15-1-基于浏览器实现分离案例"><a href="#6-15-1-基于浏览器实现分离案例" class="headerlink" title="6.15.1 基于浏览器实现分离案例"></a>6.15.1 基于浏览器实现分离案例</h4><p>各个浏览器的排版可能会有区别,所以,前端人员会写多平台的前端页面,这时就要把这些分离</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost html]# mkdir MobileSafari MobileEdge SafariEdge Trident</span><br><span class="line">[root@localhost html]# ll</span><br><span class="line">总用量 8</span><br><span class="line">-rw-r--r-- 1 root root 494 6月  11 17:12 50x.html</span><br><span class="line">-rw-r--r-- 1 root root 612 6月  11 17:12 index.html</span><br><span class="line">drwxr-xr-x 2 root root   6 6月  11 18:23 MobileEdge</span><br><span class="line">drwxr-xr-x 2 root root   6 6月  11 18:23 MobileSafari</span><br><span class="line">drwxr-xr-x 2 root root   6 6月  11 18:23 SafariEdge</span><br><span class="line">drwxr-xr-x 2 root root   6 6月  11 18:23 Trident</span><br><span class="line">[root@localhost html]# echo &quot;MobileEdge&quot; &gt;MobileEdge/index.html</span><br><span class="line">[root@localhost html]# echo &quot;MobileSafari&quot; &gt;MobileSafari/index.html</span><br><span class="line">[root@localhost html]# echo &quot;SafariEdge&quot; &gt;SafariEdge/index.html</span><br><span class="line">[root@localhost html]# echo &quot;Trident&quot; &gt;Trident/index.html</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">location / &#123;</span><br><span class="line">    root   html;</span><br><span class="line">    index index.html;</span><br><span class="line">        if ($http_user_agent ~ &apos;Mobile Safari/537.36 Edge/14.14263&apos; ) &#123;</span><br><span class="line">                rewrite ^(.*)$ /MobileEdge/$1 break;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if ($http_user_agent ~ &quot;Mobile/15A5341f Safari/604.1&quot; ) &#123;</span><br><span class="line">                rewrite ^(.*)$ /MobileSafari/$1 break;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if ($http_user_agent ~ &quot;Chrome/64.0.3282.140 Safari/537.36 Edge/18.17763&quot; ) &#123;</span><br><span class="line">                rewrite ^(.*)$ /SafariEdge/$1 break;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if ($http_user_agent ~ Trident) &#123;</span><br><span class="line">                rewrite ^(.*)$ /Trident/$1 break;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">版本号可以直接写Chrome  Firefox  Safari  Trident等...</span><br></pre></td></tr></table></figure>

<p>效果图:</p>
<p><img src="../../img/1560250364297.png" alt="1560250364297"></p>
<p><img src="../../img/1560250305079.png" alt="1560250305079"></p>
<p><img src="../../img/1560250537948.png" alt="1560250537948"></p>
<p><img src="../../img/1560250661596.png" alt="1560250661596"></p>
<h4 id="6-15-2-防盗链案例"><a href="#6-15-2-防盗链案例" class="headerlink" title="6.15.2 防盗链案例"></a>6.15.2 防盗链案例</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">location ~* \.(jpg|gif|jpeg|png)$ &#123;</span><br><span class="line">  valid_referers none blocked itw.design;</span><br><span class="line">  if ($invalid_referer) &#123;</span><br><span class="line">    rewrite ^/ http://itw.design/403.html;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="6-16-反向代理与负载均衡"><a href="#6-16-反向代理与负载均衡" class="headerlink" title="6.16 反向代理与负载均衡"></a>6.16 反向代理与负载均衡</h3><p><code>nginx</code>通常被用作后端服务器的反向代理，这样就可以很方便的实现动静分离以及负载均衡，从而大大提高服务器的处理能力。</p>
<h4 id="扩展"><a href="#扩展" class="headerlink" title="扩展:"></a>扩展:</h4><p><strong>硬件负载均衡</strong>：</p>
<ul>
<li>F5，BIG-IP</li>
<li>Citrix NetScaler</li>
<li>A10</li>
<li>Array</li>
<li>Redware</li>
</ul>
<p><strong>软件负载均衡</strong>：</p>
<ul>
<li>lvs</li>
<li>haproxy</li>
<li>nginx</li>
<li>ats</li>
<li>perlbal</li>
</ul>
<h5 id="基于工作的协议层次划分："><a href="#基于工作的协议层次划分：" class="headerlink" title="基于工作的协议层次划分："></a>基于工作的协议层次划分：</h5><ul>
<li><p>传输层：lvs，haproxy,(mode tcp)</p>
</li>
<li><p>应用层: haproxy,nginx,ats,perlbal</p>
</li>
</ul>
<p><code>nginx</code>实现动静分离，其实就是在反向代理的时候，如果是静态资源，就直接从<code>nginx</code>发布的路径去读取，而不需要从后台服务器获取了。</p>
<p>但是要注意，这种情况下需要保证后端跟前端的程序保持一致，可以使用<code>Rsync</code>做服务端自动同步或者使用<code>NFS</code>、<code>MFS</code>分布式共享存储。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Http Proxy`模块，功能很多，最常用的是`proxy_pass`和`proxy_cache</span><br></pre></td></tr></table></figure>

<p>如果要使用<code>proxy_cache</code>，需要集成第三方的<code>ngx_cache_purge</code>模块，用来清除指定的URL缓存。这个集成需要在安装<code>nginx</code>的时候去做，如：<br><code>./configure --add-module=../ngx_cache_purge-1.0 ......</code></p>
<p><code>nginx</code>通过<code>upstream</code>模块来实现简单的负载均衡，<code>upstream</code>需要定义在<code>http</code>段内</p>
<p>在<code>upstream</code>段内，定义一个服务器列表，默认的方式是轮询，如果要确定同一个访问者发出的请求总是由同一个后端服务器来处理，可以设置ip_hash，如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">准备工作:</span><br><span class="line">[root@localhost html]# mkdir 8080 8090 800 8000</span><br><span class="line">[root@localhost html]# echo 8080 &gt;8080/index.html</span><br><span class="line">[root@localhost html]# echo 800 &gt;800/index.html</span><br><span class="line">[root@localhost html]# echo 8090 &gt;8090/index.html</span><br><span class="line">[root@localhost html]# echo 8000 &gt;8000/index.html</span><br><span class="line">[root@localhost html]# vim /usr/local/nginx17/conf/nginx.conf</span><br><span class="line">    server &#123;</span><br><span class="line">        listen 800;</span><br><span class="line">        location / &#123;</span><br><span class="line">            root   html/800;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    server &#123;</span><br><span class="line">        listen 8000;</span><br><span class="line">        location / &#123;</span><br><span class="line">            root   html/8000;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    server &#123;</span><br><span class="line">        listen 8080;</span><br><span class="line">        location / &#123;</span><br><span class="line">            root   html/8080;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    server &#123;</span><br><span class="line">        listen 8090;</span><br><span class="line">        location / &#123;</span><br><span class="line">            root   html/8090;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    upstream 192.168.153.130 &#123;</span><br><span class="line">        server 127.0.0.1:800 weight=4;</span><br><span class="line">        server 127.0.0.1:8000 weight=3;</span><br><span class="line">        server 127.0.0.1:8080 weight=2;</span><br><span class="line">        server 127.0.0.1:8090;</span><br><span class="line">    &#125;</span><br><span class="line">    server &#123;</span><br><span class="line">        location / &#123;</span><br><span class="line">    proxy_pass http://192.168.153.130;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">这里的weight=n是权重,也就是800端口4个请求;8000端口3个请求;8080端口2个请求;8090端口1个请求,这里的&apos;192.168.153.130&apos;可换做公司域名,&apos;127.0.0.1&apos;可换做集群中其他主机ip地址,权重按需求和机器性能,合理配置</span><br><span class="line">修改后:</span><br><span class="line">upstream 192.168.153.130 &#123;</span><br><span class="line">        ip_hash;</span><br><span class="line">        server 127.0.0.1:800 weight=4;</span><br><span class="line">        server 127.0.0.1:8000 weight=3;</span><br><span class="line">        server 127.0.0.1:8080 weight=2;</span><br><span class="line">        server 127.0.0.1:8090;</span><br><span class="line">    &#125;</span><br><span class="line">这种修改后,用本机验证一直是其中一个虚拟主机页面,没有再更改</span><br></pre></td></tr></table></figure>

<p>注意：这个方法本质还是轮询，而且由于客户端的ip可能是不断变化的，比如动态ip，代理，翻墙等，因此ip_hash并不能完全保证同一个客户端总是由同一个服务器来处理。</p>
<p>定义好<code>upstream</code>后，需要在<code>server</code>段内添加如下内容：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">  location / &#123;</span><br><span class="line">    proxy_pass http://域名或IP;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="../../img/20190612_155350.gif" alt="验证"></p>
<h3 id="6-17-nginx内置变量"><a href="#6-17-nginx内置变量" class="headerlink" title="6.17 nginx内置变量"></a>6.17 nginx内置变量</h3><p>内置变量存放在 ngx_http_core_module 模块中，下面我来把这些变量分类记忆下，这里包括日常运维的内置变量讲解</p>
<h4 id="6-17-1-nginx地址栏系统内置变量匹配"><a href="#6-17-1-nginx地址栏系统内置变量匹配" class="headerlink" title="6.17.1 nginx地址栏系统内置变量匹配"></a>6.17.1 nginx地址栏系统内置变量匹配</h4><p>以<a href="https://itwhs.github.io/index.php?m=content&amp;c=index&amp;a=lists&amp;catid=110" target="_blank" rel="noopener">https://itwhs.github.io/index.php?m=content&amp;c=index&amp;a=lists&amp;catid=110</a>的匹配顺序为例：</p>
<p><strong>$scheme</strong> 请求使用的Web协议, “http” 或 “https”</p>
<p><strong>$host</strong> 请求中的主机头(Host)字段，如果请求中的主机头不可用或者空，则为处理请求的server名称(处理请求的server的server_name指令的值)。值为小写，不包含端口。</p>
<p><strong>$hostname</strong> 主机名，机器名使用 gethostname系统调用的值</p>
<p><strong>$document_uri</strong> 与$uri相同。请求中的当前URI(不带请求参数，参数位于$args)，可以不同于浏览器传递的$request_uri的值，它可以通过内部重定向，或者使用index指令进行修改，$uri不包含主机名，如”/foo/bar.html”。</p>
<p><strong>$document_root</strong> 当前请求的文档根目录或别名——当前请求在root指令中指定的值。</p>
<p><strong>$args</strong> 这个变量等于GET请求中的参数。$query_string 与$args相同。例如，foo=123&amp;bar=blahblah;这个变量只可以被修改</p>
<p><strong>$arg_name</strong>请求中的的参数名，即“?”后面的arg_name=arg_value形式的arg_name</p>
<p><strong>$is_args</strong> 如果$args设置，值为”?”，否则为””。</p>
<p><strong>$cookie_COOKI</strong>E cookie COOKIE的值。</p>
<p><strong>$cookie_name</strong> cookie名称</p>
<h4 id="6-17-2-nginx服务端参数内置变量匹配"><a href="#6-17-2-nginx服务端参数内置变量匹配" class="headerlink" title="6.17.2 nginx服务端参数内置变量匹配"></a>6.17.2 nginx服务端参数内置变量匹配</h4><p><strong>$server_protocol</strong> 服务器的HTTP版本, 通常为 “HTTP/1.0” 或 “HTTP/1.1”</p>
<p><strong>$server_nam</strong> 服务器名，如<a href="https://itwhs.github.io/" target="_blank" rel="noopener">itwhs.github.io</a></p>
<p><strong>$server_addr</strong> 服务器端地址，需要注意的是：为了避免访问linux系统内核，应将ip地址提前设置在配置文件中。</p>
<p><strong>$server_port</strong> 服务器端口</p>
<p><strong>$status</strong> HTTP响应代码 (1.3.2, 1.2.2)</p>
<p><strong>$https</strong> 如果开启了SSL安全模式，值为“on”，否则为空字符串。</p>
<h4 id="6-17-3-nginx客户端参数内置变量匹配"><a href="#6-17-3-nginx客户端参数内置变量匹配" class="headerlink" title="6.17.3 nginx客户端参数内置变量匹配"></a>6.17.3 nginx客户端参数内置变量匹配</h4><p><strong>$remote_addr</strong> 客户端的IP地址。</p>
<p><strong>$remote_por</strong>t 客户端的端口。</p>
<p><strong>$remote_user</strong> 用于HTTP基础认证服务的用户名，已经经过Auth Basic Module验证的用户名。</p>
<p><strong>$request</strong>代表客户端的请求地址</p>
<p><strong>$request_filename</strong> 当前连接请求的文件路径，由root或alias指令与URI请求生成。</p>
<p><strong>$realpath_root</strong>当前请求的文档根目录或别名的真实路径，会将所有符号连接转换为真实路径。</p>
<p><strong>$request_body</strong> 客户端的请求主体，此变量可在location中使用，将请求主体通过proxy_pass, fastcgi_pass, uwsgi_pass, 和 scgi_pass传递给下一级的代理服务器。这个变量（0.7.58+）包含请求的主要信息。在使用proxy_pass或fastcgi_pass指令的location<strong>中比较有意义。</strong></p>
<p><strong>$request_body_file</strong> 客户端请求主体信息的临时文件名。将客户端请求主体保存在临时文件中。文件处理结束后，此文件需删除。如果需要之一开启此功能，需要设置client_body_in_file_only。如果将次文件传递给后端的代理服务器，需要禁用request body，即设置proxy_pass_request_body off，fastcgi_pass_request_body off, uwsgi_pass_request_body off, or scgi_pass_request_body off 。</p>
<p><strong>$request_completion</strong> 如果请求成功，设为”OK”；如果请求未完成或者不是一系列请求中最后一部分则设为空。</p>
<p><strong>$request_method</strong> 这个变量是客户端请求的动作，通常为GET或POST。包括0.8.20及之前的版本中，这个变量总为main request中的动作，如果当前请求是一个子请求，并不使用这个当前请求的动作。</p>
<p><strong>$http_HEADER</strong> HTTP请求头中的内容，HEADER为HTTP请求中的内容转为小写，-变为_(破折号变为下划线)，例如：$http_user_agent(Uaer-Agent的值), $http_referer…;</p>
<p><strong>$http_name</strong>匹配任意请求头字段； 变量名中的后半部分“name”可以替换成任意请求头字段，如在配置文件中需要获取http请求头：“Accept-Language”，那么将“－”替换为下划线，大写字母替换为小写，形如：$http_accept_language即可。</p>
<p><strong>$sent_http_HEADER</strong> HTTP响应头中的内容，HEADER为HTTP响应中的内容转为小写，-变为_(破折号变为下划线)，例如： $sent_http_cache_control, $sent_http_content_type…;</p>
<h4 id="6-17-4-nginx运维及系统状态内置变量匹配"><a href="#6-17-4-nginx运维及系统状态内置变量匹配" class="headerlink" title="6.17.4 nginx运维及系统状态内置变量匹配"></a>6.17.4 nginx运维及系统状态内置变量匹配</h4><p><strong>$nginx_version</strong> 当前运行的nginx版本号。</p>
<p><strong>$time_iso8601</strong> 服务器时间的ISO 8610格式 (1.3.12, 1.2.7)</p>
<p><strong>$msec</strong> 当前的Unix时间戳 (1.3.9, 1.2.6)</p>
<p>$pid工作进程的PID</p>
<p><strong>$limit_rate</strong> 用于设置响应的速度限制</p>
<p>$binary_remote_addr 二进制码形式的客户端地址。</p>
<p><strong>$body_bytes_sent</strong> 传送页面的字节数</p>
<p><strong>$connection</strong> TCP连接的序列号 (1.3.8, 1.2.5)</p>
<p><strong>$connection_requests</strong> TCP连接当前的请求数量 (1.3.8, 1.2.5)</p>
<p><strong>$content_length</strong> 请求头中的Content-length字段。</p>
<p><strong>$content_type</strong> 请求头中的Content-Type字段。</p>
<h4 id="6-18-nginx的平滑升级"><a href="#6-18-nginx的平滑升级" class="headerlink" title="6.18 nginx的平滑升级"></a>6.18 nginx的平滑升级</h4><p>nginx在编译安装完成之后，出于以下两种考虑都需要进行升级：</p>
<ul>
<li><p>版本更新</p>
</li>
<li><p>添加未编译安装的模块</p>
</li>
</ul>
<p>而nginx所采用的平滑升级可以保证在不停止服务的情况下解决以上问题。我们以动态增加–with-http_stub_status_module模块为例，步骤如下：</p>
<p><strong>1.查看nginx版本号及已安装模块</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# nginx -V</span><br><span class="line">nginx version: nginx/1.16.0</span><br><span class="line">built by gcc 4.8.5 20150623 (Red Hat 4.8.5-36) (GCC) </span><br><span class="line">built with OpenSSL 1.0.2k-fips  26 Jan 2017</span><br><span class="line">TLS SNI support enabled</span><br><span class="line">configure arguments: --prefix=/usr/local/nginx --user=nginx --group=nginx --with-debug --with-http_ssl_module --with-http_realip_module --with-http_image_filter_module --with-http_gunzip_module --with-http_gzip_static_module --with-http_stub_status_module --http-log-path=/var/log/nginx/access.log --error-log-path=/var/log/nginx/error.log --with-pcre</span><br></pre></td></tr></table></figure>

<p><strong>2.下载对应版本的源码包和要添加的模块</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# wget http://nginx.org/download/nginx-1.17.0.tar.gz</span><br><span class="line">[root@localhost ~]# wget https://github.com/openresty/echo-nginx-module/archive/v0.61.tar.gz</span><br></pre></td></tr></table></figure>

<p><strong>3.解压并重新编译</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# tar xf nginx-1.17.0.tar.gz </span><br><span class="line">[root@localhost ~]# tar xf v0.61.tar.gz </span><br><span class="line">[root@localhost ~]# ll</span><br><span class="line">drwxrwxr-x  5 root root      174 8月   9 2017 echo-nginx-module-0.61</span><br><span class="line">drwxr-xr-x  8 1001 1001      158 5月  21 22:24 nginx-1.17.0</span><br><span class="line">-rw-r--r--  1 root root  1032978 5月  23 21:32 nginx-1.17.0.tar.gz</span><br><span class="line">-rw-r--r--  1 root root    53155 6月  11 17:01 v0.61.tar.gz</span><br><span class="line">[root@localhost ~]# cd nginx-1.17.0</span><br><span class="line">[root@localhost ~]# cd nginx-1.17.0</span><br><span class="line">[root@localhost nginx-1.17.0]# ./configure --prefix=/usr/local/nginx17 --user=nginx --group=nginx --with-debug --with-http_ssl_module --with-http_realip_module --with-http_image_filter_module --with-http_gunzip_module --with-http_gzip_static_module --with-http_stub_status_module --http-log-path=/var/log/nginx/access.log --error-log-path=/var/log/nginx/error.log --with-pcre --add-module=../echo-nginx-module-0.61</span><br><span class="line">.......</span><br><span class="line">[root@localhost nginx-1.17.0]# make</span><br><span class="line">此时2种方法升级,一是把objs里面的新编译的文件,替换到原有的文件,实现升级和加模块,这个方法不需要make install,二是直接把老版本的conf文件替换到新版本目录(下面演示的方法二)</span><br><span class="line">[root@localhost nginx-1.17.0]# make install</span><br></pre></td></tr></table></figure>

<p><strong>4.备份,升级</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost nginx-1.17.0]# mv /usr/local/nginx17/conf/nginx.conf&#123;,.origin&#125;</span><br><span class="line">[root@localhost nginx-1.17.0]# cp /usr/local/nginx/conf/nginx.conf /usr/local/nginx17/conf/</span><br><span class="line">[root@localhost nginx-1.17.0]# pkill nginx</span><br><span class="line">[root@localhost nginx-1.17.0]# /usr/local/nginx17/sbin/nginx </span><br><span class="line">[root@localhost nginx-1.17.0]# /usr/local/nginx17/sbin/nginx -V</span><br><span class="line">nginx version: nginx/1.17.0</span><br><span class="line">built by gcc 4.8.5 20150623 (Red Hat 4.8.5-36) (GCC) </span><br><span class="line">built with OpenSSL 1.0.2k-fips  26 Jan 2017</span><br><span class="line">TLS SNI support enabled</span><br><span class="line">configure arguments: --prefix=/usr/local/nginx17 --user=nginx --group=nginx --with-debug --with-http_ssl_module --with-http_realip_module --with-http_image_filter_module --with-http_gunzip_module --with-http_gzip_static_module --with-http_stub_status_module --http-log-path=/var/log/nginx/access.log --error-log-path=/var/log/nginx/error.log --with-pcre --add-module=../echo-nginx-module-0.61</span><br></pre></td></tr></table></figure>

<p><strong>5.添加环境变量</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# vim /etc/profile.d/nginx.sh</span><br><span class="line">export PATH=/usr/local/nginx17/sbin:$PATH</span><br><span class="line">[root@localhost ~]# source /etc/profile.d/nginx.sh </span><br><span class="line">[root@localhost ~]# whereis nginx</span><br><span class="line">nginx: /usr/local/nginx /usr/local/nginx17/sbin/nginx /usr/local/nginx/sbin/nginx</span><br></pre></td></tr></table></figure>


          
        
      
    </div>

    

    

    
    
    

    

    
      
    
    

    
	
	  <div>
        
      </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://aiwhs.github.io/2018/11/17/limits.conf配置/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="itw">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="itw">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2018/11/17/limits.conf配置/" class="post-title-link" itemprop="url">limits.conf</a>
              
            
          </h1>
        

        <div class="post-meta">

          
          
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-11-17 08:15:57" itemprop="dateCreated datePublished" datetime="2018-11-17T08:15:57+08:00">2018-11-17</time>
            </span>
          

          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-07-09 18:36:37" itemprop="dateModified" datetime="2019-07-09T18:36:37+08:00">2019-07-09</time>
              </span>
            
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Linux运维/" itemprop="url" rel="index"><span itemprop="name">Linux运维</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          <br>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <a id="more"></a>

<p>limits.conf 文件实际是 Linux PAM（插入式认证模块，Pluggable Authentication Modules）中 pam_limits.so 的配置文件，而且只针对于单个会话。</p>
<h3 id="limits-conf的格式如下："><a href="#limits-conf的格式如下：" class="headerlink" title="limits.conf的格式如下："></a>limits.conf的格式如下：</h3><blockquote>
<p>username|@groupname type resource limit</p>
<p>username|@groupname：设置需要被限制的用户名，组名前面加@和用户名区别。也可以用通配符*来做所有用户的限制。</p>
</blockquote>
<h3 id="type："><a href="#type：" class="headerlink" title="type："></a>type：</h3><blockquote>
<p>soft，hard 和 -，soft 指的是当前系统生效的设置值。<br>hard 表明系统中所能设定的最大值。<br>soft 的限制不能比har 限制高。<br>用 - 就表明同时设置了 soft 和 hard 的值。</p>
</blockquote>
<h3 id="resource："><a href="#resource：" class="headerlink" title="resource："></a>resource：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">core - 限制内核文件的大小</span><br><span class="line">date - 最大数据大小</span><br><span class="line">fsize - 最大文件大小</span><br><span class="line">memlock - 最大锁定内存地址空间</span><br><span class="line">nofile - 打开文件的最大数目</span><br><span class="line">rss - 最大持久设置大小</span><br><span class="line">stack - 最大栈大小</span><br><span class="line">cpu - 以分钟为单位的最多 CPU 时间</span><br><span class="line">noproc - 进程的最大数目</span><br><span class="line">as - 地址空间限制</span><br><span class="line">maxlogins - 此用户允许登录的最大数目</span><br><span class="line">要使 limits.conf 文件配置生效，必须要确保 pam_limits.so 文件被加入到启动文件中。查看 /etc/pam.d/login 文件中有：</span><br><span class="line">　　session required /lib/security/pam_limits.so</span><br></pre></td></tr></table></figure>

<h3 id="vi-etc-security-limits-conf"><a href="#vi-etc-security-limits-conf" class="headerlink" title="vi /etc/security/limits.conf"></a>vi /etc/security/limits.conf</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">* soft nofile 655360        # open files  (-n)，不要设置为unlimited</span><br><span class="line">* hard nofile 655360        # 不要超过最大值1048576，不要设置为unlimited</span><br><span class="line"></span><br><span class="line">* soft nproc 655650</span><br><span class="line">* hard nproc 655650         # max user processes   (-u)</span><br><span class="line"></span><br><span class="line">hive   - nofile 655650</span><br><span class="line">hive   - nproc  655650</span><br></pre></td></tr></table></figure>

<h3 id="用户进程限制（某些系统nproc会在20-nproc-conf内限制）"><a href="#用户进程限制（某些系统nproc会在20-nproc-conf内限制）" class="headerlink" title="用户进程限制（某些系统nproc会在20-nproc.conf内限制）"></a>用户进程限制（某些系统nproc会在20-nproc.conf内限制）</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># 加大普通用户限制  也可以改为unlimited</span><br><span class="line">    </span><br><span class="line">$ sed -i ‘s#4096#65535#g‘   /etc/security/limits.d/20-nproc.conf  </span><br><span class="line">$ egrep -v &quot;^$|^#&quot; /etc/security/limits.d/20-nproc.conf        </span><br><span class="line">    </span><br><span class="line">- soft    nproc     65535</span><br><span class="line">root       soft    nproc     unlimited</span><br></pre></td></tr></table></figure>
          
        
      
    </div>

    

    

    
    
    

    

    
      
    
    

    
	
	  <div>
        
      </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://aiwhs.github.io/2018/11/11/HTTPd/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="itw">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="itw">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2018/11/11/HTTPd/" class="post-title-link" itemprop="url">httpd</a>
              
            
          </h1>
        

        <div class="post-meta">

          
          
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-11-11 08:15:57" itemprop="dateCreated datePublished" datetime="2018-11-11T08:15:57+08:00">2018-11-11</time>
            </span>
          

          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-07-11 20:27:45" itemprop="dateModified" datetime="2019-07-11T20:27:45+08:00">2019-07-11</time>
              </span>
            
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Linux运维/" itemprop="url" rel="index"><span itemprop="name">Linux运维</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          <br>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <a id="more"></a>

<h1 id="1-httpd简介"><a href="#1-httpd简介" class="headerlink" title="1. httpd简介"></a>1. httpd简介</h1><p>httpd是Apache的超文本传输协议（HTTP）服务器的主程序。被设计为一个独立运行的后台进程，它会建立一个处理请求的子进程或线程的池。</p>
<p>通常，httpd的不应该被直接调用，而应该在类Unix的系统中由的apachectl调用，在Windows中作为服务运行。</p>
<h1 id="2-httpd版本"><a href="#2-httpd版本" class="headerlink" title="2. httpd版本"></a>2. httpd版本</h1><p>本文主要介绍的httpd的两大版本，httpd-2.2和httpd-2.4。</p>
<ul>
<li>CentOS6系列的版本默认提供的是的httpd-2.2版本的rpm包</li>
<li>CentOS7系列的版本默认提供的是的httpd-2.4版本的rpm包</li>
</ul>
<h2 id="2-1-httpd的特性"><a href="#2-1-httpd的特性" class="headerlink" title="2.1 httpd的特性"></a>2.1 httpd的特性</h2><p>httpd的有很多特性，下面就分别来说说的httpd-2.2版本和的httpd-2.4版本各自的特性。</p>
<h4 id="httpd-2-2的特性"><a href="#httpd-2-2的特性" class="headerlink" title="httpd-2.2的特性"></a>httpd-2.2的特性</h4><ul>
<li>事先创建进程</li>
<li>按需维持适当的进程</li>
<li>模块化设计，核心比较小，各种功能通过模块添加（包括PHP），支持运行时配置，支持单独编译模块</li>
<li>支持多种方式的虚拟主机配置，如基于ip的虚拟主机，基于端口的虚拟主机，基于域名的虚拟主机等</li>
<li>支持https协议（通过mod_ssl模块实现）</li>
<li>支持用户认证</li>
<li>支持基于IP或域名的ACL访问控制机制</li>
<li>支持每目录的访问控制（用户访问默认主页时不需要提供用户名和密码，但是用户访问某特定目录时 需要提供用户名和密码）</li>
<li>支持URL重写</li>
<li>支持MPM（Multi Path Modules，多处理模块）。用于定义httpd的工作模型（单进程、单进程多线程、多进程、多进程单线程、多进程多线程）</li>
</ul>
<h4 id="httpd-2-4的新特性："><a href="#httpd-2-4的新特性：" class="headerlink" title="httpd-2.4的新特性："></a>httpd-2.4的新特性：</h4><ul>
<li>MPM支持运行DSO机制（Dynamic Share Object，模块的动态装/卸载机制），以模块形式按需加载</li>
<li>支持event MPM，eventMPM模块生产环境可用</li>
<li>支持异步读写</li>
<li>支持每个模块及每个目录分别使用各自的日志级别</li>
<li>每个请求相关的专业配置，使用<if>来配置</if></li>
<li>增强版的表达式分析器</li>
<li>支持毫秒级的keepalive timeout</li>
<li>基于FQDN的虚拟主机不再需要NameVirtualHost指令</li>
<li>支持用户自定义变量</li>
<li>支持新的指令（AllowOverrideList）</li>
<li>降低对内存的消耗</li>
</ul>
<table>
<thead>
<tr>
<th>工作模型</th>
<th>工作方式</th>
</tr>
</thead>
<tbody><tr>
<td>prefork</td>
<td>多进程模型，预先生成进程，请求一个用一个进程响应,一个主进程负责生成Ñ个子进程，进程子也。称为工作进程,每个子进程处理一个用户请求，即使没有用户请求，也会预先生成多个空闲进程，随时等待请求到达，最大不会超过1024个</td>
</tr>
<tr>
<td>worker</td>
<td>基于线程工作，一个请求用一个线程响应（启动多个进程，每个进程生成多个线程）</td>
</tr>
<tr>
<td>event</td>
<td>基于事件的驱动，一个进程处理多个请求</td>
</tr>
</tbody></table>
<h2 id="2-2-httpd-2-4新增的模块"><a href="#2-2-httpd-2-4新增的模块" class="headerlink" title="2.2 httpd-2.4新增的模块"></a>2.2 httpd-2.4新增的模块</h2><p>httpd-2.4在之前的版本基础上新增了几大模块，下面就几个常用的来介绍一下。</p>
<table>
<thead>
<tr>
<th>模块</th>
<th>功能</th>
</tr>
</thead>
<tbody><tr>
<td>mod_proxy_fcgi</td>
<td>反向代理时支持的Apache服务器后端协议的模块</td>
</tr>
<tr>
<td>mod_ratelimit</td>
<td>提供速率限制功能的模块</td>
</tr>
<tr>
<td>mod_remoteip</td>
<td>基于ip的访问控制机制被改变，不再支持使用Order，Deny，Allow来做基于IP的访问控制</td>
</tr>
</tbody></table>
<h1 id="3-httpd基础"><a href="#3-httpd基础" class="headerlink" title="3. httpd基础"></a>3. httpd基础</h1><h2 id="3-1-httpd自带的工具程序"><a href="#3-1-httpd自带的工具程序" class="headerlink" title="3.1 httpd自带的工具程序"></a>3.1 httpd自带的工具程序</h2><table>
<thead>
<tr>
<th>工具</th>
<th>功能</th>
</tr>
</thead>
<tbody><tr>
<td>htpasswd</td>
<td>basic认证基于文件实现时，用到的帐号密码生成工具</td>
</tr>
<tr>
<td>apachectl</td>
<td>httpd自带的服务控制脚本，支持start，stop，restart</td>
</tr>
<tr>
<td>apxs</td>
<td>由httpd-devel包提供的，扩展httpd使用第三方模块的工具</td>
</tr>
<tr>
<td>rotatelogs</td>
<td>日志滚动工具</td>
</tr>
<tr>
<td>suexec</td>
<td>访问某些有特殊权限配置的资源时，临时切换至指定用户运行的工具</td>
</tr>
<tr>
<td>ab</td>
<td>apache benchmark，httpd的压力测试工具</td>
</tr>
</tbody></table>
<h2 id="3-2-rpm包安装的httpd程序环境"><a href="#3-2-rpm包安装的httpd程序环境" class="headerlink" title="3.2 rpm包安装的httpd程序环境"></a>3.2 rpm包安装的httpd程序环境</h2><table>
<thead>
<tr>
<th>文件/目录</th>
<th>对应的功能</th>
</tr>
</thead>
<tbody><tr>
<td>/var/log/httpd/access.log</td>
<td>访问日志</td>
</tr>
<tr>
<td>/var/log/httpd/error_log</td>
<td>错误日志</td>
</tr>
<tr>
<td>/var/www/html/</td>
<td>站点文档目录</td>
</tr>
<tr>
<td>/usr/lib64/httpd/modules/</td>
<td>模块文件路径</td>
</tr>
<tr>
<td>/etc/httpd/conf/httpd.conf</td>
<td>主配置文件</td>
</tr>
<tr>
<td>/etc/httpd/conf.modules.d/*.conf</td>
<td>模块配置文件</td>
</tr>
<tr>
<td>/etc/httpd/conf.d/*.conf</td>
<td>辅助配置文件</td>
</tr>
</tbody></table>
<blockquote>
<p>mpm：以DSO机制提供，配置文件为/etc/httpd/conf.modules.d/00-mpm.conf</p>
</blockquote>
<h2 id="3-3-web相关的命令"><a href="#3-3-web相关的命令" class="headerlink" title="3.3 web相关的命令"></a>3.3 web相关的命令</h2><h4 id="3-3-1-curl命令"><a href="#3-3-1-curl命令" class="headerlink" title="3.3.1 curl命令"></a>3.3.1 curl命令</h4><p>curl是基于URL语法在命令行方式下工作的文件传输工具，它支持FTP，FTPS，HTTP，HTTPS，GOPHER，TELNET，DICT，FILE及LDAP等协议。</p>
<p>curl支持以下功能：</p>
<ul>
<li>https认证</li>
<li>http的POST/PUT等方法</li>
<li>ftp上传</li>
<li>kerberos认证</li>
<li>http上传</li>
<li>代理服务器</li>
<li>cookies</li>
<li>用户名/密码认证</li>
<li>下载文件断点续传</li>
<li>socks5代理服务器</li>
<li>通过http代理服务器上传文件到ftp服务器</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">//语法：curl [options] [URL ...]</span><br><span class="line">//常用的options：</span><br><span class="line">    -A/--user-agent &lt;string&gt;    //设置用户代理发送给服务器</span><br><span class="line">    -basic              //使用Http基本认证</span><br><span class="line">    --tcp-nodelay       //使用TCP_NODELAY选项</span><br><span class="line">    -e/--referer &lt;URL&gt;      //来源网址</span><br><span class="line">    --cacert &lt;file&gt;     //CA证书（SSL）</span><br><span class="line">    --compressed        //要求返回时压缩的格式</span><br><span class="line">    -H/--header &lt;line&gt;  //自定义请求首部信息传递给服务器</span><br><span class="line">    -I/--head           //只显示响应报文首部信息</span><br><span class="line">    --limit-rate &lt;rate&gt;     //设置传输速度</span><br><span class="line">    -u/--user &lt;user[:password]&gt;     //设置服务器的用户和密码</span><br><span class="line">    -0/--http1      //使用http 1.0版本，默认使用1.1版本。这个选项是数字0而不是字母o</span><br><span class="line">    -o/--output     //把输出写到文件中</span><br><span class="line">    -#/--progress-bar       //进度条显示当前的传送状态</span><br></pre></td></tr></table></figure>

<h4 id="3-3-2-httpd命令"><a href="#3-3-2-httpd命令" class="headerlink" title="3.3.2 httpd命令"></a>3.3.2 httpd命令</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">//语法：httpd [options]</span><br><span class="line">//常用的options：</span><br><span class="line">    -l      //查看静态编译的模块，列出核心中编译了哪些模块。 \</span><br><span class="line">            //它不会列出使用LoadModule指令动态加载的模块</span><br><span class="line">    -M      //输出一个已经启用的模块列表，包括静态编译在服务 \</span><br><span class="line">            //器中的模块和作为DSO动态加载的模块</span><br><span class="line">    -v      //显示httpd的版本，然后退出</span><br><span class="line">    -V      //显示httpd和apr/apr-util的版本和编译参数，然后退出</span><br><span class="line">    -X      //以调试模式运行httpd。仅启动一个工作进程，并且 \</span><br><span class="line">            //服务器不与控制台脱离</span><br><span class="line">    -t      //检查配置文件是否有语法错误</span><br></pre></td></tr></table></figure>

<h1 id="4-编译安装http-2-4"><a href="#4-编译安装http-2-4" class="headerlink" title="4.编译安装http-2.4"></a>4.编译安装http-2.4</h1><p><a href="https://blog.csdn.net/wenhs5479/article/details/88536361" target="_blank" rel="noopener">点这里,查看详细安装步骤,下面为源码安装脚本</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">##配置yum源：</span><br><span class="line">echo &quot;使用本脚本请使用root用户,并且要有耐心,等待5-10分钟即可安装完成,切勿CTRL+C终止&quot;</span><br><span class="line">yum -y install wget &amp;&gt; /dev/null</span><br><span class="line">if [ $? -ne 0 ];then</span><br><span class="line">ls -l /etc/yum.repos.d/7centos_base.repo &amp;&gt;/dev/null</span><br><span class="line">  if [ $? -ne 0 ];then</span><br><span class="line">   echo &quot;正在下载yum源&quot;</span><br><span class="line">   curl -o /etc/yum.repos.d/7centos_base.repo http://mirrors.aliyun.com/repo/Centos-7.repo &amp;&gt;/dev/null</span><br><span class="line">   sed -i &apos;s/$releasever/7/g&apos; /etc/yum.repos.d/7centos_base.repo   &amp;&gt;/dev/null</span><br><span class="line">  else</span><br><span class="line">   mv /etc/yum.repos.d/7centos_base.repo /etc/yum.repos.d/7centos_base.repo_backup </span><br><span class="line">   echo &quot;正在备份yum源并重新下载，请重新运行脚本&quot;</span><br><span class="line">   exit</span><br><span class="line">  fi</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">yum clean all &amp;&gt;/dev/null</span><br><span class="line">echo &quot;正在清除yum缓存,请等待&quot;</span><br><span class="line"></span><br><span class="line">echo &quot;正在加载yum缓存,请等待&quot;</span><br><span class="line">yum makecache &amp;&gt;/dev/null</span><br><span class="line">##下载wget</span><br><span class="line">echo &quot;正在下载wget,请等待 &quot;</span><br><span class="line">yum -y install wget  &amp;&gt;/dev/null</span><br><span class="line"></span><br><span class="line">##准备make环境</span><br><span class="line">echo &quot;安装开发环境&quot;</span><br><span class="line">yum -y groups mark install &quot;Development Tools&quot; &amp;&gt;/dev/null</span><br><span class="line">#安装make gcc gcc-c++ gzip bzip2 openssl-devel pcre-devel expat-devel libtool</span><br><span class="line">yum -y install make gcc gcc-c++ gzip bzip2 openssl-devel pcre-devel expat-devel libtool &amp;&gt;/dev/null</span><br><span class="line">echo &quot;安装完成进行下一步&quot;</span><br><span class="line">##下载httpd源码包</span><br><span class="line">mkdir /usr/local/src &amp;&gt; /dev/src</span><br><span class="line">cd /usr/local/src</span><br><span class="line">echo &quot;下载源码包,请等待&quot;</span><br><span class="line">wget http://mirrors.tuna.tsinghua.edu.cn/apache//httpd/httpd-2.4.39.tar.bz2 &amp;&gt;/dev/null</span><br><span class="line">wget http://mirror.bit.edu.cn/apache//apr/apr-1.6.5.tar.bz2 &amp;&gt;/dev/null</span><br><span class="line">wget http://mirror.bit.edu.cn/apache//apr/apr-util-1.6.1.tar.bz2 &amp;&gt;/dev/null</span><br><span class="line">##解压源码包</span><br><span class="line">tar xf apr-1.6.5.tar.bz2</span><br><span class="line">tar xf apr-util-1.6.1.tar.bz2</span><br><span class="line">tar xf httpd-2.4.39.tar.bz2</span><br><span class="line">echo &quot;完成解压,进入/usr/local/src/apr-1.6.5&quot;</span><br><span class="line">##源码安装apr</span><br><span class="line">cd /usr/local/src/apr-1.6.5</span><br><span class="line">echo &quot;正在编译安装apr,请稍等&quot;</span><br><span class="line">sed -i &apos;s/$RM &quot;$cfgfile&quot;/#$RM &quot;$cfgfile&quot;/g&apos; configure</span><br><span class="line">./configure --prefix=/usr/local/apr &amp;&gt;/dev/null</span><br><span class="line">if [ $? -ne 0 ];then</span><br><span class="line">echo &quot;apr ./configure定制组件失败，请自行排错&quot;</span><br><span class="line">exit</span><br><span class="line">fi</span><br><span class="line">make &amp;&gt;/dev/null</span><br><span class="line">if [ $? -ne 0 ];then</span><br><span class="line">echo &quot;apr make编译失败，请自行排错&quot;</span><br><span class="line">exit</span><br><span class="line">fi</span><br><span class="line">make install &amp;&gt; /dev/null</span><br><span class="line">echo &quot;安装完成并进入/usr/local/src/apr-util-1.6.1/&quot;</span><br><span class="line">##源码安装apr-util</span><br><span class="line">cd /usr/local/src/apr-util-1.6.1/</span><br><span class="line">echo &quot;正在编译安装apr-util&quot;</span><br><span class="line">./configure --prefix=/usr/local/apr-util --with-apr=/usr/local/apr &amp;&gt;/dev/null</span><br><span class="line">if [ $? -ne 0 ];then</span><br><span class="line">echo &quot;apr-util ./configure定制组件失败，请自行排错&quot;</span><br><span class="line">exit</span><br><span class="line">fi</span><br><span class="line">make &amp;&gt;/dev/null</span><br><span class="line">if [ $? -ne 0 ];then</span><br><span class="line">echo &quot;apr-util make编译失败，请自行排错&quot;</span><br><span class="line">exit</span><br><span class="line">fi</span><br><span class="line">make install &amp;&gt;/dev/null</span><br><span class="line">echo &quot;安装完成并进入/usr/local/src/httpd-2.4.39/&quot;</span><br><span class="line">##源码安装httpd</span><br><span class="line">cd /usr/local/src/httpd-2.4.39/</span><br><span class="line">echo &quot;正在编译安装httpd-2.4.39,请等待&quot;</span><br><span class="line">./configure --prefix=/usr/local/apache --with-apr=/usr/local/apr --with-apr-util=/usr/local/apr-util/ &amp;&gt;/dev/null</span><br><span class="line">if [ $? -ne 0 ];then</span><br><span class="line">echo &quot;httpd ./configure定制组件失败，请自行排错&quot;</span><br><span class="line">exit</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">make &amp;&gt;/dev/null</span><br><span class="line">if [ $? -ne 0 ];then</span><br><span class="line">echo &quot;httpd make编译失败，请自行排错&quot;</span><br><span class="line">exit</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">make install &amp;&gt;/dev/null</span><br><span class="line">echo &quot;源码编译成功，正在添加环境变量&quot;</span><br><span class="line"></span><br><span class="line">##添加man文档</span><br><span class="line">echo &quot;MANDATORY_MANPATH /usr/local/apache/man&quot; &gt;&gt; /etc/man_db.conf</span><br><span class="line">man httpd &amp;&gt;/dev/null</span><br><span class="line">if [ $? -eq 0 ];then</span><br><span class="line">echo &quot;man文档添加成功&quot;</span><br><span class="line">else</span><br><span class="line">echo &quot;man文档添加失败,如有需要，请自行添加&quot;</span><br><span class="line">exit</span><br><span class="line">fi</span><br><span class="line">##编辑httpd配置文件</span><br><span class="line">sed -i &apos;/ServerName www.example.com:80/aServerName localhost:80&apos; /usr/local/apache/conf/httpd.conf</span><br><span class="line">systemctl stop firewalld &amp;&gt; /dev/null</span><br><span class="line">systemctl disable firewalld &amp;&gt; /dev/null</span><br><span class="line"></span><br><span class="line">##添加环境变量</span><br><span class="line">ln -s /usr/local/apache/bin/* /usr/bin/ &amp;&gt;/dev/null</span><br><span class="line"></span><br><span class="line">echo  &quot;安装完成&quot;</span><br></pre></td></tr></table></figure>

<p><img src="../../img/httpd1.png" alt="httpd1"></p>
<h1 id="5-httpd常用配置"><a href="#5-httpd常用配置" class="headerlink" title="5. httpd常用配置"></a>5. httpd常用配置</h1><p><strong>切换使用MPM（编辑/etc/httpd/conf.modules.d/00-mpm.conf文件）：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">LoadModule mpm_NAME_module modules/mod_mpm_NAME.so</span><br><span class="line">NAME有三种，分别是：</span><br><span class="line">    prefork</span><br><span class="line">    event</span><br><span class="line">    worker</span><br></pre></td></tr></table></figure>

<p><strong>访问控制法则：</strong></p>
<table>
<thead>
<tr>
<th>法则</th>
<th>功能</th>
</tr>
</thead>
<tbody><tr>
<td>Require all granted</td>
<td>允许所有主机访问</td>
</tr>
<tr>
<td>Require all deny</td>
<td>拒绝所有主机访问</td>
</tr>
<tr>
<td>Require ip IPADDR</td>
<td>授权指定来源地址的主机访问</td>
</tr>
<tr>
<td>Require not ip IPADDR</td>
<td>拒绝指定来源地址的主机访问</td>
</tr>
<tr>
<td>Require host HOSTNAME</td>
<td>授权指定来源主机名的主机访问</td>
</tr>
<tr>
<td>Require not host HOSTNAME</td>
<td>拒绝指定来源主机名的主机访问</td>
</tr>
</tbody></table>
<p><strong>IPADDR的类型</strong>    </p>
<ul>
<li><p>IP：192.168.1.1</p>
</li>
<li><p>Network/mask：192.168.1.0/255.255.255.0</p>
</li>
<li><p>Network/Length：192.168.1.0/24</p>
</li>
<li><p>Net：192.168    </p>
</li>
</ul>
<p><strong>HOSTNAME的类型</strong></p>
<ul>
<li><p>FQDN：特定主机的全名</p>
</li>
<li><p>DOMAIN：指定域内的所有主机</p>
</li>
</ul>
<p><strong>注意：httpd-2.4版本默认是拒绝所有主机访问的，所以安装以后必须做显示授权访问</strong></p>
<p>示例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;Directory /var/www/html/www&gt;</span><br><span class="line">    &lt;RequireAll&gt;</span><br><span class="line">        Require not ip 192.168.160.89</span><br><span class="line">        Require all granted</span><br><span class="line">    &lt;/RequireAll&gt;</span><br><span class="line">&lt;/Directory&gt;</span><br></pre></td></tr></table></figure>

<p>虚拟主机：<br>虚拟主机有三类：</p>
<ul>
<li>相同IP不同端口</li>
<li>不同IP相同端口</li>
<li>相同IP相同端口不同域名</li>
</ul>
<p><strong>ssl：</strong></p>
<p>启用模块：编辑/etc/httpd/conf.modules.d/00-base.conf文件，添加下面这行，如果已经有了但是注释了，则取消注释即可</p>
<blockquote>
<p>LoadModule ssl_module modules/mod_ssl.so</p>
</blockquote>
<h3 id="实验"><a href="#实验" class="headerlink" title="实验"></a>实验</h3><ul>
<li>编译安装Httpd-2.4版本；</li>
<li>配置三种不同风格的虚拟主机：</li>
<li>相同IP不同端口；</li>
<li>不同IP相同端口；</li>
<li>相同IP相同端口不同域名</li>
<li>配置https</li>
</ul>
<h3 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">//相同ip不同端口</span><br><span class="line"></span><br><span class="line">//设置主机名</span><br><span class="line">ServerAdmin you@example.com</span><br><span class="line"></span><br><span class="line">#</span><br><span class="line"># ServerName gives the name and port that the server uses to identify itself.</span><br><span class="line"># This can often be determined automatically, but we recommend you specify</span><br><span class="line"># it explicitly to prevent problems during startup.</span><br><span class="line">#</span><br><span class="line"># If your host doesn&apos;t have a registered DNS name, enter its IP address here.</span><br><span class="line">#</span><br><span class="line">ServerName www.example.com:80  //此行如果有注释请取消</span><br><span class="line"></span><br><span class="line">httpd-vhosts.conf  //这个文件可以查看编写虚拟主机格式示例</span><br><span class="line">[root@ip-10-0-100-141 apache]# vim conf/httpd.conf</span><br><span class="line">//设置监听端口</span><br><span class="line">#Listen 12.34.56.78:80</span><br><span class="line">Listen 80</span><br><span class="line">Listen 8080 //与添加主机的端口号相同</span><br><span class="line"></span><br><span class="line">//在文本最后添加主机配置</span><br><span class="line"></span><br><span class="line">&lt;VirtualHost 10.0.100.141:80&gt;</span><br><span class="line">    ServerName whs.example.com</span><br><span class="line">    DocumentRoot &quot;/usr/local/apache/htdocs/whs&quot;</span><br><span class="line">    ErrorLog &quot;/usr/local/apache/logs/whs_error_log&quot;</span><br><span class="line">    ErrorLog &quot;/usr/local/apache/logs/whs_error_log&quot;</span><br><span class="line">    CustomLog &quot;/usr/local/apache/logs/whs_access_log&quot; combined</span><br><span class="line">    &lt;Directory /usr/local/apache/htdocs/whs&gt;</span><br><span class="line">        Require all granted</span><br><span class="line">    &lt;/Directory&gt;</span><br><span class="line">&lt;/VirtualHost&gt;</span><br><span class="line"></span><br><span class="line">&lt;VirtualHost 10.0.100.141:8080&gt;</span><br><span class="line">    ServerName wenhs.example.com</span><br><span class="line">    DocumentRoot &quot;/usr/local/apache/htdocs/wenhs&quot;</span><br><span class="line">    ErrorLog &quot;/usr/local/apache/logs/wenhs_error_log&quot;</span><br><span class="line">    CustomLog &quot;/usr/local/apache/logs/wenhs_access_log&quot; combined</span><br><span class="line">    &lt;Directory /usr/local/apache/htdocs/wenhs&gt;</span><br><span class="line">        Require all granted</span><br><span class="line">    &lt;/Directory&gt;</span><br><span class="line">&lt;/VirtualHost&gt;</span><br><span class="line"></span><br><span class="line">[root@ip-10-0-100-141 apache]# mkdir htdocs/whs</span><br><span class="line">[root@ip-10-0-100-141 apache]# mkdir htdocs/wenhs</span><br><span class="line">[root@ip-10-0-100-141 apache]# echo whs &gt;htdocs/whs/index.html</span><br><span class="line">[root@ip-10-0-100-141 apache]# echo wenhs &gt;htdocs/wenhs/index.html</span><br><span class="line">[root@ip-10-0-100-141 apache]# apachectl -t</span><br><span class="line">Syntax OK</span><br><span class="line">[root@ip-10-0-100-141 apache]# apachectl restart</span><br><span class="line"></span><br><span class="line">验证:</span><br><span class="line">[root@ip-10-0-100-141 apache]# curl http://13.112.100.143</span><br><span class="line">whs</span><br><span class="line">[root@ip-10-0-100-141 apache]# curl http://13.112.100.143:8080</span><br><span class="line">wenhs</span><br></pre></td></tr></table></figure>

<p><img src="../../img/20190421144705802.png" alt="httpd2"><br><img src="../../img/20190421144733518.png" alt="httpd3"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">不同ip相同端口</span><br><span class="line">//设置主机名</span><br><span class="line">ServerAdmin you@example.com</span><br><span class="line"></span><br><span class="line">#</span><br><span class="line"># ServerName gives the name and port that the server uses to identify itself.</span><br><span class="line"># This can often be determined automatically, but we recommend you specify</span><br><span class="line"># it explicitly to prevent problems during startup.</span><br><span class="line">#</span><br><span class="line"># If your host doesn&apos;t have a registered DNS name, enter its IP address here.</span><br><span class="line">#</span><br><span class="line">ServerName www.example.com:80  //此行如果有注释请取消</span><br><span class="line"></span><br><span class="line">httpd-vhosts.conf  //这个文件可以查看编写虚拟主机格式示例</span><br><span class="line">[root@ip-10-0-100-141 apache]# vim conf/httpd.conf</span><br><span class="line">//设置监听端口</span><br><span class="line">#Listen 12.34.56.78:80</span><br><span class="line">Listen 80</span><br><span class="line"></span><br><span class="line">&lt;VirtualHost 10.0.100.141:80&gt;</span><br><span class="line">    ServerName whs.example.com</span><br><span class="line">    DocumentRoot &quot;/usr/local/apache/htdocs/whs&quot;</span><br><span class="line">    ErrorLog &quot;/usr/local/apache/logs/whs_error_log&quot;</span><br><span class="line">    ErrorLog &quot;/usr/local/apache/logs/whs_error_log&quot;</span><br><span class="line">    CustomLog &quot;/usr/local/apache/logs/whs_access_log&quot; combined</span><br><span class="line">    &lt;Directory /usr/local/apache/htdocs/whs&gt;</span><br><span class="line">        Require all granted</span><br><span class="line">    &lt;/Directory&gt;</span><br><span class="line">&lt;/VirtualHost&gt;</span><br><span class="line"></span><br><span class="line">&lt;VirtualHost 10.0.100.100:80&gt;</span><br><span class="line">    ServerName wenhs.example.com</span><br><span class="line">    DocumentRoot &quot;/usr/local/apache/htdocs/wenhs&quot;</span><br><span class="line">    ErrorLog &quot;/usr/local/apache/logs/wenhs_error_log&quot;</span><br><span class="line">    CustomLog &quot;/usr/local/apache/logs/wenhs_access_log&quot; combined</span><br><span class="line">    &lt;Directory /usr/local/apache/htdocs/wenhs&gt;</span><br><span class="line">        Require all granted</span><br><span class="line">    &lt;/Directory&gt;</span><br><span class="line">&lt;/VirtualHost&gt;</span><br><span class="line"></span><br><span class="line">[root@ip-10-0-100-141 apache]# apachectl -t</span><br><span class="line">Syntax OK</span><br><span class="line">[root@ip-10-0-100-141 apache]# ip addr add 10.0.100.100/24 dev eth0</span><br><span class="line">[root@ip-10-0-100-141 apache]# ip a</span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000</span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 ::1/128 scope host </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 9001 qdisc pfifo_fast state UP group default qlen 1000</span><br><span class="line">    link/ether 0a:f5:fa:b7:e9:60 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 10.0.100.141/24 brd 10.0.100.255 scope global noprefixroute dynamic eth0</span><br><span class="line">       valid_lft 3473sec preferred_lft 3473sec</span><br><span class="line">    inet 10.0.100.100/24 scope global secondary eth0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::8f5:faff:feb7:e960/64 scope link </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">[root@ip-10-0-100-141 apache]# apachectl restart</span><br></pre></td></tr></table></figure>

<p>公网IP就一个,所以只好用curl验证了</p>
<p><img src="../../img/20190421145813800.png" alt="httpd4"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">//相同端口相同ip不同域名</span><br><span class="line"></span><br><span class="line">//设置主机名</span><br><span class="line">ServerAdmin you@example.com</span><br><span class="line"></span><br><span class="line">#</span><br><span class="line"># ServerName gives the name and port that the server uses to identify itself.</span><br><span class="line"># This can often be determined automatically, but we recommend you specify</span><br><span class="line"># it explicitly to prevent problems during startup.</span><br><span class="line">#</span><br><span class="line"># If your host doesn&apos;t have a registered DNS name, enter its IP address here.</span><br><span class="line">#</span><br><span class="line">ServerName www.example.com:80  //此行如果有注释请取消</span><br><span class="line"></span><br><span class="line">[root@server apache]# vim /etc/httpd24/extra/httpd-vhosts.conf //编写主机格式示例</span><br><span class="line">[root@server apache]# vim /etc/httpd24/httpd.conf</span><br><span class="line">//设置监听端口</span><br><span class="line">#Listen 12.34.56.78:80</span><br><span class="line">Listen 80</span><br><span class="line"></span><br><span class="line">//在文本最后添加主机配置</span><br><span class="line">&lt;VirtualHost 10.0.100.141:80&gt;</span><br><span class="line">    ServerName whs.example.com</span><br><span class="line">    DocumentRoot &quot;/usr/local/apache/htdocs/whs&quot;</span><br><span class="line">    ErrorLog &quot;/usr/local/apache/logs/whs_error_log&quot;</span><br><span class="line">    ErrorLog &quot;/usr/local/apache/logs/whs_error_log&quot;</span><br><span class="line">    CustomLog &quot;/usr/local/apache/logs/whs_access_log&quot; combined</span><br><span class="line">    &lt;Directory /usr/local/apache/htdocs/whs&gt;</span><br><span class="line">        Require all granted</span><br><span class="line">    &lt;/Directory&gt;</span><br><span class="line">&lt;/VirtualHost&gt;</span><br><span class="line"></span><br><span class="line">&lt;VirtualHost 10.0.100.141:80&gt;</span><br><span class="line">    ServerName wenhs.example.com</span><br><span class="line">    DocumentRoot &quot;/usr/local/apache/htdocs/wenhs&quot;</span><br><span class="line">    ErrorLog &quot;/usr/local/apache/logs/wenhs_error_log&quot;</span><br><span class="line">    CustomLog &quot;/usr/local/apache/logs/wenhs_access_log&quot; combined</span><br><span class="line">    &lt;Directory /usr/local/apache/htdocs/wenhs&gt;</span><br><span class="line">        Require all granted</span><br><span class="line">    &lt;/Directory&gt;</span><br><span class="line">&lt;/VirtualHost&gt;</span><br><span class="line"></span><br><span class="line">[root@ip-10-0-100-141 apache]# vim /etc/hosts</span><br><span class="line">127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4</span><br><span class="line">::1         localhost localhost.localdomain localhost6 localhost6.localdomain6</span><br><span class="line">10.0.100.141 whs.example.com</span><br><span class="line">10.0.100.141 wenhs.example.com</span><br></pre></td></tr></table></figure>

<p><img src="../../img/20190421150634858.png" alt="httpd5"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line">配置https</span><br><span class="line"></span><br><span class="line">[root@ip-10-0-100-141 apache]# cd /etc/pki/CA/</span><br><span class="line">[root@ip-10-0-100-141 CA]# (umask 077;openssl genrsa -out private/cakey.pem 2048)</span><br><span class="line">Generating RSA private key, 2048 bit long modulus</span><br><span class="line">..+++</span><br><span class="line">..........................+++</span><br><span class="line">e is 65537 (0x10001)</span><br><span class="line">[root@ip-10-0-100-141 CA]# openssl rsa -in private/cakey.pem -pubout</span><br><span class="line">writing RSA key</span><br><span class="line">-----BEGIN PUBLIC KEY-----</span><br><span class="line">MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA0yVZHFUCKX+QRdAwD2tU</span><br><span class="line">msTBiKYM1njY9Nq35GXVu6h2LFoz7a8E51NyyEGDKDrBKQ9qsnHFLxLejL5BKRRM</span><br><span class="line">hCKNjguedCsPyig+skDGRJyJqqdCMTQPOvvRPd+8RzPkx6PbvPFqq2AcYgy19mhF</span><br><span class="line">RJ+yBGatLB9fLe14NwaR85B2aNynMQHCG8Kqw+eLLdknaD0Bj4wT5mlbxAHH42Zp</span><br><span class="line">NTYh56nYyL1dj19CclCTSXmiesXCb0P/r7NWPkm69q6c3V8Tk5IpVv5AsNTiyirq</span><br><span class="line">3J2pWKHNclpXpnuVvyOZe/CaE138ifNS8iu+9UDgXW+lUd3KLVmgqf0ImFd+G3oQ</span><br><span class="line">gQIDAQAB</span><br><span class="line">-----END PUBLIC KEY-----</span><br><span class="line">[root@ip-10-0-100-141 CA]# openssl req -new -x509 -key private/cakey.pem -out cacert.pem -days 365</span><br><span class="line">...</span><br><span class="line">-----</span><br><span class="line">Country Name (2 letter code) [XX]:cn</span><br><span class="line">State or Province Name (full name) []:HuBei </span><br><span class="line">Locality Name (eg, city) [Default City]:WuHan</span><br><span class="line">Organization Name (eg, company) [Default Company Ltd]:ec2-13-112-100-143.ap-northeast-1.compute.amazonaws.com</span><br><span class="line">Organizational Unit Name (eg, section) []:ec2-13-112-100-143.ap-northeast-1.compute.amazonaws.com</span><br><span class="line">Common Name (eg, your name or your server&apos;s hostname) []:ec2-13-112-100-143.ap-northeast-1.compute.amazonaws.com</span><br><span class="line">Email Address []:qingjiuyeye@gmail.com</span><br><span class="line">[root@ip-10-0-100-141 CA]# openssl x509 -text -in cacert.pem</span><br><span class="line">.....</span><br><span class="line">-----END CERTIFICATE-----</span><br><span class="line">[root@ip-10-0-100-141 CA]# cd /usr/local/apache/conf/</span><br><span class="line">[root@ip-10-0-100-141 conf]# mkdir ssl &amp;&amp; cd ssl</span><br><span class="line">[root@ip-10-0-100-141 ssl]# (umask 077;openssl genrsa -out httpd.key 2048)</span><br><span class="line">Generating RSA private key, 2048 bit long modulus</span><br><span class="line">.................................+++</span><br><span class="line">............................+++</span><br><span class="line">e is 65537 (0x10001)</span><br><span class="line">[root@ip-10-0-100-141 ssl]# ls</span><br><span class="line">httpd.key</span><br><span class="line">[root@ip-10-0-100-141 ssl]# openssl req -new -key httpd.key -days 365 -out httpd.csr</span><br><span class="line">You are about to be asked to enter information that will be incorporated</span><br><span class="line">...</span><br><span class="line">-----</span><br><span class="line">Country Name (2 letter code) [XX]:cn</span><br><span class="line">State or Province Name (full name) []:HuBei</span><br><span class="line">Locality Name (eg, city) [Default City]:WuHan</span><br><span class="line">Organization Name (eg, company) [Default Company Ltd]:ec2-13-112-100-143.ap-northeast-1.compute.amazonaws.com</span><br><span class="line">Organizational Unit Name (eg, section) []:ec2-13-112-100-143.ap-northeast-1.compute.amazonaws.com</span><br><span class="line">Common Name (eg, your name or your server&apos;s hostname) []:ec2-13-112-100-143.ap-northeast-1.compute.amazonaws.com</span><br><span class="line">Email Address []:qingjiuyeye@gmail.com</span><br><span class="line"></span><br><span class="line">Please enter the following &apos;extra&apos; attributes</span><br><span class="line">to be sent with your certificate request</span><br><span class="line">A challenge password []:</span><br><span class="line">An optional company name []:</span><br><span class="line">[root@ip-10-0-100-141 ssl]# ls</span><br><span class="line">httpd.csr  httpd.key</span><br><span class="line">[root@ip-10-0-100-141 ssl]# openssl ca -in httpd.csr -out /etc/pki/CA/httpd.crt -days 365</span><br><span class="line">Using configuration from /etc/pki/tls/openssl.cnf</span><br><span class="line">Check that the request matches the signature</span><br><span class="line">....</span><br><span class="line">Certificate is to be certified until Apr 20 07:44:24 2020 GMT (365 days)</span><br><span class="line">Sign the certificate? [y/n]:y    </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">1 out of 1 certificate requests certified, commit? [y/n]y</span><br><span class="line">Write out database with 1 new entries</span><br><span class="line">Data Base Updated</span><br><span class="line"> [root@ip-10-0-100-141 ssl]# cp /etc/pki/CA/httpd.crt .</span><br><span class="line"></span><br><span class="line">配置httpd.conf文件</span><br><span class="line">[root@ip-10-0-100-141 apache]# vim conf/httpd.conf  将以下内容取消注释</span><br><span class="line">   LoadModule ssl_module modules/mod_ssl.so</span><br><span class="line">   </span><br><span class="line">    Include conf/extra/httpd-vhosts.conf</span><br><span class="line">    Include conf/extra/httpd-ssl.conf</span><br><span class="line">在httpd-ssl.conf中配置证书的位置</span><br><span class="line">[root@server ssl]# vim /etc/httpd24/extra/httpd-ssl.conf </span><br><span class="line"></span><br><span class="line">&lt;VirtualHost 10.0.100.141:443&gt;</span><br><span class="line"></span><br><span class="line">#   General setup for the virtual host</span><br><span class="line">DocumentRoot &quot;/usr/local/apache/htdocs/wenhs&quot;</span><br><span class="line">ServerName ec2-13-112-100-143.ap-northeast-1.compute.amazonaws.com:443</span><br><span class="line">ServerAdmin you@example.com</span><br><span class="line">ErrorLog &quot;/usr/local/apache/logs/wenhs_error_log&quot;</span><br><span class="line">TransferLog &quot;/usr/local/apache/logs/wenhs_access_log&quot;</span><br><span class="line">...</span><br><span class="line">SSLCertificateFile &quot;/usr/local/apache/conf/ssl/httpd.crt&quot;</span><br><span class="line">SSLCertificateKeyFile &quot;/usr/local/apache/conf/ssl/httpd.key&quot;</span><br><span class="line">...</span><br><span class="line">填写证书的正确路径</span><br><span class="line">[root@ip-10-0-100-141 apache]# apachectl -t</span><br><span class="line">Syntax OK</span><br><span class="line">[root@ip-10-0-100-141 apache]# apachectl restart</span><br></pre></td></tr></table></figure>

<p>验证：</p>
<p><img src="../../img/20190421162707317.png" alt="httpd6"></p>

          
        
      
    </div>

    

    

    
    
    

    

    
      
    
    

    
	
	  <div>
        
      </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://aiwhs.github.io/2018/11/10/bind/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="itw">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="itw">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2018/11/10/bind/" class="post-title-link" itemprop="url">bind服务</a>
              
            
          </h1>
        

        <div class="post-meta">

          
          
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-11-10 08:15:57" itemprop="dateCreated datePublished" datetime="2018-11-10T08:15:57+08:00">2018-11-10</time>
            </span>
          

          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-07-09 17:03:40" itemprop="dateModified" datetime="2019-07-09T17:03:40+08:00">2019-07-09</time>
              </span>
            
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Linux运维/" itemprop="url" rel="index"><span itemprop="name">Linux运维</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          <br>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <a id="more"></a>

<h1 id="安装bind"><a href="#安装bind" class="headerlink" title="安装bind"></a>安装bind</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">yum install bind-chroot bind-utils</span><br><span class="line"></span><br><span class="line"># 开机启动</span><br><span class="line">systemctl enable named-chroot</span><br></pre></td></tr></table></figure>

<h1 id="配置bind"><a href="#配置bind" class="headerlink" title="配置bind"></a>配置bind</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">&gt; cat /etc/named.conf</span><br><span class="line">options &#123;</span><br><span class="line">    listen-on port 53 &#123; any; &#125;;  # 监听任何ip对53端口的请求</span><br><span class="line">    listen-on-v6 port 53 &#123; ::1; &#125;;</span><br><span class="line">    directory   &quot;/var/named&quot;;</span><br><span class="line">    dump-file   &quot;/var/named/data/cache_dump.db&quot;;</span><br><span class="line">    statistics-file &quot;/var/named/data/named_stats.txt&quot;;</span><br><span class="line">    memstatistics-file &quot;/var/named/data/named_mem_stats.txt&quot;;</span><br><span class="line">    allow-query     &#123; any; &#125;; # 接收任何来源查询dns记录</span><br><span class="line"></span><br><span class="line">    recursion yes;</span><br><span class="line"></span><br><span class="line">    dnssec-enable yes;</span><br><span class="line">    dnssec-validation yes;</span><br><span class="line"></span><br><span class="line">    bindkeys-file &quot;/etc/named.iscdlv.key&quot;;</span><br><span class="line"></span><br><span class="line">    managed-keys-directory &quot;/var/named/dynamic&quot;;</span><br><span class="line"></span><br><span class="line">    pid-file &quot;/run/named/named.pid&quot;;</span><br><span class="line">    session-keyfile &quot;/run/named/session.key&quot;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">logging &#123;</span><br><span class="line">        channel default_debug &#123;</span><br><span class="line">                file &quot;data/named.run&quot;;</span><br><span class="line">                severity dynamic;</span><br><span class="line">        &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">zone &quot;.&quot; IN &#123;</span><br><span class="line">    type hint;</span><br><span class="line">    file &quot;named.ca&quot;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">include &quot;/etc/named.rfc1912.zones&quot;;</span><br><span class="line">include &quot;/etc/named.root.key&quot;;</span><br></pre></td></tr></table></figure>

<h2 id="添加正向解析域"><a href="#添加正向解析域" class="headerlink" title="添加正向解析域"></a>添加正向解析域</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/named.rfc1912.zones</span><br><span class="line">zone &quot;wenhs.com&quot; IN &#123;</span><br><span class="line">    type master;</span><br><span class="line">    file &quot;wenhs.com.zone&quot;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="添加反向解析域"><a href="#添加反向解析域" class="headerlink" title="添加反向解析域"></a>添加反向解析域</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/named.rfc1912.zones</span><br><span class="line">zone &quot;161.168.192.in-addr.arpa&quot; IN &#123;</span><br><span class="line">    type master;</span><br><span class="line">    file &quot;161.168.192.zone&quot;;</span><br><span class="line">&#125;;</span><br><span class="line">&gt; cat /var/named/wenhs.com.zone </span><br><span class="line">$TTL 1D</span><br><span class="line">@   IN  SOA wenhs.com.   admin.wenhs.com. (</span><br><span class="line">            0   ; serial  </span><br><span class="line">            1D  ; refresh  # 主从刷新时间</span><br><span class="line">            1H  ; retry  # 主从通讯失败后重试间隔</span><br><span class="line">            1W  ; expire  # 缓存过期时间</span><br><span class="line">            3H )    ; minimum  # 没有TTL定义时的最小生存周期</span><br><span class="line">        NS  www.wenhs.com.</span><br><span class="line">        NS  ftp.wenhs.com.</span><br><span class="line">        A   127.0.0.1</span><br><span class="line">        AAAA    ::1</span><br><span class="line">        MX  10 mx.wenhs.com.</span><br><span class="line">ttl IN  A   192.168.161.88</span><br><span class="line">www     IN  A   192.168.161.88   </span><br><span class="line">bbs IN  CNAME   www</span><br><span class="line">mx  IN  A   192.168.161.88</span><br><span class="line">ftp IN  A   192.168.161.88</span><br><span class="line"></span><br><span class="line">&gt; &gt; cat /var/named/161.168.192.zone </span><br><span class="line">$TTL 1D</span><br><span class="line">@       IN      SOA     wenhs.com. admin.wenhs.com. (</span><br><span class="line">                         0</span><br><span class="line">                         2H</span><br><span class="line">                         10M</span><br><span class="line">                         7D</span><br><span class="line">                         1D )</span><br><span class="line">        NS  ttl.wenhs.com.</span><br><span class="line">        A   127.0.0.1</span><br><span class="line">        AAAA    ::1</span><br><span class="line">88  IN      PTR     wenhs.com</span><br><span class="line">88  IN      PTR     www.wenhs.com.</span><br><span class="line">88  IN      PTR     ftp.wenhs.com.</span><br><span class="line">88  IN      PTR     mx.wenhs.com.</span><br></pre></td></tr></table></figure>

<p><strong>注意：一点要给权限*</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">chown named.named 161.168.192.zone </span><br><span class="line">chmod 755 wenhs.com.zone </span><br><span class="line">chmod 755 161.168.192.zone</span><br></pre></td></tr></table></figure>

<h1 id="启动bind"><a href="#启动bind" class="headerlink" title="启动bind"></a>启动bind</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl start named-chroot</span><br></pre></td></tr></table></figure>

<h1 id="检查配置"><a href="#检查配置" class="headerlink" title="检查配置"></a>检查配置</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; named-checkzone &quot;wenhs.com&quot; /var/named/wenhs.com.zone</span><br><span class="line">zone wenhs.com/IN: loaded serial 0</span><br><span class="line">OK</span><br></pre></td></tr></table></figure>

<h1 id="本地测试解析"><a href="#本地测试解析" class="headerlink" title="本地测试解析"></a>本地测试解析</h1><blockquote>
<p>将本机的DNS修改为192.168.161.88(上面的dns服务器地址)， 打开cmd</p>
</blockquote>
<h2 id="查询-wenhs-com-的dns记录"><a href="#查询-wenhs-com-的dns记录" class="headerlink" title="查询 wenhs.com 的dns记录"></a>查询 <code>wenhs.com</code> 的dns记录</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\Administrator&gt;nslookup -qt=A wenhs.com</span><br><span class="line">服务器:  UnKnown</span><br><span class="line">Address:  192.168.161.88</span><br><span class="line"></span><br><span class="line">名称:    wenhs.com</span><br><span class="line">Addresses:  127.0.0.1</span><br><span class="line">          192.168.161.88</span><br></pre></td></tr></table></figure>

<h2 id="查询-www-wenhs-com-的dns记录"><a href="#查询-www-wenhs-com-的dns记录" class="headerlink" title="查询 www.wenhs.com 的dns记录"></a>查询 <code>www.wenhs.com</code> 的dns记录</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\Administrator&gt;nslookup -qt=A www.wenhs.com</span><br><span class="line">服务器:  UnKnown</span><br><span class="line">Address:  192.168.161.88</span><br><span class="line"></span><br><span class="line">名称:    www.wenhs.com</span><br><span class="line">Address:  192.168.161.88</span><br><span class="line"></span><br><span class="line">C:\Users\Administrator&gt;nslookup mx.wenhs.com</span><br><span class="line">服务器:  www.wenhs.com</span><br><span class="line">Address:  192.168.161.88</span><br><span class="line"></span><br><span class="line">名称:    mx.wenhs.com</span><br><span class="line">Address:  192.168.161.88</span><br></pre></td></tr></table></figure>
          
        
      
    </div>

    

    

    
    
    

    

    
      
    
    

    
	
	  <div>
        
      </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://aiwhs.github.io/2018/11/04/SAMBA/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="itw">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="itw">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2018/11/04/SAMBA/" class="post-title-link" itemprop="url">samba</a>
              
            
          </h1>
        

        <div class="post-meta">

          
          
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-11-04 08:15:57" itemprop="dateCreated datePublished" datetime="2018-11-04T08:15:57+08:00">2018-11-04</time>
            </span>
          

          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-07-12 15:11:06" itemprop="dateModified" datetime="2019-07-12T15:11:06+08:00">2019-07-12</time>
              </span>
            
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Linux运维/" itemprop="url" rel="index"><span itemprop="name">Linux运维</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          <br>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <a id="more"></a>

<h1 id="samba简介"><a href="#samba简介" class="headerlink" title="samba简介"></a>samba简介</h1><p><strong>Samba</strong>是在Linux和UNIX系统上实现SMB协议的一个免费软件，由服务器及客户端程序构成。</p>
<p><strong>SMB</strong>（Server Messages    Block，信息服务块）是一种<strong>在局域网上共享文件和打印机的一种通信协议</strong>，它为局域网内的<strong>不同计算机之间提供文件及打印机等资源的共享服务。</strong></p>
<p><strong>SMB</strong>协议是<strong>客户机/服务器</strong>型协议，客户机通过该协议可以访问服务器上的<strong>共享文件系统、打印机及其他资源</strong>。</p>
<h3 id="samba监听端口"><a href="#samba监听端口" class="headerlink" title="samba监听端口"></a>samba监听端口</h3><ul>
<li><code>TCP——139、445</code>，tcp端口相对应的服务是smbd服务，其作用是提供服务器中文件、打印资源的共享访问；</li>
<li><code>UDP——137、138</code>，udp端口相对应的服务是nmbd服务，起作用是提供基于NetBOIS主机名称的解析。</li>
</ul>
<h3 id="samba进程："><a href="#samba进程：" class="headerlink" title="samba进程："></a>samba进程：</h3><table>
<thead>
<tr>
<th>进程</th>
<th>对应</th>
</tr>
</thead>
<tbody><tr>
<td>nmbd</td>
<td>对应netbios</td>
</tr>
<tr>
<td>smbd</td>
<td>对应cifs协议</td>
</tr>
<tr>
<td>winbindd + ldap</td>
<td>对应Windows AD活动目录</td>
</tr>
</tbody></table>
<h3 id="samba用户："><a href="#samba用户：" class="headerlink" title="samba用户："></a>samba用户：</h3><table>
<thead>
<tr>
<th>帐号</th>
<th>密码</th>
</tr>
</thead>
<tbody><tr>
<td>都是系统用户/etc/passwd</td>
<td>Samba服务自有密码文件通过smbpasswd -a USERNAME命令设置</td>
</tr>
</tbody></table>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">smbpasswd</span><br><span class="line"> -L	本地模式（必须是第一选项）</span><br><span class="line">   -h	打印此用法消息</span><br><span class="line">   -s	使用stdin进行密码提示</span><br><span class="line">   -c smb.conf	文件使用smb.conf文件的给定路径</span><br><span class="line">   -D LEVEL	调试级别</span><br><span class="line">   -r MACHINE	远程机器</span><br><span class="line">   -U USER	远程用户名（例如SAM /用户）</span><br><span class="line">在root或本地模式下运行时的额外选项：</span><br><span class="line">   -a	添加用户</span><br><span class="line">   -d	禁用用户</span><br><span class="line">   -e	启用用户</span><br><span class="line">   -i	域间信任帐户</span><br><span class="line">   -m	机器信托帐户</span><br><span class="line">   -n	设置无密码</span><br><span class="line">   -W	使用stdin ldap管理员密码</span><br><span class="line">   -w PASSWORD 	ldap管理员密码</span><br><span class="line">   -x	删除用户</span><br><span class="line">   -R 	ORDER名称解析顺序</span><br></pre></td></tr></table></figure>

<h3 id="Samba安全级别："><a href="#Samba安全级别：" class="headerlink" title="Samba安全级别："></a>Samba安全级别：</h3><p>Samba服务器的安全级别有三个，分别是user，server，domain</p>
<table>
<thead>
<tr>
<th>安全级别</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td>user</td>
<td>基于本地的验证</td>
</tr>
<tr>
<td>server</td>
<td>由另一台指定的服务器对用户身份进行认证</td>
</tr>
<tr>
<td>domain</td>
<td>由域控进行身份验证</td>
</tr>
</tbody></table>
<blockquote>
<p>以前的samba版本支持的安全级别有四个，分别是share，user，server，domain</p>
<p>share是用来设置匿名访问的，但现在的版本已经不支持share了，但是还是可以实现匿名访问的 只是配置方式变了</p>
</blockquote>
<h3 id="samba配置文件："><a href="#samba配置文件：" class="headerlink" title="samba配置文件："></a>samba配置文件：</h3><ul>
<li>/etc/samba/smb.conf(主配置文件)</li>
</ul>
<table>
<thead>
<tr>
<th>samba三大组成</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td>[global]</td>
<td>全局配置，此处的设置项对整个samba服务器都有效</td>
</tr>
<tr>
<td>[homes]</td>
<td>宿主目录共享设置，此处用来设置Linux用户的默认共享，对应用户的宿主目录。当用户访问服务器中与自己用户名同名的共享目录时，通过验证后将会自动映射到该用户的宿主目录中</td>
</tr>
<tr>
<td>[printers]</td>
<td>打印机共享设置</td>
</tr>
</tbody></table>
<h3 id="常用配置文件参数："><a href="#常用配置文件参数：" class="headerlink" title="常用配置文件参数："></a>常用配置文件参数：</h3><table>
<thead>
<tr>
<th>参数</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td>workgroup</td>
<td>表示设置工作组名称</td>
</tr>
<tr>
<td>server string</td>
<td>表示描述samba服务器</td>
</tr>
<tr>
<td>security</td>
<td>表示设置安全级别，其值可为share、user、server、domain</td>
</tr>
<tr>
<td>passdb backend</td>
<td>表示设置共享帐户文件的类型，其值可为tdbsam（tdb数据库文件）、ldapsam（LDAP目录认证）、smbpasswd（兼容旧版本samba密码文件）</td>
</tr>
<tr>
<td>comment</td>
<td>表示设置对应共享目录的注释，说明信息，即文件共享名</td>
</tr>
<tr>
<td>browseable</td>
<td>表示设置共享是否可见</td>
</tr>
<tr>
<td>writable</td>
<td>表示设置目录是否可写</td>
</tr>
<tr>
<td>path</td>
<td>表示共享目录的路径</td>
</tr>
<tr>
<td>guest ok</td>
<td>表示设置是否所有人均可访问共享目录</td>
</tr>
<tr>
<td>public</td>
<td>表示设置是否允许匿名用户访问</td>
</tr>
<tr>
<td>write list</td>
<td>表示设置允许写的用户和组，组要用@表示，例如 write list = root,@root</td>
</tr>
<tr>
<td>valid users</td>
<td>设置可以访问的用户和组，例如 valid users = root,@root</td>
</tr>
<tr>
<td>hosts deny</td>
<td>设置拒绝哪台主机访问，例如 hosts deny = 192.168.72.1</td>
</tr>
<tr>
<td>hosts allow</td>
<td>设置允许哪台主机访问，例如 hosts allow = 192.168.72.2</td>
</tr>
<tr>
<td>printable</td>
<td>表示设置是否为打印机</td>
</tr>
</tbody></table>
<p><strong>测试配置文件是否有语法错误，以及显示最终生效的配置：使用testparm命令</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">交互式数据访问</span><br><span class="line">smbclient -L HOST -U USERNAME</span><br><span class="line">smbclient //SERVER/shared_name -U USERNAME</span><br><span class="line"></span><br><span class="line">基于挂载的方式访问</span><br><span class="line">mount -t cifs //SERVER/shared_name /挂载到本地的什么目录 -o username=USERNAME,password=PASSWORD</span><br><span class="line"></span><br><span class="line">/etc/fstab写法</span><br><span class="line">//SERVER/shared_name /挂载到本地的什么目录	cifs	defaults,username=USERNAME,password=PASSWORD	0	0</span><br></pre></td></tr></table></figure>

<h3 id="实验"><a href="#实验" class="headerlink" title="实验"></a>实验</h3><ul>
<li>搭建匿名用户共享服务器</li>
<li>搭建用户认证共享服务器<br> <strong>要求：</strong><ul>
<li>不论是匿名用户还是用户认证共享，均要在客户机验证结果</li>
<li>用户认证共享需要映射系统用户为一个虚拟用户</li>
</ul>
</li>
</ul>
<h3 id="搭建环境"><a href="#搭建环境" class="headerlink" title="搭建环境"></a>搭建环境</h3><ul>
<li><p>本实验的linux跑在vm15虚拟机软件中,网卡模式为桥接</p>
</li>
<li><p>服务器系统版本为centos 7.6版本,客户端有centos7.6和本机win10</p>
</li>
<li><p>实验前关闭防火墙以及selinux</p>
</li>
<li><p>实验所用地址如下：</p>
</li>
<li><p>服务器[wenhs5479]地址为192.168.42.87/24</p>
<p><img src="../../img/smb1.png" alt="smb1"></p>
</li>
<li><p>客户端[wenhs-docker-ce]地址为192.168.42.45/24</p>
</li>
</ul>
<p><img src="../../img/smb2.png" alt="smb2"></p>
<ul>
<li>客户端win10地址192.168.42.46/24</li>
</ul>
<p><img src="../../img/20190416175204126.png" alt="smb3"></p>
<ul>
<li>注意系统版本；</li>
<li>主配置文件/etc/samba/smb.conf</li>
<li>用户映射文件/etc/ samba/smbusers</li>
<li>请先检查地址能否相互ping通</li>
</ul>
<p><strong>注意:</strong> 环境由于部分原因导致换了IP,不影响最终实验,看得懂就看,看不懂请从最基础的学起,实验初始IP是手打的字,后来改成了图片里面的IP,下面实验,一定要弄清楚谁是服务器,谁是客户端</p>
<h3 id="搭建步骤"><a href="#搭建步骤" class="headerlink" title="搭建步骤"></a>搭建步骤</h3><ul>
<li>搭建匿名用户共享服务器</li>
</ul>
<p>首先在服务器端安装samba服务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install samba-*</span><br></pre></td></tr></table></figure>

<p>在服务器端创建共享目录</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /samba/test</span><br></pre></td></tr></table></figure>

<p>在服务器端修改/etc/samba/smb.conf配置文件，添加以下内容</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[globol]</span><br><span class="line">		map to guest = Bad User #设置匿名用户</span><br><span class="line">[test]</span><br><span class="line">        comment = test 		#共享目录的注释</span><br><span class="line">        path = /samba/test 	#共享目录的路径</span><br><span class="line">        browseable = yes 		#共享目录可见</span><br><span class="line">        public = yes 			#允许匿名用户访问</span><br><span class="line">        writable = yes 		#允许用户在目录下写</span><br><span class="line">        guest ok = yes 		#允许所有人访问共享目录</span><br></pre></td></tr></table></figure>

<p>在服务器端修改权限，将/samba/test目录的其他人权限设置成rw，才能在客户端进行写操作，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod o+w /samba/test</span><br></pre></td></tr></table></figure>

<p>测试配置文件是否有语法错误</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">[root@wenhs5479 samba]# testparm </span><br><span class="line">Load smb config files from /etc/samba/smb.conf</span><br><span class="line">rlimit_max: increasing rlimit_max (1024) to minimum Windows limit (16384)</span><br><span class="line">Processing section &quot;[homes]&quot;</span><br><span class="line">Processing section &quot;[printers]&quot;</span><br><span class="line">Processing section &quot;[print$]&quot;</span><br><span class="line">Processing section &quot;[test]&quot;</span><br><span class="line">Loaded services file OK.</span><br><span class="line">Server role: ROLE_STANDALONE</span><br><span class="line"></span><br><span class="line">Press enter to see a dump of your service definitions</span><br><span class="line"></span><br><span class="line"># Global parameters</span><br><span class="line">[global]</span><br><span class="line">	map to guest = Bad User</span><br><span class="line">	printcap name = cups</span><br><span class="line">	security = USER</span><br><span class="line">	workgroup = SAMBA</span><br><span class="line">	idmap config * : backend = tdb</span><br><span class="line">	cups options = raw</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[homes]</span><br><span class="line">	browseable = No</span><br><span class="line">	comment = Home Directories</span><br><span class="line">	inherit acls = Yes</span><br><span class="line">	read only = No</span><br><span class="line">	valid users = %S %D%w%S</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[printers]</span><br><span class="line">	browseable = No</span><br><span class="line">	comment = All Printers</span><br><span class="line">	create mask = 0600</span><br><span class="line">	path = /var/tmp</span><br><span class="line">	printable = Yes</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[print$]</span><br><span class="line">	comment = Printer Drivers</span><br><span class="line">	create mask = 0664</span><br><span class="line">	directory mask = 0775</span><br><span class="line">	force group = @printadmin</span><br><span class="line">	path = /var/lib/samba/drivers</span><br><span class="line">	write list = @printadmin root</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[test]</span><br><span class="line">	comment = test</span><br><span class="line">	guest ok = Yes</span><br><span class="line">	path = /samba/test</span><br><span class="line">	read only = No</span><br></pre></td></tr></table></figure>

<ul>
<li>重新启动samba服务</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart smb nmb</span><br></pre></td></tr></table></figure>

<ul>
<li>查看端口是否开启</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@wenhs5479 samba]# ss -anltup|grep smb</span><br><span class="line">tcp    LISTEN     0      50        *:139                   *:*                   users:((&quot;smbd&quot;,pid=22277,fd=36))</span><br><span class="line">tcp    LISTEN     0      50        *:445                   *:*                   users:((&quot;smbd&quot;,pid=22277,fd=35))</span><br><span class="line">tcp    LISTEN     0      50       :::139                  :::*                   users:((&quot;smbd&quot;,pid=22277,fd=34))</span><br><span class="line">tcp    LISTEN     0      50       :::445                  :::*                   users:((&quot;smbd&quot;,pid=22277,fd=33))</span><br></pre></td></tr></table></figure>

<ul>
<li>在客户端上安装samba-client，然后在客户端上进行验证</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install samba-client</span><br></pre></td></tr></table></figure>

<ul>
<li>交互式验证查看：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@wenhs-docker-ce ~]# smbclient -L 192.168.42.87 -U &apos;Bad User&apos;</span><br><span class="line">Enter SAMBA\Bad User&apos;s password: 		#这里直接回车即可,并没有密码</span><br><span class="line"></span><br><span class="line">	Sharename       Type      Comment</span><br><span class="line">	---------       ----      -------</span><br><span class="line">	print$          Disk      Printer Drivers</span><br><span class="line">	test            Disk      test</span><br><span class="line">	IPC$            IPC       IPC Service (Samba 4.8.3)</span><br><span class="line">Reconnecting with SMB1 for workgroup listing.</span><br><span class="line"></span><br><span class="line">	Server               Comment</span><br><span class="line">	---------            -------</span><br><span class="line"></span><br><span class="line">	Workgroup            Master</span><br><span class="line">	---------            -------</span><br><span class="line">	SAMBA                WENHS5479</span><br></pre></td></tr></table></figure>

<ul>
<li>交互式访问共享：(远程主机地址后接共享目录的名字，一般不用)</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@wenhs-docker-ce ~]# smbclient //192.168.42.87/test -U &apos;Bad User&apos;</span><br><span class="line">Enter SAMBA\Bad User&apos;s password: 		#这里直接回车即可,并没有密码</span><br><span class="line">Try &quot;help&quot; to get a list of possible commands.</span><br><span class="line">smb: \&gt; mkdir centosclient</span><br><span class="line">smb: \&gt; ls</span><br><span class="line">  .                                   D        0  Tue Apr 16 15:21:55 2019</span><br><span class="line">  ..                                  D        0  Tue Apr 16 14:53:46 2019</span><br><span class="line">  centosclient                        D        0  Tue Apr 16 15:21:55 2019</span><br><span class="line"></span><br><span class="line">		13092864 blocks of size 1024. 7008284 blocks available</span><br><span class="line"></span><br><span class="line">smb: \&gt; q		#quit退出</span><br><span class="line">[root@wenhs-docker-ce ~]#</span><br></pre></td></tr></table></figure>

<p><img src="../../img/smb4.png" alt="smb4"></p>
<p><img src="../../img/smb5.png" alt="smb5"></p>
<ul>
<li>在服务器上查看创建的文件和目录</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@wenhs5479 ~]# ls -al /samba/test/</span><br><span class="line">总用量 0</span><br><span class="line">drwxr-xrwx. 4 root   root   45 4月  16 15:24 .</span><br><span class="line">drwxr-xr-x. 3 root   root   18 4月  16 14:53 ..</span><br><span class="line">drwxr-xr-x. 2 nobody nobody  6 4月  16 15:21 centosclient</span><br><span class="line">drwxr-xr-x. 2 nobody nobody  6 4月  16 15:24 win10client</span><br></pre></td></tr></table></figure>

<ul>
<li>挂载式访问共享：(远程主机地址后接共享目录的名字)</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@wenhs-docker-ce ~]# mkdir /samba				#创建挂载目录</span><br><span class="line">[root@wenhs-docker-ce ~]# mount -t cifs //192.168.42.87/test /samba -o username=&apos;Bad User&apos;</span><br><span class="line">Password for Bad User@//192.168.42.87/test:  		#直接回车确认</span><br><span class="line">[root@wenhs-docker-ce ~]# df -Th</span><br><span class="line">文件系统                类型      容量  已用  可用 已用% 挂载点</span><br><span class="line">/dev/mapper/centos-root xfs        36G  6.4G   30G   18% /</span><br><span class="line">devtmpfs                devtmpfs  1.9G     0  1.9G    0% /dev</span><br><span class="line">tmpfs                   tmpfs     1.9G     0  1.9G    0% /dev/shm</span><br><span class="line">tmpfs                   tmpfs     1.9G   13M  1.9G    1% /run</span><br><span class="line">tmpfs                   tmpfs     1.9G     0  1.9G    0% /sys/fs/cgroup</span><br><span class="line">/dev/sda1               xfs      1014M  233M  782M   23% /boot</span><br><span class="line">/dev/mapper/centos-home xfs        18G   37M   18G    1% /home</span><br><span class="line">tmpfs                   tmpfs     378M  4.0K  378M    1% /run/user/42</span><br><span class="line">tmpfs                   tmpfs     378M   20K  378M    1% /run/user/0</span><br><span class="line">/dev/sr0                iso9660    11G   11G     0  100% /run/media/root/CentOS 7 x86_64</span><br><span class="line">//192.168.42.87/test    cifs       13G  5.9G  6.7G   47% /samba</span><br><span class="line">[root@wenhs-docker-ce ~]#</span><br></pre></td></tr></table></figure>

<p>win10映射网络驱动器:\192.168.42.87\test,确认即可</p>
<p><img src="../../img/smb6.png" alt="smb6"></p>
<h3 id="搭建用户共享服务器"><a href="#搭建用户共享服务器" class="headerlink" title="搭建用户共享服务器"></a>搭建用户共享服务器</h3><ul>
<li>创建用户，将用户设置为samba专用用户，并设置专用密码</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@wenhs5479 ~]# useradd wenhs</span><br><span class="line">[root@wenhs5479 ~]# smbpasswd -a wenhs</span><br><span class="line">New SMB password:</span><br><span class="line">Retype new SMB password:</span><br><span class="line">Added user wenhs.</span><br></pre></td></tr></table></figure>

<ul>
<li>创建/samba/wenhs共享目录，并将权限改为757。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@wenhs5479 ~]# mkdir /samba/wenhs</span><br><span class="line">[root@wenhs5479 ~]# chmod 757 /samba/wenhs/</span><br></pre></td></tr></table></figure>

<ul>
<li>假设将wenhs用户映射为share用户，修改/etc/samba/smbusers文件添加如下内容：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@wenhs5479 ~]# echo &apos;wenhs = share&apos; &gt;/etc/samba/smbusers</span><br></pre></td></tr></table></figure>

<ul>
<li>在服务器端修改配置文件/etc/samba/smb.conf内容</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[global]</span><br><span class="line">        username map = /etc/samba/smbusers		#指定本地用户映射成虚拟用户的文件存放位置</span><br><span class="line">[wenhs]</span><br><span class="line">        comment = wenhs</span><br><span class="line">        path = /samba/wenhs</span><br><span class="line">        browseable = yes</span><br><span class="line">        write list = wenhs	#指定wenhs用户进行读写访问，不管这个共享是否是只读文件</span><br><span class="line">        guest ok = yes</span><br><span class="line">        public = yes</span><br></pre></td></tr></table></figure>

<ul>
<li>检查配置文件</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">[root@wenhs5479 ~]# testparm </span><br><span class="line">Load smb config files from /etc/samba/smb.conf</span><br><span class="line">rlimit_max: increasing rlimit_max (1024) to minimum Windows limit (16384)</span><br><span class="line">Processing section &quot;[homes]&quot;</span><br><span class="line">Processing section &quot;[printers]&quot;</span><br><span class="line">Processing section &quot;[print$]&quot;</span><br><span class="line">Processing section &quot;[test]&quot;</span><br><span class="line">Processing section &quot;[wenhs]&quot;</span><br><span class="line">Loaded services file OK.</span><br><span class="line">Server role: ROLE_STANDALONE</span><br><span class="line"></span><br><span class="line">Press enter to see a dump of your service definitions</span><br><span class="line"></span><br><span class="line"># Global parameters</span><br><span class="line">[global]</span><br><span class="line">	map to guest = Bad User</span><br><span class="line">	printcap name = cups</span><br><span class="line">	security = USER</span><br><span class="line">	username map = /etc/samba/smbusers</span><br><span class="line">	workgroup = SAMBA</span><br><span class="line">	idmap config * : backend = tdb</span><br><span class="line">	cups options = raw</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[homes]</span><br><span class="line">	browseable = No</span><br><span class="line">	comment = Home Directories</span><br><span class="line">	inherit acls = Yes</span><br><span class="line">	read only = No</span><br><span class="line">	valid users = %S %D%w%S</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[printers]</span><br><span class="line">	browseable = No</span><br><span class="line">	comment = All Printers</span><br><span class="line">	create mask = 0600</span><br><span class="line">	path = /var/tmp</span><br><span class="line">	printable = Yes</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[print$]</span><br><span class="line">	comment = Printer Drivers</span><br><span class="line">	create mask = 0664</span><br><span class="line">	directory mask = 0775</span><br><span class="line">	force group = @printadmin</span><br><span class="line">	path = /var/lib/samba/drivers</span><br><span class="line">	write list = @printadmin root</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[test]</span><br><span class="line">	comment = test</span><br><span class="line">	guest ok = Yes</span><br><span class="line">	path = /samba/test</span><br><span class="line">	read only = No</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[wenhs]</span><br><span class="line">	comment = wenhs</span><br><span class="line">	guest ok = Yes</span><br><span class="line">	path = /samba/wenhs</span><br><span class="line">	write list = wenhs</span><br></pre></td></tr></table></figure>

<ul>
<li>重启服务</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart smb nmb</span><br></pre></td></tr></table></figure>

<ul>
<li>在客户端进行验证：</li>
<li>交互式验证查看</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@wenhs-docker-ce ~]# smbclient -L 192.168.42.87 -U share</span><br><span class="line">Enter SAMBA\share&apos;s password: </span><br><span class="line"></span><br><span class="line">	Sharename       Type      Comment</span><br><span class="line">	---------       ----      -------</span><br><span class="line">	print$          Disk      Printer Drivers</span><br><span class="line">	test            Disk      test</span><br><span class="line">	wenhs           Disk      wenhs</span><br><span class="line">	IPC$            IPC       IPC Service (Samba 4.8.3)</span><br><span class="line">Reconnecting with SMB1 for workgroup listing.</span><br><span class="line"></span><br><span class="line">	Server               Comment</span><br><span class="line">	---------            -------</span><br><span class="line"></span><br><span class="line">	Workgroup            Master</span><br><span class="line">	---------            -------</span><br><span class="line">	SAMBA                WENHS5479</span><br></pre></td></tr></table></figure>

<ul>
<li>交互式访问共享目录，（一般不用）</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@wenhs-docker-ce ~]# smbclient //192.168.42.87/wenhs -U share</span><br><span class="line">Enter SAMBA\share&apos;s password: </span><br><span class="line">Try &quot;help&quot; to get a list of possible commands.</span><br><span class="line">smb: \&gt; mkdir centosclient</span><br><span class="line">smb: \&gt; ls</span><br><span class="line">  .                                   D        0  Tue Apr 16 16:12:36 2019</span><br><span class="line">  ..                                  D        0  Tue Apr 16 15:55:47 2019</span><br><span class="line">  centosclient                        D        0  Tue Apr 16 16:12:36 2019</span><br><span class="line"></span><br><span class="line">		13092864 blocks of size 1024. 7007108 blocks available</span><br><span class="line">smb: \&gt; q</span><br><span class="line">[root@wenhs-docker-ce ~]#</span><br><span class="line">注：用户名用映射用户登录,密码还是wenhs的密码</span><br></pre></td></tr></table></figure>

<p><img src="../../img/smb7.png" alt="smb7"></p>
<p><img src="../../img/smb8.png" alt="smb8"></p>
<ul>
<li>挂载式访问共享目录</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@wenhs-docker-ce ~]# mkdir /wenhs</span><br><span class="line">[root@wenhs-docker-ce ~]# mount -t cifs //192.168.42.87/wenhs /wenhs -o username=share,password=123456</span><br><span class="line">[root@wenhs-docker-ce ~]# df -Th</span><br><span class="line">文件系统                类型      容量  已用  可用 已用% 挂载点</span><br><span class="line">/dev/mapper/centos-root xfs        36G  6.4G   30G   18% /</span><br><span class="line">devtmpfs                devtmpfs  1.9G     0  1.9G    0% /dev</span><br><span class="line">tmpfs                   tmpfs     1.9G     0  1.9G    0% /dev/shm</span><br><span class="line">tmpfs                   tmpfs     1.9G   13M  1.9G    1% /run</span><br><span class="line">tmpfs                   tmpfs     1.9G     0  1.9G    0% /sys/fs/cgroup</span><br><span class="line">/dev/sda1               xfs      1014M  233M  782M   23% /boot</span><br><span class="line">/dev/mapper/centos-home xfs        18G   37M   18G    1% /home</span><br><span class="line">tmpfs                   tmpfs     378M  4.0K  378M    1% /run/user/42</span><br><span class="line">tmpfs                   tmpfs     378M   20K  378M    1% /run/user/0</span><br><span class="line">/dev/sr0                iso9660    11G   11G     0  100% /run/media/root/CentOS 7 x86_64</span><br><span class="line">//192.168.42.87/test    cifs       13G  5.9G  6.7G   47% /samba</span><br><span class="line">//192.168.42.87/wenhs   cifs       13G  5.9G  6.7G   47% /wenhs</span><br></pre></td></tr></table></figure>

<p><img src="../../img/smb9.png" alt="smb9"></p>
<p><strong>创建目录进行查看效果：</strong></p>
<ul>
<li>挂载式共享创建 [客户端] 目录</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@wenhs-docker-ce wenhs]# mkdir centos222</span><br><span class="line">[root@wenhs-docker-ce wenhs]# ls -al</span><br><span class="line">总用量 0</span><br><span class="line">drwxr-xr-x   2 root root   0 4月  16 16:53 .</span><br><span class="line">dr-xr-xr-x. 20 root root 261 4月  16 16:47 ..</span><br><span class="line">drwxr-xr-x   2 root root   0 4月  16 16:53 centos222</span><br><span class="line">drwxr-xr-x   2 root root   0 4月  16 16:12 centosclient</span><br><span class="line">drwxr-xr-x   2 root root   0 4月  16 16:31 win10client</span><br></pre></td></tr></table></figure>

<p><img src="../../img/20190416165806311.png" alt="smb10"></p>
<ul>
<li>服务端进行查看</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@wenhs5479 ~]# ls -al /samba/wenhs/</span><br><span class="line">总用量 0</span><br><span class="line">drwxr-xrwx. 6 root  root  78 4月  16 16:56 .</span><br><span class="line">drwxr-xr-x. 4 root  root  31 4月  16 15:55 ..</span><br><span class="line">drwxr-xr-x. 2 wenhs wenhs  6 4月  16 16:53 centos222</span><br><span class="line">drwxr-xr-x. 2 wenhs wenhs  6 4月  16 16:12 centosclient</span><br><span class="line">drwxr-xr-x. 2 wenhs wenhs  6 4月  16 16:56 win10222</span><br><span class="line">drwxr-xr-x. 2 wenhs wenhs  6 4月  16 16:31 win10client</span><br></pre></td></tr></table></figure>

<h3 id="设置指定用户访问共享文件夹"><a href="#设置指定用户访问共享文件夹" class="headerlink" title="设置指定用户访问共享文件夹"></a>设置指定用户访问共享文件夹</h3><ul>
<li>创建一个samba用户</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@wenhs5479 ~]# useradd -M whs</span><br><span class="line">[root@wenhs5479 ~]# smbpasswd -a whs</span><br><span class="line">New SMB password:</span><br><span class="line">Retype new SMB password:</span><br><span class="line">Added user whs.</span><br></pre></td></tr></table></figure>

<ul>
<li>在etc/samba/smb.conf配置文件中加入“vaild users = wenhs”</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[wenhs]</span><br><span class="line">        comment = wenhs</span><br><span class="line">        path = /samba/wenhs</span><br><span class="line">        browseable = yes</span><br><span class="line">        write list = wenhs</span><br><span class="line">        guest ok = yes</span><br><span class="line">        public = yes</span><br><span class="line">        valid users = wenhs		#允许wenhs用户进行访问，其他用户不允许访问（添加到配置文件）</span><br></pre></td></tr></table></figure>

<ul>
<li>重新启动服务</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart smb nmb</span><br></pre></td></tr></table></figure>

<ul>
<li>测试</li>
</ul>
<p><img src="../../img/smb11.png" alt="smb11"></p>

          
        
      
    </div>

    

    

    
    
    

    

    
      
    
    

    
	
	  <div>
        
      </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://aiwhs.github.io/2018/11/03/tomcat/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="itw">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="itw">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2018/11/03/tomcat/" class="post-title-link" itemprop="url">tomcat</a>
              
            
          </h1>
        

        <div class="post-meta">

          
          
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-11-03 08:15:57" itemprop="dateCreated datePublished" datetime="2018-11-03T08:15:57+08:00">2018-11-03</time>
            </span>
          

          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-07-12 15:13:51" itemprop="dateModified" datetime="2019-07-12T15:13:51+08:00">2019-07-12</time>
              </span>
            
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Linux运维/" itemprop="url" rel="index"><span itemprop="name">Linux运维</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          <br>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <a id="more"></a>

<h2 id="1-tomcat简介"><a href="#1-tomcat简介" class="headerlink" title="1. tomcat简介"></a>1. tomcat简介</h2><blockquote>
<p>Tomcat是Apache 软件基金会（Apache Software Foundation）的Jakarta 项目中的一个核心项目，由Apache、Sun 和其他一些公司及个人共同开发而成。由于有了Sun 的参与和支持，最新的Servlet 和JSP 规范总是能在Tomcat 中得到体现，Tomcat 5支持最新的Servlet 2.4 和JSP 2.0 规范。因为Tomcat 技术先进、性能稳定，而且免费，因而深受Java 爱好者的喜爱并得到了部分软件开发商的认可，成为目前比较流行的Web 应用服务器。</p>
<p>Tomcat 服务器是一个免费的开放源代码的Web 应用服务器，属于轻量级应用服务器，在中小型系统和并发访问用户不是很多的场合下被普遍使用，是开发和调试JSP 程序的首选。对于一个初学者来说，可以这样认为，当在一台机器上配置好Apache 服务器，可利用它响应HTML（标准通用标记语言下的一个应用）页面的访问请求。实际上Tomcat是Apache 服务器的扩展，但运行时它是独立运行的，所以当你运行tomcat 时，它实际上作为一个与Apache 独立的进程单独运行的。</p>
<p>诀窍是，当配置正确时，Apache 为HTML页面服务，而Tomcat 实际上运行JSP 页面和Servlet。另外，Tomcat和IIS等Web服务器一样，具有处理HTML页面的功能，另外它还是一个Servlet和JSP容器，独立的Servlet容器是Tomcat的默认模式。不过，Tomcat处理静态HTML的能力不如Apache服务器。目前Tomcat最新版本为9.0。</p>
</blockquote>
<p>tomcat就是传说中的中间件之一，tomcat本身是一个容器，专门用来运行java程序，java语言开发的网页.jsp就应该运行于tomcat中。而tomcat本身的运行也依赖于jdk环境。</p>
<p>tomcat应用场景：<code>lnmt</code></p>
<h2 id="2-tomcat项目部署"><a href="#2-tomcat项目部署" class="headerlink" title="2. tomcat项目部署"></a>2. tomcat项目部署</h2><h3 id="2-1-java环境安装"><a href="#2-1-java环境安装" class="headerlink" title="2.1 java环境安装"></a>2.1 java环境安装</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">安装jdk环境</span><br><span class="line">[root@localhost ~]# yum -y install java-1.8.0-openjdk java-1.8.0-openjdk-devel</span><br><span class="line">.....安装过程略</span><br><span class="line"></span><br><span class="line">查看安装的版本</span><br><span class="line">[root@localhost ~]# java -version</span><br><span class="line">openjdk version &quot;1.8.0_131&quot;</span><br><span class="line">OpenJDK Runtime Environment (build 1.8.0_131-b12)</span><br><span class="line">OpenJDK 64-Bit Server VM (build 25.131-b12, mixed mode)</span><br></pre></td></tr></table></figure>

<h3 id="2-2-tomcat部署"><a href="#2-2-tomcat部署" class="headerlink" title="2.2 tomcat部署"></a>2.2 tomcat部署</h3><p>上<a href="http://tomcat.apache.org/" target="_blank" rel="noopener">官网</a>下载tomcat</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">下载tomcat</span><br><span class="line">[root@localhost ~]# cd /usr/src/</span><br><span class="line">[root@localhost src]# wget https://archive.apache.org/dist/tomcat/tomcat-9/v9.0.8/bin/apache-tomcat-9.0.8.tar.gz</span><br><span class="line"></span><br><span class="line">解压部署</span><br><span class="line">[root@localhost src]# ls</span><br><span class="line">apache-tomcat-9.0.8.tar.gz  debug  kernels</span><br><span class="line">[root@localhost src]# tar xf apache-tomcat-9.0.8.tar.gz -C /usr/local/</span><br><span class="line">[root@localhost src]# cd /usr/local/</span><br><span class="line">[root@localhost local]# ln -s apache-tomcat-9.0.8/ tomcat</span><br><span class="line">[root@localhost local]# ll</span><br><span class="line">total 0</span><br><span class="line">drwxr-xr-x. 9 root root 160 Sep  4 19:45 apache-tomcat-9.0.8</span><br><span class="line">drwxr-xr-x. 2 root root   6 Mar 10  2016 bin</span><br><span class="line">drwxr-xr-x. 2 root root   6 Mar 10  2016 etc</span><br><span class="line">drwxr-xr-x. 2 root root   6 Mar 10  2016 games</span><br><span class="line">drwxr-xr-x. 2 root root   6 Mar 10  2016 include</span><br><span class="line">drwxr-xr-x. 2 root root   6 Mar 10  2016 lib</span><br><span class="line">drwxr-xr-x. 2 root root   6 Mar 10  2016 lib64</span><br><span class="line">drwxr-xr-x. 2 root root   6 Mar 10  2016 libexec</span><br><span class="line">drwxr-xr-x. 2 root root   6 Mar 10  2016 sbin</span><br><span class="line">drwxr-xr-x. 5 root root  49 Jun 13 19:03 share</span><br><span class="line">drwxr-xr-x. 2 root root   6 Mar 10  2016 src</span><br><span class="line">lrwxrwxrwx. 1 root root  20 Sep  4 19:45 tomcat -&gt; apache-tomcat-9.0.8/</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">写一个hello world的java页面</span><br><span class="line">[root@localhost ~]# vim index.jsp</span><br><span class="line">[root@localhost ~]# cat index.jsp</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">        &lt;title&gt;test page&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">        &lt;%</span><br><span class="line">            out.println(&quot;Hellow World&quot;);</span><br><span class="line">        %&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@localhost ~]# mkdir /usr/local/tomcat/webapps/test</span><br><span class="line">[root@localhost ~]# cp index.jsp /usr/local/tomcat/webapps/test/</span><br><span class="line">[root@localhost ~]# ll /usr/local/tomcat/webapps/test/</span><br><span class="line">total 4</span><br><span class="line">-rw-r--r--. 1 root root 113 Sep  4 20:32 index.jsp</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">启动tomcat</span><br><span class="line">[root@localhost ~]# /usr/local/tomcat/bin/catalina.sh start</span><br><span class="line">Using CATALINA_BASE:   /usr/local/tomcat</span><br><span class="line">Using CATALINA_HOME:   /usr/local/tomcat</span><br><span class="line">Using CATALINA_TMPDIR: /usr/local/tomcat/temp</span><br><span class="line">Using JRE_HOME:        /usr</span><br><span class="line">Using CLASSPATH:       /usr/local/tomcat/bin/bootstrap.jar:/usr/local/tomcat/bin/tomcat-juli.jar</span><br><span class="line">Tomcat started.</span><br><span class="line"></span><br><span class="line">[root@localhost ~]# ps -ef|grep tomcat</span><br><span class="line">root      21582      1 24 20:33 pts/0    00:00:05 /usr/bin/java -Djava.util.logging.config.file=/usr/local/tomcat/conf/logging.properties -Djava.util.logging.manager=org.apache.juli.ClassLoaderLogManager -Djdk.tls.ephemeralDHKeySize=2048 -Djava.protocol.handler.pkgs=org.apache.catalina.webresources -Dorg.apache.catalina.security.SecurityListener.UMASK=0027 -Dignore.endorsed.dirs= -classpath /usr/local/tomcat/bin/bootstrap.jar:/usr/local/tomcat/bin/tomcat-juli.jar -Dcatalina.base=/usr/local/tomcat -Dcatalina.home=/usr/local/tomcat -Djava.io.tmpdir=/usr/local/tomcat/temp org.apache.catalina.startup.Bootstrap start</span><br><span class="line">root      21632  10293  0 20:34 pts/0    00:00:00 grep --color=auto tomcat</span><br><span class="line">[root@localhost ~]# ss -antl</span><br><span class="line">State       Recv-Q Send-Q                      Local Address:Port                                     Peer Address:Port</span><br><span class="line">LISTEN      0      128                                     *:22                                                  *:*</span><br><span class="line">LISTEN      0      100                             127.0.0.1:25                                                  *:*</span><br><span class="line">LISTEN      0      100                                    :::8080                                               :::*</span><br><span class="line">LISTEN      0      128                                    :::22                                                 :::*</span><br><span class="line">LISTEN      0      100                                   ::1:25                                                 :::*</span><br><span class="line">LISTEN      0      1                        ::ffff:127.0.0.1:8005                                               :::*</span><br><span class="line">LISTEN      0      100                                    :::8009                                               :::*</span><br></pre></td></tr></table></figure>

<p>在浏览器上浏览网页</p>
<p><img src="../../img/hello.png" alt="img"></p>

          
        
      
    </div>

    

    

    
    
    

    

    
      
    
    

    
	
	  <div>
        
      </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://aiwhs.github.io/2018/10/28/centos7.6下 安装Discuz论坛/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="itw">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="itw">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2018/10/28/centos7.6下 安装Discuz论坛/" class="post-title-link" itemprop="url">安装Discuz论坛</a>
              
            
          </h1>
        

        <div class="post-meta">

          
          
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-10-28 08:15:57" itemprop="dateCreated datePublished" datetime="2018-10-28T08:15:57+08:00">2018-10-28</time>
            </span>
          

          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-07-09 16:04:32" itemprop="dateModified" datetime="2019-07-09T16:04:32+08:00">2019-07-09</time>
              </span>
            
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Linux运维/" itemprop="url" rel="index"><span itemprop="name">Linux运维</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          <br>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <a id="more"></a>

<h2 id="一、Discuz介绍"><a href="#一、Discuz介绍" class="headerlink" title="一、Discuz介绍"></a>一、Discuz介绍</h2><p>作为国内最大的社区软件及服务提供商，Comsenz旗下的 Discuz! 开发组具有丰富的 web应用程序设计经验，尤其在论坛产品及相关领域</p>
<h2 id="二、Discuz实验环境"><a href="#二、Discuz实验环境" class="headerlink" title="二、Discuz实验环境"></a>二、Discuz实验环境</h2><p>centos7.6虚拟机</p>
<p>ApacheHTTP丶PHP丶MySQL</p>
<h2 id="三、Discuz安装步骤"><a href="#三、Discuz安装步骤" class="headerlink" title="三、Discuz安装步骤"></a>三、Discuz安装步骤</h2><p>1.Apache安装</p>
<p>2.PHP和MySQL安装</p>
<h2 id="四、Apache安装"><a href="#四、Apache安装" class="headerlink" title="四、Apache安装"></a>四、Apache安装</h2><h4 id="1、通过yum安装Apache组件："><a href="#1、通过yum安装Apache组件：" class="headerlink" title="1、通过yum安装Apache组件："></a>1、通过yum安装Apache组件：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum install httpd -y</span><br><span class="line">-y:同意安装</span><br></pre></td></tr></table></figure>

<h4 id="2、安装成功，启动httpd进程"><a href="#2、安装成功，启动httpd进程" class="headerlink" title="2、安装成功，启动httpd进程"></a>2、安装成功，启动httpd进程</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl start httpd.service</span><br></pre></td></tr></table></figure>

<h4 id="3、通过http-ip直接访问"><a href="#3、通过http-ip直接访问" class="headerlink" title="3、通过http://ip直接访问"></a>3、通过<a href="http://ip直接访问" target="_blank" rel="noopener">http://ip直接访问</a></h4><h4 id="4、把Httpd设置为开机启动"><a href="#4、把Httpd设置为开机启动" class="headerlink" title="4、把Httpd设置为开机启动"></a>4、把Httpd设置为开机启动</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable httpd.service</span><br></pre></td></tr></table></figure>

<h2 id="五、PHP和MySQL安装"><a href="#五、PHP和MySQL安装" class="headerlink" title="五、PHP和MySQL安装"></a>五、PHP和MySQL安装</h2><h4 id="1、使用yum安装-PHP"><a href="#1、使用yum安装-PHP" class="headerlink" title="1、使用yum安装 PHP"></a>1、使用yum安装 PHP</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install php php-fpm php-mysql mariadb-server mariadb-client -y</span><br></pre></td></tr></table></figure>

<h4 id="2、安装之后，启动-PHP-FPM-进程"><a href="#2、安装之后，启动-PHP-FPM-进程" class="headerlink" title="2、安装之后，启动 PHP-FPM 进程"></a>2、安装之后，启动 PHP-FPM 进程</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl start php-fpm.service</span><br></pre></td></tr></table></figure>

<h4 id="3、PHP-FPM，默认端口9000，通过netstat查看是否启动成功"><a href="#3、PHP-FPM，默认端口9000，通过netstat查看是否启动成功" class="headerlink" title="3、PHP-FPM，默认端口9000，通过netstat查看是否启动成功"></a>3、PHP-FPM，默认端口9000，通过netstat查看是否启动成功</h4><h4 id="4、PHP-FPM也设置成开机自动启动"><a href="#4、PHP-FPM也设置成开机自动启动" class="headerlink" title="4、PHP-FPM也设置成开机自动启动"></a>4、PHP-FPM也设置成开机自动启动</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable php-fpm.service</span><br></pre></td></tr></table></figure>

<h4 id="5、启动数据库服务"><a href="#5、启动数据库服务" class="headerlink" title="5、启动数据库服务"></a>5、启动数据库服务</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl start mariadb.service</span><br></pre></td></tr></table></figure>

<h4 id="6、查看是否启用成功-默认端口3306"><a href="#6、查看是否启用成功-默认端口3306" class="headerlink" title="6、查看是否启用成功,默认端口3306"></a>6、查看是否启用成功,默认端口3306</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netstat -antupl|grep 3306      ##有的话,说明启动成功</span><br></pre></td></tr></table></figure>

<h4 id="7、修改数据库密码"><a href="#7、修改数据库密码" class="headerlink" title="7、修改数据库密码"></a>7、修改数据库密码</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqladmin -u root password root</span><br></pre></td></tr></table></figure>

<h4 id="8、创建论坛数据库，并创建数据库管理账户和密码："><a href="#8、创建论坛数据库，并创建数据库管理账户和密码：" class="headerlink" title="8、创建论坛数据库，并创建数据库管理账户和密码："></a>8、创建论坛数据库，并创建数据库管理账户和密码：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -u root  -p</span><br></pre></td></tr></table></figure>

<p>显示为:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@wenhs ~]# mysql -u root  -p</span><br><span class="line">Enter password: </span><br><span class="line">Welcome to the MariaDB monitor.  Commands end with ; or \g.</span><br><span class="line">Your MariaDB connection id is 3</span><br><span class="line">Server version: 5.5.60-MariaDB MariaDB Server</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.</span><br><span class="line"></span><br><span class="line">Type &apos;help;&apos; or &apos;\h&apos; for help. Type &apos;\c&apos; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">MariaDB [(none)]&gt; create database bbs;</span><br><span class="line"></span><br><span class="line">MariaDB [(none)]&gt; grant all on bbs.* to &apos;bbs_admin&apos;@&apos;localhost&apos; identified by &apos;root&apos;;</span><br><span class="line"></span><br><span class="line">MariaDB [(none)]&gt;exit;</span><br></pre></td></tr></table></figure>

<h2 id="六、Discuz安装"><a href="#六、Discuz安装" class="headerlink" title="六、Discuz安装"></a>六、Discuz安装</h2><h4 id="1、通过wget-下载Discuz安装包"><a href="#1、通过wget-下载Discuz安装包" class="headerlink" title="1、通过wget,下载Discuz安装包"></a>1、通过wget,下载Discuz安装包</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget http://download.comsenz.com/DiscuzX/3.3/Discuz_X3.3_SC_UTF8.zip</span><br></pre></td></tr></table></figure>

<h4 id="2、通过unzip解压压缩包"><a href="#2、通过unzip解压压缩包" class="headerlink" title="2、通过unzip解压压缩包"></a>2、通过unzip解压压缩包</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">unzip Discuz_X3.3_SC_UTF8.zip</span><br><span class="line">解压完后，会看到一个upload文件夹</span><br></pre></td></tr></table></figure>

<h4 id="3、配置Discuz"><a href="#3、配置Discuz" class="headerlink" title="3、配置Discuz"></a>3、配置Discuz</h4><h5 id="a、由于PHP默认访问-var-www-html-文件夹，所以我们需要把upload文件夹里的文件都复制到-var-www-html-文件夹"><a href="#a、由于PHP默认访问-var-www-html-文件夹，所以我们需要把upload文件夹里的文件都复制到-var-www-html-文件夹" class="headerlink" title="a、由于PHP默认访问 /var/www/html/ 文件夹，所以我们需要把upload文件夹里的文件都复制到 /var/www/html/ 文件夹"></a>a、由于PHP默认访问 /var/www/html/ 文件夹，所以我们需要把upload文件夹里的文件都复制到 /var/www/html/ 文件夹</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp -r upload/* /var/www/html/</span><br></pre></td></tr></table></figure>

<h5 id="b、通过chmod设置-var-www-html目录及其子目录赋予权限"><a href="#b、通过chmod设置-var-www-html目录及其子目录赋予权限" class="headerlink" title="b、通过chmod设置/var/www/html目录及其子目录赋予权限"></a>b、通过chmod设置/var/www/html目录及其子目录赋予权限</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod -R 777 /var/www/html</span><br></pre></td></tr></table></figure>

<h5 id="c、Apache重启"><a href="#c、Apache重启" class="headerlink" title="c、Apache重启"></a>c、Apache重启</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart httpd.service</span><br></pre></td></tr></table></figure>

<h4 id="4、Discuz安装向导-访问路径："><a href="#4、Discuz安装向导-访问路径：" class="headerlink" title="4、Discuz安装向导,访问路径："></a>4、Discuz安装向导,访问路径：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://ip/install</span><br></pre></td></tr></table></figure>

<p>剩下的就在网站操作了,其中数据库密码要和之前系统数据库密码一样,不然无法安装</p>

          
        
      
    </div>

    

    

    
    
    

    

    
      
    
    

    
	
	  <div>
        
      </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://aiwhs.github.io/2018/10/27/shell示例/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="itw">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="itw">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2018/10/27/shell示例/" class="post-title-link" itemprop="url">shell脚本示例</a>
              
            
          </h1>
        

        <div class="post-meta">

          
          
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-10-27 08:15:57" itemprop="dateCreated datePublished" datetime="2018-10-27T08:15:57+08:00">2018-10-27</time>
            </span>
          

          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-07-10 15:01:59" itemprop="dateModified" datetime="2019-07-10T15:01:59+08:00">2019-07-10</time>
              </span>
            
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Linux运维/" itemprop="url" rel="index"><span itemprop="name">Linux运维</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          <br>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <a id="more"></a>

<p>使用for循环在/wenhs目录下通过随机10个字符加固定字符串wenhs批量创建10个html文件，结果类似qnvuxvicni_wenhs.html</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">dir=/wenhs/</span><br><span class="line">for ((i=1;i&lt;=10;i++));do</span><br><span class="line">	filename=$(tr -dc A-Za-z0-9_ &lt; /dev/urandom | head -c 10 |xargs)_wenhs.html</span><br><span class="line">	if [ -d $dir ];then</span><br><span class="line">		cd $dir &amp;&amp; touch $filename</span><br><span class="line">	else</span><br><span class="line">	mkdir $dir &amp;&amp; cd $dir &amp;&amp; touch $filename</span><br><span class="line">	fi</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line">效果:</span><br><span class="line">[root@wenhs5479 ~]# ls /wenhs/</span><br><span class="line">7Ocr2n4FNh_wenhs.html  eWOxCCySgE_wenhs.html  wzmqqJ8vS8_wenhs.html</span><br><span class="line">BFRXrBMn6N_wenhs.html  NEAof8Y8dN_wenhs.html  xLEbyL6ZDs_wenhs.html</span><br><span class="line">E2VgHE1rwc_wenhs.html  Ulq9EZSxLX_wenhs.html</span><br><span class="line">EcFzJip34y_wenhs.html  UMbdC4pusC_wenhs.html</span><br></pre></td></tr></table></figure>

<p>将以上文件名中的wenhs全部改成weixinghao(用for循环实现),并且html改成大写</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">dir=/wenhs</span><br><span class="line">file=$(ls $dir)</span><br><span class="line">for i in $file;do</span><br><span class="line">	j=$(echo $i|cut -c 1-10)</span><br><span class="line">	mv $dir/$j* $dir/$&#123;j&#125;_weixinghao.HTML</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line">效果:</span><br><span class="line">[root@wenhs5479 ~]# ls /wenhs/</span><br><span class="line">7Ocr2n4FNh_weixinghao.HTML  eWOxCCySgE_weixinghao.HTML  wzmqqJ8vS8_weixinghao.HTML</span><br><span class="line">BFRXrBMn6N_weixinghao.HTML  NEAof8Y8dN_weixinghao.HTML  xLEbyL6ZDs_weixinghao.HTML</span><br><span class="line">E2VgHE1rwc_weixinghao.HTML  Ulq9EZSxLX_weixinghao.HTML</span><br><span class="line">EcFzJip34y_weixinghao.HTML  UMbdC4pusC_weixinghao.HTML</span><br></pre></td></tr></table></figure>

<p>批量创建10个系统帐号wenhs01-wenhs10并设置密码（密码为随机8位字符串）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">for i in $(seq -w 10);do</span><br><span class="line">useradd -r wenhs$i</span><br><span class="line">echo &quot;password$i&quot; | md5sum |cut -c-8 | tee -a passwd.txt | passwd --stdin wenhs$i &amp;&gt;/dev/null</span><br><span class="line">done</span><br></pre></td></tr></table></figure>

<p>写一个脚本，实现判断实验主机当前网段中当前在线的IP有哪些</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">subnet=192.168.42.0/24</span><br><span class="line">netaddr=`echo $subnet|cut -d. -f1-3`</span><br><span class="line">for i in &#123;1..254&#125;;do</span><br><span class="line">&#123;</span><br><span class="line">ping -c 1 -t 1 $netaddr.$i &gt; /dev/null</span><br><span class="line">if [ $? == 0 ];then</span><br><span class="line"> echo $netaddr.$i</span><br><span class="line">fi</span><br><span class="line">&#125; &amp;</span><br><span class="line">done</span><br><span class="line">wait</span><br><span class="line"></span><br><span class="line">效果:</span><br><span class="line">[root@wenhs5479 ~]# bash nmap</span><br><span class="line">192.168.42.129</span><br><span class="line">192.168.42.87</span><br><span class="line">192.168.42.81</span><br></pre></td></tr></table></figure>

<p>打印My WeChat is wenhs5479, welcome to discuss together.中字母长度不大于6的单词</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">len=6</span><br><span class="line">words=&apos;My WeChat is wenhs5479, welcome to discuss together.&apos;</span><br><span class="line">for word in $&#123;words[@]&#125;;do</span><br><span class="line">l=$(echo $word|wc -c)</span><br><span class="line">if [ $l -gt $len ];then echo $word;fi</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line">效果:</span><br><span class="line">[root@wenhs5479 ~]# bash print.sh</span><br><span class="line">WeChat</span><br><span class="line">wenhs5479,</span><br><span class="line">welcome</span><br><span class="line">discuss</span><br><span class="line">together.</span><br></pre></td></tr></table></figure>

<p>实现以脚本传参的方式比较2个整数大小，以屏幕输出的方式提醒用户比较结果</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">max=$1</span><br><span class="line">min=$2</span><br><span class="line">[ $# -lt 2 ] &amp;&amp; echo &quot;请至少输入2个数字: &quot; &amp;&amp; exit</span><br><span class="line">for i in $*;do</span><br><span class="line">	echo &quot;$i&quot; |egrep &apos;^[0-9]+$&apos; &amp;&gt; /dev/null</span><br><span class="line">	[ $? -ne 0 ] &amp;&amp; echo &quot;请输入2个整数,不是字母或特殊字符&quot; &amp;&amp; exit</span><br><span class="line">	[ $max -le $i ] &amp;&amp; max=$i</span><br><span class="line">	[ $min -ge $i ] &amp;&amp; min=$i</span><br><span class="line">done</span><br><span class="line">echo &quot;$max &gt; $min&quot;</span><br><span class="line"></span><br><span class="line">效果:</span><br><span class="line">[root@wenhs5479 ~]# bash wenhs.sh 13123 53453</span><br><span class="line">53453 &gt; 13123</span><br></pre></td></tr></table></figure>

<p>实现以read读入的方式比较2个整数大小，以屏幕输出的方式提醒用户比较结果</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">flag=true</span><br><span class="line">while $flag;do</span><br><span class="line">    read -p &quot;请输入一个数字：&quot; A</span><br><span class="line">    echo $A |egrep &apos;^[0-9]+$&apos; &amp;&gt;/dev/null</span><br><span class="line">    if [ $? -ne 0 ];then</span><br><span class="line">        echo &quot;请输入一个整数&quot;</span><br><span class="line">        continue</span><br><span class="line">	else</span><br><span class="line">		while $flag;do</span><br><span class="line">			read -p &quot;请输入一个数字：&quot; B</span><br><span class="line">			echo $B |egrep &apos;^[0-9]+$&apos; &amp;&gt;/dev/null</span><br><span class="line">			if [ $? -ne 0 ];then</span><br><span class="line">				echo &quot;请输入一个整数&quot;</span><br><span class="line">				continue</span><br><span class="line">			else</span><br><span class="line">				flag=false</span><br><span class="line">			fi</span><br><span class="line">		done</span><br><span class="line">	fi</span><br><span class="line">done</span><br><span class="line">if [ $A -gt $B ];then</span><br><span class="line">	echo &quot;$A &gt; $B&quot;</span><br><span class="line">elif [ $A -eq $B ];then</span><br><span class="line">	echo &quot;$A = $B&quot;</span><br><span class="line">else</span><br><span class="line">	echo &quot;$A &lt; $B&quot;</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">效果:</span><br><span class="line">[root@wenhs5479 ~]# bash wenhs.sh</span><br><span class="line">请输入一个数字：a</span><br><span class="line">请输入一个整数</span><br><span class="line">请输入一个数字：b</span><br><span class="line">请输入一个整数</span><br><span class="line">请输入一个数字：123</span><br><span class="line">请输入一个数字：321</span><br><span class="line">123 &lt; 321</span><br><span class="line">[root@wenhs5479 ~]# bash wenhs.sh</span><br><span class="line">请输入一个数字：123  </span><br><span class="line">请输入一个数字：123</span><br><span class="line">123 = 123</span><br><span class="line">[root@wenhs5479 ~]# bash wenhs.sh</span><br><span class="line">请输入一个数字：321</span><br><span class="line">请输入一个数字：123</span><br><span class="line">321 &gt; 123</span><br><span class="line">[root@wenhs5479 ~]#</span><br></pre></td></tr></table></figure>
          
        
      
    </div>

    

    

    
    
    

    

    
      
    
    

    
	
	  <div>
        
      </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://aiwhs.github.io/2018/10/21/shell脚本进阶/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="itw">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="itw">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2018/10/21/shell脚本进阶/" class="post-title-link" itemprop="url">shell脚本进阶</a>
              
            
          </h1>
        

        <div class="post-meta">

          
          
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-10-21 08:15:57" itemprop="dateCreated datePublished" datetime="2018-10-21T08:15:57+08:00">2018-10-21</time>
            </span>
          

          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-07-09 15:56:56" itemprop="dateModified" datetime="2019-07-09T15:56:56+08:00">2019-07-09</time>
              </span>
            
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Linux运维/" itemprop="url" rel="index"><span itemprop="name">Linux运维</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          <br>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <a id="more"></a>

<h1 id="1-bash条件判断"><a href="#1-bash条件判断" class="headerlink" title="1. bash条件判断"></a>1. bash条件判断</h1><h2 id="1-1-条件测试类型"><a href="#1-1-条件测试类型" class="headerlink" title="1.1 条件测试类型"></a>1.1 条件测试类型</h2><ul>
<li>整数测试</li>
<li>字符测试</li>
<li>文件测试 </li>
</ul>
<h2 id="1-2-条件测试的表达式"><a href="#1-2-条件测试的表达式" class="headerlink" title="1.2 条件测试的表达式"></a>1.2 条件测试的表达式</h2><blockquote>
<p>[ expression ] </p>
<p>[[ expression ]] </p>
<p>test expression</p>
</blockquote>
<h2 id="1-3-整数测试（双目）"><a href="#1-3-整数测试（双目）" class="headerlink" title="1.3 整数测试（双目）"></a>1.3 整数测试（双目）</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">-eq      测试两个整数是否相等</span><br><span class="line">-ne      测试两个整数是否不等</span><br><span class="line">-gt      测试一个数是否大于另一个数</span><br><span class="line">-lt      测试一个数是否小于另一个数</span><br><span class="line">-ge      大于或等于</span><br><span class="line">-le      小于或等于</span><br></pre></td></tr></table></figure>

<h2 id="1-4-字符测试"><a href="#1-4-字符测试" class="headerlink" title="1.4 字符测试"></a>1.4 字符测试</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">==       等值比较，检查==两边的内容是否一致，==两边都要有空格</span><br><span class="line">!=       检查两边内容是否不一致，不一致为真，一致为假</span><br><span class="line">=~       左侧字符串是否能够被右侧的PATTERN所匹配到。此表达式应用于双中括号[[]]中</span><br><span class="line">-z &quot;string&quot;      测试指定字符串是否为空，空则为真，不空则为假</span><br><span class="line">-n &quot;string&quot;      测试指定字符串是否不空，不空则为真，空则为假</span><br></pre></td></tr></table></figure>

<h2 id="1-5-文件测试"><a href="#1-5-文件测试" class="headerlink" title="1.5 文件测试"></a>1.5 文件测试</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">存在性测试：</span><br><span class="line">    -e       测试文件是否存在</span><br><span class="line"> 存在性及类别测试：</span><br><span class="line">    -b       测试文件是否为块设备文件</span><br><span class="line">    -c       测试文件是否为字符设备文件</span><br><span class="line">    -f       测试文件是否为普通文件</span><br><span class="line">    -d       测试指定路径是否为目录</span><br><span class="line">    -h       测试文件是否为符号链接文件</span><br><span class="line">    -L       测试文件是否为符号链接文件</span><br><span class="line">    -p       测试文件是否为命名管道文件</span><br><span class="line">    -S       测试文件是否为套接字文件</span><br><span class="line"> 文件权限测试：</span><br><span class="line">    -r       测试当前用户对指定文件是否有读权限</span><br><span class="line">    -w       测试当前用户对指定文件是否有写权限</span><br><span class="line">    -x       测试当前用户对指定文件是否有执行权限</span><br><span class="line"> 文件特殊权限测试：</span><br><span class="line">    -g       测试文件是否有sgid权限</span><br><span class="line">    -u       测试文件是否有suid权限</span><br><span class="line">    -k       测试文件是否有sticky权限</span><br><span class="line"> 文件大小测试：</span><br><span class="line">    -s       测试文件是否非空</span><br><span class="line"> 文件是否打开测试：</span><br><span class="line">    -t fd    fd表示的文件描述符是否已经打开且与某终端相关</span><br><span class="line"> 双目测试：</span><br><span class="line">    file1 -ef file2      测试file1与file2是否指向同一个设备上的相同inode，说白点就是两者是不是同一个文件</span><br><span class="line">    file1 -nt file2      测试file1是否比file2新</span><br><span class="line">    file1 -ot file2      测试file1是否比file2旧</span><br><span class="line"> 无分类：</span><br><span class="line">    -N       测试文件自从上一次被读取之后是否被修改过</span><br><span class="line">    -O       测试文件是否存在并且被当前用户拥有</span><br><span class="line">    -G       测试文件是否存在并且默认组是否为当前用户组</span><br></pre></td></tr></table></figure>

<h2 id="1-6-组合测试条件"><a href="#1-6-组合测试条件" class="headerlink" title="1.6 组合测试条件"></a>1.6 组合测试条件</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">-a       与关系</span><br><span class="line">-o       或关系</span><br><span class="line">!        非关系</span><br><span class="line"></span><br><span class="line">[ $# -gt 1 -a $# -le 3 ]</span><br><span class="line">[ $# -gt 1 ] &amp;&amp; [ $# -le 3 ]</span><br></pre></td></tr></table></figure>

<h2 id="1-7-条件判断，控制结构"><a href="#1-7-条件判断，控制结构" class="headerlink" title="1.7 条件判断，控制结构"></a>1.7 条件判断，控制结构</h2><h4 id="1-7-1-单分支if语句"><a href="#1-7-1-单分支if语句" class="headerlink" title="1.7.1 单分支if语句"></a>1.7.1 单分支if语句</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">if 判断条件; then</span><br><span class="line">    statement1</span><br><span class="line">    statement2</span><br><span class="line">    ......</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>

<h4 id="1-7-2-双分支if语句"><a href="#1-7-2-双分支if语句" class="headerlink" title="1.7.2 双分支if语句"></a>1.7.2 双分支if语句</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">if 判断条件; then</span><br><span class="line">    statement1</span><br><span class="line">    statement2</span><br><span class="line">    ......</span><br><span class="line">else</span><br><span class="line">    statement3</span><br><span class="line">    statement4</span><br><span class="line">    ......</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>

<h4 id="1-7-3-多分支if语句"><a href="#1-7-3-多分支if语句" class="headerlink" title="1.7.3 多分支if语句"></a>1.7.3 多分支if语句</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">if 判断条件1; then</span><br><span class="line">    statement1</span><br><span class="line">    statement2</span><br><span class="line">    ......</span><br><span class="line">elif 判断条件2; then</span><br><span class="line">    statement3</span><br><span class="line">    statement4</span><br><span class="line">    ......</span><br><span class="line">else</span><br><span class="line">    statement5</span><br><span class="line">    statement6</span><br><span class="line">    ......</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>

<h1 id="2-分支选择"><a href="#2-分支选择" class="headerlink" title="2. 分支选择"></a>2. 分支选择</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">case $变量名 in            </span><br><span class="line">value1)                </span><br><span class="line">    statement                </span><br><span class="line">    ...                </span><br><span class="line">    ;;            </span><br><span class="line">value2)                </span><br><span class="line">    statement                </span><br><span class="line">    ...                </span><br><span class="line">    ;;            </span><br><span class="line">*)                </span><br><span class="line">    statement                </span><br><span class="line">    ...                </span><br><span class="line">    ;;        </span><br><span class="line">esac</span><br><span class="line"></span><br><span class="line">case支持glob风格的通配符：</span><br><span class="line">    *            任意长度任意字符</span><br><span class="line">    ?            任意单个字符</span><br><span class="line">    []           指字范围内的任意单个字符</span><br><span class="line">    abc|bcd      abc或bcd</span><br></pre></td></tr></table></figure>

<h1 id="3-循环语句"><a href="#3-循环语句" class="headerlink" title="3. 循环语句"></a>3. 循环语句</h1><p><strong>循环语句通常需要有一个进入条件和一个退出条件。</strong></p>
<h2 id="3-1-for循环"><a href="#3-1-for循环" class="headerlink" title="3.1 for循环"></a>3.1 for循环</h2><p><strong>for循环当列表不为空时进入循环，否则退出循环</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">for 变量 in 列表; do</span><br><span class="line">    循环体</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line">for ((expr1;expr2;expr3))</span><br><span class="line">&#123;</span><br><span class="line">    循环体</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">for (( expr1 ; expr2 ; expr3 ));do</span><br><span class="line">    循环体</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line">expr1    用于指定初始条件，给控制变量一个初始值</span><br><span class="line">expr2    判定什么时候退出循环</span><br><span class="line">expr3    修正expr1指定的变量的值</span><br><span class="line"></span><br><span class="line">如何生成列表：</span><br><span class="line">    &#123;1..100&#125;</span><br><span class="line">    seq [起始数] [步进长度] 结束数</span><br></pre></td></tr></table></figure>

<h2 id="3-2-while循环"><a href="#3-2-while循环" class="headerlink" title="3.2 while循环"></a>3.2 while循环</h2><p><strong>while循环适用于循环次数未知的场景，注意要有退出条件。<br>条件满足时进入循环，条件不满足了退出循环。</strong></p>
<h4 id="3-2-1-while循环正常用法"><a href="#3-2-1-while循环正常用法" class="headerlink" title="3.2.1 while循环正常用法"></a>3.2.1 while循环正常用法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">while 条件; do</span><br><span class="line">    statement</span><br><span class="line">    ...</span><br><span class="line">done</span><br></pre></td></tr></table></figure>

<h4 id="3-2-2-while循环特殊用法"><a href="#3-2-2-while循环特殊用法" class="headerlink" title="3.2.2 while循环特殊用法"></a>3.2.2 while循环特殊用法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">while循环特殊用法一：死循环</span><br><span class="line">while :;do</span><br><span class="line">    statement</span><br><span class="line">    ...</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line">这里的冒号可以改成true或者永远成立的条件,不能为false</span><br><span class="line">所以,可以定义一个flag=false,让它终止循环</span><br><span class="line"></span><br><span class="line">while循环特殊用法二：逐行读取某文件，将值存入line变量中</span><br><span class="line">while read line;do</span><br><span class="line">    statement</span><br><span class="line">    ...</span><br><span class="line">done &lt; /path/to/somefile</span><br></pre></td></tr></table></figure>

<h2 id="3-3-until循环"><a href="#3-3-until循环" class="headerlink" title="3.3 until循环"></a>3.3 until循环</h2><p><strong>条件不满足时进入循环，条件满足了退出循环。</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">until 条件; do</span><br><span class="line">    statement</span><br><span class="line">    ...</span><br><span class="line">done</span><br></pre></td></tr></table></figure>

<h2 id="3-4-循环语句特殊情况"><a href="#3-4-循环语句特殊情况" class="headerlink" title="3.4 循环语句特殊情况"></a>3.4 循环语句特殊情况</h2><blockquote>
<p>在循环语句中，有几种特别情况：</p>
<p>break [num]：提前退出循环。当循环语句中出现break时，将提前退出循环，不再执行循环后面的语句</p>
<p>continue [num]：提前结束本轮循环而进入下一轮循环。当循环语句执行到continue时，continue后面的语句将不再执行，提前进入下一轮循环</p>
</blockquote>
<h1 id="4-定义脚本退出状态码"><a href="#4-定义脚本退出状态码" class="headerlink" title="4. 定义脚本退出状态码"></a>4. 定义脚本退出状态码</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">exit命令用于定义执行状态结果</span><br><span class="line"></span><br><span class="line">exit #       此处的#号是一个数字，其范围可以是0-255</span><br><span class="line"></span><br><span class="line">如果脚本没有明确定义退出状态码，那么，最后执行的一条命令的退出码即为脚本的退出状态码</span><br><span class="line"></span><br><span class="line">注意：脚本中一旦遇到exit命令，脚本会立即终止</span><br></pre></td></tr></table></figure>

<p><strong>示例:</strong></p>
<p>1.猜100以内数字</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">#!bin/bash</span><br><span class="line">num=$[RANDOM%100]</span><br><span class="line">read -p &quot;Please enter a number: &quot; user_num</span><br><span class="line">until [ $user_num -eq $num ];do</span><br><span class="line">        while [ $user_num -gt $num ];do</span><br><span class="line">                echo &quot;a bit big&quot;</span><br><span class="line">                read -p &quot;Please enter a number: &quot; user_num</span><br><span class="line">        done</span><br><span class="line">        while [ $user_num -lt $num ];do</span><br><span class="line">                echo &quot;a little bit small&quot;</span><br><span class="line">                read -p &quot;Please enter a number: &quot; user_num</span><br><span class="line">        done</span><br><span class="line">done</span><br><span class="line">        echo &quot;Congratulations, you got it&quot;</span><br></pre></td></tr></table></figure>

<p>2.让用户输入自己的年龄，计算他还能活多少年，假定每个人能活100岁。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#!bin/bash</span><br><span class="line">AGEMIX=100</span><br><span class="line">read -p &quot;Please enter your age: &quot; AGE</span><br><span class="line">if [ $AGE -le $AGEMIX ];then</span><br><span class="line">	echo &quot;You can still live for $[$AGEMIX-$AGE] years.&quot;</span><br><span class="line">else</span><br><span class="line">	echo &quot;Old monster, you should die $[$AGE-$AGEMIX] years ago&quot;</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>

<p>3.脚本后接入n个数字，输出最大值和最小值。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">max=$1</span><br><span class="line">min=$2</span><br><span class="line">[ $# -lt 2 ] &amp;&amp; echo &quot;请至少输入2个数字: &quot; &amp;&amp; exit</span><br><span class="line">for i in $*;do</span><br><span class="line">	echo &quot;$i&quot; |egrep &apos;^[0-9]+$&apos; &amp;&gt; /dev/null</span><br><span class="line">	[ $? -ne 0 ] &amp;&amp; echo &quot;请输入数字,不是字母或特殊字符&quot; &amp;&amp; exit</span><br><span class="line">	[ $max -le $i ] &amp;&amp; max=$i</span><br><span class="line">	[ $min -ge $i ] &amp;&amp; min=$i</span><br><span class="line">done</span><br><span class="line">echo &quot;The max number is &quot;$max</span><br><span class="line">echo &quot;The min number is &quot;$min</span><br></pre></td></tr></table></figure>

<p>4,写一个登录接口,输入用户名和密码,认证成功后显示欢迎信息,输错3次后警告</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">username=wenhs</span><br><span class="line">passwd=jbgsn</span><br><span class="line">for ((i=1;i&gt;=1;i++));do</span><br><span class="line">read -p &quot;please enter your name: &quot; user</span><br><span class="line">read -p &quot;please entsr your passwd: &quot; pass</span><br><span class="line">[ $i -gt 3 ]&amp;&amp; echo &quot;Enter your account or password too many failures, account has been locked, please contact the administrator to unlock&quot; &amp;&amp; exit</span><br><span class="line">if [ $user != $username ] ||[ $pass != $passwd ];then</span><br><span class="line">	echo &quot;You entered an account or password incorrectly. Please re-enter it.&quot;</span><br><span class="line">	continue</span><br><span class="line">else</span><br><span class="line">	echo &quot;Hellow $user , Welcome to home.&quot;</span><br><span class="line">	break</span><br><span class="line">fi</span><br><span class="line">done</span><br></pre></td></tr></table></figure>
          
        
      
    </div>

    

    

    
    
    

    

    
      
    
    

    
	
	  <div>
        
      </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/2/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><span class="space">&hellip;</span><a class="page-number" href="/page/6/">6</a><a class="extend next" rel="next" href="/page/4/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <div class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">

          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  
  <p class="site-author-name" itemprop="name">itw</p>
  <div class="site-description motion-element" itemprop="description"></div>
</div>


  <nav class="site-state motion-element">
    
      <div class="site-state-item site-state-posts">
        
          <a href="/archives/">
        
          <span class="site-state-item-count">51</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
    

    
      
      
      <div class="site-state-item site-state-categories">
        
        
        
          
        
        <span class="site-state-item-count">1</span>
        <span class="site-state-item-name">分类</span>
        
      </div>
    

    
      
      
      <div class="site-state-item site-state-tags">
        
        
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
        <span class="site-state-item-count">28</span>
        <span class="site-state-item-name">标签</span>
        
      </div>
    
  </nav>



  <div class="feed-link motion-element">
    <a href="/atom.xml" rel="alternate">
      <i class="fa fa-rss"></i>RSS
    </a>
  </div>











          
          
        </div>
      </div>

      

      

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">itw</span>

  

  
</div>


<div class="powered-by">
<i class="fa fa-user-md"></i><span id="busuanzi_container_site_uv">
  本站访客数:<span id="busuanzi_value_site_uv"></span>
</span>
</div>
<!-- <div class="powered-by">由 <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v3.9.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> v7.2.0</div>
-->



<div class="theme-info">
  <div class="powered-by"></div>
  <span class="post-count">博客全站共183.1k字</span>
</div>

        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>










  
  













  
  <script src="/lib/jquery/index.js?v=3.4.1"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>




  <script src="/js/utils.js?v=7.2.0"></script>

  <script src="/js/motion.js?v=7.2.0"></script>



  
  


  <script src="/js/schemes/muse.js?v=7.2.0"></script>



  

  <script src="/js/next-boot.js?v=7.2.0"></script>

  

  

  

  

  



  




  

  

  

  

  

  

  

  

  

  

  

  

  


  

   <canvas class="fireworks" style="position: fixed;left: 0;top: 0;z-index: 1; pointer-events: none;"></canvas> 
   <script type="text/javascript" src="//cdn.bootcss.com/animejs/2.2.0/anime.min.js"></script> 
   <script type="text/javascript" src="/js/fireworks.js"></script>

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>
</html>

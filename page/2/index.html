<!DOCTYPE html>












  


<html class="theme-next muse use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>
<link href="//cdn.bootcss.com/pace/1.0.2/themes/pink/pace-theme-flash.css" rel="stylesheet">
<style>
    .pace .pace-progress {
        background: #1E92FB; /*进度条颜色*/
        height: 3px;
    }
    .pace .pace-progress-inner {
         box-shadow: 0 0 10px #1E92FB, 0 0 5px     #1E92FB; /*阴影颜色*/
    }
    .pace .pace-activity {
        border-top-color: #1E92FB;    /*上边框颜色*/
        border-left-color: #1E92FB;    /*左边框颜色*/
    }
</style>
<meta name="theme-color" content="#222">




  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link rel="stylesheet" href="/lib/pace/pace-theme-pace-theme-minimal.min.css?v=1.0.2">



















<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.7.0">

<link rel="stylesheet" href="/css/main.css?v=7.2.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.2.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.2.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.2.0">


  <link rel="mask-icon" href="/images/logo.svg?v=7.2.0" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '7.2.0',
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":false},
    copycode: {"enable":false,"show_result":false,"style":null},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    translation: {
      copy_button: '复制',
      copy_success: '复制成功',
      copy_failure: '复制失败'
    }
  };
</script>

  <meta property="og:type" content="website">
<meta property="og:title" content="itw">
<meta property="og:url" content="http://aiwhs.github.io/page/2/index.html">
<meta property="og:site_name" content="itw">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="itw">



  <link rel="alternate" href="/atom.xml" title="itw" type="application/atom+xml">



  
  
  <link rel="canonical" href="http://aiwhs.github.io/page/2/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  
  <title>itw</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>
    <a href="https://github.com/aiwhs" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewbox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; left: 0; transform: scale(-1, 1);" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"/><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"/><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"/></svg><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style></a>
	
    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">itw</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>

  </li>

      
      
    </ul>
  

  
    

  

  
</nav>



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://aiwhs.github.io/2018/12/23/cobbler/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="itw">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="itw">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2018/12/23/cobbler/" class="post-title-link" itemprop="url">cobbler</a>
              
            
          </h1>
        

        <div class="post-meta">

          
          
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-12-23 08:15:57" itemprop="dateCreated datePublished" datetime="2018-12-23T08:15:57+08:00">2018-12-23</time>
            </span>
          

          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-07-17 19:29:39" itemprop="dateModified" datetime="2019-07-17T19:29:39+08:00">2019-07-17</time>
              </span>
            
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Linux运维/" itemprop="url" rel="index"><span itemprop="name">Linux运维</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          <br>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <a id="more"></a>



<h2 id="1-cobbler简介"><a href="#1-cobbler简介" class="headerlink" title="1. cobbler简介"></a>1. cobbler简介</h2><p><code>Cobbler</code>是一个Linux服务器安装的服务，可以通过网络启动(PXE)的方式来快速安装、重装物理服务器和虚拟机，同时还可以管理<code>DHCP</code>，<code>DNS</code>等。</p>
<p><code>Cobbler</code>可以使用命令行方式管理，也提供了基于Web的界面管理工具(cobbler-web)，还提供了API接口，可以方便二次开发使用。</p>
<p><code>Cobbler</code>是较早前的kickstart的升级版，优点是比较容易配置，还自带web界面比较易于管理。</p>
<p><code>Cobbler</code>内置了一个轻量级配置管理系统，但它也支持和其它配置管理系统集成，如Puppet，暂时不支持SaltStack。</p>
<p><code>Cobbler</code><a href="http://cobbler.github.io/" target="_blank" rel="noopener">官网</a></p>
<p><strong>cobbler集成的服务</strong></p>
<ul>
<li>PXE服务支持</li>
<li>DHCP服务管理</li>
<li>DNS服务管理(可选bind,dnsmasq)</li>
<li>电源管理</li>
<li>Kickstart服务支持</li>
<li>YUM仓库管理</li>
<li>TFTP(PXE启动时需要)</li>
<li>Apache(提供kickstart的安装源，并提供定制化的kickstart配置)</li>
</ul>
<p><strong>cobbler配置文件详解</strong><br><code>cobbler</code>配置文件目录在<code>/etc/cobbler</code></p>
<table>
<thead>
<tr>
<th align="left">配置文件</th>
<th align="left">作用</th>
</tr>
</thead>
<tbody><tr>
<td align="left">/etc/cobbler/settings</td>
<td align="left">cobbler 主配置文件</td>
</tr>
<tr>
<td align="left">/etc/cobbler/iso/</td>
<td align="left">iso模板配置文件</td>
</tr>
<tr>
<td align="left">/etc/cobbler/pxe</td>
<td align="left">pxe模板配置文件</td>
</tr>
<tr>
<td align="left">/etc/cobbler/power</td>
<td align="left">电源配置文件</td>
</tr>
<tr>
<td align="left">/etc/cobbler/user.conf</td>
<td align="left">web服务授权配置文件</td>
</tr>
<tr>
<td align="left">/etc/cobbler/users.digest</td>
<td align="left">web访问的用户名密码配置文件</td>
</tr>
<tr>
<td align="left">/etc/cobbler/dhcp.template</td>
<td align="left">dhcp服务器的的配置模板</td>
</tr>
<tr>
<td align="left">/etc/cobbler/dnsmasq.template</td>
<td align="left">dns服务器的配置模板</td>
</tr>
<tr>
<td align="left">/etc/cobbler/tftpd.template</td>
<td align="left">tftp服务的配置模板</td>
</tr>
<tr>
<td align="left">/etc/cobbler/modules.conf</td>
<td align="left">模块的配置文件</td>
</tr>
</tbody></table>
<p><strong>cobbler数据目录</strong></p>
<table>
<thead>
<tr>
<th align="left">目录</th>
<th align="left">作用</th>
</tr>
</thead>
<tbody><tr>
<td align="left">/var/lib/cobbler/config/</td>
<td align="left">用于存放distros，system，profiles等信息配置文件</td>
</tr>
<tr>
<td align="left">/var/lib/cobbler/triggers/</td>
<td align="left">用于存放用户定义的cobbler命令</td>
</tr>
<tr>
<td align="left">/var/lib/cobbler/kickstart/</td>
<td align="left">默认存放kickstart文件</td>
</tr>
<tr>
<td align="left">/var/lib/cobbler/loaders/</td>
<td align="left">存放各种引导程序以及镜像目录</td>
</tr>
<tr>
<td align="left">/var/www/cobbler/ks_mirror/</td>
<td align="left">导入的发行版系统的所有数据</td>
</tr>
<tr>
<td align="left">/var/www/cobbler/images/</td>
<td align="left">导入发行版的kernel和initrd镜像用于远程网络启动</td>
</tr>
<tr>
<td align="left">/var/www/cobbler/repo_mirror/</td>
<td align="left">yum仓库存储目录</td>
</tr>
</tbody></table>
<p><strong>cobbler日志文件</strong></p>
<table>
<thead>
<tr>
<th align="left">日志文件路径</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">/var/log/cobbler/installing</td>
<td align="left">客户端安装日志</td>
</tr>
<tr>
<td align="left">/var/log/cobbler/cobbler.log</td>
<td align="left">cobbler日志</td>
</tr>
</tbody></table>
<p><code>cobbler</code>命令详解</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cobbler check       //核对当前设置是否有问题</span><br><span class="line">cobbler list        //列出所有的cobbler元素</span><br><span class="line">cobbler report      //列出元素的详细信息</span><br><span class="line">cobbler sync        //同步配置到数据目录,更改配置最好都要执行下</span><br><span class="line">cobbler reposync    //同步yum仓库</span><br><span class="line">cobbler distro      //查看导入的发行版系统信息</span><br><span class="line">cobbler system      //查看添加的系统信息</span><br><span class="line">cobbler profile     //查看配置信息</span><br></pre></td></tr></table></figure>

<h2 id="2-cobbler服务端部署"><a href="#2-cobbler服务端部署" class="headerlink" title="2. cobbler服务端部署"></a>2. cobbler服务端部署</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br></pre></td><td class="code"><pre><span class="line">配置yum源</span><br><span class="line">[root@localhost ~]# curl -o /etc/yum.repos.d/CentOS7-Base-163.repo http://mirrors.163.com/.help/CentOS7-Base-163.repo</span><br><span class="line">[root@localhost ~]# sed -i &apos;s/\$releasever/7/g&apos; /etc/yum.repos.d/CentOS7-Base-163.repo</span><br><span class="line">[root@localhost ~]# sed -i &apos;s/^enabled=.*/enabled=1/g&apos; /etc/yum.repos.d/CentOS7-Base-163.repo</span><br><span class="line">[root@localhost ~]# yum -y install epel-release</span><br><span class="line">安装过程略。。。。</span><br><span class="line"></span><br><span class="line">安装cobbler以及相关的软件</span><br><span class="line">[root@localhost ~]# yum -y install httpd dhcp tftp python-ctypes cobbler xinetd cobbler-web pykickstart</span><br><span class="line">安装过程略....</span><br><span class="line"></span><br><span class="line">启动服务并设置开机自启</span><br><span class="line">[root@localhost ~]# systemctl start httpd</span><br><span class="line">[root@localhost ~]# systemctl start cobblerd</span><br><span class="line">[root@localhost ~]# systemctl enable httpd</span><br><span class="line">Created symlink from /etc/systemd/system/multi-user.target.wants/httpd.service to /usr/lib/systemd/system/httpd.service.</span><br><span class="line">[root@localhost ~]# systemctl enable cobblerd</span><br><span class="line">Created symlink from /etc/systemd/system/multi-user.target.wants/cobblerd.service to /usr/lib/systemd/system/cobblerd.service.</span><br><span class="line"></span><br><span class="line">修改server的ip地址为本机ip</span><br><span class="line">[root@localhost ~]# sed -i &apos;s/^server: 127.0.0.1/server: 192.168.137.10/&apos; /etc/cobbler/settings</span><br><span class="line"></span><br><span class="line">设置tftp的ip地址为本机ip</span><br><span class="line">[root@localhost ~]# sed -i &apos;s/^next_server: 127.0.0.1/next_server: 192.168.137.10/&apos; /etc/cobbler/settings</span><br><span class="line"></span><br><span class="line">开启tftp</span><br><span class="line">[root@localhost ~]# sed -i &apos;/disable/s/yes/no/g&apos; /etc/xinetd.d/tftp</span><br><span class="line"></span><br><span class="line">下载缺失文件</span><br><span class="line">[root@localhost ~]# cobbler get-loaders</span><br><span class="line">......</span><br><span class="line">downloading https://cobbler.github.io/loaders/grub-0.97-x86_64.efi to /var/lib/cobbler/loaders/grub-x86_64.efi</span><br><span class="line">*** TASK COMPLETE ***</span><br><span class="line"></span><br><span class="line">启动rsync并设置开机自启</span><br><span class="line">[root@localhost ~]# systemctl start rsyncd</span><br><span class="line">[root@localhost ~]# systemctl enable rsyncd</span><br><span class="line">Created symlink from /etc/systemd/system/multi-user.target.wants/rsyncd.service to /usr/lib/systemd/system/rsyncd.service.</span><br><span class="line"></span><br><span class="line">生成加密的密码</span><br><span class="line">[root@localhost ~]# openssl passwd -1 -salt &quot;$RANDOM&quot; &apos;itwhs123!&apos;</span><br><span class="line">$1$8280$A4fc8ZnmQZlZjw/hDcN5Z1         //这是密码加密后的形式</span><br><span class="line"></span><br><span class="line">将新生成的加密密码加入到配置文件</span><br><span class="line">[root@localhost ~]# vim /etc/cobbler/settings</span><br><span class="line">....    //此处为省略内容</span><br><span class="line">default_password_crypted: &quot;$1$8280$A4fc8ZnmQZlZjw/hDcN5Z1&quot;</span><br><span class="line">.....   //此处为省略内容</span><br><span class="line"></span><br><span class="line">重启cobbler</span><br><span class="line">[root@localhost ~]# systemctl restart cobblerd</span><br><span class="line">[root@localhost ~]# ss -antl</span><br><span class="line">State       Recv-Q Send-Q      Local Address:Port                     Peer Address:Port</span><br><span class="line">LISTEN      0      128                     *:22                                  *:*</span><br><span class="line">LISTEN      0      100             127.0.0.1:25                                  *:*</span><br><span class="line">LISTEN      0      5               127.0.0.1:25151                               *:*</span><br><span class="line">LISTEN      0      5                       *:873                                 *:*</span><br><span class="line">LISTEN      0      128                    :::80                                 :::*</span><br><span class="line">LISTEN      0      128                    :::22                                 :::*</span><br><span class="line">LISTEN      0      100                   ::1:25                                 :::*</span><br><span class="line">LISTEN      0      128                    :::443                                :::*</span><br><span class="line">LISTEN      0      5                      :::873                                :::*</span><br><span class="line"></span><br><span class="line">通过cobbler check 核对当前设置是否有问题</span><br><span class="line">[root@localhost ~]# cobbler check</span><br><span class="line">The following are potential configuration items that you may want to fix:</span><br><span class="line"></span><br><span class="line">1 : debmirror package is not installed, it will be required to manage debian deployments and repositories</span><br><span class="line">2 : fencing tools were not found, and are required to use the (optional) power management features. install cman or fence-agents to use them</span><br><span class="line"></span><br><span class="line">Restart cobblerd and then run &apos;cobbler sync&apos; to apply changes.</span><br><span class="line">以上两个是关于debian系统的错误，请忽略</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">配置cobbler dhcp</span><br><span class="line">修改cobbler配置文件，让cobbler控制dhcp</span><br><span class="line">[root@localhost ~]# sed -i &apos;/^manage_dhcp/s/0/1/g&apos; /etc/cobbler/settings</span><br><span class="line">[root@localhost ~]# sed -n &apos;/^manage_dhcp/p&apos; /etc/cobbler/settings</span><br><span class="line">manage_dhcp: 1</span><br><span class="line"></span><br><span class="line">配置dhcp</span><br><span class="line">[root@localhost ~]# vim /etc/cobbler/dhcp.template</span><br><span class="line">....    //此处为省略内容</span><br><span class="line">subnet 192.168.137.0 netmask 255.255.255.0 &#123;</span><br><span class="line">     option routers             192.168.137.10;</span><br><span class="line">     option domain-name-servers 192.168.137.1;        //此处为系统安装好后指定的dns地址</span><br><span class="line">     option subnet-mask         255.255.255.0;</span><br><span class="line">     range dynamic-bootp        192.168.137.100 192.168.137.150;</span><br><span class="line">     default-lease-time         21600;</span><br><span class="line">     max-lease-time             43200;</span><br><span class="line">     next-server                $next_server; </span><br><span class="line">....    //此处为省略内容</span><br><span class="line"></span><br><span class="line">重启服务并同步配置，改完dhcp必须要sync同步配置</span><br><span class="line">[root@localhost ~]# systemctl restart cobblerd</span><br><span class="line">[root@localhost ~]# cobbler sync</span><br><span class="line">......</span><br><span class="line">running python trigger cobbler.modules.scm_track</span><br><span class="line">running shell triggers from /var/lib/cobbler/triggers/change/*</span><br><span class="line">*** TASK COMPLETE ***</span><br><span class="line"></span><br><span class="line">检查dhcp是否正常</span><br><span class="line">[root@localhost ~]# netstat -anulp|grep dhcp</span><br><span class="line">udp        0      0 0.0.0.0:67              0.0.0.0:*                           12692/dhcpd </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">导入redhat7镜像</span><br><span class="line">[root@localhost ~]# mount /dev/cdrom /mnt</span><br><span class="line">mount: /dev/sr0 is write-protected, mounting read-only</span><br><span class="line">[root@localhost ~]# cobbler import --path=/mnt --name=rhel-7 --arch=x86_64</span><br><span class="line">......</span><br><span class="line">Found a candidate signature: breed=redhat, version=rhel6</span><br><span class="line">Found a candidate signature: breed=redhat, version=rhel7</span><br><span class="line">Found a matching signature: breed=redhat, version=rhel7</span><br><span class="line">Adding distros from path /var/www/cobbler/ks_mirror/rhel-7-x86_64:</span><br><span class="line">creating new distro: rhel-7-x86_64</span><br><span class="line">trying symlink: /var/www/cobbler/ks_mirror/rhel-7-x86_64 -&gt; /var/www/cobbler/links/rhel-7-x86_64</span><br><span class="line">creating new profile: rhel-7-x86_64</span><br><span class="line">associating repos</span><br><span class="line">checking for rsync repo(s)</span><br><span class="line">checking for rhn repo(s)</span><br><span class="line">checking for yum repo(s)</span><br><span class="line">starting descent into /var/www/cobbler/ks_mirror/rhel-7-x86_64 for rhel-7-x86_64</span><br><span class="line">processing repo at : /var/www/cobbler/ks_mirror/rhel-7-x86_64     //导入镜像的位置</span><br><span class="line">need to process repo/comps: /var/www/cobbler/ks_mirror/rhel-7-x86_64</span><br><span class="line">looking for /var/www/cobbler/ks_mirror/rhel-7-x86_64/repodata/*comps*.xml</span><br><span class="line">Keeping repodata as-is :/var/www/cobbler/ks_mirror/rhel-7-x86_64/repodata</span><br><span class="line">*** TASK COMPLETE ***</span><br><span class="line"></span><br><span class="line">说明：</span><br><span class="line">    --path      //镜像路径</span><br><span class="line">    --name      //为安装源定义一个名字</span><br><span class="line">    --arch      //指定安装源平台</span><br><span class="line"></span><br><span class="line">安装源的唯一标示就是根据name参数来定义，本例导入成功后，安装源的唯一标示就是：CentOS-7-x86_64，如果重复，系统会提示导入失败</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">查看cobbler镜像列表</span><br><span class="line">[root@localhost ~]# cobbler list</span><br><span class="line">distros:</span><br><span class="line">   rhel-7-x86_64</span><br><span class="line"></span><br><span class="line">profiles:</span><br><span class="line">   rhel-7-x86_64</span><br><span class="line"></span><br><span class="line">systems:</span><br><span class="line"></span><br><span class="line">repos:</span><br><span class="line"></span><br><span class="line">images:</span><br><span class="line"></span><br><span class="line">mgmtclasses:</span><br><span class="line"></span><br><span class="line">packages:</span><br><span class="line"></span><br><span class="line">files:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">创建kickstarts自动安装脚本</span><br><span class="line">[root@localhost ~]# cat &gt; /var/lib/cobbler/kickstarts/Centos-7.6-x86_64.ks &lt;&lt;&apos;EOF&apos;</span><br><span class="line">auth --enableshadow --passalgo=sha512</span><br><span class="line">bootloader --location=mbr</span><br><span class="line">clearpart --all --initlabel</span><br><span class="line">part /boot --asprimary --fstype=&quot;ext4&quot; --size=500</span><br><span class="line">part swap --fstype=&quot;swap&quot; --size=3072</span><br><span class="line">part / --fstype=&quot;ext4&quot; --grow --size=15000</span><br><span class="line">text</span><br><span class="line">firewall --disabled</span><br><span class="line">firstboot --disable</span><br><span class="line">keyboard us</span><br><span class="line">lang en_US</span><br><span class="line">url --url=http://192.168.137.10/cobbler/ks_mirror/Centos-7.6-x86_64</span><br><span class="line">$yum_repo_stanza</span><br><span class="line">reboot</span><br><span class="line"></span><br><span class="line">rootpw --iscrypted $6$1DqmGBTIZJdzSAGN$i/neDtJQxcA5cAdXns6DPjgL6tSJABJIVsVQg/6MQNrF1FoXjjC6wB8M/jLc8vGv.rNVzINL6R9u2TqF3KeOB1</span><br><span class="line"></span><br><span class="line">selinux --disabled</span><br><span class="line">skipx</span><br><span class="line">timezone Asia/Shanghai --isUtc --nontp</span><br><span class="line">install</span><br><span class="line">zerombr</span><br><span class="line"></span><br><span class="line">%packages</span><br><span class="line">@^minimal</span><br><span class="line">@core</span><br><span class="line">kexec-tools</span><br><span class="line"></span><br><span class="line">%end</span><br><span class="line"></span><br><span class="line">%addon com_redhat_kdump --enable --reserve-mb=&apos;auto&apos;</span><br><span class="line"></span><br><span class="line">%end</span><br><span class="line"></span><br><span class="line">%anaconda</span><br><span class="line">pwpolicy root --minlen=6 --minquality=1 --notstrict --nochanges --notempty</span><br><span class="line">pwpolicy user --minlen=6 --minquality=1 --notstrict --nochanges --emptyok</span><br><span class="line">pwpolicy luks --minlen=6 --minquality=1 --notstrict --nochanges --notempty</span><br><span class="line">%end</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">检查ks文件语法是否有误</span><br><span class="line">[root@ct10 ~]# cobbler validateks</span><br><span class="line">task started: 2019-06-26_191758_validateks</span><br><span class="line">task started (id=Kickstart Validation, time=Wed Jun 26 19:17:58 2019)</span><br><span class="line">----------------------------</span><br><span class="line">osversion: rhel6</span><br><span class="line">checking url: http://192.168.137.10/cblr/svc/op/ks/profile/Centos-7.6-x86_64</span><br><span class="line">running: /usr/bin/ksvalidator -v &quot;rhel6&quot; &quot;http://192.168.137.10/cblr/svc/op/ks/profile/Centos-7.6-x86_64&quot;</span><br><span class="line">received on stdout: </span><br><span class="line">received on stderr: </span><br><span class="line">*** all kickstarts seem to be ok ***</span><br><span class="line">*** TASK COMPLETE ***</span><br><span class="line"></span><br><span class="line">查看当前cobbler有哪些配置文件</span><br><span class="line">[root@localhost ~]# cobbler profile list</span><br><span class="line">   Centos-7-x86_64</span><br><span class="line">   </span><br><span class="line">修改profile，将我们新建的ks文件设为默认的kickstarts安装文件</span><br><span class="line">[root@localhost ~]# cobbler profile edit --name Centos-7.6-x86_64 --kickstart=/var/lib/cobbler/kickstarts/Centos-7.6-x86_64.ks</span><br><span class="line"></span><br><span class="line">配置网卡名称为传统网卡名称eth0</span><br><span class="line">[root@localhost ~]# cobbler profile edit --name Centos-7.6-x86_64 --kopts=&apos;net.ifnames=0 biosdevname=0&apos;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">检查当前系统cobbler配置文件信息</span><br><span class="line">[root@localhost ~]# cobbler profile report</span><br><span class="line">Name                           : Centos-7.6-x86_64</span><br><span class="line">TFTP Boot Files                : &#123;&#125;</span><br><span class="line">Comment                        :</span><br><span class="line">DHCP Tag                       : default</span><br><span class="line">Distribution                   : Centos-7.6-x86_64        //仓库名字</span><br><span class="line">Enable gPXE?                   : 0</span><br><span class="line">Enable PXE Menu?               : 1</span><br><span class="line">Fetchable Files                : &#123;&#125;</span><br><span class="line">Kernel Options                 : &#123;&apos;biosdevname&apos;: &apos;0&apos;, &apos;net.ifnames&apos;: &apos;0&apos;&#125;       //网卡设为传统命名方式</span><br><span class="line">Kernel Options (Post Install)  : &#123;&#125;</span><br><span class="line">Kickstart                      : /var/lib/cobbler/kickstarts/Centos-7.6-x86_64.ks     //使用的kickstarts配置文件的路径，必须为我们新建的ks文件的路径</span><br><span class="line">Kickstart Metadata             : &#123;&#125;</span><br><span class="line">Management Classes             : []</span><br><span class="line">Management Parameters          : &lt;&lt;inherit&gt;&gt;</span><br><span class="line">Name Servers                   : []</span><br><span class="line">Name Servers Search Path       : []</span><br><span class="line">Owners                         : [&apos;admin&apos;]</span><br><span class="line">Parent Profile                 :</span><br><span class="line">Internal proxy                 :</span><br><span class="line">Red Hat Management Key         : &lt;&lt;inherit&gt;&gt;</span><br><span class="line">Red Hat Management Server      : &lt;&lt;inherit&gt;&gt;</span><br><span class="line">Repos                          : []</span><br><span class="line">Server Override                : &lt;&lt;inherit&gt;&gt;</span><br><span class="line">Template Files                 : &#123;&#125;</span><br><span class="line">Virt Auto Boot                 : 1</span><br><span class="line">Virt Bridge                    : xenbr0</span><br><span class="line">Virt CPUs                      : 1</span><br><span class="line">Virt Disk Driver Type          : raw</span><br><span class="line">Virt File Size(GB)             : 5</span><br><span class="line">Virt Path                      :</span><br><span class="line">Virt RAM (MB)                  : 512</span><br><span class="line">Virt Type                      : kvm</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">同步cobbler</span><br><span class="line">[root@localhost ~]# cobbler sync</span><br><span class="line">task started: 2019-06-26_192053_sync</span><br><span class="line">task started (id=Sync, time=Wed Jun 26 19:20:53 2019)</span><br><span class="line">running pre-sync triggers</span><br><span class="line">cleaning trees</span><br><span class="line">removing: /var/www/cobbler/images/Centos-7.6-x86_64</span><br><span class="line">removing: /var/lib/tftpboot/pxelinux.cfg/default</span><br><span class="line">removing: /var/lib/tftpboot/grub/images</span><br><span class="line">removing: /var/lib/tftpboot/grub/grub-x86.efi</span><br><span class="line">removing: /var/lib/tftpboot/grub/grub-x86_64.efi</span><br><span class="line">removing: /var/lib/tftpboot/grub/efidefault</span><br><span class="line">removing: /var/lib/tftpboot/images/Centos-7.6-x86_64</span><br><span class="line">removing: /var/lib/tftpboot/s390x/profile_list</span><br><span class="line">copying bootloaders</span><br><span class="line">trying hardlink /var/lib/cobbler/loaders/grub-x86.efi -&gt; /var/lib/tftpboot/grub/grub-x86.efi</span><br><span class="line">trying hardlink /var/lib/cobbler/loaders/grub-x86_64.efi -&gt; /var/lib/tftpboot/grub/grub-x86_64.efi</span><br><span class="line">copying distros to tftpboot</span><br><span class="line">copying files for distro: Centos-7.6-x86_64</span><br><span class="line">trying hardlink /var/www/cobbler/ks_mirror/Centos-7.6-x86_64/images/pxeboot/vmlinuz -&gt; /var/lib/tftpboot/images/Centos-7.6-x86_64/vmlinuz</span><br><span class="line">trying hardlink /var/www/cobbler/ks_mirror/Centos-7.6-x86_64/images/pxeboot/initrd.img -&gt; /var/lib/tftpboot/images/Centos-7.6-x86_64/initrd.img</span><br><span class="line">copying images</span><br><span class="line">generating PXE configuration files</span><br><span class="line">generating PXE menu structure</span><br><span class="line">copying files for distro: Centos-7.6-x86_64</span><br><span class="line">trying hardlink /var/www/cobbler/ks_mirror/Centos-7.6-x86_64/images/pxeboot/vmlinuz -&gt; /var/www/cobbler/images/Centos-7.6-x86_64/vmlinuz</span><br><span class="line">trying hardlink /var/www/cobbler/ks_mirror/Centos-7.6-x86_64/images/pxeboot/initrd.img -&gt; /var/www/cobbler/images/Centos-7.6-x86_64/initrd.img</span><br><span class="line">Writing template files for Centos-7.6-x86_64</span><br><span class="line">rendering DHCP files</span><br><span class="line">generating /etc/dhcp/dhcpd.conf</span><br><span class="line">rendering TFTPD files</span><br><span class="line">generating /etc/xinetd.d/tftp</span><br><span class="line">processing boot_files for distro: Centos-7.6-x86_64</span><br><span class="line">cleaning link caches</span><br><span class="line">running post-sync triggers</span><br><span class="line">running python triggers from /var/lib/cobbler/triggers/sync/post/*</span><br><span class="line">running python trigger cobbler.modules.sync_post_restart_services</span><br><span class="line">running: dhcpd -t -q</span><br><span class="line">received on stdout: </span><br><span class="line">received on stderr: </span><br><span class="line">running: service dhcpd restart</span><br><span class="line">received on stdout: </span><br><span class="line">received on stderr: Redirecting to /bin/systemctl restart dhcpd.service</span><br><span class="line"></span><br><span class="line">running shell triggers from /var/lib/cobbler/triggers/sync/post/*</span><br><span class="line">running python triggers from /var/lib/cobbler/triggers/change/*</span><br><span class="line">running python trigger cobbler.modules.manage_genders</span><br><span class="line">running python trigger cobbler.modules.scm_track</span><br><span class="line">running shell triggers from /var/lib/cobbler/triggers/change/*</span><br><span class="line">*** TASK COMPLETE ***</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">为避免发生未知问题，先把服务端所有服务重启</span><br><span class="line">[root@localhost ~]# systemctl restart xinetd</span><br><span class="line">[root@localhost ~]# systemctl restart cobblerd</span><br><span class="line">[root@localhost ~]# systemctl restart httpd</span><br><span class="line">[root@localhost ~]# ss -antl</span><br><span class="line">State      Recv-Q Send-Q Local Address:Port               Peer Address:Port</span><br><span class="line">LISTEN     0      128            *:22                         *:*</span><br><span class="line">LISTEN     0      100    127.0.0.1:25                         *:*</span><br><span class="line">LISTEN     0      5      127.0.0.1:25151                      *:*</span><br><span class="line">LISTEN     0      5              *:873                        *:*</span><br><span class="line">LISTEN     0      128           :::80                        :::*</span><br><span class="line">LISTEN     0      128           :::22                        :::*</span><br><span class="line">LISTEN     0      100          ::1:25                        :::*</span><br><span class="line">LISTEN     0      128           :::443                       :::*</span><br><span class="line">LISTEN     0      5             :::873                       :::*</span><br></pre></td></tr></table></figure>

<h2 id="3-客户端安装"><a href="#3-客户端安装" class="headerlink" title="3.客户端安装"></a>3.客户端安装</h2><p>新建虚拟机从PXE启动，若出现以下界面则表示成功：</p>
<p><img src="../../img/cobbler.png" alt="img"></p>
<h2 id="4-定制安装"><a href="#4-定制安装" class="headerlink" title="4.定制安装"></a>4.定制安装</h2><p>定制安装步骤：</p>
<ul>
<li>统计服务器的MAC地址</li>
<li>配置皮匠</li>
<li>安装</li>
</ul>
<p>在访问cobbler web界面到时候出现以下提示</p>
<p><img src="../../img/cobbler2.png" alt="Cobbler登录web界面提示报错“Internal Server Error”"></p>
<p>ssl的报错日志如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@Cobbler ~]# tail -f /var/log/httpd/ssl_error_log</span><br><span class="line">[Mon Jan 07 16:24:53.363029 2019] [:error] [pid 3383] [remote 10.0.0.1:212]     mod = importlib.import_module(self.SETTINGS_MODULE)</span><br><span class="line">[Mon Jan 07 16:24:53.363032 2019] [:error] [pid 3383] [remote 10.0.0.1:212]   File &quot;/usr/lib64/python2.7/importlib/__init__.py&quot;, line 37, in import_module</span><br><span class="line">[Mon Jan 07 16:24:53.363084 2019] [:error] [pid 3383] [remote 10.0.0.1:212]     __import__(name)</span><br><span class="line">[Mon Jan 07 16:24:53.363089 2019] [:error] [pid 3383] [remote 10.0.0.1:212]   File &quot;/usr/share/cobbler/web/settings.py&quot;, line 89, in &lt;module&gt;</span><br><span class="line">[Mon Jan 07 16:24:53.363097 2019] [:error] [pid 3383] [remote 10.0.0.1:212]     from django.conf.global_settings import TEMPLATE_CONTEXT_PROCESSORS</span><br><span class="line">[Mon Jan 07 16:24:53.363124 2019] [:error] [pid 3383] [remote 10.0.0.1:212] ImportError: cannot import name TEMPLATE_CONTEXT_PROCESSORS</span><br></pre></td></tr></table></figure>

<p>查看cobbler的py配置文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@Cobbler ~]# sed -n &apos;38,41p&apos; /usr/share/cobbler/web/settings.py</span><br><span class="line">if django.VERSION[0] == 1 and django.VERSION[1] &lt; 4:</span><br><span class="line">    ADMIN_MEDIA_PREFIX = &apos;/media/&apos;</span><br><span class="line">else:</span><br><span class="line">    STATIC_URL = &apos;/media/</span><br><span class="line"></span><br><span class="line">[root@Cobbler ~]# sed -n &apos;89p&apos; /usr/share/cobbler/web/settings.py</span><br><span class="line">from django.conf.global_settings import TEMPLATE_CONTEXT_PROCESSORS</span><br></pre></td></tr></table></figure>

<p>初步判断应该是pythone-django版本问题</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">#下载pip.py</span><br><span class="line">wget https://bootstrap.pypa.io/get-pip.py</span><br><span class="line"></span><br><span class="line">#调用本地python运行pip.py脚本</span><br><span class="line">python get-pip.py</span><br><span class="line"></span><br><span class="line">#安装pip</span><br><span class="line">pip install Django==1.8.9</span><br><span class="line"></span><br><span class="line">#查看pip版本号</span><br><span class="line">python -c &quot;import django; print(django.get_version())&quot;</span><br><span class="line"></span><br><span class="line">#重启httpd</span><br><span class="line">systemctl restart httpd</span><br></pre></td></tr></table></figure>

<p>最后完美解决</p>
<p>统计mac地址此处就不赘述了，直接最重要的配置<br>在cobbler的web界面上配置：</p>
<p><img src="../../img/system_create.png" alt="img"></p>
<p><img src="../../img/system_config1.png" alt="img"></p>
<p><img src="../../img/system_config2.png" alt="img"></p>
<p><img src="../../img/system_config3.png" alt="img"></p>
<p>同步配置并重启相关服务：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# cobbler sync</span><br><span class="line">[root@localhost ~]# systemctl restart httpd</span><br><span class="line">[root@localhost ~]# systemctl restart cobblerd</span><br><span class="line">[root@localhost ~]# systemctl restart xinetd</span><br></pre></td></tr></table></figure>

<p>最后开机自动会安装系统</p>

          
        
      
    </div>

    

    

    
    
    

    

    
      
    
    

    
	
	  <div>
        
      </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://aiwhs.github.io/2018/12/22/lamp/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="itw">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="itw">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2018/12/22/lamp/" class="post-title-link" itemprop="url">lamp</a>
              
            
          </h1>
        

        <div class="post-meta">

          
          
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-12-22 08:15:57" itemprop="dateCreated datePublished" datetime="2018-12-22T08:15:57+08:00">2018-12-22</time>
            </span>
          

          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-07-17 18:06:40" itemprop="dateModified" datetime="2019-07-17T18:06:40+08:00">2019-07-17</time>
              </span>
            
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Linux运维/" itemprop="url" rel="index"><span itemprop="name">Linux运维</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          <br>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <a id="more"></a>



<h2 id="1-lamp简介"><a href="#1-lamp简介" class="headerlink" title="1. lamp简介"></a>1. lamp简介</h2><p>有了前面学习的知识的铺垫，今天可以来学习下第一个常用的web架构了。</p>
<p>所谓lamp，其实就是由Linux+Apache+Mysql/MariaDB+Php/Perl/Python的一组动态网站或者服务器的开源软件，除Linux外其它各部件本身都是各自独立的程序，但是因为经常被放在一起使用，拥有了越来越高的兼容度，共同组成了一个强大的Web应用程序平台。</p>
<p>LAMP指的是Linux（操作系统）、Apache（HTTP服务器）、MySQL（也指MariaDB，数据库软件）和PHP（有时也是指Perl或Python）的第一个字母，一般用来建立web应用平台。</p>
<h2 id="2-web服务器工作流程"><a href="#2-web服务器工作流程" class="headerlink" title="2. web服务器工作流程"></a>2. web服务器工作流程</h2><p>在说lamp架构平台的搭建前，我们先来了解下什么是CGI，什么是FastCGI，什么是……</p>
<p>web服务器的资源分为两种，静态资源和动态资源</p>
<ul>
<li>静态资源就是指静态内容，客户端从服务器获得的资源的表现形式与原文件相同。可以简单的理解为就是直接存储于文件系统中的资源</li>
<li>动态资源则通常是程序文件，需要在服务器执行之后，将执行的结果返回给客户端</li>
</ul>
<p>那么web服务器如何执行程序并将结果返回给客户端呢？下面通过一张图来说明一下web服务器如何处理客户端的请求</p>
<p><img src="../../img/web_process.png" alt="img1"></p>
<p>如上图所示</p>
<p>阶段①显示的是<strong>httpd服务器（即apache）和php服务器通过FastCGI协议进行通信</strong>，且php作为独立的服务进程运行</p>
<p>阶段②显示的是<strong>php程序和mysql数据库间通过mysql协议进行通信</strong>。php与mysql本没有什么联系，但是由Php语言写成的程序可以与mysql进行数据交互。同理perl和python写的程序也可以与mysql数据库进行交互</p>
<h3 id="2-1-cgi与fastcgi"><a href="#2-1-cgi与fastcgi" class="headerlink" title="2.1 cgi与fastcgi"></a>2.1 cgi与fastcgi</h3><p>上图阶段①中提到了FastCGI，下面我们来了解下CGI与FastCGI。</p>
<blockquote>
<p>CGI（Common Gateway Interface，通用网关接口），CGI是外部应用程序（CGI程序）与WEB服务器之间的接口标准，是在CGI程序和Web服务器之间传递信息的过程。CGI规范允许Web服务器执行外部程序，并将它们的输出发送给Web浏览器，CGI将web的一组简单的静态超媒体文档变成一个完整的新的交互式媒体。</p>
<p>FastCGI（Fast Common Gateway Interface）是CGI的改良版，CGI是通过启用一个解释器进程来处理每个请求，耗时且耗资源，而FastCGI则是通过master-worker形式来处理每个请求，即启动一个master主进程，然后根据配置启动几个worker进程，当请求进来时，master会从worker进程中选择一个去处理请求，这样就避免了重复的生成和杀死进程带来的频繁cpu上下文切换而导致耗时</p>
</blockquote>
<h3 id="2-2-httpd与php结合的方式"><a href="#2-2-httpd与php结合的方式" class="headerlink" title="2.2 httpd与php结合的方式"></a>2.2 httpd与php结合的方式</h3><p>httpd与php结合的方式有以下三种：</p>
<ul>
<li>modules：php将以httpd的扩展模块形式存在，需要加载动态资源时，httpd可以直接通过php模块来加工资源并返回给客户端<ul>
<li>httpd prefork：libphp5.so（多进程模型的php）</li>
<li>httpd event or worker：libphp5-zts.so（线程模型的php）</li>
</ul>
</li>
<li>CGI：httpd需要加载动态资源时，通过CGI与php解释器联系，获得php执行的结果，此时httpd负责与php连接的建立和断开等</li>
<li>FastCGI：利用php-fpm机制，启动为服务进程，php自行运行为一个服务，https通过socket与php通信</li>
</ul>
<p><strong>较于CGI方式，FastCGI更为常用，很少有人使用CGI方式来加载动态资源</strong></p>
<h3 id="2-3-web工作流程"><a href="#2-3-web工作流程" class="headerlink" title="2.3 web工作流程"></a>2.3 web工作流程</h3><p>通过上面的图说明一下web的工作流程：</p>
<ul>
<li>客户端通过http协议请求web服务器资源</li>
<li>web服务器收到请求后判断客户端请求的资源是静态资源或是动态资源<ul>
<li>若是静态资源则直接从本地文件系统取之返回给客户端。</li>
<li>否则若为动态资源则通过FastCGI协议与php服务器联系，通过CGI程序的master进程调度worker进程来执行程序以获得客户端请求的动态资源，并将执行的结果通过FastCGI协议返回给httpd服务器，httpd服务器收到php的执行结果后将其封装为http响应报文响应给客户端。在执行程序获取动态资源时若需要获得数据库中的资源时，由Php服务器通过mysql协议与MySQL/MariaDB服务器交互，取之而后返回给httpd，httpd将从php服务器收到的执行结果封装成http响应报文响应给客户端。</li>
</ul>
</li>
</ul>
<h2 id="3-lamp平台构建"><a href="#3-lamp平台构建" class="headerlink" title="3. lamp平台构建"></a>3. lamp平台构建</h2><p><strong>环境说明：</strong></p>
<table>
<thead>
<tr>
<th align="left">系统平台</th>
<th align="left">IP</th>
<th align="left">需要安装的服务</th>
</tr>
</thead>
<tbody><tr>
<td align="left">centos7 <br>redhat7</td>
<td align="left">192.168.161.130</td>
<td align="left">httpd-2.4 <br>mysql-5.7 <br>php<br> php-mysql</td>
</tr>
</tbody></table>
<p>lamp平台软件安装次序：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">httpd --&gt; mysql --&gt; php</span><br></pre></td></tr></table></figure>

<p><strong>注意：php要求httpd使用prefork MPM</strong></p>
<h3 id="3-1-安装httpd"><a href="#3-1-安装httpd" class="headerlink" title="3.1 安装httpd"></a>3.1 安装httpd</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">安装开发工具包</span><br><span class="line">[root@localhost ~]# yum groups mark install &apos;Development Tools&apos;</span><br><span class="line"></span><br><span class="line">创建apache服务的用户和组</span><br><span class="line">[root@localhost ~]# groupadd -r apache</span><br><span class="line">[root@localhost ~]# useradd -r -M -s /sbin/nologin -g apache apache </span><br><span class="line"></span><br><span class="line">安装依赖包</span><br><span class="line">[root@localhost ~]# yum -y install openssl-devel pcre-devel expat-devel libtool</span><br><span class="line"></span><br><span class="line">下载和安装apr以及apr-util</span><br><span class="line">[root@localhost ~]# cd /usr/src/</span><br><span class="line">[root@localhost src]# wget http://mirrors.shu.edu.cn/apache//apr/apr-1.6.5.tar.bz2</span><br><span class="line">[root@localhost src]# wget http://mirrors.shu.edu.cn/apache//apr/apr-util-1.6.1.tar.bz2</span><br><span class="line">[root@localhost src]# ls</span><br><span class="line">apr-1.6.5.tar.bz2  apr-util-1.6.1.tar.bz2  debug  kernels</span><br><span class="line">[root@localhost src]# tar xf apr-1.6.5.tar.bz2</span><br><span class="line">[root@localhost src]# tar xf apr-util-1.6.1.tar.bz2</span><br><span class="line">[root@localhost src]# ls</span><br><span class="line">apr-1.6.5  apr-1.6.5.tar.bz2  apr-util-1.6.1  apr-util-1.6.1.tar.bz2  debug  kernels</span><br><span class="line">[root@localhost src]# cd apr-1.6.5</span><br><span class="line">[root@localhost apr-1.6.5]# vim configure</span><br><span class="line">    cfgfile=&quot;$&#123;ofile&#125;T&quot;</span><br><span class="line">    trap &quot;$RM \&quot;$cfgfile\&quot;; exit 1&quot; 1 2 15</span><br><span class="line">    # $RM &quot;$cfgfile&quot;        //将此行加上注释，或者删除此行</span><br><span class="line"></span><br><span class="line">[root@localhost apr-1.6.5]# ./configure --prefix=/usr/local/apr</span><br><span class="line">[root@localhost apr-1.6.5]# make &amp;&amp; make install</span><br><span class="line">[root@localhost apr-1.6.5]# cd /usr/src/apr-util-1.6.1</span><br><span class="line">[root@localhost apr-util-1.6.1]# ./configure --prefix=/usr/local/apr-util --with-apr=/usr/local/apr</span><br><span class="line">[root@localhost apr-util-1.6.1]# make &amp;&amp; make install</span><br><span class="line"></span><br><span class="line">编译安装httpd</span><br><span class="line">[root@localhost ~]# wget http://mirror.bit.edu.cn/apache//httpd/httpd-2.4.37.tar.bz2</span><br><span class="line"></span><br><span class="line">[root@localhost ~]# ls</span><br><span class="line">httpd-2.4.37.tar.bz2</span><br><span class="line">[root@localhost ~]# tar xf httpd-2.4.37.tar.bz2</span><br><span class="line">[root@localhost ~]# cd httpd-2.4.37</span><br><span class="line">[root@localhost httpd-2.4.37]# ./configure --prefix=/usr/local/apache \</span><br><span class="line">--sysconfdir=/etc/httpd24 \</span><br><span class="line">--enable-so \</span><br><span class="line">--enable-ssl \</span><br><span class="line">--enable-cgi \</span><br><span class="line">--enable-rewrite \</span><br><span class="line">--with-zlib \</span><br><span class="line">--with-pcre \</span><br><span class="line">--with-apr=/usr/local/apr \</span><br><span class="line">--with-apr-util=/usr/local/apr-util/ \</span><br><span class="line">--enable-modules=most \</span><br><span class="line">--enable-mpms-shared=all \</span><br><span class="line">--with-mpm=prefork</span><br><span class="line"></span><br><span class="line">[root@localhost httpd-2.4.37]# make &amp;&amp; make install</span><br><span class="line"></span><br><span class="line">安装后配置</span><br><span class="line">[root@localhost ~]# echo &apos;export PATH=/usr/local/apache/bin:$PATH&apos; &gt; /etc/profile.d/httpd.sh</span><br><span class="line">[root@localhost ~]# source /etc/profile.d/httpd.sh</span><br><span class="line">[root@localhost ~]# ln -s /usr/local/apache/include/ /usr/include/httpd</span><br><span class="line">[root@localhost ~]# echo &apos;MANPATH /usr/local/apache/man&apos; &gt;&gt; /etc/man.config</span><br><span class="line"></span><br><span class="line">取消ServerName前面的注释</span><br><span class="line">[root@localhost ~]# sed -i &apos;/#ServerName/s/#//g&apos; /etc/httpd24/httpd.conf </span><br><span class="line"></span><br><span class="line">启动apache</span><br><span class="line">[root@localhost ~]# apachectl start</span><br><span class="line">[root@localhost ~]# ss -antl</span><br><span class="line">State      Recv-Q Send-Q   Local Address:Port                  Peer Address:Port</span><br><span class="line">LISTEN     0      128                  *:22                               *:*</span><br><span class="line">LISTEN     0      100          127.0.0.1:25                               *:*</span><br><span class="line">LISTEN     0      128                 :::80                              :::*</span><br><span class="line">LISTEN     0      128                 :::22                              :::*</span><br><span class="line">LISTEN     0      100                ::1:25                              :::*</span><br></pre></td></tr></table></figure>

<h3 id="3-2-安装mysql"><a href="#3-2-安装mysql" class="headerlink" title="3.2 安装mysql"></a>3.2 安装mysql</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br></pre></td><td class="code"><pre><span class="line">安装依赖包</span><br><span class="line">[root@localhost ~]# yum -y install ncurses-devel openssl-devel openssl cmake mariadb-devel</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">创建用户和组</span><br><span class="line">[root@localhost src]# groupadd -r -g 306 mysql</span><br><span class="line">[root@localhost src]# useradd -M -s /sbin/nologin -g 306 -u 306 mysql</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">下载二进制格式的mysql软件包</span><br><span class="line">[root@localhost ~]# cd /usr/src/</span><br><span class="line">[root@localhost src]# wget https://downloads.mysql.com/archives/get/file/mysql-5.7.22-linux-glibc2.12-x86_64.tar.gz</span><br><span class="line">--2018-08-13 23:56:27--  https://downloads.mysql.com/archives/get/file/mysql-5.7.22-linux-glibc2.12-x86_64.tar.gz</span><br><span class="line">Resolving downloads.mysql.com (downloads.mysql.com)... 137.254.60.14</span><br><span class="line">Connecting to downloads.mysql.com (downloads.mysql.com)|137.254.60.14|:443... connected.</span><br><span class="line">HTTP request sent, awaiting response... 302 Found</span><br><span class="line">Location: https://cdn.mysql.com/archives/mysql-5.7/mysql-5.7.22-linux-glibc2.12-x86_64.tar.gz [following]</span><br><span class="line">......</span><br><span class="line">Saving to: ‘mysql-5.7.22-linux-glibc2.12-x86_64.tar.gz’</span><br><span class="line"></span><br><span class="line">100%[=====================================&gt;] 643,790,848 2.46MB/s   in 4m 20s</span><br><span class="line"></span><br><span class="line">2018-08-14 00:00:50 (2.36 MB/s) - ‘mysql-5.7.22-linux-glibc2.12-x86_64.tar.gz’saved [643790848/643790848]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">解压软件至/usr/local/</span><br><span class="line">[root@localhost src]# ls</span><br><span class="line">debug  kernels  mysql-5.7.22-linux-glibc2.12-x86_64.tar.gz</span><br><span class="line">[root@localhost src]# tar xf mysql-5.7.22-linux-glibc2.12-x86_64.tar.gz -C /usr/local/</span><br><span class="line">[root@localhost ~]# ls /usr/local/</span><br><span class="line">bin  games    lib    libexec                              sbin   src</span><br><span class="line">etc  include  lib64  mysql-5.7.22-linux-glibc2.12-x86_64  share</span><br><span class="line">[root@localhost ~]# cd /usr/local/</span><br><span class="line">[root@localhost local]# ln -sv mysql-5.7.22-linux-glibc2.12-x86_64/ mysql</span><br><span class="line">‘mysql’ -&gt; ‘mysql-5.7.22-linux-glibc2.12-x86_64/’</span><br><span class="line">[root@localhost local]# ll</span><br><span class="line">total 0</span><br><span class="line">drwxr-xr-x. 2 root root   6 Mar 10  2016 bin</span><br><span class="line">drwxr-xr-x. 2 root root   6 Mar 10  2016 etc</span><br><span class="line">drwxr-xr-x. 2 root root   6 Mar 10  2016 games</span><br><span class="line">drwxr-xr-x. 2 root root   6 Mar 10  2016 include</span><br><span class="line">drwxr-xr-x. 2 root root   6 Mar 10  2016 lib</span><br><span class="line">drwxr-xr-x. 2 root root   6 Mar 10  2016 lib64</span><br><span class="line">drwxr-xr-x. 2 root root   6 Mar 10  2016 libexec</span><br><span class="line">lrwxrwxrwx  1 root root  36 Aug 14 16:00 mysql -&gt; mysql-5.7.22-linux-glibc2.12-x86_64/</span><br><span class="line">drwxr-xr-x  9 root root 129 Aug 14 00:16 mysql-5.7.22-linux-glibc2.12-x86_64</span><br><span class="line">drwxr-xr-x. 2 root root   6 Mar 10  2016 sbin</span><br><span class="line">drwxr-xr-x. 5 root root  49 Jun 13 19:03 share</span><br><span class="line">drwxr-xr-x. 2 root root   6 Mar 10  2016 src</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">修改目录/usr/local/mysql的属主属组</span><br><span class="line">[root@localhost ~]# chown -R mysql.mysql /usr/local/mysql</span><br><span class="line">[root@localhost ~]# ll /usr/local/mysql -d</span><br><span class="line">lrwxrwxrwx 1 mysql mysql 36 Aug 14 16:00 /usr/local/mysql -&gt; mysql-5.7.22-linux-glibc2.12-x86_64/</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">添加环境变量</span><br><span class="line">[root@localhost ~]# ls /usr/local/mysql</span><br><span class="line">bin  COPYING  docs  include  lib  man  README  share  support-files</span><br><span class="line">[root@localhost ~]# echo &apos;export PATH=/usr/local/mysql/bin:$PATH&apos; &gt; /etc/profile.d/mysql.sh</span><br><span class="line">[root@localhost ~]# . /etc/profile.d/mysql.sh</span><br><span class="line">[root@localhost ~]# echo $PATH</span><br><span class="line">/usr/local/mysql/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/root/bin</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">建立数据存放目录</span><br><span class="line">[root@localhost mysql]# mkdir /opt/data</span><br><span class="line">[root@localhost mysql]# chown -R mysql.mysql /opt/data/</span><br><span class="line">[root@localhost mysql]# ll /opt/</span><br><span class="line">total 0</span><br><span class="line">drwxr-xr-x 2 mysql mysql 6 Aug 14 16:54 data</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">初始化数据库</span><br><span class="line">[root@localhost ~]# /usr/local/mysql/bin/mysqld --initialize --user=mysql --datadir=/opt/data/</span><br><span class="line">.......</span><br><span class="line">temporary password is generatedfor root@localhost: adjceSV12=Sa</span><br><span class="line">请注意，这个命令的最后会生成一个临时密码，此处密码是adjceSV12=Sa</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">配置mysql</span><br><span class="line">[root@localhost ~]# ln -sv /usr/local/mysql/include/ /usr/local/include/mysql</span><br><span class="line">‘/usr/local/include/mysql’ -&gt; ‘/usr/local/mysql/include/’</span><br><span class="line">[root@localhost ~]# echo &apos;/usr/local/mysql/lib&apos; &gt; /etc/ld.so.conf.d/mysql.conf</span><br><span class="line">[root@localhost ~]# ldconfig -v</span><br><span class="line">ldconfig: Can&apos;t stat /libx32: No such file or directory</span><br><span class="line">ldconfig: Path `/usr/lib&apos; given more than once</span><br><span class="line">ldconfig: Path `/usr/lib64&apos; given more than once</span><br><span class="line">ldconfig: Can&apos;t stat /usr/libx32: No such file or directory</span><br><span class="line">/usr/lib64/mysql:</span><br><span class="line">        libmysqlclient.so.18 -&gt; libmysqlclient_r.so</span><br><span class="line">/usr/local/mysql/lib:</span><br><span class="line">        libmysqlclient.so.20 -&gt; libmysqlclient.so.20.3.9 </span><br><span class="line">......</span><br><span class="line">/lib/sse2: (hwcap: 0x0000000004000000)</span><br><span class="line">/lib64/sse2: (hwcap: 0x0000000004000000)</span><br><span class="line">/lib64/tls: (hwcap: 0x8000000000000000)</span><br><span class="line">[root@localhost ~]# ldconfig -p |grep mysql</span><br><span class="line">        libmysqlclient.so.20 (libc6,x86-64) =&gt; /usr/local/mysql/lib/libmysqlclient.so.20</span><br><span class="line">        libmysqlclient.so.18 (libc6,x86-64) =&gt; /usr/lib64/mysql/libmysqlclient.so.18</span><br><span class="line">        libmysqlclient.so (libc6,x86-64) =&gt; /usr/lib64/mysql/libmysqlclient.so</span><br><span class="line">        libmysqlclient.so (libc6,x86-64) =&gt; /usr/local/mysql/lib/libmysqlclient.so</span><br><span class="line">        </span><br><span class="line"></span><br><span class="line">生成配置文件</span><br><span class="line">[root@localhost ~]# cat &gt; /etc/my.cnf &lt;&lt;EOF</span><br><span class="line">[mysqld]</span><br><span class="line">basedir = /usr/local/mysql</span><br><span class="line">datadir = /opt/data</span><br><span class="line">socket = /tmp/mysql.sock</span><br><span class="line">port = 3306</span><br><span class="line">pid-file = /opt/data/mysql.pid</span><br><span class="line">user = mysql</span><br><span class="line">skip-name-resolve</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">配置服务启动脚本</span><br><span class="line">[root@localhost ~]# cp -a /usr/local/mysql/support-files/mysql.server /etc/init.d/mysqld</span><br><span class="line">[root@localhost ~]# sed -ri &apos;s#^(basedir=).*#\1/usr/local/mysql#g&apos; /etc/init.d/mysqld</span><br><span class="line">[root@localhost ~]# sed -ri &apos;s#^(datadir=).*#\1/opt/data#g&apos; /etc/init.d/mysqld</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">启动mysql</span><br><span class="line">[root@localhost ~]# service mysqld start</span><br><span class="line">Starting MySQL.. SUCCESS!  </span><br><span class="line">[root@localhost ~]# ps -ef|grep mysql</span><br><span class="line">root       1521      1  0 01:58 pts/0    00:00:00 /bin/sh /usr/local/mysql/binmysqld_safe --datadir=/opt/data --pid-file=/opt/data/mysql.pid</span><br><span class="line">mysql      1699   1521  0 01:58 pts/0    00:00:00 /usr/local/mysql/bin/mysqld --basedir=/usr/local/mysql --datadir=/opt/data --plugin-dir=/usr/local/mysql/lib/plugin --user=mysql --log-error=localhost.localdomain.err --pid-file=/opt/data/mysql.pid --socket=/tmp/mysql.sock --port=3306</span><br><span class="line">root       1734   1301  0 01:59 pts/0    00:00:00 grep --color=auto mysql</span><br><span class="line">[root@localhost ~]# ss -antl</span><br><span class="line">State       Recv-Q Send-Q Local Address:Port               Peer Address:Port</span><br><span class="line">LISTEN      0      128         *:22                      *:*</span><br><span class="line">LISTEN      0      100    127.0.0.1:25                      *:*</span><br><span class="line">LISTEN      0      128        :::22                     :::*</span><br><span class="line">LISTEN      0      100       ::1:25                     :::*</span><br><span class="line">LISTEN      0      80         :::3306                   :::* </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">修改密码</span><br><span class="line">使用临时密码登录</span><br><span class="line">[root@localhost ~]# mysql -uroot -p</span><br><span class="line">Enter password:</span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 2</span><br><span class="line">Server version: 5.7.22</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2018, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type &apos;help;&apos; or &apos;\h&apos; for help. Type &apos;\c&apos; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">mysql&gt; </span><br><span class="line"></span><br><span class="line">设置新密码</span><br><span class="line">mysql&gt; set password = password(&apos;itwhs123[&apos;);</span><br><span class="line">Query OK, 0 rows affected, 1 warning (0.00 sec)</span><br><span class="line">mysql&gt; quit</span><br><span class="line">Bye</span><br></pre></td></tr></table></figure>

<h3 id="3-3-安装php"><a href="#3-3-安装php" class="headerlink" title="3.3 安装php"></a>3.3 安装php</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line">配置yum源</span><br><span class="line">[root@localhost ~]# cd /etc/yum.repos.d/</span><br><span class="line">[root@localhost yum.repos.d]# wget http://mirrors.163.com/.help/CentOS7-Base-163.repo</span><br><span class="line">[root@localhost ~]# sed -i &apos;s/\$releasever/7/g&apos; /etc/yum.repos.d/CentOS7-Base-163.repo</span><br><span class="line">[root@localhost ~]# sed -i &apos;s/^enabled=.*/enabled=1/g&apos; /etc/yum.repos.d/CentOS7-Base-163.repo</span><br><span class="line">[root@localhost ~]# yum -y install epel-release</span><br><span class="line">[root@localhost ~]# rpm -Uvh https://mirror.webtatic.com/yum/el7/webtatic-release.rpm</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">安装依赖包</span><br><span class="line">[root@localhost ~]# yum -y install libxml2 libxml2-devel openssl openssl-devel bzip2 bzip2-devel libcurl libcurl-devel libicu-devel libjpeg libjpeg-devel libpng libpng-devel openldap-devel  libpcre-devel freetype freetype-devel gmp gmp-devel libmcrypt libmcrypt-devel readline readline-devel libxslt libxslt-devel mhash mhash-devel php72w-mysqlnd</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">下载php</span><br><span class="line">[root@localhost ~]# cd /usr/src/</span><br><span class="line">[root@localhost src]# wget http://cn.php.net/distributions/php-7.2.8.tar.xz</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">编译安装php</span><br><span class="line">[root@localhost src]# tar xf php-7.2.8.tar.xz</span><br><span class="line">[root@localhost src]# cd php-7.2.8</span><br><span class="line">[root@localhost php-7.2.8]# ./configure --prefix=/usr/local/php7  \</span><br><span class="line">--with-config-file-path=/etc \</span><br><span class="line">--enable-fpm \</span><br><span class="line">--enable-inline-optimization \</span><br><span class="line">--disable-debug \</span><br><span class="line">--disable-rpath \</span><br><span class="line">--enable-shared \</span><br><span class="line">--enable-soap \</span><br><span class="line">--with-openssl \</span><br><span class="line">--enable-bcmath \</span><br><span class="line">--with-iconv \</span><br><span class="line">--with-bz2 \</span><br><span class="line">--enable-calendar \</span><br><span class="line">--with-curl \</span><br><span class="line">--enable-exif  \</span><br><span class="line">--enable-ftp \</span><br><span class="line">--with-gd \</span><br><span class="line">--with-jpeg-dir \</span><br><span class="line">--with-png-dir \</span><br><span class="line">--with-zlib-dir \</span><br><span class="line">--with-freetype-dir \</span><br><span class="line">--with-gettext \</span><br><span class="line">--enable-json \</span><br><span class="line">--enable-mbstring \</span><br><span class="line">--enable-pdo \</span><br><span class="line">--with-mysqli=mysqlnd \</span><br><span class="line">--with-pdo-mysql=mysqlnd \</span><br><span class="line">--with-readline \</span><br><span class="line">--enable-shmop \</span><br><span class="line">--enable-simplexml \</span><br><span class="line">--enable-sockets \</span><br><span class="line">--enable-zip \</span><br><span class="line">--enable-mysqlnd-compression-support \</span><br><span class="line">--with-pear \</span><br><span class="line">--enable-pcntl \</span><br><span class="line">--enable-posix</span><br><span class="line">[root@localhost php-7.2.8]# make -j $(cat /proc/cpuinfo |grep processor|wc -l)</span><br><span class="line">编译过程略</span><br><span class="line">[root@localhost php-7.2.8]# make install</span><br><span class="line">安装过程略</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">安装后配置</span><br><span class="line">[root@localhost ~]# echo &apos;export PATH=/usr/local/php7/bin:$PATH&apos; &gt; /etc/profile.d/php7.sh</span><br><span class="line">[root@localhost ~]# source /etc/profile.d/php7.sh</span><br><span class="line">[root@localhost php-7.2.8]# which php</span><br><span class="line">/usr/local/php7/bin/php</span><br><span class="line">[root@localhost php-7.2.8]# php -v</span><br><span class="line">PHP 7.2.8 (cli) (built: May 14 2019 14:32:34) ( NTS )</span><br><span class="line">Copyright (c) 1997-2018 The PHP Group</span><br><span class="line">Zend Engine v3.2.0, Copyright (c) 1998-2018 Zend Technologies</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">配置php-fpm</span><br><span class="line">[root@localhost php-7.2.8]# cp php.ini-production /etc/php.ini</span><br><span class="line">[root@localhost php-7.2.8]# cp sapi/fpm/init.d.php-fpm /etc/init.d/php-fpm</span><br><span class="line">[root@localhost php-7.2.8]# chmod +x /etc/rc.d/init.d/php-fpm</span><br><span class="line">[root@localhost php-7.2.8]# cp /usr/local/php7/etc/php-fpm.conf.default /usr/local/php7/etc/php-fpm.conf</span><br><span class="line">[root@localhost php-7.2.8]# cp /usr/local/php7/etc/php-fpm.d/www.conf.default /usr/local/php7/etc/php-fpm.d/www.conf</span><br><span class="line"></span><br><span class="line">编辑php-fpm的配置文件（/usr/local/php7/etc/php-fpm.conf）：</span><br><span class="line">配置fpm的相关选项为你所需要的值：</span><br><span class="line">[root@localhost ~]# vim /usr/local/php7/etc/php-fpm.conf</span><br><span class="line">.....</span><br><span class="line">.....</span><br><span class="line">pm.max_children = 50    //最多同时提供50个进程提供50个并发服务</span><br><span class="line">pm.start_servers = 5    //启动时启动5个进程</span><br><span class="line">pm.min_spare_servers = 2    //最小空闲进程数</span><br><span class="line">pm.max_spare_servers = 8    //最大空闲进程数</span><br><span class="line"></span><br><span class="line">[root@localhost ~]# tail /usr/local/php7/etc/php-fpm.conf</span><br><span class="line">; file.</span><br><span class="line">; Relative path can also be used. They will be prefixed by:</span><br><span class="line">;  - the global prefix if it&apos;s been set (-p argument)</span><br><span class="line">;  - /usr/local/php7 otherwise</span><br><span class="line">include=/usr/local/php7/etc/php-fpm.d/*.conf</span><br><span class="line">pm.max_children = 50</span><br><span class="line">pm.start_servers = 5</span><br><span class="line">pm.min_spare_servers = 2</span><br><span class="line">pm.max_spare_servers = 8</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">启动php-fpm</span><br><span class="line">[root@localhost ~]# service php-fpm start</span><br><span class="line">Starting php-fpm  done</span><br><span class="line"></span><br><span class="line">默认情况下，fpm监听在127.0.0.1的9000端口，也可以使用如下命令验证其是否已经监听在相应的套接字</span><br><span class="line">[root@localhost ~]# ss -antl</span><br><span class="line">State      Recv-Q Send-Q           Local Address:Port                          Peer Address:Port</span><br><span class="line">LISTEN     0      128                          *:22                                       *:*</span><br><span class="line">LISTEN     0      100                  127.0.0.1:25                                       *:*</span><br><span class="line">LISTEN     0      128                  127.0.0.1:9000                                     *:*</span><br><span class="line">LISTEN     0      128                         :::80                                      :::*</span><br><span class="line">LISTEN     0      128                         :::22                                      :::*</span><br><span class="line">LISTEN     0      100                        ::1:25                                      :::*</span><br><span class="line">LISTEN     0      80                          :::3306                                    :::*</span><br><span class="line"></span><br><span class="line">[root@localhost ~]# ps -ef|grep php</span><br><span class="line">root      81070      1  0 14:13 ?        00:00:00 php-fpm: master process (/usr/local/php7/etc/php-fpm.conf)</span><br><span class="line">nobody    81071  81070  0 14:13 ?        00:00:00 php-fpm: pool www</span><br><span class="line">nobody    81072  81070  0 14:13 ?        00:00:00 php-fpm: pool www</span><br><span class="line">nobody    81073  81070  0 14:13 ?        00:00:00 php-fpm: pool www</span><br><span class="line">nobody    81074  81070  0 14:13 ?        00:00:00 php-fpm: pool www</span><br><span class="line">nobody    81075  81070  0 14:13 ?        00:00:00 php-fpm: pool www</span><br><span class="line">root      81079  83354  0 14:15 pts/1    00:00:00 grep --color=auto php</span><br></pre></td></tr></table></figure>

<h3 id="3-4-配置apache"><a href="#3-4-配置apache" class="headerlink" title="3.4 配置apache"></a>3.4 配置apache</h3><h4 id="3-4-1-启用代理模块"><a href="#3-4-1-启用代理模块" class="headerlink" title="3.4.1 启用代理模块"></a>3.4.1 启用代理模块</h4><p>在apache httpd 2.4以后已经专门有一个模块针对FastCGI的实现，此模块为mod_proxy_fcgi.so，它其实是作为mod_proxy.so模块的扩展，因此，这两个模块都要加载，编辑httpd.conf文件，取消以下两行内容的注释:</p>
<ul>
<li>LoadModule proxy_module modules/mod_proxy.so</li>
<li>LoadModule proxy_fcgi_module modules/mod_proxy_fcgi.so</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">//启用httpd的相关模块</span><br><span class="line">[root@localhost ~]# sed -i &apos;/proxy_module/s/#//g&apos; /etc/httpd24/httpd.conf</span><br><span class="line">[root@localhost ~]# sed -i &apos;/proxy_fcgi_module/s/#//g&apos; /etc/httpd24/httpd.conf</span><br></pre></td></tr></table></figure>

<h4 id="3-4-2-配置虚拟主机"><a href="#3-4-2-配置虚拟主机" class="headerlink" title="3.4.2 配置虚拟主机"></a>3.4.2 配置虚拟主机</h4><p>在需要使用fcgi的虚拟主机中添加类似如下两行：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ProxyRequests Off       //关闭正向代理</span><br><span class="line">ProxyPassMatch ^/(.*\.php)$ fcgi://127.0.0.1:9000/PATH/TO/DOCUMENT_ROOT/$1</span><br></pre></td></tr></table></figure>

<p><strong>例如：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ProxyPassMatch ^/(.*\.php)$ fcgi://127.0.0.1:9000/var/www/html/itwhs.com/$1</span><br></pre></td></tr></table></figure>

<p>以上设置表示把以.php结尾的文件请求发送到php-fpm进程，php-fpm至少需要知道运行的目录和URI，所以这里直接在fcgi://127.0.0.1:9000后指明了这两个参数，其它参数的传递已经被mod_proxy_fcgi.so进行了封装，不需要手动指定。</p>
<p><strong>注意：</strong></p>
<blockquote>
<p>这里写的/var/www/html/是yum源安装方式生成的网页存放目录，这里必须改成你编译安装指定的网页存放路径，禁止直接复制我这里的路径<br>这里的idfsoft.com是域名，你必须改成你所使用的域名，禁止直接复制此处的域名<br>这里的$1表示匹配所有以.php结尾的http请求</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">创建虚拟主机目录并生成php测试页面</span><br><span class="line">[root@localhost ~]# mkdir /usr/local/apache/htdocs/itwhs.com</span><br><span class="line">[root@localhost ~]# cat &gt; /usr/local/apache/htdocs/itwhs.com/index.php &lt;&lt;EOF</span><br><span class="line">&lt;?php</span><br><span class="line">   phpinfo();</span><br><span class="line">?&gt;</span><br><span class="line">EOF</span><br><span class="line">[root@localhost ~]# chown -R apache.apache /usr/local/apache/htdocs/</span><br><span class="line">[root@localhost ~]# ll /usr/local/apache/htdocs/ -d</span><br><span class="line">drwxr-xr-x 3 apache apache 44 Aug 16 14:50 /usr/local/apache/htdocs/</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@localhost ~]# vim /etc/httpd24/httpd.conf</span><br><span class="line">在配置文件的最后加入以下内容</span><br><span class="line">&lt;VirtualHost *:80&gt;</span><br><span class="line">    DocumentRoot &quot;/usr/local/apache/htdocs/itwhs.com&quot;</span><br><span class="line">    ServerName www.itwhs.com</span><br><span class="line">    ProxyRequests Off</span><br><span class="line">    ProxyPassMatch ^/(.*\.php)$ fcgi://127.0.0.1:9000/usr/local/apache/htdocs/itwhs.com/$1</span><br><span class="line">    &lt;Directory &quot;/usr/local/apache/htdocs/itwhs.com&quot;&gt;</span><br><span class="line">        Options none</span><br><span class="line">        AllowOverride none</span><br><span class="line">        Require all granted</span><br><span class="line">    &lt;/Directory&gt;</span><br><span class="line">&lt;/VirtualHost&gt;  </span><br><span class="line"></span><br><span class="line">[root@localhost ~]# vim /etc/httpd24/httpd.conf</span><br><span class="line">搜索AddType，添加以下内容</span><br><span class="line">    # If the AddEncoding directives above are commented-out, then you</span><br><span class="line">    # probably should define those extensions to indicate media types:</span><br><span class="line">    #</span><br><span class="line">    AddType application/x-compress .Z</span><br><span class="line">    AddType application/x-gzip .gz .tgz</span><br><span class="line">    AddType application/x-httpd-php .php        //添加此行</span><br><span class="line">    AddType application/x-httpd-php-source .phps        //添加此行</span><br><span class="line">    </span><br><span class="line">[root@localhost ~]# sed -i &apos;/    DirectoryIndex/s/index.html/index.php index.html/g&apos; /etc/httpd24/httpd.conf</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">重启apache服务</span><br><span class="line">[root@localhost ~]# apachectl stop</span><br><span class="line">[root@localhost ~]# ss -antl</span><br><span class="line">State      Recv-Q Send-Q           Local Address:Port                          Peer Address:Port</span><br><span class="line">LISTEN     0      128                          *:22                                       *:*</span><br><span class="line">LISTEN     0      100                  127.0.0.1:25                                       *:*</span><br><span class="line">LISTEN     0      128                  127.0.0.1:9000                                     *:*</span><br><span class="line">LISTEN     0      128                         :::22                                      :::*</span><br><span class="line">LISTEN     0      100                        ::1:25                                      :::*</span><br><span class="line">LISTEN     0      80                          :::3306                                    :::*</span><br><span class="line">[root@localhost ~]# apachectl start</span><br><span class="line">[root@localhost ~]# ss -antl</span><br><span class="line">State      Recv-Q Send-Q           Local Address:Port                          Peer Address:Port</span><br><span class="line">LISTEN     0      128                          *:22                                       *:*</span><br><span class="line">LISTEN     0      100                  127.0.0.1:25                                       *:*</span><br><span class="line">LISTEN     0      128                  127.0.0.1:9000                                     *:*</span><br><span class="line">LISTEN     0      128                         :::80                                      :::*</span><br><span class="line">LISTEN     0      128                         :::22                                      :::*</span><br><span class="line">LISTEN     0      100                        ::1:25                                      :::*</span><br><span class="line">LISTEN     0      80                          :::3306                                    :::*</span><br></pre></td></tr></table></figure>

<h3 id="3-5-验证"><a href="#3-5-验证" class="headerlink" title="3.5 验证"></a>3.5 验证</h3><p>1.修改/etc/hosts文件，添加域名与IP的映射<br>2.在浏览器上使用域名访问，若看到以下界面则表示lamp架构搭建成功，否则请检查你的操作</p>
<p><img src="../../img/1557814453086.png" alt="img2"></p>

          
        
      
    </div>

    

    

    
    
    

    

    
      
    
    

    
	
	  <div>
        
      </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://aiwhs.github.io/2018/12/16/GTID主从 与 传统主从复制/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="itw">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="itw">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2018/12/16/GTID主从 与 传统主从复制/" class="post-title-link" itemprop="url">gtid主从与传统主从</a>
              
            
          </h1>
        

        <div class="post-meta">

          
          
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-12-16 08:15:57" itemprop="dateCreated datePublished" datetime="2018-12-16T08:15:57+08:00">2018-12-16</time>
            </span>
          

          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-07-17 18:00:41" itemprop="dateModified" datetime="2019-07-17T18:00:41+08:00">2019-07-17</time>
              </span>
            
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Linux运维/" itemprop="url" rel="index"><span itemprop="name">Linux运维</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          <br>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <a id="more"></a>



<h1 id="GTID主从-与-传统主从复制"><a href="#GTID主从-与-传统主从复制" class="headerlink" title="GTID主从 与 传统主从复制"></a>GTID主从 与 传统主从复制</h1><h3 id="1-主从复制"><a href="#1-主从复制" class="headerlink" title="1.主从复制"></a>1.主从复制</h3><h4 id="1-）普通主从复制："><a href="#1-）普通主从复制：" class="headerlink" title="1.）普通主从复制："></a>1.）普通主从复制：</h4><p>普通主从复制主要是基于二进制日志文件位置的复制，因此主必须启动二进制日志记录并建立唯一的服务器ID，复制组中的每个服务器都必须配置唯一的服务器ID。如果您省略server-id（或者明确地将其设置为其默认值0），则主设备将拒绝来自从设备的任何连接。 </p>
<h4 id="2-）-GTID-主从："><a href="#2-）-GTID-主从：" class="headerlink" title="2.） GTID 主从：　"></a>2.） GTID 主从：　</h4><h5 id="（1-）基本概念"><a href="#（1-）基本概念" class="headerlink" title="（1.）基本概念"></a>（1.）基本概念</h5><p>MySQL 5.6 的新特性之一，全局事务标识符（GTID）是创建的唯一标识符，并与在源（主）服务器上提交的每个事务相关联。此标识符不但是唯一的，而且在给定复制设置中的所有服务器上都是唯一的。所有交易和所有GTID之间都有一对一的映射关系 。它由服务器ID以及事务ID组合而成。这个全局事务ID不仅仅在原始服务器上唯一，在所有存在主从关系 的mysql服务器上也是唯一的。正是因为这样一个特性使得mysql的主从复制变得更加简单，以及数据库一致性更可靠。一个GTID在一个服务器上只执行一次，避免重复执行导致数据混乱或者主从不一致。</p>
<p>一个GTID被表示为一对坐标，用冒号（:）分隔，如下所示：GTID = source_id:transaction_id，source_id标识的源服务器。通常情况下，服务器 server_uuid用于这个目的。这transaction_id是一个序列号，由在此服务器上提交事务的顺序决定 .</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">3E11FA47-71CA-11E1-9E33-C80AA9429562:23</span><br></pre></td></tr></table></figure>

<p>在传统的主从复制slave端，binlog是不用开启的，但是在GTID中slave端的binlog是必须开启的，目的是记录执行过的GTID（强制）。GTID用来代替classic的复制方法，不在使用binlog+pos开启复制。而是使用master_auto_postion=1的方式自动匹配GTID断点进行复制。</p>
<p>mysql的主从复制是十分经典的一个应用，但是主从之间总会有数据一致性（data consistency ）的问题，一般情况从库会落后主库几个小时，而且在传统一主多从(mysql5.6之前)的模型中当master down掉后，我们不只是需要将一个slave提成master就可以，还要将其他slave的同步目的地从以前的master改成现在master，而且bin-log的序号和偏移量也要去查看，这是十分不方便和耗时的，但mysql5.6引入gtid之后解决了这个问题。</p>
<p>红色代表GTID，绿色代表传统主从：</p>
<p><img src="../../img/1111526-20171110095743841-1230795343.png" alt="img1"></p>
<h3 id="2-gtid的生命周期"><a href="#2-gtid的生命周期" class="headerlink" title="2.gtid的生命周期"></a>2.gtid的生命周期</h3><p><strong>gtid的生命周期对于配置和维护基于gtid的复制至关重要</strong>。所以，请尽可能理解以下几个过程。</p>
<p>gtid在master和slave上是一直<strong>持久化保存</strong>(即使删除了日志，也会记录到Previous_GTID中)的。它在master和slave上的生命周期如下：</p>
<ol>
<li>客户端发送DDL/DML给master上，master首先对此事务生成一个唯一的gtid，假如为<code>uuid_xxx:1</code>，然后立即执行该事务中的操作。</li>
</ol>
<p>注意，主从复制的情况下，sync-binlog基本上都会设置为1，这表示在每次提交事务时将缓存中的binlog刷盘。所以，在事务提交前，gtid以及事务相关操作的信息都在缓存中，提交后它们才写入到binlog file中，然后才会被dump线程dump出去。</p>
<p>换句话说，<strong>只有提交了的事务，gtid和对应的事务操作才会记录到binlog文件中。记录的格式是先记录gtid，紧跟着再记录事务相关的操作。</strong></p>
<ol start="2">
<li><p>当binlog传送到relay log中后，slave上的SQL线程首先读取该gtid，并设置变量 <em>gtid_next</em> 的值为该gtid，表示下一个要操作的事务是该gtid。 <em>gtid_next</em> <strong>是基于会话的，不同会话的gtid_next不同。</strong></p>
</li>
<li><p>随后slave检测该gtid在自己的binlog中是否存在。如果存在，则放弃此gtid事务；如果不存在，则将此gtid写入到<strong>自己的binlog中</strong>，然后立刻执行该事务，并在自己的binlog中记录该事务相关的操作。</p>
</li>
</ol>
<p>注意，<strong>slave上replay的时候，gtid不是提交后才写到自己的binlog file的，而是判断gtid不存在后立即写入binlog file。</strong></p>
<p>通过这种在执行事务前先检查并写gtid到binlog的机制，不仅可以保证当前会话在此之前没有执行过该事务，还能保证没有其他会话读取了该gtid却没有提交。因为如果其他会话读取了该gtid会立即写入到binlog(不管是否已经开始执行事务)，所以当前会话总能读取到binlog中的该gtid，于是当前会话就会放弃该事务。总之，一个gtid事务是决不允许多次执行、多个会话并行执行的。</p>
<ol start="4">
<li>slave在重放relay log中的事务时，不会自己生成gtid，所以所有的slave(无论是何种方式的一主一从或一主多从复制架构)通过重放relay log中事务获取的gtid都来源于master，并永久保存在slave上。</li>
</ol>
<h4 id="一张图说明GTID复制"><a href="#一张图说明GTID复制" class="headerlink" title="一张图说明GTID复制"></a>一张图说明GTID复制</h4><p>使用xtrabackup备份的方式提供gtid复制的基准数据。其中涉及到一些gtid检查、设置的操作。通过这些操作，大概可以感受的到gtid复制的几个概念。</p>
<p>用一张图来说明：</p>
<p><img src="../../img/733013-20180610232911355-1454041164.png" alt="img2"></p>
<p>假如当前master的gtid为A3，已经purge掉的gtid为”1–&gt;A1”，备份到slave上的数据为1-A2部分。</p>
<p>如果<code>A1 = 0</code>，表示master的binlog没有被Purge过。slave可以直接开启gtid复制，但这样可能速度较慢，因为slave要复制所有binlog。也可以将master数据备份到slave上，然后设置 <em>gtid_purged</em> 跳过备份结束时的gtid，这样速度较快。</p>
<p>如果<code>A1 != 0</code>，表示master上的binlog中删除了一部分gtid。此时slave上必须先从master处恢复purge掉的那部分日志对应的数据。上图中备份结束时的GTID为A2。然后slave开启复制，唯一需要考虑的是”是否需要设置 <em>gtid_purged</em> 跳过一部分gtid以避免重复执行”。</p>
<p>备份数据到slave上，方式可以是mysqldump、冷备份、xtrabackup备份都行。由于gtid复制的特性，所需要的操作都很少，也很简单，前提是理解了”gtid的生命周期”。</p>
<h3 id="3-基于gtid复制的好处"><a href="#3-基于gtid复制的好处" class="headerlink" title="3.基于gtid复制的好处"></a>3.基于gtid复制的好处</h3><p>从上面可以看出，gtid复制的优点大致有：</p>
<ol>
<li><strong>保证同一个事务在某slave上绝对只执行一次，没有执行过的gtid事务总是会被执行。</strong></li>
<li><strong>不用像传统复制那样保证binlog的坐标准确，因为根本不需要binlog以及坐标。</strong></li>
<li><strong>故障转移到新的master的时候很方便，简化了很多任务。</strong></li>
<li><strong>很容易判断master和slave的数据是否一致。只要master上提交的事务在slave上也提交了，那么一定是一致的。</strong></li>
</ol>
<p>当然，MySQL提供了选项可以控制跳过某些gtid事务，防止slave第一次启动复制时执行master上的所有事务而导致耗时过久。</p>
<p>虽然对于row-based和statement-based的格式都能进行gtid复制，但建议采用row-based格式。</p>
<h3 id="2-）GTID的工作原理："><a href="#2-）GTID的工作原理：" class="headerlink" title="2.）GTID的工作原理："></a>2.）GTID的工作原理：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">1、当一个事务在主库端执行并提交时，产生GTID，一同记录到binlog日志中。</span><br><span class="line">2、binlog传输到slave,并存储到slave的relaylog后，读取这个GTID的这个值设置gtid_next变量，即告诉Slave，下一个要执行的GTID值。</span><br><span class="line">3、sql线程从relay log中获取GTID，然后对比slave端的binlog是否有该GTID。</span><br><span class="line">4、如果有记录，说明该GTID的事务已经执行，slave会忽略。</span><br><span class="line">5、如果没有记录，slave就会执行该GTID事务，并记录该GTID到自身的binlog，在读取执行事务前会先检查其他session持有该GTID，确保不被重复执行。</span><br><span class="line">6、在解析过程中会判断是否有主键，如果有就用二级索引，如果没有就用全部扫描。</span><br></pre></td></tr></table></figure>

<h2 id="4-MySQL基于GTID主从复制实战"><a href="#4-MySQL基于GTID主从复制实战" class="headerlink" title="4.MySQL基于GTID主从复制实战"></a>4.MySQL基于GTID主从复制实战</h2><h3 id="4-1-前提条件"><a href="#4-1-前提条件" class="headerlink" title="4.1 前提条件"></a>4.1 前提条件</h3><ol>
<li>准备 3 台服务器</li>
<li>安装 MySQL 并且运行状态正常，MySQL 安装参考</li>
<li>两台服务器配置时间同步</li>
<li>关闭 SELINUX</li>
<li>防火墙放行 3306 端口</li>
</ol>
<h3 id="4-2-配置一主一从的-GTID-复制"><a href="#4-2-配置一主一从的-GTID-复制" class="headerlink" title="4.2 配置一主一从的 GTID 复制"></a>4.2 配置一主一从的 GTID 复制</h3><h4 id="4-2-1-环境说明"><a href="#4-2-1-环境说明" class="headerlink" title="4.2.1 环境说明"></a>4.2.1 环境说明</h4><p><img src="../../img/2019-05-17_150444.png" alt></p>
<h4 id="4-2-2-修改-master-配置文件"><a href="#4-2-2-修改-master-配置文件" class="headerlink" title="4.2.2 修改 master 配置文件"></a>4.2.2 修改 master 配置文件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@ip-10-0-100-31 ~]# vim /etc/my.cnf</span><br><span class="line"># mysql GTID</span><br><span class="line">log-bin=/var/lib/mysql/mysql-bin # 必须项,这里目录属主和组必须是mysql</span><br><span class="line">binlog_format=row # 建议项</span><br><span class="line">sync-binlog=1 # 建议项</span><br><span class="line">server-id=101 # 必须项</span><br><span class="line">master_info_repository=table # 建议项</span><br><span class="line">relay_log_info_repository=table # 建议项</span><br><span class="line">enforce_gtid_consistency=on # gtid复制需要加上的必须项</span><br><span class="line">gtid_mode=on # gtid复制需要加上的必须项</span><br></pre></td></tr></table></figure>

<p>修改配置文件后重启 MySQL</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@ip-10-0-100-31 ~]# service mysqld restart</span><br></pre></td></tr></table></figure>

<h4 id="4-2-3-修改-slave-配置文件"><a href="#4-2-3-修改-slave-配置文件" class="headerlink" title="4.2.3 修改 slave 配置文件"></a>4.2.3 修改 slave 配置文件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@ip-10-0-100-134 ~]# vim /etc/my.cnf </span><br><span class="line"># mysql GTID</span><br><span class="line">log-bin=/var/lib/mysql/slave-bin # mysql 5.6必须项，mysql 5.7非必须项</span><br><span class="line">binlog_format=row # 建议项</span><br><span class="line">relay-log=/var/lib/mysql/relay-bin # 必须项</span><br><span class="line">sync-binlog=1 # 建议项</span><br><span class="line">server-id=182 # 必须项</span><br><span class="line">master_info_repository=table # 建议项 </span><br><span class="line">relay_log_info_repository=table # 建议项 </span><br><span class="line">enforce_gtid_consistency=on # gtid复制需要加上的必须项</span><br><span class="line">gtid_mode=on # gtid复制需要加上的必须项</span><br></pre></td></tr></table></figure>

<p>修改配置文件后重启 MySQL</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@ip-10-0-100-134 ~]# service mysqld restart</span><br></pre></td></tr></table></figure>

<h4 id="4-2-4-master-上创建复制用户"><a href="#4-2-4-master-上创建复制用户" class="headerlink" title="4.2.4 master 上创建复制用户"></a>4.2.4 master 上创建复制用户</h4><p>在 master 上执行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; create user &apos;whs&apos;@&apos;10.0.100.%&apos; identified by &apos;itwhs123!&apos;;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; grant replication slave on *.* to &apos;whs&apos;@&apos;10.0.100.%&apos;;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; flush privileges;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure>

<h4 id="4-2-5-slave-启用复制线程"><a href="#4-2-5-slave-启用复制线程" class="headerlink" title="4.2.5 slave 启用复制线程"></a>4.2.5 slave 启用复制线程</h4><p>因为全新实例 master 上的 binlog 没有删除过，所以在 slave 上直接change master to 配置连接参数。</p>
<p>在 slave 上执行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; CHANGE MASTER TO MASTER_HOST=&apos;10.0.100.31&apos;,MASTER_PORT=3306,MASTER_AUTO_POSITION=1;</span><br><span class="line">Query OK, 0 rows affected (0.03 sec)</span><br></pre></td></tr></table></figure>

<p>因为是 MySQL 5.7，没有在 change master to 语句中加入 user 和 password 项，而是在 start slave 语句中使用，否则会警告。</p>
<p>现在启动 slave 上的两个复制线程:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; START SLAVE USER=&apos;whs&apos; PASSWORD=&apos;itwhs123!&apos;;</span><br><span class="line">Query OK, 0 rows affected, 1 warning (0.00 sec)</span><br></pre></td></tr></table></figure>

<h4 id="4-2-6-验证-GTID-复制是否生效"><a href="#4-2-6-验证-GTID-复制是否生效" class="headerlink" title="4.2.6 验证 GTID 复制是否生效"></a>4.2.6 验证 GTID 复制是否生效</h4><p>查看 io 线程和 sql 线程是否正常。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show processlist;</span><br><span class="line">+----+-------------+-----------+------+---------+------+--------------------------------------------------------+------------------+</span><br><span class="line">| Id | User        | Host      | db   | Command | Time | State                                                  | Info             |</span><br><span class="line">+----+-------------+-----------+------+---------+------+--------------------------------------------------------+------------------+</span><br><span class="line">|  2 | root        | localhost | NULL | Query   |    0 | starting                                               | show processlist |</span><br><span class="line">|  3 | system user |           | NULL | Connect |   29 | Waiting for master to send event                       | NULL             |</span><br><span class="line">|  4 | system user |           | NULL | Connect |  168 | Slave has read all relay log; waiting for more updates | NULL             |</span><br><span class="line">+----+-------------+-----------+------+---------+------+--------------------------------------------------------+------------------+</span><br><span class="line">3 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>在 master 上新增一些测试数据：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">DROP DATABASE IF EXISTS backuptest;</span><br><span class="line">CREATE DATABASE backuptest;</span><br><span class="line">USE backuptest;</span><br><span class="line"></span><br><span class="line"># 创建myisam类型的数值辅助表和插入数据的存储过程</span><br><span class="line">CREATE TABLE num_isam (n INT NOT NULL PRIMARY KEY) ENGINE = MYISAM ;</span><br><span class="line"></span><br><span class="line">DROP PROCEDURE IF EXISTS proc_num1;</span><br><span class="line">DELIMITER $$</span><br><span class="line">CREATE PROCEDURE proc_num1 (num INT) </span><br><span class="line">BEGIN</span><br><span class="line">    DECLARE rn INT DEFAULT 1 ;</span><br><span class="line">    TRUNCATE TABLE backuptest.num_isam ;</span><br><span class="line">    INSERT INTO backuptest.num_isam VALUES(1) ;</span><br><span class="line">    dd: WHILE rn * 2 &lt; num DO </span><br><span class="line">        BEGIN</span><br><span class="line">            INSERT INTO backuptest.num_isam </span><br><span class="line">            SELECT rn + n FROM backuptest.num_isam;</span><br><span class="line">            SET rn = rn * 2 ;</span><br><span class="line">        END ;</span><br><span class="line">    END WHILE dd;</span><br><span class="line">    INSERT INTO backuptest.num_isam </span><br><span class="line">    SELECT n + rn </span><br><span class="line">    FROM backuptest.num_isam </span><br><span class="line">    WHERE n + rn &lt;= num;</span><br><span class="line">END ;</span><br><span class="line">$$</span><br><span class="line">DELIMITER ;</span><br><span class="line"></span><br><span class="line"># 创建innodb类型的数值辅助表和插入数据的存储过程</span><br><span class="line">CREATE TABLE num_innodb (n INT NOT NULL PRIMARY KEY) ENGINE = INNODB ;</span><br><span class="line"></span><br><span class="line">DROP PROCEDURE IF EXISTS proc_num2;</span><br><span class="line">DELIMITER $$</span><br><span class="line">CREATE PROCEDURE proc_num2 (num INT) </span><br><span class="line">BEGIN</span><br><span class="line">    DECLARE rn INT DEFAULT 1 ;</span><br><span class="line">    TRUNCATE TABLE backuptest.num_innodb ;</span><br><span class="line">    INSERT INTO backuptest.num_innodb VALUES(1) ;</span><br><span class="line">    dd: WHILE rn * 2 &lt; num DO </span><br><span class="line">        BEGIN</span><br><span class="line">            INSERT INTO backuptest.num_innodb </span><br><span class="line">            SELECT rn + n FROM backuptest.num_innodb;</span><br><span class="line">            SET rn = rn * 2 ;</span><br><span class="line">        END ;</span><br><span class="line">    END WHILE dd;</span><br><span class="line">    INSERT INTO backuptest.num_innodb </span><br><span class="line">    SELECT n + rn </span><br><span class="line">    FROM backuptest.num_innodb </span><br><span class="line">    WHERE n + rn &lt;= num ;</span><br><span class="line">END ;</span><br><span class="line">$$</span><br><span class="line">DELIMITER ;</span><br><span class="line"></span><br><span class="line"># 分别向两个数值辅助表中插入100W条数据</span><br><span class="line">CALL proc_num1 (1000000) ;</span><br><span class="line">CALL proc_num2 (1000000) ;</span><br></pre></td></tr></table></figure>

<p>在 slave 上查看 slave 的状态，以下是同步结束后的状态信息：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show slave status\G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">               Slave_IO_State: Waiting for master to send event</span><br><span class="line">                  Master_Host: 10.0.100.31</span><br><span class="line">                  Master_User: whs</span><br><span class="line">                  Master_Port: 3306</span><br><span class="line">                Connect_Retry: 60</span><br><span class="line">              Master_Log_File: mysql-bin.000003</span><br><span class="line">          Read_Master_Log_Pos: 10058377</span><br><span class="line">               Relay_Log_File: relay-bin.000002</span><br><span class="line">                Relay_Log_Pos: 10058590</span><br><span class="line">        Relay_Master_Log_File: mysql-bin.000003</span><br><span class="line">             Slave_IO_Running: Yes</span><br><span class="line">            Slave_SQL_Running: Yes</span><br><span class="line">              Replicate_Do_DB: </span><br><span class="line">          Replicate_Ignore_DB: </span><br><span class="line">           Replicate_Do_Table: </span><br><span class="line">       Replicate_Ignore_Table: </span><br><span class="line">      Replicate_Wild_Do_Table: </span><br><span class="line">  Replicate_Wild_Ignore_Table: </span><br><span class="line">                   Last_Errno: 0</span><br><span class="line">                   Last_Error: </span><br><span class="line">                 Skip_Counter: 0</span><br><span class="line">          Exec_Master_Log_Pos: 10058377</span><br><span class="line">              Relay_Log_Space: 10058791</span><br><span class="line">              Until_Condition: None</span><br><span class="line">               Until_Log_File: </span><br><span class="line">                Until_Log_Pos: 0</span><br><span class="line">           Master_SSL_Allowed: No</span><br><span class="line">           Master_SSL_CA_File: </span><br><span class="line">           Master_SSL_CA_Path: </span><br><span class="line">              Master_SSL_Cert: </span><br><span class="line">            Master_SSL_Cipher: </span><br><span class="line">               Master_SSL_Key: </span><br><span class="line">        Seconds_Behind_Master: 0</span><br><span class="line">Master_SSL_Verify_Server_Cert: No</span><br><span class="line">                Last_IO_Errno: 0</span><br><span class="line">                Last_IO_Error: </span><br><span class="line">               Last_SQL_Errno: 0</span><br><span class="line">               Last_SQL_Error: </span><br><span class="line">  Replicate_Ignore_Server_Ids: </span><br><span class="line">             Master_Server_Id: 101</span><br><span class="line">                  Master_UUID: aece386a-7877-11e9-959a-0a6df75fd3e6</span><br><span class="line">             Master_Info_File: mysql.slave_master_info</span><br><span class="line">                    SQL_Delay: 0</span><br><span class="line">          SQL_Remaining_Delay: NULL</span><br><span class="line">      Slave_SQL_Running_State: Slave has read all relay log; waiting for more updates</span><br><span class="line">           Master_Retry_Count: 86400</span><br><span class="line">                  Master_Bind: </span><br><span class="line">      Last_IO_Error_Timestamp: </span><br><span class="line">     Last_SQL_Error_Timestamp: </span><br><span class="line">               Master_SSL_Crl: </span><br><span class="line">           Master_SSL_Crlpath: </span><br><span class="line">           Retrieved_Gtid_Set: aece386a-7877-11e9-959a-0a6df75fd3e6:1-55</span><br><span class="line">            Executed_Gtid_Set: aece386a-7877-11e9-959a-0a6df75fd3e6:1-55</span><br><span class="line">                Auto_Position: 1</span><br><span class="line">         Replicate_Rewrite_DB: </span><br><span class="line">                 Channel_Name: </span><br><span class="line">           Master_TLS_Version: </span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>至此处一主已从基础 GTID 复制就完成了。</p>
<h3 id="4-3-添加新的-slave-到-GTID-复制集群中"><a href="#4-3-添加新的-slave-到-GTID-复制集群中" class="headerlink" title="4.3 添加新的 slave 到 GTID 复制集群中"></a>4.3 添加新的 slave 到 GTID 复制集群中</h3><p>上面的实验是基于全新的实例，生产环境中往往 master 数据库已经运行了很久，并且 binlog 可能会定期删除掉一部分，所以，为了配置更通用的 gtid 复制环境，这里把刚才的 master 的 binlog 给 purge 掉一部分。模拟实际环境中定期删除了一部分 binlog 的场景。</p>
<p>目前 master 上的 binlog 使用情况如下，不难发现绝大多数操作都集中在mysql-bin.000001 这个 binlog 中。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@ip-10-0-100-31 ~]# ll /var/lib/mysql/*bin*</span><br><span class="line">-rw-r-----. 1 mysql mysql      177 May 17 08:17 /var/lib/mysql/mysql-bin.000001</span><br><span class="line">-rw-r-----. 1 mysql mysql      177 May 17 08:18 /var/lib/mysql/mysql-bin.000002</span><br><span class="line">-rw-r-----. 1 mysql mysql 10058377 May 17 08:50 /var/lib/mysql/mysql-bin.000003</span><br><span class="line">-rw-r-----. 1 mysql mysql       96 May 17 08:18 /var/lib/mysql/mysql-bin.index</span><br></pre></td></tr></table></figure>

<p>purge 已有的 binlog:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; flush logs;</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; purge master logs to &apos;mysql/mysql-bin.000003&apos;;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>查看当前使用的 binlog</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@ip-10-0-100-31 ~]# cat /var/lib/mysql/mysql-bin.index</span><br><span class="line">/var/lib/mysql/mysql-bin.000003</span><br><span class="line">/var/lib/mysql/mysql-bin.000004</span><br></pre></td></tr></table></figure>

<h4 id="4-3-1-当前环境说明"><a href="#4-3-1-当前环境说明" class="headerlink" title="4.3.1 当前环境说明"></a>4.3.1 当前环境说明</h4><p><img src="../../img/2019-05-17_151306.png" alt></p>
<h4 id="4-3-2-修改-slave2-节点配置文件"><a href="#4-3-2-修改-slave2-节点配置文件" class="headerlink" title="4.3.2 修改 slave2 节点配置文件"></a>4.3.2 修改 slave2 节点配置文件</h4><p>其中 slave2 节点的配置文件和 slave1 的配置文件完全相同：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@ip-10-0-100-143 ~]# vim /etc/my.cnf </span><br><span class="line"># mysql GTID</span><br><span class="line">log-bin=/var/lib/mysql/slave-bin # mysql 5.6必须项，mysql 5.7非必须项</span><br><span class="line">binlog_format=row # 建议项</span><br><span class="line">relay-log=/var/lib/mysql/relay-bin # 必须项</span><br><span class="line">sync-binlog=1 # 建议项</span><br><span class="line">server-id=183 # 必须项</span><br><span class="line">master_info_repository=table # 建议项 </span><br><span class="line">relay_log_info_repository=table # 建议项 </span><br><span class="line">enforce_gtid_consistency=on # gtid复制需要加上的必须项</span><br><span class="line">gtid_mode=on # gtid复制需要加上的必须项</span><br></pre></td></tr></table></figure>

<h4 id="4-3-3-备份-master-节点数据"><a href="#4-3-3-备份-master-节点数据" class="headerlink" title="4.3.3 备份 master 节点数据"></a>4.3.3 备份 master 节点数据</h4><p>我这里没有安装 xtrabackup 的 innobackupex 工具，所以使用 mysqldump。</p>
<p>在 master 节点执行：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@ip-10-0-100-31 ~]# mysqldump -uroot -pjbgsn123! -R --triggers --master-data=2 --single-transaction --set-gtid-purged=OFF --all-databases &gt; all.sql</span><br><span class="line">mysqldump: [Warning] Using a password on the command line interface can be insecure.</span><br></pre></td></tr></table></figure>

<p>将数据复制到 slave2 节点</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@ip-10-0-100-31 ~]# mv all.sql /nfs/</span><br></pre></td></tr></table></figure>

<h4 id="4-3-4-将备份恢复到-slave2"><a href="#4-3-4-将备份恢复到-slave2" class="headerlink" title="4.3.4 将备份恢复到 slave2"></a>4.3.4 将备份恢复到 slave2</h4><p>在 slave 2上执行：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@ip-10-0-100-143 ~]# mysql -uroot -pjbgsn123! &lt;/nfs/all.sql </span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br></pre></td></tr></table></figure>

<h4 id="4-3-5-在-master-查看已经执行过的事务"><a href="#4-3-5-在-master-查看已经执行过的事务" class="headerlink" title="4.3.5 在 master 查看已经执行过的事务"></a>4.3.5 在 master 查看已经执行过的事务</h4><p>查看已经执行过的事务，这部分是不需要再 slave2 上执行了，因为已经都恢复数据过去了。</p>
<p>在 master 上直接查看 gtid_executed 的值，注意不是 gtid_purged 的值，master 上的 gtid_purged 表示的是曾经删除掉的 binlog。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show global variables like &apos;%gtid%&apos;;</span><br><span class="line">+----------------------------------+-------------------------------------------+</span><br><span class="line">| Variable_name                    | Value                                     |</span><br><span class="line">+----------------------------------+-------------------------------------------+</span><br><span class="line">| binlog_gtid_simple_recovery      | ON                                        |</span><br><span class="line">| enforce_gtid_consistency         | ON                                        |</span><br><span class="line">| gtid_executed                    | aece386a-7877-11e9-959a-0a6df75fd3e6:1-55 |</span><br><span class="line">| gtid_executed_compression_period | 1000                                      |</span><br><span class="line">| gtid_mode                        | ON                                        |</span><br><span class="line">| gtid_owned                       |                                           |</span><br><span class="line">| gtid_purged                      |                                           |</span><br><span class="line">| session_track_gtids              | OFF                                       |</span><br><span class="line">+----------------------------------+-------------------------------------------+</span><br><span class="line">8 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<h4 id="4-3-6-启用-slave2-上的复制线程"><a href="#4-3-6-启用-slave2-上的复制线程" class="headerlink" title="4.3.6 启用 slave2 上的复制线程"></a>4.3.6 启用 slave2 上的复制线程</h4><p>可以在启动 slave2 线程之前使用 gtid_purged 变量来指定需要跳过的 gtid 集合。但因为要设置 gtid_purged 必须保证全局变量 gtid_executed为空，所以先在 slave2 上执行 reset master(注意，不是 reset slave)，再设置 gtid_purged。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; reset master;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; set @@global.gtid_purged=&apos;aece386a-7877-11e9-959a-0a6df75fd3e6:1-55&apos;;</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br></pre></td></tr></table></figure>

<p>设置好 gtid_purged 之后，就可以开启复制线程了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; CHANGE MASTER TO MASTER_HOST=&apos;10.0.100.31&apos;,MASTER_PORT=3306,MASTER_AUTO_POSITION=1;</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; START SLAVE USER=&apos;whs&apos; PASSWORD=&apos;itwhs123!&apos;;</span><br><span class="line">Query OK, 0 rows affected, 1 warning (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>查看 slave2 的状态，看是否正确启动了复制功能。如果没错，再在 master 上修改一部分数据，检查是否同步到 slave1和 slave2。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show slave status\G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">               Slave_IO_State: Waiting for master to send event</span><br><span class="line">                  Master_Host: 10.0.100.31</span><br><span class="line">                  Master_User: whs</span><br><span class="line">                  Master_Port: 3306</span><br><span class="line">                Connect_Retry: 60</span><br><span class="line">              Master_Log_File: mysql-bin.000004</span><br><span class="line">          Read_Master_Log_Pos: 194</span><br><span class="line">               Relay_Log_File: relay-bin.000002</span><br><span class="line">                Relay_Log_Pos: 367</span><br><span class="line">        Relay_Master_Log_File: mysql-bin.000004</span><br><span class="line">             Slave_IO_Running: Yes</span><br><span class="line">            Slave_SQL_Running: Yes</span><br><span class="line">              Replicate_Do_DB: </span><br><span class="line">          Replicate_Ignore_DB: </span><br><span class="line">           Replicate_Do_Table: </span><br><span class="line">       Replicate_Ignore_Table: </span><br><span class="line">      Replicate_Wild_Do_Table: </span><br><span class="line">  Replicate_Wild_Ignore_Table: </span><br><span class="line">                   Last_Errno: 0</span><br><span class="line">                   Last_Error: </span><br><span class="line">                 Skip_Counter: 0</span><br><span class="line">          Exec_Master_Log_Pos: 194</span><br><span class="line">              Relay_Log_Space: 568</span><br><span class="line">              Until_Condition: None</span><br><span class="line">               Until_Log_File: </span><br><span class="line">                Until_Log_Pos: 0</span><br><span class="line">           Master_SSL_Allowed: No</span><br><span class="line">           Master_SSL_CA_File: </span><br><span class="line">           Master_SSL_CA_Path: </span><br><span class="line">              Master_SSL_Cert: </span><br><span class="line">            Master_SSL_Cipher: </span><br><span class="line">               Master_SSL_Key: </span><br><span class="line">        Seconds_Behind_Master: 0</span><br><span class="line">Master_SSL_Verify_Server_Cert: No</span><br><span class="line">                Last_IO_Errno: 0</span><br><span class="line">                Last_IO_Error: </span><br><span class="line">               Last_SQL_Errno: 0</span><br><span class="line">               Last_SQL_Error: </span><br><span class="line">  Replicate_Ignore_Server_Ids: </span><br><span class="line">             Master_Server_Id: 101</span><br><span class="line">                  Master_UUID: aece386a-7877-11e9-959a-0a6df75fd3e6</span><br><span class="line">             Master_Info_File: mysql.slave_master_info</span><br><span class="line">                    SQL_Delay: 0</span><br><span class="line">          SQL_Remaining_Delay: NULL</span><br><span class="line">      Slave_SQL_Running_State: Slave has read all relay log; waiting for more updates</span><br><span class="line">           Master_Retry_Count: 86400</span><br><span class="line">                  Master_Bind: </span><br><span class="line">      Last_IO_Error_Timestamp: </span><br><span class="line">     Last_SQL_Error_Timestamp: </span><br><span class="line">               Master_SSL_Crl: </span><br><span class="line">           Master_SSL_Crlpath: </span><br><span class="line">           Retrieved_Gtid_Set: </span><br><span class="line">            Executed_Gtid_Set: aece386a-7877-11e9-959a-0a6df75fd3e6:1-55</span><br><span class="line">                Auto_Position: 1</span><br><span class="line">         Replicate_Rewrite_DB: </span><br><span class="line">                 Channel_Name: </span><br><span class="line">           Master_TLS_Version: </span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>在 master 上创建一个测试数据库 mydb 检查 slave1 和 slave2 节点能否同步。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; create database mydb;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>slave1 节点查看</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show databases;</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| backuptest         |</span><br><span class="line">| mydb               |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| sys                |</span><br><span class="line">+--------------------+</span><br><span class="line">6 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>slave1节点验证数据同步</p>
<p>slave2 节点查看</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show databases;</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| backuptest         |</span><br><span class="line">| mydb               |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| sys                |</span><br><span class="line">+--------------------+</span><br><span class="line">6 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>slave2节点验证数据同步</p>
<h4 id="4-3-7-回到-master，purge-掉已同步的-binlog"><a href="#4-3-7-回到-master，purge-掉已同步的-binlog" class="headerlink" title="4.3.7 回到 master，purge 掉已同步的 binlog"></a>4.3.7 回到 master，purge 掉已同步的 binlog</h4><p>当 slave 指定 gtid_purged 并实现了同步之后，为了下次重启 mysqld 实例不用再次设置 gtid_purged(甚至可能会在启动的时候自动开启复制线程)，所以应该去 master 上将已经同步的 binlog 给 purged 掉。</p>
<p>在 master 上执行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; flush logs;</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; purge master logs to &apos;mysql-bin.000005&apos;;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; show global variables like &apos;%gtid%&apos;;</span><br><span class="line">+----------------------------------+-------------------------------------------+</span><br><span class="line">| Variable_name                    | Value                                     |</span><br><span class="line">+----------------------------------+-------------------------------------------+</span><br><span class="line">| binlog_gtid_simple_recovery      | ON                                        |</span><br><span class="line">| enforce_gtid_consistency         | ON                                        |</span><br><span class="line">| gtid_executed                    | aece386a-7877-11e9-959a-0a6df75fd3e6:1-56 |</span><br><span class="line">| gtid_executed_compression_period | 1000                                      |</span><br><span class="line">| gtid_mode                        | ON                                        |</span><br><span class="line">| gtid_owned                       |                                           |</span><br><span class="line">| gtid_purged                      | aece386a-7877-11e9-959a-0a6df75fd3e6:1-56 |</span><br><span class="line">| session_track_gtids              | OFF                                       |</span><br><span class="line">+----------------------------------+-------------------------------------------+</span><br><span class="line">8 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<h3 id="4-4-GTID-复制相关的状态信息和变量"><a href="#4-4-GTID-复制相关的状态信息和变量" class="headerlink" title="4.4 GTID 复制相关的状态信息和变量"></a>4.4 GTID 复制相关的状态信息和变量</h3><h4 id="4-4-1-show-slave-status-中和-gtid-复制相关的状态行"><a href="#4-4-1-show-slave-status-中和-gtid-复制相关的状态行" class="headerlink" title="4.4.1 show slave status 中和 gtid 复制相关的状态行"></a>4.4.1 show slave status 中和 gtid 复制相关的状态行</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Retrieved_Gtid_Set: aece386a-7877-11e9-959a-0a6df75fd3e6:56</span><br><span class="line">Executed_Gtid_Set: aece386a-7877-11e9-959a-0a6df75fd3e6:1-56</span><br><span class="line">Auto_Position: 1</span><br></pre></td></tr></table></figure>

<ul>
<li>Retrieved_Gtid_Set：在开启了 gtid 复制(即 gtid_mode=on)时，slave 在启动 io 线程的时候会检查自己的 relay log，并从中检索出gtid 集合。也就是说，这代表的是 slave 已经从 master 中复制了哪些事务过来。检索出来的 gtid 不会再请求 master 发送过来。</li>
<li>Executed_Gtid_Set：在开启了 gtid 复制(即 gtid_mode=on)时，它表示已经向自己的 binlog 中写入了哪些 gtid 集合。注意，这个值是根据一些状态信息计算出来的，并非 binlog 中能看到的那些。举个特殊一点的例子，可能 slave 的 binlog 还是空的，但这里已经显示一些已执行 gtid 集合了。</li>
<li>Auto_Position：开启 gtid 时是否自动获取 binlog 坐标。1 表示开启，这是 gtid 复制的默认值。</li>
</ul>
<h4 id="4-4-2-一些重要的变量"><a href="#4-4-2-一些重要的变量" class="headerlink" title="4.4.2 一些重要的变量"></a>4.4.2 一些重要的变量</h4><ul>
<li>gtid_mode：是否开启gtid复制模式。只允许on/off类的布尔值，不允许其他类型(如1/0)的布尔值，实际上这个变量是枚举类型的。要设置 gtid_mode=on ，必须同时设置 enforce_gtid_consistency 开。在MySQL 5.6中，还必须开启 log_slave_updates ，即使是master也要开启。</li>
<li>enforce_gtid_consistency：强制要求只允许复制事务安全的事务。 gtid_mode=on 时必须显式设置该项，如果不给定值，则默认为 on。应该尽量将该选项放在 gtid_mode 的前面，减少启动 mysqld 时的检查。</li>
<li>不能在事务内部创建和删除临时表。只能在事务外部进行，且 autocommit 需要设置为 1。</li>
<li>不能执行 create table … select 语句。该语句除了创建一张新表并填充一些数据，其他什么事也没干。</li>
<li>不能在事务内既更新事务表又更新非事务表。</li>
<li>gtid_executed：已经执行过的 GTID。 reset master 会清空该项的全局变量值。</li>
<li>gtid_purged：已经 purge 掉的 gtid。要设置该项，必须先保证gtid_executed 已经为空，这意味着也一定会同时设置该项为空。在 slave 上设置该项时，表示稍后启动 io 线程和 SQL 线程都跳过这些 gtid，slave 上设置时应该让此项的 gtid 集合等于 master上 gtid_executed 的值。</li>
<li>gtid_next：表示下一个要执行的gtid事务。</li>
</ul>
<p>需要注意，master和slave上都有gtid_executed和gtid_purged，它们代表的意义有时候是不同的。</p>

          
        
      
    </div>

    

    

    
    
    

    

    
      
    
    

    
	
	  <div>
        
      </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://aiwhs.github.io/2018/12/15/mysql中间件proxysql实现mysql读写分离/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="itw">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="itw">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2018/12/15/mysql中间件proxysql实现mysql读写分离/" class="post-title-link" itemprop="url">proxysql中间件</a>
              
            
          </h1>
        

        <div class="post-meta">

          
          
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-12-15 08:15:57" itemprop="dateCreated datePublished" datetime="2018-12-15T08:15:57+08:00">2018-12-15</time>
            </span>
          

          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-07-17 16:20:00" itemprop="dateModified" datetime="2019-07-17T16:20:00+08:00">2019-07-17</time>
              </span>
            
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Linux运维/" itemprop="url" rel="index"><span itemprop="name">Linux运维</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          <br>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <a id="more"></a>

<h2 id="1-mysql实现读写分离的方式"><a href="#1-mysql实现读写分离的方式" class="headerlink" title="1. mysql实现读写分离的方式"></a>1. mysql实现读写分离的方式</h2><p>mysql 实现读写分离的方式有以下几种：</p>
<ul>
<li>程序修改mysql操作，直接和数据库通信，简单快捷的读写分离和随机的方式实现的负载均衡，权限独立分配，需要开发人员协助。</li>
<li>amoeba，直接实现读写分离和负载均衡，不用修改代码，有很灵活的数据解决方案，自己分配账户，和后端数据库权限管理独立，权限处理不够灵活。</li>
<li>mysql-proxy，直接实现读写分离和负载均衡，不用修改代码，master和slave用一样的帐号，效率低</li>
<li>mycat中间件</li>
<li>proxysql中间件（推荐使用）</li>
</ul>
<h2 id="2-ProxySQL简介"><a href="#2-ProxySQL简介" class="headerlink" title="2. ProxySQL简介"></a>2. ProxySQL简介</h2><p>ProxySQL 是一款可以实际用于生产环境的 MySQL 中间件，它有官方版和 percona 版两种。percona版是在官方版的基础上修改的，添加了几个比较实用的工具。生产环境建议用官方版。</p>
<p>ProxySQL 是用 C++ 语言开发的，虽然也是一个轻量级产品，但性能很好(据测试，能处理千亿级的数据)，功能也足够，能满足中间件所需的绝大多数功能，包括：</p>
<ul>
<li>最基本的读/写分离，且方式有多种</li>
<li>可定制基于用户、基于schema、基于语句的规则对SQL语句进行路由。换句话说，规则很灵活。基于schema和与语句级的规则，可以实现简单的sharding(分库分表)</li>
<li>可缓存查询结果。虽然ProxySQL的缓存策略比较简陋，但实现了基本的缓存功能，绝大多数时候也够用了。此外，作者已经打算实现更丰富的缓存策略</li>
<li>监控后端节点。ProxySQL可以监控后端节点的多个指标，包括：ProxySQL和后端的心跳信息，后端节点的read-only/read-write，slave和master的数据同步延迟性(replication lag)</li>
</ul>
<h2 id="3-ProxySQL安装"><a href="#3-ProxySQL安装" class="headerlink" title="3. ProxySQL安装"></a>3. ProxySQL安装</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">//配置yum源</span><br><span class="line">[root@proxysql ~]# cat &lt;&lt;EOF | tee /etc/yum.repos.d/proxysql.repo</span><br><span class="line">[proxysql_repo]</span><br><span class="line">name= ProxySQL</span><br><span class="line">baseurl=http://repo.proxysql.com/ProxySQL/proxysql-1.4.x/centos/7</span><br><span class="line">gpgcheck=1</span><br><span class="line">gpgkey=http://repo.proxysql.com/ProxySQL/repo_pub_key</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">[root@proxysql ~]# yum -y install proxysql</span><br></pre></td></tr></table></figure>

<h2 id="4-ProxySQL的Admin管理接口"><a href="#4-ProxySQL的Admin管理接口" class="headerlink" title="4. ProxySQL的Admin管理接口"></a>4. ProxySQL的Admin管理接口</h2><p>当 ProxySQL 启动后，将监听两个端口：</p>
<ul>
<li>admin管理接口，默认端口为6032。该端口用于查看、配置ProxySQL</li>
<li>接收SQL语句的接口，默认端口为6033，这个接口类似于MySQL的3306端口</li>
</ul>
<p><img src="../../img/proxysql_admin.png" alt="img"></p>
<p>ProxySQL 的 admin 管理接口是一个使用 MySQL 协议的接口，所以，可以直接使用 mysql 客户端、navicat 等工具去连接这个管理接口，其默认的用户名和密码均为 admin</p>
<p>例如，使用 mysql 客户端去连接 ProxySQL 的管理接口：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@proxysql ~]# mysql -uadmin -padmin -h127.0.0.1 -P6032</span><br><span class="line">Welcome to the MariaDB monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 6</span><br><span class="line">Server version: 5.5.30 (ProxySQL Admin Module)</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.</span><br><span class="line"></span><br><span class="line">Type &apos;help;&apos; or &apos;\h&apos; for help. Type &apos;\c&apos; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">MySQL [(none)]&gt; show databases;</span><br><span class="line">+-----+---------------+-------------------------------------+</span><br><span class="line">| seq | name          | file                                |</span><br><span class="line">+-----+---------------+-------------------------------------+</span><br><span class="line">| 0   | main          |                                     |</span><br><span class="line">| 2   | disk          | /var/lib/proxysql/proxysql.db       |</span><br><span class="line">| 3   | stats         |                                     |</span><br><span class="line">| 4   | monitor       |                                     |</span><br><span class="line">| 5   | stats_history | /var/lib/proxysql/proxysql_stats.db |</span><br><span class="line">+-----+---------------+-------------------------------------+</span><br><span class="line">5 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>由于 ProxySQL 的配置全部保存在几个自带的库中，所以通过管理接口，可以非常方便地通过发送一些SQL命令去修改 ProxySQL 的配置。 ProxySQL 会解析通过该接口发送的某些对ProxySQL 有效的特定命令，并将其合理转换后发送给内嵌的 SQLite3 数据库引擎去运行</p>
<p>ProxySQL 的配置几乎都是通过管理接口来操作的，通过 Admin 管理接口，可以在线修改几乎所有的配置并使其生效。只有两个变量的配置是必须重启 ProxySQL 才能生效的，它们是：<br><strong>mysql-threads 和 mysql-stacksize</strong></p>
<h2 id="5-和admin管理接口相关的变量"><a href="#5-和admin管理接口相关的变量" class="headerlink" title="5. 和admin管理接口相关的变量"></a>5. 和admin管理接口相关的变量</h2><h3 id="5-1-admin-admin-credentials"><a href="#5-1-admin-admin-credentials" class="headerlink" title="5.1 admin-admin_credentials"></a>5.1 admin-admin_credentials</h3><p>admin-admin_credentials 变量控制的是admin管理接口的管理员账户。默认的管理员账户和密码为admin:admin，但是这个默认的用户只能在本地使用。如果想要远程连接到ProxySQL，例如用windows上的navicat连接Linux上的ProxySQL管理接口，必须自定义一个管理员账户。</p>
<p><strong>添加管理员帐户</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">MySQL [(none)]&gt; select @@admin-admin_credentials;       //查看当前用户名和密码</span><br><span class="line">+---------------------------+</span><br><span class="line">| @@admin-admin_credentials |</span><br><span class="line">+---------------------------+</span><br><span class="line">| admin:admin               |</span><br><span class="line">+---------------------------+</span><br><span class="line">1 row in set (0.01 sec)</span><br><span class="line"></span><br><span class="line">//设置管理员帐号myadmin,密码wangqing123!</span><br><span class="line">MySQL [(none)]&gt; set admin-admin_credentials=&apos;admin:admin;myadmin:wangqing123!&apos;;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)]&gt; select @@admin-admin_credentials;</span><br><span class="line">+----------------------------------+</span><br><span class="line">| @@admin-admin_credentials        |</span><br><span class="line">+----------------------------------+</span><br><span class="line">| admin:admin;runtime:wangqing123! |</span><br><span class="line">+----------------------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)]&gt; load admin variables to runtime;    //使修改立即生效</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)]&gt; save admin variables to disk;   //使修改永久保存到磁盘</span><br><span class="line">Query OK, 31 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>修改后，就可以使用该用户名和密码连接管理接口</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@proxysql ~]# mysql -umyadmin -pwangqing123! -h172.16.12.128 -P6032</span><br><span class="line">Welcome to the MariaDB monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 7</span><br><span class="line">Server version: 5.5.30 (ProxySQL Admin Module)</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.</span><br><span class="line"></span><br><span class="line">Type &apos;help;&apos; or &apos;\h&apos; for help. Type &apos;\c&apos; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">MySQL [(none)]&gt;</span><br></pre></td></tr></table></figure>

<p>所有的配置操作都是在修改main库中对应的表</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">MySQL [(none)]&gt; select * from global_variables where variable_name=&apos;admin-admin_credentials&apos;;</span><br><span class="line">+-------------------------+----------------------------------+</span><br><span class="line">| variable_name           | variable_value                   |</span><br><span class="line">+-------------------------+----------------------------------+</span><br><span class="line">| admin-admin_credentials | admin:admin;myadmin:wangqing123! |</span><br><span class="line">+-------------------------+----------------------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<p><strong>必须要区分admin管理接口的用户名和mysql_users中的用户名</strong></p>
<ul>
<li>admin管理接口的用户是连接到管理接口(默认端口6032)上用来管理、配置ProxySQL的</li>
<li>mysql_users表中的用户名是应用程序连接ProxySQL(默认端口6033)，以及ProxySQL连接后端MySQL Servers使用的用户。它的作用是发送、路由SQL语句，类似于MySQL Server的3306端口。所以，这个表中的用户必须已经在后端MySQL Server上存在且授权了</li>
</ul>
<p><strong>admin管理接口的用户必须不能存在于mysql_users中，这是出于安全的考虑，防止通过admin管理接口用户猜出mysql_users中的用户</strong></p>
<h3 id="5-2-admin-stats-credentials"><a href="#5-2-admin-stats-credentials" class="headerlink" title="5.2 admin-stats_credentials"></a>5.2 admin-stats_credentials</h3><p>admin-stats_credentials 变量控制admin管理接口的普通用户，这个变量中的用户没有超级管理员权限，只能查看monitor库和main库中关于统计的数据，其它库都是不可见的，且没有任何写权限</p>
<p>默认的普通用户名和密码均为 stats ，与admin一样，它默认也只能用于本地登录，若想让人远程查看则要添加查看的专有用户</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">MySQL [(none)]&gt; select @@admin-stats_credentials;</span><br><span class="line">+---------------------------+</span><br><span class="line">| @@admin-stats_credentials |</span><br><span class="line">+---------------------------+</span><br><span class="line">| stats:stats               |</span><br><span class="line">+---------------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">//添加专有的查看用户</span><br><span class="line">MySQL [(none)]&gt; set admin-stats_credentials=&apos;stats:stats;mystats:wangqing123!&apos;;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)]&gt; select @@admin-stats_credentials;</span><br><span class="line">+----------------------------------+</span><br><span class="line">| @@admin-stats_credentials        |</span><br><span class="line">+----------------------------------+</span><br><span class="line">| stats:stats;mystats:wangqing123! |</span><br><span class="line">+----------------------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)]&gt; load admin variables to runtime;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)]&gt; save admin variables to disk;</span><br><span class="line">Query OK, 31 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>同样，<strong>这个变量中的用户必须不能存在于mysql_users表中</strong><br>使用mystats用户远程连接查看</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[root@proxysql ~]# mysql -umystats -pwangqing123! -h172.16.12.128 -P6032</span><br><span class="line">Welcome to the MariaDB monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 11</span><br><span class="line">Server version: 5.5.30 (ProxySQL Admin Module)</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.</span><br><span class="line"></span><br><span class="line">Type &apos;help;&apos; or &apos;\h&apos; for help. Type &apos;\c&apos; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">MySQL [(none)]&gt;</span><br><span class="line"></span><br><span class="line">MySQL [(none)]&gt; show tables from main;</span><br><span class="line">+--------------------------------------+</span><br><span class="line">| tables                               |</span><br><span class="line">+--------------------------------------+</span><br><span class="line">| global_variables                     |    </span><br><span class="line">| stats_memory_metrics                 |</span><br><span class="line">| stats_mysql_commands_counters        |</span><br><span class="line">| stats_mysql_connection_pool          |</span><br><span class="line">| stats_mysql_connection_pool_reset    |</span><br><span class="line">| stats_mysql_global                   |</span><br><span class="line">| stats_mysql_prepared_statements_info |</span><br><span class="line">| stats_mysql_processlist              |</span><br><span class="line">| stats_mysql_query_digest             |</span><br><span class="line">| stats_mysql_query_digest_reset       |</span><br><span class="line">| stats_mysql_query_rules              |</span><br><span class="line">| stats_mysql_users                    |</span><br><span class="line">| stats_proxysql_servers_checksums     |</span><br><span class="line">| stats_proxysql_servers_metrics       |</span><br><span class="line">| stats_proxysql_servers_status        |</span><br><span class="line">+--------------------------------------+</span><br><span class="line">15 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<h3 id="5-3-admin-mysql-ifaces"><a href="#5-3-admin-mysql-ifaces" class="headerlink" title="5.3 admin-mysql_ifaces"></a>5.3 admin-mysql_ifaces</h3><p>admin-mysql_ifaces 变量指定admin接口的监听地址，格式为冒号分隔的hostname:port列表。默认监听在 0.0.0.0:6032</p>
<p>注意，允许使用UNIX的domain socket进行监听，这样本主机内的应用程序就可以直接被处理。<br>例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">MySQL [(none)]&gt; SET admin-mysql_ifaces=&apos;0.0.0.0:6032;/tmp/proxysql_admin.sock&apos;;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)]&gt; load admin variables to runtime;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)]&gt; save admin variables to disk;</span><br><span class="line">Query OK, 31 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure>

<h2 id="6-多层配置系统"><a href="#6-多层配置系统" class="headerlink" title="6. 多层配置系统"></a>6. 多层配置系统</h2><h3 id="6-1-proxysql中的库"><a href="#6-1-proxysql中的库" class="headerlink" title="6.1 proxysql中的库"></a>6.1 proxysql中的库</h3><p><strong>使用ProxySQL的Admin管理接口连上ProxySQL，可查看ProxySQL拥有的库</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@proxysql ~]# mysql -umyadmin -pwangqing123! -h172.16.12.128 -P6032</span><br><span class="line">Welcome to the MariaDB monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 14</span><br><span class="line">Server version: 5.5.30 (ProxySQL Admin Module)</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.</span><br><span class="line"></span><br><span class="line">Type &apos;help;&apos; or &apos;\h&apos; for help. Type &apos;\c&apos; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">MySQL [(none)]&gt; show databases;</span><br><span class="line">+-----+---------------+-------------------------------------+</span><br><span class="line">| seq | name          | file                                |</span><br><span class="line">+-----+---------------+-------------------------------------+</span><br><span class="line">| 0   | main          |                                     |</span><br><span class="line">| 2   | disk          | /var/lib/proxysql/proxysql.db       |</span><br><span class="line">| 3   | stats         |                                     |</span><br><span class="line">| 4   | monitor       |                                     |</span><br><span class="line">| 5   | stats_history | /var/lib/proxysql/proxysql_stats.db |</span><br><span class="line">+-----+---------------+-------------------------------------+</span><br><span class="line">5 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>其中：</p>
<ul>
<li>main库是ProxySQL最主要的库，是需要修改配置时使用的库，它其实是一个内存数据库系统。所以，修改main库中的配置后，必须将其持久化到disk上才能永久保存</li>
<li>disk库是磁盘数据库，该数据库结构和内存数据库完全一致。当持久化内存数据库中的配置时，其实就是写入到disk库中。磁盘数据库的默认路径为 $DATADIR/proxysql.db</li>
<li>stats库是统计信息库。这个库中的数据一般是在检索其内数据时临时填充的，它保存在内存中。因为没有相关的配置项，所以无需持久化</li>
<li>monitor库是监控后端MySQL节点相关的库，该库中只有几个log类的表，监控模块收集到的监控信息全都存放到对应的log表中</li>
<li>stats_history库是1.4.4版新增的库，用于存放历史统计数据。默认路径为 $DATADIR/proxysql_stats.db</li>
</ul>
<p>ProxySQL 内部使用的是 SQLite3 数据库，无论是内存数据库还是磁盘数据库，都是通过SQLite3引 擎进行解析、操作的。它和 MySQL 的语法可能稍有不同，但ProxySQL会对不兼容的语法自动进行调整，最大程度上保证MySQL语句的有效率。<br>上面描述main库的时候，只是说了内存数据库需要持久化到disk库才能永久保存配置。但实际上，修改了main库中的配置后，并不会立即生效，它还需要load到runtime的数据结构中才生效，只有在runtime数据结构中的配置才是对ProxySQL当前有效的配置</p>
<h3 id="6-2-ProxySQL多层配置系统"><a href="#6-2-ProxySQL多层配置系统" class="headerlink" title="6.2 ProxySQL多层配置系统"></a>6.2 ProxySQL多层配置系统</h3><p>ProxySQL 的配置系统非常强大，它能在线修改几乎所有配置(仅有的两个需要重启才能生效的变量为 mysql-threads 和 mysql-stacksize )，并在线生效、持久化保存。这得益于它采用的多层配置系统。<br>多层配置系统结构如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">+-------------------------+</span><br><span class="line">|         RUNTIME         |</span><br><span class="line">+-------------------------+</span><br><span class="line">       /|\          |</span><br><span class="line">        |           |</span><br><span class="line">    [1] |       [2] |</span><br><span class="line">        |          \|/</span><br><span class="line">+-------------------------+</span><br><span class="line">|         MEMORY          |</span><br><span class="line">+-------------------------+ _</span><br><span class="line">       /|\          |      |\</span><br><span class="line">        |           |        \</span><br><span class="line">    [3] |       [4] |         \ [5]</span><br><span class="line">        |          \|/         \</span><br><span class="line">+-------------------------+  +---------------+</span><br><span class="line">|          DISK           |  |  CONFIG FILE  |</span><br><span class="line">+-------------------------+  +---------------+</span><br></pre></td></tr></table></figure>

<p>最底层的是 disk 库和 config file 。这里需要注意，这里的 config file 就是传统的配置文件，默认为 /etc/proxysql.cnf ， ProxySQL 启动时，主要是从 disk 库中读取配置加载到内存并最终加载到 runtime 生效，只有极少的几个特定配置内容是从 config file 中加载的，除非是第一次初始化 ProxySQL 运行环境(或者disk库为空)。</p>
<p>中间层的是 memory ，表示的是内存数据库，其实就是 main 库。通过管理接口修改的所有配置，都保存在内存数据库(main)中。当 ProxySQL 重启或者崩溃时，这个内存数据库中的数据会丢失，所以需要 save 到 disk 库中。</p>
<p>最上层的是 runtime ，它是 ProxySQL 有关线程运行时读取的数据结构。换句话说，该数据结构中的配置都是已生效的配置。所以，修改了 main 库中的配置后，必须 load 到 runtime 数据结构中才能使其生效。<br>在上面的多层配置系统图中，标注了[1]、[2]、[3]、[4]、[5]的序号。每个序号都有两个操作方向from/to，其实只是所站角度不同而已。以下是各序号对应的操作：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[1] ：将内存数据库中的配置加载到RUNTIME数据结构中</span><br><span class="line">        LOAD XXX FROM MEMORY</span><br><span class="line">        LOAD XXX TO RUNTIME</span><br><span class="line"></span><br><span class="line">[2] ：将RUNTIME数据结构中的配置持久化到内存数据库中</span><br><span class="line">        SAVE XXX FROM RUNTIME</span><br><span class="line">        SAVE XXX TO MEMORY</span><br><span class="line"></span><br><span class="line">[3] ：将磁盘数据库中的配置加载到内存数据库中</span><br><span class="line">        LOAD XXX FROM DISK</span><br><span class="line">        LOAD XXX TO MEMORY</span><br><span class="line"></span><br><span class="line">[4] ：将内存数据库中的配置持久化到磁盘数据库中</span><br><span class="line">        SAVE XXX FROM MEMORY</span><br><span class="line">        SAVE XXX TO DISK</span><br><span class="line"></span><br><span class="line">[5] ：从传统配置文件中读取配置加载到内存数据库中</span><br><span class="line">        LOAD XXX FROM CONFIG</span><br></pre></td></tr></table></figure>

<p><strong>DISK/MEMORY/RUNTIME/CONFIG 可以缩写，只要能识别即可。例如MEMORY可以缩写为MEM，runtime可以缩写为run</strong></p>
<p>另外，上面的XXX是什么？这表示要加载/保存的是哪类配置。目前的ProxySQL支持以下几种：</p>
<ul>
<li>mysql users</li>
<li>mysql servers</li>
<li>mysql variables</li>
<li>mysql query rules</li>
<li>admin variables</li>
<li>scheduler</li>
<li>proxysql_servers：目前ProxySQL集群功能还处于实验阶段，所以该类配置不应该去使用</li>
</ul>
<p>这些从main库或disk库中就可以查看到</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">MySQL [(none)]&gt; show tables from disk;</span><br><span class="line">+------------------------------------+</span><br><span class="line">| tables                             |</span><br><span class="line">+------------------------------------+</span><br><span class="line">| global_variables                   |  # (1)</span><br><span class="line">| mysql_collations                   |  # (N)</span><br><span class="line">| mysql_group_replication_hostgroups |  # (2)</span><br><span class="line">| mysql_query_rules                  |  # (3)</span><br><span class="line">| mysql_query_rules_fast_routing     |  # (4)</span><br><span class="line">| mysql_replication_hostgroups       |  # (5)</span><br><span class="line">| mysql_servers                      |  # (6)</span><br><span class="line">| mysql_users                        |  # (7)</span><br><span class="line">| proxysql_servers                   |  # (8)</span><br><span class="line">| scheduler                          |  # (9)</span><br><span class="line">+------------------------------------+</span><br><span class="line">10 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>上面的结果中我给这些表都标注了一些序号，其所对应的表的内容有以下讲究：</p>
<ul>
<li>(1)中包含两类变量，以amdin-开头的表示admin variables，以mysql-开头的表示mysql variables。修改哪类变量，前文的XXX就代表哪类</li>
<li>(2,5,6)对应的都是mysql servers</li>
<li>(3,4)对应的是mysql query rules</li>
<li>(7)对应的mysql users</li>
<li>(9)对应的scheduler</li>
<li>(N)只是一张表，保存的是ProxySQL支持的字符集和排序规则，它是不用修改的</li>
<li>(8)是ProxySQL的集群配置表，该功能目前还处于实验阶段。如果想要配置该功能，则load/save proxysql_servers to/from …</li>
</ul>
<h3 id="6-3-启动ProxySQL时如何加载配置"><a href="#6-3-启动ProxySQL时如何加载配置" class="headerlink" title="6.3 启动ProxySQL时如何加载配置"></a>6.3 启动ProxySQL时如何加载配置</h3><p>如果 ProxySQL 是刚安装的，或者磁盘数据库文件为空(甚至不存在)，或者启动 ProxySQL 时使用了选项 –initial，这几种情况启动 ProxySQL 时，都会从传统配置文件 config file 中读取配置加载到内存数据库，并自动 load 到 runtime 数据结构、save到磁盘数据库，这是初始化 ProxySQL 运行环境的过程。</p>
<p>如果不是第一次启动 ProxySQL ，由于已经存在磁盘数据库文件，这时 ProxySQL 会从磁盘数据库中读取几乎所有的配置(即使传统配置文件中配置了某项，也不会去解析)，但有3项是必须从传统配置文件中读取，它们分别是：</p>
<ul>
<li>datadir：ProxySQL启动时，必须从配置文件中确定它的数据目录，因为磁盘数据库文件、日志以及其它一些文件是存放在数据目录下的。如果使用/etc/init.d/proxysql管理ProxySQL，则除了修改/etc/proxysql.cnf的datadir，还需要修改该脚本中的datadir。</li>
<li>restart_on_missing_heartbeats：MySQL线程丢失多少次心跳，就会杀掉这个线程并重启它。默认值为10。</li>
<li>execute_on_exit_failure：如果设置了该变量，ProxySQL父进程将在每次ProxySQL崩溃的时候执行已经定义好的脚本。建议使用它来生成一些崩溃时的警告和日志。注意，ProxySQL的重启速度可能只有几毫秒，因此很多其它的监控工具可能无法探测到ProxySQL的一次普通故障，此时可使用该变量</li>
</ul>
<h2 id="7-不同类型的读写分离方案解析"><a href="#7-不同类型的读写分离方案解析" class="headerlink" title="7. 不同类型的读写分离方案解析"></a>7. 不同类型的读写分离方案解析</h2><p>数据库中间件最基本的功能就是实现读写分离， ProxySQL 当然也支持。而且 ProxySQL 支持的路由规则非常灵活，不仅可以实现最简单的读写分离，还可以将读/写都分散到多个不同的组，以及实现分库 sharding (分表sharding的规则比较难写，但也能实现)。</p>
<p>本文只描述通过规则制定的语句级读写分离，不讨论通过 ip/port, client, username, schemaname 实现的读写分离。</p>
<p>下面描述了ProxySQL能实现的常见读写分离类型</p>
<h3 id="7-1-最简单的读写分离"><a href="#7-1-最简单的读写分离" class="headerlink" title="7.1 最简单的读写分离"></a>7.1 最简单的读写分离</h3><p><img src="../../img/proxysql_read&write1.png" alt="img"></p>
<p>这种模式的读写分离，严格区分后端的master和slave节点，且slave节点必须设置选项read_only=1</p>
<p>在ProxySQL上，分两个组，一个写组HG=10，一个读组HG=20。同时在ProxySQL上开启monitor模块的read_only监控功能，让ProxySQL根据监控到的read_only值来自动调整节点放在HG=10(master会放进这个组)还是HG=20(slave会放进这个组)</p>
<p>这种模式的读写分离是最简单的，只需在mysql_users表中设置用户的默认路由组为写组HG=10，并在mysql_query_rules中加上两条简单的规则(一个select for update，一个select)即可</p>
<p>这种读写分离模式，在环境较小时能满足绝大多数需求。但是需求复杂、环境较大时，这种模式就太过死板，因为一切都是monitor模块控制的</p>
<h3 id="7-2-多个读组或写组的分离模式"><a href="#7-2-多个读组或写组的分离模式" class="headerlink" title="7.2 多个读组或写组的分离模式"></a>7.2 多个读组或写组的分离模式</h3><p>前面那种读写分离模式，是通过 monitor 模块监控 read_only 来调整的，所以每一个后端集群必须只能分为一个写组，一个读组。<br>但如果想要区分不同的 select ，并将不同的 select 路由到不同的节点上。例如有些查询语句的开销非常大，想让它们独占一个节点/组，其它查询共享一个节点/组，怎么实现？</p>
<p>例如，下面这种模式</p>
<p><img src="../../img/proxysql_read&write2.png" alt="img"></p>
<p>看上去非常简单。但是却能适应各种需求。例如，后端做了分库，对某库的查询要路由到特定的主机组</p>
<p>至于各个主机组是同一个主从集群(下图左边)，还是互相独立的主从集群环境(下图右边)，要看具体的需求，不过这种读写分离模式都能应付</p>
<p><img src="../../img/proxysql_read&write3.png" alt="img"></p>
<p>在实现这种模式时，前提是不能开启monitor模块的read_only监控功能，也不要设置mysql_replication_hostgroup 表</p>
<p>例如，下面的配置实现的是上图左边的结构：写请求路由给HG=10，对test1库的select语句路由给HG=20，其它select路由给HG=30</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">mysql_servers: </span><br><span class="line">+--------------+----------+------+--------+--------+</span><br><span class="line">| hostgroup_id | hostname | port | status | weight |</span><br><span class="line">+--------------+----------+------+--------+--------+</span><br><span class="line">| 10           | host1    | 3306 | ONLINE | 1      |</span><br><span class="line">| 20           | host2    | 3306 | ONLINE | 1      |</span><br><span class="line">| 30           | host3    | 3306 | ONLINE | 1      |</span><br><span class="line">+--------------+----------+------+--------+--------+</span><br><span class="line"></span><br><span class="line">mysql_users: </span><br><span class="line">+----------+-------------------+</span><br><span class="line">| username | default_hostgroup |</span><br><span class="line">+----------+-------------------+</span><br><span class="line">| root     | 10                |</span><br><span class="line">+----------+-------------------+</span><br><span class="line"></span><br><span class="line">mysql_query_rules: </span><br><span class="line">+---------+-----------------------+----------------------+</span><br><span class="line">| rule_id | destination_hostgroup | match_digest         |</span><br><span class="line">+---------+-----------------------+----------------------+</span><br><span class="line">| 1       | 10                    | ^SELECT.*FOR UPDATE$ |</span><br><span class="line">| 2       | 20                    | ^SELECT.*test1\..*   |</span><br><span class="line">| 3       | 30                    | ^SELECT              |</span><br><span class="line">+---------+-----------------------+----------------------+</span><br></pre></td></tr></table></figure>

<p><strong>查看表结构的方式：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PRAGMA  table_info(&quot;表名&quot;);</span><br></pre></td></tr></table></figure>

<h2 id="8-ProxySQL实现读写分离示例"><a href="#8-ProxySQL实现读写分离示例" class="headerlink" title="8. ProxySQL实现读写分离示例"></a>8. ProxySQL实现读写分离示例</h2><p><strong>环境说明：</strong></p>
<table>
<thead>
<tr>
<th align="center">IP</th>
<th align="center">角色</th>
<th align="center">应用</th>
<th align="center">系统平台</th>
</tr>
</thead>
<tbody><tr>
<td align="center">192.168.153.136</td>
<td align="center">读写分离解析主机</td>
<td align="center">proxysql</td>
<td align="center">centos7.6</td>
</tr>
<tr>
<td align="center">192.168.153.140</td>
<td align="center">master</td>
<td align="center">mariadb5.5.6</td>
<td align="center">centos7.6</td>
</tr>
<tr>
<td align="center">192.168.153.141</td>
<td align="center">slave</td>
<td align="center">mariadb5.5.6</td>
<td align="center">centos7.6</td>
</tr>
<tr>
<td align="center">192.168.153.142</td>
<td align="center">slave</td>
<td align="center">mariadb5.5.6</td>
<td align="center">centos7.6</td>
</tr>
</tbody></table>
<p><strong>准备工作：</strong></p>
<ul>
<li>关闭防火墙</li>
<li>关闭SELINUX</li>
<li>安装mysql并配置主从</li>
</ul>
<h3 id="8-1-安装ProxySQL"><a href="#8-1-安装ProxySQL" class="headerlink" title="8.1 安装ProxySQL"></a>8.1 安装ProxySQL</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">配置proxysql的yum源</span><br><span class="line">[root@ct136 ~]# cat &lt;&lt;EOF | tee /etc/yum.repos.d/proxysql.repo</span><br><span class="line">[proxysql_repo]</span><br><span class="line">name= ProxySQL</span><br><span class="line">baseurl=http://repo.proxysql.com/ProxySQL/proxysql-1.4.x/centos/7</span><br><span class="line">gpgcheck=1</span><br><span class="line">gpgkey=http://repo.proxysql.com/ProxySQL/repo_pub_key</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">安装proxysql</span><br><span class="line">[root@ct136 ~]# yum -y install proxysql</span><br><span class="line"></span><br><span class="line">启动proxysql并设置开机自动启动</span><br><span class="line">proxysql默认只提供了sysv风格的启动脚本，所以想设置开机自启则需借助于chkconfig工具</span><br><span class="line">[root@ct136 ~]# systemctl start proxysql</span><br><span class="line">[root@ct136 ~]# chkconfig proxysql on</span><br></pre></td></tr></table></figure>

<h3 id="8-2-配置ProxySQL"><a href="#8-2-配置ProxySQL" class="headerlink" title="8.2 配置ProxySQL"></a>8.2 配置ProxySQL</h3><h4 id="8-2-1-mysql主库添加proxysql可以增删改查的账号"><a href="#8-2-1-mysql主库添加proxysql可以增删改查的账号" class="headerlink" title="8.2.1 mysql主库添加proxysql可以增删改查的账号"></a>8.2.1 mysql主库添加proxysql可以增删改查的账号</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@ct140 ~]# mysql</span><br><span class="line">Welcome to the MariaDB monitor.  Commands end with ; or \g.</span><br><span class="line">Your MariaDB connection id is 6</span><br><span class="line">Server version: 5.5.60-MariaDB MariaDB Server</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.</span><br><span class="line"></span><br><span class="line">Type &apos;help;&apos; or &apos;\h&apos; for help. Type &apos;\c&apos; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">MariaDB [(none)]&gt; grant all on *.* to &apos;proxysql&apos;@&apos;192.168.153.136&apos; identified by &apos;pwproxysql&apos;;</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [(none)]&gt; flush privileges;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure>

<h4 id="8-2-2-登录proxysql管理端"><a href="#8-2-2-登录proxysql管理端" class="headerlink" title="8.2.2 登录proxysql管理端"></a>8.2.2 登录proxysql管理端</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[root@ct136 ~]# yum -y install mariadb</span><br><span class="line">[root@ct136 ~]# export MYSQL_PS1=&quot;(\u@\h:\p) [\d]&gt; &quot;</span><br><span class="line">[root@ct136 ~]# mysql -uadmin -padmin -h127.0.0.1 -P6032</span><br><span class="line">Welcome to the MariaDB monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 1</span><br><span class="line">Server version: 5.5.30 (ProxySQL Admin Module)</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.</span><br><span class="line"></span><br><span class="line">Type &apos;help;&apos; or &apos;\h&apos; for help. Type &apos;\c&apos; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">(admin@127.0.0.1:6032) [(none)]&gt; show databases;</span><br><span class="line">+-----+---------------+-------------------------------------+</span><br><span class="line">| seq | name          | file                                |</span><br><span class="line">+-----+---------------+-------------------------------------+</span><br><span class="line">| 0   | main          |                                     |</span><br><span class="line">| 2   | disk          | /var/lib/proxysql/proxysql.db       |</span><br><span class="line">| 3   | stats         |                                     |</span><br><span class="line">| 4   | monitor       |                                     |</span><br><span class="line">| 5   | stats_history | /var/lib/proxysql/proxysql_stats.db |</span><br><span class="line">+-----+---------------+-------------------------------------+</span><br><span class="line">5 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>数据库说明：</p>
<ul>
<li>main 内存配置数据库，表里存放后端db实例、用户验证、路由规则等信息。表名以 runtime开头的表示proxysql当前运行的配置内容，不能通过dml语句修改，只能修改对应的不以 runtime 开头的（在内存）里的表，然后 LOAD 使其生效， SAVE 使其存到硬盘以供下次重启加载</li>
<li>disk 是持久化到硬盘的配置，sqlite数据文件</li>
<li>stats 是proxysql运行抓取的统计信息，包括到后端各命令的执行次数、流量、processlist、查询种类汇总/执行时间等等</li>
<li>monitor 库存储 monitor 模块收集的信息，主要是对后端db的健康/延迟检查</li>
<li>stats_history 统计信息历史库</li>
</ul>
<h4 id="8-2-3-Proxysql管理端添加后端连接mysql主从数据库的配置"><a href="#8-2-3-Proxysql管理端添加后端连接mysql主从数据库的配置" class="headerlink" title="8.2.3 Proxysql管理端添加后端连接mysql主从数据库的配置"></a>8.2.3 Proxysql管理端添加后端连接mysql主从数据库的配置</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">(admin@127.0.0.1:6032) [(none)]&gt; show tables from main;</span><br><span class="line">+--------------------------------------------+</span><br><span class="line">| tables                                     |</span><br><span class="line">+--------------------------------------------+</span><br><span class="line">| global_variables                           |  # ProxySQL的基本配置参数，类似与MySQL</span><br><span class="line">| mysql_collations                           |  # 配置对MySQL字符集的支持</span><br><span class="line">| mysql_group_replication_hostgroups         |  # MGR相关的表，用于实例的读写组自动分配</span><br><span class="line">| mysql_query_rules                          |  # 路由表</span><br><span class="line">| mysql_query_rules_fast_routing             |  # 主从复制相关的表，用于实例的读写组自动分配</span><br><span class="line">| mysql_replication_hostgroups               |  </span><br><span class="line">| mysql_servers                              |  # 存储MySQL实例的信息</span><br><span class="line">| mysql_users                                |  # 存储MySQL用户</span><br><span class="line">| proxysql_servers                           |  # 存储ProxySQL的信息，用于ProxySQL Cluster同步</span><br><span class="line">| runtime_checksums_values                   |  # 运行环境的存储校验值</span><br><span class="line">| runtime_global_variables                   |</span><br><span class="line">| runtime_mysql_group_replication_hostgroups |</span><br><span class="line">| runtime_mysql_query_rules                  |</span><br><span class="line">| runtime_mysql_query_rules_fast_routing     |</span><br><span class="line">| runtime_mysql_replication_hostgroups       |  # 与上面对应，但是运行环境正在使用的配置</span><br><span class="line">| runtime_mysql_servers                      |</span><br><span class="line">| runtime_mysql_users                        |</span><br><span class="line">| runtime_proxysql_servers                   |</span><br><span class="line">| runtime_scheduler                          |</span><br><span class="line">| scheduler                                  |  # 定时任务表</span><br><span class="line">+--------------------------------------------+</span><br><span class="line">20 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>runtime_ 开头的是运行时的配置，这些是不能修改的。要修改 ProxySQL 的配置，需要修改了非 runtime_ 表，修改后必须执行 LOAD … TO RUNTIME 才能加载到 RUNTIME 生效，执行 save … to disk 才能将配置持久化保存到磁盘</p>
<p>下面语句中没有先切换到 main 库也执行成功了，因为 ProxySQL 内部使用的 SQLite3 数据库引擎，和 MySQL 的解析方式是不一样的。即使执行了 USE main 语句也是无任何效果的，但不会报错</p>
<p>使用 insert 语句添加 mysql 主机到 mysql_servers 表中，其中：hostgroup_id 1 表示写组，2表示读组</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">(admin@127.0.0.1:6032) [(none)]&gt; insert into mysql_servers(hostgroup_id,hostname,port,weight,comment) values(10,&apos;192.168.153.140&apos;,3306,1,&apos;Write Group&apos;),(20,&apos;192.168.153.141&apos;,3306,1,&apos;Read Group&apos;),(20,&apos;192.168.153.142&apos;,3306,1,&apos;Read Group&apos;);</span><br><span class="line">Query OK, 2 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">(admin@127.0.0.1:6032) [(none)]&gt; select * from mysql_servers;</span><br><span class="line">+--------------+-----------------+------+--------+--------+-------------+-----------------+---------------------+---------+----------------+-------------+</span><br><span class="line">| hostgroup_id | hostname        | port | status | weight | compression | max_connections | max_replication_lag | use_ssl | max_latency_ms | comment     |</span><br><span class="line">+--------------+-----------------+------+--------+--------+-------------+-----------------+---------------------+---------+----------------+-------------+</span><br><span class="line">| 10           | 192.168.153.140 | 3306 | ONLINE | 1      | 0           | 1000            | 0                   | 0       | 0              | Write Group |</span><br><span class="line">| 20           | 192.168.153.141 | 3306 | ONLINE | 1      | 0           | 1000            | 0                   | 0       | 0              | Read Group  |</span><br><span class="line">| 20           | 192.168.153.142 | 3306 | ONLINE | 1      | 0           | 1000            | 0                   | 0       | 0              | Read Group  |</span><br><span class="line">+--------------+-----------------+------+--------+--------+-------------+-----------------+---------------------+---------+----------------+-------------+</span><br><span class="line">3 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>修改后，需要加载到RUNTIME，并保存到disk</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(admin@127.0.0.1:6032) [(none)]&gt; load mysql servers to runtime;</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">(admin@127.0.0.1:6032) [(none)]&gt; save mysql servers to disk;</span><br><span class="line">Query OK, 0 rows affected (0.05 sec)</span><br></pre></td></tr></table></figure>

<p>在 proxysql 主机的 mysql_users 表中添加刚才在 master 上创建的账号 proxysql，proxysql 客户端需要使用这个账号来访问数据库<br>default_hostgroup 默认组设置为写组，也就是1;<br>当读写分离的路由规则不符合时，会访问默认组的数据库;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">(admin@127.0.0.1:6032) [(none)]&gt; insert into mysql_users(username,password,default_hostgroup,transaction_persistent) values(&apos;proxysql&apos;,&apos;pwproxysql&apos;,10,1);</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">(admin@127.0.0.1:6032) [(none)]&gt; select * from mysql_users \G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">              username: proxysql        # 后端mysql实例的用户名</span><br><span class="line">              password: pwproxysql      # 后端mysql实例的密码</span><br><span class="line">                active: 1               # active=1表示用户生效，0表示不生效</span><br><span class="line">               use_ssl: 0</span><br><span class="line">     default_hostgroup: 10               # 用户默认登录到哪个hostgroup_id下的实例</span><br><span class="line">        default_schema: NULL            # 用户默认登录后端mysql实例时连接的数据库，这个地方为NULL的话，则由全局变量mysql-default_schema决定，默认是information_schema</span><br><span class="line">         schema_locked: 0</span><br><span class="line">transaction_persistent: 1       # 如果设置为1，连接上ProxySQL的会话后，如果在一个hostgroup上开启了事务，那么后续的sql都继续维持在这个hostgroup上，不论是否会匹配上其它路由规则，直到事务结束。虽然默认是0</span><br><span class="line">          fast_forward: 0       # 忽略查询重写/缓存层，直接把这个用户的请求透传到后端DB。相当于只用它的连接池功能，一般不用，路由规则 .* 就行了</span><br><span class="line">               backend: 1</span><br><span class="line">              frontend: 1</span><br><span class="line">       max_connections: 10000   # 该用户允许的最大连接数</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">(admin@127.0.0.1:6032) [(none)]&gt; load mysql users to runtime;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">(admin@127.0.0.1:6032) [(none)]&gt; save mysql users to disk;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure>

<h4 id="8-2-4-添加健康检测的帐号"><a href="#8-2-4-添加健康检测的帐号" class="headerlink" title="8.2.4 添加健康检测的帐号"></a>8.2.4 添加健康检测的帐号</h4><p><strong>在mysql的 master 端添加属于proxysql的只读账号</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [(none)]&gt; grant select on *.* to &apos;monitor&apos;@&apos;192.168.153.%&apos; identified by &apos;monitor&apos;;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [(none)]&gt; flush privileges;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure>

<p><strong>在proxysql主机端修改变量设置健康检测的账号</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">(admin@127.0.0.1:6032) [(none)]&gt; set mysql-monitor_username=&apos;monitor&apos;;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">(admin@127.0.0.1:6032) [(none)]&gt; set mysql-monitor_password=&apos;monitor&apos;;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">(admin@127.0.0.1:6032) [(none)]&gt; load mysql variables to runtime;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">(admin@127.0.0.1:6032) [(none)]&gt; save mysql variables to disk;</span><br><span class="line">Query OK, 97 rows affected (0.01 sec)</span><br></pre></td></tr></table></figure>

<h4 id="8-2-5-添加读写分离的路由规则"><a href="#8-2-5-添加读写分离的路由规则" class="headerlink" title="8.2.5 添加读写分离的路由规则"></a>8.2.5 添加读写分离的路由规则</h4><p><strong>需求：</strong></p>
<ul>
<li>将 select 查询语句全部路由至 hostgroup_id=2 的组(也就是读组)</li>
<li>但是 select * from tb for update 这样的语句是会修改数据的，所以需要单独定义，将它路由至 hostgroup_id=1 的组(也就是写组)</li>
<li>其他没有被规则匹配到的组将会被路由至用户默认的组(mysql_users 表中的 default_hostgroup)</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">(admin@127.0.0.1:6032) [(none)]&gt; insert into mysql_query_rules(rule_id,active,match_digest,destination_hostgroup,apply)values(1,1,&apos;^SELECT.*FOR UPDATE$&apos;,1,1);</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">(admin@127.0.0.1:6032) [(none)]&gt; insert into mysql_query_rules(rule_id,active,match_digest,destination_hostgroup,apply)values(2,1,&apos;^SELECT&apos;,2,1);</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">(admin@127.0.0.1:6032) [(none)]&gt; select rule_id,active,match_digest,destination_hostgroup,apply from mysql_query_rules;</span><br><span class="line">+---------+--------+----------------------+-----------------------+-------+</span><br><span class="line">| rule_id | active | match_digest         | destination_hostgroup | apply |</span><br><span class="line">+---------+--------+----------------------+-----------------------+-------+</span><br><span class="line">| 1       | 1      | ^SELECT.*FOR UPDATE$ | 10                    | 1     |</span><br><span class="line">| 2       | 1      | ^SELECT              | 20                    | 1     |</span><br><span class="line">+---------+--------+----------------------+-----------------------+-------+</span><br><span class="line">2 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">(admin@127.0.0.1:6032) [(none)]&gt; load mysql query rules to runtime;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">(admin@127.0.0.1:6032) [(none)]&gt; load admin variables to runtime;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">(admin@127.0.0.1:6032) [(none)]&gt; save mysql query rules to disk;</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">(admin@127.0.0.1:6032) [(none)]&gt; save admin variables to disk;</span><br><span class="line">Query OK, 31 rows affected (0.01 sec)</span><br></pre></td></tr></table></figure>

<h3 id="8-3-验证读写分离"><a href="#8-3-验证读写分离" class="headerlink" title="8.3 验证读写分离"></a>8.3 验证读写分离</h3><h4 id="8-3-1-登录-proxysql-客户端"><a href="#8-3-1-登录-proxysql-客户端" class="headerlink" title="8.3.1 登录 proxysql 客户端"></a>8.3.1 登录 proxysql 客户端</h4><p>登录用户是刚才我们在 mysql_user 表中创建的用户，端口为6033</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@ct136 ~]# mysql -uproxysql -ppwproxysql -h127.0.0.1 -P6033</span><br><span class="line">Welcome to the MariaDB monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 3</span><br><span class="line">Server version: 5.5.30 (ProxySQL)</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.</span><br><span class="line"></span><br><span class="line">Type &apos;help;&apos; or &apos;\h&apos; for help. Type &apos;\c&apos; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">(proxysql@127.0.0.1:6033) [(none)]&gt; show databases;</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| test               |</span><br><span class="line">| whs                |</span><br><span class="line">+--------------------+</span><br><span class="line">5 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<h4 id="8-3-2-尝试修改数据库和查询"><a href="#8-3-2-尝试修改数据库和查询" class="headerlink" title="8.3.2 尝试修改数据库和查询"></a>8.3.2 尝试修改数据库和查询</h4><p>创建2个数据库并查询一下表</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">(proxysql@127.0.0.1:6033) [(none)]&gt; create database itwhs;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">(proxysql@127.0.0.1:6033) [(none)]&gt; create database itw;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">(proxysql@127.0.0.1:6033) [(none)]&gt; select user,host from mysql.user;</span><br><span class="line">+----------+-----------------+</span><br><span class="line">| user     | host            |</span><br><span class="line">+----------+-----------------+</span><br><span class="line">| root     | 127.0.0.1       |</span><br><span class="line">| monitor  | 192.168.153.%   |</span><br><span class="line">| proxysql | 192.168.153.136 |</span><br><span class="line">| whs      | 192.168.153.142 |</span><br><span class="line">| root     | ::1             |</span><br><span class="line">|          | ct141           |</span><br><span class="line">| root     | ct141           |</span><br><span class="line">|          | localhost       |</span><br><span class="line">| root     | localhost       |</span><br><span class="line">+----------+-----------------+</span><br><span class="line">9 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<h4 id="8-3-3-验证读写分离是否成功"><a href="#8-3-3-验证读写分离是否成功" class="headerlink" title="8.3.3 验证读写分离是否成功"></a>8.3.3 验证读写分离是否成功</h4><blockquote>
<p>proxysql有个类似审计的功能，可以查看各类SQL的执行情况，其需要在proxysql管理端执行</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@ct136 ~]# mysql -uadmin -padmin -h127.0.0.1 -P6032</span><br><span class="line">Welcome to the MariaDB monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 5</span><br><span class="line">Server version: 5.5.30 (ProxySQL Admin Module)</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.</span><br><span class="line"></span><br><span class="line">Type &apos;help;&apos; or &apos;\h&apos; for help. Type &apos;\c&apos; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">(admin@127.0.0.1:6032) [(none)]&gt; select * from stats_mysql_query_digest;</span><br><span class="line">+-----------+--------------------+----------+--------------------+----------------------------------+------------+------------+------------+----------+----------+----------+</span><br><span class="line">| hostgroup | schemaname         | username | digest             | digest_text                      | count_star | first_seen | last_seen  | sum_time | min_time | max_time |</span><br><span class="line">+-----------+--------------------+----------+--------------------+----------------------------------+------------+------------+------------+----------+----------+----------+</span><br><span class="line">| 20        | information_schema | proxysql | 0x0F02B330C823D739 | select user,host from mysql.user | 1          | 1561462395 | 1561462395 | 5578     | 5578     | 5578     |</span><br><span class="line">| 10        | information_schema | proxysql | 0x88DAAF812073F71F | create database itw              | 1          | 1561462378 | 1561462378 | 1870     | 1870     | 1870     |</span><br><span class="line">| 10        | information_schema | proxysql | 0x02033E45904D3DF0 | show databases                   | 1          | 1561462249 | 1561462249 | 5885     | 5885     | 5885     |</span><br><span class="line">| 10        | information_schema | proxysql | 0xFC4D8902AD1850BE | create database itwhs            | 1          | 1561462373 | 1561462373 | 1970     | 1970     | 1970     |</span><br><span class="line">| 10        | information_schema | proxysql | 0x594F2C744B698066 | select USER()                    | 1          | 1561462244 | 1561462244 | 0        | 0        | 0        |</span><br><span class="line">+-----------+--------------------+----------+--------------------+----------------------------------+------------+------------+------------+----------+----------+----------+</span><br><span class="line">9 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>从上面的 hostgroup 和 digest_text 值来看，所有的写操作都被路由至10组，读操作都被路由至20组，其中10组为写组，20组为读组！</p>
<p>由此可见，读写分离成功！！！</p>

          
        
      
    </div>

    

    

    
    
    

    

    
      
    
    

    
	
	  <div>
        
      </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://aiwhs.github.io/2018/12/09/mysql多实例部署/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="itw">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="itw">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2018/12/09/mysql多实例部署/" class="post-title-link" itemprop="url">MySQL多实例</a>
              
            
          </h1>
        

        <div class="post-meta">

          
          
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-12-09 08:15:57" itemprop="dateCreated datePublished" datetime="2018-12-09T08:15:57+08:00">2018-12-09</time>
            </span>
          

          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-07-17 16:14:39" itemprop="dateModified" datetime="2019-07-17T16:14:39+08:00">2019-07-17</time>
              </span>
            
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Linux运维/" itemprop="url" rel="index"><span itemprop="name">Linux运维</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          <br>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <a id="more"></a>

<h1 id="mysql多实例部署"><a href="#mysql多实例部署" class="headerlink" title="mysql多实例部署"></a>mysql多实例部署</h1><p>软件下载</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">下载二进制格式的mysql软件包</span><br><span class="line">[root@localhost ~]# cd /usr/src/</span><br><span class="line">[root@localhost src]# wget https://downloads.mysql.com/archives/get/file/mysql-5.7.22-linux-glibc2.12-x86_64.tar.gz</span><br></pre></td></tr></table></figure>

<p>配置用户和组并解压二进制程序至/usr/local下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">创建用户和组</span><br><span class="line">[root@localhost src]# groupadd -r mysql</span><br><span class="line">[root@localhost src]# useradd -M -s /sbin/nologin -g mysql mysql</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">解压软件至/usr/local/</span><br><span class="line">[root@localhost src]# ls</span><br><span class="line">debug  kernels  mysql-5.7.22-linux-glibc2.12-x86_64.tar.gz</span><br><span class="line">[root@localhost src]# tar xf mysql-5.7.22-linux-glibc2.12-x86_64.tar.gz -C /usr/local/</span><br><span class="line">[root@localhost ~]# ls /usr/local/</span><br><span class="line">bin  games    lib    libexec                              sbin   src</span><br><span class="line">etc  include  lib64  mysql-5.7.22-linux-glibc2.12-x86_64  share</span><br><span class="line">[root@localhost ~]# cd /usr/local/</span><br><span class="line">[root@localhost local]# ln -sv mysql-5.7.22-linux-glibc2.12-x86_64/ mysql</span><br><span class="line">‘mysql’ -&gt; ‘mysql-5.7.22-linux-glibc2.12-x86_64/’</span><br><span class="line">[root@localhost local]# ll</span><br><span class="line">total 0</span><br><span class="line">drwxr-xr-x. 2 root root   6 4月  11 2018 bin</span><br><span class="line">drwxr-xr-x. 2 root root   6 4月  11 2018 etc</span><br><span class="line">drwxr-xr-x. 2 root root   6 4月  11 2018 games</span><br><span class="line">drwxr-xr-x. 2 root root   6 4月  11 2018 include</span><br><span class="line">drwxr-xr-x. 2 root root   6 4月  11 2018 lib</span><br><span class="line">drwxr-xr-x. 2 root root   6 4月  11 2018 lib64</span><br><span class="line">drwxr-xr-x. 2 root root   6 4月  11 2018 libexec</span><br><span class="line">lrwxrwxrwx  1 root root  36 5月  14 18:07 mysql -&gt; mysql-5.7.22-linux-glibc2.12-x86_64/</span><br><span class="line">drwxr-xr-x  9 root root 129 5月  14 18:06 mysql-5.7.22-linux-glibc2.12-x86_64</span><br><span class="line">drwxr-xr-x. 2 root root   6 4月  11 2018 sbin</span><br><span class="line">drwxr-xr-x. 5 root root  49 5月   3 20:12 share</span><br><span class="line">drwxr-xr-x. 2 root root   6 4月  11 2018 src</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">修改目录/usr/local/mysql的属主属组</span><br><span class="line">[root@localhost ~]# chown -R mysql.mysql /usr/local/mysql</span><br><span class="line">[root@localhost ~]# ll /usr/local/mysql -d</span><br><span class="line">lrwxrwxrwx 1 mysql mysql 36 5月  14 18:07 /usr/local/mysql -&gt; mysql-5.7.22-linux-glibc2.12-x86_64/</span><br><span class="line"></span><br><span class="line">//配置环境变量</span><br><span class="line">[root@localhost ~]# echo &apos;export PATH=/usr/local/mysql/bin:$PATH&apos; &gt; /etc/profile.d/mysql.sh</span><br><span class="line">[root@localhost ~]# . /etc/profile.d/mysql.sh</span><br><span class="line">[root@localhost ~]# echo $PATH</span><br><span class="line">/usr/local/mysql/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/root/bin</span><br></pre></td></tr></table></figure>

<p>创建各实例数据存放的目录</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# mkdir -p /opt/data/&#123;3306,3307,3308&#125;</span><br><span class="line"></span><br><span class="line">[root@localhost ~]# chown -R mysql.mysql /opt/data/</span><br><span class="line"></span><br><span class="line">[root@localhost ~]# ll /opt/data/</span><br><span class="line">总用量 0</span><br><span class="line">drwxr-xr-x 2 mysql mysql 6 5月  14 18:09 3306</span><br><span class="line">drwxr-xr-x 2 mysql mysql 6 5月  14 18:09 3307</span><br><span class="line">drwxr-xr-x 2 mysql mysql 6 5月  14 18:09 3308</span><br><span class="line"></span><br><span class="line">[root@localhost ~]# tree /opt/data/</span><br><span class="line">/opt/data/</span><br><span class="line">├── 3306</span><br><span class="line">├── 3307</span><br><span class="line">└── 3308</span><br><span class="line"></span><br><span class="line">3 directories, 0 files</span><br></pre></td></tr></table></figure>

<p>初始化各实例</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">初始化3306实例</span><br><span class="line">[root@localhost ~]# mysqld --initialize --datadir=/opt/data/3306 --user=mysql</span><br><span class="line">2019-05-14T10:21:09.607685Z 0 [Warning] TIMESTAMP with implicit DEFAULT value is deprecated. Please use --explicit_defaults_for_timestamp server option (see documentation for more details).</span><br><span class="line">2019-05-14T10:21:09.822454Z 0 [Warning] InnoDB: New log files created, LSN=45790</span><br><span class="line">2019-05-14T10:21:09.858420Z 0 [Warning] InnoDB: Creating foreign key constraint system tables.</span><br><span class="line">2019-05-14T10:21:09.916381Z 0 [Warning] No existing UUID has been found, so we assume that this is the first time that this server has been started. Generating a new UUID: fe0bac5b-7631-11e9-bec6-000c299f3251.</span><br><span class="line">2019-05-14T10:21:09.917673Z 0 [Warning] Gtid table is not ready to be used. Table &apos;mysql.gtid_executed&apos; cannot be opened.</span><br><span class="line">2019-05-14T10:21:09.918517Z 1 [Note] A temporary password is generated for root@localhost: AG/j:g?ob1CO</span><br><span class="line">[root@localhost ~]# echo &apos;AG/j:g?ob1CO&apos; &gt; 3306_pass</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">初始化3307实例</span><br><span class="line">[root@localhost ~]# mysqld --initialize --datadir=/opt/data/3307 --user=mysql</span><br><span class="line">2019-05-14T10:24:10.367114Z 0 [Warning] TIMESTAMP with implicit DEFAULT value is deprecated. Please use --explicit_defaults_for_timestamp server option (see documentation for more details).</span><br><span class="line">2019-05-14T10:24:10.572462Z 0 [Warning] InnoDB: New log files created, LSN=45790</span><br><span class="line">2019-05-14T10:24:10.610295Z 0 [Warning] InnoDB: Creating foreign key constraint system tables.</span><br><span class="line">2019-05-14T10:24:10.669903Z 0 [Warning] No existing UUID has been found, so we assume that this is the first time that this server has been started. Generating a new UUID: 69c878d3-7632-11e9-82ab-000c299f3251.</span><br><span class="line">2019-05-14T10:24:10.670681Z 0 [Warning] Gtid table is not ready to be used. Table &apos;mysql.gtid_executed&apos; cannot be opened.</span><br><span class="line">2019-05-14T10:24:10.671566Z 1 [Note] A temporary password is generated for root@localhost: rfY5Ys(u:s!s</span><br><span class="line">[root@localhost ~]# echo &apos;rfY5Ys(u:s!s&apos; &gt; 3307_pass</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">初始化3308实例</span><br><span class="line">[root@localhost ~]# mysqld --initialize --datadir=/opt/data/3308 --user=mysql</span><br><span class="line">2019-05-14T10:25:03.584110Z 0 [Warning] TIMESTAMP with implicit DEFAULT value is deprecated. Please use --explicit_defaults_for_timestamp server option (see documentation for more details).</span><br><span class="line">2019-05-14T10:25:03.795984Z 0 [Warning] InnoDB: New log files created, LSN=45790</span><br><span class="line">2019-05-14T10:25:03.832243Z 0 [Warning] InnoDB: Creating foreign key constraint system tables.</span><br><span class="line">2019-05-14T10:25:03.891271Z 0 [Warning] No existing UUID has been found, so we assume that this is the first time that this server has been started. Generating a new UUID: 89816891-7632-11e9-85fa-000c299f3251.</span><br><span class="line">2019-05-14T10:25:03.892710Z 0 [Warning] Gtid table is not ready to be used. Table &apos;mysql.gtid_executed&apos; cannot be opened.</span><br><span class="line">2019-05-14T10:25:03.893870Z 1 [Note] A temporary password is generated for root@localhost: +g9h.g(%g2&gt;E</span><br><span class="line">[root@localhost ~]# echo &apos;+g9h.g(%g2&gt;E&apos; &gt; 3308_pass</span><br></pre></td></tr></table></figure>

<p>安装perl</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# yum -y install perl</span><br></pre></td></tr></table></figure>

<p>配置配置文件/etc/my.cnf</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# vim /etc/my.cnf</span><br><span class="line">[mysqld_multi]</span><br><span class="line">mysqld = /usr/local/mysql/bin/mysqld_safe</span><br><span class="line">mysqladmin = /usr/local/mysql/bin/mysqladmin</span><br><span class="line">user = root</span><br><span class="line">password = wangqing123!</span><br><span class="line"></span><br><span class="line">[mysqld3306]</span><br><span class="line">datadir = /opt/data/3306</span><br><span class="line">port = 3306</span><br><span class="line">socket = /tmp/mysql3306.sock</span><br><span class="line">pid-file = /opt/data/3306/mysql_3306.pid</span><br><span class="line">log-error=/var/log/3306.log</span><br><span class="line"></span><br><span class="line">[mysqld3307]</span><br><span class="line">datadir = /opt/data/3307</span><br><span class="line">port = 3307</span><br><span class="line">socket = /tmp/mysql3307.sock</span><br><span class="line">pid-file = /opt/data/3307/mysql_3307.pid</span><br><span class="line">log-error=/var/log/3307.log</span><br><span class="line"></span><br><span class="line">[mysqld3308]</span><br><span class="line">datadir = /opt/data/3308</span><br><span class="line">port = 3308</span><br><span class="line">socket = /tmp/mysql3308.sock</span><br><span class="line">pid-file = /opt/data/3308/mysql_3308.pid</span><br><span class="line">log-error=/var/log/3308.log</span><br></pre></td></tr></table></figure>

<p>启动各实例</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# mysqld_multi start 3306</span><br><span class="line">[root@localhost ~]# mysqld_multi start 3307</span><br><span class="line">[root@localhost ~]# mysqld_multi start 3308</span><br><span class="line">[root@localhost ~]# ss -antl</span><br><span class="line">State      Recv-Q Send-Q     Local Address:Port                    Peer Address:Port</span><br><span class="line">LISTEN     0      128                    *:22                                 *:*</span><br><span class="line">LISTEN     0      100            127.0.0.1:25                                 *:*</span><br><span class="line">LISTEN     0      80                    :::3307                              :::*</span><br><span class="line">LISTEN     0      80                    :::3308                              :::*</span><br><span class="line">LISTEN     0      128                   :::22                                :::*</span><br><span class="line">LISTEN     0      100                  ::1:25                                :::*</span><br><span class="line">LISTEN     0      80                    :::3306                              :::*</span><br></pre></td></tr></table></figure>

<p>初始化密码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# ls</span><br><span class="line">3306_pass  3307_pass  3308_pass  anaconda-ks.cfg</span><br><span class="line">[root@localhost ~]# cat 3306_pass</span><br><span class="line">AG/j:g?ob1CO</span><br><span class="line">[root@localhost ~]# mysql -uroot -p&apos;AG/j:g?ob1CO&apos; -S /tmp/mysql3306.sock</span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 3</span><br><span class="line">Server version: 5.7.22</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2018, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type &apos;help;&apos; or &apos;\h&apos; for help. Type &apos;\c&apos; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">mysql&gt; set password = password(&apos;itwhs123!&apos;);</span><br><span class="line">Query OK, 0 rows affected, 1 warning (0.01 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; quit</span><br><span class="line">Bye</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@localhost ~]# cat 3307_pass</span><br><span class="line">rfY5Ys(u:s!s</span><br><span class="line">[root@localhost ~]# mysql -uroot -p&apos;rfY5Ys(u:s!s&apos; -S /tmp/mysql3307.sock -e &apos;set password = password(&quot;itwhs123!&quot;);&apos; --connect-expired-password</span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@localhost ~]# cat 3308_pass</span><br><span class="line">+g9h.g(%g2&gt;E</span><br><span class="line">[root@localhost ~]# mysql -uroot -p&apos;+g9h.g(%g2&gt;E&apos; -S /tmp/mysql3308.sock -e &apos;set password = password(&quot;itwhs123!&quot;);&apos; --connect-expired-password</span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br></pre></td></tr></table></figure>
          
        
      
    </div>

    

    

    
    
    

    

    
      
    
    

    
	
	  <div>
        
      </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://aiwhs.github.io/2018/12/08/MySQL主从/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="itw">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="itw">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2018/12/08/MySQL主从/" class="post-title-link" itemprop="url">MySQL主从</a>
              
            
          </h1>
        

        <div class="post-meta">

          
          
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-12-08 08:15:57" itemprop="dateCreated datePublished" datetime="2018-12-08T08:15:57+08:00">2018-12-08</time>
            </span>
          

          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-07-17 16:12:23" itemprop="dateModified" datetime="2019-07-17T16:12:23+08:00">2019-07-17</time>
              </span>
            
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Linux运维/" itemprop="url" rel="index"><span itemprop="name">Linux运维</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          <br>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <a id="more"></a>

<h3 id="MySQL主从复制虽好，能完美解决数据库单点问题吗？"><a href="#MySQL主从复制虽好，能完美解决数据库单点问题吗？" class="headerlink" title="MySQL主从复制虽好，能完美解决数据库单点问题吗？"></a>MySQL主从复制虽好，能完美解决数据库单点问题吗？</h3><h4 id="一、单个数据库服务器的缺点"><a href="#一、单个数据库服务器的缺点" class="headerlink" title="一、单个数据库服务器的缺点"></a>一、单个数据库服务器的缺点</h4><ul>
<li>数据库服务器存在单点问题；</li>
<li>数据库服务器资源无法满足增长的读写请求；</li>
<li>高峰时数据库连接数经常超过上限。</li>
</ul>
<h4 id="二、如何解决单点问题"><a href="#二、如何解决单点问题" class="headerlink" title="二、如何解决单点问题"></a>二、如何解决单点问题</h4><ul>
<li>增加额外的数据库服务器，组建数据库集群；</li>
<li>同一集群中的数据库服务器需要具有相同的数据；</li>
<li>集群中的任一服务器宕机后，其它服务器可以取代宕机服务器。</li>
</ul>
<h4 id="三、MySQL主从复制架构"><a href="#三、MySQL主从复制架构" class="headerlink" title="三、MySQL主从复制架构"></a>三、MySQL主从复制架构</h4><p><strong>1、主库将变更写入到主库的binlog中</strong></p>
<ul>
<li>一些MySQL版本并不会开启二进制日志，所以一定要检查是否开启；</li>
<li>如果刚开始没有开启，后面再进行开启的话，需要重启数据库才能生效，而且数据库的重启往往会对业务造成很大的影响；</li>
<li>尽管二进制日志对性能有稍许的影响，所以还是建议大家无论是否使用复制功能，都要开启MySQL二进制日志，因为增量备份也需要二进制日志。</li>
</ul>
<p><strong>2、从库的IO线程在指定位置读取主库binlog内容存储到本地的中继日志（Relay Log）中</strong></p>
<p>要完成二进制日志的传输过程，MySQL会在从服务器上启动一个工作线程，称为IO线程，这个IO线程会跟主数据库建立一个普通的客户端连接，然后在主服务器上启动一个特殊的二进制转储线程称为binlogdown线程。</p>
<p>从库上的IO线程通过这个二进制转储线程来读取主库上的二进制事件，如果该事件追赶上主库，则会进入sleep状态，直到主库发起信号通知有新事件产生时，才会被唤醒，relay log的格式和binlog格式是完全相同的，</p>
<p>可以使用mysqlbinlog来读取relay log中的内容。</p>
<p><strong>3、从库的SQL线程读取Relay Log日志中的内容，并在从库中重放</strong></p>
<p>SQL线程所执行的事件，我们可以通过配置选项来决定是否要写入到从服务器的二进制日志中。</p>
<p>目前MySQL支持两种复制类型：</p>
<ul>
<li>基于二进制日志点的复制</li>
<li>基于GTID的复制（MySQL&gt;=5.7推荐使用）</li>
</ul>
<h4 id="四-主从复制的一些缺点"><a href="#四-主从复制的一些缺点" class="headerlink" title="四. 主从复制的一些缺点"></a>四. 主从复制的一些缺点</h4><p>虽然主从复制增加了一个数据库副本，但从数据库和主数据库的数据最终会是一致的。之所以说是最终一致，因为MySQL复制是异步的，正常情况下主从复制数据之间会有一个微小的延迟。</p>
<p>通过这个数据库副本看似解决了数据库单点问题，但并不完美：因为这种架构下，如果主服务器宕机，需要手动切换从服务器，业务中断不能忍受，不能满足应用高可用的要求。</p>
<h2 id="1-主从简介"><a href="#1-主从简介" class="headerlink" title="1.主从简介"></a>1.主从简介</h2><p>在现代企业中，数据显得尤为重要，而存储数据的数据库选择又五花八门，但无论是何种数据库，均存在着一种隐患。</p>
<p>想几个问题：</p>
<ul>
<li>用一台数据库存放数据，若此数据库服务器宕机了导致数据丢失怎么办？</li>
<li>业务量大了，数据多了，访问的人多了，一台数据库无法保证服务质量了怎么办？</li>
</ul>
<h3 id="1-1-主从作用"><a href="#1-1-主从作用" class="headerlink" title="1.1 主从作用"></a>1.1 主从作用</h3><ul>
<li>实时灾备，用于故障切换</li>
<li>读写分离，提供查询服务</li>
<li>备份，避免影响业务(这里说的备份是备份sql服务器,而不是备份数据)</li>
</ul>
<h3 id="1-2-主从形式"><a href="#1-2-主从形式" class="headerlink" title="1.2 主从形式"></a>1.2 主从形式</h3><p><img src="../../img/mysql_master_slave02.png" alt="img"></p>
<ul>
<li>一主一从</li>
<li>主主复制</li>
<li>一主多从—扩展系统读取的性能，因为读是在从库读取的</li>
<li>多主一从—5.7开始支持</li>
<li>联级复制</li>
</ul>
<h2 id="2-主从复制原理"><a href="#2-主从复制原理" class="headerlink" title="2. 主从复制原理"></a>2. 主从复制原理</h2><p><img src="../../img/mysql_master_slave01.png" alt="img2"></p>
<p><strong>主从复制步骤：</strong></p>
<ul>
<li>主库将所有的写操作记录到binlog日志中并生成一个log dump线程，将binlog日志传给从库的I/O线程</li>
<li>从库生成两个线程，一个I/O线程，一个SQL线程<ul>
<li>I/O线程去请求主库的binlog，并将得到的binlog日志写到relay log（中继日志） 文件中</li>
<li>SQL线程，会读取relay log文件中的日志，并解析成具体操作，来实现主从的操作一致，达到最终数据一致的目的</li>
</ul>
</li>
</ul>
<h2 id="3-主从复制配置"><a href="#3-主从复制配置" class="headerlink" title="3. 主从复制配置"></a>3. 主从复制配置</h2><p><strong>主从复制配置步骤：</strong></p>
<ol>
<li>确保从数据库与主数据库里的数据一样</li>
<li>在主数据库里创建一个同步账号授权给从数据库使用</li>
<li>配置主数据库（修改配置文件）</li>
<li>配置从数据库（修改配置文件）</li>
</ol>
<p><strong>需求：</strong><br>搭建两台<code>MySQL</code>服务器，一台作为主服务器，一台作为从服务器，主服务器进行写操作，从服务器进行读操作</p>
<p><strong>环境说明：</strong>Red Hat Enterprise Linux 8.0 (Ootpa)</p>
<p><img src="../../img/%E7%8E%AF%E5%A2%83.png" alt="环境"></p>
<h3 id="3-1-mysql安装"><a href="#3-1-mysql安装" class="headerlink" title="3.1 mysql安装"></a>3.1 mysql安装</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br></pre></td><td class="code"><pre><span class="line">[root@ip-10-0-10-70 ~]# dnf -y install wget vim</span><br><span class="line">[root@ip-10-0-10-70 ~]# groupadd -r mysql</span><br><span class="line">[root@ip-10-0-10-70 ~]# useradd -M -s /sbin/nologin -g mysql mysql</span><br><span class="line">[root@ip-10-0-10-70 ~]# mkdir /opt/data</span><br><span class="line">[root@ip-10-0-10-70 ~]# chown -R mysql.mysql /opt/data/</span><br><span class="line">[root@ip-10-0-10-70 ~]# ll /opt/</span><br><span class="line">total 0</span><br><span class="line">drwxr-xr-x. 2 mysql mysql 6 May 15 04:37 data</span><br><span class="line">[root@ip-10-0-10-70 ~]# wget https://downloads.mysql.com/archives/get/file/mysql-5.7.25-linux-glibc2.12-x86_64.tar.gz</span><br><span class="line">--2019-05-15 04:32:36--  https://downloads.mysql.com/archives/get/file/mysql-5.7.25-linux-glibc2.12-x86_64.tar.gz</span><br><span class="line">Resolving downloads.mysql.com (downloads.mysql.com)... 137.254.60.14</span><br><span class="line">Connecting to downloads.mysql.com (downloads.mysql.com)|137.254.60.14|:443... connected.</span><br><span class="line">HTTP request sent, awaiting response... 302 Found</span><br><span class="line">Location: https://cdn.mysql.com/archives/mysql-5.7/mysql-5.7.25-linux-glibc2.12-x86_64.tar.gz [following]</span><br><span class="line">--2019-05-15 04:32:37--  https://cdn.mysql.com/archives/mysql-5.7/mysql-5.7.25-linux-glibc2.12-x86_64.tar.gz</span><br><span class="line">Resolving cdn.mysql.com (cdn.mysql.com)... 23.35.197.183</span><br><span class="line">Connecting to cdn.mysql.com (cdn.mysql.com)|23.35.197.183|:443... connected.</span><br><span class="line">HTTP request sent, awaiting response... 200 OK</span><br><span class="line">......</span><br><span class="line">成功后615m大小</span><br><span class="line">发现下载速度太慢,决定共享这个二进制的源码包,既然在同一可用区,那么内网互通,就用了nfs,配置简单,快捷</span><br><span class="line">[root@ip-10-0-10-70 ~]# dnf -y install nfs* rpcbind*   //三台都执行这个命令</span><br><span class="line">[root@ip-10-0-10-70 ~]# mkdir /nfs</span><br><span class="line">[root@ip-10-0-10-70 ~]# vim /etc/exports</span><br><span class="line">/nfs *(rw)</span><br><span class="line">[root@ip-10-0-10-70 ~]# systemctl restart rpcbind nfs-server</span><br><span class="line">[root@ip-10-0-10-70 ~]# showmount -e 10.0.10.70</span><br><span class="line">Export list for 10.0.10.70:</span><br><span class="line">/nfs *</span><br><span class="line">[root@ip-10-0-10-70 ~]# mv mysql-5.7.25-linux-glibc2.12-x86_64.tar.gz /nfs/</span><br><span class="line">[root@ip-10-0-10-70 ~]# ls -lh /nfs/</span><br><span class="line">total 615M</span><br><span class="line">-rw-r--r--. 1 root root 615M Dec 21 10:24 mysql-5.7.25-linux-glibc2.12-x86_64.tar.gz</span><br><span class="line">从数据库1:</span><br><span class="line">[root@ip-10-0-10-86 ~]# mkdir /nfs1</span><br><span class="line">[root@ip-10-0-10-86 ~]# systemctl restart rpcbind</span><br><span class="line">[root@ip-10-0-10-86 ~]# mount -t nfs 10.0.10.70:/nfs /nfs1</span><br><span class="line">[root@ip-10-0-10-86 ~]# df -Th</span><br><span class="line">Filesystem      Type      Size  Used Avail Use% Mounted on</span><br><span class="line">devtmpfs        devtmpfs  391M     0  391M   0% /dev</span><br><span class="line">tmpfs           tmpfs     410M     0  410M   0% /dev/shm</span><br><span class="line">tmpfs           tmpfs     410M   11M  400M   3% /run</span><br><span class="line">tmpfs           tmpfs     410M     0  410M   0% /sys/fs/cgroup</span><br><span class="line">/dev/xvda2      xfs        10G  1.2G  8.9G  12% /</span><br><span class="line">tmpfs           tmpfs      82M     0   82M   0% /run/user/0</span><br><span class="line">10.0.10.70:/nfs nfs4       10G  1.8G  8.3G  18% /nfs1</span><br><span class="line">[root@ip-10-0-10-86 ~]# ls -lh /nfs1/</span><br><span class="line">total 615M</span><br><span class="line">-rw-r--r--. 1 root root 615M Dec 21 10:24 mysql-5.7.25-linux-glibc2.12-x86_64.tar.gz</span><br><span class="line">从数据库2:</span><br><span class="line">[root@ip-10-0-10-39 ~]# mkdir /nfs2</span><br><span class="line">[root@ip-10-0-10-39 ~]# systemctl restart rpcbind</span><br><span class="line">[root@ip-10-0-10-39 ~]# mount -t nfs 10.0.10.70:/nfs /nfs2</span><br><span class="line">[root@ip-10-0-10-39 ~]# df -Th</span><br><span class="line">Filesystem      Type      Size  Used Avail Use% Mounted on</span><br><span class="line">devtmpfs        devtmpfs  391M     0  391M   0% /dev</span><br><span class="line">tmpfs           tmpfs     410M     0  410M   0% /dev/shm</span><br><span class="line">tmpfs           tmpfs     410M   11M  400M   3% /run</span><br><span class="line">tmpfs           tmpfs     410M     0  410M   0% /sys/fs/cgroup</span><br><span class="line">/dev/xvda2      xfs        10G  1.2G  8.9G  12% /</span><br><span class="line">tmpfs           tmpfs      82M     0   82M   0% /run/user/0</span><br><span class="line">10.0.10.70:/nfs nfs4       10G  1.8G  8.3G  18% /nfs2</span><br><span class="line">[root@ip-10-0-10-39 ~]# ls -lh /nfs2/</span><br><span class="line">total 615M</span><br><span class="line">-rw-r--r--. 1 root root 615M Dec 21 10:24 mysql-5.7.25-linux-glibc2.12-x86_64.tar.gz</span><br><span class="line"></span><br><span class="line">安装开始:</span><br><span class="line">[root@ip-10-0-10-70 nfs]# tar xf mysql-5.7.25-linux-glibc2.12-x86_64.tar.gz -C /usr/local/</span><br><span class="line">[root@ip-10-0-10-70 nfs]# cd /usr/local/</span><br><span class="line">[root@ip-10-0-10-70 local]# ln -sv mysql-5.7.25-linux-glibc2.12-x86_64/ mysql</span><br><span class="line">&apos;mysql&apos; -&gt; &apos;mysql-5.7.25-linux-glibc2.12-x86_64/&apos;</span><br><span class="line">[root@ip-10-0-10-70 local]# chown -R mysql.mysql /usr/local/mysql</span><br><span class="line">[root@ip-10-0-10-70 local]# ll /usr/local/mysql -d</span><br><span class="line">lrwxrwxrwx. 1 mysql mysql 36 May 15 05:55 /usr/local/mysql -&gt; mysql-5.7.25-linux-glibc2.12-x86_64/</span><br><span class="line">[root@ip-10-0-10-70 local]# ls /usr/local/mysql</span><br><span class="line">bin  COPYING  docs  include  lib  man  README  share  support-files</span><br><span class="line">[root@ip-10-0-10-70 local]# echo &apos;export PATH=/usr/local/mysql/bin:$PATH&apos; &gt; /etc/profile.d/mysql.sh</span><br><span class="line">[root@ip-10-0-10-70 local]# source /etc/profile.d/mysql.sh</span><br><span class="line">[root@ip-10-0-10-70 local]# echo $PATH</span><br><span class="line">/usr/local/mysql/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/root/bin</span><br><span class="line">初始化数据库</span><br><span class="line">[root@ip-10-0-10-70 ~]# /usr/local/mysql/bin/mysqld --initialize --user=mysql --datadir=/opt/data/</span><br><span class="line">/usr/local/mysql/bin/mysqld: error while loading shared libraries: libaio.so.1: cannot open shared object file: No such file or directory</span><br><span class="line">解决方法:</span><br><span class="line">[root@ip-10-0-10-70 ~]# dnf -y install libaio*    //另外2个也要安装</span><br><span class="line">[root@ip-10-0-10-70 ~]# /usr/local/mysql/bin/mysqld --initialize --user=mysql --datadir=/opt/data/</span><br><span class="line">2019-05-15T06:05:26.411877Z 0 [Warning] TIMESTAMP with implicit DEFAULT value is deprecated. Please use --explicit_defaults_for_timestamp server option (see documentation for more details).</span><br><span class="line">2019-05-15T06:05:27.226596Z 0 [Warning] InnoDB: New log files created, LSN=45790</span><br><span class="line">2019-05-15T06:05:27.469528Z 0 [Warning] InnoDB: Creating foreign key constraint system tables.</span><br><span class="line">2019-05-15T06:05:27.532234Z 0 [Warning] No existing UUID has been found, so we assume that this is the first time that this server has been started. Generating a new UUID: 6faf638d-76d7-11e9-a710-061fe46abf16.</span><br><span class="line">2019-05-15T06:05:27.533755Z 0 [Warning] Gtid table is not ready to be used. Table &apos;mysql.gtid_executed&apos; cannot be opened.</span><br><span class="line">2019-05-15T06:05:27.534192Z 1 [Note] A temporary password is generated for root@localhost: dgjdbs6vi.6T</span><br><span class="line">[root@ip-10-0-10-70 ~]# echo &apos;dgjdbs6vi.6T&apos; &gt;pass</span><br><span class="line">[root@ip-10-0-10-70 ~]# cat pass </span><br><span class="line">dgjdbs6vi.6T    //初始密码,要记住,一会要用</span><br><span class="line">生成配置文件</span><br><span class="line">[root@ip-10-0-10-70 ~]# cat &gt;/etc/my.cnf &lt;&lt;EOF</span><br><span class="line">&gt; [mysqld]</span><br><span class="line">&gt; basedir = /usr/local/mysql</span><br><span class="line">&gt; datadir = /opt/data</span><br><span class="line">&gt; socket = /tmp/mysql.sock</span><br><span class="line">&gt; port = 3306</span><br><span class="line">&gt; pid-file = /opt/data/mysql.pid</span><br><span class="line">&gt; user = mysql</span><br><span class="line">&gt; skip-name-resolve</span><br><span class="line">&gt; EOF</span><br><span class="line">配置服务启动脚本</span><br><span class="line">[root@ip-10-0-10-70 ~]# cp -a /usr/local/mysql/support-files/mysql.server /etc/init.d/mysqld</span><br><span class="line">[root@ip-10-0-10-70 ~]# sed -ri &apos;s#^(basedir=).*#\1/usr/local/mysql#g&apos; /etc/init.d/mysqld</span><br><span class="line">[root@ip-10-0-10-70 ~]# sed -ri &apos;s#^(datadir=).*#\1/opt/data#g&apos; /etc/init.d/mysqld</span><br><span class="line">启动mysql</span><br><span class="line">[root@ip-10-0-10-70 ~]# /etc/init.d/mysqld start</span><br><span class="line">Starting MySQL.Logging to &apos;/opt/data/ip-10-0-10-70.ap-northeast-1.compute.internal.err&apos;.</span><br><span class="line"> SUCCESS! </span><br><span class="line">[root@ip-10-0-10-70 ~]# ps -ef|grep mysql</span><br><span class="line">root     15530     1  0 06:13 pts/1    00:00:00 /bin/sh /usr/local/mysql/bin/mysqld_safe --datadir=/opt/data --pid-file=/opt/data/mysql.pid</span><br><span class="line">mysql    15718 15530  2 06:13 pts/1    00:00:00 /usr/local/mysql/bin/mysqld --basedir=/usr/local/mysql --datadir=/opt/data --plugin-dir=/usr/local/mysql/lib/plugin --user=mysql --log-error=ip-10-0-10-70.ap-northeast-1.compute.internal.err --pid-file=/opt/data/mysql.pid --socket=/tmp/mysql.sock --port=3306</span><br><span class="line">root     15748 15355  0 06:13 pts/1    00:00:00 grep --color=auto mysql</span><br><span class="line">[root@ip-10-0-10-70 ~]# ss -antl</span><br><span class="line">State     Recv-Q     Send-Q           Local Address:Port            Peer Address:Port     </span><br><span class="line">LISTEN    0          128                    0.0.0.0:22                   0.0.0.0:*        </span><br><span class="line">LISTEN    0          64                     0.0.0.0:39517                0.0.0.0:*        </span><br><span class="line">LISTEN    0          64                     0.0.0.0:2049                 0.0.0.0:*        </span><br><span class="line">LISTEN    0          128                    0.0.0.0:48229                0.0.0.0:*        </span><br><span class="line">LISTEN    0          128                    0.0.0.0:111                  0.0.0.0:*        </span><br><span class="line">LISTEN    0          128                    0.0.0.0:20048                0.0.0.0:*        </span><br><span class="line">LISTEN    0          128                       [::]:22                      [::]:*        </span><br><span class="line">LISTEN    0          64                        [::]:2049                    [::]:*        </span><br><span class="line">LISTEN    0          128                       [::]:48385                   [::]:*        </span><br><span class="line">LISTEN    0          80                           *:3306                       *:*        </span><br><span class="line">LISTEN    0          64                        [::]:40523                   [::]:*        </span><br><span class="line">LISTEN    0          128                       [::]:111                     [::]:*        </span><br><span class="line">LISTEN    0          128                       [::]:20048                   [::]:*</span><br><span class="line">修改密码</span><br><span class="line">使用临时密码登录</span><br><span class="line">[root@ip-10-0-10-70 ~]# /usr/local/mysql/bin/mysql -uroot -p</span><br><span class="line">/usr/local/mysql/bin/mysql: error while loading shared libraries: libncurses.so.5: cannot open shared object file: No such file or directory</span><br><span class="line">解决方法</span><br><span class="line">[root@ip-10-0-10-70 ~]# dnf -y install libncurses*</span><br><span class="line">[root@ip-10-0-10-70 ~]# /usr/local/mysql/bin/mysql -uroot -p</span><br><span class="line">Enter password: </span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 2</span><br><span class="line">Server version: 5.7.25</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2019, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type &apos;help;&apos; or &apos;\h&apos; for help. Type &apos;\c&apos; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">mysql&gt; set password = password(&apos;jbgsn123!&apos;);</span><br><span class="line">Query OK, 0 rows affected, 1 warning (0.01 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; exit</span><br><span class="line">Bye</span><br><span class="line">[root@ip-10-0-10-70 ~]# cp /etc/my.cnf /nfs/</span><br><span class="line">[root@ip-10-0-10-70 ~]# cp /etc/init.d/mysqld /nfs/</span><br><span class="line">[root@ip-10-0-10-70 ~]# ll /nfs/</span><br><span class="line">total 629768</span><br><span class="line">-rw-r--r--. 1 root root        155 May 15 06:20 my.cnf</span><br><span class="line">-rw-r--r--. 1 7161 31415 644862820 Dec 21 11:23 mysql-5.7.25-linux-glibc2.12-x86_64.tar.gz</span><br><span class="line">-rwxr-xr-x. 1 root root      10601 May 15 06:20 mysqld</span><br><span class="line">从服务器方法一样,特此写一个</span><br><span class="line">[root@ip-10-0-10-86 nfs1]# tar xf mysql-5.7.25-linux-glibc2.12-x86_64.tar -C /usr/local/</span><br><span class="line">[root@ip-10-0-10-86 nfs1]# cd /usr/local/</span><br><span class="line">[root@ip-10-0-10-86 local]# ln -sv mysql-5.7.25-linux-glibc2.12-x86_64/ mysql</span><br><span class="line">&apos;mysql&apos; -&gt; &apos;mysql-5.7.25-linux-glibc2.12-x86_64/&apos;</span><br><span class="line">[root@ip-10-0-10-86 local]# chown -R mysql.mysql /usr/local/mysql</span><br><span class="line">[root@ip-10-0-10-86 local]# echo &apos;export PATH=/usr/local/mysql/bin:$PATH&apos; &gt; /etc/profile.d/mysql.sh</span><br><span class="line">[root@ip-10-0-10-86 local]# source /etc/profile.d/mysql.sh</span><br><span class="line">[root@ip-10-0-10-86 local]# /usr/local/mysql/bin/mysqld --initialize --user=mysql --datadir=/opt/data/</span><br><span class="line">2019-05-15T06:25:33.161453Z 0 [Warning] TIMESTAMP with implicit DEFAULT value is deprecated. Please use --explicit_defaults_for_timestamp server option (see documentation for more details).</span><br><span class="line">2019-05-15T06:25:33.981113Z 0 [Warning] InnoDB: New log files created, LSN=45790</span><br><span class="line">2019-05-15T06:25:34.223408Z 0 [Warning] InnoDB: Creating foreign key constraint system tables.</span><br><span class="line">2019-05-15T06:25:34.284942Z 0 [Warning] No existing UUID has been found, so we assume that this is the first time that this server has been started. Generating a new UUID: 3ef73d2c-76da-11e9-bea1-06dc2c9b3f12.</span><br><span class="line">2019-05-15T06:25:34.286543Z 0 [Warning] Gtid table is not ready to be used. Table &apos;mysql.gtid_executed&apos; cannot be opened.</span><br><span class="line">2019-05-15T06:25:34.286983Z 1 [Note] A temporary password is generated for root@localhost: q%_H12.OAvta</span><br><span class="line">[root@ip-10-0-10-86 local]# echo &apos;q%_H12.OAvta&apos;&gt;pass</span><br><span class="line">[root@ip-10-0-10-86 local]# cp /nfs1/my.cnf /etc/</span><br><span class="line">[root@ip-10-0-10-86 local]# cp /nfs1/mysqld /etc/init.d/</span><br><span class="line">[root@ip-10-0-10-86 local]# /etc/init.d/mysqld start</span><br><span class="line">Starting MySQL.Logging to &apos;/opt/data/ip-10-0-10-86.ap-northeast-1.compute.internal.err&apos;.</span><br><span class="line"> SUCCESS! </span><br><span class="line">[root@ip-10-0-10-86 local]# /usr/local/mysql/bin/mysql -uroot -p</span><br><span class="line">Enter password: </span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 2</span><br><span class="line">Server version: 5.7.25</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2019, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type &apos;help;&apos; or &apos;\h&apos; for help. Type &apos;\c&apos; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">mysql&gt; set password = password(&apos;jbgsn123!&apos;);</span><br><span class="line">Query OK, 0 rows affected, 1 warning (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; quit</span><br><span class="line">Bye</span><br><span class="line">三个服务器上MySQL密码都是jbgsn123!,配置一样</span><br></pre></td></tr></table></figure>

<h3 id="3-2-mysql主从配置-2个新的mysql服务器"><a href="#3-2-mysql主从配置-2个新的mysql服务器" class="headerlink" title="3.2 mysql主从配置(2个新的mysql服务器)"></a>3.2 mysql主从配置(2个新的mysql服务器)</h3><h4 id="3-2-1-在主数据库里创建一个同步账号授权给从数据库使用"><a href="#3-2-1-在主数据库里创建一个同步账号授权给从数据库使用" class="headerlink" title="3.2.1 在主数据库里创建一个同步账号授权给从数据库使用"></a>3.2.1 在主数据库里创建一个同步账号授权给从数据库使用</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; create user &apos;whs&apos;@&apos;10.0.10.86&apos; identified by &apos;itwhs1&apos;;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; grant replication slave on *.* to &apos;whs&apos;@&apos;10.0.10.86&apos;;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; flush privileges;</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br></pre></td></tr></table></figure>

<h4 id="3-2-2-配置主数据库"><a href="#3-2-2-配置主数据库" class="headerlink" title="3.2.2 配置主数据库"></a>3.2.2 配置主数据库</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[root@ip-10-0-10-70 ~]# vim /etc/my.cnf </span><br><span class="line">在[mysqld]这段的后面加上如下内容</span><br><span class="line">[mysqld]</span><br><span class="line">basedir = /usr/local/mysql</span><br><span class="line">datadir = /opt/data</span><br><span class="line">socket = /tmp/mysql.sock</span><br><span class="line">port = 3306</span><br><span class="line">pid-file = /opt/data/mysql.pid</span><br><span class="line">user = mysql</span><br><span class="line">skip-name-resolve</span><br><span class="line">log-bin = mysql-bin    //启用binlog日志</span><br><span class="line">server-id = 1    //数据库服务器唯一标识符，主库的server-id值必须比从库的大</span><br><span class="line">log-error = /var/log/mysqld.log   //记录错误日志</span><br><span class="line"></span><br><span class="line">重启mysql服务</span><br><span class="line">[root@ip-10-0-10-70 ~]# /etc/init.d/mysqld restart</span><br><span class="line">Shutting down MySQL.. SUCCESS! </span><br><span class="line">Starting MySQL. SUCCESS!</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">查看主库的状态</span><br><span class="line">[root@ip-10-0-10-70 ~]# /usr/local/mysql/bin/mysql -uroot -pjbgsn123! -e &apos;show master status;&apos;</span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">+------------------+----------+--------------+------------------+-------------------+</span><br><span class="line">| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |</span><br><span class="line">+------------------+----------+--------------+------------------+-------------------+</span><br><span class="line">| mysql-bin.000001 |      154 |              |                  |                   |</span><br><span class="line">+------------------+----------+--------------+------------------+-------------------+</span><br></pre></td></tr></table></figure>

<h4 id="3-2-3-配置从数据库"><a href="#3-2-3-配置从数据库" class="headerlink" title="3.2.3 配置从数据库"></a>3.2.3 配置从数据库</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">[root@ip-10-0-10-86 ~]# vim /etc/my.cnf</span><br><span class="line">添加如下内容</span><br><span class="line">[mysqld]</span><br><span class="line">basedir = /usr/local/mysql</span><br><span class="line">datadir = /opt/data</span><br><span class="line">socket = /tmp/mysql.sock</span><br><span class="line">port = 3306</span><br><span class="line">pid-file = /opt/data/mysql.pid</span><br><span class="line">user = mysql</span><br><span class="line">skip-name-resolve</span><br><span class="line">server-id=2    //设置从库的唯一标识符，从库的server-id值必须小于主库的该值</span><br><span class="line">relay-log=mysql-relay-bin    //启用中继日志relay-log     </span><br><span class="line">symbolic-links=0</span><br><span class="line">log-error=/var/log/mysqld.log</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">重启从库的mysql服务</span><br><span class="line">[root@ip-10-0-10-86 ~]# /etc/init.d/mysqld restart</span><br><span class="line">Shutting down MySQL.. SUCCESS! </span><br><span class="line">Starting MySQL. SUCCESS!</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">配置并启动主从复制</span><br><span class="line">[root@ip-10-0-10-86 ~]# /usr/local/mysql/bin/mysql -uroot -pjbgsn123!</span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 2</span><br><span class="line">Server version: 5.7.25 MySQL Community Server (GPL)</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2019, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type &apos;help;&apos; or &apos;\h&apos; for help. Type &apos;\c&apos; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">mysql&gt; change master to</span><br><span class="line">    -&gt; master_host=&apos;10.0.10.70&apos;,</span><br><span class="line">    -&gt; master_user=&apos;whs&apos;,</span><br><span class="line">    -&gt; master_password=&apos;itwhs1&apos;,</span><br><span class="line">    -&gt; master_log_file=&apos;mysql-bin.000001&apos;,</span><br><span class="line">    -&gt; master_log_pos=154;</span><br><span class="line">Query OK, 0 rows affected, 2 warnings (0.02 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; start slave;</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; show slave status \G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">               Slave_IO_State: Waiting for master to send event</span><br><span class="line">                  Master_Host: 10.0.10.70</span><br><span class="line">                  Master_User: whs</span><br><span class="line">                  Master_Port: 3306</span><br><span class="line">                Connect_Retry: 60</span><br><span class="line">              Master_Log_File: mysql-bin.000001</span><br><span class="line">          Read_Master_Log_Pos: 154</span><br><span class="line">               Relay_Log_File: mysql-relay-bin.000002</span><br><span class="line">                Relay_Log_Pos: 320</span><br><span class="line">        Relay_Master_Log_File: mysql-bin.000001</span><br><span class="line">             Slave_IO_Running: Yes      //此处必须为Yes</span><br><span class="line">            Slave_SQL_Running: Yes      //此处必须为Yes</span><br><span class="line">              Replicate_Do_DB:</span><br><span class="line">          Replicate_Ignore_DB:</span><br></pre></td></tr></table></figure>

<h4 id="3-2-4-测试验证"><a href="#3-2-4-测试验证" class="headerlink" title="3.2.4 测试验证"></a>3.2.4 测试验证</h4><p><strong>在主服务器创建aiwhs库和it表并插入数据：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; create database aiwhs;</span><br><span class="line">Query OK, 1 row affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; use aiwhs;</span><br><span class="line">Database changed</span><br><span class="line">mysql&gt; create table it (id mediumint not null auto_increment,name char(30) not null,age tinyint,primary key (id));</span><br><span class="line">Query OK, 0 rows affected (0.02 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; insert into it(name,age) values(&apos;zhangshan&apos;,26),(&apos;zhangshan&apos;,20),(&apos;lisi&apos;,null),(&apos;chenshuo&apos;,10),(&apos;wangwu&apos;,3);</span><br><span class="line">Query OK, 5 rows affected (0.01 sec)</span><br><span class="line">Records: 5  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from it;</span><br><span class="line">+----+-----------+------+</span><br><span class="line">| id | name      | age  |</span><br><span class="line">+----+-----------+------+</span><br><span class="line">|  1 | zhangshan |   26 |</span><br><span class="line">|  2 | zhangshan |   20 |</span><br><span class="line">|  3 | lisi      | NULL |</span><br><span class="line">|  4 | chenshuo  |   10 |</span><br><span class="line">|  5 | wangwu    |    3 |</span><br><span class="line">+----+-----------+------+</span><br><span class="line">5 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<p><strong>在从数据库中查看数据是否同步：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@ip-10-0-10-86 ~]# /usr/local/mysql/bin/mysql -uroot -pjbgsn123! -e &apos;select * from aiwhs.it;&apos;</span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">+----+-----------+------+</span><br><span class="line">| id | name      | age  |</span><br><span class="line">+----+-----------+------+</span><br><span class="line">|  1 | zhangshan |   26 |</span><br><span class="line">|  2 | zhangshan |   20 |</span><br><span class="line">|  3 | lisi      | NULL |</span><br><span class="line">|  4 | chenshuo  |   10 |</span><br><span class="line">|  5 | wangwu    |    3 |</span><br><span class="line">+----+-----------+------+</span><br></pre></td></tr></table></figure>

<h3 id="3-3-mysql主从配置"><a href="#3-3-mysql主从配置" class="headerlink" title="3.3 mysql主从配置"></a>3.3 mysql主从配置</h3><h4 id="3-3-1-确保从数据库与主数据库里的数据一样"><a href="#3-3-1-确保从数据库与主数据库里的数据一样" class="headerlink" title="3.3.1 确保从数据库与主数据库里的数据一样"></a>3.3.1 确保从数据库与主数据库里的数据一样</h4><p>为确保从数据库与主数据库里的数据一样，先全备主数据库并还原到从数据库中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">先查看主库有哪些库</span><br><span class="line">[root@ip-10-0-10-70 ~]# mysql -uroot -pjbgsn123! -e &apos;show databases;&apos;</span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| aiwhs              |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| sys                |</span><br><span class="line">+--------------------+</span><br><span class="line"></span><br><span class="line">再查看从库有哪些库</span><br><span class="line">[root@ip-10-0-10-39 ~]# mysql -uroot -pjbgsn123! -e &apos;show databases;&apos;</span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| sys                |</span><br><span class="line">+--------------------+</span><br><span class="line"></span><br><span class="line">全备主库</span><br><span class="line">全备主库时需要另开一个终端，给数据库加上读锁，避免在备份期间有其他人在写入导致数据不一致</span><br><span class="line">mysql&gt; flush tables with read lock;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line">此锁表的终端必须在备份完成以后才能退出</span><br><span class="line"></span><br><span class="line">备份主库并将备份文件传送到从库</span><br><span class="line">[root@ip-10-0-10-70 ~]# mysqldump -uroot -pjbgsn123! --all-databases &gt;/nfs/all-201905151548.sql</span><br><span class="line">mysqldump: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">[root@ip-10-0-10-70 ~]# ls /nfs/</span><br><span class="line">all-201905151548.sql  my.cnf  mysql-5.7.25-linux-glibc2.12-x86_64.tar.gz  mysqld</span><br><span class="line"></span><br><span class="line">解除主库的锁表状态，直接退出交互式界面即可</span><br><span class="line">mysql&gt; quit</span><br><span class="line">Bye</span><br><span class="line"></span><br><span class="line">在从库上恢复主库的备份并查看从库有哪些库，确保与主库一致</span><br><span class="line">[root@ip-10-0-10-39 ~]# cd /nfs2/</span><br><span class="line">[root@ip-10-0-10-39 nfs2]# ll</span><br><span class="line">total 630544</span><br><span class="line">-rw-r--r--. 1 root root     792967 May 15 07:50 all-201905151548.sql</span><br><span class="line">-rw-r--r--. 1 root root        155 May 15 06:20 my.cnf</span><br><span class="line">-rw-r--r--. 1 7161 31415 644862820 Dec 21 11:23 mysql-5.7.25-linux-glibc2.12-x86_64.tar.gz</span><br><span class="line">-rwxr-xr-x. 1 root root      10601 May 15 06:20 mysqld</span><br><span class="line">[root@ip-10-0-10-39 nfs2]# mysql -uroot -pjbgsn123! &lt; all-201905151548.sql </span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">[root@ip-10-0-10-39 nfs2]# mysql -uroot -pjbgsn123! -e &apos;show databases;&apos;</span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| aiwhs              |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| sys                |</span><br><span class="line">+--------------------+</span><br></pre></td></tr></table></figure>

<h4 id="3-3-2-在主数据库里创建一个同步账号授权给从数据库使用"><a href="#3-3-2-在主数据库里创建一个同步账号授权给从数据库使用" class="headerlink" title="3.3.2 在主数据库里创建一个同步账号授权给从数据库使用"></a>3.3.2 在主数据库里创建一个同步账号授权给从数据库使用</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; create user &apos;whs&apos;@&apos;10.0.10.39&apos; identified by &apos;itwhs2&apos;;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; grant replication slave on *.* to &apos;whs&apos;@&apos;10.0.10.39&apos;;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; flush privileges;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure>

<h4 id="3-3-3-配置主数据库"><a href="#3-3-3-配置主数据库" class="headerlink" title="3.3.3 配置主数据库"></a>3.3.3 配置主数据库</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[root@ip-10-0-10-70 ~]# /etc/init.d/mysqld restart</span><br><span class="line">Shutting down MySQL............ SUCCESS! </span><br><span class="line">Starting MySQL. SUCCESS!</span><br><span class="line"></span><br><span class="line">查看主库的状态</span><br><span class="line">mysql&gt; show master status;</span><br><span class="line">+------------------+----------+--------------+------------------+-------------------+</span><br><span class="line">| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |</span><br><span class="line">+------------------+----------+--------------+------------------+-------------------+</span><br><span class="line">| mysql-bin.000003 |      154 |              |                  |                   |</span><br><span class="line">+------------------+----------+--------------+------------------+-------------------+</span><br><span class="line">1 row in set (0.00 sec)  //发现,重启mysql后log-bin会变,position也会变,之前配的从服务器大约10秒后会同步状态</span><br><span class="line"></span><br><span class="line">上一个从服务器同步状态</span><br><span class="line">mysql&gt; show slave status \G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">               Slave_IO_State: Waiting for master to send event</span><br><span class="line">                  Master_Host: 10.0.10.70</span><br><span class="line">                  Master_User: whs</span><br><span class="line">                  Master_Port: 3306</span><br><span class="line">                Connect_Retry: 60</span><br><span class="line">              Master_Log_File: mysql-bin.000003</span><br><span class="line">          Read_Master_Log_Pos: 154</span><br><span class="line">               Relay_Log_File: mysql-relay-bin.000006</span><br><span class="line">                Relay_Log_Pos: 367</span><br><span class="line">        Relay_Master_Log_File: mysql-bin.000003</span><br><span class="line">             Slave_IO_Running: Yes</span><br><span class="line">            Slave_SQL_Running: Yes</span><br></pre></td></tr></table></figure>

<h4 id="3-3-4-配置从数据库"><a href="#3-3-4-配置从数据库" class="headerlink" title="3.3.4 配置从数据库"></a>3.3.4 配置从数据库</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">[root@ip-10-0-10-39 ~]# vim /etc/my.cnf</span><br><span class="line">添加如下内容</span><br><span class="line">[mysqld]</span><br><span class="line">basedir = /usr/local/mysql</span><br><span class="line">datadir = /opt/data</span><br><span class="line">socket = /tmp/mysql.sock</span><br><span class="line">port = 3306</span><br><span class="line">pid-file = /opt/data/mysql.pid</span><br><span class="line">user = mysql</span><br><span class="line">skip-name-resolve</span><br><span class="line">server-id = 3   //设置从库的唯一标识符，从库的server-id值必须小于主库的该值</span><br><span class="line">relay-log = mysql-relay-bin    //启用中继日志relay-log     </span><br><span class="line">symbolic-links = 0</span><br><span class="line">log-error = /var/log/mysqld.log</span><br><span class="line"></span><br><span class="line">重启从库的mysql服务</span><br><span class="line">[root@ip-10-0-10-39 ~]# /etc/init.d/mysqld restart</span><br><span class="line">Shutting down MySQL.. SUCCESS! </span><br><span class="line">Starting MySQL. SUCCESS!</span><br><span class="line"></span><br><span class="line">配置并启动主从复制</span><br><span class="line">mysql&gt; change master to</span><br><span class="line">    -&gt; master_host=&apos;10.0.10.70&apos;,</span><br><span class="line">    -&gt; master_user=&apos;whs&apos;,</span><br><span class="line">    -&gt; master_password=&apos;itwhs2&apos;,</span><br><span class="line">    -&gt; master_log_file=&apos;mysql-bin.000003&apos;,</span><br><span class="line">    -&gt; master_log_pos=154;</span><br><span class="line">Query OK, 0 rows affected, 2 warnings (0.02 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; start slave;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; show slave status \G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">               Slave_IO_State: Waiting for master to send event</span><br><span class="line">                  Master_Host: 10.0.10.70</span><br><span class="line">                  Master_User: whs</span><br><span class="line">                  Master_Port: 3306</span><br><span class="line">                Connect_Retry: 60</span><br><span class="line">              Master_Log_File: mysql-bin.000003</span><br><span class="line">          Read_Master_Log_Pos: 154</span><br><span class="line">               Relay_Log_File: mysql-relay-bin.000002</span><br><span class="line">                Relay_Log_Pos: 320</span><br><span class="line">        Relay_Master_Log_File: mysql-bin.000003</span><br><span class="line">             Slave_IO_Running: Yes</span><br><span class="line">            Slave_SQL_Running: Yes</span><br></pre></td></tr></table></figure>

<h4 id="3-3-5-测试验证"><a href="#3-3-5-测试验证" class="headerlink" title="3.3.5 测试验证"></a>3.3.5 测试验证</h4><p><strong>在主服务器的aiwhs库的it表中插入数据：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; insert into it(name,age) values(&apos;dbf&apos;,26),(&apos;nfgb&apos;,56),(&apos;gsd&apos;,54),(&apos;sfs&apos;,33); </span><br><span class="line">Query OK, 4 rows affected (0.01 sec)</span><br><span class="line">Records: 4  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from it;</span><br><span class="line">+----+-----------+------+</span><br><span class="line">| id | name      | age  |</span><br><span class="line">+----+-----------+------+</span><br><span class="line">|  1 | zhangshan |   26 |</span><br><span class="line">|  2 | zhangshan |   20 |</span><br><span class="line">|  3 | lisi      | NULL |</span><br><span class="line">|  4 | chenshuo  |   10 |</span><br><span class="line">|  5 | wangwu    |    3 |</span><br><span class="line">|  6 | dbf       |   26 |</span><br><span class="line">|  7 | nfgb      |   56 |</span><br><span class="line">|  8 | gsd       |   54 |</span><br><span class="line">|  9 | sfs       |   33 |</span><br><span class="line">+----+-----------+------+</span><br><span class="line">9 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<p><strong>在从数据库中查看数据是否同步：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@ip-10-0-10-39 ~]# mysql -uroot -pjbgsn123! -e &apos;select * from aiwhs.it;&apos;</span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">+----+-----------+------+</span><br><span class="line">| id | name      | age  |</span><br><span class="line">+----+-----------+------+</span><br><span class="line">|  1 | zhangshan |   26 |</span><br><span class="line">|  2 | zhangshan |   20 |</span><br><span class="line">|  3 | lisi      | NULL |</span><br><span class="line">|  4 | chenshuo  |   10 |</span><br><span class="line">|  5 | wangwu    |    3 |</span><br><span class="line">|  6 | dbf       |   26 |</span><br><span class="line">|  7 | nfgb      |   56 |</span><br><span class="line">|  8 | gsd       |   54 |</span><br><span class="line">|  9 | sfs       |   33 |</span><br><span class="line">+----+-----------+------+</span><br></pre></td></tr></table></figure>
          
        
      
    </div>

    

    

    
    
    

    

    
      
    
    

    
	
	  <div>
        
      </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://aiwhs.github.io/2018/12/02/三种代理的简单总结/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="itw">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="itw">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2018/12/02/三种代理的简单总结/" class="post-title-link" itemprop="url">三种代理</a>
              
            
          </h1>
        

        <div class="post-meta">

          
          
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-12-02 08:15:57" itemprop="dateCreated datePublished" datetime="2018-12-02T08:15:57+08:00">2018-12-02</time>
            </span>
          

          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-07-11 20:22:10" itemprop="dateModified" datetime="2019-07-11T20:22:10+08:00">2019-07-11</time>
              </span>
            
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Linux运维/" itemprop="url" rel="index"><span itemprop="name">Linux运维</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          <br>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <a id="more"></a>

<h2 id="正向代理、反向代理以及透明代理的简单总结"><a href="#正向代理、反向代理以及透明代理的简单总结" class="headerlink" title="正向代理、反向代理以及透明代理的简单总结"></a>正向代理、反向代理以及透明代理的简单总结</h2><p>代理服务技术是一门很古老的技术，是在互联网早期出现就使用的技术。一般实现代理技术的方式就是在服务器上安装代理服务软件，让其成为一个代理服务器，从而实现代理技术。常用的代理技术分为正向代理、反向代理和透明代理。</p>
<h3 id="1-正向代理服务器"><a href="#1-正向代理服务器" class="headerlink" title="1.正向代理服务器"></a>1.正向代理服务器</h3><p>正向代理服务器位于用户与目标服务器之间，用户通过对代理服务器发送指向目标服务器的请求来获得资源。用户端需要作一些设定才可以使用正向代理服务器，而反向/透明代理服务器是不需要对用户端进行任何设定的。</p>
<p><img src="../../img/1559291821892525.png" alt="正向代理服务器"></p>
<h3 id="2-反向代理服务器"><a href="#2-反向代理服务器" class="headerlink" title="2.反向代理服务器"></a>2.反向代理服务器</h3><p>反向代理服务器同样位于用户与目标服务器之间，但对于用户而言，反向代理服务器就相当于目标服务器，即用户直接访问反向代理服务器就可以获得目标服务器的资源。同时，用户不需要知道目标服务器地址，也无需在用户端作任何设定。反向代理服务器通常可用来作Web加速，即使用反向代理作为Web服务器的前置机来降低网络和服务器的负载，提高访问效率。</p>
<p><img src="../../img/1559291828305494.png" alt="反向代理服务器"></p>
<h3 id="3-透明代理服务器"><a href="#3-透明代理服务器" class="headerlink" title="3.透明代理服务器"></a>3.透明代理服务器</h3><p>透明代理服务器位于于用户与目标服务器之间.和前两种服务器不同的是，用户即不需要对客户端进行任何设定，也无需知道代理服务器的地址。用户只需要向目标服务器上的资源发起请求即可，然后透明代理服务器会将系统的请求重新定向到代理服务器，然后由代理服务器获得目标资源并返回给用户端。通常，透明代理服务器在局域网中应用。</p>
<p><img src="../../img/1559291831121815.png" alt="透明代理服务器 "></p>
<h3 id="正向代理-Forward-Proxy-代理端代理的是客户端"><a href="#正向代理-Forward-Proxy-代理端代理的是客户端" class="headerlink" title="正向代理(Forward Proxy)-代理端代理的是客户端"></a>正向代理(Forward Proxy)-代理端代理的是客户端</h3><p>一般情况下，如果没有特别说明，代理技术默认说的是正向代理技术。关于正向代理的概念如下： 正向代理(forward)是一个位于客户端【用户A】和原始服务器(origin server)【服务器B】之间的服务器【代理服务器Z】，为了从原始服务器取得内容，用户A向代理服务器Z发送一个请求并指定目标(服务器B)，然后代理服务器Z向服务器B转交请求并将获得的内容返回给客户端。客户端必须要进行一些特别的设置才能使用正向代理。 </p>
<p><img src="../../img/16adfd339dd7624b.jpg" alt="正向代理与反向代理示意图1"></p>
<p>从上面的概念中，我们看出，文中所谓的<strong>正向代理就是代理服务器替代访问方【用户】去访问目标服务器【服务器】</strong></p>
<h4 id="使用正向代理服务器的作用如下："><a href="#使用正向代理服务器的作用如下：" class="headerlink" title="使用正向代理服务器的作用如下："></a>使用正向代理服务器的作用如下：</h4><p><strong>1.翻墙</strong></p>
<p>国内用浏览器访问某些被强网站时，被残忍的拒绝了，于是你可以在国外搭建一台代理服务器，让代理帮我去请求，代理把请求返回的相应结构再返回给我。</p>
<p><img src="../../img/16adfd339e4caeda.jpg" alt="翻墙"></p>
<p><strong>2.Cache作用</strong></p>
<p>数据缓存在代理服务器上，如果客户端请求的内容在缓存中则不去访问目标主机。 Cache（缓存）技术和代理服务技术是紧密联系的（不光是正向代理，反向代理也使用了Cache（缓存）技术。如果在用户A访问服务器B某数据J之前，已经有人通过代理服务器Z访问过服务器B上得数据J，那么代理服务器Z会把数据J保存一段时间，如果有人正好取该数据J，那么代理服务器Z不再访问服务器B，而把缓存的数据J直接发给用户A。这一技术在Cache中术语就叫Cache命中。如果有更多的像用户A的用户来访问代理服务器Z，那么这些用户都可以直接从代理服务器Z中取得数据J，而不用千里迢迢的去服务器B下载数据了。</p>
<p><strong>3.客户端访问授权</strong></p>
<p>这方面的内容现今使用的还是比较多的，例如一些公司采用ISA SERVER做为正向代理服务器来授权用户是否有权限访问互联网。</p>
<p><img src="../../img/16adfd339debb546.jpg" alt="客户端访问授权"></p>
<p>防火墙作为网关，用来过滤外网对其的访问。假设用户A和用户B都设置了代理服务器，用户A允许访问互联网，而用户B不允许访问互联网（这个在代理服务器Z上做限制）这样用户A因为授权，可以通过代理服务器访问到服务器B，而用户B因为没有被代理服务器Z授权，所以访问服务器B时，数据包会被直接丢弃。</p>
<p><strong>4.隐藏访问者</strong></p>
<p>通过配置，目标服务器无法获取真实客户端信息，只能获取到代理服务器的信息</p>
<p>##反向代理(Forward Proxy)-代理端代理的是服务端</p>
<p>反向代理正好与正向代理相反，对于客户端而言<strong>代理服务器就像是原始服务器</strong>，并且客户端不需要进行任何特别的设置。客户端向反向代理的命名空间(name-space)中的内容发送普通请求，接着反向代理将判断向何处(原始服务器)转交请求，并将获得的内容返回给客户端。</p>
<h4 id="使用反向代理服务器的作用如下："><a href="#使用反向代理服务器的作用如下：" class="headerlink" title="使用反向代理服务器的作用如下："></a>使用反向代理服务器的作用如下：</h4><p><strong>1.保护和隐藏原始资源服务器</strong></p>
<p><img src="../../img/16adfd339e359655.jpg" alt="保护和隐藏原始资源服务器"></p>
<p>如上图所示，用户A始终认为它访问的是原始服务器B而不是代理服务器Z，但实用际上反向代理服务器接受用户A的应答，从原始资源服务器B中取得用户A的需求资源，然后发送给用户A。由于防火墙的作用，只允许代理服务器Z访问原始资源服务器B。尽管在这个虚拟的环境下，防火墙和反向代理的共同作用保护了原始资源服务器B，但用户A并不知情。</p>
<p><strong>2.负载均衡</strong></p>
<p><img src="../../img/16adfd339ebeed4b.jpg" alt="负载均衡"></p>
<p>当反向代理服务器不止一个的时候，我们甚至可以把它们做成集群，当更多的用户访问资源服务器B的时候，让不同的代理服务器Z(x)去应答不同的用户，然后发送不同用户需要的资源。</p>
<p><strong>3.cache缓存</strong></p>
<p>当然反向代理服务器像正向代理服务器一样拥有cache的作用，它可以缓存原始资源服务器B的资源，而不是每次都要向原始资源服务器B请求数据，特别是一些静态的数据，比如图片和文件，如果这些反向代理服务器能够做到和用户X来自同一个网络，那么用户X访问反向代理服务器X，就会得到很高质量的速度。这正是CDN技术的核心。如下图所示</p>
<p><img src="../../img/16adfd33cadfe378.jpg" alt="image.png"></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><h4 id="正向代理"><a href="#正向代理" class="headerlink" title="正向代理"></a>正向代理</h4><p>正向代理位于客户端和源服务器之间的服务器<strong>（代理客户端）</strong>；</p>
<ul>
<li><strong>隐藏客户端</strong>：由代理服务器代替客户端去访问目标服务器，用户需要设置代理服务器的IP和端口；</li>
<li>每一次请求是到代理服务器，代理服务器转发请求到真实服务器并获取结果返回给客户端</li>
</ul>
<p><strong>作用：</strong></p>
<ul>
<li>翻墙：绕过无法访问的结点，从另外一条路由路径进行目标服务器的访问；</li>
<li>缓存：数据缓存在代理服务器上，如果客户端请求的内容在缓存中则不去访问目标主机；</li>
<li>权限控制：防火墙授权代理服务器访问权限，客户端通过正向代理可以通过防火墙；</li>
<li>隐藏访问者：通过配置，目标服务器无法获取真实客户端信息，只能获取到代理服务器的信息</li>
</ul>
<h4 id="反向代理"><a href="#反向代理" class="headerlink" title="反向代理"></a>反向代理</h4><p>对于客户端而言，反向代理服务器像是原始服务器<strong>（代理服务端）</strong>；</p>
<ul>
<li><strong>隐藏真实服务器</strong>：代理服务器代替目标服务器去接受并返回客户端的请求</li>
</ul>
<p><strong>作用：</strong></p>
<ul>
<li>隐藏真实服务器：防止服务器恶意攻击等；</li>
<li>缓存作用：数据缓存在代理服务器上，如果客户端请求的内容在缓存中则不去访问目标主机；</li>
<li>负载均衡：如nginx</li>
</ul>

          
        
      
    </div>

    

    

    
    
    

    

    
      
    
    

    
	
	  <div>
        
      </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://aiwhs.github.io/2018/12/01/xtrabackup/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="itw">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="itw">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2018/12/01/xtrabackup/" class="post-title-link" itemprop="url">xtrabackup</a>
              
            
          </h1>
        

        <div class="post-meta">

          
          
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-12-01 08:15:57" itemprop="dateCreated datePublished" datetime="2018-12-01T08:15:57+08:00">2018-12-01</time>
            </span>
          

          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-07-09 19:28:45" itemprop="dateModified" datetime="2019-07-09T19:28:45+08:00">2019-07-09</time>
              </span>
            
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Linux运维/" itemprop="url" rel="index"><span itemprop="name">Linux运维</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          <br>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <a id="more"></a>

<h2 id="xtrabackup的安装-centos-rhel系列"><a href="#xtrabackup的安装-centos-rhel系列" class="headerlink" title="xtrabackup的安装(centos/rhel系列)"></a>xtrabackup的安装(centos/rhel系列)</h2><p><a href="https://www.percona.com/doc/percona-xtrabackup/2.4/installation/yum_repo.html" target="_blank" rel="noopener">想要支持5.7版本的备份至少得2.4的，然后8.0的只支持mysql8</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum -y install https://repo.percona.com/yum/percona-release-latest.noarch.rpm</span><br><span class="line">yum -y list | grep percona</span><br><span class="line">yum -y install percona-xtrabackup-24</span><br></pre></td></tr></table></figure>

<p><strong>xtrabackup的特性：</strong></p>
<p>使用innobakupex备份时，其会调用xtrabackup备份所有的InnoDB表，复制所有关于表结构定义的相关文件(.frm)、以及MyISAM、MERGE、CSV和ARCHIVE表的相关文件，同时还会备份触发器和数据库配置信息相关的文件。这些文件会被保存至一个以时间命名的目录中,在备份时，innobackupex还会在备份目录中创建如下文件：</p>
<ol>
<li>xtrabackup_checkpoints：备份类型（如完全或增量）、备份状态（如是否已经为prepared状态）和LSN(日志序列号)范围信息,每个InnoDB页(通常为16k大小)都会包含一个日志序列号，即LSN。LSN是整个数据库系统的系统版本号，每个页面相关的LSN能够表明此页面最近是如何发生改变的</li>
<li>xtrabackup_binlog_info：mysql服务器当前正在使用的二进制日志文件及至备份这一刻为止二进制日志事件的位置</li>
<li>xtrabackup_binlog_pos_innodb：二进制日志文件及用于InnoDB或XtraDB表的二进制日志文件的当position</li>
<li>xtrabackup_binary：备份中用到的xtrabackup的可执行文件</li>
<li>backup-my.cnf：备份命令用到的配置选项信息在使用innobackupex进行备份时，还可以使用–no-timestamp选项来阻止命令自动创建一个以时间命名的目录；innobackupex命令将会创建一个BACKUP-DIR目录来存储备份数据</li>
</ol>
<h3 id="该xtrabackup2-4选项参考"><a href="#该xtrabackup2-4选项参考" class="headerlink" title="该xtrabackup2.4选项参考"></a>该<strong>xtrabackup2.4</strong>选项参考</h3><p>此页面记录了<strong>xtrabackup</strong>二进制文件的所有命令行选项 。</p>
<h3 id="选项"><a href="#选项" class="headerlink" title="选项"></a>选项</h3><p>–apply-log-only</p>
<p>此选项仅在准备备份时执行重做阶段。这对增量备份非常重要。</p>
<p>–backup</p>
<p>进行备份并将其放入。</p>
<p>请参阅 <a href="https://www.percona.com/doc/percona-xtrabackup/2.4/backup_scenarios/full_backup.html#creating-a-backup" target="_blank" rel="noopener">创建备份</a>。<a href="https://www.percona.com/doc/percona-xtrabackup/2.4/xtrabackup_bin/xbk_option_reference.html#cmdoption-xtrabackup-target-dir" target="_blank" rel="noopener"><code>xtrabackup --target-dir</code></a></p>
<p>–binlog-info</p>
<p>此选项控制<em>Percona XtraBackup</em>应如何检索与备份对应的服务器二进制日志坐标。可能的值是 <code>OFF</code>，<code>ON</code>，<code>LOCKLESS</code>和<code>AUTO</code>。</p>
<p>有关 详细信息，请参阅<em>Percona XtraBackup无</em> <a href="https://www.percona.com/doc/percona-xtrabackup/2.4/advanced/lockless_bin-log.html#lockless-bin-log" target="_blank" rel="noopener">锁二进制日志信息</a>手册页。</p>
<p>–check-privileges</p>
<p>此选项检查<em>Percona XtraBackup</em>是否具有所有必需的权限。如果当前操作需要缺少权限，它将终止并打印出错误消息。如果当前操作不需要缺少权限，但某些其他XtraBackup操作可能需要该权限，则不会中止该过程并打印警告。<code>xtrabackup：错误：*。*上缺少必需的权限LOCK TABLES xtrabackup：警告：在*。*上缺少必需的权限复制客户端</code></p>
<p>–close-files</p>
<p>不要保持文件打开。当<strong>xtrabackup</strong>打开表空间时，它通常不会关闭其文件句柄以正确处理DDL操作。但是，如果表空间的数量非常大并且不能满足任何限制，则可以选择在不再访问文件句柄时关闭它们。<em>Percona XtraBackup</em>可以在启用此选项的情况下生成不一致的备份。使用风险由您自己承担。</p>
<p>–compact</p>
<p>通过跳过辅助索引页来创建压缩备份。</p>
<p>–compress</p>
<p>此选项告诉<strong>xtrabackup</strong>使用指定的压缩算法压缩所有输出数据，包括事务日志文件和元数据文件。目前唯一支持的算法是<code>quicklz</code>。生成的文件具有qpress存档格式，即<code>*.qp</code>xtrabackup生成的每个文件本质上都是一个文件的qpress存档，可以通过<a href="http://www.quicklz.com/" target="_blank" rel="noopener">qpress</a> 文件存档提取<a href="http://www.quicklz.com/" target="_blank" rel="noopener">和解</a>压缩。</p>
<p>–compress-chunk-size=#</p>
<p>压缩线程的工作缓冲区大小（以字节为单位）。默认值为64K。</p>
<p>–compress-threads=#</p>
<p>此选项指定<strong>xtrabackup</strong>用于并行数据压缩的工作线程数。此选项默认为<code>1</code>。并行压缩（：选项：<code>xtrabackup -compress-threads</code>）可以与并行文件复制（）一起使用。</p>
<p>例如， 将创建4个I / O线程，这些线程将读取数据并将其传递给2个压缩线程。<a href="https://www.percona.com/doc/percona-xtrabackup/2.4/xtrabackup_bin/xbk_option_reference.html#cmdoption-xtrabackup-parallel" target="_blank" rel="noopener"><code>xtrabackup --parallel</code></a><code>--parallel=4 --compress --compress-threads=2</code></p>
<p>–copy-back</p>
<p>将先前制作的备份中的所有文件从备份目录复制到其原始位置。除非指定了选项，否则此选项不会复制现有文件。<a href="https://www.percona.com/doc/percona-xtrabackup/2.4/xtrabackup_bin/xbk_option_reference.html#cmdoption-xtrabackup-force-non-empty-directories" target="_blank" rel="noopener"><code>xtrabackup --force-non-empty-directories</code></a></p>
<p>–create-ib-logfile</p>
<p>此选项目前尚未实施。要创建InnoDB日志文件，您必须准备两次备份。</p>
<p>–databases=#</p>
<p>此选项指定应备份的数据库和表的列表。该选项接受表单列表。<code>&quot;databasename1[.table_name1] databasename2[.table_name2] . . .&quot;</code></p>
<p>–databases-exclude=name</p>
<p>根据名称排除数据库，操作方式与备份相同，但匹配的名称将从备份中排除。请注意，此选项的优先级高于 。<a href="https://www.percona.com/doc/percona-xtrabackup/2.4/xtrabackup_bin/xbk_option_reference.html#cmdoption-xtrabackup-databases" target="_blank" rel="noopener"><code>xtrabackup --databases</code></a><a href="https://www.percona.com/doc/percona-xtrabackup/2.4/xtrabackup_bin/xbk_option_reference.html#cmdoption-xtrabackup-databases" target="_blank" rel="noopener"><code>xtrabackup --databases</code></a></p>
<p>–databases-file=#</p>
<p>此选项指定包含应备份的数据库和表列表的文件的路径。该文件可以包含表单的列表元素，<code>databasename1[.table_name1]</code>每行一个元素。</p>
<p>–datadir=DIRECTORY</p>
<p>备份的源目录。这应该与<em>MySQL</em>服务器的datadir相同，因此<code>my.cnf</code>如果存在则应该从中读取; 否则你必须在命令行上指定它。</p>
<p>–decompress</p>
<p>使用<code>.qp</code>以前使用该选项进行的备份中的扩展名解压缩所有文件。该 选项将允许同时解密多个文件。为了解压缩，必须在路径中安装和访问qpress实用程序。<em>Percona XtraBackup</em>不会自动删除压缩文件。为了清理备份目录，用户应该使用选项。<a href="https://www.percona.com/doc/percona-xtrabackup/2.4/xtrabackup_bin/xbk_option_reference.html#cmdoption-xtrabackup-compress" target="_blank" rel="noopener"><code>xtrabackup --compress</code></a><a href="https://www.percona.com/doc/percona-xtrabackup/2.4/xtrabackup_bin/xbk_option_reference.html#cmdoption-xtrabackup-parallel" target="_blank" rel="noopener"><code>xtrabackup --parallel</code></a><a href="https://www.percona.com/doc/percona-xtrabackup/2.4/xtrabackup_bin/xbk_option_reference.html#cmdoption-xtrabackup-remove-original" target="_blank" rel="noopener"><code>xtrabackup --remove-original</code></a></p>
<p>–decrypt=ENCRYPTION-ALGORITHM</p>
<p><code>.xbcrypt</code>在先前使用选项进行的备份中解密具有扩展名的所有文件。该 选项将允许同时解密多个文件。<em>Percona XtraBackup</em>不会自动删除加密文件。为了清理备份目录，用户应该使用选项。<a href="https://www.percona.com/doc/percona-xtrabackup/2.4/xtrabackup_bin/xbk_option_reference.html#cmdoption-xtrabackup-encrypt" target="_blank" rel="noopener"><code>xtrabackup --encrypt</code></a><a href="https://www.percona.com/doc/percona-xtrabackup/2.4/xtrabackup_bin/xbk_option_reference.html#cmdoption-xtrabackup-parallel" target="_blank" rel="noopener"><code>xtrabackup --parallel</code></a><a href="https://www.percona.com/doc/percona-xtrabackup/2.4/xtrabackup_bin/xbk_option_reference.html#cmdoption-xtrabackup-remove-original" target="_blank" rel="noopener"><code>xtrabackup --remove-original</code></a>`</p>
<p>–defaults-extra-file=[MY.CNF]</p>
<p>读取全局文件后读取此文件。必须作为命令行上的第一个选项。</p>
<p>–defaults-file=[MY.CNF]</p>
<p>仅读取给定文件中的默认选项。必须作为命令行上的第一个选项。必须是真实的文件; 它不能成为一种象征性的联系。</p>
<p>–defaults-group=GROUP-NAME</p>
<p>此选项用于设置应从配置文件中读取的组。如果您使用该选项，<strong>innobackupex</strong>将使用此 选项。部署需要它 。<a href="https://www.percona.com/doc/percona-xtrabackup/2.4/xtrabackup_bin/xbk_option_reference.html#cmdoption-xtrabackup-defaults-group" target="_blank" rel="noopener"><code>xtrabackup --defaults-group</code></a><code>mysqld_multi</code></p>
<p>–dump-innodb-buffer-pool</p>
<p>此选项控制是否应该执行缓冲池内容的新转储。使用<code>--dump-innodb-buffer-pool</code>，<strong>xtrabackup</strong> 向服务器发出请求以在<strong>备份</strong>开始时启动缓冲池转储（需要一些时间才能完成并在后台完成），前提是状态变量 <code>innodb_buffer_pool_dump_status</code>报告转储已完成。<code>$ xtrabackup --backup --dump-innodb-buffer-pool --target-dir = / home / user / backup</code>默认情况下，此选项设置为OFF。如果<code>innodb_buffer_pool_dump_status</code>报告存在正在运行的缓冲池转储，则<strong>xtrabackup</strong>将使用值等待转储完成<a href="https://www.percona.com/doc/percona-xtrabackup/2.4/xtrabackup_bin/xbk_option_reference.html#cmdoption-xtrabackup-dump-innodb-buffer-pool-timeout" target="_blank" rel="noopener"><code>--dump-innodb-buffer-pool-timeout</code></a>该文件<code>ib_buffer_pool</code>存储用于更快地预热缓冲池的表空间ID和页面ID数据。也可以看看<em>MySQL</em>文档：保存和恢复缓冲池状态<a href="https://dev.mysql.com/doc/refman/5.7/en/innodb-preload-buffer-pool.html" target="_blank" rel="noopener">https://dev.mysql.com/doc/refman/5.7/en/innodb-preload-buffer-pool.html</a></p>
<p>–dump-innodb-buffer-pool-timeout</p>
<p>此选项包含<strong>xtrabackup</strong>应监视其值<code>innodb_buffer_pool_dump_status</code>以确定缓冲池转储是否已完成的秒数。此选项与<a href="https://www.percona.com/doc/percona-xtrabackup/2.4/xtrabackup_bin/xbk_option_reference.html#cmdoption-xtrabackup-dump-innodb-buffer-pool" target="_blank" rel="noopener"><code>--dump-innodb-buffer-pool</code></a>。结合使用 。默认情况下，它设置为10 秒。</p>
<p>–dump-innodb-buffer-pool-pct</p>
<p>此选项包含要转储的最近使用的缓冲池页面的百分比。如果<a href="https://www.percona.com/doc/percona-xtrabackup/2.4/xtrabackup_bin/xbk_option_reference.html#cmdoption-xtrabackup-dump-innodb-buffer-pool" target="_blank" rel="noopener"><code>--dump-innodb-buffer-pool</code></a>选项设置为ON，则此选项有效。如果此选项包含值，则<strong>xtrabackup会</strong>设置<em>MySQL</em> 系统变量<code>innodb_buffer_pool_dump_pct</code>。缓冲池转储完成或停止（请参阅 <a href="https://www.percona.com/doc/percona-xtrabackup/2.4/xtrabackup_bin/xbk_option_reference.html#cmdoption-xtrabackup-dump-innodb-buffer-pool-timeout" target="_blank" rel="noopener"><code>--dump-innodb-buffer-pool-timeout</code></a>）后，将恢复<em>MySQL</em>系统变量的值。也可以看看更改缓冲池转储的超时<a href="https://www.percona.com/doc/percona-xtrabackup/2.4/xtrabackup_bin/xbk_option_reference.html#cmdoption-xtrabackup-dump-innodb-buffer-pool-timeout" target="_blank" rel="noopener"><code>--dump-innodb-buffer-pool-timeout</code></a><em>MySQL</em>文档：innodb_buffer_pool_dump_pct系统变量<a href="https://dev.mysql.com/doc/refman/8.0/en/innodb-parameters.html#sysvar_innodb_buffer_pool_dump_pct" target="_blank" rel="noopener">https://dev.mysql.com/doc/refman/8.0/en/innodb-parameters.html#sysvar_innodb_buffer_pool_dump_pct</a></p>
<p>–encrypt=ENCRYPTION_ALGORITHM</p>
<p>此选项指示xtrabackup使用ENCRYPTION_ALGORITHM中指定的算法加密InnoDB数据文件的备份副本。它直接传递给xtrabackup子进程。有关更多详细信息，请参阅 <strong>xtrabackup</strong> <a href="https://www.percona.com/doc/percona-xtrabackup/2.4/xtrabackup_bin/xtrabackup_binary.html" target="_blank" rel="noopener">文档</a>。</p>
<p>–encrypt-key=ENCRYPTION_KEY</p>
<p>此选项指示xtrabackup <code>ENCRYPTION_KEY</code>在使用该选项时使用给定的。它直接传递给xtrabackup子进程。有关更多详细信息，请参阅<strong>xtrabackup</strong> <a href="https://www.percona.com/doc/percona-xtrabackup/2.4/xtrabackup_bin/xtrabackup_binary.html" target="_blank" rel="noopener">文档</a>。<a href="https://www.percona.com/doc/percona-xtrabackup/2.4/xtrabackup_bin/xbk_option_reference.html#cmdoption-xtrabackup-encrypt" target="_blank" rel="noopener"><code>xtrabackup --encrypt</code></a></p>
<p>–encrypt-key-file=ENCRYPTION_KEY_FILE</p>
<p>此选项指示xtrabackup <code>ENCRYPTION_KEY_FILE</code>在使用该 选项时使用存储在给定中的加密密钥。它直接传递给xtrabackup子进程。有关更多详细信息，请参阅 <strong>xtrabackup</strong> <a href="https://www.percona.com/doc/percona-xtrabackup/2.4/xtrabackup_bin/xtrabackup_binary.html" target="_blank" rel="noopener">文档</a>。<a href="https://www.percona.com/doc/percona-xtrabackup/2.4/xtrabackup_bin/xbk_option_reference.html#cmdoption-xtrabackup-encrypt" target="_blank" rel="noopener"><code>xtrabackup --encrypt</code></a></p>
<p>–encrypt-threads=#</p>
<p>此选项指定将用于并行加密/解密的工作线程数。有关更多详细信息，请参阅<strong>xtrabackup</strong> <a href="https://www.percona.com/doc/percona-xtrabackup/2.4/xtrabackup_bin/xtrabackup_binary.html" target="_blank" rel="noopener">文档</a>。</p>
<p>–encrypt-chunk-size=#</p>
<p>此选项指定每个加密线程的内部工作缓冲区的大小（以字节为单位）。它直接传递给xtrabackup子进程。有关更多详细信息，请参阅<strong>xtrabackup</strong> <a href="https://www.percona.com/doc/percona-xtrabackup/2.4/xtrabackup_bin/xtrabackup_binary.html" target="_blank" rel="noopener">文档</a>。</p>
<p>–export</p>
<p>创建导出表所需的文件。请参阅<a href="https://www.percona.com/doc/percona-xtrabackup/2.4/xtrabackup_bin/restoring_individual_tables.html" target="_blank" rel="noopener">恢复单个表</a>。</p>
<p>–extra-lsndir=DIRECTORY</p>
<p>（for -backup）：在此目录中保存<code>xtrabackup_checkpoints</code> 和<code>xtrabackup_info</code>文件的额外副本。</p>
<p>–force-non-empty-directories</p>
<p>如果指定，它会：选项<code>xtrabackup -copy-back</code>和 选项将文件传输到非空目录。不会覆盖现有文件。如果需要从备份目录中复制/移动的文件已存在于目标目录中，则它仍将失败并显示错误。<a href="https://www.percona.com/doc/percona-xtrabackup/2.4/xtrabackup_bin/xbk_option_reference.html#cmdoption-xtrabackup-move-back" target="_blank" rel="noopener"><code>xtrabackup --move-back</code></a></p>
<p>–ftwrl-wait-timeout=SECONDS</p>
<p>此选项指定xtrabackup应等待在运行之前阻塞的查询的时间（以秒为单位）。如果超时到期时仍有此类查询，则xtrabackup将终止并显示错误。默认是，在这种情况下，它不会等待查询完成并 立即启动。如果支持（Percona Server 5.6+），则xtrabackup将自动使用<a href="https://www.percona.com/doc/percona-server/5.6/management/backup_locks.html#backup-locks" target="_blank" rel="noopener">备份锁</a> 作为复制非InnoDB数据的轻量级替代方法，以避免阻止修改InnoDB表的DML查询。<code>FLUSH TABLES WITH READ LOCK``0``FLUSH TABLESWITH READ LOCK``FLUSH TABLES WITH READ LOCK</code></p>
<p>–ftwrl-wait-threshold=SECONDS</p>
<p>此选项指定查询运行时阈值，该阈值由xtrabackup用于检测具有非零值的长时间运行的查询 。 在存在长时间运行的查询之前不会启动。如果是，则此选项无效。默认值为秒。如果支持（Percona Server 5.6+），则xtrabackup将自动使用<a href="https://www.percona.com/doc/percona-server/5.6/management/backup_locks.html#backup-locks" target="_blank" rel="noopener">备份锁</a> 作为复制非InnoDB数据的轻量级替代方法，以避免阻止修改InnoDB表的DML查询。<a href="https://www.percona.com/doc/percona-xtrabackup/2.4/xtrabackup_bin/xbk_option_reference.html#cmdoption-xtrabackup-ftwrl-wait-timeout" target="_blank" rel="noopener"><code>xtrabackup --ftwrl-wait-timeout</code></a><code>FLUSH TABLES WITH READLOCK</code><a href="https://www.percona.com/doc/percona-xtrabackup/2.4/xtrabackup_bin/xbk_option_reference.html#cmdoption-xtrabackup-ftwrl-wait-timeout" target="_blank" rel="noopener"><code>xtrabackup --ftwrl-wait-timeout</code></a><code>0``60``FLUSH TABLES WITH READ LOCK</code></p>
<p>–ftwrl-wait-query-type=all|update</p>
<p>此选项指定在xtrabackup发出全局锁之前允许完成哪些类型的查询。默认是<code>all</code>。</p>
<p>–galera-info</p>
<p>此选项创建<code>xtrabackup_galera_info</code>包含备份时本地节点状态的文件。在执行<em>Percona XtraDB Cluster</em>的备份时应使用选项。使用备份锁创建备份时，它不起作用。</p>
<p>–incremental-basedir=DIRECTORY</p>
<p>创建增量备份时，这是包含完整备份的目录，该备份是增量备份的基础数据集。</p>
<p>–incremental-dir=DIRECTORY</p>
<p>准备增量备份时，这是增量备份与完整备份组合的目录，以进行新的完整备份。</p>
<p>–incremental-force-scan</p>
<p>创建增量备份时，即使完整更改的页面位图数据可用，也强制对正在备份的实例中的数据页进行完全扫描。</p>
<p>–incremental-lsn=LSN</p>
<p>创建增量备份时，可以指定日志序列号（<a href="https://www.percona.com/doc/percona-xtrabackup/2.4/glossary.html#term-lsn" target="_blank" rel="noopener">LSN</a>）而不是指定 。对于在5.1及更高版本中创建的数据库，请将<a href="https://www.percona.com/doc/percona-xtrabackup/2.4/glossary.html#term-lsn" target="_blank" rel="noopener">LSN</a>指定为单个64位整数。<strong>注意</strong>：如果指定了错误的LSN值（<em>Percona XtraBackup</em>无法检测到的用户错误），则备份将无法使用。小心！<a href="https://www.percona.com/doc/percona-xtrabackup/2.4/xtrabackup_bin/xbk_option_reference.html#cmdoption-xtrabackup-incremental-basedir" target="_blank" rel="noopener"><code>xtrabackup --incremental-basedir</code></a></p>
<p>–innodb-log-arch-dir=DIRECTORY</p>
<p>此选项用于指定包含存档日志的目录。它只能与选项一起使用。<a href="https://www.percona.com/doc/percona-xtrabackup/2.4/xtrabackup_bin/xbk_option_reference.html#cmdoption-xtrabackup-prepare" target="_blank" rel="noopener"><code>xtrabackup --prepare</code></a></p>
<p>–innodb-miscellaneous</p>
<p>有一大组InnoDB选项通常从<code>my.cnf</code>配置文件中读取 ，因此<strong>xtrabackup</strong>以与当前服务器相同的配置启动其嵌入式InnoDB。您通常不需要明确指定这些。这些选项与InnoDB或XtraDB中的选项具有相同的行为。</p>
<p>它们如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">-innodb-adaptive-hash-index </span><br><span class="line">-innodb-additional-mem-pool-size  </span><br><span class="line">-innodb-autoextend-increment </span><br><span class="line">-innodb-buffer-pool-size  </span><br><span class="line">-innodb-checksums  </span><br><span class="line">-innodb-data-file-path</span><br><span class="line">-innodb-数据-主页-目录</span><br><span class="line">-innodb-doublewrite-file</span><br><span class="line">-innodb-doublewrite</span><br><span class="line">-innodb-extra-undoslots</span><br><span class="line">-innodb-fast-checksum</span><br><span class="line">-innodb-file-io-threads</span><br><span class="line">-innodb-file-per-table</span><br><span class="line">-innodb-flush-log-at-trx-commit</span><br><span class="line">-innodb-flush-method</span><br><span class="line">-innodb-force-recovery</span><br><span class="line">-innodb-io-capacity</span><br><span class="line">-innodb-lock-wait-timeout</span><br><span class="line">-innodb-log-buffer-size</span><br><span class="line">-innodb-log- files-in-group</span><br><span class="line">-innodb-日志-文件-大小</span><br><span class="line">-innodb-log-group-home-dir</span><br><span class="line">-innodb-max-dirty-pages- pct</span><br><span class="line">-innodb-open-files</span><br><span class="line">-innodb-page-size</span><br><span class="line">-innodb-read-io-threads</span><br><span class="line">-innodb-write-io-threads</span><br></pre></td></tr></table></figure>

<p>–keyring-file-data=FILENAME</p>
<p>密钥环文件的路径。</p>
<p>–lock-ddl</p>
<p>如果备份开始时服务器支持阻止所有DDL操作，则发出问题。<code>LOCK TABLES FOR BACKUP</code></p>
<p>–lock-ddl-per-table</p>
<p>在xtrabackup开始复制之前锁定每个表的DDL，直到备份完成。</p>
<p>–lock-ddl-timeout</p>
<p>如果在给定的超时内没有返回，则中止备份。<code>LOCK TABLES FOR BACKUP</code></p>
<p>–log-copy-interval=#</p>
<p>此选项指定日志复制线程执行的检查之间的时间间隔（以毫秒为单位）（默认值为1秒）。</p>
<p>–move-back</p>
<p>将先前制作的备份中的所有文件从备份目录移动到其原始位置。由于此选项会删除备份文件，因此必须谨慎使用。</p>
<p>–no-defaults</p>
<p>不要从任何选项文件中读取默认选项。必须作为命令行上的第一个选项。</p>
<p>–no-version-check</p>
<p>此选项禁用版本检查。如果未通过此选项，则在模式下运行<strong>xtrabackup</strong>时<strong>会</strong>隐式启用自动版本检查<code>--backup</code>。要禁用版本检查，应<code>--no-version-check</code>在envoking <strong>xtrabackup</strong>时显式传递该选项。启用自动版本检查后，<strong>xtrabackup</strong>会在创建服务器连接后对备份阶段的服务器执行版本检查。<strong>xtrabackup</strong>将以下信息发送到服务器：MySQL的味道和版本操作系统名称Percona Toolkit版本Perl版本每条信息都有唯一的标识符。这是一个MD5哈希值，Percona Toolkit用它来获取有关如何使用它的统计信息。这是一个随机的UUID; 没有收集或存储客户信息。</p>
<p>–parallel=#</p>
<p>此选项指定在创建备份时用于同时复制多个数据文件的线程数。默认值为1（即没有并发传输）。在<em>Percona XtraBackup</em> 2.3.10及更高版本中，此选项可与选项一起使用以并行复制用户数据文件（重做日志和系统表空间在主线程中复制）。<a href="https://www.percona.com/doc/percona-xtrabackup/2.4/xtrabackup_bin/xbk_option_reference.html#cmdoption-xtrabackup-copy-back" target="_blank" rel="noopener"><code>xtrabackup --copy-back</code></a></p>
<p>–password=PASSWORD</p>
<p>此选项指定连接到数据库时要使用的密码。它接受一个字符串参数。有关详细信息，请参阅mysql -help。</p>
<p>–prepare</p>
<p>使<strong>xtrabackup</strong>对使用创建的备份执行恢复 ，以便可以使用它。请参阅 <a href="https://www.percona.com/doc/percona-xtrabackup/2.4/backup_scenarios/full_backup.html#preparing-a-backup" target="_blank" rel="noopener">准备备份</a>。<a href="https://www.percona.com/doc/percona-xtrabackup/2.4/xtrabackup_bin/xbk_option_reference.html#cmdoption-xtrabackup-backup" target="_blank" rel="noopener"><code>xtrabackup --backup</code></a></p>
<p>–print-defaults</p>
<p>打印程序参数列表并退出。必须作为命令行上的第一个选项。</p>
<p>–print-param</p>
<p>使<strong>xtrabackup</strong>打印出可用于将数据文件复制回原始位置以恢复它们的参数。请参阅 <a href="https://www.percona.com/doc/percona-xtrabackup/2.4/xtrabackup_bin/scripting_backups_xbk.html#scripting-xtrabackup" target="_blank" rel="noopener">使用xtrabackup编写备份脚本</a>。</p>
<p>–reencrypt-for-server-id=<new_server_id></new_server_id></p>
<p>使用此选项可以使用与从中获取加密备份的server_id不同的server_id启动服务器实例，例如复制从属节点或galera节点。使用此选项时，作为准备步骤，xtrabackup将根据新的server_id生成具有ID的新主密钥，将其存储到密钥环文件中并重新加密表空间标头内的表空间密钥。选项应该通过<a href="https://www.percona.com/doc/percona-xtrabackup/2.4/xtrabackup_bin/xbk_option_reference.html#cmdoption-xtrabackup-prepare" target="_blank" rel="noopener"><code>--prepare</code></a>（最后一步）。</p>
<p>–remove-original</p>
<p>在<em>Percona XtraBackup</em> 2.4.6中实现，指定时将删除此选项<code>.qp</code>，<code>.xbcrypt</code>并<code>.qp.xbcrypt</code>在解密和解压缩后删除文件。</p>
<p>–safe-slave-backup</p>
<p>指定后，xtrabackup将在运行之前停止从属SQL线程，并等待启动备份直到 in 为零。如果没有打开的临时表，则会进行备份，否则将启动并停止SQL线程，直到没有打开的临时表为止。如果在几秒钟后没有变为零， 则备份将失败。备份完成后，将重新启动从属SQL线程。实现此选项是为了处理<a href="https://dev.mysql.com/doc/refman/5.7/en/replication-features-temptables.html" target="_blank" rel="noopener">复制临时表</a> ，而不是基于行的复制。<code>FLUSH TABLES WITH READ LOCK``Slave_open_temp_tables``SHOWSTATUS``Slave_open_temp_tables</code><a href="https://www.percona.com/doc/percona-xtrabackup/2.4/xtrabackup_bin/xbk_option_reference.html#cmdoption-xtrabackup-safe-slave-backup-timeout" target="_blank" rel="noopener"><code>xtrabackup --safe-slave-backup-timeout</code></a></p>
<p>–safe-slave-backup-timeout=SECONDS</p>
<p>应该等待 多少秒才能变为零。默认为300秒。<a href="https://www.percona.com/doc/percona-xtrabackup/2.4/xtrabackup_bin/xbk_option_reference.html#cmdoption-xtrabackup-safe-slave-backup" target="_blank" rel="noopener"><code>xtrabackup --safe-slave-backup</code></a><code>Slave_open_temp_tables</code></p>
<p>–secure-auth</p>
<p>如果客户端使用旧的（4.1.1之前的）协议，则拒绝客户端连接到服务器。（默认情况下启用;使用-skip-secure-auth禁用。）</p>
<p>–server-id=#</p>
<p>正在备份的服务器实例。</p>
<p>–slave-info</p>
<p>备份复制从属服务器时，此选项很有用。它打印主服务器的二进制日志位置。它还将此信息<code>xtrabackup_slave_info</code>作为 命令写入文件。可以通过在此备份上启动从属服务器并发出保存在文件中的二进制日志位置的命令来设置此主站的新从站。<code>CHANGE MASTER``CHANGEMASTER``xtrabackup_slave_info</code></p>
<p>–ssl</p>
<p> 启用安全连接。更多信息可以在<a href="https://dev.mysql.com/doc/refman/5.7/en/secure-connection-options.html#option_general_ssl" target="_blank" rel="noopener">-ssl</a> MySQL服务器文档中找到。</p>
<p>–ssl-ca</p>
<p>包含受信任SSL CA列表的文件路径。更多信息可以在<a href="https://dev.mysql.com/doc/refman/5.7/en/secure-connection-options.html#option_general_ssl-ca" target="_blank" rel="noopener">-ssl-ca</a> MySQL服务器文档中找到。</p>
<p>–ssl-capath</p>
<p>包含PEM格式的受信任SSL CA证书的目录路径。更多信息可以在<a href="https://dev.mysql.com/doc/refman/5.7/en/secure-connection-options.html#option_general_ssl-capath" target="_blank" rel="noopener">-ssl-capath</a> MySQL服务器文档中找到。</p>
<p>–ssl-cert</p>
<p>包含PEM格式的X509证书的文件的路径。更多信息可以在<a href="https://dev.mysql.com/doc/refman/5.7/en/secure-connection-options.html#option_general_ssl-cert" target="_blank" rel="noopener">-ssl-cert</a> MySQL服务器文档中找到。</p>
<p>–ssl-cipher</p>
<p>用于连接加密的允许密码列表。更多信息可以在<a href="https://dev.mysql.com/doc/refman/5.7/en/secure-connection-options.html#option_general_ssl-cipher" target="_blank" rel="noopener">-ssl-cipher</a> MySQL服务器文档中找到。</p>
<p>–ssl-crl</p>
<p>包含证书吊销列表的文件的路径。更多信息可以在<a href="https://dev.mysql.com/doc/refman/5.7/en/secure-connection-options.html#option_general_ssl-crl" target="_blank" rel="noopener">-ssl-crl</a> MySQL服务器文档中找到。</p>
<p>–ssl-crlpath</p>
<p> 包含证书吊销列表文件的目录路径。更多信息可以在<a href="https://dev.mysql.com/doc/refman/5.7/en/secure-connection-options.html#option_general_ssl-crlpath" target="_blank" rel="noopener">-ssl-crlpath</a> MySQL服务器文档中找到。</p>
<p>–ssl-key</p>
<p>包含PEM格式的X509密钥的文件路径。更多信息可以在<a href="https://dev.mysql.com/doc/refman/5.7/en/secure-connection-options.html#option_general_ssl-key" target="_blank" rel="noopener">-ssl-key</a> MySQL服务器文档中找到。</p>
<p>–ssl-mode</p>
<p>与服务器连接的安全状态。更多信息可以在 <a href="https://dev.mysql.com/doc/refman/5.7/en/secure-connection-options.html#option_general_ssl-mode" target="_blank" rel="noopener">-ssl-mode</a> MySQL服务器文档中找到。</p>
<p>–ssl-verify-server-cert</p>
<p>验证服务器证书Common Name值与连接到服务器时使用的主机名。更多信息可以在 <a href="https://dev.mysql.com/doc/refman/5.6/en/secure-connection-options.html#option_general_ssl-verify-server-cert" target="_blank" rel="noopener">-ssl-verify-server-cert</a> MySQL服务器文档中找到。</p>
<p>–stats</p>
<p>使<strong>xtrabackup</strong>扫描指定的数据文件并打印出索引统计信息。</p>
<p>–stream=name</p>
<p>将所有备份文件以指定格式流式传输到标准输出。目前支持的格式是<code>xbstream</code>和<code>tar</code>。</p>
<p>–tables=name</p>
<p>正则表达式，与<code>databasename.tablename</code>格式的完整表名 匹配。如果名称匹配，则备份表。查看<a href="https://www.percona.com/doc/percona-xtrabackup/2.4/xtrabackup_bin/partial_backups.html" target="_blank" rel="noopener">部分备份</a>。</p>
<p>–tables-exclude=name</p>
<p>通过regexp过滤表名。操作方式与备份相同，但匹配的名称不在备份中。请注意，此选项的优先级高于 。<a href="https://www.percona.com/doc/percona-xtrabackup/2.4/xtrabackup_bin/xbk_option_reference.html#cmdoption-xtrabackup-tables" target="_blank" rel="noopener"><code>xtrabackup --tables</code></a><a href="https://www.percona.com/doc/percona-xtrabackup/2.4/xtrabackup_bin/xbk_option_reference.html#cmdoption-xtrabackup-tables" target="_blank" rel="noopener"><code>xtrabackup --tables</code></a></p>
<p>–tables-file=name</p>
<p>每行包含一个表名的文件，格式为databasename.tablename。备份将仅限于指定的表。请参阅 <a href="https://www.percona.com/doc/percona-xtrabackup/2.4/xtrabackup_bin/scripting_backups_xbk.html#scripting-xtrabackup" target="_blank" rel="noopener">使用xtrabackup编写备份脚本</a>。</p>
<p>–target-dir=DIRECTORY</p>
<p>此选项指定备份的目标目录。如果目录不存在，则<strong>xtrabackup</strong>会创建它。如果该目录确实存在且为空，则<strong>xtrabackup</strong>将成功。 但是，<strong>xtrabackup</strong>不会覆盖现有文件; 它将因操作系统错误17而失败。<code>file exists</code>如果此选项是相对路径，则将其解释为相对于执行<strong>xtrabackup</strong>的当前工作目录。</p>
<p>–throttle=#</p>
<p>此选项限制每秒复制的块数。块大小为 <em>10 MB</em>。要将带宽限制为<em>10 MB / s</em>，请将选项设置为<em>1</em>： -throttle = 1。也可以看看有关如何限制备份的详细信息<a href="https://www.percona.com/doc/percona-xtrabackup/2.4/advanced/throttling_backups.html#throttling-backups" target="_blank" rel="noopener">限制备份</a></p>
<p>–tmpdir=name</p>
<p>除了在使用时打印出正确的tmpdir参数，此选项当前不用于任何内容。<a href="https://www.percona.com/doc/percona-xtrabackup/2.4/xtrabackup_bin/xbk_option_reference.html#cmdoption-xtrabackup-print-param" target="_blank" rel="noopener"><code>xtrabackup --print-param</code></a></p>
<p>–to-archived-lsn=LSN</p>
<p>此选项用于指定在准备备份时应将日志应用到的LSN。它只能与选项一起使用 。<a href="https://www.percona.com/doc/percona-xtrabackup/2.4/xtrabackup_bin/xbk_option_reference.html#cmdoption-xtrabackup-prepare" target="_blank" rel="noopener"><code>xtrabackup --prepare</code></a></p>
<p>–transition-key</p>
<p>此选项用于在不访问密钥环保管库服务器的情况下启用备份处理。在这种情况下，<strong>xtrabackup</strong>从指定的密码短语中派生AES加密密钥，并使用它来加密正在备份的表空间的表空间密钥。如果<a href="https://www.percona.com/doc/percona-xtrabackup/2.4/xtrabackup_bin/xbk_option_reference.html#cmdoption-xtrabackup-transition-key" target="_blank" rel="noopener"><code>--transition-key</code></a>没有任何价值，<strong>xtrabackup</strong>会要求它。应为该命令指定相同的密码。<a href="https://www.percona.com/doc/percona-xtrabackup/2.4/xtrabackup_bin/xbk_option_reference.html#cmdoption-xtrabackup-prepare" target="_blank" rel="noopener"><code>xtrabackup --prepare</code></a></p>
<p>–use-memory=#</p>
<p>此选项会影响为备份或使用分析统计分配的内存 量 。其目的与<a href="https://www.percona.com/doc/percona-xtrabackup/2.4/glossary.html#term-innodb-buffer-pool-size" target="_blank" rel="noopener">innodb_buffer_pool_size</a>类似。它与Oracle的InnoDB热备份工具中的类似命名选项不同。默认值为100MB，如果您有足够的可用内存，1GB到2GB是一个很好的推荐值。提供单元支持倍数（例如1MB，1M，1GB，1G）。<a href="https://www.percona.com/doc/percona-xtrabackup/2.4/xtrabackup_bin/xbk_option_reference.html#cmdoption-xtrabackup-prepare" target="_blank" rel="noopener"><code>xtrabackup --prepare</code></a><a href="https://www.percona.com/doc/percona-xtrabackup/2.4/xtrabackup_bin/xbk_option_reference.html#cmdoption-xtrabackup-stats" target="_blank" rel="noopener"><code>xtrabackup --stats</code></a></p>
<p>–user=USERNAME</p>
<p>此选项指定连接到服务器时使用的MySQL用户名（如果不是当前用户）。该选项接受字符串参数。有关详细信息，请参阅mysql -help。</p>
<p>–version</p>
<p>此选项打印<strong>xtrabackup</strong>版本并退出</p>
<p><strong>xtrabackup用法</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">备份：innobackupex [option] BACKUP-ROOT-DIR</span><br><span class="line">选项说明：</span><br><span class="line">--user：该选项表示备份账号</span><br><span class="line">--password：该选项表示备份的密码</span><br><span class="line">--host：该选项表示备份数据库的地址</span><br><span class="line">--databases：该选项接受的参数为数据名，如果要指定多个数据库，彼此间需要以空格隔开；如：&quot;xtra_test dba_test&quot;，同时，在指定某数据库时，也可以只指定其中的某张表。如：&quot;mydatabase.mytable&quot;。该选项对innodb引擎表无效，还是会备份所有innodb表</span><br><span class="line">--defaults-file：该选项指定了从哪个文件读取MySQL配置，必须放在命令行第一个选项的位置</span><br><span class="line">--incremental：该选项表示创建一个增量备份，需要指定--incremental-</span><br><span class="line">basedir</span><br><span class="line">--incremental-basedir：该选项表示接受了一个字符串参数指定含有full backup的目录为增量备份的base目录，与--incremental同时使用</span><br><span class="line">--incremental-dir：该选项表示增量备份的目录</span><br><span class="line">--include=name：指定表名，格式：databasename.tablename</span><br><span class="line">Prepare：innobackupex --apply-log [option] BACKUP-DIR</span><br><span class="line">选项说明：</span><br><span class="line">--apply-log：一般情况下,在备份完成后，数据尚且不能用于恢复操作，因为备份的数据中可能会包含尚未提交的事务或已经提交但尚未同步至数据文件中的事务。因此，此时数据文件仍处理不一致状态。此选项作用是通过回滚未提交的事务及同步已经提交的事务至数据文件使数据文件处于一致性状态</span><br><span class="line">--use-memory：该选项表示和--apply-log选项一起使用，prepare 备份的时候，xtrabackup做crash recovery分配的内存大小，单位字节。也可(1MB,1M,1G,1GB)，推荐1G</span><br><span class="line">--defaults-file：该选项指定了从哪个文件读取MySQL配置，必须放在命令行第一个选项的位置</span><br><span class="line">-export：表示开启可导出单独的表之后再导入其他Mysql中</span><br><span class="line">--redo-only：这个选项在prepare base full backup，往其中merge增量备份时候使用</span><br><span class="line">还原：innobackupex --copy-back [选项] BACKUP-DIR</span><br><span class="line">innobackupex --move-back [选项] [--defaults-group=GROUP-NAME] BACKUP-DIR</span><br><span class="line">选项说明：</span><br><span class="line">--copy-back：做数据恢复时将备份数据文件拷贝到MySQL服务器的datadir</span><br><span class="line">--move-back：这个选项与--copy-back相似，唯一的区别是它不拷贝文件，而是移动文件到目的地。这个选项移除backup文件，用时候必须小心。使用场景：没有足够的磁盘空间同事保留数据文件和Backup副本</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">cat xtrabackup.sh</span><br><span class="line">#!/bin/bash</span><br><span class="line">[ -d /root/increment/ ] || mkdir -p /root/increment/</span><br><span class="line">mysql_path=/opt/data</span><br><span class="line">mysql_increment_path=/root/increment/</span><br><span class="line">#mysql全备</span><br><span class="line">mysql_backup() &#123;</span><br><span class="line">innobackupex --defaults-file=/etc/my.cnf --user=root --password=&apos;jbgsn123!&apos; --backup $mysql_path/mysql-`date +%Y%m%d`/  --no-timestamp</span><br><span class="line">exit 0</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#恢复</span><br><span class="line">mysql_recovery() &#123;</span><br><span class="line">systemctl stop mysqld</span><br><span class="line">mv /var/lib/mysql  /var/lib/mysql2</span><br><span class="line">innobackupex --apply-log $mysql_path/mysql-`date +%Y%m%d`/</span><br><span class="line">innobackupex --defaults-file=/etc/my.cnf --copy-back $mysql_path/mysql-`date +%Y%m%d`/</span><br><span class="line">chown -R mysql.mysql /var/lib/mysql</span><br><span class="line">systemctl start mysqld</span><br><span class="line">exit 0</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#增量备份</span><br><span class="line">mysql_increment() &#123;</span><br><span class="line">innobackupex --defaults-file=/etc/my.cnf --user=root --password=&apos;jbgsn123!&apos; --incremental $mysql_increment_path/mysql-`date +%Y%m%d`/ --incremental-basedir=$mysql_path/mysql-`date +%Y%m%d`/ --no-timestamp</span><br><span class="line">exit 0</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#增量恢复</span><br><span class="line">mysql_increment_recovery() &#123;</span><br><span class="line">innobackupex --apply-log --redo-only $mysql_path/mysql-`date +%Y%m%d`/</span><br><span class="line">innobackupex --apply-log --redo-only $mysql_path/mysql-`date +%Y%m%d`/  --incremental-dir=$mysql_path/mysql-`date +%Y%m%d`/</span><br><span class="line">systemctl stop mysqld</span><br><span class="line">mv /var/lib/mysql  /var/lib/mysql2</span><br><span class="line">innobackupex --defaults-file=/etc/my.cnf --copy-back $mysql_path/mysql-`date +%Y%m%d`/</span><br><span class="line">chown -R mysql.mysql /var/lib/mysql</span><br><span class="line">systemctl start mysqld</span><br><span class="line">exit 0</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">man() &#123;</span><br><span class="line">mysql_backup</span><br><span class="line">#mysql_recovery</span><br><span class="line">mysql_increment</span><br><span class="line">#mysql_increment_recovery</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">man</span><br></pre></td></tr></table></figure>
          
        
      
    </div>

    

    

    
    
    

    

    
      
    
    

    
	
	  <div>
        
      </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://aiwhs.github.io/2018/11/25/MySQL2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="itw">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="itw">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2018/11/25/MySQL2/" class="post-title-link" itemprop="url">MySQL进阶</a>
              
            
          </h1>
        

        <div class="post-meta">

          
          
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-11-25 08:15:57" itemprop="dateCreated datePublished" datetime="2018-11-25T08:15:57+08:00">2018-11-25</time>
            </span>
          

          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-07-10 14:42:08" itemprop="dateModified" datetime="2019-07-10T14:42:08+08:00">2019-07-10</time>
              </span>
            
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Linux运维/" itemprop="url" rel="index"><span itemprop="name">Linux运维</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          <br>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <a id="more"></a>

<h1 id="1-二进制格式mysql安装"><a href="#1-二进制格式mysql安装" class="headerlink" title="1. 二进制格式mysql安装"></a>1. 二进制格式mysql安装</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br></pre></td><td class="code"><pre><span class="line">下载二进制格式的mysql软件包</span><br><span class="line">[root@wenhs5479 ~]# wget https://downloads.mysql.com/archives/get/file/mysql-5.7.25-linux-glibc2.12-x86_64.tar</span><br><span class="line"></span><br><span class="line">创建用户和组</span><br><span class="line">[root@wenhs5479 ~]# groupadd -r mysql</span><br><span class="line">[root@wenhs5479 ~]# useradd -M -s /sbin/nologin -g mysql mysql</span><br><span class="line"></span><br><span class="line">解压软件至/usr/local/</span><br><span class="line">[root@wenhs5479 ~]# tar xf mysql-5.7.25-linux-glibc2.12-x86_64.tar -C /usr/local/</span><br><span class="line">[root@wenhs5479 ~]# ls /usr/local/</span><br><span class="line">apache    games    mysql-5.7.25-linux-glibc2.12-x86_64.tar.gz</span><br><span class="line">apr       include  mysql-test-5.7.25-linux-glibc2.12-x86_64.tar.gz</span><br><span class="line">apr-util  lib      sbin</span><br><span class="line">bin       lib64    share</span><br><span class="line">etc       libexec  src</span><br><span class="line">[root@wenhs5479 ~]# tar xf /usr/local/mysql-5.7.25-linux-glibc2.12-x86_64.tar.gz -C /usr/local/</span><br><span class="line">[root@wenhs5479 ~]# ls /usr/local/</span><br><span class="line">apache    lib64</span><br><span class="line">apr       libexec</span><br><span class="line">apr-util  mysql-5.7.25-linux-glibc2.12-x86_64</span><br><span class="line">bin       mysql-5.7.25-linux-glibc2.12-x86_64.tar.gz</span><br><span class="line">etc       mysql-test-5.7.25-linux-glibc2.12-x86_64.tar.gz</span><br><span class="line">games     sbin</span><br><span class="line">include   share</span><br><span class="line">lib       src</span><br><span class="line">[root@wenhs5479 ~]# cd /usr/local/</span><br><span class="line">[root@wenhs5479 local]# ln -sv mysql-5.7.25-linux-glibc2.12-x86_64/ mysql</span><br><span class="line">&quot;mysql&quot; -&gt; &quot;mysql-5.7.25-linux-glibc2.12-x86_64/&quot;</span><br><span class="line">[root@wenhs5479 local]# ll</span><br><span class="line">总用量 658620</span><br><span class="line">drwxr-xr-x. 13 root root        152 4月  29 09:08 apache</span><br><span class="line">drwxr-xr-x.  6 root root         58 4月  29 09:06 apr</span><br><span class="line">drwxr-xr-x.  5 root root         43 4月  29 09:07 apr-util</span><br><span class="line">drwxr-xr-x.  2 root root          6 4月  11 2018 bin</span><br><span class="line">drwxr-xr-x.  2 root root          6 4月  11 2018 etc</span><br><span class="line">drwxr-xr-x.  2 root root          6 4月  11 2018 games</span><br><span class="line">drwxr-xr-x.  2 root root          6 4月  11 2018 include</span><br><span class="line">drwxr-xr-x.  2 root root          6 4月  11 2018 lib</span><br><span class="line">drwxr-xr-x.  2 root root          6 4月  11 2018 lib64</span><br><span class="line">drwxr-xr-x.  2 root root          6 4月  11 2018 libexec</span><br><span class="line">lrwxrwxrwx.  1 root root         36 4月  29 11:59 mysql -&gt; mysql-5.7.25-linux-glibc2.12-x86_64/</span><br><span class="line">drwxr-xr-x.  9 root root        129 4月  29 11:58 mysql-5.7.25-linux-glibc2.12-x86_64</span><br><span class="line">-rw-r--r--.  1 7161 31415 644862820 12月 21 19:23 mysql-5.7.25-linux-glibc2.12-x86_64.tar.gz</span><br><span class="line">-rw-r--r--.  1 7161 31415  29556980 12月 21 19:21 mysql-test-5.7.25-linux-glibc2.12-x86_64.tar.gz</span><br><span class="line">drwxr-xr-x.  2 root root          6 4月  11 2018 sbin</span><br><span class="line">drwxr-xr-x.  5 root root         49 3月   6 20:35 share</span><br><span class="line">drwxr-xr-x.  5 root root        145 4月  29 09:06 src</span><br><span class="line"></span><br><span class="line">修改目录/usr/local/mysql的属主属组</span><br><span class="line">[root@wenhs5479 ~]# chown -R mysql.mysql /usr/local/mysql</span><br><span class="line">[root@wenhs5479 ~]# ll /usr/local/mysql -d</span><br><span class="line">lrwxrwxrwx. 1 mysql mysql 36 4月  29 11:59 /usr/local/mysql -&gt; mysql-5.7.25-linux-glibc2.12-x86_64/</span><br><span class="line"></span><br><span class="line">添加环境变量</span><br><span class="line">[root@wenhs5479 ~]# ls /usr/local/mysql</span><br><span class="line">bin  COPYING  docs  include  lib  man  README  share  support-files</span><br><span class="line">[root@wenhs5479 ~]# echo &apos;export PATH=/usr/local/mysql/bin:$PATH&apos; &gt; /etc/profile.d/mysql.sh </span><br><span class="line">[root@wenhs5479 ~]# source /etc/profile.d/mysql.sh </span><br><span class="line">[root@wenhs5479 ~]# echo $PATH</span><br><span class="line">/usr/local/mysql/bin:/usr/local/apache/bin:/usr/lib64/qt-3.3/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/root/bin:/root/bin</span><br><span class="line"></span><br><span class="line">建立数据存放目录</span><br><span class="line">[root@wenhs5479 ~]# mkdir /opt/data</span><br><span class="line">[root@wenhs5479 ~]# chown -R mysql.mysql /opt/data/</span><br><span class="line">[root@wenhs5479 ~]# ll /opt/</span><br><span class="line">总用量 0</span><br><span class="line">drwxr-xr-x. 2 mysql mysql 6 4月  29 12:07 data</span><br><span class="line">drwxr-xr-x. 2 root  root  6 10月 31 03:17 rh</span><br><span class="line"></span><br><span class="line">初始化数据库</span><br><span class="line">[root@wenhs5479 ~]# /usr/local/mysql/bin/mysqld --initialize --user=mysql --datadir=/opt/data/</span><br><span class="line">2019-04-29T04:25:29.411729Z 0 [Warning] TIMESTAMP with implicit DEFAULT value is deprecated. Please use --explicit_defaults_for_timestamp server option (see documentation for more details).</span><br><span class="line">2019-04-29T04:25:29.801636Z 0 [Warning] InnoDB: New log files created, LSN=45790</span><br><span class="line">2019-04-29T04:25:29.881540Z 0 [Warning] InnoDB: Creating foreign key constraint system tables.</span><br><span class="line">2019-04-29T04:25:29.952437Z 0 [Warning] No existing UUID has been found, so we assume that this is the first time that this server has been started. Generating a new UUID: d23d56a4-6a36-11e9-af12-000c298a2a2e.</span><br><span class="line">2019-04-29T04:25:29.953823Z 0 [Warning] Gtid table is not ready to be used. Table &apos;mysql.gtid_executed&apos; cannot be opened.</span><br><span class="line">2019-04-29T04:25:29.955744Z 1 [Note] A temporary password is generated for root@localhost: gQBy9Sq(dr&gt;h</span><br><span class="line">请注意，这个命令的最后会生成一个临时密码，此处密码是gQBy9Sq(dr&gt;h</span><br><span class="line">再次注意，这个密码是随机的，你的不会跟我一样，一定要记住这个密码，因为一会登录时会用到</span><br><span class="line"></span><br><span class="line">生成配置文件</span><br><span class="line">[root@wenhs5479 ~]# cat &gt;/etc/my.cnf &lt;&lt;EOF</span><br><span class="line">&gt; [mysqld]</span><br><span class="line">&gt; basedir = /usr/local/mysql</span><br><span class="line">&gt; datadir = /opt/data</span><br><span class="line">&gt; socket = /tmp/mysql.sock</span><br><span class="line">&gt; port = 3306</span><br><span class="line">&gt; pid-file = /opt/data/mysql.pid</span><br><span class="line">&gt; user = mysql</span><br><span class="line">&gt; skip-name-resolve</span><br><span class="line">&gt; EOF</span><br><span class="line">&gt; </span><br><span class="line">[root@wenhs5479 ~]# cat /etc/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">basedir = /usr/local/mysql</span><br><span class="line">datadir = /opt/data</span><br><span class="line">socket = /tmp/mysql.sock</span><br><span class="line">port = 3306</span><br><span class="line">pid-file = /opt/data/mysql.pid</span><br><span class="line">user = mysql</span><br><span class="line">skip-name-resolve</span><br><span class="line"></span><br><span class="line">配置服务启动脚本</span><br><span class="line">[root@wenhs5479 ~]# cp -a /usr/local/mysql/support-files/mysql.server /etc/init.d/mysqld</span><br><span class="line">[root@wenhs5479 ~]# sed -ri &apos;s#^(basedir=).*#\1/usr/local/mysql#g&apos; /etc/init.d/mysqld</span><br><span class="line">[root@wenhs5479 ~]# sed -ri &apos;s#^(datadir=).*#\1/opt/data#g&apos; /etc/init.d/mysqld</span><br><span class="line"></span><br><span class="line">启动mysql</span><br><span class="line">[root@wenhs5479 ~]# /etc/init.d/mysqld start</span><br><span class="line">Starting MySQL.Logging to &apos;/opt/data/wenhs5479.err&apos;.</span><br><span class="line"> SUCCESS! </span><br><span class="line">[root@wenhs5479 ~]# ps -ef|grep mysql</span><br><span class="line">root      90916      1  0 13:55 pts/1    00:00:00 /bin/sh /usr/local/mysql/bin/mysqld_safe --datadir=/opt/data --pid-file=/opt/data/mysql.pid</span><br><span class="line">mysql     91094  90916  2 13:55 pts/1    00:00:00 /usr/local/mysql/binmysqld --basedir=/usr/local/mysql --datadir=/opt/data --plugin-dir=/usr/local/mysql/lib/plugin --user=mysql --log-error=wenhs5479.err --pid-file=/opt/data/mysql.pid --socket=/tmp/mysql.sock --port=3306</span><br><span class="line">root      91132  53676  0 13:55 pts/1    00:00:00 grep --color=auto mysql</span><br><span class="line">[root@wenhs5479 ~]# ss -antl</span><br><span class="line">State       Recv-Q Send-Q Local Address:Port               Peer Address:Port              </span><br><span class="line">LISTEN      0      128     *:111                 *:*                  </span><br><span class="line">LISTEN      0      5      192.168.122.1:53                  *:*                  </span><br><span class="line">LISTEN      0      128     *:22                  *:*                  </span><br><span class="line">LISTEN      0      128    127.0.0.1:631                 *:*                  </span><br><span class="line">LISTEN      0      100    127.0.0.1:25                  *:*                  </span><br><span class="line">LISTEN      0      128    127.0.0.1:6010                *:*                  </span><br><span class="line">LISTEN      0      80     :::3306               :::*                  </span><br><span class="line">LISTEN      0      128    :::111                :::*                  </span><br><span class="line">LISTEN      0      128    :::80                 :::*                  </span><br><span class="line">LISTEN      0      128    :::22                 :::*                  </span><br><span class="line">LISTEN      0      128       ::1:631                :::*                  </span><br><span class="line">LISTEN      0      100       ::1:25                 :::*                  </span><br><span class="line">LISTEN      0      128       ::1:6010               :::*</span><br><span class="line"></span><br><span class="line">修改密码</span><br><span class="line">使用临时密码登录</span><br><span class="line">[root@wenhs5479 ~]# /usr/local/mysql/bin/mysql -uroot -p</span><br><span class="line">Enter password: </span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 2</span><br><span class="line">Server version: 5.7.25</span><br><span class="line">Copyright (c) 2000, 2019, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line">Type &apos;help;&apos; or &apos;\h&apos; for help. Type &apos;\c&apos; to clear the current input statement.</span><br><span class="line">mysql&gt;</span><br><span class="line"></span><br><span class="line">设置新密码</span><br><span class="line">mysql&gt; set password = password(&apos;jbgsn123!&apos;);</span><br><span class="line">Query OK, 0 rows affected, 1 warning (0.00 sec)</span><br></pre></td></tr></table></figure>

<h1 id="2-mysql配置文件"><a href="#2-mysql配置文件" class="headerlink" title="2. mysql配置文件"></a>2. mysql配置文件</h1><p><code>mysql</code>的配置文件为<code>/etc/my.cnf</code></p>
<p>配置文件查找次序：若在多个配置文件中均有设定，则最后找到的最终生效</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/etc/my.cnf --&gt; /etc/mysql/my.cnf --&gt; --default-extra-file=/PATH/TO/CONF_FILE --&gt; ~/.my.cnf</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">配置免密登录</span><br><span class="line">[root@wenhs5479 ~]# cat &gt;.my.cnf &lt;&lt;EOF</span><br><span class="line">&gt; [client]</span><br><span class="line">&gt; user=root</span><br><span class="line">&gt; password=jbgsn123!</span><br><span class="line">&gt; EOF</span><br><span class="line">[root@wenhs5479 ~]# mysql</span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 8</span><br><span class="line">Server version: 5.7.25 MySQL Community Server (GPL)</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2019, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type &apos;help;&apos; or &apos;\h&apos; for help. Type &apos;\c&apos; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">mysql&gt;</span><br></pre></td></tr></table></figure>

<p><strong>mysql常用配置文件参数：</strong></p>
<table>
<thead>
<tr>
<th>参数</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>port = 3306</td>
<td>设置监听端口</td>
</tr>
<tr>
<td>socket = /tmp/mysql.sock</td>
<td>指定套接字文件位置</td>
</tr>
<tr>
<td>basedir = /usr/local/mysql</td>
<td>指定MySQL的安装路径</td>
</tr>
<tr>
<td>datadir = /data/mysql</td>
<td>指定MySQL的数据存放路径</td>
</tr>
<tr>
<td>pid-file = /data/mysql/mysql.pid</td>
<td>指定进程ID文件存放路径</td>
</tr>
<tr>
<td>user = mysql</td>
<td>指定MySQL以什么用户的身份提供服务</td>
</tr>
<tr>
<td>skip-name-resolve</td>
<td>禁止MySQL对外部连接进行DNS解析<br>使用这一选项可以消除MySQL进行DNS解析的时间。<br>若开启该选项，则所有远程主机连接授权都要使用IP地址方<br>式否则MySQL将无法正常处理连接请求</td>
</tr>
</tbody></table>
<h1 id="3-mysql数据库备份与恢复"><a href="#3-mysql数据库备份与恢复" class="headerlink" title="3. mysql数据库备份与恢复"></a>3. mysql数据库备份与恢复</h1><h3 id="3-1-数据库常用备份方案"><a href="#3-1-数据库常用备份方案" class="headerlink" title="3.1 数据库常用备份方案"></a>3.1 数据库常用备份方案</h3><p><strong>数据库备份方案：</strong></p>
<ul>
<li>全量备份</li>
<li>增量备份</li>
<li>差异备份</li>
</ul>
<table>
<thead>
<tr>
<th>备份方案</th>
<th>特点</th>
</tr>
</thead>
<tbody><tr>
<td>全量备份</td>
<td>全量备份就是指对某一个时间点上的所有数据或应用进行的一个完全拷贝。<br>数据恢复快。<br>备份时间长</td>
</tr>
<tr>
<td>增量备份</td>
<td>增量备份是指在一次全备份或上一次增量备份后，以后每次的备份只需备份<br>与前一次相比增加和者被修改的文件。这就意味着，第一次增量备份的对象<br>是进行全备后所产生的增加和修改的文件；第二次增量备份的对象是进行第一次增量<br>备份后所产生的增加和修改的文件，如此类推。<br>没有重复的备份数据<br>备份时间短<br>恢复数据时必须按一定的顺序进行</td>
</tr>
<tr>
<td>差异备份</td>
<td>备份上一次的完全备份后发生变化的所有文件。<br>差异备份是指在一次全备份后到进行差异备份的这段时间内<br>对那些增加或者修改文件的备份。在进行恢复时，我们只需对第一次全量备份和最后一次差异备份进行恢复。</td>
</tr>
</tbody></table>
<h3 id="3-2-mysql备份工具mysqldump"><a href="#3-2-mysql备份工具mysqldump" class="headerlink" title="3.2 mysql备份工具mysqldump"></a>3.2 mysql备份工具mysqldump</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line">语法：</span><br><span class="line">    mysqldump [OPTIONS] database [tables ...]</span><br><span class="line">    mysqldump [OPTIONS] --all-databases [OPTIONS]</span><br><span class="line">    mysqldump [OPTIONS] --databases [OPTIONS] DB1 [DB2 DB3...]</span><br><span class="line">    </span><br><span class="line">常用的OPTIONS：</span><br><span class="line">    -uUSERNAME      //指定数据库用户名</span><br><span class="line">    -hHOST          //指定服务器主机，请使用ip地址</span><br><span class="line">    -pPASSWORD      //指定数据库用户的密码</span><br><span class="line">    -P#             //指定数据库监听的端口，这里的#需用实际的端口号代替，如-P3307</span><br><span class="line"> </span><br><span class="line">备份整个数据库(全备)</span><br><span class="line">mysql&gt; show databases;</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| sys                |</span><br><span class="line">| wenhs              |</span><br><span class="line">+--------------------+</span><br><span class="line">5 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; use wenhs;</span><br><span class="line">Database changed</span><br><span class="line">mysql&gt; show tables;</span><br><span class="line">+-----------------+</span><br><span class="line">| Tables_in_wenhs |</span><br><span class="line">+-----------------+</span><br><span class="line">| student         |</span><br><span class="line">| teacher         |</span><br><span class="line">+-----------------+</span><br><span class="line">2 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; exit</span><br><span class="line">Bye</span><br><span class="line">[root@wenhs5479 ~]# mysqldump -uroot -p -hlocalhost --all-databases &gt;all-$(date +%F_%T).sql</span><br><span class="line">Enter password: </span><br><span class="line">[root@wenhs5479 ~]# ls</span><br><span class="line">all-2019-04-29_14:44:04.sql              公共  下载</span><br><span class="line">anaconda-ks.cfg                          模板  音乐</span><br><span class="line">apache                                   视频  桌面</span><br><span class="line">initial-setup-ks.cfg                     图片</span><br><span class="line">mysql-5.7.25-linux-glibc2.12-x86_64.tar  文档</span><br><span class="line"></span><br><span class="line">备份wenhs库的student表和teacher表</span><br><span class="line">[root@wenhs5479 ~]# mysqldump -uroot -p -hlocalhost wenhs student teacher &gt;table-$(date +%F_%T).sql</span><br><span class="line">Enter password: </span><br><span class="line">[root@wenhs5479 ~]# ls</span><br><span class="line">all-2019-04-29_14:44:04.sql              模板</span><br><span class="line">anaconda-ks.cfg                          视频</span><br><span class="line">apache                                   图片</span><br><span class="line">initial-setup-ks.cfg                     文档</span><br><span class="line">mysql-5.7.25-linux-glibc2.12-x86_64.tar  下载</span><br><span class="line">table-2019-04-29_14:45:41.sql            音乐</span><br><span class="line">公共                                     桌面</span><br><span class="line"></span><br><span class="line">备份wenhs库</span><br><span class="line">[root@wenhs5479 ~]# mysqldump -uroot -p -hlocalhost --databases wenhs &gt;wenhs-$(date +%F_%T).sql</span><br><span class="line">Enter password: </span><br><span class="line">[root@wenhs5479 ~]# ls</span><br><span class="line">all-2019-04-29_14:44:04.sql              模板</span><br><span class="line">anaconda-ks.cfg                          视频</span><br><span class="line">apache                                   图片</span><br><span class="line">initial-setup-ks.cfg                     文档</span><br><span class="line">mysql-5.7.25-linux-glibc2.12-x86_64.tar  下载</span><br><span class="line">table-2019-04-29_14:45:41.sql            音乐</span><br><span class="line">wenhs-2019-04-29_14:46:35.sql            桌面</span><br><span class="line">公共</span><br><span class="line"></span><br><span class="line">模拟误删wenhs数据库</span><br><span class="line">mysql&gt; drop database wenhs;</span><br><span class="line">Query OK, 2 rows affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; show databases;</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| sys                |</span><br><span class="line">+--------------------+</span><br><span class="line">4 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<h3 id="3-3-mysql数据恢复"><a href="#3-3-mysql数据恢复" class="headerlink" title="3.3 mysql数据恢复"></a>3.3 mysql数据恢复</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">恢复wenhs数据库</span><br><span class="line">[root@wenhs5479 ~]# ls</span><br><span class="line">all-2019-04-29_14:44:04.sql              模板</span><br><span class="line">anaconda-ks.cfg                          视频</span><br><span class="line">apache                                   图片</span><br><span class="line">initial-setup-ks.cfg                     文档</span><br><span class="line">mysql-5.7.25-linux-glibc2.12-x86_64.tar  下载</span><br><span class="line">table-2019-04-29_14:45:41.sql            音乐</span><br><span class="line">wenhs-2019-04-29_14:46:35.sql            桌面</span><br><span class="line">公共</span><br><span class="line">[root@wenhs5479 ~]# mysql &lt;all-2019-04-29_14\:44\:04.sql 	配置了免密登录</span><br><span class="line">[root@wenhs5479 ~]# mysql -e &apos;show databases;&apos;</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| sys                |</span><br><span class="line">| wenhs              |</span><br><span class="line">+--------------------+</span><br><span class="line"></span><br><span class="line">恢复wenhs数据库的student表和teacher表</span><br><span class="line">mysql&gt; use wenhs;</span><br><span class="line">Reading table information for completion of table and column names</span><br><span class="line">You can turn off this feature to get a quicker startup with -A</span><br><span class="line"></span><br><span class="line">mysql&gt; source table-2019-04-29_14:45:41.sql</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line">......</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; show tables;</span><br><span class="line">+-----------------+</span><br><span class="line">| Tables_in_wenhs |</span><br><span class="line">+-----------------+</span><br><span class="line">| student         |</span><br><span class="line">| teacher         |</span><br><span class="line">+-----------------+</span><br><span class="line">2 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">模拟删除整个数据库</span><br><span class="line">mysql&gt; drop database wenhs;</span><br><span class="line">Query OK, 2 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; show databases;</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| sys                |</span><br><span class="line">+--------------------+</span><br><span class="line">4 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">恢复整个数据库</span><br><span class="line">[root@wenhs5479 ~]# mysql &lt; all-2019-04-29_14\:44\:04.sql </span><br><span class="line">[root@wenhs5479 ~]# mysql wenhs &lt; table-2019-04-29_14\:45\:41.sql    此步多余,第一次全备中,库里面数据都已经备份,不需要这步</span><br><span class="line">[root@wenhs5479 ~]# mysql -e &apos;select * from wenhs.student;&apos;</span><br><span class="line">+----+-------------+------+</span><br><span class="line">| id | name        | age  |</span><br><span class="line">+----+-------------+------+</span><br><span class="line">|  1 | tom         |   20 |</span><br><span class="line">|  2 | jerry       |   23 |</span><br><span class="line">|  3 | wangqing    |   25 |</span><br><span class="line">|  4 | sean        |   28 |</span><br><span class="line">|  5 | zhangshan   |   26 |</span><br><span class="line">|  7 | lisi        |   50 |</span><br><span class="line">|  8 | chenshuo    |   10 |</span><br><span class="line">|  9 | wangwu      |    3 |</span><br><span class="line">| 10 | qiuyi       |   15 |</span><br><span class="line">| 11 | qiuxiaotian |   20 |</span><br><span class="line">+----+-------------+------+</span><br></pre></td></tr></table></figure>

<h3 id="3-4-差异备份与恢复"><a href="#3-4-差异备份与恢复" class="headerlink" title="3.4 差异备份与恢复"></a>3.4 差异备份与恢复</h3><h4 id="3-4-1-MySQL的差异备份"><a href="#3-4-1-MySQL的差异备份" class="headerlink" title="3.4.1 MySQL的差异备份"></a>3.4.1 MySQL的差异备份</h4><p><strong>开启的MySQL服务器的二进制日志功能</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@wenhs5479 ~]# vim /etc/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">basedir = /usr/local/mysql</span><br><span class="line">datadir = /opt/data</span><br><span class="line">socket = /tmp/mysql.sock</span><br><span class="line">port = 3306</span><br><span class="line">pid-file = /opt/data/mysql.pid</span><br><span class="line">user = mysql</span><br><span class="line">skip-name-resolve</span><br><span class="line"></span><br><span class="line">server-id=1			设置服务器标识符</span><br><span class="line">log-bin=mysql_bin				开启二进制日志功能</span><br><span class="line">[root@wenhs5479 ~]# service mysqld restart</span><br><span class="line">Shutting down MySQL.. SUCCESS! </span><br><span class="line">Starting MySQL. SUCCESS!</span><br></pre></td></tr></table></figure>

<p><strong>对数据库进行完全备份</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line">[root@wenhs5479 ~]# mysql			配置了免密登录</span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 2</span><br><span class="line">Server version: 5.7.25-log MySQL Community Server (GPL)</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2019, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type &apos;help;&apos; or &apos;\h&apos; for help. Type &apos;\c&apos; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">mysql&gt; show databases;</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| sys                |</span><br><span class="line">| wenhs              |</span><br><span class="line">+--------------------+</span><br><span class="line">5 rows in set (0.01 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; show tables from wenhs;</span><br><span class="line">+-----------------+</span><br><span class="line">| Tables_in_wenhs |</span><br><span class="line">+-----------------+</span><br><span class="line">| student         |</span><br><span class="line">| teacher         |</span><br><span class="line">+-----------------+</span><br><span class="line">2 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from wenhs.student;</span><br><span class="line">+----+-------------+------+</span><br><span class="line">| id | name        | age  |</span><br><span class="line">+----+-------------+------+</span><br><span class="line">|  1 | tom         |   20 |</span><br><span class="line">|  2 | jerry       |   23 |</span><br><span class="line">|  3 | wangqing    |   25 |</span><br><span class="line">|  4 | sean        |   28 |</span><br><span class="line">|  5 | zhangshan   |   26 |</span><br><span class="line">|  7 | lisi        |   50 |</span><br><span class="line">|  8 | chenshuo    |   10 |</span><br><span class="line">|  9 | wangwu      |    3 |</span><br><span class="line">| 10 | qiuyi       |   15 |</span><br><span class="line">| 11 | qiuxiaotian |   20 |</span><br><span class="line">+----+-------------+------+</span><br><span class="line">10 rows in set (0.01 sec)</span><br><span class="line"></span><br><span class="line">完全备份</span><br><span class="line">[root@wenhs5479 ~]# mysqldump --single-transaction --flush-logs --master-data=2 --all-databases --delete-master-logs &gt; all-$(date +%F_%T).sql</span><br><span class="line">[root@wenhs5479 ~]# ll</span><br><span class="line">总用量 660192</span><br><span class="line">-rw-r--r--. 1 root root    794130 4月  30 09:43 all-2019-04-30_09:43:24.sql</span><br><span class="line"></span><br><span class="line">增加新内容</span><br><span class="line">mysql&gt; use wenhs;</span><br><span class="line">Reading table information for completion of table and column names</span><br><span class="line">You can turn off this feature to get a quicker startup with -A</span><br><span class="line"></span><br><span class="line">Database changed</span><br><span class="line">mysql&gt; insert into student values(100,&apos;hehe&apos;,20),(200,&apos;xixi&apos;,34);</span><br><span class="line">Query OK, 2 rows affected (0.00 sec)</span><br><span class="line">Records: 2  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">mysql&gt; </span><br><span class="line">mysql&gt; select * from student;</span><br><span class="line">+-----+-------------+------+</span><br><span class="line">| id  | name        | age  |</span><br><span class="line">+-----+-------------+------+</span><br><span class="line">|   1 | tom         |   20 |</span><br><span class="line">|   2 | jerry       |   23 |</span><br><span class="line">|   3 | wangqing    |   25 |</span><br><span class="line">|   4 | sean        |   28 |</span><br><span class="line">|   5 | zhangshan   |   26 |</span><br><span class="line">|   7 | lisi        |   50 |</span><br><span class="line">|   8 | chenshuo    |   10 |</span><br><span class="line">|   9 | wangwu      |    3 |</span><br><span class="line">|  10 | qiuyi       |   15 |</span><br><span class="line">|  11 | qiuxiaotian |   20 |</span><br><span class="line">| 100 | hehe        |   20 |</span><br><span class="line">| 200 | xixi        |   34 |</span><br><span class="line">+-----+-------------+------+</span><br><span class="line">12 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; update student set age = 100 where id = 100;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line">Rows matched: 1  Changed: 1  Warnings: 0</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from student;</span><br><span class="line">+-----+-------------+------+</span><br><span class="line">| id  | name        | age  |</span><br><span class="line">+-----+-------------+------+</span><br><span class="line">|   1 | tom         |   20 |</span><br><span class="line">|   2 | jerry       |   23 |</span><br><span class="line">|   3 | wangqing    |   25 |</span><br><span class="line">|   4 | sean        |   28 |</span><br><span class="line">|   5 | zhangshan   |   26 |</span><br><span class="line">|   7 | lisi        |   50 |</span><br><span class="line">|   8 | chenshuo    |   10 |</span><br><span class="line">|   9 | wangwu      |    3 |</span><br><span class="line">|  10 | qiuyi       |   15 |</span><br><span class="line">|  11 | qiuxiaotian |   20 |</span><br><span class="line">| 100 | hehe        |  100 |</span><br><span class="line">| 200 | xixi        |   34 |</span><br><span class="line">+-----+-------------+------+</span><br><span class="line">12 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<h4 id="3-4-2-mysql差异备份恢复"><a href="#3-4-2-mysql差异备份恢复" class="headerlink" title="3.4.2. mysql差异备份恢复"></a>3.4.2. mysql差异备份恢复</h4><p>模拟误删数据库</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@wenhs5479 ~]# mysql -e &apos;drop database wenhs;&apos;</span><br><span class="line">[root@wenhs5479 ~]# mysql -e &apos;show databases;&apos;</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| sys                |</span><br><span class="line">+--------------------+</span><br><span class="line">由上可以看到wenhs这个数据库已被删除</span><br></pre></td></tr></table></figure>

<p>刷新创建新的二进制日志</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[root@wenhs5479 ~]# ll /opt/data/</span><br><span class="line">总用量 122944</span><br><span class="line">-rw-r-----. 1 mysql mysql       56 4月  29 12:25 auto.cnf</span><br><span class="line">-rw-r-----. 1 mysql mysql     1008 4月  30 09:38 ib_buffer_pool</span><br><span class="line">-rw-r-----. 1 mysql mysql 12582912 4月  30 09:58 ibdata1</span><br><span class="line">-rw-r-----. 1 mysql mysql 50331648 4月  30 09:58 ib_logfile0</span><br><span class="line">-rw-r-----. 1 mysql mysql 50331648 4月  29 12:25 ib_logfile1</span><br><span class="line">-rw-r-----. 1 mysql mysql 12582912 4月  30 09:43 ibtmp1</span><br><span class="line">drwxr-x---. 2 mysql mysql     4096 4月  29 15:09 mysql</span><br><span class="line">-rw-r-----. 1 mysql mysql      877 4月  30 09:58 mysql_bin.000002</span><br><span class="line">-rw-r-----. 1 mysql mysql       19 4月  30 09:43 mysql_bin.index</span><br><span class="line">-rw-r-----. 1 mysql mysql        6 4月  30 09:38 mysql.pid</span><br><span class="line">drwxr-x---. 2 mysql mysql     8192 4月  29 12:25 performance_schema</span><br><span class="line">drwxr-x---. 2 mysql mysql     8192 4月  29 12:25 sys</span><br><span class="line">-rw-r-----. 1 mysql mysql    12748 4月  30 09:38 wenhs5479.err</span><br><span class="line">[root@wenhs5479 ~]# mysqladmin flush-logs</span><br><span class="line">[root@wenhs5479 ~]# ll /opt/data/</span><br><span class="line">总用量 122948</span><br><span class="line">-rw-r-----. 1 mysql mysql       56 4月  29 12:25 auto.cnf</span><br><span class="line">-rw-r-----. 1 mysql mysql     1008 4月  30 09:38 ib_buffer_pool</span><br><span class="line">-rw-r-----. 1 mysql mysql 12582912 4月  30 09:58 ibdata1</span><br><span class="line">-rw-r-----. 1 mysql mysql 50331648 4月  30 09:58 ib_logfile0</span><br><span class="line">-rw-r-----. 1 mysql mysql 50331648 4月  29 12:25 ib_logfile1</span><br><span class="line">-rw-r-----. 1 mysql mysql 12582912 4月  30 09:43 ibtmp1</span><br><span class="line">drwxr-x---. 2 mysql mysql     4096 4月  29 15:09 mysql</span><br><span class="line">-rw-r-----. 1 mysql mysql      924 4月  30 09:59 mysql_bin.000002</span><br><span class="line">-rw-r-----. 1 mysql mysql      154 4月  30 09:59 mysql_bin.000003</span><br><span class="line">-rw-r-----. 1 mysql mysql       38 4月  30 09:59 mysql_bin.index</span><br><span class="line">-rw-r-----. 1 mysql mysql        6 4月  30 09:38 mysql.pid</span><br><span class="line">drwxr-x---. 2 mysql mysql     8192 4月  29 12:25 performance_schema</span><br><span class="line">drwxr-x---. 2 mysql mysql     8192 4月  29 12:25 sys</span><br><span class="line">-rw-r-----. 1 mysql mysql    12748 4月  30 09:38 wenhs5479.err</span><br></pre></td></tr></table></figure>

<p>恢复完全备份</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">[root@wenhs5479 ~]# mysql &lt;all-2019-04-30_09\:43\:24.sql </span><br><span class="line">[root@wenhs5479 ~]# mysql -e &apos;show databases;&apos;</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| sys                |</span><br><span class="line">| wenhs              |</span><br><span class="line">+--------------------+</span><br><span class="line">[root@wenhs5479 ~]# mysql -e &apos;show tables from wenhs;&apos;</span><br><span class="line">+-----------------+</span><br><span class="line">| Tables_in_wenhs |</span><br><span class="line">+-----------------+</span><br><span class="line">| student         |</span><br><span class="line">| teacher         |</span><br><span class="line">+-----------------+</span><br><span class="line">[root@wenhs5479 ~]# mysql -e &apos;select * from wenhs.student;&apos;</span><br><span class="line">+----+-------------+------+</span><br><span class="line">| id | name        | age  |</span><br><span class="line">+----+-------------+------+</span><br><span class="line">|  1 | tom         |   20 |</span><br><span class="line">|  2 | jerry       |   23 |</span><br><span class="line">|  3 | wangqing    |   25 |</span><br><span class="line">|  4 | sean        |   28 |</span><br><span class="line">|  5 | zhangshan   |   26 |</span><br><span class="line">|  7 | lisi        |   50 |</span><br><span class="line">|  8 | chenshuo    |   10 |</span><br><span class="line">|  9 | wangwu      |    3 |</span><br><span class="line">| 10 | qiuyi       |   15 |</span><br><span class="line">| 11 | qiuxiaotian |   20 |</span><br><span class="line">+----+-------------+------+</span><br><span class="line">[root@wenhs5479 ~]# mysql -e &apos;select * from wenhs.teacher;&apos;</span><br><span class="line">+----+-------------+------+</span><br><span class="line">| id | name        | age  |</span><br><span class="line">+----+-------------+------+</span><br><span class="line">|  1 | tom         |   20 |</span><br><span class="line">|  2 | jerry       |   23 |</span><br><span class="line">|  3 | wangqing    |   25 |</span><br><span class="line">|  4 | sean        |   28 |</span><br><span class="line">|  5 | zhangshan   |   26 |</span><br><span class="line">|  6 | zhangshan   |   20 |</span><br><span class="line">|  7 | lisi        | NULL |</span><br><span class="line">|  8 | chenshuo    |   10 |</span><br><span class="line">|  9 | wangwu      |    3 |</span><br><span class="line">| 10 | qiuyi       |   15 |</span><br><span class="line">| 11 | qiuxiaotian |   20 |</span><br><span class="line">+----+-------------+------+</span><br></pre></td></tr></table></figure>

<p>恢复差异备份</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">[root@wenhs5479 ~]# ll /opt/data/</span><br><span class="line">总用量 123704</span><br><span class="line">-rw-r-----. 1 mysql mysql       56 4月  29 12:25 auto.cnf</span><br><span class="line">-rw-r-----. 1 mysql mysql     1008 4月  30 09:38 ib_buffer_pool</span><br><span class="line">-rw-r-----. 1 mysql mysql 12582912 4月  30 10:00 ibdata1</span><br><span class="line">-rw-r-----. 1 mysql mysql 50331648 4月  30 10:00 ib_logfile0</span><br><span class="line">-rw-r-----. 1 mysql mysql 50331648 4月  29 12:25 ib_logfile1</span><br><span class="line">-rw-r-----. 1 mysql mysql 12582912 4月  30 09:43 ibtmp1</span><br><span class="line">drwxr-x---. 2 mysql mysql     4096 4月  30 10:00 mysql</span><br><span class="line">-rw-r-----. 1 mysql mysql      924 4月  30 09:59 mysql_bin.000002</span><br><span class="line">-rw-r-----. 1 mysql mysql   776980 4月  30 10:00 mysql_bin.000003</span><br><span class="line">-rw-r-----. 1 mysql mysql       38 4月  30 09:59 mysql_bin.index</span><br><span class="line">-rw-r-----. 1 mysql mysql        6 4月  30 09:38 mysql.pid</span><br><span class="line">drwxr-x---. 2 mysql mysql     8192 4月  29 12:25 performance_schema</span><br><span class="line">drwxr-x---. 2 mysql mysql     8192 4月  29 12:25 sys</span><br><span class="line">drwxr-x---. 2 mysql mysql       96 4月  30 10:00 wenhs</span><br><span class="line">-rw-r-----. 1 mysql mysql    12748 4月  30 09:38 wenhs5479.err</span><br><span class="line">[root@wenhs5479 ~]# mysql</span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 13</span><br><span class="line">Server version: 5.7.25-log MySQL Community Server (GPL)</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2019, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type &apos;help;&apos; or &apos;\h&apos; for help. Type &apos;\c&apos; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">mysql&gt; show binlog events in &apos;mysql_bin.000002&apos;;</span><br><span class="line">+------------------+-----+----------------+-----------+-------------+---------------------------------------+</span><br><span class="line">| Log_name         | Pos | Event_type     | Server_id | End_log_pos | Info                                  |</span><br><span class="line">+------------------+-----+----------------+-----------+-------------+---------------------------------------+</span><br><span class="line">| mysql_bin.000002 |   4 | Format_desc    |         1 |         123 | Server ver: 5.7.25-log, Binlog ver: 4 |</span><br><span class="line">| mysql_bin.000002 | 123 | Previous_gtids |         1 |         154 |                                       |</span><br><span class="line">| mysql_bin.000002 | 154 | Anonymous_Gtid |         1 |         219 | SET @@SESSION.GTID_NEXT= &apos;ANONYMOUS&apos;  |</span><br><span class="line">| mysql_bin.000002 | 219 | Query          |         1 |         292 | BEGIN                                 |</span><br><span class="line">| mysql_bin.000002 | 292 | Table_map      |         1 |         347 | table_id: 141 (wenhs.student)         |</span><br><span class="line">| mysql_bin.000002 | 347 | Write_rows     |         1 |         404 | table_id: 141 flags: STMT_END_F       |</span><br><span class="line">| mysql_bin.000002 | 404 | Xid            |         1 |         435 | COMMIT /* xid=487 */                  |</span><br><span class="line">| mysql_bin.000002 | 435 | Anonymous_Gtid |         1 |         500 | SET @@SESSION.GTID_NEXT= &apos;ANONYMOUS&apos;  |</span><br><span class="line">| mysql_bin.000002 | 500 | Query          |         1 |         573 | BEGIN                                 |</span><br><span class="line">| mysql_bin.000002 | 573 | Table_map      |         1 |         628 | table_id: 141 (wenhs.student)         |</span><br><span class="line">| mysql_bin.000002 | 628 | Update_rows    |         1 |         686 | table_id: 141 flags: STMT_END_F       |</span><br><span class="line">| mysql_bin.000002 | 686 | Xid            |         1 |         717 | COMMIT /* xid=489 */                  |</span><br><span class="line">| mysql_bin.000002 | 717 | Anonymous_Gtid |         1 |         782 | SET @@SESSION.GTID_NEXT= &apos;ANONYMOUS&apos;  |</span><br><span class="line">| mysql_bin.000002 | 782 | Query          |         1 |         877 | drop database wenhs                   |</span><br><span class="line">| mysql_bin.000002 | 877 | Rotate         |         1 |         924 | mysql_bin.000003;pos=4                |</span><br><span class="line">+------------------+-----+----------------+-----------+-------------+---------------------------------------+</span><br><span class="line">15 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">使用mysqlbinlog恢复差异备份</span><br><span class="line">[root@wenhs5479 ~]# mysqlbinlog --stop-position=782 /opt/data/mysql_bin.000002 |mysql-----配置了密码登录,否则要-u和-p</span><br><span class="line">[root@wenhs5479 ~]# mysql -e &apos;select * from wenhs.student;&apos;</span><br><span class="line">+-----+-------------+------+</span><br><span class="line">| id  | name        | age  |</span><br><span class="line">+-----+-------------+------+</span><br><span class="line">|   1 | tom         |   20 |</span><br><span class="line">|   2 | jerry       |   23 |</span><br><span class="line">|   3 | wangqing    |   25 |</span><br><span class="line">|   4 | sean        |   28 |</span><br><span class="line">|   5 | zhangshan   |   26 |</span><br><span class="line">|   7 | lisi        |   50 |</span><br><span class="line">|   8 | chenshuo    |   10 |</span><br><span class="line">|   9 | wangwu      |    3 |</span><br><span class="line">|  10 | qiuyi       |   15 |</span><br><span class="line">|  11 | qiuxiaotian |   20 |</span><br><span class="line">| 100 | hehe        |  100 |</span><br><span class="line">| 200 | xixi        |   34 |</span><br><span class="line">+-----+-------------+------+</span><br></pre></td></tr></table></figure>

<h1 id="4-xtrabackup"><a href="#4-xtrabackup" class="headerlink" title="4.xtrabackup"></a>4.xtrabackup</h1><p>Percona XtraBackup工具提供了一种在系统运行时执行MySQL数据热备份的方法。Percona XtraBackup是一款免费的在线开源完整数据库备份解决方案，适用于所有版本的Percona Server for MySQL和MySQL®。Percona XtraBackup在事务性系统上执行在线非阻塞，紧密压缩，高度安全的完整备份，以便应用程序在计划维护窗口期间保持完全可用。</p>
<p>可在事务系统上执行在线无阻塞，紧密压缩，高度安全的完整MySQL备份，以便在计划维护窗口期间完全可用任务关键型应用程序。</p>
<p>在本地和云中工作</p>
<ul>
<li>Percona XtraBackup与当今的云提供商（如AWS，Google Cloud，Microsoft<br>Azure等）完全兼容，完全部署在云中或作为混合解决方案。</li>
</ul>
<p>保持数据库的实时</p>
<ul>
<li>企业准备就绪 Percona XtraBackup具有企业所需的所有工具和功能，可确保数据文件的一致性和安全性。</li>
</ul>
<p>保持数据库的实时</p>
<ul>
<li>简化操作 </li>
<li>通过使用Percona XtraBackup加速数据库操作并将数据复制到新的复制从属，可以节省时间和金钱。</li>
</ul>
<p>保持数据库的实时</p>
<ul>
<li>非阻塞备份 </li>
<li>Percona XtraBackup允许您在生产中备份数据库，而不会影响正常运行时间或数据更改。</li>
</ul>
<p>保持数据库的实时</p>
<ul>
<li>备份自动化 </li>
<li>您可以自动执行备份过程并验证自动备份。</li>
</ul>
<p>当与Percona Server for MySQL结合使用时，Percona XtraBackup为当前可用的事务系统提供唯一真正的非阻塞在线实时MySQL备份。</p>
<p><strong>Percona XtraBackup提供：</strong></p>
<ul>
<li>快速可靠的数据库备份（例如热备份，增量备份，bacula备份等）</li>
<li>备份期间不间断的事务处理</li>
<li>通过更好的压缩节省磁盘空间和网络带宽</li>
<li>自动备份验证</li>
<li>由于更快的恢复时间，正常运行时间更长</li>
<li>时间点恢复</li>
</ul>
<p><a href="https://www.cnblogs.com/f-ck-need-u/p/9018716.html" target="_blank" rel="noopener">点这里,了解此工具详解</a></p>
<h1 id="5-冷备-温备-热备详解"><a href="#5-冷备-温备-热备详解" class="headerlink" title="5.冷备,温备,热备详解"></a>5.冷备,温备,热备详解</h1><p><strong>按备份系统的准备程度，可将其分为 冷备份、温备份和热备份三大类 :</strong></p>
<ul>
<li><p><strong>冷备份</strong> : 备份系统未安装或未配置成与当前使用的系统相同或相似的运行环境，应用系统数据没有及时装入备份系统。一旦发生灾难，需安装配置所需的运行环境，用数据备份介质(磁带或光盘)<br>恢复应用数据，手工逐笔或自动批量追补孤立数据，将终端用户通过通讯线路切换到备份系统，恢复业务运行</p>
<ul>
<li><input disabled type="checkbox"> 优点 : 设备投资较少，节省通信费用，通信环境要求不高</li>
<li><input disabled type="checkbox"> 缺点 : 恢复时间较长，一般要数天至1周，数据完整性与一致性较差</li>
</ul>
</li>
<li><p><strong>温备份</strong> : 将备份系统已安装配置成与当前使用的系统相同或相似的系统和网络运行环境，安装应用系统业务定期备份数据。一旦发生灾难，直接使用定期备份数据，手工逐笔或自动批量追补孤立数据或将终端用户通过通讯线路切换到备份系统，恢复业务运行</p>
<ul>
<li><input disabled type="checkbox"> 优点 : 设备投资较少，通信环境要求不高</li>
<li><input disabled type="checkbox"> 缺点 : 恢复时间长，一般要十几个小时至数天，数据完整性与一致性较差</li>
</ul>
</li>
<li><p><strong>热备份</strong> : 备份处于联机状态，当前应用系统通过高速通信线路将数据实时传送到备份系统，保持备份系统与当前应用系统数据的同步；也可定时在备份系统上恢复应用系统的数据。一旦发生灾难，不用追补或只需追补很少的孤立数据，备份系统可快速接替生产系统运行，恢复营业</p>
<ul>
<li><input disabled type="checkbox"> 优点 : 恢复时间短，一般几十分钟到数小时，数据完整性与一致性最好，数据丢失可能性最小</li>
<li><input disabled type="checkbox"> 缺点 : 设备投资大，通信费用高，通信环境要求高，平时运行管理较复杂</li>
</ul>
</li>
</ul>
<p><strong>在计算机服务器备份和恢复中</strong>
　</p>
<ul>
<li>冷备份服务器(cold server)<br>是在主服务器丢失的情况下才使用的备份服务器。冷备份服务器基本上只在软件安装和配置的情况下打开，然后关闭直到需要时再打开</li>
<li>温备份服务器(warm server) 一般都是周期性开机，根据主服务器内容进行更新，然后关机。经常用温备份服务器来进行复制和镜像操作</li>
<li>热备份服务器(hot server) 时刻处于开机状态，同主机保持同步。当主机失灵时，可以随时启用热备份服务器来代替</li>
</ul>

          
        
      
    </div>

    

    

    
    
    

    

    
      
    
    

    
	
	  <div>
        
      </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://aiwhs.github.io/2018/11/24/MYSQL1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="itw">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="itw">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2018/11/24/MYSQL1/" class="post-title-link" itemprop="url">MySQL基础</a>
              
            
          </h1>
        

        <div class="post-meta">

          
          
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-11-24 08:15:57" itemprop="dateCreated datePublished" datetime="2018-11-24T08:15:57+08:00">2018-11-24</time>
            </span>
          

          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-07-10 14:40:33" itemprop="dateModified" datetime="2019-07-10T14:40:33+08:00">2019-07-10</time>
              </span>
            
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Linux运维/" itemprop="url" rel="index"><span itemprop="name">Linux运维</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          <br>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <a id="more"></a>

<h1 id="1-关系型数据库介绍"><a href="#1-关系型数据库介绍" class="headerlink" title="1. 关系型数据库介绍"></a>1. 关系型数据库介绍</h1><h3 id="1-1-数据结构模型"><a href="#1-1-数据结构模型" class="headerlink" title="1.1 数据结构模型"></a>1.1 数据结构模型</h3><p>数据结构模型主要有：</p>
<ul>
<li>层次模型</li>
<li>网状结构</li>
<li>关系模型</li>
</ul>
<p>关系模型：<br>二维关系：row，column</p>
<p>数据库管理系统：DBMS<br>关系：Relational，RDBMS</p>
<h3 id="1-2-RDBMS专业名词"><a href="#1-2-RDBMS专业名词" class="headerlink" title="1.2 RDBMS专业名词"></a>1.2 RDBMS专业名词</h3><p><strong>常见的关系型数据库管理系统：</strong></p>
<ul>
<li>MySQL：MySQL，MariaDB，Percona-Server</li>
<li>PostgreSQL：简称为pgsql</li>
<li>Oracle</li>
<li>MSSQL</li>
</ul>
<p><strong>记录</strong>:数据库中表的每行是一条记录</p>
<p><strong>事务</strong>：多个操作被当作一个整体对待就称为一个事务</p>
<p>要看一个关系型数据库是否支持事务，需要看其是否支持并满足ACID测试<br>ACID：ACID是事务的一个基本标准</p>
<ul>
<li>A：Automicity，原子性</li>
<li>C：Consistency，一致性</li>
<li>I：Isolation，隔离性</li>
<li>D：Durability，持久性</li>
</ul>
<p>ACID，可以查看<a href="https://baike.baidu.com/item/acid/10738" target="_blank" rel="noopener">这里</a>了解详细说明，</p>
<p><strong>SQL</strong>：Structure Query Language，结构化查询语言</p>
<p><strong>约束</strong>：constraint，向数据表提供的数据要遵守的限制</p>
<ul>
<li>主键约束：一个或多个字段的组合，填入的数据必须能在本表中唯一标识本行。且必须提供数据，不能为空（NOT NULL）。<ul>
<li><input disabled type="checkbox"> 一个表只能存在一个</li>
</ul>
</li>
<li>惟一键约束：一个或多个字段的组合，填入的数据必须能在本表中唯一标识本行。允许为空（NULL）<ul>
<li><input disabled type="checkbox"> 一个表可以存在多个</li>
</ul>
</li>
<li>外键约束：一个表中的某字段可填入数据取决于另一个表的主键已有的数据</li>
<li>检查性约束</li>
</ul>
<p><strong>索引</strong>：将表中的一个或多个字段中的数据复制一份另存，并且这些数据需要按特定次序排序存储</p>
<p><strong>关系运算</strong>：</p>
<ul>
<li>选择：挑选出符合条件的行（部分行）</li>
<li>投影：挑选出需要的字段</li>
<li>连接</li>
</ul>
<p><strong>数据抽象方式</strong>：</p>
<ul>
<li>物理层：决定数据的存储格式，即RDBMS在磁盘上如何组织文件</li>
<li>逻辑层：描述DB存储什么数据，以及数据间存在什么样的关系</li>
<li>视图层：描述DB中的部分数据</li>
</ul>
<h3 id="1-3-关系型数据库的常见组件"><a href="#1-3-关系型数据库的常见组件" class="headerlink" title="1.3 关系型数据库的常见组件"></a>1.3 关系型数据库的常见组件</h3><p>关系型数据库的常见组件有：</p>
<ul>
<li>数据库：database</li>
<li>表：table，由行（row）和列（column）组成</li>
<li>索引：index</li>
<li>视图：view</li>
<li>用户：user</li>
<li>权限：privilege</li>
<li>存储过程：procedure</li>
<li>存储函数：function</li>
<li>触发器：trigger</li>
<li>事件调度器：event scheduler</li>
</ul>
<h3 id="1-4-SQL语句"><a href="#1-4-SQL语句" class="headerlink" title="1.4 SQL语句"></a>1.4 SQL语句</h3><p>SQL语句有三种类型：</p>
<ul>
<li>DDL：Data Defination Language，数据定义语言</li>
<li>DML：Data Manipulation Language，数据操纵语言</li>
<li>DCL：Data Control Language，数据控制语言</li>
</ul>
<table>
<thead>
<tr>
<th>SQL语句类型</th>
<th>对应操作</th>
</tr>
</thead>
<tbody><tr>
<td>DDL</td>
<td>CREATE：创建<br>DROP：删除<br>ALTER：修改</td>
</tr>
<tr>
<td>DML</td>
<td>INSERT：向表中插入数据<br>DELETE：删除表中数据<br>UPDATE：更新表中数据<br>SELECT：查询表中数据</td>
</tr>
<tr>
<td>DCL</td>
<td>GRANT：授权<br>REVOKE：移除授权</td>
</tr>
</tbody></table>
<h1 id="2-mysql安装与配置"><a href="#2-mysql安装与配置" class="headerlink" title="2. mysql安装与配置"></a>2. mysql安装与配置</h1><h3 id="2-1-mysql安装"><a href="#2-1-mysql安装" class="headerlink" title="2.1 mysql安装"></a>2.1 mysql安装</h3><p>mysql安装方式有三种：</p>
<ul>
<li>源代码：编译安装</li>
<li>二进制格式的程序包：展开至特定路径，并经过简单配置后即可使用</li>
<li>程序包管理器管理的程序包：<ul>
<li><input disabled type="checkbox"> rpm：有两种<ul>
<li>OS Vendor：操作系统发行商提供的</li>
<li>项目官方提供的<ul>
<li><input disabled type="checkbox"> deb</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">配置MySQL安装源:</span><br><span class="line">[root@ip-10-0-100-141 ~]# cd /usr/src/</span><br><span class="line">[root@ip-10-0-100-141 src]# ls</span><br><span class="line">debug  kernels</span><br><span class="line">[root@ip-10-0-100-141 src]# wget http://dev.mysql.com/get/mysql57-community-release-el7-10.noarch.rpm</span><br><span class="line">--2019-04-22 15:04:45--  http://dev.mysql.com/get/mysql57-community-release-el7-10.noarch.rpm</span><br><span class="line">正在解析主机 dev.mysql.com (dev.mysql.com)... 137.254.60.11</span><br><span class="line">......</span><br><span class="line"></span><br><span class="line">100%[=============================================&gt;] 25,548      --.-K/s 用时 0.04s   </span><br><span class="line"></span><br><span class="line">2019-04-22 15:04:55 (572 KB/s) - 已保存 “mysql57-community-release-el7-10.noarch.rpm” [25548/25548])</span><br><span class="line"></span><br><span class="line">[root@ip-10-0-100-141 src]# ls</span><br><span class="line">debug  kernels  mysql57-community-release-el7-10.noarch.rpm</span><br><span class="line">[root@ip-10-0-100-141 src]# rpm -ivh mysql57-community-release-el7-10.noarch.rpm </span><br><span class="line">警告：mysql57-community-release-el7-10.noarch.rpm: 头V3 DSA/SHA1 Signature, 密钥 ID 5072e1f5: NOKEY</span><br><span class="line">准备中...                          ################################# [100%]</span><br><span class="line">正在升级/安装...</span><br><span class="line">   1:mysql57-community-release-el7-10 ################################# [100%]</span><br><span class="line">[root@ip-10-0-100-141 src]# ls /etc/yum.repos.d/</span><br><span class="line">mysql-community.repo         redhat-rhui-client-config.repo  rhui-load-balancers.conf</span><br><span class="line">mysql-community-source.repo  redhat-rhui.repo</span><br><span class="line">[root@ip-10-0-100-141 src]#</span><br><span class="line"></span><br><span class="line">安装MySQL5.7</span><br><span class="line">[root@ip-10-0-100-141 ~]# yum -y install mysql-community-server mysql-community-client mysql-community-common mysql-community-devel</span><br><span class="line">......</span><br><span class="line">Installed:</span><br><span class="line">  mysql-community-client.x86_64 0:5.7.25-1.el7                                         </span><br><span class="line">  mysql-community-common.x86_64 0:5.7.25-1.el7                                         </span><br><span class="line">  mysql-community-devel.x86_64 0:5.7.25-1.el7                                          </span><br><span class="line">  mysql-community-libs.x86_64 0:5.7.25-1.el7                                           </span><br><span class="line">  mysql-community-libs-compat.x86_64 0:5.7.25-1.el7                                    </span><br><span class="line">  mysql-community-server.x86_64 0:5.7.25-1.el7                                         </span><br><span class="line"></span><br><span class="line">Dependency Installed:</span><br><span class="line">  libaio.x86_64 0:0.3.109-13.el7                                                       </span><br><span class="line"></span><br><span class="line">Replaced:</span><br><span class="line">  mariadb-libs.x86_64 1:5.5.60-1.el7_5                                                 </span><br><span class="line"></span><br><span class="line">Complete!</span><br></pre></td></tr></table></figure>

<h3 id="2-2MySQL配置"><a href="#2-2MySQL配置" class="headerlink" title="2.2MySQL配置"></a>2.2MySQL配置</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line">启动MySQL</span><br><span class="line">[root@ip-10-0-100-141 ~]# systemctl start mysqld</span><br><span class="line">[root@ip-10-0-100-141 ~]# systemctl status mysqld</span><br><span class="line">● mysqld.service - MySQL Server</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/mysqld.service; enabled; vendor preset: disabled)</span><br><span class="line">   Active: active (running) since Mon 2019-04-22 07:46:26 UTC; 11s ago</span><br><span class="line">     Docs: man:mysqld(8)</span><br><span class="line">           http://dev.mysql.com/doc/refman/en/using-systemd.html</span><br><span class="line">  Process: 4802 ExecStart=/usr/sbin/mysqld --daemonize --pid-file=/var/run/mysqld/mysqld.pid $MYSQLD_OPTS (code=exited, status=0/SUCCESS)</span><br><span class="line">  Process: 4725 ExecStartPre=/usr/bin/mysqld_pre_systemd (code=exited, status=0/SUCCESS)</span><br><span class="line"> Main PID: 4805 (mysqld)</span><br><span class="line">   CGroup: /system.slice/mysqld.service</span><br><span class="line">           └─4805 /usr/sbin/mysqld --daemonize --pid-file=/var/run/mysqld/mysqld.pid...</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Apr 22 07:46:21 ip-10-0-100-141.ap-northeast-1.compute.internal systemd[1]: Starting...</span><br><span class="line">Apr 22 07:46:26 ip-10-0-100-141.ap-northeast-1.compute.internal systemd[1]: Started ...</span><br><span class="line">Hint: Some lines were ellipsized, use -l to show in full.</span><br><span class="line"></span><br><span class="line">确认3306端口已经监听起来</span><br><span class="line">[root@ip-10-0-100-141 ~]# ss -aultn</span><br><span class="line">Netid State      Recv-Q Send-Q Local Address:Port               Peer Address:Port              </span><br><span class="line">udp   UNCONN     0      0             *:68                        *:*                  </span><br><span class="line">udp   UNCONN     0      0      127.0.0.1:323                       *:*                  </span><br><span class="line">udp   UNCONN     0      0           ::1:323                      :::*                  </span><br><span class="line">tcp   LISTEN     0      128           *:22                        *:*                  </span><br><span class="line">tcp   LISTEN     0      100    127.0.0.1:25                        *:*                  </span><br><span class="line">tcp   LISTEN     0      80           :::3306                     :::*                  </span><br><span class="line">tcp   LISTEN     0      128          :::80                       :::*                  </span><br><span class="line">tcp   LISTEN     0      128          :::22                       :::*                  </span><br><span class="line">tcp   LISTEN     0      100         ::1:25                       :::*                  </span><br><span class="line">tcp   LISTEN     0      128          :::443                      :::*</span><br><span class="line"></span><br><span class="line">在日志文件中找出临时密码</span><br><span class="line">[root@ip-10-0-100-141 ~]# grep password /var/log/mysqld.log </span><br><span class="line">2019-04-22T07:46:24.034205Z 1 [Note] A temporary password is generated for root@localhost: HtCqw44K),Li</span><br><span class="line">[root@ip-10-0-100-141 ~]# grep password /var/log/mysqld.log |awk &apos;&#123;print $NF&#125;&apos; </span><br><span class="line">HtCqw44K),Li</span><br><span class="line"></span><br><span class="line">使用获取到的临时密码登录MySQL</span><br><span class="line">[root@ip-10-0-100-141 ~]# mysql -uroot -p&apos;HtCqw44K),Li&apos;</span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 3</span><br><span class="line">Server version: 5.7.25</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2019, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type &apos;help;&apos; or &apos;\h&apos; for help. Type &apos;\c&apos; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">mysql&gt; 看到有这样的标识符则表示成功登录了</span><br><span class="line">注意事项:密码有特殊字符的话,必须要用&apos;&apos;,就像上面那样,否则不能登录</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">修改mysql登录密码</span><br><span class="line">mysql&gt; set global validate_password_policy=0;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; set global validate_password_length=1;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; ALTER USER &apos;root&apos;@&apos;localhost&apos; IDENTIFIED BY &apos;wenhs5479!&apos;;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; quit</span><br><span class="line">Bye</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">为避免mysql自动升级，这里需要卸载最开始安装的yum源</span><br><span class="line">[root@ip-10-0-100-141 ~]# rpm -qa|grep mysql</span><br><span class="line">mysql-community-libs-5.7.25-1.el7.x86_64</span><br><span class="line">mysql-community-libs-compat-5.7.25-1.el7.x86_64</span><br><span class="line">mysql57-community-release-el7-10.noarch</span><br><span class="line">mysql-community-client-5.7.25-1.el7.x86_64</span><br><span class="line">mysql-community-devel-5.7.25-1.el7.x86_64</span><br><span class="line">mysql-community-common-5.7.25-1.el7.x86_64</span><br><span class="line">mysql-community-server-5.7.25-1.el7.x86_64</span><br><span class="line">[root@ip-10-0-100-141 ~]# yum -y remove mysql57-community-release-el7-10.noarch</span><br><span class="line">Loaded plugins: amazon-id, rhui-lb, search-disabled-repos</span><br><span class="line">Resolving Dependencies</span><br><span class="line">--&gt; Running transaction check</span><br><span class="line">---&gt; Package mysql57-community-release.noarch 0:el7-10 will be erased</span><br><span class="line">--&gt; Finished Dependency Resolution</span><br><span class="line">......</span><br><span class="line">  Erasing    : mysql57-community-release-el7-10.noarch                             1/1 </span><br><span class="line">  Verifying  : mysql57-community-release-el7-10.noarch                             1/1 </span><br><span class="line"></span><br><span class="line">Removed:</span><br><span class="line">  mysql57-community-release.noarch 0:el7-10                                            </span><br><span class="line"></span><br><span class="line">Complete!</span><br></pre></td></tr></table></figure>

<h1 id="3-mysql的程序组成"><a href="#3-mysql的程序组成" class="headerlink" title="3. mysql的程序组成"></a>3. mysql的程序组成</h1><ul>
<li>客户端<ul>
<li><input disabled type="checkbox"> mysql：CLI交互式客户端程序</li>
<li><input disabled type="checkbox"> mysql_secure_installation：安全初始化，强烈建议安装完以后执行此命令</li>
<li><input disabled type="checkbox"> mysqldump：mysql备份工具</li>
<li><input disabled type="checkbox"> mysqladmin</li>
</ul>
</li>
<li>服务器端<ul>
<li><input disabled type="checkbox"> mysqld</li>
</ul>
</li>
</ul>
<h3 id="3-1-mysql工具使用"><a href="#3-1-mysql工具使用" class="headerlink" title="3.1 mysql工具使用"></a>3.1 mysql工具使用</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">语法：mysql [OPTIONS] [database]</span><br><span class="line">常用的OPTIONS：</span><br><span class="line">    -uUSERNAME      指定用户名，默认为root</span><br><span class="line">    -hHOST          指定服务器主机，默认为localhost，推荐使用ip地址</span><br><span class="line">    -pPASSWORD      指定用户的密码</span><br><span class="line">    -P#             指定数据库监听的端口，这里的#需用实际的端口号代替，如-P3307</span><br><span class="line">    -V              查看当前使用的mysql版本</span><br><span class="line">    -e          不登录mysql执行sql语句后退出，常用于脚本</span><br><span class="line"></span><br><span class="line">[root@ip-10-0-100-141 ~]# mysql -V</span><br><span class="line">mysql  Ver 14.14 Distrib 5.7.25, for Linux (x86_64) using  EditLine wrapper</span><br><span class="line"></span><br><span class="line">[root@ip-10-0-100-141 ~]# mysql -uroot -pwenhs5479! -h127.0.0.1</span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 5</span><br><span class="line">Server version: 5.7.25 MySQL Community Server (GPL)</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2019, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type &apos;help;&apos; or &apos;\h&apos; for help. Type &apos;\c&apos; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">mysql&gt;</span><br><span class="line"></span><br><span class="line">注意，不推荐直接在命令行里直接用-pPASSWORD的方式登录，而是使用-p选项，然后交互式输入密码</span><br><span class="line">[root@ip-10-0-100-141 ~]# mysql -uroot -p -h 127.0.0.1 -e &apos;SHOW DATABASES;&apos;</span><br><span class="line">Enter password: 	-----&gt;密码不会回显</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| sys                |</span><br><span class="line">+--------------------+</span><br></pre></td></tr></table></figure>

<h3 id="3-2-服务器监听的两种socket地址"><a href="#3-2-服务器监听的两种socket地址" class="headerlink" title="3.2 服务器监听的两种socket地址"></a>3.2 服务器监听的两种socket地址</h3><p><strong>socket类型</strong></p>
<ul>
<li><strong>ip socket</strong>    :默认监听在tcp的3306端口，支持远程通信</li>
<li><strong>unix sock</strong>    :监听在sock文件上（/tmp/mysql.sock，/var/lib/mysql/mysql.sock） 仅支持本地通信 server地址只能是：localhost，127.0.0.1</li>
</ul>
<h1 id="4-mysql数据库操作"><a href="#4-mysql数据库操作" class="headerlink" title="4.mysql数据库操作"></a>4.mysql数据库操作</h1><h3 id="4-1-DDL操作"><a href="#4-1-DDL操作" class="headerlink" title="4.1 DDL操作"></a>4.1 DDL操作</h3><h4 id="4-1-1-数据库操作"><a href="#4-1-1-数据库操作" class="headerlink" title="4.1.1 数据库操作"></a>4.1.1 数据库操作</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">创建数据库</span><br><span class="line">语法：CREATE DATABASE [IF NOT EXISTS] &apos;DB_NAME&apos;;</span><br><span class="line">创建数据库wenhs</span><br><span class="line">mysql&gt; CREATE DATABASE IF NOT EXISTS wenhs;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">查看当前有哪些数据库</span><br><span class="line">mysql&gt; SHOW DATABASES;</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| sys                |</span><br><span class="line">| wenhs              |</span><br><span class="line">+--------------------+</span><br><span class="line">5 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">删除数据库</span><br><span class="line">语法：DROP DATABASE [IF EXISTS] &apos;DB_NAME&apos;;</span><br><span class="line">删除数据库wenhs</span><br><span class="line">mysql&gt; DROP DATABASE IF EXISTS wenhs;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; SHOW DATABASES;</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| sys                |</span><br><span class="line">+--------------------+</span><br><span class="line">4 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<h4 id="4-1-2-表操作"><a href="#4-1-2-表操作" class="headerlink" title="4.1.2 表操作"></a>4.1.2 表操作</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">创建表</span><br><span class="line">语法：CREATE TABLE table_name (col1 datatype 修饰符,col2 datatype 修饰符) ENGINE=&apos;存储引擎类型&apos;;</span><br><span class="line">在数据库wenhs里创建表jbgsn</span><br><span class="line">mysql&gt; CREATE DATABASE wenhs;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; USE wenhs;		进入wenhs数据库</span><br><span class="line">Database changed</span><br><span class="line"></span><br><span class="line">mysql&gt; CREATE TABLE jbgsn (id int NOT NULL,name VARCHAR(100) NOT NULL,age tinyint);</span><br><span class="line">Query OK, 0 rows affected (0.02 sec)</span><br><span class="line"></span><br><span class="line">查看当前数据库有哪些表</span><br><span class="line">mysql&gt; SHOW TABLES;</span><br><span class="line">+-----------------+</span><br><span class="line">| Tables_in_wenhs |</span><br><span class="line">+-----------------+</span><br><span class="line">| jbgsn           |</span><br><span class="line">+-----------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">删除表</span><br><span class="line">语法：DROP TABLE [ IF EXISTS ] &apos;table_name&apos;;</span><br><span class="line">删除表jbgsn</span><br><span class="line">mysql&gt; DROP TABLE jbgsn;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; SHOW TABLES;</span><br><span class="line">Empty set (0.00 sec)</span><br></pre></td></tr></table></figure>

<h4 id="4-1-3-用户操作"><a href="#4-1-3-用户操作" class="headerlink" title="4.1.3 用户操作"></a>4.1.3 用户操作</h4><blockquote>
<p>mysql用户帐号由两部分组成，如‘USERNAME’@’HOST’，表示此USERNAME只能从此HOST上远程登录</p>
</blockquote>
<p>这里（‘USERNAME’@’HOST’）的HOST用于限制此用户可通过哪些主机远程连接mysql程序，其值可为：</p>
<ul>
<li>IP地址，如：10.0.100.141</li>
<li>通配符<ul>
<li><input disabled type="checkbox"> %：匹配任意长度的任意字符，常用于设置允许从任何主机登录</li>
<li><input disabled type="checkbox"> _：匹配任意单个字符</li>
</ul>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">数据库用户创建</span><br><span class="line">语法：CREATE USER &apos;username&apos;@&apos;host&apos; [IDENTIFIED BY &apos;password&apos;];</span><br><span class="line">创建数据库用户wenhs</span><br><span class="line">mysql&gt; CREATE USER &apos;wenhs&apos;@&apos;127.0.0.1&apos; IDENTIFIED BY &apos;wenhs5479!&apos;;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">使用新创建的用户和密码登录</span><br><span class="line">[root@ip-10-0-100-141 ~]# mysql -uwenhs -pwenhs5479! -h127.0.0.1</span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 9</span><br><span class="line">Server version: 5.7.25 MySQL Community Server (GPL)</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2019, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type &apos;help;&apos; or &apos;\h&apos; for help. Type &apos;\c&apos; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">mysql&gt;</span><br><span class="line"></span><br><span class="line">删除数据库用户</span><br><span class="line">语法：DROP USER &apos;username&apos;@&apos;host&apos;; </span><br><span class="line">mysql&gt; DROP USER &apos;wenhs&apos;@&apos;127.0.0.1&apos;;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line">注意:自己不能删自己,所以要换root账号登录数据库</span><br></pre></td></tr></table></figure>

<h4 id="4-1-4-查看命令SHOW"><a href="#4-1-4-查看命令SHOW" class="headerlink" title="4.1.4 查看命令SHOW"></a>4.1.4 查看命令SHOW</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SHOW CHARACTER SET;			查看支持的所有字符集</span><br><span class="line">+----------+---------------------------------+---------------------+--------+</span><br><span class="line">| Charset  | Description                     | Default collation   | Maxlen |</span><br><span class="line">+----------+---------------------------------+---------------------+--------+</span><br><span class="line">| big5     | Big5 Traditional Chinese        | big5_chinese_ci     |      2 |</span><br><span class="line">| dec8     | DEC West European               | dec8_swedish_ci     |      1 |</span><br><span class="line">| cp850    | DOS West European               | cp850_general_ci    |      1 |</span><br><span class="line">| hp8      | HP West European                | hp8_english_ci      |      1 |</span><br><span class="line">| koi8r    | KOI8-R Relcom Russian           | koi8r_general_ci    |      1 |</span><br><span class="line">| latin1   | cp1252 West European            | latin1_swedish_ci   |      1 |</span><br><span class="line">| latin2   | ISO 8859-2 Central European     | latin2_general_ci   |      1 |</span><br><span class="line">| swe7     | 7bit Swedish                    | swe7_swedish_ci     |      1 |</span><br><span class="line">| ascii    | US ASCII                        | ascii_general_ci    |      1 |</span><br><span class="line">| ujis     | EUC-JP Japanese                 | ujis_japanese_ci    |      3 |</span><br><span class="line">| sjis     | Shift-JIS Japanese              | sjis_japanese_ci    |      2 |</span><br><span class="line">| hebrew   | ISO 8859-8 Hebrew               | hebrew_general_ci   |      1 |</span><br><span class="line">| tis620   | TIS620 Thai                     | tis620_thai_ci      |      1 |</span><br><span class="line">| euckr    | EUC-KR Korean                   | euckr_korean_ci     |      2 |</span><br><span class="line">| koi8u    | KOI8-U Ukrainian                | koi8u_general_ci    |      1 |</span><br><span class="line">| gb2312   | GB2312 Simplified Chinese       | gb2312_chinese_ci   |      2 |</span><br><span class="line">| greek    | ISO 8859-7 Greek                | greek_general_ci    |      1 |</span><br><span class="line">| cp1250   | Windows Central European        | cp1250_general_ci   |      1 |</span><br><span class="line">| gbk      | GBK Simplified Chinese          | gbk_chinese_ci      |      2 |</span><br><span class="line">| latin5   | ISO 8859-9 Turkish              | latin5_turkish_ci   |      1 |</span><br><span class="line">| armscii8 | ARMSCII-8 Armenian              | armscii8_general_ci |      1 |</span><br><span class="line">| utf8     | UTF-8 Unicode                   | utf8_general_ci     |      3 |</span><br><span class="line">| ucs2     | UCS-2 Unicode                   | ucs2_general_ci     |      2 |</span><br><span class="line">| cp866    | DOS Russian                     | cp866_general_ci    |      1 |</span><br><span class="line">| keybcs2  | DOS Kamenicky Czech-Slovak      | keybcs2_general_ci  |      1 |</span><br><span class="line">| macce    | Mac Central European            | macce_general_ci    |      1 |</span><br><span class="line">| macroman | Mac West European               | macroman_general_ci |      1 |</span><br><span class="line">| cp852    | DOS Central European            | cp852_general_ci    |      1 |</span><br><span class="line">| latin7   | ISO 8859-13 Baltic              | latin7_general_ci   |      1 |</span><br><span class="line">| utf8mb4  | UTF-8 Unicode                   | utf8mb4_general_ci  |      4 |</span><br><span class="line">| cp1251   | Windows Cyrillic                | cp1251_general_ci   |      1 |</span><br><span class="line">| utf16    | UTF-16 Unicode                  | utf16_general_ci    |      4 |</span><br><span class="line">| utf16le  | UTF-16LE Unicode                | utf16le_general_ci  |      4 |</span><br><span class="line">| cp1256   | Windows Arabic                  | cp1256_general_ci   |      1 |</span><br><span class="line">| cp1257   | Windows Baltic                  | cp1257_general_ci   |      1 |</span><br><span class="line">| utf32    | UTF-32 Unicode                  | utf32_general_ci    |      4 |</span><br><span class="line">| binary   | Binary pseudo charset           | binary              |      1 |</span><br><span class="line">| geostd8  | GEOSTD8 Georgian                | geostd8_general_ci  |      1 |</span><br><span class="line">| cp932    | SJIS for Windows Japanese       | cp932_japanese_ci   |      2 |</span><br><span class="line">| eucjpms  | UJIS for Windows Japanese       | eucjpms_japanese_ci |      3 |</span><br><span class="line">| gb18030  | China National Standard GB18030 | gb18030_chinese_ci  |      4 |</span><br><span class="line">+----------+---------------------------------+---------------------+--------+</span><br><span class="line">41 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; SHOW ENGINES;			查看当前数据库支持的所有存储引擎</span><br><span class="line">+--------------------+---------+----------------------------------------------------------------+--------------+------+------------+</span><br><span class="line">| Engine             | Support | Comment                                                        | Transactions | XA   | Savepoints |</span><br><span class="line">+--------------------+---------+----------------------------------------------------------------+--------------+------+------------+</span><br><span class="line">| InnoDB             | DEFAULT | Supports transactions, row-level locking, and foreign keys     | YES          | YES  | YES        |</span><br><span class="line">| MRG_MYISAM         | YES     | Collection of identical MyISAM tables                          | NO           | NO   | NO         |</span><br><span class="line">| MEMORY             | YES     | Hash based, stored in memory, useful for temporary tables      | NO           | NO   | NO         |</span><br><span class="line">| BLACKHOLE          | YES     | /dev/null storage engine (anything you write to it disappears) | NO           | NO   | NO         |</span><br><span class="line">| MyISAM             | YES     | MyISAM storage engine                                          | NO           | NO   | NO         |</span><br><span class="line">| CSV                | YES     | CSV storage engine                                             | NO           | NO   | NO         |</span><br><span class="line">| ARCHIVE            | YES     | Archive storage engine                                         | NO           | NO   | NO         |</span><br><span class="line">| PERFORMANCE_SCHEMA | YES     | Performance Schema                                             | NO           | NO   | NO         |</span><br><span class="line">| FEDERATED          | NO      | Federated MySQL storage engine                                 | NULL         | NULL | NULL       |</span><br><span class="line">+--------------------+---------+----------------------------------------------------------------+--------------+------+------------+</span><br><span class="line">9 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; SHOW DATABASES;			查看数据库信息</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| sys                |</span><br><span class="line">| wenhs              |</span><br><span class="line">+--------------------+</span><br><span class="line">5 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; SHOW TABLES FROM wenhs;			不进入某数据库而列出其包含的所有表</span><br><span class="line">+-----------------+</span><br><span class="line">| Tables_in_wenhs |</span><br><span class="line">+-----------------+</span><br><span class="line">| jbgsn           |</span><br><span class="line">+-----------------+</span><br><span class="line">1 row in set (0.00 sec)		</span><br><span class="line"></span><br><span class="line">查看表结构</span><br><span class="line">语法：DESC [db_name.]table_name;</span><br><span class="line">mysql&gt; DESC wenhs.jbgsn;</span><br><span class="line">+-------+--------------+------+-----+---------+-------+</span><br><span class="line">| Field | Type         | Null | Key | Default | Extra |</span><br><span class="line">+-------+--------------+------+-----+---------+-------+</span><br><span class="line">| id    | int(11)      | NO   |     | NULL    |       |</span><br><span class="line">| name  | varchar(100) | NO   |     | NULL    |       |</span><br><span class="line">| age   | tinyint(4)   | YES  |     | NULL    |       |</span><br><span class="line">+-------+--------------+------+-----+---------+-------+</span><br><span class="line">3 rows in set (0.01 sec)</span><br><span class="line"></span><br><span class="line">查看某表的创建命令</span><br><span class="line">语法：SHOW CREATE TABLE table_name;</span><br><span class="line">mysql&gt; SHOW CREATE TABLE wenhs.jbgsn;</span><br><span class="line">+-------+--------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| Table | Create Table                                                                                                                                           |</span><br><span class="line">+-------+--------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| jbgsn | CREATE TABLE `jbgsn` (</span><br><span class="line">  `id` int(11) NOT NULL,</span><br><span class="line">  `name` varchar(100) NOT NULL,</span><br><span class="line">  `age` tinyint(4) DEFAULT NULL</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=latin1 |</span><br><span class="line">+-------+--------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">查看某表的状态</span><br><span class="line">语法：SHOW TABLE STATUS LIKE &apos;table_name&apos;\G</span><br><span class="line">mysql&gt; SHOW TABLE STATUS LIKE &apos;jbgsn&apos;\G;</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">           Name: jbgsn</span><br><span class="line">         Engine: InnoDB</span><br><span class="line">        Version: 10</span><br><span class="line">     Row_format: Dynamic</span><br><span class="line">           Rows: 0</span><br><span class="line"> Avg_row_length: 0</span><br><span class="line">    Data_length: 16384</span><br><span class="line">Max_data_length: 0</span><br><span class="line">   Index_length: 0</span><br><span class="line">      Data_free: 0</span><br><span class="line"> Auto_increment: NULL</span><br><span class="line">    Create_time: 2019-04-22 10:54:02</span><br><span class="line">    Update_time: NULL</span><br><span class="line">     Check_time: NULL</span><br><span class="line">      Collation: latin1_swedish_ci</span><br><span class="line">       Checksum: NULL</span><br><span class="line"> Create_options: </span><br><span class="line">        Comment: </span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<h4 id="4-1-5-获取帮助"><a href="#4-1-5-获取帮助" class="headerlink" title="4.1.5 获取帮助"></a>4.1.5 获取帮助</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">获取命令使用帮助</span><br><span class="line">语法：HELP keyword;</span><br><span class="line"></span><br><span class="line">mysql&gt; HELP CREATE TABLE;			获取创建表的帮助</span><br><span class="line">Name: &apos;CREATE TABLE&apos;</span><br><span class="line">Description:</span><br><span class="line">Syntax:</span><br><span class="line">CREATE [TEMPORARY] TABLE [IF NOT EXISTS] tbl_name</span><br><span class="line">    (create_definition,...)</span><br><span class="line">    [table_options]</span><br><span class="line">    [partition_options]</span><br><span class="line"></span><br><span class="line">CREATE [TEMPORARY] TABLE [IF NOT EXISTS] tbl_name</span><br><span class="line">    [(create_definition,...)]</span><br><span class="line">    [table_options]</span><br><span class="line">    [partition_options]</span><br><span class="line">    [IGNORE | REPLACE]</span><br><span class="line">    [AS] query_expression</span><br><span class="line"></span><br><span class="line">CREATE [TEMPORARY] TABLE [IF NOT EXISTS] tbl_name</span><br><span class="line">    &#123; LIKE old_tbl_name | (LIKE old_tbl_name) &#125;</span><br><span class="line">.......</span><br></pre></td></tr></table></figure>

<h3 id="4-2-DML操作"><a href="#4-2-DML操作" class="headerlink" title="4.2 DML操作"></a>4.2 DML操作</h3><p><strong>DML操作包括增(INSERT)、删(DELETE)、改(UPDATE)、查(SELECT)，均属针对表的操作。</strong></p>
<h4 id="4-2-1-INSERT语句"><a href="#4-2-1-INSERT语句" class="headerlink" title="4.2.1 INSERT语句"></a>4.2.1 INSERT语句</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">DML操作之增操作insert</span><br><span class="line">修改字段类型:alter table tb_name modify column 字段名 data_type;</span><br><span class="line">语法：INSERT [INTO] table_name [(column_name,...)] &#123;VALUES | VALUE&#125; (value1,...),(...),...;</span><br><span class="line">	INSERT INTO tb_name VALUE(value1,value2,...);	完整插入一条记录</span><br><span class="line">	INSERT INTO tb_name VALUES(value1,value2,...),(value1,value2,...),...;		完整插入多条记录</span><br><span class="line">	INSERT INTO tb_name(key1,key2,...) VALUE(value1,value2,...);		给指定字段插入一条记录</span><br><span class="line">	INSERT INTO tb_name(key1,key2,...) VALUES(value1,value2,...),(value1,value2,...),...;		给指定字段插入多条记录</span><br><span class="line">mysql&gt; USE wenhs;</span><br><span class="line">Database changed</span><br><span class="line">mysql&gt; INSERT INTO jbgsn (id,name,age) VALUE (1,&apos;tom&apos;,20);		一次插入一条记录</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line">mysql&gt; INSERT INTO jbgsn (id,name,age) VALUES (2,&apos;nbhr&apos;,23),(3,&apos;whs&apos;,25),(4,&apos;wen&apos;,28),(55,&apos;ym&apos;,26),(6,&apos;wuym&apos;,20),(7,&apos;expl&apos;,NULL);</span><br><span class="line">Query OK, 6 rows affected (0.00 sec)</span><br><span class="line">Records: 6  Duplicates: 0  Warnings: 0			一次插入多条记录</span><br><span class="line">mysql&gt; INSERT INTO jbgsn(name,id) VALUES(&apos;bhg&apos;,93),(&apos;mnb&apos;,67),(&apos;jkl&apos;,85),(&apos;fg&apos;,75),(&apos;dbffd&apos;,27),(&apos;fsdf&apos;,43);</span><br><span class="line">Query OK, 6 rows affected (0.01 sec)</span><br><span class="line">Records: 6  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from jbgsn;</span><br><span class="line">+----+------+------+</span><br><span class="line">| id | name | age  |</span><br><span class="line">+----+------+------+</span><br><span class="line">|  1 | tom  |   20 |</span><br><span class="line">|  2 | nbhr |   23 |</span><br><span class="line">|  3 | whs  |   25 |</span><br><span class="line">|  4 | wen  |   28 |</span><br><span class="line">|  5 | ym   |   26 |</span><br><span class="line">|  6 | wuym |   20 |</span><br><span class="line">|  7 | expl | NULL |</span><br><span class="line">| 93 | bhg  | NULL |</span><br><span class="line">| 67 | mnb  | NULL |</span><br><span class="line">| 85 | jkl  | NULL |</span><br><span class="line">| 75 | fg   | NULL |</span><br><span class="line">| 27 | dbfd | NULL |</span><br><span class="line">| 43 | fsdf | NULL |</span><br><span class="line">+----+------+------+</span><br><span class="line">13 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<h4 id="4-2-2-SELECT语句"><a href="#4-2-2-SELECT语句" class="headerlink" title="4.2.2 SELECT语句"></a>4.2.2 SELECT语句</h4><p><strong>字段column表示法</strong></p>
<table>
<thead>
<tr>
<th>表示符</th>
<th>代表什么？</th>
</tr>
</thead>
<tbody><tr>
<td>*</td>
<td>所有字段</td>
</tr>
<tr>
<td>as</td>
<td>字段别名，如col1 AS alias1<br>当表名很长时用别名代替</td>
</tr>
</tbody></table>
<p><strong>条件判断语句WHERE</strong></p>
<table>
<thead>
<tr>
<th>操作类型</th>
<th>常用操作符</th>
</tr>
</thead>
<tbody><tr>
<td>操作符</td>
<td>&gt;，&lt;，&gt;=，&lt;=，=，!=<br>BETWEEN column# AND column#<br>LIKE：模糊匹配<br>RLIKE：基于正则表达式进行模式匹配<br>ISNOT NULL：非空<br>IS NULL：空</td>
</tr>
<tr>
<td>条件逻辑操作</td>
<td>AND<br>OR<br>NOT</td>
</tr>
</tbody></table>
<p><strong>ORDER BY：排序，默认为升序（ASC）</strong></p>
<table>
<thead>
<tr>
<th>ORDER BY语句</th>
<th>意义</th>
</tr>
</thead>
<tbody><tr>
<td>ORDER BY ‘column_name’</td>
<td>根据column_name进行升序排序</td>
</tr>
<tr>
<td>ORDER BY ‘column_name’ DESC</td>
<td>根据column_name进行降序排序</td>
</tr>
<tr>
<td>ORDER BY ’column_name’ LIMIT 2</td>
<td>根据column_name进行升序排序<br>并只取前2个结果</td>
</tr>
<tr>
<td>ORDER BY ‘column_name’ LIMIT 1,2</td>
<td>根据column_name进行升序排序<br>并且略过第1个结果取后面的2个结果</td>
</tr>
</tbody></table>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br></pre></td><td class="code"><pre><span class="line">DML操作之查操作select</span><br><span class="line">语法：SELECT column1,column2,... FROM table_name [WHERE clause] [ORDER BY &apos;column_name&apos; [DESC]] [LIMIT [m,]n];</span><br><span class="line"></span><br><span class="line">mysql&gt; SELECT * FROM jbgsn;		原表情况,下列查询语句均为此表操作</span><br><span class="line">+----+------+------+</span><br><span class="line">| id | name | age  |</span><br><span class="line">+----+------+------+</span><br><span class="line">|  1 | tom  |   20 |</span><br><span class="line">|  2 | nbhr |   23 |</span><br><span class="line">|  3 | whs  |   25 |</span><br><span class="line">|  4 | wen  |   28 |</span><br><span class="line">|  5 | ym   |   26 |</span><br><span class="line">|  6 | wuym |   20 |</span><br><span class="line">|  7 | expl | NULL |</span><br><span class="line">| 93 | bhg  | NULL |</span><br><span class="line">| 67 | mnb  | NULL |</span><br><span class="line">| 85 | jkl  | NULL |</span><br><span class="line">| 75 | fg   | NULL |</span><br><span class="line">| 27 | dbfd | NULL |</span><br><span class="line">| 43 | fsdf | NULL |</span><br><span class="line">+----+------+------+</span><br><span class="line">13 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; SELECT name,age FROM jbgsn WHERE age BETWEEN 21 AND 27;</span><br><span class="line">+------+------+</span><br><span class="line">| name | age  |</span><br><span class="line">+------+------+</span><br><span class="line">| nbhr |   23 |</span><br><span class="line">| whs  |   25 |</span><br><span class="line">| ym   |   26 |</span><br><span class="line">+------+------+</span><br><span class="line">3 rows in set (0.01 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; SELECT * FROM jbgsn WHERE name LIKE &apos;y&apos;;</span><br><span class="line">Empty set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; SELECT * FROM jbgsn WHERE name LIKE &apos;y%&apos;;</span><br><span class="line">+----+------+------+</span><br><span class="line">| id | name | age  |</span><br><span class="line">+----+------+------+</span><br><span class="line">|  5 | ym   |   26 |</span><br><span class="line">+----+------+------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; SELECT * FROM jbgsn WHERE name LIKE &apos;w%&apos;;</span><br><span class="line">+----+------+------+</span><br><span class="line">| id | name | age  |</span><br><span class="line">+----+------+------+</span><br><span class="line">|  3 | whs  |   25 |</span><br><span class="line">|  4 | wen  |   28 |</span><br><span class="line">|  6 | wuym |   20 |</span><br><span class="line">+----+------+------+</span><br><span class="line">3 rows in set (0.01 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; SELECT * FROM jbgsn WHERE name LIKE &apos;w*&apos;;</span><br><span class="line">Empty set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; SELECT * FROM jbgsn WHERE name RLIKE &apos;w*&apos;;</span><br><span class="line">+----+------+------+</span><br><span class="line">| id | name | age  |</span><br><span class="line">+----+------+------+</span><br><span class="line">|  1 | tom  |   20 |</span><br><span class="line">|  2 | nbhr |   23 |</span><br><span class="line">|  3 | whs  |   25 |</span><br><span class="line">|  4 | wen  |   28 |</span><br><span class="line">|  5 | ym   |   26 |</span><br><span class="line">|  6 | wuym |   20 |</span><br><span class="line">|  7 | expl | NULL |</span><br><span class="line">| 93 | bhg  | NULL |</span><br><span class="line">| 67 | mnb  | NULL |</span><br><span class="line">| 85 | jkl  | NULL |</span><br><span class="line">| 75 | fg   | NULL |</span><br><span class="line">| 27 | dbfd | NULL |</span><br><span class="line">| 43 | fsdf | NULL |</span><br><span class="line">+----+------+------+</span><br><span class="line">13 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; SELECT * FROM jbgsn WHERE name RLIKE &apos;w%&apos;;</span><br><span class="line">Empty set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; SELECT * FROM jbgsn WHERE age IS null;</span><br><span class="line">+----+------+------+</span><br><span class="line">| id | name | age  |</span><br><span class="line">+----+------+------+</span><br><span class="line">|  7 | expl | NULL |</span><br><span class="line">| 93 | bhg  | NULL |</span><br><span class="line">| 67 | mnb  | NULL |</span><br><span class="line">| 85 | jkl  | NULL |</span><br><span class="line">| 75 | fg   | NULL |</span><br><span class="line">| 27 | dbfd | NULL |</span><br><span class="line">| 43 | fsdf | NULL |</span><br><span class="line">+----+------+------+</span><br><span class="line">7 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; SELECT * FROM jbgsn WHERE age IS NOT null;</span><br><span class="line">+----+------+------+</span><br><span class="line">| id | name | age  |</span><br><span class="line">+----+------+------+</span><br><span class="line">|  1 | tom  |   20 |</span><br><span class="line">|  2 | nbhr |   23 |</span><br><span class="line">|  3 | whs  |   25 |</span><br><span class="line">|  4 | wen  |   28 |</span><br><span class="line">|  5 | ym   |   26 |</span><br><span class="line">|  6 | wuym |   20 |</span><br><span class="line">+----+------+------+</span><br><span class="line">6 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; SELECT * FROM jbgsn ORDER BY id;		按id字段升序排序</span><br><span class="line">+----+------+------+</span><br><span class="line">| id | name | age  |</span><br><span class="line">+----+------+------+</span><br><span class="line">|  1 | tom  |   20 |</span><br><span class="line">|  2 | nbhr |   23 |</span><br><span class="line">|  3 | whs  |   25 |</span><br><span class="line">|  4 | wen  |   28 |</span><br><span class="line">|  5 | ym   |   26 |</span><br><span class="line">|  6 | wuym |   20 |</span><br><span class="line">|  7 | expl | NULL |</span><br><span class="line">| 27 | dbfd | NULL |</span><br><span class="line">| 43 | fsdf | NULL |</span><br><span class="line">| 67 | mnb  | NULL |</span><br><span class="line">| 75 | fg   | NULL |</span><br><span class="line">| 85 | jkl  | NULL |</span><br><span class="line">| 93 | bhg  | NULL |</span><br><span class="line">+----+------+------+</span><br><span class="line">13 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; SELECT * FROM jbgsn ORDER BY id DESC;		按id字段降序排序</span><br><span class="line">+----+------+------+</span><br><span class="line">| id | name | age  |</span><br><span class="line">+----+------+------+</span><br><span class="line">| 93 | bhg  | NULL |</span><br><span class="line">| 85 | jkl  | NULL |</span><br><span class="line">| 75 | fg   | NULL |</span><br><span class="line">| 67 | mnb  | NULL |</span><br><span class="line">| 43 | fsdf | NULL |</span><br><span class="line">| 27 | dbfd | NULL |</span><br><span class="line">|  7 | expl | NULL |</span><br><span class="line">|  6 | wuym |   20 |</span><br><span class="line">|  5 | ym   |   26 |</span><br><span class="line">|  4 | wen  |   28 |</span><br><span class="line">|  3 | whs  |   25 |</span><br><span class="line">|  2 | nbhr |   23 |</span><br><span class="line">|  1 | tom  |   20 |</span><br><span class="line">+----+------+------+</span><br><span class="line">13 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; SELECT * FROM jbgsn WHERE age IS NOT NULL ORDER BY id DESC;		取出age非空的字段并对id进行降序排序</span><br><span class="line">+----+------+------+</span><br><span class="line">| id | name | age  |</span><br><span class="line">+----+------+------+</span><br><span class="line">|  6 | wuym |   20 |</span><br><span class="line">|  5 | ym   |   26 |</span><br><span class="line">|  4 | wen  |   28 |</span><br><span class="line">|  3 | whs  |   25 |</span><br><span class="line">|  2 | nbhr |   23 |</span><br><span class="line">|  1 | tom  |   20 |</span><br><span class="line">+----+------+------+</span><br><span class="line">6 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; SELECT * FROM jbgsn WHERE age IS NOT NULL ORDER BY age DESC LIMIT 1,3;</span><br><span class="line">+----+------+------+		取出age字段非空的记录并对其进行降序排序,然后跳过第一条记录,取3条记录</span><br><span class="line">| id | name | age  |		order by 必须放在where语句后面</span><br><span class="line">+----+------+------+</span><br><span class="line">|  5 | ym   |   26 |</span><br><span class="line">|  3 | whs  |   25 |</span><br><span class="line">|  2 | nbhr |   23 |</span><br><span class="line">+----+------+------+</span><br><span class="line">3 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<h4 id="4-2-3-update语句"><a href="#4-2-3-update语句" class="headerlink" title="4.2.3 update语句"></a>4.2.3 update语句</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">DML操作之改操作update</span><br><span class="line">语法：UPDATE table_name SET column1 = new_value1[,column2 = new_value2,...] [WHERE clause] [ORDER BY &apos;column_name&apos; [DESC]] [LIMIT [m,]n];</span><br><span class="line">mysql&gt; select * from jbgsn;</span><br><span class="line">+----+------+------+</span><br><span class="line">| id | name | age  |</span><br><span class="line">+----+------+------+</span><br><span class="line">|  1 | tom  |   20 |</span><br><span class="line">|  2 | nbhr |   23 |</span><br><span class="line">|  3 | whs  |   25 |</span><br><span class="line">|  4 | wen  |   28 |</span><br><span class="line">|  5 | ym   |   26 |</span><br><span class="line">|  6 | wuym |   20 |</span><br><span class="line">|  7 | expl | NULL |</span><br><span class="line">| 93 | bhg  | NULL |</span><br><span class="line">| 67 | mnb  | NULL |</span><br><span class="line">| 85 | jkl  | NULL |</span><br><span class="line">| 75 | fg   | NULL |</span><br><span class="line">| 27 | dbfd | NULL |</span><br><span class="line">| 43 | fsdf | NULL |</span><br><span class="line">+----+------+------+</span><br><span class="line">13 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; UPDATE jbgsn SET age = 88 WHERE name = &apos;tom&apos;;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line">Rows matched: 1  Changed: 1  Warnings: 0</span><br><span class="line"></span><br><span class="line">mysql&gt; UPDATE jbgsn SET age = 66,id = 66  WHERE name = &apos;whs&apos;;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)		更新一条记录里面的多个字段</span><br><span class="line">Rows matched: 1  Changed: 1  Warnings: 0</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from jbgsn;</span><br><span class="line">+----+------+------+</span><br><span class="line">| id | name | age  |</span><br><span class="line">+----+------+------+</span><br><span class="line">|  1 | tom  |   88 |</span><br><span class="line">|  2 | nbhr |   23 |</span><br><span class="line">| 66 | whs  |   66 |</span><br><span class="line">|  4 | wen  |   28 |</span><br><span class="line">|  5 | ym   |   26 |</span><br><span class="line">|  6 | wuym |   20 |</span><br><span class="line">|  7 | expl | NULL |</span><br><span class="line">| 93 | bhg  | NULL |</span><br><span class="line">| 67 | mnb  | NULL |</span><br><span class="line">| 85 | jkl  | NULL |</span><br><span class="line">| 75 | fg   | NULL |</span><br><span class="line">| 27 | dbfd | NULL |</span><br><span class="line">| 43 | fsdf | NULL |</span><br><span class="line">+----+------+------+</span><br><span class="line">13 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<h4 id="4-2-4-delete语句"><a href="#4-2-4-delete语句" class="headerlink" title="4.2.4 delete语句"></a>4.2.4 delete语句</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">DML操作之删操作delete</span><br><span class="line">语法：DELETE FROM table_name [WHERE clause] [ORDER BY &apos;column_name&apos; [DESC]] [LIMIT [m,]n];</span><br><span class="line">mysql&gt; DELETE FROM jbgsn WHERE id = 1;		删除某条记录</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from jbgsn;</span><br><span class="line">+----+------+------+</span><br><span class="line">| id | name | age  |</span><br><span class="line">+----+------+------+</span><br><span class="line">|  2 | nbhr |   23 |</span><br><span class="line">| 66 | whs  |   66 |</span><br><span class="line">|  4 | wen  |   28 |</span><br><span class="line">|  5 | ym   |   26 |</span><br><span class="line">|  6 | wuym |   20 |</span><br><span class="line">|  7 | expl | NULL |</span><br><span class="line">| 93 | bhg  | NULL |</span><br><span class="line">| 67 | mnb  | NULL |</span><br><span class="line">| 85 | jkl  | NULL |</span><br><span class="line">| 75 | fg   | NULL |</span><br><span class="line">| 27 | dbfd | NULL |</span><br><span class="line">| 43 | fsdf | NULL |</span><br><span class="line">+----+------+------+</span><br><span class="line">12 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; DELETE FROM jbgsn;		删除整张表的内容</span><br><span class="line">Query OK, 12 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from jbgsn;</span><br><span class="line">Empty set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; SHOW TABLES;</span><br><span class="line">+-----------------+</span><br><span class="line">| Tables_in_wenhs |</span><br><span class="line">+-----------------+</span><br><span class="line">| jbgsn           |</span><br><span class="line">+-----------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; DESC jbgsn;</span><br><span class="line">+-------+--------------+------+-----+---------+-------+</span><br><span class="line">| Field | Type         | Null | Key | Default | Extra |</span><br><span class="line">+-------+--------------+------+-----+---------+-------+</span><br><span class="line">| id    | int(11)      | NO   |     | NULL    |       |</span><br><span class="line">| name  | varchar(100) | NO   |     | NULL    |       |</span><br><span class="line">| age   | tinyint(4)   | YES  |     | NULL    |       |</span><br><span class="line">+-------+--------------+------+-----+---------+-------+</span><br><span class="line">3 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<h4 id="4-2-5-truncate语句"><a href="#4-2-5-truncate语句" class="headerlink" title="4.2.5 truncate语句"></a>4.2.5 truncate语句</h4><p><strong>truncate与delete的区别：</strong></p>
<table>
<thead>
<tr>
<th>语句类型</th>
<th>特点</th>
</tr>
</thead>
<tbody><tr>
<td>delete</td>
<td>DELETE删除表内容时仅删除内容，但会保留表结构<br>DELETE语句每次删除一行，并在事务日志中为所删除的每行记录一项<br>可以过回滚事务日志恢复数据<br>非常占用空间</td>
</tr>
<tr>
<td>truncate</td>
<td>删除表中所有数据，且无法恢复<br>表结构、约束和索引等保持不变，新添加的行计数值重置为初始值<br>执行速度比DELETE快，且使用的系统和事务日志资源少<br>通过释放存储表数据所用的数据页来删除数据，并且只在事务日志中记录页的释放<br>对于有外键约束引用的表，不能使用TRUNCATE TABLE删除数据<br>不能用于加入了索引视图的表</td>
</tr>
</tbody></table>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">语法：TRUNCATE table_name;</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from jbgsn;</span><br><span class="line">+----+-----------+------+</span><br><span class="line">| id | name      | age  |</span><br><span class="line">+----+-----------+------+</span><br><span class="line">|  1 | tom       |   20 |</span><br><span class="line">|  2 | jerry     |   23 |</span><br><span class="line">|  3 | whs       |   25 |</span><br><span class="line">|  4 | shen      |   28 |</span><br><span class="line">|  5 | zsdfcddan |   26 |</span><br><span class="line">|  6 | adwffdsan |   20 |</span><br><span class="line">|  7 | scfs      | NULL |</span><br><span class="line">+----+-----------+------+</span><br><span class="line">7 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; truncate table jbgsn;		这个table可加可不加</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from jbgsn;</span><br><span class="line">Empty set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; DESC jbgsn;                                                                  </span><br><span class="line">+-------+--------------+------+-----+---------+-------+</span><br><span class="line">| Field | Type         | Null | Key | Default | Extra |</span><br><span class="line">+-------+--------------+------+-----+---------+-------+</span><br><span class="line">| id    | int(11)      | NO   |     | NULL    |       |</span><br><span class="line">| name  | varchar(100) | NO   |     | NULL    |       |</span><br><span class="line">| age   | tinyint(4)   | YES  |     | NULL    |       |</span><br><span class="line">+-------+--------------+------+-----+---------+-------+</span><br><span class="line">3 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<h3 id="4-3-DCL操作"><a href="#4-3-DCL操作" class="headerlink" title="4.3 DCL操作"></a>4.3 DCL操作</h3><h4 id="4-3-1-创建授权grant"><a href="#4-3-1-创建授权grant" class="headerlink" title="4.3.1 创建授权grant"></a>4.3.1 创建授权grant</h4><p><strong>权限类型(priv_type)</strong></p>
<table>
<thead>
<tr>
<th>权限类型</th>
<th>代表什么？</th>
</tr>
</thead>
<tbody><tr>
<td>ALL</td>
<td>所有权限</td>
</tr>
<tr>
<td>SELECT</td>
<td>读取内容的权限</td>
</tr>
<tr>
<td>INSERT</td>
<td>插入内容的权限</td>
</tr>
<tr>
<td>UPDATE</td>
<td>更新内容的权限</td>
</tr>
<tr>
<td>DELETE</td>
<td>删除内容的权限</td>
</tr>
</tbody></table>
<p><strong>指定要操作的对象db_name.table_name</strong></p>
<table>
<thead>
<tr>
<th>表示方式</th>
<th>意义</th>
</tr>
</thead>
<tbody><tr>
<td>*.*</td>
<td>所有库的所有表</td>
</tr>
<tr>
<td>db_name</td>
<td>指定库的所有表</td>
</tr>
<tr>
<td>db_name.table_name</td>
<td>指定库的指定表</td>
</tr>
</tbody></table>
<blockquote>
<p>WITH GRANT OPTION：被授权的用户可将自己的权限副本转赠给其他用户，说白点就是将自己的权限完全复制给另一个用户。不建议使用。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">语法:GRANT priv_type,... ON [object_type] db_name.table_name TO ‘username&apos;@&apos;host&apos; [IDENTIFIED BY &apos;password&apos;] [WITH GRANT OPTION];</span><br><span class="line">mysql&gt; SHOW DATABASES;</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| sys                |</span><br><span class="line">| wenhs              |</span><br><span class="line">+--------------------+</span><br><span class="line">5 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">授权wenhs用户在数据库本机上登录访问所有数据库</span><br><span class="line">mysql&gt; GRANT ALL ON *.* TO &apos;wenhs&apos;@&apos;localhost&apos; IDENTIFIED BY &apos;WSFwdaSDFF3232?:&quot;&lt;&gt;&apos;;</span><br><span class="line">Query OK, 0 rows affected, 1 warning (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; GRANT ALL ON *.* TO &apos;wenhs&apos;@&apos;127.0.0.1&apos; IDENTIFIED BY &apos;WSFwdaSDFF3232?:&quot;&lt;&gt;&apos;;</span><br><span class="line">Query OK, 0 rows affected, 1 warning (0.00 sec)</span><br><span class="line"></span><br><span class="line">授权wenhs用户在10.0.100.111上远程登录访问wenhs数据库</span><br><span class="line">mysql&gt; GRANT ALL ON wenhs.* TO &apos;wenhs&apos;@&apos;10.0.100.111&apos; IDENTIFIED BY &apos;WSFwdaSDFF3232?:&quot;&lt;&gt;&apos;; </span><br><span class="line">Query OK, 0 rows affected, 1 warning (0.00 sec)</span><br><span class="line"></span><br><span class="line">授权wenhs用户在所有位置上远程登录访问wenhs数据库</span><br><span class="line">mysql&gt; GRANT ALL ON *.* TO &apos;wenhs&apos;@&apos;%&apos; IDENTIFIED BY &apos;WSFwdaSDFF3232?:&quot;&lt;&gt;&apos;;</span><br><span class="line">Query OK, 0 rows affected, 1 warning (0.00 sec)</span><br></pre></td></tr></table></figure>

<h4 id="4-3-2-查看授权"><a href="#4-3-2-查看授权" class="headerlink" title="4.3.2 查看授权"></a>4.3.2 查看授权</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">查看当前登录用户的授权信息</span><br><span class="line">mysql&gt; SHOW GRANTS;</span><br><span class="line">+---------------------------------------------------------------------+</span><br><span class="line">| Grants for root@localhost                                           |</span><br><span class="line">+---------------------------------------------------------------------+</span><br><span class="line">| GRANT ALL PRIVILEGES ON *.* TO &apos;root&apos;@&apos;localhost&apos; WITH GRANT OPTION |</span><br><span class="line">| GRANT PROXY ON &apos;&apos;@&apos;&apos; TO &apos;root&apos;@&apos;localhost&apos; WITH GRANT OPTION        |</span><br><span class="line">+---------------------------------------------------------------------+</span><br><span class="line">2 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">查看指定用户wenhs的授权信息</span><br><span class="line">mysql&gt; SHOW GRANTS FOR wenhs;</span><br><span class="line">+--------------------------------------------+</span><br><span class="line">| Grants for wenhs@%                         |</span><br><span class="line">+--------------------------------------------+</span><br><span class="line">| GRANT ALL PRIVILEGES ON *.* TO &apos;wenhs&apos;@&apos;%&apos; |</span><br><span class="line">+--------------------------------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line">mysql&gt; SHOW GRANTS FOR &apos;wenhs&apos;@&apos;127.0.0.1&apos;;</span><br><span class="line">+----------------------------------------------------+</span><br><span class="line">| Grants for wenhs@127.0.0.1                         |</span><br><span class="line">+----------------------------------------------------+</span><br><span class="line">| GRANT ALL PRIVILEGES ON *.* TO &apos;wenhs&apos;@&apos;127.0.0.1&apos; |</span><br><span class="line">+----------------------------------------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; SHOW GRANTS FOR &apos;wenhs&apos;@&apos;localhost&apos;;</span><br><span class="line">+----------------------------------------------------+</span><br><span class="line">| Grants for wenhs@localhost                         |</span><br><span class="line">+----------------------------------------------------+</span><br><span class="line">| GRANT ALL PRIVILEGES ON *.* TO &apos;wenhs&apos;@&apos;localhost&apos; |</span><br><span class="line">+----------------------------------------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<h4 id="4-3-3-取消授权REVOKE"><a href="#4-3-3-取消授权REVOKE" class="headerlink" title="4.3.3 取消授权REVOKE"></a>4.3.3 取消授权REVOKE</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">语法：REVOKE priv_type,... ON db_name.table_name FROM &apos;username&apos;@&apos;host&apos;;</span><br><span class="line">mysql&gt; REVOKE ALL ON *.* FROM &apos;wenhs&apos;@&apos;10.0.100.111&apos;;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; FLUSH PRIVILEGES;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure>

<p><strong>注意：mysql服务进程启动时会读取mysql库中的所有授权表至内存中：</strong></p>
<ul>
<li>GRANT或REVOKE等执行权限操作会保存于表中，mysql的服务进程会自动重读授权表，并更新至内存中</li>
<li>对于不能够或不能及时重读授权表的命令，可手动让mysql的服务进程重读授权表</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; FLUSH PRIVILEGES;</span><br></pre></td></tr></table></figure>

<h2 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h2><h5 id="1-创建一个以你名字为名的数据库，并创建一张表student，该表包含三个字段（id，name，age），表结构如下："><a href="#1-创建一个以你名字为名的数据库，并创建一张表student，该表包含三个字段（id，name，age），表结构如下：" class="headerlink" title="1.创建一个以你名字为名的数据库，并创建一张表student，该表包含三个字段（id，name，age），表结构如下："></a>1.创建一个以你名字为名的数据库，并创建一张表student，该表包含三个字段（id，name，age），表结构如下：</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; CREATE DATABASE IF NOT EXISTS wenhongsheng;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; USE wenhongsheng;</span><br><span class="line">Database changed</span><br><span class="line">mysql&gt; CREATE TABLE student (id int primary key auto_increment NOT NULL,name VARCHAR(100) NOT NULL,age tinyint);</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; DESC student;</span><br><span class="line">+-------+--------------+------+-----+---------+-------+</span><br><span class="line">| Field | Type         | Null | Key | Default | Extra |</span><br><span class="line">+-------+--------------+------+-----+---------+-------+</span><br><span class="line">| id    | int(11)      | NO   |     | NULL    |       |</span><br><span class="line">| name  | varchar(100) | NO   |     | NULL    |       |</span><br><span class="line">| age   | tinyint(4)   | YES  |     | NULL    |       |</span><br><span class="line">+-------+--------------+------+-----+---------+-------+</span><br><span class="line">3 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<h5 id="2-查看下该新建的表有无内容（用select语句）"><a href="#2-查看下该新建的表有无内容（用select语句）" class="headerlink" title="2.查看下该新建的表有无内容（用select语句）"></a>2.查看下该新建的表有无内容（用select语句）</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT * FROM student;</span><br><span class="line">Empty set (0.00 sec)</span><br></pre></td></tr></table></figure>

<h5 id="3-往新建的student表中插入数据（用insert语句），结果应如下所示："><a href="#3-往新建的student表中插入数据（用insert语句），结果应如下所示：" class="headerlink" title="3.往新建的student表中插入数据（用insert语句），结果应如下所示："></a>3.往新建的student表中插入数据（用insert语句），结果应如下所示：</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; insert into student values(1,&apos;tom&apos;,20),(2,&apos;jerry&apos;,23),(3,&apos;wangqing&apos;,25),(4,&apos;sean&apos;,28),</span><br><span class="line">    -&gt; (5,&apos;zhangshan&apos;,26),(6,&apos;zhangshan&apos;,20),(7,&apos;lisi&apos;,null),(8,&apos;chenshuo&apos;,10),(9,&apos;wangwu&apos;,3),</span><br><span class="line">    -&gt; (10,&apos;qiuyi&apos;,15),(11,&apos;qiuxiaotian&apos;,20);</span><br><span class="line">Query OK, 11 rows affected (0.00 sec)</span><br><span class="line">Records: 11  Duplicates: 0  Warnings: 0</span><br><span class="line">mysql&gt; select * from student;     #查询表内容</span><br><span class="line">+----+-------------+------+</span><br><span class="line">| id | name        | age  |</span><br><span class="line">+----+-------------+------+</span><br><span class="line">|  1 | tom         |   20 |</span><br><span class="line">|  2 | jerry       |   23 |</span><br><span class="line">|  3 | wangqing    |   25 |</span><br><span class="line">|  4 | sean        |   28 |</span><br><span class="line">|  5 | zhangshan   |   26 |</span><br><span class="line">|  6 | zhangshan   |   20 |</span><br><span class="line">|  7 | lisi        | NULL |</span><br><span class="line">|  8 | chenshuo    |   10 |</span><br><span class="line">|  9 | wangwu      |    3 |</span><br><span class="line">| 10 | qiuyi       |   15 |</span><br><span class="line">| 11 | qiuxiaotian |   20 |</span><br><span class="line">+----+-------------+------+</span><br><span class="line">11 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<h5 id="4-修改lisi的年龄为50"><a href="#4-修改lisi的年龄为50" class="headerlink" title="4.修改lisi的年龄为50"></a>4.修改lisi的年龄为50</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; UPDATE student SET age = 50 WHERE name = &apos;lisi&apos;;                                        </span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line">Rows matched: 1  Changed: 1  Warnings: 0</span><br><span class="line"></span><br><span class="line">mysql&gt; SELECT * FROM student;</span><br><span class="line">+----+-------------+------+</span><br><span class="line">| id | name        | age  |</span><br><span class="line">+----+-------------+------+</span><br><span class="line">|  1 | tom         |   20 |</span><br><span class="line">|  2 | jerry       |   23 |</span><br><span class="line">|  3 | wangqing    |   25 |</span><br><span class="line">|  4 | sean        |   28 |</span><br><span class="line">|  5 | zhangshan   |   26 |</span><br><span class="line">|  6 | zhangshan   |   20 |</span><br><span class="line">|  7 | lisi        |   50 |</span><br><span class="line">|  8 | chenshuo    |   10 |</span><br><span class="line">|  9 | wangwu      |    3 |</span><br><span class="line">| 10 | qiuyi       |   15 |</span><br><span class="line">| 11 | qiuxiaotian |   20 |</span><br><span class="line">+----+-------------+------+</span><br><span class="line">11 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<h5 id="5-以age字段降序排序"><a href="#5-以age字段降序排序" class="headerlink" title="5.以age字段降序排序"></a>5.以age字段降序排序</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT * FROM student ORDER BY age DESC;</span><br><span class="line">+----+-------------+------+</span><br><span class="line">| id | name        | age  |</span><br><span class="line">+----+-------------+------+</span><br><span class="line">|  7 | lisi        |   50 |</span><br><span class="line">|  4 | sean        |   28 |</span><br><span class="line">|  5 | zhangshan   |   26 |</span><br><span class="line">|  3 | wangqing    |   25 |</span><br><span class="line">|  2 | jerry       |   23 |</span><br><span class="line">|  1 | tom         |   20 |</span><br><span class="line">|  6 | zhangshan   |   20 |</span><br><span class="line">| 11 | qiuxiaotian |   20 |</span><br><span class="line">| 10 | qiuyi       |   15 |</span><br><span class="line">|  8 | chenshuo    |   10 |</span><br><span class="line">|  9 | wangwu      |    3 |</span><br><span class="line">+----+-------------+------+</span><br><span class="line">11 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<h5 id="6-查询student表中年龄最小的3位同学"><a href="#6-查询student表中年龄最小的3位同学" class="headerlink" title="6.查询student表中年龄最小的3位同学"></a>6.查询student表中年龄最小的3位同学</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT * FROM student ORDER BY age LIMIT 3;</span><br><span class="line">+----+----------+------+</span><br><span class="line">| id | name     | age  |</span><br><span class="line">+----+----------+------+</span><br><span class="line">|  9 | wangwu   |    3 |</span><br><span class="line">|  8 | chenshuo |   10 |</span><br><span class="line">| 10 | qiuyi    |   15 |</span><br><span class="line">+----+----------+------+</span><br><span class="line">3 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<h5 id="7-查询student表中年龄最大的4位同学"><a href="#7-查询student表中年龄最大的4位同学" class="headerlink" title="7.查询student表中年龄最大的4位同学"></a>7.查询student表中年龄最大的4位同学</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT * FROM student ORDER BY age DESC LIMIT 4;</span><br><span class="line">+----+-----------+------+</span><br><span class="line">| id | name      | age  |</span><br><span class="line">+----+-----------+------+</span><br><span class="line">|  7 | lisi      |   50 |</span><br><span class="line">|  4 | sean      |   28 |</span><br><span class="line">|  5 | zhangshan |   26 |</span><br><span class="line">|  3 | wangqing  |   25 |</span><br><span class="line">+----+-----------+------+</span><br><span class="line">4 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<h5 id="8-查询student表中名字叫zhangshan的记录"><a href="#8-查询student表中名字叫zhangshan的记录" class="headerlink" title="8.查询student表中名字叫zhangshan的记录"></a>8.查询student表中名字叫zhangshan的记录</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT * FROM student WHERE name = &apos;zhangshan&apos;;</span><br><span class="line">+----+-----------+------+</span><br><span class="line">| id | name      | age  |</span><br><span class="line">+----+-----------+------+</span><br><span class="line">|  5 | zhangshan |   26 |</span><br><span class="line">|  6 | zhangshan |   20 |</span><br><span class="line">+----+-----------+------+</span><br><span class="line">2 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<h5 id="9-查询student表中名字叫zhangshan且年龄大于20岁的记录"><a href="#9-查询student表中名字叫zhangshan且年龄大于20岁的记录" class="headerlink" title="9.查询student表中名字叫zhangshan且年龄大于20岁的记录"></a>9.查询student表中名字叫zhangshan且年龄大于20岁的记录</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT * FROM student WHERE name = &apos;zhangshan&apos; AND age &gt; 20;</span><br><span class="line">+----+-----------+------+</span><br><span class="line">| id | name      | age  |</span><br><span class="line">+----+-----------+------+</span><br><span class="line">|  5 | zhangshan |   26 |</span><br><span class="line">+----+-----------+------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<h5 id="10-查询student表中年龄在23到30之间的记录"><a href="#10-查询student表中年龄在23到30之间的记录" class="headerlink" title="10.查询student表中年龄在23到30之间的记录"></a>10.查询student表中年龄在23到30之间的记录</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT * FROM student WHERE age BETWEEN 23 AND 30;</span><br><span class="line">+----+-----------+------+</span><br><span class="line">| id | name      | age  |</span><br><span class="line">+----+-----------+------+</span><br><span class="line">|  3 | wangqing  |   25 |</span><br><span class="line">|  4 | sean      |   28 |</span><br><span class="line">|  5 | zhangshan |   26 |</span><br><span class="line">+----+-----------+------+</span><br><span class="line">3 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<h5 id="11-修改wangwu的年龄为100"><a href="#11-修改wangwu的年龄为100" class="headerlink" title="11.修改wangwu的年龄为100"></a>11.修改wangwu的年龄为100</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; UPDATE student SET age = 100 WHERE name = &apos;wangwu&apos;;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line">Rows matched: 1  Changed: 1  Warnings: 0</span><br><span class="line"></span><br><span class="line">mysql&gt; SELECT * FROM student;</span><br><span class="line">+----+-------------+------+</span><br><span class="line">| id | name        | age  |</span><br><span class="line">+----+-------------+------+</span><br><span class="line">|  1 | tom         |   20 |</span><br><span class="line">|  2 | jerry       |   23 |</span><br><span class="line">|  3 | wangqing    |   25 |</span><br><span class="line">|  4 | sean        |   28 |</span><br><span class="line">|  5 | zhangshan   |   26 |</span><br><span class="line">|  6 | zhangshan   |   20 |</span><br><span class="line">|  7 | lisi        |   50 |</span><br><span class="line">|  8 | chenshuo    |   10 |</span><br><span class="line">|  9 | wangwu      |  100 |</span><br><span class="line">| 10 | qiuyi       |   15 |</span><br><span class="line">| 11 | qiuxiaotian |   20 |</span><br><span class="line">+----+-------------+------+</span><br><span class="line">11 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<h5 id="12-删除student中名字叫zhangshan且年龄小于等于20的记录"><a href="#12-删除student中名字叫zhangshan且年龄小于等于20的记录" class="headerlink" title="12.删除student中名字叫zhangshan且年龄小于等于20的记录"></a>12.删除student中名字叫zhangshan且年龄小于等于20的记录</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; DELETE FROM student WHERE name = &apos;zhangshan&apos; AND age &lt;= 20;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; SELECT * FROM student;</span><br><span class="line">+----+-------------+------+</span><br><span class="line">| id | name        | age  |</span><br><span class="line">+----+-------------+------+</span><br><span class="line">|  1 | tom         |   20 |</span><br><span class="line">|  2 | jerry       |   23 |</span><br><span class="line">|  3 | wangqing    |   25 |</span><br><span class="line">|  4 | sean        |   28 |</span><br><span class="line">|  5 | zhangshan   |   26 |</span><br><span class="line">|  7 | lisi        |   50 |</span><br><span class="line">|  8 | chenshuo    |   10 |</span><br><span class="line">|  9 | wangwu      |  100 |</span><br><span class="line">| 10 | qiuyi       |   15 |</span><br><span class="line">| 11 | qiuxiaotian |   20 |</span><br><span class="line">+----+-------------+------+</span><br><span class="line">10 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>
          
        
      
    </div>

    

    

    
    
    

    

    
      
    
    

    
	
	  <div>
        
      </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/6/">6</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <div class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">

          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  
  <p class="site-author-name" itemprop="name">itw</p>
  <div class="site-description motion-element" itemprop="description"></div>
</div>


  <nav class="site-state motion-element">
    
      <div class="site-state-item site-state-posts">
        
          <a href="/archives/">
        
          <span class="site-state-item-count">51</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
    

    
      
      
      <div class="site-state-item site-state-categories">
        
        
        
          
        
        <span class="site-state-item-count">1</span>
        <span class="site-state-item-name">分类</span>
        
      </div>
    

    
      
      
      <div class="site-state-item site-state-tags">
        
        
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
        <span class="site-state-item-count">28</span>
        <span class="site-state-item-name">标签</span>
        
      </div>
    
  </nav>



  <div class="feed-link motion-element">
    <a href="/atom.xml" rel="alternate">
      <i class="fa fa-rss"></i>RSS
    </a>
  </div>











          
          
        </div>
      </div>

      

      

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">itw</span>

  

  
</div>


<div class="powered-by">
<i class="fa fa-user-md"></i><span id="busuanzi_container_site_uv">
  本站访客数:<span id="busuanzi_value_site_uv"></span>
</span>
</div>
<!-- <div class="powered-by">由 <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v3.9.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> v7.2.0</div>
-->



<div class="theme-info">
  <div class="powered-by"></div>
  <span class="post-count">博客全站共183.1k字</span>
</div>

        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>










  
  













  
  <script src="/lib/jquery/index.js?v=3.4.1"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>




  <script src="/js/utils.js?v=7.2.0"></script>

  <script src="/js/motion.js?v=7.2.0"></script>



  
  


  <script src="/js/schemes/muse.js?v=7.2.0"></script>



  

  <script src="/js/next-boot.js?v=7.2.0"></script>

  

  

  

  

  



  




  

  

  

  

  

  

  

  

  

  

  

  

  


  

   <canvas class="fireworks" style="position: fixed;left: 0;top: 0;z-index: 1; pointer-events: none;"></canvas> 
   <script type="text/javascript" src="//cdn.bootcss.com/animejs/2.2.0/anime.min.js"></script> 
   <script type="text/javascript" src="/js/fireworks.js"></script>

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>
</html>

<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>itw</title>
  
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://aiwhs.github.io/"/>
  <updated>2019-07-17T13:24:00.299Z</updated>
  <id>http://aiwhs.github.io/</id>
  
  <author>
    <name>itw</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>CentOS 7.6+NFS+Heartbeat+DRBD</title>
    <link href="http://aiwhs.github.io/2019/03/03/CentOS%207.6+NFS+Heartbeat+DRBD/"/>
    <id>http://aiwhs.github.io/2019/03/03/CentOS 7.6+NFS+Heartbeat+DRBD/</id>
    <published>2019-03-03T00:15:57.000Z</published>
    <updated>2019-07-17T13:24:00.299Z</updated>
    
    <content type="html"><![CDATA[<a id="more"></a><h2 id="理论概述"><a href="#理论概述" class="headerlink" title="理论概述"></a>理论概述</h2><p><strong>本案例只是，为搭建MySQL集群做准备，并无MySQL</strong></p><h3 id="DRBD"><a href="#DRBD" class="headerlink" title="DRBD"></a>DRBD</h3><p><strong>DRBD（distributed replicated block device分布式复制块设备）是一个基于软件实现的、无共享的、服务器之间镜像块设备内容的存储复制解决方案。DRBD是镜像块设备，是按数据位镜像成一样的数据块</strong></p><p>DRBD可以部署在如下类的底层设备上：</p><p> 1、一个磁盘，或者是磁盘的某一个分区；</p><p> 2、一个soft raid 设备；</p><p> 3、一个LVM的逻辑卷；</p><p> 4、一个EVMS（Enterprise Volume Management System，企业卷管理系统）的卷；</p><p> 5、其他任何的块设备。</p><p><strong>工作原理</strong></p><p><img src="../../img/19051714132885.jpg" alt="CentOS 7.6数据库架构之NFS+Heartbeat+DRBD实测"></p><p>DRBD需要运行在各个节点上，且是运行在节点主机的内核中，所以DRBD是内核模块，在Linux2.6.33版本起开始整合进内核。</p><p><strong>DRBD工作的位置在文件系统的buffer Cache和磁盘调度器之间</strong></p><p>如上图左节点为活跃节点实线箭头，有节点为备用节点虚线箭头。 左节点接收到数据法网内核的数据通路，DRBD在数据通路中注册钩子检查数据（类似ipvs）当检测到接收的数据是发往自己管理的存储位置，程序会复制另一份，一份存储到本机的DRBD存储设备，另一份就发给TCP/IP协议栈，通过网络传输到另一台节点上TCP/IP协议栈；另一台节点上运行的DRBD模块同样在数据通路上监测数据，当检测到传输过来的数据时，运行存储机制，存储到本机DRBD存储设备的对应位置。</p><p><strong>如果左节点宕机，在高可用集群中右节点成为活跃节点，并且会接收到左节点宕机的信号，接受数据先保存到本地，左节点恢复上线之后，再把左节点宕机后右节点变动的 数据镜像到左节点。 每个设备（drbd 提供了不止一个设备）都有一个状态，可能是‘主’状态或‘从’态。在主节点上，应用程序应能运行和访问drbd设备（/dev/drbd）。每次写入会发往本地磁盘设备和从节点设备中。从节点只能简单地把数据写入它的磁盘设上。 读取数据通常在本地进行。如果主节点发生故障，心跳（heartbeat或corosync）将会把从节点转换到主状态，并启动其上的应用程序。（如果您将它和无日志FS 一起使用，则需要运行fsck）。如果发生故障的节点恢复工作，它就会成为新的从节点，而且必须使自己的内容与主节点的内容保持同步。</strong></p><p><strong>复制模式</strong> 镜像过程完成之后还需要返回成功或失败的回应信息。回应信息可以在传输过程中的不同位置返回，如上图A/B/C三处， 可以分为三种复制模式：</p><blockquote><p><strong>特点： 实时复制：一段修改之后马上复制过去 透明的传输：程序不需要检测到这个数据存储在多个主机上 同步或者异步：同步镜像：程序写操作完成后会通知所有已经连接的主机；异步同步：程序会在本地写完之前通知其它的主机。</strong></p></blockquote><blockquote><p>A:一旦本地磁盘写入已经完成，数据包已在发送队列中，则写操作被认为是完成的 。在一个节点发生故障时，可能发生数据丢失，因为被写入到远程节点上的数据可能仍在发送队列。尽管，在故障转移节点上的数据是一致的，但没有及时更新。这通常是用于地理上分开的节点。</p><p>  B:一旦本地磁盘写入已完成且复制数据包达到了对等节点则认为写操作在主节点上被认为是完成的。数据丢失可能发生在参加的两个节点同时故障的情况下，因为在飞行中的数据可能不会被提交到磁盘。 </p><p>  C:只有在本地和远程节点的磁盘已经确认了写操作完成，写才被认为完成。没有任何数据丢失，所以这是一个群集节点的流行模式，但I/O吞吐量依赖于网络带宽。 A 数据一旦写入磁盘并发送到网络中就认为完成了写入操作。 B 收到接收确认就认为完成了写入操作。 C 收到写入确认就认为完成了写入操作。 就目前而言应用最多和应用最广泛的为协议C。</p></blockquote><h3 id="架构"><a href="#架构" class="headerlink" title="架构"></a>架构</h3><p><strong>MySQL+heartbeat+drbd+lvs是一套成熟的集群解决方案在现在多数企业里面，通过heartbeat+DRBD完成MySQL的主节点写操作的高可用性，通过MySQL+lvs实现MySQL数据库的主从复制和MySQL读写的负载均衡。这个方案在读写方面进行了分离，融合了写操作的高可用和读操作的负载均衡。</strong></p><h3 id="NFS"><a href="#NFS" class="headerlink" title="NFS"></a>NFS</h3><p><strong>NFS作为业界常用的共享存储方案，被众多公司采用。使用NFS作为共享存储，为前端WEB server提供服务，主要存储网页代码以及其他文件。</strong></p><ul><li>常用同步技术</li></ul><ol><li>rsync+inotify实现文件同步</li><li>借助DRBD，实现文件同步<br>但是以上方案都没有实现高可用，只是实现了两者数据同步。但是业务要求NFS服务器必须是高可用，所以我们在第二种同步方案的基础上，在结合heartbeat来实现高可用。</li></ol><h2 id="架构部署"><a href="#架构部署" class="headerlink" title="架构部署"></a>架构部署</h2><p>采用MySQL读写分离的方案；而读写之间的数据同步采用MySQL的单项或者双向复制技术实现。 MySQL写操作采用基于heartbeat+DRBD+MySQL搭建高可用集群；读操作普遍采用基于LVS+keepalived搭建高可用扩展集群方案</p><p><strong>本案例中暂时没部署MySQL，实现思路：ct74和ct75两台机器，分别安装nfs，heartbeat，ct74，DRBD。</strong></p><ul><li>nfs可以另找一台服务器搭建专门用为共享存储。</li><li>nfs的控制权交给了heartbeat。</li></ul><p>架构拓扑</p><p><img src="../../img/19051714146047.png" alt="CentOS 7.6数据库架构之NFS+Heartbeat+DRBD实测"></p><p><strong>环境</strong> 全部都是CentOS7.6 系统</p><table><thead><tr><th>主机名</th><th>IP</th><th align="center">担任角色</th></tr></thead><tbody><tr><td>ct74</td><td>192.168.137.74</td><td align="center">drbd主，nfs server，heartbeat主</td></tr><tr><td>ct75</td><td>192.168.137.75</td><td align="center">drbd被，heartbeat被</td></tr><tr><td>VIP</td><td>192.168.137.82</td><td align="center"></td></tr><tr><td>nfs客户端</td><td>192.168.137.61</td><td align="center">挂载VIP共享的目录测试</td></tr></tbody></table><h3 id="部署DRBD"><a href="#部署DRBD" class="headerlink" title="部署DRBD"></a>部署DRBD</h3><ol><li>所有主机配置hosts并且改为对应的主机名</li><li>所有主机保持网络状况的良好通信</li><li>所有主机安装最新的epel源</li><li>DRBD这两台各自分别添加了1GB硬盘供DRBD使用</li><li>同步时间</li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root@ct74 ~]# vim /etc/hosts</span><br><span class="line">192.168.137.74 ct74</span><br><span class="line">192.168.137.75 ct75</span><br><span class="line"></span><br><span class="line">[root@ct74 ~]# ssh-keygen -q -t rsa -N &apos;&apos; -f ~/.ssh/id_rsa</span><br><span class="line">[root@ct74 ~]# ssh-copy-id root@ct75</span><br><span class="line">#ssh免密认证</span><br><span class="line"></span><br><span class="line">[root@ct74 ~]# uname -r</span><br><span class="line">3.10.0-957.21.3.el7.x86_64</span><br><span class="line">#要是这个957版本以后的,若不是,请升级(yum update kernel* -y)然后reboot</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@ct75 ~]# yum install https://www.elrepo.org/elrepo-release-7.0-3.el7.elrepo.noarch.rpm -y</span><br><span class="line"></span><br><span class="line">[root@ct75 ~]# yum -y install drbd84-utils kmod-drbd84</span><br><span class="line">#安装DRBD</span><br><span class="line">[root@ct75 ~]# modprobe drbd</span><br><span class="line">#不出意外这样就OK了</span><br><span class="line">echo &quot;modprobe drbd&quot;&gt;&gt;/etc/rc.local    # 加入开机自启动</span><br><span class="line">chmod +x /etc/rc.d/rc.local</span><br><span class="line">[root@ct75 ~]# lsmod |grep -i drbd</span><br><span class="line">drbd                  397041  0 </span><br><span class="line">libcrc32c              12644  4 xfs,drbd,nf_nat,nf_conntrack</span><br></pre></td></tr></table></figure><ul><li>分区</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[root@ct75 ~]# fdisk /dev/sdb</span><br><span class="line">欢迎使用 fdisk (util-linux 2.23.2)。</span><br><span class="line"></span><br><span class="line">更改将停留在内存中，直到您决定将更改写入磁盘。</span><br><span class="line">使用写入命令前请三思。</span><br><span class="line"></span><br><span class="line">Device does not contain a recognized partition table</span><br><span class="line">使用磁盘标识符 0x7ce5781e 创建新的 DOS 磁盘标签。</span><br><span class="line"></span><br><span class="line">命令(输入 m 获取帮助)：n</span><br><span class="line">Partition type:</span><br><span class="line">   p   primary (0 primary, 0 extended, 4 free)</span><br><span class="line">   e   extended</span><br><span class="line">Select (default p): p</span><br><span class="line">分区号 (1-4，默认 1)：</span><br><span class="line">起始 扇区 (2048-2097151，默认为 2048)：</span><br><span class="line">将使用默认值 2048</span><br><span class="line">Last 扇区, +扇区 or +size&#123;K,M,G&#125; (2048-2097151，默认为 2097151)：</span><br><span class="line">将使用默认值 2097151</span><br><span class="line">分区 1 已设置为 Linux 类型，大小设为 1023 MiB</span><br><span class="line"></span><br><span class="line">命令(输入 m 获取帮助)：w</span><br><span class="line">The partition table has been altered!</span><br><span class="line"></span><br><span class="line">Calling ioctl() to re-read partition table.</span><br><span class="line">正在同步磁盘。</span><br><span class="line">[root@ct75 ~]# partprobe /dev/sdb</span><br><span class="line">#以上关于DRBD和分区的操作在2台机器上重复操作，master和backup分区大小一致。</span><br></pre></td></tr></table></figure><ul><li>修改配置文件</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">[root@ct74 ~]# vim /etc/drbd.conf</span><br><span class="line">#include &quot;drbd.d/global_common.conf&quot;; </span><br><span class="line">#注释掉这行，避免和我们自己写的配置产生冲突。</span><br><span class="line">    include &quot;drbd.d/*.res&quot;;</span><br><span class="line">    include &quot;drbd.d/*.cfg&quot;;</span><br><span class="line">[root@ct74 ~]# vim /etc/drbd.d/drbd_basic.cfg</span><br><span class="line">global &#123;</span><br><span class="line">    usage-count yes;</span><br><span class="line">#是否参与DRBD使用者统计，默认为yes，yes or no都无所谓 </span><br><span class="line">&#125;</span><br><span class="line">common &#123;</span><br><span class="line">    syncer &#123; rate 100M; &#125;</span><br><span class="line">&#125;</span><br><span class="line">#设置主备节点同步的网络速率最大值，默认单位是字节，我们可以设定为兆</span><br><span class="line">resource r0 &#123;</span><br><span class="line">#r0为资源名，我们在初始化磁盘的时候就可以使用资源名来初始化。</span><br><span class="line">    protocol C;</span><br><span class="line">#使用 C 协议。</span><br><span class="line">    handlers &#123;</span><br><span class="line">        pri-on-incon-degr &quot;echo o &gt; /proc/sysrq-trigger ; halt -f &quot;;  </span><br><span class="line">        pri-lost-after-sb &quot;echo o &gt; /proc/sysrq-trigger ; halt &quot;;</span><br><span class="line">        local-io-error &quot;echo o &gt; /proc/sysrq-trigger ; halt -f&quot;;</span><br><span class="line">        fence-peer &quot;/usr/lib4/heartbeat/drbd-peer-outdater -t 5&quot;;</span><br><span class="line">        pri-lost &quot;echo pri-lst. Have a look at the log file.mail -s &apos;Drbd Alert&apos; root&quot;;</span><br><span class="line">        split-brain &quot;/usr/lib/drbd/notify-split-brain.sh root&quot;;</span><br><span class="line">        out-of-sync &quot;/usr/lib/drbd/notify-out-of-sync.sh root&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">    net &#123;</span><br><span class="line">        cram-hmac-alg &quot;sha1&quot;;</span><br><span class="line">        shared-secret &quot;MySQL-HA&quot;;</span><br><span class="line">#drbd同步时使用的验证方式和密码信息</span><br><span class="line">    &#125;</span><br><span class="line">    disk &#123;</span><br><span class="line">        on-io-error detach;</span><br><span class="line">        fencing resource-only;</span><br><span class="line"># 使用DOPD（drbd outdate-peer deamon）功能保证数据不同步的时候不进行切换。</span><br><span class="line">    &#125;</span><br><span class="line">    startup &#123;</span><br><span class="line">        wfc-timeout 120;</span><br><span class="line">        degr-wfc-timeout 120;</span><br><span class="line">    &#125;</span><br><span class="line">    device /dev/drbd0;</span><br><span class="line">#这里/dev/drbd0是用户挂载时的设备名字，由DRBD进程创建</span><br><span class="line">    on ct74 &#123;</span><br><span class="line">#每个主机名的说明以on开头，后面是hostname（必须在/etc/hosts可解析）</span><br><span class="line">        disk /dev/sdb1;</span><br><span class="line">#使用这个磁盘作为drbd的磁盘/dev/drbd0。</span><br><span class="line">        address 192.168.137.74:7788;</span><br><span class="line">#设置DRBD的监听端口，用于与另一台主机通信</span><br><span class="line">        meta-disk internal;</span><br><span class="line">#drbd的元数据存放方式</span><br><span class="line">    &#125;</span><br><span class="line">    on ct75 &#123;</span><br><span class="line">        disk /dev/sdb1;</span><br><span class="line">        address 192.168.137.75:7788;</span><br><span class="line">        meta-disk internal;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[root@dbmaster ~]# dd if=/dev/zero of=/dev/sdb1 bs=1M count=1</span><br><span class="line">记录了1+0 的读入</span><br><span class="line">记录了1+0 的写出</span><br><span class="line">1048576字节(1.0 MB)已复制，0.00339429 秒，309 MB/秒</span><br><span class="line">[root@ct74 ~]# drbdadm create-md r0</span><br><span class="line">  --==  Thank you for participating in the global usage survey  ==--</span><br><span class="line">The server&apos;s response is:</span><br><span class="line"></span><br><span class="line">you are the 14097th user to install this version</span><br><span class="line">WARN:</span><br><span class="line">  You are using the &apos;drbd-peer-outdater&apos; as fence-peer program.</span><br><span class="line">  If you use that mechanism the dopd heartbeat plugin program needs</span><br><span class="line">  to be able to call drbdsetup and drbdmeta with root privileges.</span><br><span class="line"></span><br><span class="line">  You need to fix this with these commands:</span><br><span class="line">  chgrp haclient /lib/drbd/drbdsetup-84</span><br><span class="line">  chmod o-x /lib/drbd/drbdsetup-84</span><br><span class="line">  chmod u+s /lib/drbd/drbdsetup-84</span><br><span class="line"></span><br><span class="line">  chgrp haclient /usr/sbin/drbdmeta</span><br><span class="line">  chmod o-x /usr/sbin/drbdmeta</span><br><span class="line">  chmod u+s /usr/sbin/drbdmeta</span><br><span class="line"></span><br><span class="line">initializing activity log</span><br><span class="line">initializing bitmap (32 KB) to all zero</span><br><span class="line">Writing meta data...</span><br><span class="line">New drbd meta data block successfully created.</span><br><span class="line">success</span><br><span class="line">#使用dd命令清空，然后再执行</span><br></pre></td></tr></table></figure><ul><li>进一步配置</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[root@ct74 ~]# drbdadm up all</span><br><span class="line">[root@ct74 ~]# systemctl start drbd.service</span><br><span class="line">[root@ct75 ~]# systemctl enable drbd.service </span><br><span class="line">#启动服务</span><br><span class="line"></span><br><span class="line">#如报错，试试如下，不报错跳过这步</span><br><span class="line">groupadd haclient</span><br><span class="line">chgrp haclient /lib/drbd/drbdsetup-84</span><br><span class="line">chmod o-x /lib/drbd/drbdsetup-84</span><br><span class="line">chmod u+s /lib/drbd/drbdsetup-84</span><br><span class="line">chgrp haclient /usr/sbin/drbdmeta</span><br><span class="line">chmod o-x /usr/sbin/drbdmeta</span><br><span class="line">chmod u+s /usr/sbin/drbdmeta</span><br><span class="line">#以上这几个操作，找了很多资料都没有提到要做，还特意提醒不用做，可能环境不同吧，不做一直报错</span><br><span class="line"></span><br><span class="line">[root@ct74 ~]# drbdadm primary --force r0</span><br><span class="line">#仅在主上操作</span><br><span class="line">[root@ct74 ~]# drbdadm role r0</span><br><span class="line">Primary/Secondary</span><br><span class="line">#查看状态</span><br><span class="line">[root@ct74 ~]# watch -n1 -x cat /proc/drbd</span><br><span class="line"></span><br><span class="line">[root@ct75 ~]# drbdadm role r0</span><br><span class="line">Secondary/Primary</span><br><span class="line">#backup机器查看状态</span><br><span class="line"></span><br><span class="line">[root@ct75 ~]# drbdadm dstate r0</span><br><span class="line">UpToDate/UpToDate</span><br><span class="line">#查看数据同步状态，如上为一致，还有Inconsistent状态为数据不一致正在同步</span><br></pre></td></tr></table></figure><ul><li>挂载DRBD磁盘</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">现在ct74上操作</span><br><span class="line">[root@ct74 ~]# mkfs.ext4 /dev/drbd0 </span><br><span class="line">mke2fs 1.42.9 (28-Dec-2013)</span><br><span class="line">文件系统标签=</span><br><span class="line">OS type: Linux</span><br><span class="line">块大小=4096 (log=2)</span><br><span class="line">分块大小=4096 (log=2)</span><br><span class="line">Stride=0 blocks, Stripe width=0 blocks</span><br><span class="line">65536 inodes, 261871 blocks</span><br><span class="line">13093 blocks (5.00%) reserved for the super user</span><br><span class="line">第一个数据块=0</span><br><span class="line">Maximum filesystem blocks=268435456</span><br><span class="line">8 block groups</span><br><span class="line">32768 blocks per group, 32768 fragments per group</span><br><span class="line">8192 inodes per group</span><br><span class="line">Superblock backups stored on blocks: </span><br><span class="line">    32768, 98304, 163840, 229376</span><br><span class="line"></span><br><span class="line">Allocating group tables: 完成                            </span><br><span class="line">正在写入inode表: 完成                            </span><br><span class="line">Creating journal (4096 blocks): 完成</span><br><span class="line">Writing superblocks and filesystem accounting information: 完成</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@ct74 ~]# mkdir /nfs</span><br><span class="line">[root@ct74 ~]# mount /dev/drbd0 /nfs</span><br><span class="line">[root@ct74 ~]# df -Th</span><br><span class="line">Filesystem     Type      Size  Used Avail Use% Mounted on</span><br><span class="line">/dev/sda3      ext4       46G  1.7G   42G   4% /</span><br><span class="line">devtmpfs       devtmpfs  749M     0  749M   0% /dev</span><br><span class="line">tmpfs          tmpfs     759M     0  759M   0% /dev/shm</span><br><span class="line">tmpfs          tmpfs     759M  8.8M  750M   2% /run</span><br><span class="line">tmpfs          tmpfs     759M     0  759M   0% /sys/fs/cgroup</span><br><span class="line">/dev/sda1      ext4      477M  124M  325M  28% /boot</span><br><span class="line">tmpfs          tmpfs     152M     0  152M   0% /run/user/0</span><br><span class="line">/dev/drbd0     ext4      991M  2.6M  922M   1% /nfs</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">现在是ct75上操作，主要是检测备端是否能够正常挂载和使用：</span><br><span class="line"></span><br><span class="line">[root@ct74 ~]# umount /nfs</span><br><span class="line">#主上将设备卸载</span><br><span class="line">[root@ct74 ~]# drbdadm secondary all</span><br><span class="line">#切换为被状态</span><br><span class="line"></span><br><span class="line">[root@ct75 ~]# drbdadm primary r0</span><br><span class="line">#被设为主状态</span><br><span class="line">[root@ct75 ~]# mkdir /nfs</span><br><span class="line">[root@ct75 ~]# mount /dev/drbd0 /nfs</span><br><span class="line"></span><br><span class="line">[root@ct75 ~]# df -Th</span><br><span class="line">Filesystem     Type      Size  Used Avail Use% Mounted on</span><br><span class="line">/dev/sda3      ext4       46G  1.7G   42G   4% /</span><br><span class="line">devtmpfs       devtmpfs  749M     0  749M   0% /dev</span><br><span class="line">tmpfs          tmpfs     759M     0  759M   0% /dev/shm</span><br><span class="line">tmpfs          tmpfs     759M  8.8M  750M   2% /run</span><br><span class="line">tmpfs          tmpfs     759M     0  759M   0% /sys/fs/cgroup</span><br><span class="line">/dev/sda1      ext4      477M  124M  325M  28% /boot</span><br><span class="line">tmpfs          tmpfs     152M     0  152M   0% /run/user/0</span><br><span class="line">/dev/drbd0     ext4      991M  2.6M  922M   1% /nfs</span><br><span class="line"></span><br><span class="line">再按相同的方法将状态切换回来</span><br></pre></td></tr></table></figure><p><strong>好的，这下简单测试了下，先告一段落</strong></p><h3 id="部署heartbeat"><a href="#部署heartbeat" class="headerlink" title="部署heartbeat"></a>部署heartbeat</h3><ul><li>安装cluster-glue</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">yum install gcc gcc-c++ flex autoconf automake libtool glib2-devel libxml2-devel bzip2 bzip2-devel e2fsprogs-devel libxslt-devel libtool-ltdl-devel asciidoc -y</span><br><span class="line">#两机同样操作安装依赖</span><br><span class="line"></span><br><span class="line">groupadd haclient</span><br><span class="line">useradd -g haclient hacluster -s /sbin/nologin</span><br><span class="line"></span><br><span class="line">安装包下载</span><br><span class="line">下载软件包：Reusable-Components-glue、resource-agents、heartbeat</span><br><span class="line">cd /opt</span><br><span class="line">wget http://hg.linux-ha.org/heartbeat-STABLE_3_0/archive/958e11be8686.tar.bz2</span><br><span class="line">wget http://hg.linux-ha.org/glue/archive/0a7add1d9996.tar.bz2</span><br><span class="line">wget https://github.com/ClusterLabs/resource-agents/archive/v3.9.6.tar.gz</span><br><span class="line"></span><br><span class="line">tar xf 0a7add1d9996.tar.bz2</span><br><span class="line">cd Reusable-Cluster-Components-glue--0a7add1d9996/</span><br><span class="line">./autogen.sh</span><br><span class="line">./configure --prefix=/usr/local/heartbeat --with-daemon-user=hacluster --with-daemon-group=haclient --enable-fatal-warnings=no LIBS=&apos;/lib64/libuuid.so.1&apos;</span><br><span class="line">make &amp;&amp; make install</span><br><span class="line">echo $?</span><br><span class="line">cd ..</span><br></pre></td></tr></table></figure><ul><li>安装resource-agents</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">tar xf v3.9.6.tar.gz</span><br><span class="line">cd resource-agents-3.9.6/</span><br><span class="line">./autogen.sh </span><br><span class="line">./configure --prefix=/usr/local/heartbeat --with-daemon-user=hacluster --with-daemon-group=haclient --enable-fatal-warnings=no LIBS=&apos;/lib64/libuuid.so.1&apos;</span><br><span class="line">make &amp;&amp; make install</span><br><span class="line">echo $?</span><br><span class="line">cd ..</span><br></pre></td></tr></table></figure><ul><li>安装heartbeat</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">tar xf 958e11be8686.tar.bz2</span><br><span class="line">cd Heartbeat-3-0-958e11be8686/</span><br><span class="line">./bootstrap</span><br><span class="line">export CFLAGS=&quot;$CFLAGS -I/usr/local/heartbeat/include -L/usr/local/heartbeat/lib&quot; </span><br><span class="line">./configure --prefix=/usr/local/heartbeat --with-daemon-user=hacluster --with-daemon-group=haclient --enable-fatal-warnings=no LIBS=&apos;/lib64/libuuid.so.1&apos;</span><br><span class="line">make &amp;&amp; make install</span><br><span class="line">echo $?</span><br><span class="line"></span><br><span class="line">mkdir -pv /usr/local/heartbeat/usr/lib/ocf/lib/heartbeat/</span><br><span class="line">cp -R /usr/lib/ocf/lib/heartbeat/ocf-* /usr/local/heartbeat/usr/lib/ocf/lib/heartbeat/</span><br><span class="line">cp -R /opt/Heartbeat-3-0-958e11be8686/doc/&#123;ha.cf,haresources,authkeys&#125; /usr/local/heartbeat/etc/ha.d/</span><br><span class="line">#拷贝配置文件</span><br><span class="line"></span><br><span class="line">chmod 600 /usr/local/heartbeat/etc/ha.d/authkeys</span><br><span class="line">#该权限必须为600</span><br><span class="line">#以上安装两台机器一样</span><br></pre></td></tr></table></figure><ul><li>配置文件</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">[root@ct74 ~]# vim /usr/local/heartbeat/etc/ha.d/haresources</span><br><span class="line">#末尾添加如下</span><br><span class="line">ct74 IPaddr::192.168.137.82/24/eth0 drbddisk::r0 Filesystem::/dev/drbd0::/nfs::ext4 killnfsd</span><br><span class="line">#ct74 IPaddr::192.168.137.82/24/eth0主机名 后跟虚拟IP地址、接口</span><br><span class="line">#drbddisk::r0管理drbd资源的名称</span><br><span class="line">#Filesystem::/dev/drbd0::/nfs::ext4 renfsd文件系统::挂载的目录及格式::后跟renfsd资源脚本</span><br><span class="line"></span><br><span class="line">cp -R /etc/ha.d/resource.d/drbddisk /usr/local/heartbeat/etc/ha.d/resource.d/</span><br><span class="line">#两台一样</span><br><span class="line"></span><br><span class="line">echo &quot;pkill -9 nfs; systemctl restart nfs; exit 0&quot; &gt; /usr/local/heartbeat/etc/ha.d/resource.d/killnfsd</span><br><span class="line">#编辑nfs脚本文件killnfsd ，killnfsd 脚本文件的作用，</span><br><span class="line">#drbd主备切换时，若nfs没有启动，则此脚本会把nfs启动</span><br><span class="line">#drbd主备切换时，若nfs已启动，则此脚本会重启nfs服务，因为NFS服务切换后，必须重新mount一下nfs共享出来的目录，否则会出现stale NFS file handle的错误</span><br><span class="line"></span><br><span class="line">chmod +x /usr/local/heartbeat/etc/ha.d/resource.d/drbddisk</span><br><span class="line">chmod +x /usr/local/heartbeat/etc/ha.d/resource.d/killnfsd </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@ct74 resource.d]# pwd</span><br><span class="line">/usr/local/heartbeat/etc/ha.d/resource.d</span><br><span class="line">[root@ct74 resource.d]#  ll drbddisk Filesystem killnfsd IPaddr </span><br><span class="line">-rwxr-xr-x 1 root root 3162 5月  14 15:43 drbddisk</span><br><span class="line">-rwxr-xr-x 1 root root 1923 5月  14 10:15 Filesystem</span><br><span class="line">-rwxr-xr-x 1 root root 2297 5月  14 10:15 IPaddr</span><br><span class="line">-rwxr-xr-x 1 root root   57 5月  14 15:41 killnfsd</span><br><span class="line">#必须要有这四个脚本，有的是自带，有的是复制，有的自己写，上面已经说明而且必须要有执行权限。</span><br><span class="line">[root@ct74 ~]# vim  /usr/local/heartbeat/etc/ha.d/ha.cf</span><br><span class="line">#修改主配置文件（去掉注释或修改值）</span><br><span class="line">debugfile /var/log/ha-debug</span><br><span class="line">logfile /var/log/ha-log</span><br><span class="line">#指定heartbeat日志文件的位置</span><br><span class="line">logfacility     local0</span><br><span class="line">#利用系统日志打印日志</span><br><span class="line">keepalive 1</span><br><span class="line"># 心跳发送时间间隔</span><br><span class="line">deadtime 5</span><br><span class="line"> # 备用节点5s内没有检测到master机的心跳，确认对方故障</span><br><span class="line">warntime 2</span><br><span class="line"># 警告2次</span><br><span class="line">initdead 10</span><br><span class="line"># 守护进程启动30s后，启动服务资源。</span><br><span class="line">udpport 694</span><br><span class="line">#设定集群节点间的通信协议及端口为udp694监听端口（该端口可以修改）</span><br><span class="line">ucast eth0 192.168.137.75</span><br><span class="line"># 另一台主机节点eth0的地址，注意是另一台。</span><br><span class="line">auto_failback off</span><br><span class="line">#当primary节点切换到secondary节点之后，primary节点恢复正常，不进行切回操作，因为切换一次mysql master成本很高。</span><br><span class="line">node    ct74</span><br><span class="line">node    ct75</span><br><span class="line"># 定义两个节点的主机名，一行写一个。</span><br><span class="line">ping 192.168.137.1</span><br><span class="line">#两个IP的网关</span><br><span class="line">respawn hacluster /usr/local/heartbeat/libexec/heartbeat/ipfail </span><br><span class="line">#使用这个脚本去侦听对方是否还活着（使用的是ICMP报文检测）</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@ct74 ~]# vim /usr/local/heartbeat/etc/ha.d/authkeys</span><br><span class="line">#认证文件</span><br><span class="line">auth 1</span><br><span class="line">#表示使用id为2的验证 下边需要定义一个2的验证算法</span><br><span class="line">1 sha1 HA_DB</span><br><span class="line">#口令（HISHA1）随便给 主从配置相同即可</span><br></pre></td></tr></table></figure><p>dbdackup也是同样的安装方法，配置文件直接scp过去就可以了，然后修改</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@ct74 ~]# scp -r /usr/local/heartbeat/etc/ha.d/&#123;authkeys,haresources,ha.cf&#125; root@ct75:/usr/local/heartbeat/etc/ha.d/</span><br><span class="line">[root@ct75 ha.d]# vim /usr/local/heartbeat/etc/ha.d/ha.cf </span><br><span class="line">ucast eth0 192.168.137.74</span><br><span class="line">#把backup节点上ha.cf配置文件中ucast中IP改为对方</span><br><span class="line"></span><br><span class="line">[root@ct74 ~]# ln -svf /usr/local/heartbeat/lib64/heartbeat/plugins/RAExec/* /usr/local/heartbeat/lib/heartbeat/plugins/RAExec/</span><br><span class="line"></span><br><span class="line">[root@ct74 ~]# ln -svf /usr/local/heartbeat/lib64/heartbeat/plugins/* /usr/local/heartbeat/lib/heartbeat/plugins/</span><br><span class="line">#2机器将这些库文件链接过去，要不启动报错</span><br><span class="line">May 13 13:09:27 ct74 heartbeat: [86183]: ERROR: Illegal directive [ucast] in /usr/local/heartbeat/etc/ha.d/ha.cf</span><br></pre></td></tr></table></figure><h3 id="部署NFS及配合heartbeat"><a href="#部署NFS及配合heartbeat" class="headerlink" title="部署NFS及配合heartbeat"></a>部署NFS及配合heartbeat</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[root@ct75 ~]# yum -y install nfs-utils nfs-utils-lib nfs4-acl-tools rpcbind</span><br><span class="line">#ct74和ct75安装</span><br><span class="line">[root@ct74 ~]# vim /etc/exports</span><br><span class="line">/nfs 192.168.137.0/24(rw,sync,no_root_squash)</span><br><span class="line">#设置nfs共享目录，权限，网段</span><br><span class="line">[root@ct74 ~]# systemctl restart rpcbind</span><br><span class="line"></span><br><span class="line">#启动顺序一定是rpcbind-&gt;nfs，否则有可能出现错误</span><br><span class="line">#在这里nfs不需要启动，它由heartbeat控制</span><br><span class="line"></span><br><span class="line">[root@ct74 ~]# systemctl start heartbeat</span><br><span class="line">[root@ct74 ~]# systemctl enable heartbeat</span><br><span class="line">#最多等一两分钟VIP肯定出来，否则查看日志</span><br><span class="line">[root@ct74 ~]# ip a | grep inet</span><br><span class="line">#主上查看</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">    inet6 ::1/128 scope host </span><br><span class="line">    inet 192.168.137.74/24 brd 192.168.137.255 scope global noprefixroute eth0</span><br><span class="line">    inet 192.168.137.82/24 brd 192.168.137.255 scope global secondary eth0:0</span><br><span class="line">    inet6 fe80::20c:29ff:fec3:1a39/64 scope link</span><br><span class="line">#到了这，VIP肯定要出来，可以稍等会，观察下日志。如果出错，上面可能哪一步没有到位</span><br><span class="line">[root@ct74 ~]# mount | grep drbd</span><br><span class="line">/dev/drbd0 on /nfs type ext4 (rw,relatime,data=ordered)</span><br><span class="line">#这个也已经根据配置自动挂载</span><br><span class="line"></span><br><span class="line">[root@ct75 ~]# showmount -e 192.168.137.82</span><br><span class="line">Export list for 192.168.137.82</span><br><span class="line">/nfs 192.168.137.82/24</span><br><span class="line">#查看VIP共享的目录</span><br></pre></td></tr></table></figure><ul><li>配置nfs自动挂载</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# mkdir /nfs</span><br><span class="line">[root@localhost ~]# mount 192.168.137.82:/nfs/ /nfs/</span><br><span class="line">#客户端测试</span><br><span class="line">[root@localhost ~]# echo &quot;192.168.137.82:/nfs /nfs nfs defaults,soft,intr 0 0&quot; &gt;&gt; /etc/fstab </span><br><span class="line">[root@localhost ~]# tail -1 /etc/fstab </span><br><span class="line">192.168.137.82:/nfs /nfs nfs defaults,soft,intr 0 0</span><br><span class="line">#Nfs是类型</span><br><span class="line">#soft参数是为了向用户输出错误信息</span><br><span class="line">#intr参数为了解决当网络出现故障时，我们可以通过按下ctrl+c组合键来终止操作</span><br></pre></td></tr></table></figure><ul><li>验证：接下来我们在主上把nfs服务关掉，模拟故障，看VIP是否切换主机</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@ct74 ~]# systemctl stop nfs</span><br><span class="line">[root@ct74 ~]# systemctl status nfs</span><br><span class="line">● nfs-server.service - NFS server and services</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/nfs-server.service; disabled; vendor preset: disabled)</span><br><span class="line">  Drop-In: /run/systemd/generator/nfs-server.service.d</span><br><span class="line">           └─order-with-mounts.conf</span><br><span class="line">   Active: inactive (dead) since 二 2019-05-14 18:21:09 CST; 6s ago</span><br><span class="line">  Process: 61802 ExecStopPost=/usr/sbin/exportfs -f (code=exited, status=0/SUCCESS)</span><br><span class="line">  Process: 61799 ExecStopPost=/usr/sbin/exportfs -au (code=exited, status=0/SUCCESS)</span><br><span class="line">  Process: 61797 ExecStop=/usr/sbin/rpc.nfsd 0 (code=exited, status=0/SUCCESS)</span><br><span class="line"> Main PID: 60625 (code=exited, status=0/SUCCESS)</span><br><span class="line"></span><br><span class="line">5月 14 16:35:58 ct74 systemd[1]: Starting NFS server and services...</span><br><span class="line">5月 14 16:35:58 ct74 systemd[1]: Started NFS server and services.</span><br><span class="line">5月 14 18:21:09 ct74 systemd[1]: Stopping NFS server and services...</span><br><span class="line">5月 14 18:21:09 ct74 systemd[1]: Stopped NFS server and services.</span><br></pre></td></tr></table></figure><p>我在主被两台机器上查看debug日志，没有任何变动</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@ct75 ~]# cd /nfs</span><br><span class="line"></span><br><span class="line">#我在挂载了VIP的机器上查看共享目录能否使用，卡死终端</span><br></pre></td></tr></table></figure><p>总结下原因：heartbeat没有监控到nfs的服务状态，它自身想当然的认为，只有heartbeat服务出故障，才切VIP。</p><p>解决：我们将nfs，和heartbeat服务做一个捆绑，类似于事物性质。即nfs出问题，heartbeat也要宕掉。这里通过脚本实现。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[root@ct74 ~]# vim /opt/monitornfs.sh</span><br><span class="line"></span><br><span class="line">while true</span><br><span class="line">do</span><br><span class="line">    drbdstatus=`cat /proc/drbd 2&gt; /dev/null  | grep ro | tail -n1 | awk -F&apos;:&apos; &apos;&#123;print $4&#125;&apos; | awk -F&apos;/&apos; &apos;&#123;print $1&#125;&apos;`</span><br><span class="line">    nfsstatus=`systemctl status nfs&amp;&gt;/dev/null ; echo $?`</span><br><span class="line"></span><br><span class="line">    if [ -z  $drbdstatus ];then</span><br><span class="line">        sleep 10</span><br><span class="line">        continue</span><br><span class="line">    elif [ $drbdstatus == &apos;Primary&apos; ];then</span><br><span class="line">        if [ $nfsstatus -ne 0 ];then</span><br><span class="line">            systemctl start nfs &amp;&gt; /dev/null</span><br><span class="line">            newnfsstatus=`systemctl status nfs&amp;&gt;/dev/null ; echo $?`</span><br><span class="line">            if [ $newnfsstatus -ne 0 ];then</span><br><span class="line">            systemctl stop heartbeat</span><br><span class="line">            #尝试开启之后若还是不行,则关掉heartbeat</span><br><span class="line">            fi</span><br><span class="line">        fi</span><br><span class="line">    fi</span><br><span class="line">    sleep 5</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line">[root@ct74 ~]# chmod +x /opt/monitornfs.sh </span><br><span class="line">[root@ct74 ~]# nohup /opt/monitornfs.sh &amp;</span><br><span class="line">echo &quot;nohup /opt/monitornfs.sh &amp;&quot; &gt;&gt;/etc/rc.local</span><br><span class="line">#以上关于脚本操作，在ct75上重复</span><br></pre></td></tr></table></figure><ul><li>测试</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@ct74 ~]# systemctl stop nfs</span><br><span class="line">#主节点关掉nfs服务</span><br><span class="line"></span><br><span class="line">#但是后台的脚本又给他开启了</span><br><span class="line">[root@ct74 ~]# systemctl stop heartbeat</span><br><span class="line">#VIP切换到备机了</span><br></pre></td></tr></table></figure><p><strong>但是nfs客户端的使用并不影响，切换的时候会有轻微的延迟。</strong></p><h4 id="nfs切记要挂载到别的机器上不要为了省事，省机器"><a href="#nfs切记要挂载到别的机器上不要为了省事，省机器" class="headerlink" title="nfs切记要挂载到别的机器上不要为了省事，省机器"></a>nfs切记要挂载到别的机器上不要为了省事，省机器</h4>]]></content>
    
    <summary type="html">
    
      
      
        &lt;a id=&quot;more&quot;&gt;&lt;/a&gt;



&lt;h2 id=&quot;理论概述&quot;&gt;&lt;a href=&quot;#理论概述&quot; class=&quot;headerlink&quot; title=&quot;理论概述&quot;&gt;&lt;/a&gt;理论概述&lt;/h2&gt;&lt;p&gt;&lt;strong&gt;本案例只是，为搭建MySQL集群做准备，并无MySQL&lt;/stro
      
    
    </summary>
    
      <category term="Linux运维" scheme="http://aiwhs.github.io/categories/Linux%E8%BF%90%E7%BB%B4/"/>
    
    
      <category term="实验" scheme="http://aiwhs.github.io/tags/%E5%AE%9E%E9%AA%8C/"/>
    
  </entry>
  
  <entry>
    <title>keepalived</title>
    <link href="http://aiwhs.github.io/2019/03/02/keepalived%E9%AB%98%E5%8F%AF%E7%94%A8/"/>
    <id>http://aiwhs.github.io/2019/03/02/keepalived高可用/</id>
    <published>2019-03-02T00:15:57.000Z</published>
    <updated>2019-07-17T12:49:37.222Z</updated>
    
    <content type="html"><![CDATA[<a id="more"></a><h2 id="1-keepalived简介"><a href="#1-keepalived简介" class="headerlink" title="1. keepalived简介"></a>1. keepalived简介</h2><h3 id="1-1-keepalived是什么？"><a href="#1-1-keepalived是什么？" class="headerlink" title="1.1 keepalived是什么？"></a>1.1 keepalived是什么？</h3><p>Keepalived 软件起初是专为LVS负载均衡软件设计的，用来管理并监控LVS集群系统中各个服务节点的状态，后来又加入了可以实现高可用的VRRP功能。因此，Keepalived除了能够管理LVS软件外，还可以作为其他服务（例如：Nginx、Haproxy、MySQL等）的高可用解决方案软件。</p><p>Keepalived软件主要是通过VRRP协议实现高可用功能的。VRRP是Virtual Router RedundancyProtocol(虚拟路由器冗余协议）的缩写，VRRP出现的目的就是为了解决静态路由单点故障问题的，它能够保证当个别节点宕机时，整个网络可以不间断地运行。</p><p>所以，Keepalived 一方面具有配置管理LVS的功能，同时还具有对LVS下面节点进行健康检查的功能，另一方面也可实现系统网络服务的高可用功能。</p><p>keepalived<a href="http://www.keepalived.org/" target="_blank" rel="noopener">官网</a></p><h3 id="1-2-keepalived的重要功能"><a href="#1-2-keepalived的重要功能" class="headerlink" title="1.2 keepalived的重要功能"></a>1.2 keepalived的重要功能</h3><p>keepalived 有三个重要的功能，分别是：</p><ul><li>管理LVS负载均衡软件</li><li>实现LVS集群节点的健康检查</li><li>作为系统网络服务的高可用性（failover）</li></ul><h3 id="1-3-keepalived高可用故障转移的原理"><a href="#1-3-keepalived高可用故障转移的原理" class="headerlink" title="1.3 keepalived高可用故障转移的原理"></a>1.3 keepalived高可用故障转移的原理</h3><p>Keepalived 高可用服务之间的故障切换转移，是通过 VRRP (Virtual Router Redundancy Protocol ,虚拟路由器冗余协议）来实现的。</p><p>在 Keepalived 服务正常工作时，主 Master 节点会不断地向备节点发送（多播的方式）心跳消息，用以告诉备 Backup 节点自己还活看，当主 Master 节点发生故障时，就无法发送心跳消息，备节点也就因此无法继续检测到来自主 Master 节点的心跳了，于是调用自身的接管程序，接管主 Master 节点的 IP 资源及服务。而当主 Master 节点恢复时，备 Backup 节点又会释放主节点故障时自身接管的IP资源及服务，恢复到原来的备用角色。</p><p>那么，什么是VRRP呢？<br>VRRP ,全 称 Virtual Router Redundancy Protocol ,中文名为虚拟路由冗余协议 ，VRRP的出现就是为了解决静态踣甶的单点故障问题，VRRP是通过一种竞选机制来将路由的任务交给某台VRRP路由器的。</p><h3 id="1-4-keepalived原理"><a href="#1-4-keepalived原理" class="headerlink" title="1.4 keepalived原理"></a>1.4 keepalived原理</h3><h4 id="1-4-1-keepalived高可用架构图"><a href="#1-4-1-keepalived高可用架构图" class="headerlink" title="1.4.1 keepalived高可用架构图"></a>1.4.1 keepalived高可用架构图</h4><p><img src="../../img/keepalived_yuanli.png" alt="img"></p><h4 id="1-4-2-keepalived工作原理描述"><a href="#1-4-2-keepalived工作原理描述" class="headerlink" title="1.4.2 keepalived工作原理描述"></a>1.4.2 keepalived工作原理描述</h4><p>Keepalived高可用对之间是通过VRRP通信的，因此，我们从 VRRP开始了解起：<br>1) VRRP,全称 Virtual Router Redundancy Protocol,中文名为虚拟路由冗余协议，VRRP的出现是为了解决静态路由的单点故障。<br>2) VRRP是通过一种竟选协议机制来将路由任务交给某台 VRRP路由器的。<br>3) VRRP用 IP多播的方式（默认多播地址（224.0_0.18))实现高可用对之间通信。<br>4) 工作时主节点发包，备节点接包，当备节点接收不到主节点发的数据包的时候，就启动接管程序接管主节点的开源。备节点可以有多个，通过优先级竞选，但一般 Keepalived系统运维工作中都是一对。<br>5) VRRP使用了加密协议加密数据，但Keepalived官方目前还是推荐用明文的方式配置认证类型和密码。</p><p>介绍完 VRRP,接下来我再介绍一下 Keepalived服务的工作原理：</p><blockquote><p>Keepalived高可用是通过 VRRP 进行通信的， VRRP是通过竞选机制来确定主备的，主的优先级高于备，因此，工作时主会优先获得所有的资源，备节点处于等待状态，当主挂了的时候，备节点就会接管主节点的资源，然后顶替主节点对外提供服务。</p><p>在 Keepalived 服务之间，只有作为主的服务器会一直发送 VRRP 广播包,告诉备它还活着，此时备不会枪占主，当主不可用时，即备监听不到主发送的广播包时，就会启动相关服务接管资源，保证业务的连续性.接管速度最快可以小于1秒。</p></blockquote><h2 id="2-keepalived配置文件讲解"><a href="#2-keepalived配置文件讲解" class="headerlink" title="2. keepalived配置文件讲解"></a>2. keepalived配置文件讲解</h2><h3 id="2-1-keepalived默认配置文件"><a href="#2-1-keepalived默认配置文件" class="headerlink" title="2.1 keepalived默认配置文件"></a>2.1 keepalived默认配置文件</h3><p>keepalived 的主配置文件是 <code>/etc/keepalived/keepalived.conf</code>。其内容如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# cat /etc/keepalived/keepalived.conf</span><br><span class="line">! Configuration File for keepalived</span><br><span class="line"></span><br><span class="line">global_defs &#123;       //全局配置</span><br><span class="line">   notification_email &#123;     //定义报警收件人邮件地址</span><br><span class="line">     acassen@firewall.loc</span><br><span class="line">     failover@firewall.loc</span><br><span class="line">     sysadmin@firewall.loc</span><br><span class="line">   &#125;</span><br><span class="line">   notification_email_from Alexandre.Cassen@firewall.loc    //定义报警发件人邮箱</span><br><span class="line">   smtp_server 192.168.200.1    //邮箱服务器地址</span><br><span class="line">   smtp_connect_timeout 30      //定义邮箱超时时间</span><br><span class="line">   router_id LVS_DEVEL          //定义路由标识信息，同局域网内唯一</span><br><span class="line">   vrrp_skip_check_adv_addr</span><br><span class="line">   vrrp_strict</span><br><span class="line">   vrrp_garp_interval 0</span><br><span class="line">   vrrp_gna_interval 0</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;        //定义实例</span><br><span class="line">    state MASTER            //指定keepalived节点的初始状态，可选值为MASTER|BACKUP</span><br><span class="line">    interface eth0          //VRRP实例绑定的网卡接口，用户发送VRRP包</span><br><span class="line">    virtual_router_id 51    //虚拟路由的ID，同一集群要一致</span><br><span class="line">    priority 100            //定义优先级，按优先级来决定主备角色，优先级越大越优先</span><br><span class="line">    nopreempt               //设置不抢占</span><br><span class="line">    advert_int 1            //主备通讯时间间隔</span><br><span class="line">    authentication &#123;        //配置认证</span><br><span class="line">        auth_type PASS      //认证方式，此处为密码</span><br><span class="line">        auth_pass 1111      //同一集群中的keepalived配置里的此处必须一致，推荐使用8位随机数</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;     //配置要使用的VIP地址</span><br><span class="line">        192.168.200.16</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">virtual_server 10.10.10.2 1358 &#123;    //配置虚拟服务器</span><br><span class="line">    delay_loop 6        //健康检查的时间间隔</span><br><span class="line">    lb_algo rr          //lvs调度算法</span><br><span class="line">    lb_kind NAT         //lvs模式</span><br><span class="line">    persistence_timeout 50      //持久化超时时间，单位是秒</span><br><span class="line">    protocol TCP        //4层协议</span><br><span class="line"></span><br><span class="line">    sorry_server 192.168.200.200 1358   //定义备用服务器，当所有RS都故障时用sorry_server来响应客户端</span><br><span class="line"></span><br><span class="line">    real_server 192.168.200.2 1358 &#123;    //定义真实处理请求的服务器</span><br><span class="line">        weight 1    //给服务器指定权重，默认为1</span><br><span class="line">        HTTP_GET &#123;</span><br><span class="line">            url &#123;</span><br><span class="line">              path /testurl/test.jsp    //指定要检查的URL路径</span><br><span class="line">              digest 640205b7b0fc66c1ea91c463fac6334d   //摘要信息</span><br><span class="line">            &#125;</span><br><span class="line">            url &#123;</span><br><span class="line">              path /testurl2/test.jsp</span><br><span class="line">              digest 640205b7b0fc66c1ea91c463fac6334d</span><br><span class="line">            &#125;</span><br><span class="line">            url &#123;</span><br><span class="line">              path /testurl3/test.jsp</span><br><span class="line">              digest 640205b7b0fc66c1ea91c463fac6334d</span><br><span class="line">            &#125;</span><br><span class="line">            connect_timeout 3       //连接超时时间</span><br><span class="line">            nb_get_retry 3          //get尝试次数</span><br><span class="line">            delay_before_retry 3    //在尝试之前延迟多长时间</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    real_server 192.168.200.3 1358 &#123;</span><br><span class="line">        weight 1</span><br><span class="line">        HTTP_GET &#123;</span><br><span class="line">            url &#123;</span><br><span class="line">              path /testurl/test.jsp</span><br><span class="line">              digest 640205b7b0fc66c1ea91c463fac6334c</span><br><span class="line">            &#125;</span><br><span class="line">            url &#123;</span><br><span class="line">              path /testurl2/test.jsp</span><br><span class="line">              digest 640205b7b0fc66c1ea91c463fac6334c</span><br><span class="line">            &#125;</span><br><span class="line">            connect_timeout 3</span><br><span class="line">            nb_get_retry 3</span><br><span class="line">            delay_before_retry 3</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-2-定制主配置文件"><a href="#2-2-定制主配置文件" class="headerlink" title="2.2 定制主配置文件"></a>2.2 定制主配置文件</h3><p><strong>vrrp_instance段配置</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">nopreempt   //设置为不抢占。默认是抢占的，当高优先级的机器恢复后，会抢占低优先 \</span><br><span class="line">级的机器成为MASTER，而不抢占，则允许低优先级的机器继续成为MASTER，即使高优先级 \</span><br><span class="line">的机器已经上线。如果要使用这个功能，则初始化状态必须为BACKUP。</span><br><span class="line"></span><br><span class="line">preempt_delay   //设置抢占延迟。单位是秒，范围是0---1000，默认是0.发现低优先 \</span><br><span class="line">级的MASTER后多少秒开始抢占。</span><br></pre></td></tr></table></figure><p><strong>vrrp_script段配置</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">作用：添加一个周期性执行的脚本。脚本的退出状态码会被调用它的所有的VRRP Instance记录。</span><br><span class="line">注意：至少有一个VRRP实例调用它并且优先级不能为0.优先级范围是1-254.</span><br><span class="line">vrrp_script &lt;SCRIPT_NAME&gt; &#123;</span><br><span class="line">          ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">选项说明：</span><br><span class="line">script &quot;/path/to/somewhere&quot;      //指定要执行的脚本的路径。</span><br><span class="line">interval &lt;INTEGER&gt;              //指定脚本执行的间隔。单位是秒。默认为1s。</span><br><span class="line">timeout &lt;INTEGER&gt;               //指定在多少秒后，脚本被认为执行失败。</span><br><span class="line">weight &lt;-254 --- 254&gt;           //调整优先级。默认为2.</span><br><span class="line">rise &lt;INTEGER&gt;                  //执行成功多少次才认为是成功。</span><br><span class="line">fall &lt;INTEGER&gt;                  //执行失败多少次才认为失败。</span><br><span class="line">user &lt;USERNAME&gt; [GROUPNAME]     //运行脚本的用户和组。</span><br><span class="line">init_fail                       //假设脚本初始状态是失败状态。</span><br><span class="line"></span><br><span class="line">weight说明： </span><br><span class="line">1. 如果脚本执行成功(退出状态码为0)，weight大于0，则priority增加。</span><br><span class="line">2. 如果脚本执行失败(退出状态码为非0)，weight小于0，则priority减少。</span><br><span class="line">3. 其他情况下，priority不变。</span><br></pre></td></tr></table></figure><p><strong>real_server段配置</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">weight &lt;INT&gt;            //给服务器指定权重。默认是1</span><br><span class="line">inhibit_on_failure      //当服务器健康检查失败时，将其weight设置为0， \</span><br><span class="line">                        而不是从Virtual Server中移除</span><br><span class="line">notify_up &lt;STRING&gt;      //当服务器健康检查成功时，执行的脚本</span><br><span class="line">notify_down &lt;STRING&gt;    //当服务器健康检查失败时，执行的脚本</span><br><span class="line">uthreshold &lt;INT&gt;        //到这台服务器的最大连接数</span><br><span class="line">lthreshold &lt;INT&gt;        //到这台服务器的最小连接数</span><br></pre></td></tr></table></figure><p><strong>tcp_check段配置</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">connect_ip &lt;IP ADDRESS&gt;     //连接的IP地址。默认是real server的ip地址</span><br><span class="line">connect_port &lt;PORT&gt;         //连接的端口。默认是real server的端口</span><br><span class="line">bindto &lt;IP ADDRESS&gt;         //发起连接的接口的地址。</span><br><span class="line">bind_port &lt;PORT&gt;            //发起连接的源端口。</span><br><span class="line">connect_timeout &lt;INT&gt;       //连接超时时间。默认是5s。</span><br><span class="line">fwmark &lt;INTEGER&gt;            //使用fwmark对所有出去的检查数据包进行标记。</span><br><span class="line">warmup &lt;INT&gt;    //指定一个随机延迟，最大为N秒。可防止网络阻塞。如果为0，则关闭该功能。</span><br><span class="line">retry &lt;INIT&gt;                //重试次数。默认是1次。</span><br><span class="line">delay_before_retry &lt;INT&gt;    //默认是1秒。在重试之前延迟多少秒。</span><br></pre></td></tr></table></figure><h3 id="2-3-实例"><a href="#2-3-实例" class="headerlink" title="2.3 实例"></a>2.3 实例</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">global_defs &#123;</span><br><span class="line">    router_id LVS_Server</span><br><span class="line">&#125;</span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state BACKUP</span><br><span class="line">    interface ens33</span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    priority 150</span><br><span class="line">    nopreempt</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass itwhs</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;  </span><br><span class="line">        172.16.137.250 dev ens192</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">virtual_server 172.16.137.250 80 &#123;</span><br><span class="line">    delay_loop 3</span><br><span class="line">    lvs_sched rr</span><br><span class="line">    lvs_method DR</span><br><span class="line">    protocol TCP</span><br><span class="line">    real_server 172.16.137.11 80 &#123;</span><br><span class="line">        weight 1</span><br><span class="line">        TCP_CHECK &#123;</span><br><span class="line">            connect_port 80</span><br><span class="line">            connect_timeout 3</span><br><span class="line">            nb_get_retry 3</span><br><span class="line">            delay_before_retry 3</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    real_server 172.16.137.12 8080 &#123;</span><br><span class="line">        weight 1</span><br><span class="line">        TCP_CHECK &#123;</span><br><span class="line">            connect_port 8080</span><br><span class="line">            connect_timeout 3</span><br><span class="line">            nb_get_retry 3</span><br><span class="line">            delay_before_retry 3</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="3-脑裂"><a href="#3-脑裂" class="headerlink" title="3 脑裂"></a>3 脑裂</h2><p>在高可用（HA）系统中，当联系2个节点的“心跳线”断开时，本来为一整体、动作协调的HA系统，就分裂成为2个独立的个体。由于相互失去了联系，都以为是对方出了故障。两个节点上的HA软件像“裂脑人”一样，争抢“共享资源”、争起“应用服务”，就会发生严重后果——或者共享资源被瓜分、2边“服务”都起不来了；或者2边“服务”都起来了，但同时读写“共享存储”，导致数据损坏（常见如数据库轮询着的联机日志出错）。</p><p>对付HA系统“裂脑”的对策，目前达成共识的的大概有以下几条：</p><ul><li>添加冗余的心跳线，例如：双线条线（心跳线也HA），尽量减少“裂脑”发生几率；</li><li>启用磁盘锁。正在服务一方锁住共享磁盘，“裂脑”发生时，让对方完全“抢不走”共享磁盘资源。但使用锁磁盘也会有一个不小的问题，如果占用共享盘的一方不主动“解锁”，另一方就永远得不到共享磁盘。现实中假如服务节点突然死机或崩溃，就不可能执行解锁命令。后备节点也就接管不了共享资源和应用服务。于是有人在HA中设计了“智能”锁。即：正在服务的一方只在发现心跳线全部断开（察觉不到对端）时才启用磁盘锁。平时就不上锁了。</li><li>设置仲裁机制。例如设置参考IP（如网关IP），当心跳线完全断开时，2个节点都各自ping一下参考IP，不通则表明断点就出在本端。不仅“心跳”、还兼对外“服务”的本端网络链路断了，即使启动（或继续）应用服务也没有用了，那就主动放弃竞争，让能够ping通参考IP的一端去起服务。更保险一些，ping不通参考IP的一方干脆就自我重启，以彻底释放有可能还占用着的那些共享资源</li></ul><h3 id="3-1-脑裂产生的原因"><a href="#3-1-脑裂产生的原因" class="headerlink" title="3.1 脑裂产生的原因"></a>3.1 脑裂产生的原因</h3><p>一般来说，脑裂的发生，有以下几种原因：</p><ul><li>高可用服务器对之间心跳线链路发生故障，导致无法正常通信<ul><li>因心跳线坏了（包括断了，老化）</li><li>因网卡及相关驱动坏了，ip配置及冲突问题（网卡直连）</li><li>因心跳线间连接的设备故障（网卡及交换机）</li><li>因仲裁的机器出问题（采用仲裁的方案）</li></ul></li><li>高可用服务器上开启了 iptables防火墙阻挡了心跳消息传输</li><li>高可用服务器上心跳网卡地址等信息配置不正确，导致发送心跳失败</li><li>其他服务配置不当等原因，如心跳方式不同，心跳广插冲突、软件Bug等</li></ul><p><strong>注意：</strong></p><blockquote><p>Keepalived配置里同一 VRRP实例如果 virtual_router_id两端参数配置不一致也会导致裂脑问题发生。</p></blockquote><h3 id="3-2-脑裂的常见解决方案"><a href="#3-2-脑裂的常见解决方案" class="headerlink" title="3.2 脑裂的常见解决方案"></a>3.2 脑裂的常见解决方案</h3><p>在实际生产环境中，我们可以从以下几个方面来防止裂脑问题的发生：</p><ul><li><p>同时使用串行电缆和以太网电缆连接，同时用两条心跳线路，这样一条线路坏了，另一个还是好的，依然能传送心跳消息</p></li><li><p>当检测到裂脑时强行关闭一个心跳节点（这个功能需特殊设备支持，如Stonith、feyce）。相当于备节点接收不到心跳消患，通过单独的线路发送关机命令关闭主节点的电源</p></li><li><p>做好对裂脑的监控报警（如邮件及手机短信等或值班）.在问题发生时人为第一时间介入仲裁，降低损失。例如，百度的监控报警短倍就有上行和下行的区别。报警消息发送到管理员手机上，管理员可以通过手机回复对应数字或简单的字符串操作返回给服务器.让服务器根据指令自动处理相应故障，这样解决故障的时间更短.</p></li></ul><p>当然，在实施高可用方案时，要根据业务实际需求确定是否能容忍这样的损失。对于一般的网站常规业务.这个损失是可容忍的</p><h3 id="3-3-对脑裂进行监控"><a href="#3-3-对脑裂进行监控" class="headerlink" title="3.3 对脑裂进行监控"></a>3.3 对脑裂进行监控</h3><p>对脑裂的监控应在备用服务器上进行，通过添加zabbix自定义监控进行。<br>监控什么信息呢？监控备上有无VIP地址</p><p>备机上出现VIP有两种情况：</p><ul><li>发生了脑裂</li><li>正常的主备切换</li></ul><p>监控只是监控发生脑裂的可能性，不能保证一定是发生了脑裂，因为正常的主备切换VIP也是会到备上的。</p><p>监控脚本如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@slave ~]# mkdir -p /scripts &amp;&amp; cd /scripts</span><br><span class="line">[root@slave scripts]# vim check_keepalived.sh</span><br><span class="line">#!/bin/bash</span><br><span class="line"></span><br><span class="line">while true</span><br><span class="line">do</span><br><span class="line">if [ `ip a show ens33 |grep 172.16.137.250|wc -l` -ne 0 ]</span><br><span class="line">then</span><br><span class="line">    echo &quot;keepalived is error!&quot;</span><br><span class="line">else</span><br><span class="line">    echo &quot;keepalived is OK !&quot;</span><br><span class="line">fi</span><br><span class="line">done</span><br></pre></td></tr></table></figure><p>编写脚本时要注意，网卡要改成你自己的网卡名称，VIP也要改成你自己的VIP，最后不要忘了给脚本赋予执行权限，且要修改/scripts目录的属主属组为zabbix</p><h2 id="4-keepalived实现nginx负载均衡机高可用"><a href="#4-keepalived实现nginx负载均衡机高可用" class="headerlink" title="4. keepalived实现nginx负载均衡机高可用"></a>4. keepalived实现nginx负载均衡机高可用</h2><p><strong>环境说明</strong></p><table><thead><tr><th align="center">系统信息</th><th align="left">主机名</th><th align="left">IP</th></tr></thead><tbody><tr><td align="center">centos7.6</td><td align="left">master</td><td align="left">172.16.137.11</td></tr><tr><td align="center">centos7.6</td><td align="left">slave</td><td align="left">172.16.137.12</td></tr></tbody></table><p>本次高可用虚拟IP（VIP）地址暂定为 172.16.137.250</p><h3 id="4-1-keepalived安装"><a href="#4-1-keepalived安装" class="headerlink" title="4.1 keepalived安装"></a>4.1 keepalived安装</h3><p><strong>配置主keepalived</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">关闭防火墙与SELINUX</span><br><span class="line">[root@master ~]# systemctl stop firewalld</span><br><span class="line">[root@master ~]# systemctl disable firewalld</span><br><span class="line">Removed symlink /etc/systemd/system/multi-user.target.wants/firewalld.service.</span><br><span class="line">Removed symlink /etc/systemd/system/dbus-org.fedoraproject.FirewallD1.service.</span><br><span class="line">[root@master ~]# setenforce 0</span><br><span class="line">[root@master ~]# sed -ri &apos;s/^(SELINUX=).*/\1disabled/g&apos; /etc/selinux/config</span><br><span class="line"></span><br><span class="line">配置网络源</span><br><span class="line">[root@master ~]# curl -o /etc/yum.repos.d/CentOS7-Base-163.repo http://mirrors.163.com/.help/CentOS7-Base-163.repo</span><br><span class="line">[root@master ~]# sed -i &apos;s/\$releasever/7/g&apos; /etc/yum.repos.d/CentOS7-Base-163.repo</span><br><span class="line">[root@master ~]# sed -i &apos;s/^enabled=.*/enabled=1/g&apos; /etc/yum.repos.d/CentOS7-Base-163.repo</span><br><span class="line">[root@master ~]# yum -y install epel-release vim wget gcc gcc-c++</span><br><span class="line">安装过程略.....</span><br><span class="line"></span><br><span class="line">安装keepalived</span><br><span class="line">[root@master ~]# yum -y install keepalived</span><br><span class="line"></span><br><span class="line">查看安装生成的文件</span><br><span class="line">[root@master ~]# rpm -ql keepalived</span><br><span class="line">/etc/keepalived     //配置目录</span><br><span class="line">/etc/keepalived/keepalived.conf     //此为主配置文件</span><br><span class="line">/etc/sysconfig/keepalived</span><br><span class="line">/usr/bin/genhash</span><br><span class="line">/usr/lib/systemd/system/keepalived.service      //此为服务控制文件</span><br><span class="line">/usr/libexec/keepalived</span><br><span class="line">/usr/sbin/keepalived</span><br><span class="line">.....此处省略N行</span><br></pre></td></tr></table></figure><p><strong>用同样的方法在备服务器上安装keepalived</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">关闭防火墙与SELINUX</span><br><span class="line">[root@slave ~]# systemctl stop firewalld</span><br><span class="line">[root@slave ~]# systemctl disable firewalld</span><br><span class="line">Removed symlink /etc/systemd/system/multi-user.target.wants/firewalld.service.</span><br><span class="line">Removed symlink /etc/systemd/system/dbus-org.fedoraproject.FirewallD1.service.</span><br><span class="line">[root@slave ~]# setenforce 0</span><br><span class="line">[root@slave ~]# sed -ri &apos;s/^(SELINUX=).*/\1disabled/g&apos; /etc/selinux/config</span><br><span class="line"></span><br><span class="line">配置网络源</span><br><span class="line">[root@slave ~]# curl -o /etc/yum.repos.d/CentOS7-Base-163.repo http://mirrors.163.com/.help/CentOS7-Base-163.repo</span><br><span class="line">[root@slave ~]# sed -i &apos;s/\$releasever/7/g&apos; /etc/yum.repos.d/CentOS7-Base-163.repo</span><br><span class="line">[root@slave ~]# sed -i &apos;s/^enabled=.*/enabled=1/g&apos; /etc/yum.repos.d/CentOS7-Base-163.repo</span><br><span class="line">[root@slave ~]# yum -y install epel-release vim wget gcc gcc-c++</span><br><span class="line">安装过程略.....</span><br><span class="line"></span><br><span class="line">安装keepalived</span><br><span class="line">[root@slave ~]# yum -y install keepalived</span><br></pre></td></tr></table></figure><h3 id="4-2-在主备机上分别安装nginx"><a href="#4-2-在主备机上分别安装nginx" class="headerlink" title="4.2 在主备机上分别安装nginx"></a>4.2 在主备机上分别安装nginx</h3><p><strong>在master上安装nginx</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# yum -y install nginx</span><br><span class="line">[root@master ~]# cd /usr/share/nginx/html/</span><br><span class="line">[root@master html]# ls</span><br><span class="line">404.html  50x.html  index.html  nginx-logo.png  poweredby.png</span><br><span class="line">[root@master html]# mv index.html&#123;,.bak&#125;</span><br><span class="line">[root@master html]# echo &apos;master&apos; &gt; index.html</span><br><span class="line">[root@master html]# ls</span><br><span class="line">404.html  50x.html  index.html  index.html.bak  nginx-logo.png  poweredby.png</span><br><span class="line">[root@master html]# systemctl start nginx</span><br><span class="line">[root@master html]# systemctl enable nginx</span><br><span class="line">[root@master html]# ss -antl</span><br><span class="line">State       Recv-Q Send-Q Local Address:Port               Peer Address:Port</span><br><span class="line">LISTEN      0      128              *:80                           *:*</span><br><span class="line">LISTEN      0      128              *:22                           *:*</span><br><span class="line">LISTEN      0      100      127.0.0.1:25                           *:*</span><br><span class="line">LISTEN      0      128             :::80                          :::*</span><br><span class="line">LISTEN      0      128             :::22                          :::*</span><br><span class="line">LISTEN      0      100            ::1:25                          :::*</span><br></pre></td></tr></table></figure><p><strong>在slave上安装nginx</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@slave ~]# yum -y install nginx</span><br><span class="line">[root@slave ~]# cd /usr/share/nginx/html/</span><br><span class="line">[root@slave html]# ls</span><br><span class="line">404.html  50x.html  index.html  nginx-logo.png  poweredby.png</span><br><span class="line">[root@slave html]# mv index.html&#123;,.bak&#125;</span><br><span class="line">[root@slave html]# echo &apos;slave&apos; &gt; index.html</span><br><span class="line">[root@slave html]# ls</span><br><span class="line">404.html  50x.html  index.html  index.html.bak  nginx-logo.png  poweredby.png</span><br><span class="line">[root@slave html]# systemctl start nginx</span><br><span class="line">[root@slave html]# systemctl enable nginx</span><br></pre></td></tr></table></figure><p><strong>在浏览器上访问试试，确保master上的nginx服务能够正常访问</strong></p><h3 id="4-3-keepalived配置"><a href="#4-3-keepalived配置" class="headerlink" title="4.3 keepalived配置"></a>4.3 keepalived配置</h3><h4 id="4-3-1-配置主keepalived"><a href="#4-3-1-配置主keepalived" class="headerlink" title="4.3.1 配置主keepalived"></a>4.3.1 配置主keepalived</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# vim /etc/keepalived/keepalived.conf</span><br><span class="line">! Configuration File for keepalived</span><br><span class="line"></span><br><span class="line">global_defs &#123;</span><br><span class="line">   router_id lb01</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state MASTER</span><br><span class="line">    interface ens33</span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    priority 100</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass itwhs</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        172.16.137.250</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">virtual_server 172.16.137.250 80 &#123;</span><br><span class="line">    delay_loop 6</span><br><span class="line">    lb_algo rr</span><br><span class="line">    lb_kind DR</span><br><span class="line">    persistence_timeout 50</span><br><span class="line">    protocol TCP</span><br><span class="line"></span><br><span class="line">    real_server 172.16.137.11 80 &#123;</span><br><span class="line">        weight 1</span><br><span class="line">        TCP_CHECK &#123;</span><br><span class="line">            connect_port 80</span><br><span class="line">            connect_timeout 3</span><br><span class="line">            nb_get_retry 3</span><br><span class="line">            delay_before_retry 3</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    real_server 172.16.137.12 80 &#123;</span><br><span class="line">        weight 1</span><br><span class="line">        TCP_CHECK &#123;</span><br><span class="line">            connect_port 80</span><br><span class="line">            connect_timeout 3</span><br><span class="line">            nb_get_retry 3</span><br><span class="line">            delay_before_retry 3</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@master ~]# systemctl start keepalived</span><br><span class="line">[root@master ~]# systemctl enable keepalived</span><br></pre></td></tr></table></figure><h4 id="4-3-2-配置备keepalived"><a href="#4-3-2-配置备keepalived" class="headerlink" title="4.3.2 配置备keepalived"></a>4.3.2 配置备keepalived</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">[root@slave ~]# vim /etc/keepalived/keepalived.conf</span><br><span class="line">! Configuration File for keepalived</span><br><span class="line"></span><br><span class="line">global_defs &#123;</span><br><span class="line">   router_id lb02</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state BACKUP</span><br><span class="line">    interface eth0</span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    priority 90</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass itwhs</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        172.16.137.250</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">virtual_server 172.16.137.250 80 &#123;</span><br><span class="line">    delay_loop 6</span><br><span class="line">    lb_algo rr</span><br><span class="line">    lb_kind DR</span><br><span class="line">    persistence_timeout 50</span><br><span class="line">    protocol TCP</span><br><span class="line"></span><br><span class="line">    real_server 172.16.137.11 80 &#123;</span><br><span class="line">        weight 1</span><br><span class="line">        TCP_CHECK &#123;</span><br><span class="line">            connect_port 80</span><br><span class="line">            connect_timeout 3</span><br><span class="line">            nb_get_retry 3</span><br><span class="line">            delay_before_retry 3</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    real_server 172.16.137.12 80 &#123;</span><br><span class="line">        weight 1</span><br><span class="line">        TCP_CHECK &#123;</span><br><span class="line">            connect_port 80</span><br><span class="line">            connect_timeout 3</span><br><span class="line">            nb_get_retry 3</span><br><span class="line">            delay_before_retry 3</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@slave ~]# systemctl start keepalived</span><br><span class="line">[root@slave ~]# systemctl enable keepalived</span><br></pre></td></tr></table></figure><h4 id="4-3-3-查看VIP在哪里"><a href="#4-3-3-查看VIP在哪里" class="headerlink" title="4.3.3 查看VIP在哪里"></a>4.3.3 查看VIP在哪里</h4><p><strong>在MASTER上查看</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# ip a</span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN qlen 1</span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 ::1/128 scope host</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: ens192: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP qlen 1000</span><br><span class="line">    link/ether 00:0c:29:c0:ed:3b brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.16.137.11/24 brd 172.16.137.255 scope global ens192</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet 172.16.137.250/32 scope global ens192        //可以看到此处有VIP</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::20c:29ff:fec0:ed3b/64 scope link</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure><p><strong>在SLAVE上查看</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@slave ~]# ip a</span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN qlen 1</span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 ::1/128 scope host</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP qlen 1000</span><br><span class="line">    link/ether 00:0c:29:b5:38:80 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.16.137.12/24 brd 172.16.137.255 scope global dynamic eth0</span><br><span class="line">       valid_lft 1303sec preferred_lft 1303sec</span><br><span class="line">    inet6 fe80::20c:29ff:feb5:3880/64 scope link</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure><h3 id="4-4-修改内核参数，开启监听VIP功能"><a href="#4-4-修改内核参数，开启监听VIP功能" class="headerlink" title="4.4 修改内核参数，开启监听VIP功能"></a>4.4 修改内核参数，开启监听VIP功能</h3><p><strong>此步可做可不做，该功能可用于仅监听VIP的时候</strong>(有bug,好像已失效)</p><p><strong>在master上修改内核参数</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# echo &apos;net.ipv4.ip_nonlocal_bind = 1&apos; &gt;&gt;/etc/sysctl.conf</span><br><span class="line">[root@master ~]# sysctl -p</span><br><span class="line">net.ipv4.ip_nonlocal_bind = 1</span><br><span class="line">[root@master ~]# cat /proc/sys/net/ipv4/ip_nonlocal_bind</span><br><span class="line">1</span><br></pre></td></tr></table></figure><p><strong>在slave上修改内核参数</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@slave ~]# echo &apos;net.ipv4.ip_nonlocal_bind = 1&apos; &gt;&gt;/etc/sysctl.conf</span><br><span class="line">[root@slave ~]# sysctl -p</span><br><span class="line">net.ipv4.ip_nonlocal_bind = 1</span><br><span class="line">[root@slave ~]# cat /proc/sys/net/ipv4/ip_nonlocal_bind</span><br><span class="line">1</span><br></pre></td></tr></table></figure><h3 id="4-5-让keepalived监控nginx负载均衡机"><a href="#4-5-让keepalived监控nginx负载均衡机" class="headerlink" title="4.5 让keepalived监控nginx负载均衡机"></a>4.5 让keepalived监控nginx负载均衡机</h3><p>keepalived通过脚本来监控nginx负载均衡机的状态</p><p><strong>在master上编写脚本</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# mkdir /scripts</span><br><span class="line">[root@master ~]# cd /scripts/</span><br><span class="line">[root@master scripts]# vim check_n.sh</span><br><span class="line">#!/bin/bash</span><br><span class="line">nginx_status=$(ps -ef|grep -Ev &quot;grep|$0&quot;|grep &apos;\bnginx\b&apos;|wc -l)</span><br><span class="line">if [ $nginx_status -lt 1 ];then</span><br><span class="line">    systemctl stop keepalived</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">[root@master scripts]# chmod +x check_n.sh</span><br><span class="line">[root@master scripts]# ll</span><br><span class="line">total 4</span><br><span class="line">-rwxr-xr-x 1 root root 168 Oct 19 23:38 check_n.sh</span><br><span class="line"></span><br><span class="line">[root@master scripts]# vim notify.sh</span><br><span class="line">#!/bin/bash</span><br><span class="line">VIP=$2</span><br><span class="line">sendmail ()&#123;</span><br><span class="line">        subject=&quot;$&#123;VIP&#125;&apos;s server keepalived state is translate&quot;</span><br><span class="line">        content=&quot;`date +&apos;%F %T&apos;`: `hostname`&apos;s state change to master&quot;</span><br><span class="line">        echo $content | mail -s &quot;$subject&quot; 邮箱地址</span><br><span class="line">&#125;</span><br><span class="line">case &quot;$1&quot; in</span><br><span class="line">  master)</span><br><span class="line">        nginx_status=$(ps -ef|grep -Ev &quot;grep|$0&quot;|grep &apos;\bnginx\b&apos;|wc -l)</span><br><span class="line">        if [ $nginx_status -lt 1 ];then</span><br><span class="line">            systemctl start nginx</span><br><span class="line">        fi</span><br><span class="line">        sendmail</span><br><span class="line">  ;;</span><br><span class="line">  backup)</span><br><span class="line">        nginx_status=$(ps -ef|grep -Ev &quot;grep|$0&quot;|grep &apos;\bnginx\b&apos;|wc -l)</span><br><span class="line">        if [ $nginx_status -gt 0 ];then</span><br><span class="line">            systemctl stop nginx</span><br><span class="line">        fi</span><br><span class="line">  ;;</span><br><span class="line">  *)</span><br><span class="line">        echo &quot;Usage:$0 master|backup VIP&quot;</span><br><span class="line">  ;;</span><br><span class="line">esac</span><br><span class="line"></span><br><span class="line">[root@master scripts]# chmod +x notify.sh</span><br><span class="line">[root@master scripts]# ll</span><br><span class="line">total 8</span><br><span class="line">-rwxr-xr-x 1 root root 168 Oct 19 23:38 check_n.sh</span><br><span class="line">-rwxr-xr-x 1 root root 594 Oct 20 03:24 notify.sh</span><br></pre></td></tr></table></figure><p><strong>在slave上编写脚本</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">[root@slave ~]# mkdir /scripts</span><br><span class="line">[root@slave ~]# cd /scripts/</span><br><span class="line">[root@slave scripts]# vim notify.sh</span><br><span class="line">#!/bin/bash</span><br><span class="line">VIP=$2</span><br><span class="line">sendmail ()&#123;</span><br><span class="line">        subject=&quot;$&#123;VIP&#125;&apos;s server keepalived state is translate&quot;</span><br><span class="line">        content=&quot;`date +&apos;%F %T&apos;`: `hostname`&apos;s state change to master&quot;</span><br><span class="line">        echo $content | mail -s &quot;$subject&quot; 邮箱地址</span><br><span class="line">&#125;</span><br><span class="line">case &quot;$1&quot; in</span><br><span class="line">  master)</span><br><span class="line">        nginx_status=$(ps -ef|grep -Ev &quot;grep|$0&quot;|grep &apos;\bnginx\b&apos;|wc -l)</span><br><span class="line">        if [ $nginx_status -lt 1 ];then</span><br><span class="line">            systemctl start nginx</span><br><span class="line">        fi</span><br><span class="line">        sendmail</span><br><span class="line">  ;;</span><br><span class="line">  backup)</span><br><span class="line">        nginx_status=$(ps -ef|grep -Ev &quot;grep|$0&quot;|grep &apos;\bnginx\b&apos;|wc -l)</span><br><span class="line">        if [ $nginx_status -gt 0 ];then</span><br><span class="line">            systemctl stop nginx</span><br><span class="line">        fi</span><br><span class="line">  ;;</span><br><span class="line">  *)</span><br><span class="line">        echo &quot;Usage:$0 master|backup VIP&quot;</span><br><span class="line">  ;;</span><br><span class="line">esac</span><br><span class="line"></span><br><span class="line">[root@slave scripts]# chmod +x notify.sh</span><br><span class="line">[root@slave scripts]# ll</span><br><span class="line">total 8</span><br><span class="line">-rwxr-xr-x 1 root root 168 Oct 19 23:38 check_n.sh</span><br><span class="line">-rwxr-xr-x 1 root root 594 Oct 20 03:24 notify.sh</span><br></pre></td></tr></table></figure><p><strong>此处的脚本名称应避免与服务名相同，推荐用服务名的首字母代替，如check_n，不要给脚本起名check_nginx</strong></p><h3 id="4-6-配置keepalived加入监控脚本的配置"><a href="#4-6-配置keepalived加入监控脚本的配置" class="headerlink" title="4.6 配置keepalived加入监控脚本的配置"></a>4.6 配置keepalived加入监控脚本的配置</h3><p><strong>配置主keepalived</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# vim /etc/keepalived/keepalived.conf</span><br><span class="line">! Configuration File for keepalived</span><br><span class="line"></span><br><span class="line">global_defs &#123;</span><br><span class="line">   router_id lb01</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_script nginx_check &#123;</span><br><span class="line">    script &quot;/scripts/check_n.sh&quot;</span><br><span class="line">    interval 1</span><br><span class="line">    weight -20</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state MASTER</span><br><span class="line">    interface ens33</span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    priority 100</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass itwhs</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        172.16.137.250</span><br><span class="line">    &#125;</span><br><span class="line">    track_script &#123;</span><br><span class="line">        nginx_check</span><br><span class="line">    &#125;</span><br><span class="line">    notify_master &quot;/scripts/notify.sh master 172.16.137.250&quot;</span><br><span class="line">    notify_backup &quot;/scripts/notify.sh backup 172.16.137.250&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">virtual_server 172.16.137.250 80 &#123;</span><br><span class="line">    delay_loop 6</span><br><span class="line">    lb_algo rr</span><br><span class="line">    lb_kind DR</span><br><span class="line">    persistence_timeout 50</span><br><span class="line">    protocol TCP</span><br><span class="line"></span><br><span class="line">    real_server 172.16.137.11 80 &#123;</span><br><span class="line">        weight 1</span><br><span class="line">        TCP_CHECK &#123;</span><br><span class="line">            connect_port 80</span><br><span class="line">            connect_timeout 3</span><br><span class="line">            nb_get_retry 3</span><br><span class="line">            delay_before_retry 3</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    real_server 172.16.137.12 80 &#123;</span><br><span class="line">        weight 1</span><br><span class="line">        TCP_CHECK &#123;</span><br><span class="line">            connect_port 80</span><br><span class="line">            connect_timeout 3</span><br><span class="line">            nb_get_retry 3</span><br><span class="line">            delay_before_retry 3</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@master ~]# systemctl restart keepalived</span><br></pre></td></tr></table></figure><p><strong>配置备keepalived</strong></p><blockquote><p>backup无需检测nginx是否正常，当升级为MASTER时启动nginx，当降级为BACKUP时关闭</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">[root@slave ~]# vim /etc/keepalived/keepalived.conf</span><br><span class="line">! Configuration File for keepalived</span><br><span class="line"></span><br><span class="line">global_defs &#123;</span><br><span class="line">   router_id lb02</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state BACKUP</span><br><span class="line">    interface eth0</span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    priority 90</span><br><span class="line">    nopreempt</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass itwhs</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        172.16.137.250</span><br><span class="line">    &#125;</span><br><span class="line">    notify_master &quot;/scripts/notify.sh master 172.16.137.250&quot;</span><br><span class="line">    notify_backup &quot;/scripts/notify.sh backup 172.16.137.250&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">virtual_server 172.16.137.250 80 &#123;</span><br><span class="line">    delay_loop 6</span><br><span class="line">    lb_algo rr</span><br><span class="line">    lb_kind DR</span><br><span class="line">    persistence_timeout 50</span><br><span class="line">    protocol TCP</span><br><span class="line"></span><br><span class="line">    real_server 172.16.137.11 80 &#123;</span><br><span class="line">        weight 1</span><br><span class="line">        TCP_CHECK &#123;</span><br><span class="line">            connect_port 80</span><br><span class="line">            connect_timeout 3</span><br><span class="line">            nb_get_retry 3</span><br><span class="line">            delay_before_retry 3</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    real_server 172.16.137.12 80 &#123;</span><br><span class="line">        weight 1</span><br><span class="line">        TCP_CHECK &#123;</span><br><span class="line">            connect_port 80</span><br><span class="line">            connect_timeout 3</span><br><span class="line">            nb_get_retry 3</span><br><span class="line">            delay_before_retry 3</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@slave ~]# systemctl restart keepalived</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;a id=&quot;more&quot;&gt;&lt;/a&gt;



&lt;h2 id=&quot;1-keepalived简介&quot;&gt;&lt;a href=&quot;#1-keepalived简介&quot; class=&quot;headerlink&quot; title=&quot;1. keepalived简介&quot;&gt;&lt;/a&gt;1. keepalived简介&lt;/h2&gt;&lt;h
      
    
    </summary>
    
      <category term="Linux运维" scheme="http://aiwhs.github.io/categories/Linux%E8%BF%90%E7%BB%B4/"/>
    
    
      <category term="高可用" scheme="http://aiwhs.github.io/tags/%E9%AB%98%E5%8F%AF%E7%94%A8/"/>
    
  </entry>
  
  <entry>
    <title>LVS</title>
    <link href="http://aiwhs.github.io/2019/02/24/LVS%20%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E5%99%A8%E6%80%BB%E7%BB%93/"/>
    <id>http://aiwhs.github.io/2019/02/24/LVS 负载均衡器总结/</id>
    <published>2019-02-24T00:15:57.000Z</published>
    <updated>2019-07-17T12:42:04.321Z</updated>
    
    <content type="html"><![CDATA[<a id="more"></a><h2 id="负载均衡和高可用的简单介绍"><a href="#负载均衡和高可用的简单介绍" class="headerlink" title="负载均衡和高可用的简单介绍"></a>负载均衡和高可用的简单介绍</h2><h3 id="1-LB-LoadBalancer-负载均衡-或称为调度器"><a href="#1-LB-LoadBalancer-负载均衡-或称为调度器" class="headerlink" title="1.LB(LoadBalancer)负载均衡,或称为调度器"></a>1.LB(LoadBalancer)负载均衡,或称为调度器</h3><ul><li>硬件：<ul><li>F5 Big-IP </li><li>Citrix(思杰) Netscaler 最常用</li><li>A10</li><li>Array</li><li>Redware</li></ul></li><li>软件：<ul><li><strong>LVS(4层)</strong>：根据套接字来负载均衡。 套接字=IP + 端口 </li><li><strong>Nginx(7层) ：更适合http，smtp，pop3，imap的负载均衡</strong></li><li><strong>Haproxy(7层)</strong> :根据用户请求的内容来调度。<ul><li>它支持4层和7层的负载均衡，其更适合http，tcp(如：mysql，smtp)</li></ul></li><li>ats</li><li>perlbal</li></ul></li><li>LB集群主要以提高并发能力为根本<ul><li>LB的功能：<ul><li>监控主服务器的存活情况</li><li>故障切换时，完成挂载存储，启动服务，抢占VIP</li></ul></li></ul></li></ul><h3 id="2-HA-HighAvailability-高可用集群"><a href="#2-HA-HighAvailability-高可用集群" class="headerlink" title="2. HA(HighAvailability) 高可用集群"></a>2. HA(HighAvailability) 高可用集群</h3><p>在线时间/(在线时间 + 故障恢复时间)</p><p>RHCS,heartbeat,pacemaker,<strong>rose(windows),PowerHA(AIX)：目前这些使用都不多了。</strong></p><p><strong>主流是：Keepalived,目前官方也非常活跃,更新版本为2.x。</strong></p><p>高可用指标：99％, 99.9%, 99.99%, 99.999%</p><p>HA集群主要解决提高服务在线时间为根本</p><h3 id="3-HPC-High-Performance-Computing-高性能计算【HPC集群主要解决大任务计算的问题】"><a href="#3-HPC-High-Performance-Computing-高性能计算【HPC集群主要解决大任务计算的问题】" class="headerlink" title="3.HPC(High-Performance Computing):高性能计算【HPC集群主要解决大任务计算的问题】"></a>3.HPC(High-Performance Computing):高性能计算【HPC集群主要解决大任务计算的问题】</h3><ul><li>MapReduce</li><li>追踪任务完成的状态</li><li>Hadoop</li></ul><p><strong>LVS的工作原理:</strong></p><p>LVS的两大组件：</p><ul><li><p>用户空间： ipvsadm</p></li><li><p>内核空间： ipvs</p></li></ul><p>当用户请求被网卡收到，该请求将最先来到PREROUTING链，接着进入INPUT链，当请求进入INPUT链后，ipvs将监听<br>到这个连接请求，并将该连接请求重定向到自己，接着根据内部调度规则进行匹配，若没有匹配到则将该请求原封不动的转交给INPUT链，最终被INPUT链转发给监听在指定套接字(IP+Port)的应用程序。若匹配调度规则，则ipvs将修改该请求的相关地址(NAT模型：修改VIP–&gt;RIP; DR模型：修改目的MAC为RealSRV的MAC)后，重定向到POSTROUTING链上，最终转发到后端的Real Server上。</p><p>　　　　<img src="../../img/922925-20190524174631961-779300426.png" alt="img"></p><h3 id="LVS的四种工作模式介绍："><a href="#LVS的四种工作模式介绍：" class="headerlink" title="LVS的四种工作模式介绍："></a>LVS的四种工作模式介绍：</h3><ul><li><p>Virtual server via NAT（VS-NAT）</p><ul><li>优点：集群中的物理服务器可以使用任何支持TCP/IP操作系统，物理服务器可以分配Internet的保留私有地址，只有负载均衡器需要一个合法的IP地址。</li></ul></li><li><p>缺点：扩展性有限。当服务器节点（普通PC服务器）数据增长到20个或更多时,负载均衡器将成为整个系统的瓶颈，因为所有的请求包和应答包都需要经过负载均衡器。假使TCP包的平均长度是536字节的话，平均每个包重新构建,延迟时间大约为60us（在Pentium处理器上计算的，采用更快的处理器将使得这个延迟时间变短），负载均衡器的最大容许能力为8.93M/s，假定每台物理服务器的平台容许能力为400K/s来计算，负载均衡器能为22台物理服务器提供计算。</p></li></ul><p>解决办法：即使是是负载均衡器成为整个系统的瓶颈，如果是这样也有两种方法来解决它。一种是混合处理: 如果采用混合处理的方法，将需要许多同属单一的RR(DNS的资源记录) DNS域。另一种是采用Virtual Server via IP tunneling(即:Tunl模型)或Virtual Server via direct routing(即:DR模型) :若使用此方式可以获得更好的可扩展性；也可以嵌套使用负载均衡器，在最前端的是VS-Tunneling或<br>VS-DR的负载均衡器，然后后面采用VS-NAT的负载均衡器。</p><ul><li>Virtual server via IP tunneling（VS-TUN）</li></ul><p>我们发现，许多Internet服务（例如WEB服务器）的请求包很短小，而应答包通常很大。</p><pre><code>- 优点：负载均衡器只负责将请求包分发给物理服务器，而物理服务器将应答包直接发给用户。所以，负载均衡器能处理很巨大的请求量，这种方式，一台负载均衡能为超过100台的物理服务器服务，负载均衡器不再是系统的瓶颈。使用VS-TUN方式，如果你的负载均衡器拥有100M的全双工网卡的话，就能使得整个Virtual Server能达到1G的吞吐量。- 缺点：但是，这种方式需要所有的服务器支持&quot;IP Tunneling&quot;(IP Encapsulation)协议，我仅在Linux系统上实现了这个，目前其它操作系统的支持还在探索之中。</code></pre><ul><li><p>Virtual Server via Direct Routing（VS-DR）</p><ul><li>优点：和VS－TUN一样，负载均衡器也只是分发请求，应答包通过单独的路由方法返回给客户端。与VS-TUN相比，VS-DR这种实现方式不需要隧道结构，因此可以使用大多数操作系统做为物理服务器，其中包括：Linux、Solaris 、FreeBSD 、windows、IRIX 6.5；HPUX11等。</li><li>缺点：要求负载均衡器的网卡必须与物理网卡在一个物理段上。</li></ul></li><li><p>LVS-FullNAT</p></li></ul><p>通过同时修改请求报文的源IP地址和目标IP地址进行转发（CIP –&gt; DIP, VIP –&gt; RIP ）此模式在跨机房，跨多个不同网络时,FullNAT模式也可实现调度。因为此时实际是将IP包的源和目标都修改了,就好象调度器直接去访问远端RealServer,远端RealServer只需要按照自己本地路由,找到网关,将包回应给远端调度器，远端调度器再次将回应包，返回给用户。</p><p>(1) VIP是公网地址，RIP和DIP是私网地址，且通常不在同一IP网络；因此，RIP的网关一般不会指向DIP</p><p>(2) RS收到的请求报文源地址是DIP，因此，只需响应给DIP；但Director还要将其发往Client</p><p>(3) 请求和响应报文都经由Director</p><p>(4) 支持端口映射</p><p><strong>注意</strong>：此类型kernel默认不支持</p><p>此中使用场景较少,仅阿里云内部的SLB使用此种模式.</p><p><strong>对上面三种IP负载均衡技术的优缺点比较:</strong></p><table><thead><tr><th>杂项</th><th>VS/NAT</th><th>VS/TUN</th><th>VS/DR</th></tr></thead><tbody><tr><td>服务器操作系统</td><td>任意</td><td>支持隧道</td><td>多数(支持Non-arp )</td></tr><tr><td>服务器网络</td><td>私有网络</td><td>局域网/广域网</td><td>局域网</td></tr><tr><td>服务器数目(100M网络)</td><td>10-20</td><td>100</td><td>多(100)</td></tr><tr><td>服务器网关</td><td>负载均衡器</td><td>自己的路由</td><td>自己的路由</td></tr><tr><td>效率</td><td>一般</td><td>高</td><td>最高</td></tr></tbody></table><h4 id="LVS的调度算法介绍："><a href="#LVS的调度算法介绍：" class="headerlink" title="LVS的调度算法介绍："></a>LVS的调度算法介绍：</h4><h5 id="1-轮叫调度（Round-Robin）-简称rr"><a href="#1-轮叫调度（Round-Robin）-简称rr" class="headerlink" title="1.轮叫调度（Round Robin）(简称rr)"></a>1.轮叫调度（Round Robin）(简称rr)</h5><p>不考虑RealServer实际连接数,系统负载,只是轮流给每个RealServer分配请求.</p><h5 id="2-加权轮叫（Weighted-Round-Robin）（简称wrr"><a href="#2-加权轮叫（Weighted-Round-Robin）（简称wrr" class="headerlink" title="2.加权轮叫（Weighted Round Robin）（简称wrr)"></a>2.加权轮叫（Weighted Round Robin）（简称wrr)</h5><p>根据实际RealServer的主机配置,将主机配置强的RealServer更大的权重,让调度器分配更多请求给它处理,<br>同时调度器可自动询问RealServer的负载请求,并动态调整其权重值.</p><h5 id="3-最少链接（Least-Connections）-LC"><a href="#3-最少链接（Least-Connections）-LC" class="headerlink" title="3.最少链接（Least Connections）(LC) :"></a>3.最少链接（Least Connections）(LC) :</h5><p>将新的链接请求分配到当前链接数最小的服务器上.<br>调度器需要记录每个Server已经建立链接的数目,当调度器给A调度一个请求,则将A的总链接数+1,当链接中止/超时,则总链接-1。</p><p><strong>缺陷</strong>：</p><pre><code>- Server性能相同：可平滑分发负载，但不能将长链接的请求发向同一Server.-  Server性能不同：该算法并不理会。</code></pre><p>因为TCP连接处理请求后会进入TIME_WAIT状态,TCP的TIME_WAIT一般为2分钟,此时连接还占用服务器的资源,所以会出现这样情形,性能高的服务器已处理所收到的连接,连接处于TIME_WAIT状态,而性能低的服务器已经忙于处理所收到的连接,还不断地收到新的连接请求。</p><p>4.加权最少链接（Weighted Least Connections）(WLC)</p><p>在集群系统中的服务器性能差异较大的情况下，调度器采用“加权最少链接”调度算法优化负载均衡性能，具有较高权值的服务器将承受较大比例的活动连接负载。调度器可以自动问询真实服务器的负载情况，并动态地调整其权值。</p><h5 id="5-目标地址散列（Destination-Hashing）-DH"><a href="#5-目标地址散列（Destination-Hashing）-DH" class="headerlink" title="5.目标地址散列（Destination Hashing）(DH)"></a>5.目标地址散列（Destination Hashing）(DH)</h5><p>“目标地址散列”调度算法根据请求的目标IP地址，作为散列键（Hash Key）从静态分配的散列表找出对应的服务器，若该服务器是可用的且未超载，将请求发送到该服务器，否则返回空。</p><p><strong>补充</strong>：目标地址散列调度(Destination Hashing Scheduling)算法,是针对目标IP地址的负载均衡,它是一种静态映射算法,<br>通过一个散列函数将一个目标IP地址映射为一台服务器。目标地址散列算法会先根据请求的目标IP,计算散列哈希(hash key),从静态分配的散列表找出对应的服务器,<br>若该服务器是可用且未超载，则将请求发给该服务器，否则返回空,重新调度。</p><p><strong>哈希散列表可理解如下</strong>：</p><p>　　　　　　<img src="../../img/922925-20190524165257607-95485930.png" alt="img"></p><p>在此算法中,默认它使用256个哈希桶来将目标IP的哈希值前1个字节划分,平均分成256份，每一份就是一个范围,这样我只要计算出目标IP的哈希值,马上就能确定它应该在那个桶中,然后定位到该桶，这样在做小范围表扫描，速度就非常快。另外还需要注意：在此算法中它类似于一致性哈希算法，它会事先将所有可用服务器均匀循环分布到每个桶中，更简单理解就是本来就是一张有256条记录的大表,<br>该表中事先将所有可用服务器全部顺序循环插入到每一行记录中,然后将这张大表拆分成多个小表,并按前面的方法,将一个范围值作为进入该小表的条件，这样就可以最大限度均匀每一台服务器的负载。</p><h5 id="6-源地址散列（Source-Hashing）-SH"><a href="#6-源地址散列（Source-Hashing）-SH" class="headerlink" title="6.源地址散列（Source Hashing）(SH)"></a>6.源地址散列（Source Hashing）(SH)</h5><p>“源地址散列”调度算法根据请求的源IP地址，作为散列键（Hash Key）从静态分配的散列表找出对应的服务器,若该服务器是可用的且未超载，将请求发送到该服务器，否则返回空。</p><h5 id="7-基于局部性的最少链接（Locality-Based-Least-Connections）-LBLC"><a href="#7-基于局部性的最少链接（Locality-Based-Least-Connections）-LBLC" class="headerlink" title="7.基于局部性的最少链接（Locality-Based Least Connections）(LBLC)"></a>7.基于局部性的最少链接（Locality-Based Least Connections）(LBLC)</h5><p>“基于局部性的最少链接”调度算法是针对目标IP地址的负载均衡，目前主要用于Cache集群系统。该算法根据请求的目标IP地址找出该目标IP地址最近使用的服务器，若该服务器是可用的且没有超载，将请求发送到该服务器；若服务器不存在，或者该服务器超载且有服务器处于一半的工作负载，则用“最少链接” 的原则选出一个可用的服务器，将请求发送到该服务器。</p><h5 id="8-带复制的基于局部性最少链接（Locality-Based-Least-Connections-with-Replication）-LBLCR"><a href="#8-带复制的基于局部性最少链接（Locality-Based-Least-Connections-with-Replication）-LBLCR" class="headerlink" title="8.带复制的基于局部性最少链接（Locality-Based Least Connections with Replication）(LBLCR)"></a>8.带复制的基于局部性最少链接（Locality-Based Least Connections with Replication）(LBLCR)</h5><p>　　　　<img src="../../img/922925-20190524165433339-926454398.png" alt="img"></p><p> “带复制的基于局部性最少链接”调度算法也是针对目标IP地址的负载均衡，目前主要用于Cache集群系统。<br>它与LBLC算法的不同之处是它要维护从一个目标 IP地址到一组服务器的映射，而LBLC算法维护从一个目标IP地址到一台服务器的映射。该算法根据请求的目标IP地址找出该目标IP地址对应的服务器组，按“最小连接”原则从服务器组中选出一台服务器，若服务器没有超载，将请求发送到该服务器；</p><p>若所选服务器超载（超负载的标准是:该服务器正在处理的连接总数 &gt; 其权重值的2倍），则按“最小连接”原则从这个集群中选出一台服务器，将该服务器加入到服务器组中，将请求发送到该服务器。同时，当该所选服务器组有一段时间没有被修改过,则所选服务器加入新缓存复制组后,很可能导致复制流量大量增加，因此将最忙的服务器从服务器组中删除，以降低复制流量的程度。</p><h5 id="9-最短的期望的延迟（Shortest-Expected-Delay-Scheduling-SED）-SED"><a href="#9-最短的期望的延迟（Shortest-Expected-Delay-Scheduling-SED）-SED" class="headerlink" title="9.最短的期望的延迟（Shortest Expected Delay Scheduling SED）(SED)"></a>9.最短的期望的延迟（Shortest Expected Delay Scheduling SED）(SED)</h5><p>基于wlc算法。这个必须举例来说了</p><p>ABC三台机器分别权重1，2，3 ，连接数也分别是1，2，3。那么如果使用WLC算法的话一个新请求进入时<br>它可能会分给ABC中的任意一个，使用sed算法后会进行这样一个运算</p><ul><li><p>A：(1+1)/1 = 2</p></li><li><p>B：(1+2)/2 = 1.5</p></li><li><p>C：(1+3)/3 = 1.3334</p></li></ul><p>根据运算结果，把连接交给C，因为C的处理延时最小 。</p><h5 id="10-最少队列调度（Never-Queue-Scheduling-NQ）-NQ"><a href="#10-最少队列调度（Never-Queue-Scheduling-NQ）-NQ" class="headerlink" title="10.最少队列调度（Never Queue Scheduling NQ）(NQ)"></a>10.最少队列调度（Never Queue Scheduling NQ）(NQ)</h5><p>无需队列。如果有台 realserver的连接数＝0就直接分配过去，不需要在进行sed运算。</p><h4 id="下面对三种模式做示例配置说明"><a href="#下面对三种模式做示例配置说明" class="headerlink" title="下面对三种模式做示例配置说明:"></a>下面对三种模式做示例配置说明:</h4><h5 id="1-LVS-NAT模型："><a href="#1-LVS-NAT模型：" class="headerlink" title="1.LVS-NAT模型："></a>1.LVS-NAT模型：</h5><p>简单的来说，LVS的NAT模型如下图：</p><p>　</p><p><img src="../../img/mmexport1560403332206.jpg" alt="NAT"></p><p>　　</p><p>本质是多目标IP的DNAT，通过将请求报文中的目标地址和目标端口修改为通过调度算法挑出的RS的RIP和PORT实现转发。</p><p>LVS-NAT模型:</p><p>（1）RealServer和调度器应在同一个IP网络，且应使用私网地址；RealServer的网关要指向调度器的IP</p><p>（2）调度器(Director)是RealServer的网关, 因此请求和响应报文都将由调度器转发,因此调度器容易成为系统瓶颈.</p><p>（3）支持端口映射，可修改请求报文的目标PORT</p><p>（4）LVS必须是Linux系统，RS可以是任意OS系统</p><p>上面拓扑图的配置如下:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">Cip:192.168.161.226/24    GW:公网网关</span><br><span class="line">Vip:192.168.161.184/24    GW:公网网关</span><br><span class="line">Dip:192.168.153.136/24    GW:没设</span><br><span class="line">Rip1:192.168.153.137/24   GW:Dip</span><br><span class="line">Rip2:192.168.153.138/24   GW:Dip</span><br><span class="line">Director LVS:</span><br><span class="line">[root@director ~]# systemctl stop firewalld</span><br><span class="line">[root@director ~]# echo &quot;net.ipv4.ip_forward = 1&quot; &gt;&gt; /etc/sysctl.conf</span><br><span class="line">[root@director ~]# sysctl -p</span><br><span class="line">net.ipv4.ip_forward = 1</span><br><span class="line">[root@director ~]# yum install -y ipvsadm</span><br><span class="line">[root@director ~]# ipvsadm -A -t 192.168.161.184:80 -s wrr</span><br><span class="line">[root@director ~]# ipvsadm -a -t 192.168.161.184:80 -r 192.168.153.137:80 -m -w 5</span><br><span class="line">[root@director ~]# ipvsadm -a -t 192.168.161.184:80 -r 192.168.153.138:80 -m -w 4</span><br><span class="line">[root@director ~]# ipvsadm -a -t 192.168.161.184:80 -r 192.168.153.137:800 -m -w 3</span><br><span class="line">[root@director ~]# ipvsadm -a -t 192.168.161.184:80 -r 192.168.153.138:800 -m -w 2</span><br><span class="line">[root@director ~]# ipvsadm -a -t 192.168.161.184:80 -r 192.168.153.137:8080 -m</span><br><span class="line">[root@director ~]# ipvsadm -a -t 192.168.161.184:80 -r 192.168.153.138:8080 -m</span><br></pre></td></tr></table></figure><p>　　　　　　<img src="../../img/1560498709039.png" alt="1560498709039"></p><p>三台RealServer上只需配置IP把DIP设置成RS的网关,并安装nginx软件，然后启动即可.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">firewall-cmd --add-port=80/tcp --permanent; firewall-cmd --reload</span><br><span class="line">firewall-cmd --add-port=800/tcp --permanent; firewall-cmd --reload</span><br><span class="line">firewall-cmd --add-port=8080/tcp --permanent; firewall-cmd --reload</span><br></pre></td></tr></table></figure><p>在任意一台上查看nginx的日志:</p><p>　　　　<img src="../../img/1560502049280.png" alt="1560502049280"></p><p>可以看到CIP是ISP上的IP,即客户端的默认网关外网接口的IP.</p><p>验证:</p><p><img src="../../img/20190614_170030.gif" alt></p><h5 id="2-LVS-DR模型"><a href="#2-LVS-DR模型" class="headerlink" title="2.LVS-DR模型"></a>2.LVS-DR模型</h5><p>实验拓扑说明：这个拓扑中必须有一个独立的网关，因为用户请求发来时，GW将请求发给VIP，而VIP只有调度器会响应，GW将请求发给调度器，【注意：调度器的VIP,尽量使用32位掩码，这非必须】，在DR模式下，调度器上与GW连接的接口上有两个IP，一个是VIP(Virtual IP)，一个是DIP(Director IP)； 当调度器收到来自GW的包后,发现目标是VIP,并且访问的服务与自身定义的虚拟服务一样，接着调度器将数据包中的源MAC修改为自己的MAC，而目的MAC的修改是 根据调度算法，选择一台Real Server后，将该Real Server的MAC填写在目的MAC上，接着将包发给后端服务器，如此例为Real Server 1，RIP1收到后将解包发现其IP是本地loopback的接口IP，因此RIP1继续解包，最终将包送给上层服务，如本例是Web服务；Web开始进行响应，最终封包时，将源MAC写为自己，目的MAC写为GW，源IP写VIP，目的IP写Client IP，并发给GW出去响应。</p><p>（1）DIP, RIP 和 VIP : 可在同一网段，也可不在同一网段 ，但他们必须在同一个交换网络。</p><p>（2）Director(调度器)和RealServer他们的网关都必须指向真实网关(Firewall)，并且都要配置VIP.</p><p>（3）Director可以响应ARP查询VIP的MAC，但RealServer一律都不回应查询VIP的ARP请求.　　　</p><p><img src="../../img/lvs-dr.jpg" alt></p><p>以上拓扑图的配置如下:　　         </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">Cip:192.168.161.12/24    GW:公网网关(这里设的内网网关)</span><br><span class="line">Vip:192.168.161.184/24    GW:公网网关(这里设的内网网关)</span><br><span class="line">Dip:10.203.0.11/24    GW:内网网关</span><br><span class="line">Rip1:10.203.0.12/24   GW:内网网关   网页内容:137:80</span><br><span class="line">Rip2:10.203.0.12/24   GW:内网网关   网页内容:138:80</span><br><span class="line">此时,内网在同一网段,不用网关即可互通</span><br><span class="line">Director LVS:</span><br><span class="line">[root@director ~]# systemctl stop firewalld</span><br><span class="line">[root@director ~]# echo &quot;net.ipv4.ip_forward = 1&quot; &gt;&gt; /etc/sysctl.conf</span><br><span class="line">[root@director ~]# sysctl -p</span><br><span class="line">net.ipv4.ip_forward = 1</span><br><span class="line">[root@director ~]# nmtui设置ens32自动获取ip ,并添加一个子接口192168.161.184</span><br><span class="line">[root@director ~]# ip a show ens32</span><br><span class="line">2: ens32: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000</span><br><span class="line">    link/ether 00:0c:29:68:ea:96 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 10.203.0.11/21 brd 10.203.7.255 scope global noprefixroute dynamic ens32</span><br><span class="line">       valid_lft 5898sec preferred_lft 5898sec</span><br><span class="line">    inet 192.168.161.184/24 brd 192.168.161.255 scope global noprefixroute ens32</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::20c:29ff:fe68:ea96/64 scope link </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">[root@director ~]# route -n</span><br><span class="line">Kernel IP routing table</span><br><span class="line">Destination     Gateway         Genmask         Flags Metric Ref    Use Iface</span><br><span class="line">0.0.0.0         10.203.7.254    0.0.0.0         UG    100    0        0 ens32</span><br><span class="line">10.203.0.0      0.0.0.0         255.255.248.0   U     100    0        0 ens32</span><br><span class="line">192.168.161.0   0.0.0.0         255.255.255.0   U     100    0        0 ens32</span><br><span class="line">[root@director ~]# yum install -y ipvsadm</span><br><span class="line">[root@director ~]# ipvsadm -A -t 192.168.161.184:80 -s wrr</span><br><span class="line">[root@director ~]# ipvsadm -a -t 192.168.161.184:80 -r 10.203.0.12:80 -g -w 3</span><br><span class="line">[root@director ~]# ipvsadm -a -t 192.168.161.184:80 -r 10.203.0.13:80 -g -w 2</span><br><span class="line">[root@director ~]# ipvsadm -ln</span><br><span class="line">IP Virtual Server version 1.2.1 (size=4096)</span><br><span class="line">Prot LocalAddress:Port Scheduler Flags</span><br><span class="line">  -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn</span><br><span class="line">TCP  192.168.161.184:80 wrr</span><br><span class="line">  -&gt; 10.203.0.12:80               Route   3      90         0         </span><br><span class="line">  -&gt; 10.203.0.13:80               Route   2      60         0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">RSs(都做这个操作):</span><br><span class="line">[root@realserver1 ~]# echo &quot;net.ipv4.conf.all.arp_ignore = 1&quot; &gt;&gt; /etc/sysctl.conf</span><br><span class="line">[root@realserver1 ~]# echo &quot;net.ipv4.conf.all.arp_announce = 2&quot; &gt;&gt; /etc/sysctl.conf</span><br><span class="line">[root@realserver1 ~]# echo &quot;net.ipv4.conf.lo.arp_ignore = 1&quot; &gt;&gt; /etc/sysctl.conf </span><br><span class="line">[root@realserver1 ~]# echo &quot;net.ipv4.conf.lo.arp_announce = 2&quot; &gt;&gt; /etc/sysctl.conf</span><br><span class="line">[root@realserver1 ~]# sysctl -p</span><br><span class="line">net.ipv4.conf.all.arp_ignore = 1</span><br><span class="line">net.ipv4.conf.all.arp_announce = 2</span><br><span class="line">net.ipv4.conf.lo.arp_ignore = 1</span><br><span class="line">net.ipv4.conf.lo.arp_announce = 2</span><br><span class="line">[root@realserver1 ~]# firewall-cmd --add-port=80/tcp --permanent; firewall-cmd --reload</span><br><span class="line">[root@realserver1 ~]# nmtui设置ens32自动获取ip ,并添加一个子接口192168.161.184</span><br><span class="line">[root@realserver1 ~]# ip a show ens32</span><br><span class="line">2: ens32: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000</span><br><span class="line">    link/ether 00:0c:29:60:75:ab brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 10.203.0.12/21 brd 10.203.7.255 scope global noprefixroute dynamic ens32</span><br><span class="line">       valid_lft 7002sec preferred_lft 7002sec</span><br><span class="line">    inet 192.168.161.184/24 brd 192.168.161.255 scope global noprefixroute ens32</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::20c:29ff:fe60:75ab/64 scope link </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">[root@realserver1 ~]# route -n</span><br><span class="line">Kernel IP routing table</span><br><span class="line">Destination     Gateway         Genmask         Flags Metric Ref    Use Iface</span><br><span class="line">0.0.0.0         10.203.7.254    0.0.0.0         UG    100    0        0 ens32</span><br><span class="line">10.203.0.0      0.0.0.0         255.255.248.0   U     100    0        0 ens32</span><br><span class="line">192.168.161.0   0.0.0.0         255.255.255.0   U     100    0        0 ens32</span><br><span class="line">然后配置nginx,测试验证</span><br></pre></td></tr></table></figure><p><img src="../../img/1560676691848.png" alt="1560676691848"></p><h5 id="3-LVS-Tunnel模式"><a href="#3-LVS-Tunnel模式" class="headerlink" title="3.LVS Tunnel模式"></a>3.LVS Tunnel模式</h5><p>拓扑：</p><p>　　　　　　<img src="../../img/922925-20190524172334043-1110633750.png" alt="img"></p><p>LVS Tunnel模式配置要点：</p><p>(1) LVS调度节点、RealServer节点、VIP都必须是公网IP</p><p>(2) LVS调度节点、RealServer节点都必须配置VIP</p><p>(3) 调度节点 与 RS间必须打通一条隧道</p><p>(4) 客户端请求发往调度节点，调度节点通过隧道将请求报文封装起来发给RS,<br>RS在隧道另一端去掉GRE封装,发现是去往VIP的,随即转给tunl0处理,最终Tunl0<br>将响应报文从RS的默认路由发出。</p><p>(5) 调度节点要在所有设备上启用 只接收网关发送的ICMP的重定向报文。</p><p>(6) 调度节点 和 RS上都必须关闭路由转发(ip_forward), RS上关闭ARP响应和返回路径过滤<br>(即:源是A口,要从B口出,B口不丢该包).</p><p>LVS Tunnel环境搭建</p><p>(1) 路由器模拟:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">echo 1 &gt; /proc/sys/net/ipv4/ip_forward</span><br><span class="line"></span><br><span class="line">ifconfig eth0 20.0.0.254/24 up</span><br><span class="line"></span><br><span class="line">ifconfig eth1 30.0.0.254/24 up</span><br><span class="line"></span><br><span class="line">ifconfig eth2 40.0.0.254/24 up</span><br><span class="line"></span><br><span class="line">ifconfig eth3 192.168.10.254/24 up</span><br><span class="line"></span><br><span class="line">iptables -t nat -A POSTROUTING -s 192.168.10.0/24 ! -d 192.168.10.0/24 -j SNAT --to 192.168.10.254</span><br></pre></td></tr></table></figure><p>(2) LVS调度节点</p><p>关闭路由转发（默认是关闭.）</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo 0 &gt; /proc/sys/net/ipv4/ip_forward</span><br></pre></td></tr></table></figure><p>在所有接口、默认接口、eth0上都打开 仅接收来自网关的ICMP重定向.</p><p>注：默认应该是打开的,从抓包和分析上看,ICMP重定向是必须,因为客户端访问的调度器的子接口,</p><p>而调度器的主接口IP是20.0.0.1,子(次)接口IP20.0.0.2,网关通过ARP发现,客户端访问的VIP20.0.0.2</p><p>是在调度器接口上，因此,将去往20.0.0.2的请求重定向给调度器。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">echo 1 &gt; /proc/sys/net/ipv4/conf/all/send_redirects</span><br><span class="line"></span><br><span class="line">echo 1 &gt; /proc/sys/net/ipv4/conf/default/send_redirects</span><br><span class="line"></span><br><span class="line">echo 1 &gt; /proc/sys/net/ipv4/conf/eth0/send_redirects</span><br></pre></td></tr></table></figure><p>先关闭所有接口,用到那个激活那个。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">service network stop</span><br><span class="line"></span><br><span class="line">ifconfig eth0 20.0.0.1/24 up</span><br><span class="line"></span><br><span class="line">ifconfig eth0:0 20.0.0.2 broadcast 20.0.0.2 netmask 255.255.255.255 up</span><br><span class="line"></span><br><span class="line">ip tunnel add tun1 mode gre remote 30.0.0.1 local 20.0.0.1</span><br><span class="line"></span><br><span class="line">ifconfig tun1 10.0.0.1/30 up</span><br><span class="line"></span><br><span class="line">ip tunnel add tun2 mode gre remote 40.0.0.1 local 20.0.0.1</span><br><span class="line"></span><br><span class="line">ifconfig tun2 10.0.0.5/30 up</span><br></pre></td></tr></table></figure><p>#注：</p><p>GRE(通用路由封装) ： <a href="https://blog.csdn.net/taozpwater/article/details/9774123" target="_blank" rel="noopener">https://blog.csdn.net/taozpwater/article/details/9774123</a></p><p>简单理解: GRE就是在将原始IP包,再次封装在GRE内部, 接着在再次将GRE包封装到新IP包中,然后在加入如链路层帧头,最后发出去.其实GRE,VxLAN,NVGRE,IPSec都可认为是一种VPN.</p><p>MAC帧[IP头[GRE头【IP头[TCP头[应用协议数据]]】]]</p><p>注意：</p><p>GRE封装后,若后端是调度器,则该调度器将永远只能看到一个IP来访问自己,因此要注意使用调度算法.</p><p>添加默认路由</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">route add default gw 20.0.0.254</span><br></pre></td></tr></table></figure><p>添加主机路由,以便Linux收到去往20.0.0.2的报文后,知道转到那个接口上。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">route add -host 20.0.0.2 dev eth0:0</span><br><span class="line"></span><br><span class="line">yum install ipvsadm</span><br><span class="line"></span><br><span class="line">ipvsadm -A -t 20.0.0.2:80 -s rr</span><br><span class="line"></span><br><span class="line">ipvsadm -a -t 20.0.0.2:80 -r 10.0.0.2 -i</span><br></pre></td></tr></table></figure><p>注意:这里必须使用tunnel模式,即“-i”</p><p>ipvsadm -a -t 20.0.0.2:80 -r 10.0.0.6 -i</p><p>(2) RealServer1的配置:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ifconfig eth0 30.0.0.1/24 up</span><br><span class="line"></span><br><span class="line">ifconfig tunl0 20.0.0.2 broadcast 20.0.0.2 netmask 255.255.255.255 up</span><br></pre></td></tr></table></figure><p>注意：一定要添加一条主机路由,否则Linux的tun0接口收到GRE封包后,</p><p>解开发现是一个去往20.0.0.2的IP报文,查本机转发表若没有找到,就可能丢弃该报文.</p><p>那么客户端可能就打不开网页了。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">route add -host 20.0.0.2 dev tunl0</span><br><span class="line"></span><br><span class="line">ip tunnel add tun0 mode gre remote 20.0.0.1 local 30.0.0.1</span><br><span class="line"></span><br><span class="line">ifconfig tun0 10.0.0.2/30 up</span><br></pre></td></tr></table></figure><p>关闭路由转发</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo 0 &gt; /proc/sys/net/ipv4/ip_forward</span><br></pre></td></tr></table></figure><p>#arp_ignore: 定义接收到ARP请求时的响应级别；</p><p>#　　 0：只要本地配置的有相应地址，就给予响应；</p><p>#　　 1：仅响应目的IP配置在此接口上的ARP广播请求</p><p>#arp_announce: 定义将自己的地址向外通告时的通告级别(此行为仅发生在网络设备刚接入网络时)</p><p>#　　 0：将本地任何接口上的任何地址向外通告；</p><p># 　　 1：试图仅向目标网络通告与其网络匹配的地址；</p><p># 　　 2：仅向与本地接口上地址匹配的网络进行通告；</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">echo 1 &gt; /proc/sys/net/ipv4/conf/tunl0/arp_ignore</span><br><span class="line"></span><br><span class="line">echo 2 &gt; /proc/sys/net/ipv4/conf/tunl0/arp_announce</span><br><span class="line"></span><br><span class="line">echo 1 &gt; /proc/sys/net/ipv4/conf/all/arp_ignore</span><br><span class="line"></span><br><span class="line">echo 2 &gt; /proc/sys/net/ipv4/conf/all/arp_announce</span><br></pre></td></tr></table></figure><p>关闭tunl0、eth0上返回路径过滤</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">echo 0 &gt; /proc/sys/net/ipv4/conf/tunl0/rp_filter</span><br><span class="line"></span><br><span class="line">echo 0 &gt; /proc/sys/net/ipv4/conf/eth0/rp_filter</span><br><span class="line"></span><br><span class="line">echo 0 &gt; /proc/sys/net/ipv4/conf/all/rp_filter</span><br></pre></td></tr></table></figure><p>(2) RealServer2的配置:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ifconfig eth0 40.0.0.1/24 up</span><br><span class="line"></span><br><span class="line">ifconfig tunl0 20.0.0.2 broadcast 20.0.0.2 netmask 255.255.255.255 up</span><br></pre></td></tr></table></figure><p>注意：一定要添加一条主机路由,否则Linux的tun0接口收到GRE封包后,</p><p>解开发现是一个去往20.0.0.2的IP报文,查本机转发表若没有找到,就可能丢弃该报文.</p><p>那么客户端可能就打不开网页了。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">route add -host 20.0.0.2 dev tunl0</span><br><span class="line"></span><br><span class="line">ip tunnel add tun0 mode gre remote 20.0.0.1 local 40.0.0.1</span><br><span class="line"></span><br><span class="line">ifconfig tun0 10.0.0.6/30 up</span><br></pre></td></tr></table></figure><p>关闭路由转发</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">echo 0 &gt; /proc/sys/net/ipv4/ip_forward</span><br><span class="line"></span><br><span class="line">echo 1 &gt; /proc/sys/net/ipv4/conf/tunl0/arp_ignore</span><br><span class="line"></span><br><span class="line">echo 2 &gt; /proc/sys/net/ipv4/conf/tunl0/arp_announce</span><br><span class="line"></span><br><span class="line">echo 1 &gt; /proc/sys/net/ipv4/conf/all/arp_ignore</span><br><span class="line"></span><br><span class="line">echo 2 &gt; /proc/sys/net/ipv4/conf/all/arp_announce</span><br></pre></td></tr></table></figure><p>关闭tunl0、eth0上返回路径过滤</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">echo 0 &gt; /proc/sys/net/ipv4/conf/tunl0/rp_filter</span><br><span class="line"></span><br><span class="line">echo 0 &gt; /proc/sys/net/ipv4/conf/eth0/rp_filter</span><br><span class="line"></span><br><span class="line">echo 0 &gt; /proc/sys/net/ipv4/conf/all/rp_filter</span><br></pre></td></tr></table></figure><p>LVS调度器收到来客户端的访问报文：</p><p>先重定向</p><p>　　　　　　<img src="../../img/922925-20190524173007227-440916154.png" alt="img2"></p><p>调度后发送的报文，注意每个IP报文内部的内容,在该IP报文看来都仅仅是数据而已。</p><p>　　　　　　<img src="../../img/922925-20190524173042011-2018947801.png" alt="img3"></p><p>RealServer2收到GRE报文解封装后，将该报文发给tun0接口后：</p><p>　　　　　　<img src="../../img/922925-20190524173113024-1143857962.png" alt="img4"></p><p>RealServer2的tun0接口去掉IP层后，发现还是IP报文,随机转发给tunl0接口:</p><p>　　　　　　<img src="../../img/922925-20190524173158304-1642108484.png" alt="img5"></p><p>回应</p><p>　　　　　　<img src="../../img/922925-20190524173226213-1195581363.png" alt="img6"></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;a id=&quot;more&quot;&gt;&lt;/a&gt;



&lt;h2 id=&quot;负载均衡和高可用的简单介绍&quot;&gt;&lt;a href=&quot;#负载均衡和高可用的简单介绍&quot; class=&quot;headerlink&quot; title=&quot;负载均衡和高可用的简单介绍&quot;&gt;&lt;/a&gt;负载均衡和高可用的简单介绍&lt;/h2&gt;&lt;h3 id=&quot;
      
    
    </summary>
    
      <category term="Linux运维" scheme="http://aiwhs.github.io/categories/Linux%E8%BF%90%E7%BB%B4/"/>
    
    
      <category term="负载均衡" scheme="http://aiwhs.github.io/tags/%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/"/>
    
  </entry>
  
  <entry>
    <title>Kvm</title>
    <link href="http://aiwhs.github.io/2019/02/23/kvm%E8%99%9A%E6%8B%9F%E5%8C%96/"/>
    <id>http://aiwhs.github.io/2019/02/23/kvm虚拟化/</id>
    <published>2019-02-23T00:15:57.000Z</published>
    <updated>2019-07-17T12:18:21.307Z</updated>
    
    <content type="html"><![CDATA[<a id="more"></a><h2 id="1-虚拟化介绍"><a href="#1-虚拟化介绍" class="headerlink" title="1. 虚拟化介绍"></a>1. 虚拟化介绍</h2><p>虚拟化是云计算的基础。简单的说，虚拟化使得在一台物理的服务器上可以跑多台虚拟机，虚拟机共享物理机的 CPU、内存、IO 硬件资源，但逻辑上虚拟机之间是相互隔离的。</p><p>物理机我们一般称为宿主机（Host），宿主机上面的虚拟机称为客户机（Guest）。</p><p>那么 Host 是如何将自己的硬件资源虚拟化，并提供给 Guest 使用的呢？<br>这个主要是通过一个叫做 Hypervisor 的程序实现的。</p><p>根据 Hypervisor 的实现方式和所处的位置，虚拟化又分为两种：</p><ul><li>全虚拟化</li><li>半虚拟化</li></ul><p><strong>全虚拟化：</strong><br>Hypervisor 直接安装在物理机上，多个虚拟机在 Hypervisor 上运行。Hypervisor 实现方式一般是一个特殊定制的 Linux 系统。Xen 和 VMWare 的 ESXi 都属于这个类型</p><p><img src="../../img/full_virtual.png" alt="img"></p><p><strong>半虚拟化：</strong><br>物理机上首先安装常规的操作系统，比如 Redhat、Ubuntu 和 Windows。Hypervisor 作为 OS 上的一个程序模块运行，并对管理虚拟机进行管理。KVM、VirtualBox 和 VMWare Workstation 都属于这个类型</p><p><img src="../../img/half_virtual.png" alt="img"></p><p><strong>理论上讲：</strong><br>全虚拟化一般对硬件虚拟化功能进行了特别优化，性能上比半虚拟化要高；<br>半虚拟化因为基于普通的操作系统，会比较灵活，比如支持虚拟机嵌套。嵌套意味着可以在KVM虚拟机中再运行KVM。</p><h2 id="2-kvm介绍"><a href="#2-kvm介绍" class="headerlink" title="2. kvm介绍"></a>2. kvm介绍</h2><p>kVM 全称是 Kernel-Based Virtual Machine。也就是说 KVM 是基于 Linux 内核实现的。<br>KVM有一个内核模块叫 kvm.ko，只用于管理虚拟 CPU 和内存。</p><p>那 IO 的虚拟化，比如存储和网络设备则是由 Linux 内核与Qemu来实现。</p><p>作为一个 Hypervisor，KVM 本身只关注虚拟机调度和内存管理这两个方面。IO 外设的任务交给 Linux 内核和 Qemu。</p><p>大家在网上看 KVM 相关文章的时候肯定经常会看到 Libvirt 这个东西。</p><p>Libvirt 就是 KVM 的管理工具。</p><p>其实，Libvirt 除了能管理 KVM 这种 Hypervisor，还能管理 Xen，VirtualBox 等。</p><p>Libvirt 包含 3 个东西：后台 daemon 程序 libvirtd、API 库和命令行工具 virsh</p><ul><li>libvirtd是服务程序，接收和处理 API 请求；</li><li>API 库使得其他人可以开发基于 Libvirt 的高级工具，比如 virt-manager，这是个图形化的 KVM 管理工具；</li><li>virsh 是我们经常要用的 KVM 命令行工具</li></ul><h2 id="3-kvm部署"><a href="#3-kvm部署" class="headerlink" title="3. kvm部署"></a>3. kvm部署</h2><p><strong>环境说明：</strong></p><table><thead><tr><th align="left">系统类型</th><th align="left">IP</th></tr></thead><tbody><tr><td align="left">centos7.6</td><td align="left">172.16.137.12</td></tr></tbody></table><h3 id="3-1-kvm安装"><a href="#3-1-kvm安装" class="headerlink" title="3.1 kvm安装"></a>3.1 kvm安装</h3><p>部署前请确保你的CPU虚拟化功能已开启。分为两种情况：</p><ul><li>虚拟机要关机设置CPU虚拟化</li><li>物理机要在BIOS里开启CPU虚拟化</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line">关闭防火墙与SELINUX</span><br><span class="line">[root@kvm ~]# systemctl stop firewalld</span><br><span class="line">[root@kvm ~]# systemctl disable firewalld</span><br><span class="line">Removed symlink /etc/systemd/system/multi-user.target.wants/firewalld.service.</span><br><span class="line">Removed symlink /etc/systemd/system/dbus-org.fedoraproject.FirewallD1.service.</span><br><span class="line">[root@kvm ~]# setenforce 0</span><br><span class="line">[root@kvm ~]# sed -ri &apos;s/^(SELINUX=).*/\1disabled/g&apos; /etc/selinux/config</span><br><span class="line">[root@localhost ~]# reboot</span><br><span class="line"></span><br><span class="line">配置网络源</span><br><span class="line">[root@kvm yum.repos.d]# curl -o /etc/yum.repos.d/CentOS7-Base-163.repo http://mirrors.163.com/.help/CentOS7-Base-163.repo</span><br><span class="line">[root@kvm ~]# sed -i &apos;s/\$releasever/7/g&apos; /etc/yum.repos.d/CentOS7-Base-163.repo</span><br><span class="line">[root@kvm ~]# sed -i &apos;s/^enabled=.*/enabled=1/g&apos; /etc/yum.repos.d/CentOS7-Base-163.repo</span><br><span class="line">[root@kvm ~]# yum -y install epel-release vim wget net-tools unzip zip gcc gcc-c++</span><br><span class="line">安装过程略.....</span><br><span class="line"></span><br><span class="line">验证CPU是否支持KVM；如果结果中有vmx（Intel）或svm(AMD)字样，就说明CPU的支持的</span><br><span class="line">[root@kvm ~]# egrep -o &apos;vmx|svm&apos; /proc/cpuinfo</span><br><span class="line">vmx</span><br><span class="line">vmx</span><br><span class="line">vmx</span><br><span class="line">vmx</span><br><span class="line"></span><br><span class="line">kvm安装</span><br><span class="line">[root@kvm ~]# yum -y install qemu-kvm qemu-kvm-tools qemu-img virt-manager libvirt libvirt-python libvirt-client virt-install virt-viewer bridge-utils libguestfs-tools</span><br><span class="line">安装过程略......</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">因为虚拟机中网络，我们一般都是和公司的其他服务器是同一个网段，所以我们需要把 \</span><br><span class="line">KVM服务器的网卡配置成桥接模式。这样的话KVM的虚拟机就可以通过该桥接网卡和公司内部 \</span><br><span class="line">其他服务器处于同一网段</span><br><span class="line">此处我的网卡是ens33，所以用br0来桥接ens33网卡</span><br><span class="line">[root@kvm ~]# cd /etc/sysconfig/network-scripts/</span><br><span class="line">[root@kvm network-scripts]# ls</span><br><span class="line">ifcfg-ens33  ifdown-isdn      ifup          ifup-plip      ifup-tunnel</span><br><span class="line">ifcfg-lo     ifdown-post      ifup-aliases  ifup-plusb     </span><br><span class="line">.....此处内容省略</span><br><span class="line">[root@kvm network-scripts]# cp ifcfg-ens33 ifcfg-br0</span><br><span class="line">[root@kvm network-scripts]# cat ifcfg-br0</span><br><span class="line">TYPE=Bridge</span><br><span class="line">DEVICE=br0</span><br><span class="line">NM_CONTROLLED=no</span><br><span class="line">BOOTPROTO=static</span><br><span class="line">NAME=br0</span><br><span class="line">ONBOOT=yes</span><br><span class="line">IPADDR=192.168.160.109</span><br><span class="line">NETMASK=255.255.255.0</span><br><span class="line">GATEWAY=192.168.160.1</span><br><span class="line">DNS1=114.114.114.114</span><br><span class="line">DNS2=8.8.8.8</span><br><span class="line">[root@kvm network-scripts]# cat ifcfg-ens33</span><br><span class="line">TYPE=Ethernet</span><br><span class="line">BOOTPROTO=static</span><br><span class="line">NAME=ens33</span><br><span class="line">DEVICE=ens33</span><br><span class="line">ONBOOT=yes</span><br><span class="line">BRIDGE=br0</span><br><span class="line">NM_CONTROLLED=no</span><br><span class="line"></span><br><span class="line">重启网络</span><br><span class="line">[root@kvm ~]# systemctl restart network</span><br><span class="line">[root@kvm ~]# ip a</span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN qlen 1</span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 ::1/128 scope host</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: ens33: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast master br0 state UP qlen 1000</span><br><span class="line">    link/ether 00:0c:29:4c:50:b4 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">3: virbr0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN qlen 1000</span><br><span class="line">    link/ether 52:54:00:60:a8:ea brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 192.168.122.1/24 brd 192.168.122.255 scope global virbr0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">4: virbr0-nic: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc pfifo_fast master virbr0 state DOWN qlen 1000</span><br><span class="line">    link/ether 52:54:00:60:a8:ea brd ff:ff:ff:ff:ff:ff</span><br><span class="line">5: br0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP qlen 1000</span><br><span class="line">    link/ether 72:63:57:0a:ca:76 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 192.168.160.109/24 brd 192.168.160.255 scope global br0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::7063:57ff:fe0a:ca76/64 scope link</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">       </span><br><span class="line"></span><br><span class="line">启动服务</span><br><span class="line">[root@kvm ~]# systemctl start libvirtd</span><br><span class="line">[root@kvm ~]# systemctl enable libvirtd</span><br><span class="line"></span><br><span class="line">验证安装结果</span><br><span class="line">[root@kvm ~]# lsmod|grep kvm</span><br><span class="line">kvm_intel             170086  0</span><br><span class="line">kvm                   566340  1 kvm_intel</span><br><span class="line">irqbypass              13503  1 kvm</span><br><span class="line"></span><br><span class="line">测试并验证安装结果</span><br><span class="line">[root@kvm ~]# virsh -c qemu:///system list</span><br><span class="line"> Id    Name                           State</span><br><span class="line">----------------------------------------------------</span><br><span class="line">[root@kvm ~]# virsh --version</span><br><span class="line">3.9.0</span><br><span class="line">[root@kvm ~]# virt-install --version</span><br><span class="line">1.4.3</span><br><span class="line">[root@kvm ~]# ln -s /usr/libexec/qemu-kvm /usr/bin/qemu-kvm</span><br><span class="line">[root@kvm ~]# ll /usr/bin/qemu-kvm</span><br><span class="line">lrwxrwxrwx 1 root root 21 Oct 18 10:57 /usr/bin/qemu-kvm -&gt; /usr/libexec/qemu-kvm</span><br><span class="line">[root@kvm ~]# lsmod |grep kvm</span><br><span class="line">kvm_intel             170086  0</span><br><span class="line">kvm                   566340  1 kvm_intel</span><br><span class="line">irqbypass              13503  1 kvm</span><br><span class="line"></span><br><span class="line">查看网桥信息</span><br><span class="line">[root@kvm ~]# brctl show</span><br><span class="line">bridge name     bridge id               STP enabled     interfaces</span><br><span class="line">br0             8000.000c294c50b4       no              ens33</span><br><span class="line">virbr0          8000.52540060a8ea       yes             virbr0-nic</span><br></pre></td></tr></table></figure><h3 id="3-2-kvm-web管理界面安装"><a href="#3-2-kvm-web管理界面安装" class="headerlink" title="3.2 kvm web管理界面安装"></a>3.2 kvm web管理界面安装</h3><p>kvm 的 web 管理界面是由 webvirtmgr 程序提供的。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br></pre></td><td class="code"><pre><span class="line">安装依赖包</span><br><span class="line">[root@kvm ~]# yum -y install git python-pip libvirt-python libxml2-python python-websockify supervisor nginx python-devel</span><br><span class="line"></span><br><span class="line">升级pip</span><br><span class="line">[root@kvm ~]# pip install --upgrade pip</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">从github上下载webvirtmgr代码</span><br><span class="line">[root@kvm ~]# cd /usr/local/src/</span><br><span class="line">[root@kvm src]# git clone git://github.com/retspen/webvirtmgr.git</span><br><span class="line">Cloning into &apos;webvirtmgr&apos;...</span><br><span class="line">remote: Enumerating objects: 5730, done.</span><br><span class="line">remote: Total 5730 (delta 0), reused 0 (delta 0), pack-reused 5730</span><br><span class="line">Receiving objects: 100% (5730/5730), 3.01 MiB | 39.00 KiB/s, done.</span><br><span class="line">Resolving deltas: 100% (3688/3688), done.</span><br><span class="line"></span><br><span class="line">安装webvirtmgr</span><br><span class="line">[root@kvm src]# cd webvirtmgr/</span><br><span class="line">[root@kvm webvirtmgr]# pip install -r requirements.txt</span><br><span class="line">Collecting django==1.5.5 (from -r requirements.txt (line 1))</span><br><span class="line">  Downloading https://files.pythonhosted.org/packages/38/49/93511c5d3367b6b21fc2995a0e53399721afc15e4cd6eb57be879ae13ad4/Django-1.5.5.tar.gz (8.1MB)</span><br><span class="line">    57% |██████████████████▌             | 4.7MB 38kB/s eta 0:01:28 </span><br><span class="line">.....此处省略安装步骤</span><br><span class="line"></span><br><span class="line">检查sqlite3是否安装</span><br><span class="line">[root@kvm webvirtmgr]# python</span><br><span class="line">Python 2.7.5 (default, May  3 2017, 07:55:04)</span><br><span class="line">[GCC 4.8.5 20150623 (Red Hat 4.8.5-14)] on linux2</span><br><span class="line">Type &quot;help&quot;, &quot;copyright&quot;, &quot;credits&quot; or &quot;license&quot; for more information.</span><br><span class="line">&gt;&gt;&gt; import sqlite3</span><br><span class="line">&gt;&gt;&gt; exit()</span><br><span class="line"></span><br><span class="line">初始化帐号信息</span><br><span class="line">[root@kvm webvirtmgr]# python manage.py syncdb</span><br><span class="line">WARNING:root:No local_settings file found.</span><br><span class="line">Creating tables ...</span><br><span class="line">Creating table auth_permission</span><br><span class="line">Creating table auth_group_permissions</span><br><span class="line">Creating table auth_group</span><br><span class="line">Creating table auth_user_groups</span><br><span class="line">Creating table auth_user_user_permissions</span><br><span class="line">Creating table auth_user</span><br><span class="line">Creating table django_content_type</span><br><span class="line">Creating table django_session</span><br><span class="line">Creating table django_site</span><br><span class="line">Creating table servers_compute</span><br><span class="line">Creating table instance_instance</span><br><span class="line">Creating table create_flavor</span><br><span class="line"></span><br><span class="line">You just installed Django&apos;s auth system, which means you don&apos;t have any superusers defined.</span><br><span class="line">Would you like to create one now? (yes/no): yes     //问你是否创建超级管理员帐号</span><br><span class="line">Username (leave blank to use &apos;root&apos;):   //指定超级管理员帐号用户名，默认留空为root</span><br><span class="line">Email address: sean1002@126.com     //设置超级管理员邮箱</span><br><span class="line">Password:       //设置超级管理员密码</span><br><span class="line">Password (again):       //再次输入超级管理员密码</span><br><span class="line">Superuser created successfully.</span><br><span class="line">Installing custom SQL ...</span><br><span class="line">Installing indexes ...</span><br><span class="line">Installed 6 object(s) from 1 fixture(s)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">拷贝web网页至指定目录</span><br><span class="line">[root@kvm webvirtmgr]# mkdir /var/www</span><br><span class="line">[root@kvm webvirtmgr]# cp -r /usr/local/src/webvirtmgr /var/www/</span><br><span class="line">[root@kvm webvirtmgr]# chown -R nginx.nginx /var/www/webvirtmgr/</span><br><span class="line"></span><br><span class="line">生成密钥</span><br><span class="line">[root@kvm ~]# ssh-keygen -t rsa</span><br><span class="line">Generating public/private rsa key pair.</span><br><span class="line">Enter file in which to save the key (/root/.ssh/id_rsa):</span><br><span class="line">Created directory &apos;/root/.ssh&apos;.</span><br><span class="line">Enter passphrase (empty for no passphrase):</span><br><span class="line">Enter same passphrase again:</span><br><span class="line">Your identification has been saved in /root/.ssh/id_rsa.</span><br><span class="line">Your public key has been saved in /root/.ssh/id_rsa.pub.</span><br><span class="line">The key fingerprint is:</span><br><span class="line">SHA256:CQoZtso2M5Uo39lKvjZboncqakQ69iJt5wnjiJKZNhw root@kvm</span><br><span class="line">The key&apos;s randomart image is:</span><br><span class="line">+---[RSA 2048]----+</span><br><span class="line">|  o              |</span><br><span class="line">| ..+.            |</span><br><span class="line">|..+o  .          |</span><br><span class="line">|o+.o + . .       |</span><br><span class="line">|+*. = . S        |</span><br><span class="line">|+E+o .           |</span><br><span class="line">|+*= + .          |</span><br><span class="line">|BO+===.          |</span><br><span class="line">|Oo=**=           |</span><br><span class="line">+----[SHA256]-----+</span><br><span class="line">由于这里webvirtmgr和kvm服务部署在同一台机器，所以这里本地信任。如果kvm部署在其他机器，那么这个是它的ip</span><br><span class="line">[root@kvm ~]# ssh-copy-id 192.168.160.109</span><br><span class="line">/usr/bin/ssh-copy-id: INFO: Source of key(s) to be installed: &quot;/root/.ssh/id_rsa.pub&quot;</span><br><span class="line">The authenticity of host &apos;192.168.160.109 (192.168.160.109)&apos; can&apos;t be established.</span><br><span class="line">ECDSA key fingerprint is SHA256:UszC1ZeHM7xw/uefVkJoXW6XgRw+Jl51tAXLjFERclE.</span><br><span class="line">ECDSA key fingerprint is MD5:b3:f1:02:b8:01:8e:53:a7:87:09:c0:75:24:4c:ad:88.</span><br><span class="line">Are you sure you want to continue connecting (yes/no)? yes</span><br><span class="line">/usr/bin/ssh-copy-id: INFO: attempting to log in with the new key(s), to filter out any that are already installed</span><br><span class="line">/usr/bin/ssh-copy-id: INFO: 1 key(s) remain to be installed -- if you are prompted now it is to install the new keys</span><br><span class="line">root@192.168.160.109&apos;s password:</span><br><span class="line"></span><br><span class="line">Number of key(s) added: 1</span><br><span class="line"></span><br><span class="line">Now try logging into the machine, with:   &quot;ssh &apos;192.168.160.109&apos;&quot;</span><br><span class="line">and check to make sure that only the key(s) you wanted were added.</span><br><span class="line">配置端口转发</span><br><span class="line">[root@kvm ~]# ssh 192.168.160.109 -L localhost:8000:localhost:8000 -L localhost:6080:localhost:60</span><br><span class="line">Last login: Thu Oct 18 08:26:40 2018 from 192.168.160.36</span><br><span class="line">[root@kvm ~]# ss -antl</span><br><span class="line">State       Recv-Q Send-Q Local Address:Port               Peer Address:Port</span><br><span class="line">LISTEN      0      128              *:111                          *:*</span><br><span class="line">LISTEN      0      5      192.168.122.1:53                           *:*</span><br><span class="line">LISTEN      0      128              *:22                           *:*</span><br><span class="line">LISTEN      0      100      127.0.0.1:25                           *:*</span><br><span class="line">LISTEN      0      128      127.0.0.1:6080                         *:*</span><br><span class="line">LISTEN      0      128      127.0.0.1:8000                         *:*</span><br><span class="line">LISTEN      0      128             :::111                         :::*</span><br><span class="line">LISTEN      0      128             :::22                          :::*</span><br><span class="line">LISTEN      0      100            ::1:25                          :::*</span><br><span class="line">LISTEN      0      128            ::1:6080                        :::*</span><br><span class="line">LISTEN      0      128            ::1:8000                        :::* </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">配置nginx</span><br><span class="line">[root@kvm ~]# vim /etc/nginx/nginx.conf</span><br><span class="line">user nginx;</span><br><span class="line">worker_processes auto;</span><br><span class="line">error_log /var/log/nginx/error.log;</span><br><span class="line">pid /run/nginx.pid;</span><br><span class="line"></span><br><span class="line">include /usr/share/nginx/modules/*.conf;</span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections 1024;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    log_format  main  &apos;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &apos;</span><br><span class="line">                      &apos;$status $body_bytes_sent &quot;$http_referer&quot; &apos;</span><br><span class="line">                      &apos;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&apos;;</span><br><span class="line"></span><br><span class="line">    access_log  /var/log/nginx/access.log  main;</span><br><span class="line"></span><br><span class="line">    sendfile            on;</span><br><span class="line">    tcp_nopush          on;</span><br><span class="line">    tcp_nodelay         on;</span><br><span class="line">    keepalive_timeout   65;</span><br><span class="line">    types_hash_max_size 2048;</span><br><span class="line"></span><br><span class="line">    include             /etc/nginx/mime.types;</span><br><span class="line">    default_type        application/octet-stream;</span><br><span class="line"></span><br><span class="line">    include /etc/nginx/conf.d/*.conf;</span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line">        listen       80;</span><br><span class="line">        server_name  localhost;</span><br><span class="line"></span><br><span class="line">        include /etc/nginx/default.d/*.conf;</span><br><span class="line"></span><br><span class="line">        location / &#123;</span><br><span class="line">            root html;</span><br><span class="line">            index index.html index.htm;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        error_page 404 /404.html;</span><br><span class="line">            location = /40x.html &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        error_page 500 502 503 504 /50x.html;</span><br><span class="line">            location = /50x.html &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@kvm ~]# vim /etc/nginx/conf.d/webvirtmgr.conf</span><br><span class="line">server &#123;</span><br><span class="line">    listen 80 default_server;</span><br><span class="line"></span><br><span class="line">    server_name $hostname;</span><br><span class="line">    #access_log /var/log/nginx/webvirtmgr_access_log;</span><br><span class="line"></span><br><span class="line">    location /static/ &#123;</span><br><span class="line">        root /var/www/webvirtmgr/webvirtmgr;</span><br><span class="line">        expires max;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        proxy_pass http://127.0.0.1:8000;</span><br><span class="line">        proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">        proxy_set_header X-Forwarded-for $proxy_add_x_forwarded_for;</span><br><span class="line">        proxy_set_header Host $host:$server_port;</span><br><span class="line">        proxy_set_header X-Forwarded-Proto $remote_addr;</span><br><span class="line">        proxy_connect_timeout 600;</span><br><span class="line">        proxy_read_timeout 600;</span><br><span class="line">        proxy_send_timeout 600;</span><br><span class="line">        client_max_body_size 1024M;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">确保bind绑定的是本机的8000端口</span><br><span class="line">[root@kvm ~]# vim /var/www/webvirtmgr/conf/gunicorn.conf.py</span><br><span class="line">.....此处省略N行</span><br><span class="line">bind = &apos;0.0.0.0:8000&apos;     //确保此处绑定的是本机的8000端口，这个在nginx配置中定义了，被代理的端口</span><br><span class="line">backlog = 2048</span><br><span class="line">.....此处省略N行</span><br><span class="line"></span><br><span class="line">重启nginx</span><br><span class="line">[root@kvm ~]# systemctl restart nginx</span><br><span class="line">[root@kvm ~]# ss -antl</span><br><span class="line">State       Recv-Q Send-Q Local Address:Port               Peer Address:Port</span><br><span class="line">LISTEN      0      128              *:111                          *:*</span><br><span class="line">LISTEN      0      128              *:80                           *:*</span><br><span class="line">LISTEN      0      5      192.168.122.1:53                           *:*</span><br><span class="line">LISTEN      0      128              *:22                           *:*</span><br><span class="line">LISTEN      0      100      127.0.0.1:25                           *:*</span><br><span class="line">LISTEN      0      128      127.0.0.1:6080                         *:*</span><br><span class="line">LISTEN      0      128      127.0.0.1:8000                         *:*</span><br><span class="line">LISTEN      0      128             :::111                         :::*</span><br><span class="line">LISTEN      0      128             :::22                          :::*</span><br><span class="line">LISTEN      0      100            ::1:25                          :::*</span><br><span class="line">LISTEN      0      128            ::1:6080                        :::*</span><br><span class="line">LISTEN      0      128            ::1:8000                        :::*</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">设置supervisor</span><br><span class="line">[root@kvm ~]# vim /etc/supervisord.conf</span><br><span class="line">.....此处省略上面的内容，在文件最后加上以下内容</span><br><span class="line">[program:webvirtmgr]</span><br><span class="line">command=/usr/bin/python2 /var/www/webvirtmgr/manage.py run_gunicorn -c /var/www/webvirtmgr/conf/gunicorn.conf.py</span><br><span class="line">directory=/var/www/webvirtmgr</span><br><span class="line">autostart=true</span><br><span class="line">autorestart=true</span><br><span class="line">logfile=/var/log/supervisor/webvirtmgr.log</span><br><span class="line">log_stderr=true</span><br><span class="line">user=nginx</span><br><span class="line"></span><br><span class="line">[program:webvirtmgr-console]</span><br><span class="line">command=/usr/bin/python2 /var/www/webvirtmgr/console/webvirtmgr-console</span><br><span class="line">directory=/var/www/webvirtmgr</span><br><span class="line">autostart=true</span><br><span class="line">autorestart=true</span><br><span class="line">stdout_logfile=/var/log/supervisor/webvirtmgr-console.log</span><br><span class="line">redirect_stderr=true</span><br><span class="line">user=nginx</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">启动supervisor并设置开机自启</span><br><span class="line">[root@kvm ~]# systemctl start supervisord</span><br><span class="line">[root@kvm ~]# systemctl enable supervisord</span><br><span class="line">Created symlink from /etc/systemd/system/multi-user.target.wants/supervisord.service to /usr/lib/systemd/system/supervisord.service.</span><br><span class="line">[root@kvm ~]# systemctl status supervisord</span><br><span class="line">● supervisord.service - Process Monitoring and Control Daemon</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/supervisord.service; enabled; vendor preset: disabled)</span><br><span class="line">   Active: active (running) since Thu 2018-10-18 11:59:33 CST; 25s ago</span><br><span class="line"> Main PID: 17918 (supervisord)</span><br><span class="line">   CGroup: /system.slice/supervisord.service</span><br><span class="line">           └─17918 /usr/bin/python /usr/bin/supervisord -c /etc/supervisord.conf</span><br><span class="line"></span><br><span class="line">Oct 18 11:59:33 kvm systemd[1]: Starting Process Monitoring and Control Daemon...</span><br><span class="line">Oct 18 11:59:33 kvm systemd[1]: Started Process Monitoring and Control Daemon.</span><br><span class="line"></span><br><span class="line">[root@kvm webvirtmgr]# ss -antl</span><br><span class="line">State       Recv-Q Send-Q Local Address:Port               Peer Address:Port</span><br><span class="line">LISTEN      0      128              *:111                          *:*</span><br><span class="line">LISTEN      0      128              *:80                           *:*</span><br><span class="line">LISTEN      0      5      192.168.122.1:53                           *:*</span><br><span class="line">LISTEN      0      128              *:22                           *:*</span><br><span class="line">LISTEN      0      100      127.0.0.1:25                           *:*</span><br><span class="line">LISTEN      0      128              *:8000                         *:*</span><br><span class="line">LISTEN      0      100              *:6080                         *:*</span><br><span class="line">LISTEN      0      128             :::111                         :::*</span><br><span class="line">LISTEN      0      128             :::22                          :::*</span><br><span class="line">LISTEN      0      100            ::1:25                          :::*</span><br><span class="line"></span><br><span class="line">配置nginx用户</span><br><span class="line">[root@kvm home]# su - nginx -s /bin/bash</span><br><span class="line">-bash-4.2$ ssh-keygen -t rsa</span><br><span class="line">Generating public/private rsa key pair.</span><br><span class="line">Enter file in which to save the key (/var/lib/nginx/.ssh/id_rsa):</span><br><span class="line">Created directory &apos;/var/lib/nginx/.ssh&apos;.</span><br><span class="line">Enter passphrase (empty for no passphrase):</span><br><span class="line">Enter same passphrase again:</span><br><span class="line">Your identification has been saved in /var/lib/nginx/.ssh/id_rsa.</span><br><span class="line">Your public key has been saved in /var/lib/nginx/.ssh/id_rsa.pub.</span><br><span class="line">The key fingerprint is:</span><br><span class="line">SHA256:rdbmW/YIXxAJBzPsd9q9eKHPjWtSZ5EQC5li3tkczYI nginx@localhost.localdomain</span><br><span class="line">The key&apos;s randomart image is:</span><br><span class="line">+---[RSA 2048]----+</span><br><span class="line">|         .=o=.+  |</span><br><span class="line">|         o.E.=.o |</span><br><span class="line">|        o.o *.+ .|</span><br><span class="line">|         o.o.+.o |</span><br><span class="line">|        S ...+ ..|</span><br><span class="line">|         o  ..o.+|</span><br><span class="line">|        o + o.+oo|</span><br><span class="line">|       . o =.*o+.|</span><br><span class="line">|          o.oo*+.|</span><br><span class="line">+----[SHA256]-----+</span><br><span class="line"></span><br><span class="line">-bash-4.2$ touch ~/.ssh/config &amp;&amp; echo -e &quot;StrictHostKeyChecking=no\nUserKnownHostsFile=/dev/null&quot; &gt;&gt; ~/.ssh/config</span><br><span class="line">-bash-4.2$ chmod 0600 ~/.ssh/config</span><br><span class="line"></span><br><span class="line">-bash-4.2$ ssh-copy-id root@192.168.160.109</span><br><span class="line">/bin/ssh-copy-id: INFO: Source of key(s) to be installed: &quot;/var/lib/nginx/.ssh/id_rsa.pub&quot;</span><br><span class="line">/bin/ssh-copy-id: INFO: attempting to log in with the new key(s), to filter out any that are already installed</span><br><span class="line">/bin/ssh-copy-id: INFO: 1 key(s) remain to be installed -- if you are prompted now it is to install the new keys</span><br><span class="line">Warning: Permanently added &apos;192.168.160.109&apos; (ECDSA) to the list of known hosts.</span><br><span class="line">root@192.168.160.109&apos;s password:</span><br><span class="line"></span><br><span class="line">Number of key(s) added: 1</span><br><span class="line"></span><br><span class="line">Now try logging into the machine, with:   &quot;ssh &apos;root@192.168.160.109&apos;&quot;</span><br><span class="line">and check to make sure that only the key(s) you wanted were added.</span><br><span class="line"></span><br><span class="line">-bash-4.2$ exit</span><br><span class="line">logout</span><br><span class="line"></span><br><span class="line">[root@kvm ~]# vim /etc/polkit-1/localauthority/50-local.d/50-libvirt-remote-access.pkla</span><br><span class="line">[Remote libvirt SSH access]</span><br><span class="line">Identity=unix-user:root</span><br><span class="line">Action=org.libvirt.unix.manage</span><br><span class="line">ResultAny=yes</span><br><span class="line">ResultInactive=yes</span><br><span class="line">ResultActive=yes</span><br><span class="line"></span><br><span class="line">[root@kvm ~]# chown -R root.root /etc/polkit-1/localauthority/50-local.d/50-libvirt-remote-access.pkla</span><br><span class="line">[root@kvm ~]# systemctl restart nginx</span><br><span class="line">[root@kvm ~]# systemctl restart libvirtd</span><br></pre></td></tr></table></figure><h3 id="3-3-kvm-web界面管理"><a href="#3-3-kvm-web界面管理" class="headerlink" title="3.3 kvm web界面管理"></a>3.3 kvm web界面管理</h3><p>通过ip地址在浏览器上访问kvm，例如我这里就是：<code>http://192.168.160.109/login</code></p><p><img src="../../img/kvm_index1.png" alt="img"></p><h4 id="3-3-1-kvm连接管理"><a href="#3-3-1-kvm连接管理" class="headerlink" title="3.3.1 kvm连接管理"></a>3.3.1 kvm连接管理</h4><p><strong>创建SSH连接：</strong></p><p><img src="../../img/kvm_connection.png" alt="img"></p><p><img src="../../img/kvm_ssh_connect.png" alt="img"></p><p><img src="../../img/kvm_ip.png" alt="img"></p><h4 id="3-3-2-kvm存储管理"><a href="#3-3-2-kvm存储管理" class="headerlink" title="3.3.2 kvm存储管理"></a>3.3.2 kvm存储管理</h4><p><strong>创建存储：</strong></p><p><img src="../../img/kvm_storage.png" alt="img"></p><p><img src="../../img/kvm_storage_create.png" alt="img"></p><p><strong>进入存储：</strong></p><p><img src="../../img/kvm_into_storage.png" alt="img"></p><p><img src="../../img/kvm_storage_detail.png" alt="img"></p><p><strong>通过远程连接软件上传ISO镜像文件至存储目录/var/lib/libvirt/images/</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@kvm ~]# cd /var/lib/libvirt/images/</span><br><span class="line">[root@kvm images]# ls</span><br><span class="line">[root@kvm images]#</span><br><span class="line"></span><br><span class="line">Upload SCP</span><br><span class="line">CentOS-7-x86_64-DVD-1804.iso          (4263.00 MB, 8:45 min = 8.12 MB/sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@kvm images]# ls</span><br><span class="line">CentOS-7-x86_64-DVD-1804.iso</span><br></pre></td></tr></table></figure><p><strong>在 web 界面查看ISO镜像是否存在</strong></p><p><img src="../../img/kvm_show_storage.png" alt="img"></p><p><strong>创建系统安装镜像</strong></p><p><img src="../../img/kvm_img_add.png" alt="img"></p><p><img src="../../img/kvm_img_add1.png" alt="img"></p><p><strong>添加成功如下图所示</strong></p><p><img src="../../img/kvm_img_add2.png" alt="img"></p><h4 id="3-3-3-kvm网络管理"><a href="#3-3-3-kvm网络管理" class="headerlink" title="3.3.3 kvm网络管理"></a>3.3.3 kvm网络管理</h4><p><strong>添加桥接网络</strong></p><p><img src="../../img/kvm_network_add.png" alt="img"></p><p><img src="../../img/kvm_network_create_bridge1.png" alt="img"></p><p><img src="../../img/kvm_network_show.png" alt="img"></p><h4 id="3-3-4-实例管理"><a href="#3-3-4-实例管理" class="headerlink" title="3.3.4 实例管理"></a>3.3.4 实例管理</h4><p><strong>实例(虚拟机)创建</strong></p><p><img src="../../img/kvm_instance_add.png" alt="img"></p><p><img src="../../img/kvm_instance_custom.png" alt="img"></p><p><img src="../../img/kvm_instance_config.png" alt="img"></p><p><strong>虚拟机插入光盘</strong></p><p><img src="../../img/kvm_instance_cdrom.png" alt="img"></p><p><strong>设置在 web 上访问虚拟机的密码</strong></p><p><img src="../../img/kvm_console_setpasswd.png" alt="img"></p><p><strong>启动虚拟机</strong></p><p><img src="../../img/kvm_instance_start.png" alt="img"></p><p><img src="../../img/kvm_virtualhost_start.png" alt="img"></p><p><strong>虚拟机安装</strong></p><p><img src="../../img/kvm_virtualhost_install.png" alt="img"></p><p>虚拟机安装步骤就是安装系统的步骤，此处就不再赘述</p><h2 id="4-故障案例"><a href="#4-故障案例" class="headerlink" title="4.故障案例"></a>4.故障案例</h2><h3 id="4-1-案例1"><a href="#4-1-案例1" class="headerlink" title="4.1 案例1"></a>4.1 案例1</h3><p>web界面配置完成后可能会出现以下错误界面</p><p><img src="../../img/15523585024461.jpg" alt="img"><br>解决方法是安装novnc并通过novnc_server启动一个vnc</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# ll /etc/rc.local</span><br><span class="line">lrwxrwxrwx. 1 root root 13 Aug  6  2018 /etc/rc.local -&gt; rc.d/rc.local</span><br><span class="line">[root@localhost ~]# ll /etc/rc.d/rc.local</span><br><span class="line">-rw-r--r-- 1 root root 513 Mar 11 22:35 /etc/rc.d/rc.local</span><br><span class="line">[root@localhost ~]# chmod +x /etc/rc.d/rc.local</span><br><span class="line">[root@localhost ~]# ll /etc/rc.d/rc.local</span><br><span class="line">-rwxr-xr-x 1 root root 513 Mar 11 22:35 /etc/rc.d/rc.local</span><br><span class="line"></span><br><span class="line">[root@localhost ~]# vim /etc/rc.d/rc.local</span><br><span class="line">......此处省略N行</span><br><span class="line"># that this script will be executed during boot.</span><br><span class="line"></span><br><span class="line">touch /var/lock/subsys/local</span><br><span class="line">nohup novnc_server 172.16.12.128:5920 &amp;</span><br><span class="line"></span><br><span class="line">[root@localhost ~]# . /etc/rc.d/rc.local</span><br></pre></td></tr></table></figure><p>做完以上操作后再次访问即可正常访问</p><p><img src="../../img/15523588093971.jpg" alt="img"></p><h3 id="4-2-案例2"><a href="#4-2-案例2" class="headerlink" title="4.2 案例2"></a>4.2 案例2</h3><p>第一次通过web访问kvm时可能会一直访问不了，一直转圈，而命令行界面一直报错(too many open files)</p><p>此时需要对nginx进行配置</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# vim /etc/nginx/nginx.conf</span><br><span class="line">....此处省略N行</span><br><span class="line">user nginx;</span><br><span class="line">worker_processes auto;</span><br><span class="line">error_log /var/log/nginx/error.log;</span><br><span class="line">pid /run/nginx.pid;</span><br><span class="line">worker_rlimit_nofile 655350;    //添加此行配置</span><br><span class="line"></span><br><span class="line"># Load dynamic modules. See /usr/share/nginx/README.dynamic.</span><br><span class="line">....此处省略N行</span><br><span class="line"></span><br><span class="line">[root@localhost ~]# systemctl restart nginx</span><br></pre></td></tr></table></figure><p>然后对系统参数进行设置</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# vim /etc/security/limits.conf</span><br><span class="line">....此处省略N行</span><br><span class="line"># End of file</span><br><span class="line">* soft nofile 655350</span><br><span class="line">* hard nofile 655350</span><br></pre></td></tr></table></figure><p>到此问题即可解决</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;a id=&quot;more&quot;&gt;&lt;/a&gt;



&lt;h2 id=&quot;1-虚拟化介绍&quot;&gt;&lt;a href=&quot;#1-虚拟化介绍&quot; class=&quot;headerlink&quot; title=&quot;1. 虚拟化介绍&quot;&gt;&lt;/a&gt;1. 虚拟化介绍&lt;/h2&gt;&lt;p&gt;虚拟化是云计算的基础。简单的说，虚拟化使得在一台物理的
      
    
    </summary>
    
      <category term="Linux运维" scheme="http://aiwhs.github.io/categories/Linux%E8%BF%90%E7%BB%B4/"/>
    
    
      <category term="虚拟化" scheme="http://aiwhs.github.io/tags/%E8%99%9A%E6%8B%9F%E5%8C%96/"/>
    
  </entry>
  
  <entry>
    <title>zabbix监控MySQL</title>
    <link href="http://aiwhs.github.io/2019/01/13/Zabbix%E7%9B%91%E6%8E%A7MySQL%E4%B8%BB%E4%BB%8E/"/>
    <id>http://aiwhs.github.io/2019/01/13/Zabbix监控MySQL主从/</id>
    <published>2019-01-13T00:15:57.000Z</published>
    <updated>2019-07-17T12:10:45.522Z</updated>
    
    <content type="html"><![CDATA[<a id="more"></a><h2 id="实验环境"><a href="#实验环境" class="headerlink" title="实验环境:"></a>实验环境:</h2><p>mysql主从配置参考 <a href="https://blog.csdn.net/wenhs5479/article/details/90240226" target="_blank" rel="noopener">mysql主从</a></p><p>关闭防火墙和selinux<br>安装zabbix，zabbix是基于lamp环境下的，先搭建lamp架构</p><p><a href="https://blog.csdn.net/wenhs5479/article/details/90267202" target="_blank" rel="noopener">安装zabbix</a>监控mysql主从</p><table><thead><tr><th align="center">主机系统</th><th align="center">IP</th><th align="center">角色</th></tr></thead><tbody><tr><td align="center">centos7.6最小化</td><td align="center">192.168.2.158</td><td align="center">zabbix-server<br>lamp</td></tr><tr><td align="center">centos7.6最小化</td><td align="center">192.168.2.229</td><td align="center">zabbix-agentd<br>MySQL-slave</td></tr><tr><td align="center">centos7.6最小化</td><td align="center">192.168.2.157</td><td align="center">zabbix-agentd<br>MySQL-server</td></tr></tbody></table><p><a href="https://blog.csdn.net/wenhs5479/article/details/90514799" target="_blank" rel="noopener">ZABBIX的自定义监控</a>续章扩展,</p><h3 id="实验一-监控MySQL主从同步状态"><a href="#实验一-监控MySQL主从同步状态" class="headerlink" title="实验一:监控MySQL主从同步状态"></a>实验一:监控MySQL主从同步状态</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[root@itwhs ~]# egrep -v &quot;#|^$&quot; /usr/local/etc/zabbix_agentd.conf</span><br><span class="line">LogFile=/tmp/zabbix_agentd.log</span><br><span class="line">Server=192.168.2.158</span><br><span class="line">ServerActive=192.168.2.158</span><br><span class="line">Hostname=itwhs</span><br><span class="line">UnsafeUserParameters=1    //设1为开启</span><br><span class="line">UserParameter=ckproc[*],/usr/bin/bash /scripts/proc.sh $1</span><br><span class="line">UserParameter=cklog[*],/usr/bin/python /scripts/log.py $1 $2 $3</span><br><span class="line"></span><br><span class="line">配置免密登录</span><br><span class="line">[root@itwhs ~]# head -4 /etc/my.cnf</span><br><span class="line">[client]</span><br><span class="line">host=localhost</span><br><span class="line">user=root</span><br><span class="line">password=itwhsgithubio</span><br><span class="line"></span><br><span class="line">添加一个key</span><br><span class="line">[root@itwhs ~]# vim /usr/local/etc/zabbix_agentd.conf</span><br><span class="line">UserParameter=ckmysqlms,mysql -e &quot;show slave status\G&quot; | grep &quot;Running&quot; |awk &apos;&#123;print $NF&#125;&apos; | grep -c &quot;Yes&quot;</span><br><span class="line"></span><br><span class="line">重启服务</span><br><span class="line">[root@itwhs ~]# pkill zabbix</span><br><span class="line">[root@itwhs ~]# zabbix_agentd</span><br></pre></td></tr></table></figure><p>服务端验证:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@zabbix ~]# zabbix_get -s 192.168.2.229 -k ckmysqlms</span><br><span class="line">2</span><br><span class="line">#抓取mysql-slave端的键值，如果返回数值2.则表明IO和SQL线程状态都为yes状态，则表明主从正常</span><br></pre></td></tr></table></figure><p><strong>【Zabbix-server-web端配置】</strong></p><p><strong>创建一个监控项作为mysql主从</strong></p><p><img src="../../img/2019-05-25_154837.png" alt></p><p>【创建触发器，实现主从异常报警】</p><p><img src="../../img/2019-05-25_155244.png" alt></p><p>手动触发测试:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@itwhs ~]# mysql -e &quot;stop slave;&quot;</span><br><span class="line">[root@itwhs ~]# mysql -e &quot;start slave;&quot;</span><br></pre></td></tr></table></figure><p><img src="../../img/2019-05-25_163141.png" alt></p><p><img src="../../img/Screenshot_20190525-163620.jpg" alt></p><h3 id="实验二-监控MySQL主从延迟"><a href="#实验二-监控MySQL主从延迟" class="headerlink" title="实验二:监控MySQL主从延迟"></a>实验二:监控MySQL主从延迟</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">添加key</span><br><span class="line">[root@itwhs ~]# vim /usr/local/etc/zabbix_agentd.conf</span><br><span class="line">UserParameter=mysql.delay,mysql -e &quot;show slave status\G&quot; 2&gt;/dev/null|egrep &apos;Seconds_Behind_Master&apos;|awk &apos;&#123;print $2&#125;&apos;</span><br><span class="line"></span><br><span class="line">重启服务</span><br><span class="line">[root@itwhs ~]# pkill zabbix</span><br><span class="line">[root@itwhs ~]# zabbix_agentd</span><br></pre></td></tr></table></figure><p>服务端验证:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@zabbix ~]# zabbix_get -s 192.168.2.229 -k mysql.delay</span><br><span class="line">0</span><br><span class="line">说明没有延迟</span><br></pre></td></tr></table></figure><p><strong>【Zabbix-server-web端配置】</strong></p><p><strong>创建一个监控项作为mysql延迟</strong></p><p><img src="../../img/2019-05-25_165508.png" alt></p><p>【创建触发器，实现主从异常报警】</p><p><img src="../../img/2019-05-25_170010.png" alt></p><p>手动测试</p><p>插入几百到几千万条数据,才能看出延迟,方法在<a href="https://blog.csdn.net/wenhs5479/article/details/90320220" target="_blank" rel="noopener">gtid主从</a>那一章</p><p>结果:</p><p><img src="../../img/2019-05-25_171201.png" alt></p><p><img src="../../img/Screenshot_20190525-171536.jpg" alt></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;a id=&quot;more&quot;&gt;&lt;/a&gt;



&lt;h2 id=&quot;实验环境&quot;&gt;&lt;a href=&quot;#实验环境&quot; class=&quot;headerlink&quot; title=&quot;实验环境:&quot;&gt;&lt;/a&gt;实验环境:&lt;/h2&gt;&lt;p&gt;mysql主从配置参考 &lt;a href=&quot;https://blog.csdn.
      
    
    </summary>
    
      <category term="Linux运维" scheme="http://aiwhs.github.io/categories/Linux%E8%BF%90%E7%BB%B4/"/>
    
    
      <category term="监控服务" scheme="http://aiwhs.github.io/tags/%E7%9B%91%E6%8E%A7%E6%9C%8D%E5%8A%A1/"/>
    
  </entry>
  
  <entry>
    <title>zabbix之微信钉钉告警</title>
    <link href="http://aiwhs.github.io/2019/01/12/zabbix%E5%91%8A%E8%AD%A6%E4%B9%8B%E5%BE%AE%E4%BF%A1%E5%92%8C%E9%92%89%E9%92%89/"/>
    <id>http://aiwhs.github.io/2019/01/12/zabbix告警之微信和钉钉/</id>
    <published>2019-01-12T00:15:57.000Z</published>
    <updated>2019-07-17T12:07:49.904Z</updated>
    
    <content type="html"><![CDATA[<a id="more"></a><h2 id="一-zabbix配置WeChat报警"><a href="#一-zabbix配置WeChat报警" class="headerlink" title="一,zabbix配置WeChat报警"></a>一,zabbix配置WeChat报警</h2><p>写先声明:本人完全python小白,脚本内容有许多看不懂,这都不影响接下来的操作,写这个就是为了复习记忆,也多谢<a href="https://www.zabbix.com/cn/integrations/wechat" target="_blank" rel="noopener">官网</a>推荐的,用于WeChat报警的python脚本,主要是图文教程,配合作者<a href="https://github.com/X-Mars/Zabbix-Alert-WeChat" target="_blank" rel="noopener">火星小刘</a>的README和脚本,更容易学习.</p><p>注意事项等,作者<a href="https://github.com/X-Mars/Zabbix-Alert-WeChat" target="_blank" rel="noopener">火星小刘</a>的README中有,下面开始教程正文</p><h3 id="需要具备一下条件"><a href="#需要具备一下条件" class="headerlink" title="需要具备一下条件"></a>需要具备一下条件</h3><ul><li>注册微信企业号 <a href="https://qy.weixin.qq.com/" target="_blank" rel="noopener">点击注册</a>   或    注册企业号微信  [点击注册](<a href="https://work.weixin.qq.com/）" target="_blank" rel="noopener">https://work.weixin.qq.com/）</a></li></ul><p><img src="../../img/1558582852920.png" alt="1558582852920"></p><p>信息不要求,无需认证</p><h4 id="安装组件"><a href="#安装组件" class="headerlink" title="安装组件"></a>安装组件</h4><ol><li>安装方法一</li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">yum -y install python-pip python-wheel python-setuptools</span><br><span class="line">yum upgrade python-setuptools</span><br><span class="line">pip install requests</span><br><span class="line">pip install --upgrade requests</span><br></pre></td></tr></table></figure><ol start="2"><li>安装方法二</li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">wget https://pypi.python.org/packages/c3/38/d95ddb6cc8558930600be088e174a2152261a1e0708a18bf91b5b8c90b22/requests-2.18.3.tar.gz</span><br><span class="line">tar zxvf requests-2.18.3.tar.gz</span><br><span class="line">cd requests-2.18.3</span><br><span class="line">python setup.py build</span><br><span class="line">python setup.py install</span><br></pre></td></tr></table></figure><h4 id="下载安装脚本"><a href="#下载安装脚本" class="headerlink" title="下载安装脚本"></a>下载安装脚本</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/X-Mars/Zabbix-Alert-WeChat.git  </span><br><span class="line">cp Zabbix-Alert-WeChat/wechat.py /etc/zabbix/alertscripts  </span><br><span class="line">chmod +x /usr/local/etc/scripts/wechat.py  </span><br><span class="line">chown zabbix.zabbix /usr/local/etc/scripts/wechat.py</span><br></pre></td></tr></table></figure><h3 id="微信企业号设置"><a href="#微信企业号设置" class="headerlink" title="微信企业号设置"></a>微信企业号设置</h3><h4 id="通讯录设置"><a href="#通讯录设置" class="headerlink" title="通讯录设置"></a>通讯录设置</h4><p>登陆微信企业号控制台  </p><p><img src="../../img/1558583445317.png" alt="1558583445317"></p><p>点击左侧“通讯录”，新增部门（技术部）与子部门（运维部），并添加用户 </p><p><img src="../../img/1558583950181.png" alt="1558583950181"></p><p>点击（运维部）后方的三角，修改部门，记录<strong>部门ID</strong>  </p><p><img src="../../img/1558584006786.png" alt="1558584006786"></p><h4 id="创建应用"><a href="#创建应用" class="headerlink" title="创建应用"></a>创建应用</h4><p>点击左侧“应用中心”，新建消息型应用，应用名称“自己随便取” </p><p><img src="../../img/1558584148515.png" alt="1558584148515"></p><p>“应用可见范围”，添加刚刚新建的子部门（运维部）  </p><p><img src="../../img/1558584304526.png" alt="1558584304526"></p><p>点击“自己随便取的应用”，记录<strong>应用ID</strong></p><h4 id="应用权限设置"><a href="#应用权限设置" class="headerlink" title="应用权限设置"></a>应用权限设置</h4><p>点击左侧“设置”，权限管理，新建普通管理组，名称填写“zabbix报警组”<br>点击修改“通讯录权限”，勾选（技术部）后方的管理<br>点击修改“应用权限”，勾选刚刚创建的“zabbix报警”  </p><p><img src="../../img/1558584738682.png" alt="1558584738682"></p><p>点击刚刚创建的“zabbix报警组”，记录左侧的<strong>CorpID与Secret</strong>(个人创建的没有,问题不大)</p><h4 id="收集微信相关信息"><a href="#收集微信相关信息" class="headerlink" title="收集微信相关信息"></a>收集微信相关信息</h4><ol><li>记录<strong>应用ID</strong></li></ol><p><img src="../../img/1558587645603.png" alt="1558587645603"></p><ol start="2"><li>记录<strong>CorpID与Secret</strong></li></ol><p><img src="../../img/1558587536574.png" alt="1558587536574"></p><ol start="3"><li>记录<strong>子部门（运维部）ID</strong></li></ol><p><img src="../../img/1558587727154.png" alt="1558587727154"></p><p>这时,就可以填写脚本却的参数了:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/python2.7</span><br><span class="line">#_*_coding:utf-8 _*_</span><br><span class="line">#auther:火星小刘(出自这位大佬的GitHub库,链接在开头)</span><br><span class="line"></span><br><span class="line">import requests,sys,json</span><br><span class="line">import urllib3</span><br><span class="line">urllib3.disable_warnings()</span><br><span class="line"></span><br><span class="line">reload(sys)</span><br><span class="line">sys.setdefaultencoding(&apos;utf-8&apos;)</span><br><span class="line"></span><br><span class="line">def GetTokenFromServer(Corpid,Secret):</span><br><span class="line">    Url = &quot;https://qyapi.weixin.qq.com/cgi-bin/gettoken&quot;</span><br><span class="line">    Data = &#123;</span><br><span class="line">        &quot;corpid&quot;:Corpid,</span><br><span class="line">        &quot;corpsecret&quot;:Secret</span><br><span class="line">    &#125;</span><br><span class="line">    r = requests.get(url=Url,params=Data,verify=False)</span><br><span class="line">    print(r.json())</span><br><span class="line">    if r.json()[&apos;errcode&apos;] != 0:</span><br><span class="line">        return False</span><br><span class="line">    else:</span><br><span class="line">        Token = r.json()[&apos;access_token&apos;]</span><br><span class="line">        file = open(&apos;/tmp/zabbix_wechat_config.json&apos;, &apos;w&apos;)</span><br><span class="line">        file.write(r.text)</span><br><span class="line">        file.close()</span><br><span class="line">        return Token</span><br><span class="line"></span><br><span class="line">def SendMessage(User,Agentid,Subject,Content):</span><br><span class="line">    try:</span><br><span class="line">        file = open(&apos;/tmp/zabbix_wechat_config.json&apos;, &apos;r&apos;)</span><br><span class="line">        Token = json.load(file)[&apos;access_token&apos;]</span><br><span class="line">        file.close()</span><br><span class="line">    except:</span><br><span class="line">        Token = GetTokenFromServer(Corpid, Secret)</span><br><span class="line"></span><br><span class="line">    n = 0</span><br><span class="line">    Url = &quot;https://qyapi.weixin.qq.com/cgi-bin/message/send?access_token=%s&quot; % Token</span><br><span class="line">    Data = &#123;</span><br><span class="line">        &quot;touser&quot;: User,          # 企业号中的用户帐号，在zabbix用户Media中配置，如果配置不正常，将按部门发送。</span><br><span class="line">        &quot;totag&quot;: Tagid,          # 企业号中的标签id，群发使用（推荐）</span><br><span class="line">        &quot;toparty&quot;: Partyid,      # 企业号中的部门id，群发时使用。</span><br><span class="line">        &quot;msgtype&quot;: &quot;text&quot;,       # 消息类型。</span><br><span class="line">        &quot;agentid&quot;: Agentid,      # 企业号中的应用id。</span><br><span class="line">        &quot;text&quot;: &#123;</span><br><span class="line">            &quot;content&quot;: Subject + &apos;\n&apos; + Content</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;safe&quot;: &quot;0&quot;</span><br><span class="line">    &#125;</span><br><span class="line">    r = requests.post(url=Url,data=json.dumps(Data),verify=False)</span><br><span class="line">    while r.json()[&apos;errcode&apos;] != 0 and n &lt; 4:</span><br><span class="line">        n+=1</span><br><span class="line">        Token = GetTokenFromServer(Corpid, Secret)</span><br><span class="line">        if Token:</span><br><span class="line">            Url = &quot;https://qyapi.weixin.qq.com/cgi-bin/message/send?access_token=%s&quot; % Token</span><br><span class="line">            r = requests.post(url=Url,data=json.dumps(Data),verify=False)</span><br><span class="line">            print(r.json())</span><br><span class="line"></span><br><span class="line">    return r.json()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if __name__ == &apos;__main__&apos;:</span><br><span class="line">    User = sys.argv[1]               # zabbix传过来的第一个参数&#123;ALERT.SENDTO&#125;</span><br><span class="line">    Subject = str(sys.argv[2])       # zabbix传过来的第二个参数&#123;ALERT.SUBJECT&#125;</span><br><span class="line">    Content = str(sys.argv[3])       # zabbix传过来的第三个参数&#123;ALERT.MESSAGE&#125;</span><br><span class="line"></span><br><span class="line">    Corpid = &quot;企业Id&quot;         # CorpID是企业号的标识</span><br><span class="line">    Secret = &quot;在应用里面&quot;      # Secret是管理组凭证密钥</span><br><span class="line">    Tagid = &quot;zabbix&quot;         # 通讯录标签ID(这个没搞懂,随便写的通讯录标签名)</span><br><span class="line">    Agentid = &quot;自己修改&quot;      # 应用ID</span><br><span class="line">    Partyid = &quot;2&quot;            # 部门ID,如果是1,则是技术部,那么技术部下面的,都可以收到告警,显然不合适</span><br><span class="line"></span><br><span class="line">    Status = SendMessage(User,Agentid,Subject,Content)</span><br><span class="line">    print Status</span><br></pre></td></tr></table></figure><h3 id="zabbix设置"><a href="#zabbix设置" class="headerlink" title="zabbix设置"></a>zabbix设置</h3><ol><li>添加示警媒介  </li></ol><p><img src="../../img/1558587849221.png" alt="1558587849221"></p><h4 id="管理–-gt-示警媒介"><a href="#管理–-gt-示警媒介" class="headerlink" title="管理–&gt;示警媒介"></a>管理–&gt;示警媒介</h4><p>名称填写<strong>微信报警</strong>，类型选择<strong>脚本</strong>，脚本名称填写<strong>wechat.py</strong>  </p><h4 id="管理–-gt-用户–-gt-示警媒介"><a href="#管理–-gt-用户–-gt-示警媒介" class="headerlink" title="管理–&gt;用户–&gt;示警媒介"></a>管理–&gt;用户–&gt;示警媒介</h4><p>类型选择<strong>微信报警</strong>，收件人添加<strong>微信企业号通讯录内的，用户帐号</strong></p><p><img src="../../img/1558587981394.png" alt="1558587981394"></p><p>添加到动作,具体方法,如下图所示</p><p><img src="../../img/1558588246133.png" alt="1558588246133"></p><p>测试一:</p><p><img src="../../img/1558588591326.png" alt="1558588591326"></p><p>结果一:</p><p><img src="../../img/Screenshot_20190523-132529__01.jpg" alt></p><p>测试二:手动触发</p><p><img src="../../img/1558589480439.png" alt="1558589480439"></p><p>结果二:</p><p><img src="../../img/Screenshot_20190523-133330__01.jpg" alt></p><h2 id="二-钉钉告警"><a href="#二-钉钉告警" class="headerlink" title="二,钉钉告警"></a>二,钉钉告警</h2><p><strong>下载钉钉后创建群组</strong></p><p><strong>添加机器人实现报警</strong></p><p> <img src="../../img/1558609475491.png" alt="1558609475491"></p><p><strong>添加完成</strong></p><p>创建告警脚本</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">简洁版一:</span><br><span class="line">#!/usr/bin/python</span><br><span class="line"># -*- coding: utf-8 -*-</span><br><span class="line"></span><br><span class="line">import requests</span><br><span class="line">import json</span><br><span class="line">import sys</span><br><span class="line">import os</span><br><span class="line">headers = &#123;&apos;Content-Type&apos;: &apos;application/json;charset=utf-8&apos;&#125;</span><br><span class="line">#api_url后跟告警机器人的webhook</span><br><span class="line">api_url = &quot;上图中的webhook的链接&quot;</span><br><span class="line">def msg(text):</span><br><span class="line">   json_text= &#123;</span><br><span class="line">    &quot;msgtype&quot;: &quot;text&quot;,</span><br><span class="line">    &quot;text&quot;: &#123;</span><br><span class="line">        &quot;content&quot;: text</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;at&quot;: &#123;</span><br><span class="line">        &quot;atMobiles&quot;: [</span><br><span class="line">            &quot;手机号&quot;    #@群里的一个人</span><br><span class="line">        ],</span><br><span class="line">        &quot;isAtAll&quot;: False  #@所有人为True,</span><br><span class="line">    &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   print(requests.post(api_url,json.dumps(json_text),headers=headers).content)</span><br><span class="line">if __name__ == &apos;__main__&apos;:</span><br><span class="line">   text = sys.argv[1]</span><br><span class="line">   msg(text)</span><br><span class="line">   </span><br><span class="line">   </span><br><span class="line">脚本二:</span><br><span class="line">#!/usr/bin/env python</span><br><span class="line">#coding:utf-8</span><br><span class="line">#zabbix钉钉报警</span><br><span class="line">import requests,json,sys,os,datetime</span><br><span class="line">webhook=&quot;https://oapi.dingtalk.com/robot/send?access_token=8ea7abd3db4b49a9e898e911920d4899c526ae78f5794c977cfca8b6c0b77fdf&quot;</span><br><span class="line">user=sys.argv[1]</span><br><span class="line">text=sys.argv[3]</span><br><span class="line">data=&#123;</span><br><span class="line">    &quot;msgtype&quot;: &quot;text&quot;,</span><br><span class="line">    &quot;text&quot;: &#123;</span><br><span class="line">        &quot;content&quot;: text</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;at&quot;: &#123;</span><br><span class="line">        &quot;atMobiles&quot;: [</span><br><span class="line">            user</span><br><span class="line">        ],</span><br><span class="line">        &quot;isAtAll&quot;: False</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">headers = &#123;&apos;Content-Type&apos;: &apos;application/json&apos;&#125;</span><br><span class="line">x=requests.post(url=webhook,data=json.dumps(data),headers=headers)</span><br><span class="line">if os.path.exists(&quot;/tmp/ding.log&quot;):</span><br><span class="line">    f=open(&quot;/tmp/ding.log&quot;,&quot;a+&quot;)</span><br><span class="line">else:</span><br><span class="line">    f=open(&quot;tmp/ding.log&quot;,&quot;w+&quot;)</span><br><span class="line">f.write(&quot;\n&quot;+&quot;--&quot;*30)</span><br><span class="line">if x.json()[&quot;errcode&quot;] == 0:</span><br><span class="line">    f.write(&quot;\n&quot;+str(datetime.datetime.now())+&quot;    &quot;+str(user)+&quot;    &quot;+&quot;发送成功&quot;+&quot;\n&quot;+str(text))</span><br><span class="line">    f.close()</span><br><span class="line">else:</span><br><span class="line">    f.write(&quot;\n&quot;+str(datetime.datetime.now()) + &quot;    &quot; + str(user) + &quot;    &quot; + &quot;发送失败&quot; + &quot;\n&quot; + str(text))</span><br><span class="line">    f.close()</span><br></pre></td></tr></table></figure><p>赋予执行权限</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">chown zabbix.zabbix ding.py</span><br><span class="line"></span><br><span class="line">chmod +x ding.py</span><br></pre></td></tr></table></figure><p>测试</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@zabbix scripts]# ./ding.py 这是测试</span><br><span class="line">&#123;&quot;errcode&quot;:0,&quot;errmsg&quot;:&quot;ok&quot;&#125;</span><br><span class="line">[root@zabbix scripts]# ./ding.py 这是测试</span><br><span class="line">&#123;&quot;errcode&quot;:0,&quot;errmsg&quot;:&quot;ok&quot;&#125;</span><br></pre></td></tr></table></figure><p><img src="../../img/1558610185107.png" alt="1558610185107"></p><p>如果想知道消息内容中宏，可参考<a href="https://www.zabbix.com/documentation/4.2/manual/appendix/macros/supported_by_location" target="_blank" rel="noopener">官网宏的使用场景</a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">服务器:&#123;HOST.NAME&#125;发生: &#123;TRIGGER.NAME&#125;故障!</span><br><span class="line">&#123;</span><br><span class="line">告警主机:&#123;HOST.NAME&#125;</span><br><span class="line">告警地址:&#123;HOST.IP&#125;</span><br><span class="line">监控项目:&#123;ITEM.NAME&#125;</span><br><span class="line">监控取值:&#123;ITEM.LASTVALUE&#125;</span><br><span class="line">告警等级:&#123;TRIGGER.SEVERITY&#125;</span><br><span class="line">当前状态:&#123;TRIGGER.STATUS&#125;</span><br><span class="line">告警信息:&#123;TRIGGER.NAME&#125;</span><br><span class="line">告警时间:&#123;EVENT.DATE&#125; &#123;EVENT.TIME&#125;</span><br><span class="line">事件ID:&#123;EVENT.ID&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">服务器:&#123;HOST.NAME&#125;: &#123;TRIGGER.NAME&#125;已恢复!</span><br><span class="line">&#123;</span><br><span class="line">告警主机:&#123;HOST.NAME&#125;</span><br><span class="line">告警地址:&#123;HOST.IP&#125;</span><br><span class="line">监控项目:&#123;ITEM.NAME&#125;</span><br><span class="line">监控取值:&#123;ITEM.LASTVALUE&#125;</span><br><span class="line">告警等级:&#123;TRIGGER.SEVERITY&#125;</span><br><span class="line">当前状态:&#123;TRIGGER.STATUS&#125;</span><br><span class="line">告警信息:&#123;TRIGGER.NAME&#125;</span><br><span class="line">告警时间:&#123;EVENT.DATE&#125; &#123;EVENT.TIME&#125;</span><br><span class="line">恢复时间:&#123;EVENT.RECOVERY.DATE&#125; &#123;EVENT.RECOVERY.TIME&#125;</span><br><span class="line">持续时间:&#123;EVENT.AGE&#125;</span><br><span class="line">事件ID:&#123;EVENT.ID&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">服务器:&#123;HOST.NAME&#125;: 报警确认</span><br><span class="line">&#123;</span><br><span class="line">确认人:&#123;USER.FULLNAME&#125; </span><br><span class="line">时间:&#123;ACK.DATE&#125; &#123;ACK.TIME&#125; </span><br><span class="line">确认信息如下:</span><br><span class="line">&quot;&#123;ACK.MESSAGE&#125;&quot;</span><br><span class="line">问题服务器IP:&#123;HOSTNAME1&#125;</span><br><span class="line">问题ID:&#123;EVENT.ID&#125;</span><br><span class="line">当前的问题是: &#123;TRIGGER.NAME&#125;</span><br><span class="line">&#125;</span><br><span class="line">分别填在下面3个操作</span><br></pre></td></tr></table></figure><p><img src="../../img/1558611240781.png" alt="1558611240781"></p><p>创建报警媒介   </p><p><img src="../../img/1558610599068.png" alt="1558610599068"></p><p>脚本二需要3个脚本参数：ALERT.SENDTO      ALERT.SUBJECT      ALERT.MESSAGE</p><p><img src="../../img/1558688875988.png" alt="1558688875988"></p><p>用户设置媒介(收件人py脚本写死了,这随便写)</p><p><img src="../../img/1558610665901.png" alt="1558610665901"></p><p>脚本二:</p><p><img src="../../img/1558689127326.png" alt="1558689127326"></p><p>添加动作(和上方WeChat方法一样,改一个通知介质),这里就不截屏了</p><p>最后测试附图:</p><p><img src="../../img/1558611032763.png" alt="1558611032763"></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;a id=&quot;more&quot;&gt;&lt;/a&gt;



&lt;h2 id=&quot;一-zabbix配置WeChat报警&quot;&gt;&lt;a href=&quot;#一-zabbix配置WeChat报警&quot; class=&quot;headerlink&quot; title=&quot;一,zabbix配置WeChat报警&quot;&gt;&lt;/a&gt;一,zabbix配置W
      
    
    </summary>
    
      <category term="Linux运维" scheme="http://aiwhs.github.io/categories/Linux%E8%BF%90%E7%BB%B4/"/>
    
    
      <category term="监控服务" scheme="http://aiwhs.github.io/tags/%E7%9B%91%E6%8E%A7%E6%9C%8D%E5%8A%A1/"/>
    
  </entry>
  
  <entry>
    <title>Zabbix监控组件及流程</title>
    <link href="http://aiwhs.github.io/2019/01/06/Zabbix%E7%9B%91%E6%8E%A7%E7%BB%84%E4%BB%B6%E5%8F%8A%E6%B5%81%E7%A8%8B/"/>
    <id>http://aiwhs.github.io/2019/01/06/Zabbix监控组件及流程/</id>
    <published>2019-01-06T00:15:57.000Z</published>
    <updated>2019-07-17T12:00:34.733Z</updated>
    
    <content type="html"><![CDATA[<a id="more"></a><h2 id="Zabbix监控组件及流程"><a href="#Zabbix监控组件及流程" class="headerlink" title="Zabbix监控组件及流程"></a><strong>Zabbix监控组件及流程</strong></h2><p>Zabbix监控组件主要包括：Zabbix Server、Zabbix Proxy、Zabbix Agent；其中Zabbix Server包括：WEB GUI、Database、Zabbix Server。</p><h3 id="每个模块工作职责："><a href="#每个模块工作职责：" class="headerlink" title="每个模块工作职责："></a>每个模块工作职责：</h3><ul><li>Zabbix Server：负责接收agent发送的报告信息的核心组件，所有配置，统计数据及操作数据均由其组织进行；</li><li>Database Storage：用户存储所有配置信息，以及存储由Zabbix Server收集到的数据；</li><li>Web Interface：Zabbix的GUI接口，通常与Server运行在同一台主机上；</li><li>Zabbix Proxy：常用于分布监控环境中，代理Server收集部分被监控的监控数据并统一发往Server端；（通常大于500台主机需要使用）</li><li>Zabbix Agent：部署在被监控主机上，负责收集本地数据发往Server端或Proxy端；</li></ul><h2 id="Zabbix监控系统具体监控流程："><a href="#Zabbix监控系统具体监控流程：" class="headerlink" title="Zabbix监控系统具体监控流程："></a>Zabbix监控系统具体监控流程：</h2><p><img src="../../img/01.jpg" alt="Zabbix监控组件介绍、工作原理、监控方式、监控概念 linux服务搭建1"></p><h2 id="Zabbix监控原理："><a href="#Zabbix监控原理：" class="headerlink" title="Zabbix监控原理："></a><strong>Zabbix监控原理：</strong></h2><p>Agentd安装在被监控的主机上，Agent负责定期收集客户端本地各项数据，并发送至Zabbix Server端，Zabbix Server收到数据，将数据存储到数据库中，用户基于Zabbix WEB可以看到数据在前端展现图像。当Zabbix监控某个具体的项目，改项目会设置一个触发器阈值，当被监控的指标超过该触发器设定的阈值，会进行一些必要的动作，动作包括：发送信息（邮件、微信、短信）、发送命令（SHELL 命令、Reboot、Restart、Install等）。</p><h2 id="Zabbix监控常见的五个程序及功能"><a href="#Zabbix监控常见的五个程序及功能" class="headerlink" title="Zabbix监控常见的五个程序及功能"></a>Zabbix监控常见的五个程序及功能</h2><ul><li>zabbix server：zabbix服务端守护进程，其中zabbix_agentd、zabbix_get、zabbix_sender、zabbix_proxy的数据最终都提交给zabbix server；</li><li>zabbix agentd：客户端守护进程，负责收集客户端数据，例如：收集cpu负载、内存、硬盘使用情况等；</li><li>zabbix proxy：zabbix分布式代理守护进程，通过大于500台主机，需要进行分布式监控架构部署；</li><li>zabbix get：zabbix数据接收工具，单独使用的命令，通常在server或者proxy端执行获取远程客户端信息的命令；</li><li>zabbix sender：zabbix数据发送工具，用户发送数据给server或proxy端，通常用户耗时比较长的检查。</li></ul><h2 id="Zabbix三种监控方式：Agent、SNMP、IPMI"><a href="#Zabbix三种监控方式：Agent、SNMP、IPMI" class="headerlink" title="Zabbix三种监控方式：Agent、SNMP、IPMI"></a><strong>Zabbix三种监控方式：Agent、SNMP、IPMI</strong></h2><p>Agent：Zabbix可以基于自身zabbix_agent客户端插件监控OS的状态，例如CPU、内存、硬盘、网卡、文件等。</p><p>SNMP：Zabbix通过简单网络管理协议（Simple Network Management Protocol）监控网络设备或windows主机等。通过设定SNMP的参数将相关监控数据传送至服务端，交换机、防火墙等网络设备一般都支持SNMP协议。</p><p>IPMI：智能平台管理接口（Intelligent Platform Management Interface，IPMI）即主要应用于设备的物理特性，包括：温度、电压、电扇工作状态，电源供应以及机箱入侵等。IPMI最大的优势在于无论OS的开机还是关机状态下，只要接通电源就可以实现对服务器的监控。</p><h2 id="主动监控与被动监控"><a href="#主动监控与被动监控" class="headerlink" title="主动监控与被动监控"></a>主动监控与被动监控</h2><ul><li>Zabbix监控客户端分为主动监控与被动监控，主被动模式以客户端为参照，Zabbix监控客户端默认为被动模式，可以修改为主动模式，只需要在客户端配置文件中添加 StartAgents=0。主被动监控模式如下：</li><li>Zabbix主动模式：Agent主动请求server获取主动的监控项列表，并主动将监控项内需要检测的数据提交给server/proxy，zabbix agent首先向ServerActive配置的IP请求获取active items，获取并提交active items数据至server/proxy。</li><li>Zabbix被动模式：Server向agent请求获取监控项的数据，agent返回数据，server打开一个TCP连接，Server发送请求agent.ping，Agent接收到请求并且响应，Server处理接收到的数据。</li></ul><h2 id="Zabbix监控概念"><a href="#Zabbix监控概念" class="headerlink" title="Zabbix监控概念"></a><strong>Zabbix监控概念</strong></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">主机（host）：                             被监控的网络设备，可以写IP或者DNS；</span><br><span class="line">主机组（host group）：             主机组用于管理主机，可以批量设置权限；</span><br><span class="line">监控项（item）：                        具体监控项，items值由独立的keys进行识别；</span><br><span class="line">触发器（trigger）：                    为某个items设置触发器，达到触发器会执行action动作；</span><br><span class="line">事件（event）：                          例如达到某个触发器，称之为一个事件；</span><br><span class="line">动作（action）：                         对于特定事件事先定义的处理方法，默认可以发送信息及发送命令；</span><br><span class="line">报警升级（escalation）：         发送警报或执行远程命令的自定义方案，如隔5分钟发送一次警报，共发送5次等。</span><br><span class="line">媒介（media）：                        发送通知的方式，可以支持Mail、SMS、Scripts等；</span><br><span class="line">通知（notification）：               通过设置的媒介向用户发送的有关某事件的信息；</span><br><span class="line">远程命令 ：                                   达到触发器，可以在被监控端执行命令；</span><br><span class="line">模板（template）：                    可以快速监控被监控端，模块包含：item、trigger、graph、screen、application；</span><br><span class="line">web场景（web scennario）       用于检测web站点可用性，监控HTTP关键词；</span><br><span class="line">web前端（frontend）：             Zabbix的web接口；</span><br><span class="line">图形（graph）：                          监控图像；</span><br><span class="line">屏幕（screens）：                       屏幕显示；</span><br><span class="line">幻灯（slide show）：                  幻灯显示</span><br></pre></td></tr></table></figure><h2 id="在WEB界面主机配置的步骤"><a href="#在WEB界面主机配置的步骤" class="headerlink" title="在WEB界面主机配置的步骤"></a>在WEB界面主机配置的步骤</h2><ul><li>创建主机群组(按照项目分类,按照系统类型分类,按照应用类型分类)</li><li>添加主机(注意配置文件参数和web对应)</li><li>创建应用集(或者添加模板)</li><li>添加监控项</li><li>给监控项添加触发器</li><li>设置报警类型(发邮件,打电话,发短信,微信推送,脚本)</li><li>配置用户报警方式</li><li>添加针对触发器指定的动作</li><li>测试</li></ul><h2 id="以监控-etc-passwd为例"><a href="#以监控-etc-passwd为例" class="headerlink" title="以监控/etc/passwd为例"></a>以监控/etc/passwd为例</h2><h3 id="创建主机群组"><a href="#创建主机群组" class="headerlink" title="创建主机群组"></a>创建主机群组</h3><p>点击配置——主机群组——创建主机群组，页面如下</p><p><img src="../../img/2019-05-22_101757.png" alt></p><p>说明：</p><ul><li>每个主机都需要在一个主机群组中，在创建主机时需要指定。</li></ul><h3 id="添加主机"><a href="#添加主机" class="headerlink" title="添加主机"></a>添加主机</h3><ul><li>点击配置——主机——创建主机，页面配置如下</li></ul><p><img src="../../img/2019-05-22_102120.png" alt="2019-05-22_102120"></p><h3 id="创建应用集"><a href="#创建应用集" class="headerlink" title="创建应用集"></a>创建应用集</h3><ul><li>配置——主机——应用集——创建应用集，页面如下</li></ul><p><img src="../../img/2019-05-22_104131.png" alt></p><h3 id="添加监控项"><a href="#添加监控项" class="headerlink" title="添加监控项"></a>添加监控项</h3><ul><li>配置——主机——监控项——创建监控项页，页面配置如下</li></ul><p><img src="../../img/2019-05-22_110610.png" alt></p><ul><li>查看监控是否可以监控到数据，点击检测中——最新数据，页面配置如下</li></ul><p><img src="../../img/2019-05-22_111027.png" alt></p><ul><li>监控到的数据，点击查看</li></ul><p><img src="../../img/2019-05-22_111223.png" alt></p><h3 id="给监控项添加触发器"><a href="#给监控项添加触发器" class="headerlink" title="给监控项添加触发器"></a>给监控项添加触发器</h3><ul><li>配置——主机——触发器——创建触发器，页面配置如下</li></ul><p><img src="../../img/2019-05-22_111829.png" alt></p><p><img src="../../img/2019-05-22_112100.png" alt></p><ul><li>需要验证触发器的正确性，在client端中，修改/etc/passwd文件，看能否触发，点击<strong>监测——仪表板</strong>，问题仪表盘中有<strong>闪烁</strong>项表示触发器<strong>生效</strong>，反之不生效</li></ul><p><img src="../../img/2019-05-22_112344.png" alt></p><h3 id="电子邮件报警"><a href="#电子邮件报警" class="headerlink" title="电子邮件报警"></a>电子邮件报警</h3><p><img src="../../img/TIM%E5%9B%BE%E7%89%8720190522180228.jpg" alt></p><ul><li>先要在服务端安装mailx；</li><li>重新启动postfix服务；</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@server ~]# systemctl restart postfix</span><br></pre></td></tr></table></figure><ul><li>测试手动发送邮件；</li></ul><p><img src="../../img/2019-05-22_112855.png" alt></p><p><img src="../../img/2019-05-22_112728.png" alt></p><ul><li>添加报警媒介内容（可以选择默认的E-mail方式或者手动创建媒介类型）；<ul><li>默认的E-mail方式；</li><li>点击管理——报警媒介类型——选择Email，页面设置如下</li></ul></li></ul><p><img src="../../img/2019-05-22_113721.png" alt></p><ul><li>注：手动添加方式与上图一样，若没有邮箱可用或者邮箱反垃圾系统会将邮件过滤掉可以使用linux系统自带邮箱，设置方法如下图</li></ul><p><img src="../../img/2019-05-22_115821.png" alt></p><ul><li><p>配置用户发送的警告方式</p></li><li><p>管理——用户——选择Admin（或者其他用户）——报警媒介，页面设置如下</p></li></ul><p><img src="../../img/2019-05-22_120335.png" alt></p><ul><li><p>配置触发器的动作</p></li><li><p>点击配置——动作——创建动作，第一页面添加名称,——点击操作，页面如下</p></li></ul><p><img src="../../img/2019-05-22_120935.png" alt></p><ul><li>修改/etc/passwd文件查看验证</li></ul><p><img src="../../img/1558506541852.png" alt="1558506541852"></p><h3 id="脚本报警"><a href="#脚本报警" class="headerlink" title="脚本报警"></a>脚本报警</h3><ul><li>安装mailx</li><li>重启postfix服务</li><li>测试手动发送邮件</li><li>添加告警媒介<ul><li>点击配置——报警媒介类型——创建媒介类型，页面配置如下</li></ul></li></ul><p><img src="../../img/2019-05-22_180501.png" alt></p><ul><li>配置用户的警告方式</li></ul><p><img src="../../img/2019-05-22_181033.png" alt></p><p>点击更新</p><ul><li>配置触发器的动作</li><li>点击配置——动作——创建动作，页面如图一——操作，页面如图二</li></ul><p><img src="../../img/2019-05-22_181310.png" alt></p><ul><li><p>在服务端上写发送告警信息脚本</p></li><li><p>在服务端创建存放脚本的目录并写如下图脚本，将目录以及脚本的属主和属组设置为zabbix，并给脚本执行权限</p></li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@server ~]# mkdir /usr/local/etc/scripts</span><br><span class="line">[root@server scripts]# vim sendmail.sh</span><br><span class="line">#!/bin/bash</span><br><span class="line">subject=$(echo $2 |tr &quot;\r\n&quot; &quot;\n&quot;)</span><br><span class="line">message=$(echo $3 |tr &quot;\r\n&quot; &quot;\n&quot;)</span><br><span class="line">echo &quot;$message&quot; | /usr/bin/mail -s &quot;$subject&quot; $1 &amp;&gt;/tmp/sm.log</span><br><span class="line"></span><br><span class="line">[root@server scripts]# cd ..</span><br><span class="line">[root@server etc]# chown -R zabbix.zabbix scripts</span><br><span class="line">[root@server etc]# chmod +x scripts/sendmail.sh</span><br></pre></td></tr></table></figure><ul><li>修改/usr/local/etc/zabbix_server.conf，修改如下</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AlertScriptsPath=/usr/local/etc/scripts</span><br></pre></td></tr></table></figure><ul><li>重启服务</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@server ~]# pkill zabbix</span><br><span class="line">[root@server ~]# zabbix_server </span><br><span class="line">[root@server ~]# zabbix_agentd </span><br><span class="line">[root@server ~]# ss -ntl</span><br><span class="line">State       Recv-Q Send-Q               Local Address:Port                 Peer Address:Port </span><br><span class="line">LISTEN      0      128                             *:10050                           *:*     </span><br><span class="line">LISTEN      0      128                              *:10051</span><br></pre></td></tr></table></figure><ul><li>修改配置文件查看验证</li></ul><p><img src="../../img/1558521078432.png" alt="1558521078432"></p><p><img src="../../img/1558521155686.png" alt="1558521155686"></p><h3 id="通过zabbix用户发送邮件"><a href="#通过zabbix用户发送邮件" class="headerlink" title="通过zabbix用户发送邮件"></a>通过zabbix用户发送邮件</h3><ul><li>在服务端安装mailx、postfix</li><li>重新启动postfix</li><li>添加邮箱白名单<a href="mailto:zabbix@zabbix.server.com" target="_blank" rel="noopener">zabbix@zabbix.server.com</a></li><li>修改主机名</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# hostnamectl set-hostname zabbix.server.com</span><br></pre></td></tr></table></figure><ul><li>修改/etc/hosts文件,添加如下</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1zabbix.com</span><br></pre></td></tr></table></figure><ul><li>重启postfix服务</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@server etc]# systemctl restart postfix</span><br></pre></td></tr></table></figure><ul><li>添加告警媒介</li></ul><p><img src="../../img/1558523235561.png" alt="02"></p><ul><li>添加告警用户</li></ul><p><img src="../../img/1558523538073.png" alt="1558523538073"></p><ul><li>添加动作</li></ul><p><img src="../../img/1558523604822.png" alt="1558523604822"></p><ul><li>修改配置文件进行验证</li></ul><p><img src="../../img/1558523472639.png" alt="1558523472639"></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;a id=&quot;more&quot;&gt;&lt;/a&gt;



&lt;h2 id=&quot;Zabbix监控组件及流程&quot;&gt;&lt;a href=&quot;#Zabbix监控组件及流程&quot; class=&quot;headerlink&quot; title=&quot;Zabbix监控组件及流程&quot;&gt;&lt;/a&gt;&lt;strong&gt;Zabbix监控组件及流程&lt;/str
      
    
    </summary>
    
      <category term="Linux运维" scheme="http://aiwhs.github.io/categories/Linux%E8%BF%90%E7%BB%B4/"/>
    
    
      <category term="监控服务" scheme="http://aiwhs.github.io/tags/%E7%9B%91%E6%8E%A7%E6%9C%8D%E5%8A%A1/"/>
    
  </entry>
  
  <entry>
    <title>zabbix自定义监控</title>
    <link href="http://aiwhs.github.io/2019/01/05/Zabbix%E7%9A%84%E8%87%AA%E5%AE%9A%E4%B9%89%E7%9B%91%E6%8E%A7/"/>
    <id>http://aiwhs.github.io/2019/01/05/Zabbix的自定义监控/</id>
    <published>2019-01-05T00:15:57.000Z</published>
    <updated>2019-07-17T11:50:13.511Z</updated>
    
    <content type="html"><![CDATA[<a id="more"></a><h3 id="进程和日志"><a href="#进程和日志" class="headerlink" title="进程和日志"></a>进程和日志</h3><ul><li><p>有的时候zabbix提供的监控项目，不能满足我们生产环境下的监控需求，此时我们就要按照zabbix的规范自定义监控项目，达到监控的目的</p></li><li><p>zabbix_get:模拟zabbix_server和agent获取数据</p></li><li><p>相关概念</p></li><li><p>item: Items是从agnet主机里面获取的所有数据。通常情况下我叫itme为监控项,item由key+参数组成</p></li><li><p>Key：我们可以理解为key是item的唯一标识，在agent端有很多监控项，zabbix-server根据key区分不同的监控项</p></li><li><p>trigger：触发器是建立在item数据上的，具有阈值触发事件的功能</p><blockquote><p>  基本格式: :.()}</p><p>  server:agent名称，加入主机时配置的</p><p>  key：就是上面说的key</p><p>  function：对阈值进行操作的函数，以下函数</p><p>  operate：表达式</p><p>  constant：常量</p></blockquote></li></ul><p>例如：{docker02:proc.mysql.last()}&lt;&gt;1</p><ul><li>不用担心trigger表达式不好写，在定义好item后，在zabbix点点就自动生成了</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">zabbix_get -s 192.168.161.67 -k ckproc[postfix]</span><br><span class="line">3</span><br><span class="line"># -s:指定agent地址</span><br><span class="line"># -p：agent端口</span><br><span class="line"># -k：指定item的key</span><br><span class="line"># [postfix]:向脚本传递的参数(用逗号分隔)</span><br></pre></td></tr></table></figure><hr><h4 id="下面以监控postfix服务进程为例，做了自定义监控"><a href="#下面以监控postfix服务进程为例，做了自定义监控" class="headerlink" title="下面以监控postfix服务进程为例，做了自定义监控"></a>下面以监控postfix服务进程为例，做了自定义监控</h4><hr><h3 id="1-zabbix-server与zabbix-agent"><a href="#1-zabbix-server与zabbix-agent" class="headerlink" title="1. zabbix_server与zabbix_agent"></a>1. zabbix_server与zabbix_agent</h3><p><img src="../../img/064b243ede8a779a7b1695560d109dfc_461x224.png" alt="img"></p><ul><li>zabbix_server通过发送key给zabbix_agent,然后agent端口根据key，把所要监控的item的最新数据返回给server端</li></ul><hr><h3 id="2-自定义监控项"><a href="#2-自定义监控项" class="headerlink" title="2. 自定义监控项"></a>2. 自定义监控项</h3><ul><li>自定义脚本格式</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">key[*],[command|sh]</span><br><span class="line"># &lt;key[参数]&gt;，&lt;命令或者脚本&gt;</span><br><span class="line"># [*]：固定格式，表示server端是否传过来参数，在命令或者脚本中用$1,23...引用，shell脚本中的引用$$1,2,3..引用，</span><br><span class="line"># 如果server端不传参数，[*]可以不写</span><br></pre></td></tr></table></figure><h4 id="2-1-修改agent端配置文件，自定义key"><a href="#2-1-修改agent端配置文件，自定义key" class="headerlink" title="2.1 修改agent端配置文件，自定义key"></a>2.1 修改agent端配置文件，自定义key</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/etc/zabbix_agentd.conf</span><br></pre></td></tr></table></figure><ul><li>做以下修改</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">UnsafeUserParameters=1 # 默认为0，表示不允许自定义key</span><br><span class="line"># 监控*进程是否存在，[*]是server端传递参数，是服务名称</span><br><span class="line">UserParameter=ckproc[*],/usr/bin/bash /scripts/proc.sh $1</span><br></pre></td></tr></table></figure><p>然后写脚本</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mkdir /scripts</span><br><span class="line">vim /scripts/proc.sh</span><br><span class="line">#!/bin/bash</span><br><span class="line">proc_count=$(ps -ef|grep -Ev &quot;grep|$0&quot; |grep -c $1)</span><br><span class="line">echo $proc_count</span><br><span class="line">chown -R zabbix.zabbix /scripts/</span><br><span class="line">chmod +x /scripts/*</span><br></pre></td></tr></table></figure><h4 id="2-2-web页面配置，加入自定义监控项"><a href="#2-2-web页面配置，加入自定义监控项" class="headerlink" title="2.2 web页面配置，加入自定义监控项"></a>2.2 web页面配置，加入自定义监控项</h4><p> 1.【配置】-&gt;【主机】,点击所要监控的主机</p><p> 2.点击【监控项】</p><p> 3.点击右上角【创建监控项】</p><p> 4.创建监控项</p><ul><li>这里的key值对应我们在agent端自定义的key</li></ul><p><img src="../../img/2019-05-24_103000.png" alt></p><ul><li>重启agent服务</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pkill zabbix</span><br><span class="line">zabbix_agentd</span><br></pre></td></tr></table></figure><h4 id="2-3-查看返回的数据：【检测中】-gt-【最新数据】"><a href="#2-3-查看返回的数据：【检测中】-gt-【最新数据】" class="headerlink" title="2.3 查看返回的数据：【检测中】-&gt;【最新数据】"></a>2.3 查看返回的数据：【检测中】-&gt;【最新数据】</h4><p>最新数据是zabbix所有监控项的收集的数据的概览，从这可以看到监控项最新的监控值</p><p><img src="../../img/2019-05-24_104141.png" alt></p><blockquote><p>从图中可以看到，postfix监控项返回的数值是3，说明postfix的进程数为3，代表postfix运行正常，如果想要可以邮件报警，可以给这个自定义的添加触发器，参考“Zabbix监控组件及流程”一章</p></blockquote><hr><h4 id="2-4-测试结果"><a href="#2-4-测试结果" class="headerlink" title="2.4 测试结果:"></a>2.4 测试结果:</h4><p><img src="../../img/Screenshot_20190524-104950__01.jpg" alt></p><hr><h4 id="下面是以监控日志，做了自定义监控"><a href="#下面是以监控日志，做了自定义监控" class="headerlink" title="下面是以监控日志，做了自定义监控"></a>下面是以监控日志，做了自定义监控</h4><hr><p>注：监控日志用shell脚本难以实现记录之前已经看过的日志，为了解决这个问题，我们用python来监控</p><ul><li><p>编写Python程序，可以点击<a href="https://github.com/chendao2015/pyscripts/blob/master/log.py" target="_blank" rel="noopener">查看</a></p></li><li><p>说明：第一个参数为日志文件名（必须有，相对路径、绝对路径均可）</p></li><li><p>第二个参数为“记录之前所看位置”的文件路径（可选项，若不设置则默认为/tmp/logseek文件。相对路径、绝对路径均可）</p></li><li><p>第三个参数为搜索关键字，默认为 Error</p></li><li><p>将脚本文件下载后上传到/scripts/目录下，将文件赋予执行权限并将属主和属组改为zabbix</p></li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line">放脚本路径和上一个例子一样,如果不做上一个例子,自行创建目录,更改属主属组</span><br><span class="line">vim /scripts/log.py</span><br><span class="line">#!/usr/bin/env python3</span><br><span class="line">import sys</span><br><span class="line">import re</span><br><span class="line"></span><br><span class="line">def prePos(seekfile):</span><br><span class="line">    global curpos</span><br><span class="line">    try:</span><br><span class="line">        cf = open(seekfile)</span><br><span class="line">    except IOError:</span><br><span class="line">        curpos = 0</span><br><span class="line">        return curpos</span><br><span class="line">    except FileNotFoundError:</span><br><span class="line">        curpos = 0</span><br><span class="line">        return curpos</span><br><span class="line">    else:</span><br><span class="line">        try:</span><br><span class="line">            curpos = int(cf.readline().strip())</span><br><span class="line">        except ValueError:</span><br><span class="line">            curpos = 0</span><br><span class="line">            cf.close()</span><br><span class="line">            return curpos</span><br><span class="line">        cf.close()</span><br><span class="line">    return curpos</span><br><span class="line"></span><br><span class="line">def lastPos(filename):</span><br><span class="line">    with open(filename) as lfile:</span><br><span class="line">        if lfile.readline():</span><br><span class="line">            lfile.seek(0,2)</span><br><span class="line">        else:</span><br><span class="line">            return 0</span><br><span class="line">        lastPos = lfile.tell()</span><br><span class="line">    return lastPos</span><br><span class="line"></span><br><span class="line">def getSeekFile():</span><br><span class="line">    try:</span><br><span class="line">        seekfile = sys.argv[2]</span><br><span class="line">    except IndexError:</span><br><span class="line">        seekfile = &apos;/tmp/logseek&apos;</span><br><span class="line">    return seekfile</span><br><span class="line"></span><br><span class="line">def getKey():</span><br><span class="line">    try:</span><br><span class="line">        tagKey = str(sys.argv[3])</span><br><span class="line">    except IndexError:</span><br><span class="line">        tagKey = &apos;Error&apos;</span><br><span class="line">    return tagKey</span><br><span class="line"></span><br><span class="line">def getResult(filename,seekfile,tagkey):</span><br><span class="line">    destPos = prePos(seekfile)</span><br><span class="line">    curPos = lastPos(filename)</span><br><span class="line"></span><br><span class="line">    if curPos &lt; destPos:</span><br><span class="line">        curpos = 0</span><br><span class="line"></span><br><span class="line">    try:</span><br><span class="line">        f = open(filename)</span><br><span class="line">    except IOError:</span><br><span class="line">        print(&apos;Could not open file: %s&apos; % filename)</span><br><span class="line">    except FileNotFoundError:</span><br><span class="line">        print(&apos;Could not open file: %s&apos; % filename)</span><br><span class="line">    else:</span><br><span class="line">        f.seek(destPos)</span><br><span class="line"></span><br><span class="line">        while curPos != 0 and f.tell() &lt; curPos:</span><br><span class="line">            rresult = f.readline().strip()</span><br><span class="line">            global result</span><br><span class="line">            if re.search(tagkey, rresult):</span><br><span class="line">                result = 1</span><br><span class="line">                break</span><br><span class="line">            else:</span><br><span class="line">                result = 0</span><br><span class="line"></span><br><span class="line">        with open(seekfile,&apos;w&apos;) as sf:</span><br><span class="line">            sf.write(str(curPos))</span><br><span class="line">    finally:</span><br><span class="line">        f.close()</span><br><span class="line">    return result</span><br><span class="line"></span><br><span class="line">if __name__ == &quot;__main__&quot;:</span><br><span class="line">    result = 0</span><br><span class="line">    curpos = 0</span><br><span class="line">    tagkey = getKey()</span><br><span class="line">    seekfile = getSeekFile()</span><br><span class="line">    result = getResult(sys.argv[1],seekfile,tagkey)</span><br><span class="line">    print(result)</span><br><span class="line"></span><br><span class="line">chmod +x /scripts/log.py</span><br><span class="line">chown zabbix.zabbix log.py</span><br></pre></td></tr></table></figure><ul><li>修改客户端/usr/locla/etc/zabbix_agentd.conf文件</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">UnsafeUserParameters=1</span><br><span class="line">UserParameter=cklog[*],/usr/bin/python /scripts/log.py $1 $2 $3</span><br></pre></td></tr></table></figure><ul><li>创建日志文件（有，则不需要创建），创建存放读取记录的目录并设置属主和属组为zabbix</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;&gt; /tmp/zabbix_agentd.log &lt;&lt; EOF</span><br><span class="line">sklfs</span><br><span class="line">sfkfnkslf</span><br><span class="line">error</span><br><span class="line">errorksdm</span><br><span class="line">Error</span><br><span class="line">failed</span><br><span class="line">failed</span><br><span class="line">whs</span><br><span class="line">itwhs</span><br><span class="line">qwszc</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><ul><li>重新启动服务</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pkill zabbix</span><br><span class="line">zabbix_agentd</span><br></pre></td></tr></table></figure><ul><li>在服务端手动执行脚本</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">zabbix_get -s 192.168.161.67 -k cklog[/tmp/zabbix_agentd.log,/tmp/itwhs,failed]</span><br><span class="line">1</span><br></pre></td></tr></table></figure><ul><li>添加主机监控项</li></ul><p><img src="../../img/2019-05-24_114655.png" alt></p><ul><li>给监控项添加触发器</li></ul><p><img src="../../img/2019-05-24_115026.png" alt></p><ul><li>添加报警媒(介参考“Zabbix监控组件及流程”一章)</li><li>添加用户报警类型(介参考“Zabbix监控组件及流程”一章)</li><li>添加动作(介参考“Zabbix监控组件及流程”一章)</li></ul><p>测试结果:</p><p><img src="../../img/2019-05-24_114150.png" alt></p><p><img src="../../img/Screenshot_20190524-114340__01.jpg" alt></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;a id=&quot;more&quot;&gt;&lt;/a&gt;



&lt;h3 id=&quot;进程和日志&quot;&gt;&lt;a href=&quot;#进程和日志&quot; class=&quot;headerlink&quot; title=&quot;进程和日志&quot;&gt;&lt;/a&gt;进程和日志&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;&lt;p&gt;有的时候zabbix提供的监控项目，不能满足我们生产环境
      
    
    </summary>
    
      <category term="Linux运维" scheme="http://aiwhs.github.io/categories/Linux%E8%BF%90%E7%BB%B4/"/>
    
    
      <category term="监控服务" scheme="http://aiwhs.github.io/tags/%E7%9B%91%E6%8E%A7%E6%9C%8D%E5%8A%A1/"/>
    
  </entry>
  
  <entry>
    <title>zabbix部署</title>
    <link href="http://aiwhs.github.io/2018/12/30/%E9%83%A8%E7%BD%B2zabbix%E7%9B%91%E6%8E%A7%E6%9C%8D%E5%8A%A1/"/>
    <id>http://aiwhs.github.io/2018/12/30/部署zabbix监控服务/</id>
    <published>2018-12-30T00:15:57.000Z</published>
    <updated>2019-07-17T11:43:14.464Z</updated>
    
    <content type="html"><![CDATA[<a id="more"></a><h2 id="1-zabbix介绍"><a href="#1-zabbix介绍" class="headerlink" title="1. zabbix介绍"></a>1. zabbix介绍</h2><p><code>zabbix</code>是一个基于WEB界面的提供分布式系统监视以及网络监视功能的企业级的开源解决方案。</p><p><code>zabbix</code>能监视各种网络参数，保证服务器系统的安全运营；并提供灵活的通知机制以让系统管理员快速定位/解决存在的各种问题。</p><p><code>zabbix</code>由2部分构成，<code>zabbix server</code>与可选组件<code>zabbix agent</code>。</p><p><code>zabbix server</code>可以通过<code>SNMP</code>，<code>zabbix agent</code>，<code>ping</code>，端口监视等方法提供对远程服务器/网络状态的监视，数据收集等功能，它可以运行在Linux，Ubuntu，Solaris，HP-UX，AIX，Free BSD，Open BSD，OS X等平台上。</p><p><code>zabbix agent</code>需要安装在被监视的目标服务器上，它主要完成对硬件信息或与操作系统有关的内存，CPU等信息的收集。</p><p><code>zabbix server</code>可以单独监视远程服务器的服务状态；同时也可以与<code>zabbix agent</code>配合，可以轮询<code>zabbix agent</code>主动接收监视数据（agent方式），同时还可被动接收<code>zabbix agent</code>发送的数据（trapping方式）。<br>另外<code>zabbix server</code>还支持SNMP (v1,v2)，可以与SNMP软件(例如：net-snmp)等配合使用。</p><h2 id="2-什么是zabbix及优缺点（对比cacti和nagios）"><a href="#2-什么是zabbix及优缺点（对比cacti和nagios）" class="headerlink" title="2.什么是zabbix及优缺点（对比cacti和nagios）"></a>2.什么是zabbix及优缺点（对比cacti和nagios）</h2><p>Zabbix能监视各种网络参数，保证服务器系统的安全运营；并提供灵活的通知机制以让系统管理员快速定位/解决存在的各种问题。是一个基于WEB界面的提供分布式系统监视以及网络监视功能的企业级的开源解决方案。</p><ul><li><p>agent端：主机通过安装agent方式采集数据。</p></li><li><p>server端：通过收集agent发送的数据，写入数据库（MySQL，ORACLE等），再通过php+apache在web前端展示.</p></li><li><p>zabbix = cacti + nagios</p></li><li><p>优点：基于两款工具优点于一身并更强大，实现企业级分布式监控。</p></li><li><p>缺点：2.2版本带宽占用大但是升级到2.4版本后更节省了带宽资源，其它再无发现。</p></li></ul><h2 id="3-zabbix特点"><a href="#3-zabbix特点" class="headerlink" title="3. zabbix特点"></a>3. zabbix特点</h2><p>zabbix的主要特点：</p><ul><li>安装与配置简单，学习成本低</li><li>支持多语言（包括中文）</li><li>免费开源</li><li>自动发现服务器与网络设备</li><li>分布式监视以及WEB集中管理功能</li><li>可以无agent监视</li><li>用户安全认证和柔软的授权方式</li><li>通过WEB界面设置或查看监视结果</li><li>email等通知功能</li></ul><p>Zabbix主要功能：</p><ul><li>CPU负荷</li><li>内存使用</li><li>磁盘使用</li><li>网络状况</li><li>端口监视</li><li>日志监视</li></ul><h2 id="4-工作原理"><a href="#4-工作原理" class="headerlink" title="4.工作原理"></a>4.工作原理</h2><p>一个监控系统运行的大概的流程是这样的：</p><p>zabbix agent需要安装到被监控的主机上，它负责定期收集各项数据，并发送到zabbix server端，zabbix server将数据存储到数据库中，zabbix web根据数据在前端进行展现和绘图。这里agent收集数据分为主动和被动两种模式：</p><p>主动：agent请求server获取主动的监控项列表，并主动将监控项内需要检测的数据提交给server/proxy</p><p>被动：server向agent请求获取监控项的数据，agent返回数据。</p><h3 id="5-zabbix的组件及进程"><a href="#5-zabbix的组件及进程" class="headerlink" title="5.zabbix的组件及进程"></a>5.zabbix的组件及进程</h3><h4 id="1：重要组件"><a href="#1：重要组件" class="headerlink" title="1：重要组件"></a>1：重要组件</h4><p>zabbix由以下几个组件部分构成：</p><ol><li>Zabbix Server：负责接收agent发送的报告信息的核心组件，所有配置，统计数据及操作数据均由其组织进行；</li><li>Database Storage：专用于存储所有配置信息，以及由zabbix收集的数据；</li><li>Web interface：zabbix的GUI接口，通常与Server运行在同一台主机上；</li><li>Proxy：可选组件，常用于分布监控环境中，代理Server收集部分被监控端的监控数据并统一发往Server端；</li><li>Agent：部署在被监控主机上，负责收集本地数据并发往Server端或Proxy端；</li></ol><p>注：zabbix node也是 zabbix server的一种 。</p><h4 id="2：常见进程"><a href="#2：常见进程" class="headerlink" title="2：常见进程"></a>2：常见进程</h4><p>默认情况下zabbix包含5个程序：zabbix_agentd、zabbix_get、zabbix_proxy、zabbix_sender、zabbix_server，另外一个zabbix_java_gateway是可选，这个需要另外安装。下面来分别介绍下他们各自的作用。</p><h5 id="（1）zabbix-agentd："><a href="#（1）zabbix-agentd：" class="headerlink" title="（1）zabbix_agentd："></a>（1）zabbix_agentd：</h5><p>客户端守护进程，此进程收集客户端数据，例如cpu负载、内存、硬盘使用情况等。</p><h5 id="（2）zabbix-get"><a href="#（2）zabbix-get" class="headerlink" title="（2）zabbix_get"></a>（2）zabbix_get</h5><p>zabbix工具，单独使用的命令，通常在server或者proxy端执行获取远程客户端信息的命令。通常用户排错。例如在server端获取不到客户端的内存数据，我们可以使用zabbix_get获取客户端的内容的方式来做故障排查。</p><h5 id="（3）zabbix-sender"><a href="#（3）zabbix-sender" class="headerlink" title="（3）zabbix_sender"></a>（3）zabbix_sender</h5><p>zabbix工具，用于发送数据给server或者proxy，通常用于耗时比较长的检查。很多检查非常耗时间，导致zabbix超时。于是我们在脚本执行完毕之后，使用sender主动提交数据。</p><h5 id="（4）zabbix-server"><a href="#（4）zabbix-server" class="headerlink" title="（4）zabbix_server"></a>（4）zabbix_server</h5><p>zabbix服务端守护进程。zabbix_agentd、zabbix_get、zabbix_sender、zabbix_proxy、zabbix_java_gateway的数据最终都是提交到server</p><p>备注：当然不是数据都是主动提交给zabbix_server,也有的是server主动去取数据。</p><h5 id="（5）zabbix-proxy"><a href="#（5）zabbix-proxy" class="headerlink" title="（5）zabbix_proxy"></a>（5）zabbix_proxy</h5><p>zabbix代理守护进程。功能类似server，唯一不同的是它只是一个中转站，它需要把收集到的数据提交/被提交到server里。为什么要用代理？代理是做什么的？卖个关子，请继续关注运维生存时间zabbix教程系列。</p><h5 id="（6）zabbix-java-gateway"><a href="#（6）zabbix-java-gateway" class="headerlink" title="（6）zabbix_java_gateway"></a>（6）zabbix_java_gateway</h5><p>zabbix2.0之后引入的一个功能。顾名思义：Java网关，类似agentd，但是只用于Java方面。需要特别注意的是，它只能主动去获取数据，而不能被动获取数据。它的数据最终会给到server或者proxy。</p><h2 id="6-zabbix监控环境中基本概念"><a href="#6-zabbix监控环境中基本概念" class="headerlink" title="6.zabbix监控环境中基本概念"></a>6.zabbix监控环境中基本概念</h2><ol><li>主机（host）：要监控的网络设备，可由IP或DNS名称指定；</li><li>主机组（host group）：主机的逻辑容器，可以包含主机和模板，但同一个组织内的主机和模板不能互相链接；主机组通常在给用户或用户组指派监控权限时使用；</li><li>监控项（item）：一个特定监控指标的相关的数据；这些数据来自于被监控对象；item是zabbix进行数据收集的核心，相对某个监控对象，每个item都由”key”标识；</li><li>触发器（trigger）：一个表达式，用于评估某监控对象的特定item内接收到的数据是否在合理范围内，也就是阈值；接收的数据量大于阈值时，触发器状态将从”OK”转变为”Problem”，当数据再次恢复到合理范围，又转变为”OK”；</li><li>事件（event）：触发一个值得关注的事情，比如触发器状态转变，新的agent或重新上线的agent的自动注册等；</li><li>动作（action）：指对于特定事件事先定义的处理方法，如发送通知，何时执行操作；</li><li>报警升级（escalation）：发送警报或者执行远程命令的自定义方案，如每隔5分钟发送一次警报，共发送5次等；</li><li>媒介（media）：发送通知的手段或者通道，如Email、Jabber或者SMS等；</li><li>通知（notification）：通过选定的媒介向用户发送的有关某事件的信息；</li><li>远程命令（remote command）：预定义的命令，可在被监控主机处于某特定条件下时自动执行；</li><li>模板（template）：用于快速定义被监控主机的预设条目集合，通常包含了item、trigger、graph、screen、appication以及low-level discovery rule；模板可以直接链接至某个主机；</li><li>应用（application）：一组item的集合；</li><li>web场景（web scennario）：用于检测web站点可用性的一个活多个HTTP请求；</li><li>前端（frontend）：Zabbix的web接口；</li></ol><h2 id="7-zabbix的监控架构"><a href="#7-zabbix的监控架构" class="headerlink" title="7.zabbix的监控架构"></a>7.zabbix的监控架构</h2><p>在实际监控架构中，zabbix根据网络环境、监控规模等 分了三种架构： server-client 、master-node-client、server-proxy-client三种 。</p><h4 id="1：server-client架构"><a href="#1：server-client架构" class="headerlink" title="1：server-client架构"></a>1：server-client架构</h4><p>也是zabbix的最简单的架构，监控机和被监控机之间不经过任何代理 ，直接由zabbix server和zabbix agentd之间进行数据交互。适用于网络比较简单，设备比较少的监控环境 。</p><h4 id="2：server-proxy-client架构"><a href="#2：server-proxy-client架构" class="headerlink" title="2：server-proxy-client架构"></a>2：server-proxy-client架构</h4><p>其中proxy是server、client之间沟通的一个桥梁，proxy本身没有前端，而且其本身并不存放数据，只是将agentd发来的数据暂时存放，而后再提交给server 。该架构经常是和master-node-client架构做比较的架构 ，一般适用于跨机房、跨网络的中型网络架构的监控。</p><h4 id="3：master-node-client架构"><a href="#3：master-node-client架构" class="headerlink" title="3：master-node-client架构"></a>3：master-node-client架构</h4><p>该架构是zabbix最复杂的监控架构，适用于跨网络、跨机房、设备较多的大型环境 。每个node同时也是一个server端，node下面可以接proxy，也可以直接接client 。node有自已的配置文件和数据库，其要做的是将配置信息和监控数据向master同步，master的故障或损坏对node其下架构的完整性。</p><p>其实zabbix做的还是挺人性化的，给了我们下载地址：<a href="http://repo.zabbix.com/" target="_blank" rel="noopener">http://repo.zabbix.com/</a> 里面可以选很多版本，但这里就给大家提供一个目前最新版本4.2的部署及添加客户端方式。</p><h2 id="8-zabbix配置文件"><a href="#8-zabbix配置文件" class="headerlink" title="8. zabbix配置文件"></a>8. zabbix配置文件</h2><p>zabbix配置文件有两种：</p><ul><li>服务器端配置文件(/usr/local/etc/zabbix_server.conf)</li><li>客户端配置文件(/usr/local/etc/zabbix_agentd.conf)</li><li>zabbix代理配置文件(/usr/local/etc/zabbix_proxy.conf)</li></ul><p><strong>服务器端配置文件zabbix_server.conf常用配置参数：</strong></p><table><thead><tr><th align="left">参数</th><th align="left">作用</th></tr></thead><tbody><tr><td align="left">LogFile</td><td align="left">设置服务端日志文件存放路径</td></tr><tr><td align="left">ListenIP</td><td align="left">设置服务端监听IP</td></tr><tr><td align="left">ListenPort</td><td align="left">设置服务端监听的端口号</td></tr><tr><td align="left">PidFile</td><td align="left">设置服务端进程号文件存放路径</td></tr><tr><td align="left">DBHost</td><td align="left">指定zabbix的数据库服务器IP</td></tr><tr><td align="left">DBName</td><td align="left">指定zabbix使用的数据库库名</td></tr><tr><td align="left">DBUser</td><td align="left">指定zabbix数据库登录用户</td></tr><tr><td align="left">DBPassword</td><td align="left">指定zabbix数据库登录密码</td></tr><tr><td align="left">DBPort</td><td align="left">指定zabbix数据库端口号</td></tr><tr><td align="left">User</td><td align="left">设置zabbix以什么用户的身份运行</td></tr><tr><td align="left">AlertScriptsPath</td><td align="left">设置告警脚本存放路径</td></tr><tr><td align="left">ExternalScripts</td><td align="left">外部脚本存放路径</td></tr></tbody></table><p><strong>客户端配置文件zabbix_agentd.conf常用配置参数：</strong></p><p>如果是默认值，可以不用声明，即不要删除注释，需要更改特殊值时才修改，下面为了讲解，每个选项基本都取消注释了，但是有注明默认值是多少的</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">LogFile=/usr/local/zabbix/log/zabbix_agentd.log    #日志</span><br><span class="line"></span><br><span class="line">Server=10.10.88.20    # zabbix server IP，此种表示被动监听。可以有多个IP，以逗号分隔，如 Server=123.56.178.128,192.168.0.41</span><br><span class="line"></span><br><span class="line">ListenPort=10050    # agent 监听端口。默认也是10050</span><br><span class="line"></span><br><span class="line">ListenIP=0.0.0.0    # agent监听的网络接口。0.0.0.0表示监听所有IP</span><br><span class="line"></span><br><span class="line">StartAgents=3    #处理被动检查的预启动的zabbix_agent进程。默认值为3</span><br><span class="line"></span><br><span class="line">ServerActive=10.10.88.20:10051    #主动模式。主动检查zabbix server的端口，如果没有指明端口，则默认为10051</span><br><span class="line"></span><br><span class="line">Hostname=slave2    # 该项需要主动检查，并且必须与服务器上服务器上配置的主机名一致。如果未定义，则从HostnameItem获取值。</span><br><span class="line"> How often list of active checks is refreshed, in seconds.</span><br><span class="line"></span><br><span class="line">RefreshActiveChecks=120    # 主动模式下，agent主动检查监控项的刷新频率（隔多久从server获取一次item），单位s，默认120s</span><br><span class="line"></span><br><span class="line">BufferSend=5    #数据在缓冲区的保留时间。默认只保留5秒</span><br><span class="line"></span><br><span class="line">BufferSize=100    #内存缓冲区中的最大值。 如果缓冲区已满，代理将发送所有收集的数据到Zabbix Server或Proxy。默认值为100</span><br><span class="line"></span><br><span class="line">Timeout=30    # 处理超时时间。默认30秒为超时</span><br><span class="line"></span><br><span class="line">AllowRoot=0    # 是否允许agent以 root用户运行。0表示不允许，1表示允许，默认值为0</span><br><span class="line"></span><br><span class="line">User=zabbix    #</span><br><span class="line"></span><br><span class="line">Include=xxx    # 包含的配置文件，默认没有值。如Include=/usr/local/etc/zabbix_agentd.conf.d/*.conf</span><br><span class="line"></span><br><span class="line">UserParameter=xxx    # 用户自定义监控项，即自定义key。如</span><br></pre></td></tr></table></figure><h2 id="9-部署zabbix"><a href="#9-部署zabbix" class="headerlink" title="9. 部署zabbix"></a>9. 部署zabbix</h2><p><strong>环境说明：</strong></p><table><thead><tr><th align="left">环境</th><th align="left">IP</th><th align="left">要安装的应用</th></tr></thead><tbody><tr><td align="left">服务器</td><td align="left">192.168.161.130</td><td align="left">lamp架构 <br>zabbix server<br> zabbix agent</td></tr><tr><td align="left">客户端</td><td align="left">192.168.161.167</td><td align="left">zabbix agent</td></tr></tbody></table><p><strong>因为zabbix是用php语言开发的，所以必须先部署lamp架构，使其能够支持运行php网页</strong></p><h3 id="9-1-zabbix服务端安装"><a href="#9-1-zabbix服务端安装" class="headerlink" title="9.1 zabbix服务端安装"></a>9.1 zabbix服务端安装</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">安装依赖包</span><br><span class="line">[root@localhost ~]# yum -y install net-snmp-devel libevent-devel libxml2-devel curl-devel pcre*</span><br><span class="line"></span><br><span class="line">下载zabbix</span><br><span class="line">[root@localhost ~]# cd /usr/src/</span><br><span class="line">[root@localhost src]# wget https://nchc.dl.sourceforge.net/project/zabbix/ZABBIX%20Latest%20Stable/4.2.1/zabbix-4.2.1.tar.gz</span><br><span class="line">--2019-05-16 14:25:00--  https://nchc.dl.sourceforge.net/project/zabbix/ZABBIX%20Latest%20Stable/4.2.1/zabbix-4.2.1.tar.gz</span><br><span class="line">正在解析主机 nchc.dl.sourceforge.net (nchc.dl.sourceforge.net)... 211.79.60.17, 2001:e10:ffff:1f02::17</span><br><span class="line">正在连接 nchc.dl.sourceforge.net (nchc.dl.sourceforge.net)|211.79.60.17|:443... 已连接。</span><br><span class="line">已发出 HTTP 请求，正在等待回应... 200 OK</span><br><span class="line">长度：18284589 (17M) [application/x-gzip]</span><br><span class="line">正在保存至: “zabbix-4.2.1.tar.gz”</span><br><span class="line">    [                         &lt;=&gt;               ] 16,789,873   327KB/s 用时 57s    </span><br><span class="line">2019-05-16 13:45:44 (287 KB/s) - “zabbix-4.2.1.tar.gz” 已保存 [16789873]</span><br><span class="line"></span><br><span class="line">解压</span><br><span class="line">[root@localhost src]# tar xf zabbix-4.2.1.tar.gz</span><br><span class="line"></span><br><span class="line">创建zabbix用户和组</span><br><span class="line">[root@localhost ~]# groupadd -r zabbix</span><br><span class="line">[root@localhost ~]# useradd -r -g zabbix -M -s /sbin/nologin zabbix</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">配置zabbix数据库</span><br><span class="line">[root@localhost ~]# mysql -uroot -pjbgsn123!</span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 2</span><br><span class="line">Server version: 5.7.22 MySQL Community Server (GPL)</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2018, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type &apos;help;&apos; or &apos;\h&apos; for help. Type &apos;\c&apos; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">mysql&gt; create database zabbix character set utf8 collate utf8_bin;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; grant all privileges on zabbix.* to zabbix@localhost identified by &apos;zabbix123!&apos;;</span><br><span class="line">Query OK, 0 rows affected, 2 warnings (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; flush privileges;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; exit</span><br><span class="line">Bye</span><br><span class="line">[root@localhost ~]# cd /usr/src/zabbix-4.2.1/database/mysql/</span><br><span class="line">[root@localhost mysql]# ls</span><br><span class="line">data.sql  images.sql  Makefile.am  Makefile.in  schema.sql</span><br><span class="line">[root@localhost mysql]# mysql -uzabbix -pzabbix123! zabbix &lt; schema.sql</span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">[root@localhost mysql]# mysql -uzabbix -pzabbix123! zabbix &lt; images.sql</span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">[root@localhost mysql]# mysql -uzabbix -pzabbix123! zabbix &lt; data.sql</span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">编译安装zabbix</span><br><span class="line">[root@localhost ~]# cd /usr/src/zabbix-4.2.1    </span><br><span class="line">[root@localhost zabbix-4.2.1]# ./configure --enable-server --enable-agent --with-mysql --with-net-snmp --with-libcurl --with-libxml2</span><br><span class="line"></span><br><span class="line">[root@localhost zabbix-4.2.1]# make install</span><br></pre></td></tr></table></figure><h3 id="9-2-zabbix服务端配置"><a href="#9-2-zabbix服务端配置" class="headerlink" title="9.2 zabbix服务端配置"></a>9.2 zabbix服务端配置</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# ls /usr/local/etc/</span><br><span class="line">zabbix_agentd.conf  zabbix_agentd.conf.d  zabbix_server.conf  zabbix_server.conf.d</span><br><span class="line"></span><br><span class="line">修改服务端配置文件</span><br><span class="line">设置数据库信息</span><br><span class="line">[root@localhost ~]# vim /usr/local/etc/zabbix_server.conf</span><br><span class="line">....</span><br><span class="line">DBPassword=zabbix123!       //设置zabbix数据库连接密码</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">启动zabbix_server和zabbix_agentd</span><br><span class="line">[root@localhost ~]# zabbix_server</span><br><span class="line">[root@localhost ~]# zabbix_agentd</span><br><span class="line">[root@localhost ~]# ss -antl</span><br><span class="line">State       Recv-Q Send-Q Local Address:Port               Peer Address:Port              </span><br><span class="line">LISTEN      0      128     127.0.0.1:9000                        *:*                  </span><br><span class="line">LISTEN      0      128             *:22                          *:*                  </span><br><span class="line">LISTEN      0      100     127.0.0.1:25                          *:*                  </span><br><span class="line">LISTEN      0      128             *:10050                       *:*                  </span><br><span class="line">LISTEN      0      128             *:10051                       *:*                  </span><br><span class="line">LISTEN      0      80             :::3306                       :::*                  </span><br><span class="line">LISTEN      0      128            :::80                         :::*                  </span><br><span class="line">LISTEN      0      128            :::22                         :::*                  </span><br><span class="line">LISTEN      0      100           ::1:25                         :::*</span><br></pre></td></tr></table></figure><h3 id="9-3-zabbix服务端web界面安装与配置"><a href="#9-3-zabbix服务端web界面安装与配置" class="headerlink" title="9.3 zabbix服务端web界面安装与配置"></a>9.3 zabbix服务端web界面安装与配置</h3><h4 id="9-3-1-zabbix-web界面安装前配置"><a href="#9-3-1-zabbix-web界面安装前配置" class="headerlink" title="9.3.1 zabbix web界面安装前配置"></a>9.3.1 zabbix web界面安装前配置</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">修改/etc/php.ini的配置并重启php-fpm</span><br><span class="line">[root@localhost ~]# sed -ri &apos;s/(post_max_size =).*/\1 16M/g&apos; /etc/php.ini</span><br><span class="line">[root@localhost ~]# sed -ri &apos;s/(max_execution_time =).*/\1 300/g&apos; /etc/php.ini</span><br><span class="line">[root@localhost ~]# sed -ri &apos;s/(max_input_time =).*/\1 300/g&apos; /etc/php.ini</span><br><span class="line">[root@localhost ~]# sed -i &apos;/;date.timezone/a date.timezone = Asia/Shanghai&apos; /etc/php.ini</span><br><span class="line">[root@localhost ~]# service php-fpm restart</span><br><span class="line">Gracefully shutting down php-fpm . done</span><br><span class="line">Starting php-fpm  done</span><br><span class="line"></span><br><span class="line">[root@localhost ~]# cd /usr/src/zabbix-4.2.1</span><br><span class="line">[root@localhost zabbix-4.2.1]# ls</span><br><span class="line">aclocal.m4  compile        config.sub    depcomp     m4           misc     src</span><br><span class="line">AUTHORS     conf           configure     frontends   Makefile     missing</span><br><span class="line">bin         config.guess   configure.ac  include     Makefile.am  NEWS</span><br><span class="line">build       config.log     COPYING       INSTALL     Makefile.in  README</span><br><span class="line">ChangeLog   config.status  database      install-sh  man          sass</span><br><span class="line">[root@localhost zabbix-4.2.1]# mkdir /usr/local/apache/htdocs/zabbix</span><br><span class="line">[root@localhost zabbix-4.2.1]# cp -a frontends/php/* /usr/local/apache/htdocs/zabbix/</span><br><span class="line">[root@localhost zabbix-4.2.1]# groupadd -r apache</span><br><span class="line">[root@localhost zabbix-4.2.1]# useradd -r -g apache -M -s /sbin/nologin apache</span><br><span class="line">[root@localhost zabbix-4.2.1]# chown -R apache.apache /usr/local/apache/htdocs</span><br><span class="line"></span><br><span class="line">配置apache虚拟主机</span><br><span class="line">[root@localhost ~]# vim /etc/httpd/httpd.conf</span><br><span class="line">在配置文件的末尾加如下内容</span><br><span class="line">ServerName zabbix.wenhs.com:80</span><br><span class="line">&lt;VirtualHost *:80&gt;</span><br><span class="line">    DocumentRoot &quot;/usr/local/apache/htdocs/zabbix&quot;</span><br><span class="line">    ServerName zabbix.wenhs.com</span><br><span class="line">    ProxyRequests Off</span><br><span class="line">    ProxyPassMatch ^/(.*\.php)$ fcgi://127.0.0.1:9000/usr/local/apache/htdocs/zabbix/$1</span><br><span class="line">    &lt;Directory &quot;/usr/local/apache/htdocs/zabbix&quot;&gt;</span><br><span class="line">        Options none</span><br><span class="line">        AllowOverride none</span><br><span class="line">        Require all granted</span><br><span class="line">    &lt;/Directory&gt;</span><br><span class="line">&lt;/VirtualHost&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">设置zabbix/conf目录的权限，让zabbix有权限生成配置文件zabbix.conf.php</span><br><span class="line">[root@localhost ~]# chmod 777 /usr/local/apache/htdocs/zabbix/conf</span><br><span class="line">[root@localhost ~]# ll -d /usr/local/apache/htdocs/zabbix/conf</span><br><span class="line">drwxrwsrwx 2 apache apache 81 4月  18 17:26 /usr/local/apache/htdocs/zabbix/conf</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">重启apache</span><br><span class="line">[root@localhost ~]# apachectl -t</span><br><span class="line">Syntax OK</span><br><span class="line">[root@localhost ~]# apachectl stop</span><br><span class="line">[root@localhost ~]# apachectl start</span><br><span class="line">[root@localhost ~]# ss -antl</span><br><span class="line">State       Recv-Q Send-Q Local Address:Port               Peer Address:Port              </span><br><span class="line">LISTEN      0      128     127.0.0.1:9000                        *:*                  </span><br><span class="line">LISTEN      0      128             *:22                          *:*                  </span><br><span class="line">LISTEN      0      100     127.0.0.1:25                          *:*                  </span><br><span class="line">LISTEN      0      128             *:10050                       *:*                  </span><br><span class="line">LISTEN      0      128             *:10051                       *:*                  </span><br><span class="line">LISTEN      0      80             :::3306                       :::*                  </span><br><span class="line">LISTEN      0      128            :::80                         :::*                  </span><br><span class="line">LISTEN      0      128            :::22                         :::*                  </span><br><span class="line">LISTEN      0      100           ::1:25                         :::*</span><br></pre></td></tr></table></figure><h4 id="9-3-2-安装zabbix-web界面"><a href="#9-3-2-安装zabbix-web界面" class="headerlink" title="9.3.2 安装zabbix web界面"></a>9.3.2 安装zabbix web界面</h4><ul><li>修改/etc/hosts文件，添加域名与IP的映射</li><li>在浏览器上访问域名，本文设置的域名为zabbix.wenhs.com，你需要修改成你自己的域名</li><li>恢复zabbix/conf目录的权限为755</li></ul><p>在浏览器上访问域名进行安装：</p><p><img src="../../img/1557990954228.png" alt="img1"></p><p><img src="../../img/1557991001839.png" alt="img2"></p><p><img src="../../img/1557991134277.png" alt="img3"></p><p><img src="../../img/1557991230631.png" alt="img4"></p><p><img src="../../img/1557991264039.png" alt="img5"></p><p><img src="../../img/1557991290886.png" alt="img6"></p><p><img src="../../img/1557991341715.png" alt="img6"></p><p>恢复zabbix/conf目录的权限为755：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# chmod 755 /usr/local/apache/htdocs/zabbix/conf</span><br><span class="line">[root@localhost ~]# ll -d /usr/local/apache/htdocs/zabbix/conf</span><br><span class="line">drwxr-sr-x 2 apache apache 104 5月  16 15:21 /usr/local/apache/htdocs/zabbix/conf</span><br></pre></td></tr></table></figure><h3 id="9-4-登录zabbix"><a href="#9-4-登录zabbix" class="headerlink" title="9.4 登录zabbix"></a>9.4 登录zabbix</h3><p><strong>zabbix默认登录用户名和密码：</strong></p><table><thead><tr><th align="left">用户名</th><th align="left">密码</th></tr></thead><tbody><tr><td align="left">Admin</td><td align="left">zabbix</td></tr></tbody></table><h2 id="10-汉化zabbix"><a href="#10-汉化zabbix" class="headerlink" title="10.汉化zabbix"></a>10.汉化zabbix</h2><h5 id="zabbix-自带多种语言包，也包括中文。登陆zabbix-web控制台默认是英文，可切换中文版本"><a href="#zabbix-自带多种语言包，也包括中文。登陆zabbix-web控制台默认是英文，可切换中文版本" class="headerlink" title="zabbix 自带多种语言包，也包括中文。登陆zabbix web控制台默认是英文，可切换中文版本"></a>zabbix 自带多种语言包，也包括中文。登陆zabbix web控制台默认是英文，可切换中文版本</h5><p>1.默认登陆界面(英文版)</p><p><img src="../../img/1557991450914.png" alt="img7"></p><p>  点击右上角小人图标,切换语言</p><p><img src="../../img/1557991583049.png" alt="img8"></p><p>  汉化后界面如下</p><p><img src="../../img/1557992321097.png" alt="img9"></p><h5 id="解决中文乱码"><a href="#解决中文乱码" class="headerlink" title="解决中文乱码"></a>解决中文乱码</h5><p>  上传本地字体</p><p>  找到本地C:\Windows\Fonts\STXINWEI.TTF(华文新魏)上传到/usr/share/zabbix/fonts</p><p><img src="../../img/1557984849451.png" alt="img10"></p><p> 重命名字体名称</p><p> 将zabbix服务器正在使用字体备份</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# mv /usr/local/apache/htdocs/zabbix/fonts/DejaVuSans.ttf&#123;,.bak&#125;</span><br><span class="line"> 将刚刚上传的字体替换</span><br><span class="line"></span><br><span class="line">$ scp STXINWEI.TTF root@192.168.161.130:/usr/local/apache/htdocs/zabbix/fo nts/DejaVuSans.ttf                                                         root@192.168.161.130&apos;s password:                                           STXINWEI.TTF                             100% 3956KB   1.3MB/s   00:03</span><br></pre></td></tr></table></figure><p>再次查看界面</p><p><img src="../../img/1557992833068.png" alt="img11"></p><h2 id="11-客户端配置"><a href="#11-客户端配置" class="headerlink" title="11.客户端配置"></a>11.客户端配置</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">安装依赖包</span><br><span class="line">[root@wenhs5479 ~]# yum -y install net-snmp-devel libevent-devel libxml2-devel curl-devel pcre*</span><br><span class="line"></span><br><span class="line">下载zabbix</span><br><span class="line">[root@wenhs5479 ~]# cd /usr/src/</span><br><span class="line">[root@wenhs5479 src]# scp 192.168.161.130:/usr/src/zabbix-4.2.1.tar.gz .</span><br><span class="line">root@192.168.161.130&apos;s password: </span><br><span class="line">zabbix-4.2.1.tar.gz                               100%   17MB  61.7MB/s   00:00    </span><br><span class="line">[root@wenhs5479 src]# tar xf zabbix-4.2.1.tar.gz</span><br><span class="line"></span><br><span class="line">创建zabbix用户和组</span><br><span class="line">[root@wenhs5479 ~]# groupadd -r zabbix</span><br><span class="line">[root@wenhs5479 ~]# useradd -r -g zabbix -M -s /sbin/nologin zabbix</span><br><span class="line"></span><br><span class="line">编译安装zabbix</span><br><span class="line">[root@wenhs5479 ~]# cd /usr/src/zabbix-4.2.1    </span><br><span class="line">[root@wenhs5479 zabbix-4.2.1]# ./configure --enable-agent</span><br><span class="line">[root@wenhs5479 zabbix-4.2.1]# make install</span><br><span class="line">[root@wenhs5479 zabbix-4.2.1]# ls /usr/local/etc/</span><br><span class="line">zabbix_agentd.conf  zabbix_agentd.conf.d </span><br><span class="line"></span><br><span class="line">修改服务端配置文件</span><br><span class="line">设置数据库信息</span><br><span class="line">[root@wenhs5479 zabbix-4.2.1]# vim /usr/local/etc/zabbix_agentd.conf</span><br><span class="line">Server=192.168.161.130</span><br><span class="line">ServerActive=192.168.161.130</span><br><span class="line">Hostname=167</span><br><span class="line">启动zabbix_agentd</span><br><span class="line">[root@wenhs5479 zabbix-4.2.1]# zabbix_agentd</span><br><span class="line">[root@wenhs5479 zabbix-4.2.1]# ss -antl</span><br><span class="line">State      Recv-Q Send-Q Local Address:Port               Peer Address:Port              </span><br><span class="line">LISTEN     0      128            *:111                        *:*                  </span><br><span class="line">LISTEN     0      5      192.168.122.1:53                         *:*                  </span><br><span class="line">LISTEN     0      128            *:22                         *:*                  </span><br><span class="line">LISTEN     0      128    127.0.0.1:631                        *:*                  </span><br><span class="line">LISTEN     0      100    127.0.0.1:25                         *:*                  </span><br><span class="line">LISTEN     0      128    127.0.0.1:6010                       *:*                  </span><br><span class="line">LISTEN     0      128            *:10050                      *:*                  </span><br><span class="line">LISTEN     0      128           :::111                       :::*                  </span><br><span class="line">LISTEN     0      128           :::22                        :::*                  </span><br><span class="line">LISTEN     0      128          ::1:631                       :::*                  </span><br><span class="line">LISTEN     0      100          ::1:25                        :::*                  </span><br><span class="line">LISTEN     0      128          ::1:6010                      :::*</span><br></pre></td></tr></table></figure><p><img src="../../img/1557994936761.png" alt="img12"></p><p><img src="../../img/1557995112055.png" alt="img13"></p><p><img src="../../img/1557995259971.png" alt="img14"></p><p><img src="../../img/1557996138901.png" alt="img15"></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;a id=&quot;more&quot;&gt;&lt;/a&gt;


&lt;h2 id=&quot;1-zabbix介绍&quot;&gt;&lt;a href=&quot;#1-zabbix介绍&quot; class=&quot;headerlink&quot; title=&quot;1. zabbix介绍&quot;&gt;&lt;/a&gt;1. zabbix介绍&lt;/h2&gt;&lt;p&gt;&lt;code&gt;zabbix&lt;/co
      
    
    </summary>
    
      <category term="Linux运维" scheme="http://aiwhs.github.io/categories/Linux%E8%BF%90%E7%BB%B4/"/>
    
    
      <category term="监控服务" scheme="http://aiwhs.github.io/tags/%E7%9B%91%E6%8E%A7%E6%9C%8D%E5%8A%A1/"/>
    
  </entry>
  
  <entry>
    <title>Gitlab</title>
    <link href="http://aiwhs.github.io/2018/12/29/%E7%89%88%E6%9C%AC%E6%8E%A7%E5%88%B6GitLab/"/>
    <id>http://aiwhs.github.io/2018/12/29/版本控制GitLab/</id>
    <published>2018-12-29T00:15:57.000Z</published>
    <updated>2019-07-17T11:34:13.840Z</updated>
    
    <content type="html"><![CDATA[<a id="more"></a><h2 id="1-版本控制介绍"><a href="#1-版本控制介绍" class="headerlink" title="1.版本控制介绍"></a>1.版本控制介绍</h2><p>版本控制是指对软件开发过程中各种程序代码，配置文件及说明文档等文件变更的管理，是软件配置管理的核心思想之一。</p><p>版本控制最主要的功能就是追踪文件的变更。它将什么时候，什么人更改了文件的什么内容等信息忠实地了记录下来。每一次文件的改变，文件的版本号都将增加。除了记录版本变更外，版本控制的另一个重要功能是并行开发。软件开发往往是多人协同作业，版本控制可以有效地解决版本的同步以及不同开发者之间的开发通信问题，提高协同开发的效率并行。开发中最常见的不同版本软件的错误（错误）修正问题也可以通过版本控制中分支与合并的方法有效地解决。<br>具体来说，在每一项开发任务中，都需要首先设定开发基线，确定各个配置项的开发初始版本，在开发过程中，开发人员基于开发基线的版本，开发出所需的目标版本。当发生需求变更时，通过对变更的评估，确定变更的影响范围，对被影响的配置项的版本进行修改，根据变更的性质使配置 的版本树继续延伸或产生新的分支，形成新的目标版本，而对于不受变更影响的配置项则不应发产生变动。同时，应能够将变更所产生的对版本的影响进行记录和跟踪。必要时还可以回退到以前的版本。例如当开发需求或需求变更被取消时，就需要有能力将版本回退到开发基线版本。在曾经出现过的季度升级包拆包和重新组包的过程中，其实就是将部分配置项的版本回退到开发基线，将对应不同需求的不同分支重新组合归并，形成新的升级包版本。<br>版本控制是软件配置管理的核心功能。所有置于配置库中的元素都应自动予以版本的标识，并保证版本命名的唯一性。版本在生成过程中，自动依照设定的使用模型自动分支，演进。除了系统自动记录的版本信息以外，为了配合软件开发流程的各个阶段。还需要定义，收集一些元数据来记录版本的辅助信息和规范开发流程，并为今后对软件过程的度量做好准备。当然如果选用的工具支持，这些辅助数据将能直接统计出过程数据，从而方便软件过程改进活动的进行。对于配置库中的各个基线控制项，应该根据其基线的位置和状态来设置相应的访问权限。一般来说，对于基线版本之前的各个版本都应处于被锁定的状态，如需要对它们进行变更，则应按照变更控制的流程来进行操作。</p><p>常用的版本控制工具：</p><ul><li>gitlab</li><li>颠覆</li></ul><h2 id="2-gitlab部署"><a href="#2-gitlab部署" class="headerlink" title="2. gitlab部署"></a>2. gitlab部署</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line">配置yum源</span><br><span class="line">[root@localhost ~]# cd /etc/yum.repos.d/</span><br><span class="line">[root@localhost yum.repos.d]# wget http://mirrors.163.com/.help/CentOS7-Base-163.repo</span><br><span class="line">[root@localhost ~]# sed -i &apos;s/\$releasever/7/g&apos; /etc/yum.repos.d/CentOS7-Base-163.repo</span><br><span class="line">[root@localhost ~]# sed -i &apos;s/^enabled=.*/enabled=1/g&apos; /etc/yum.repos.d/CentOS7-Base-163.repo</span><br><span class="line"></span><br><span class="line">安装git</span><br><span class="line">[root@localhost ~]# yum -y install epel-release git</span><br><span class="line">安装过程略</span><br><span class="line"></span><br><span class="line">安装依赖包</span><br><span class="line">[root@localhost ~]# yum -y install curl openssh-server openssh-clients postfix cronie policycoreutils-python</span><br><span class="line">安装过程略....</span><br><span class="line"></span><br><span class="line">启动postfix服务并设置开机自启</span><br><span class="line">[root@localhost ~]# systemctl restart postfix</span><br><span class="line">[root@localhost ~]# systemctl enable postfix</span><br><span class="line"></span><br><span class="line">下载gitlab的rpm包</span><br><span class="line">[root@localhost ~]# cd /usr/src/</span><br><span class="line">[root@localhost src]# ls</span><br><span class="line">debug  kernels</span><br><span class="line">[root@localhost src]# wget https://mirrors.tuna.tsinghua.edu.cn/gitlab-ce/yum/el7/gitlab-ce-11.2.1-ce.0.el7.x86_64.rpm</span><br><span class="line">......</span><br><span class="line">HTTP request sent, awaiting response... 200 OK</span><br><span class="line">Length: 444944490 (424M) [application/x-redhat-package-manager]</span><br><span class="line">Saving to: ‘gitlab-ce-11.2.1-ce.0.el7.x86_64.rpm’</span><br><span class="line"></span><br><span class="line">[root@localhost src]# ls</span><br><span class="line">debug  gitlab-ce-11.2.1-ce.0.el7.x86_64.rpm  kernels</span><br><span class="line"></span><br><span class="line">安装gitlab</span><br><span class="line">[root@localhost src]# rpm -ivh gitlab-ce-11.2.1-ce.0.el7.x86_64.rpm</span><br><span class="line">warning: gitlab-ce-11.2.1-ce.0.el7.x86_64.rpm: Header V4 RSA/SHA1 Signature, key ID f27eab47: NOKEY</span><br><span class="line">Preparing...                                                            (1################################# [100%]</span><br><span class="line">Updating / installing...</span><br><span class="line">   1:gitlab-ce-11.2.1-ce.0.el7                                          (</span><br><span class="line">################################# [100%]</span><br><span class="line">It looks like GitLab has not been configured yet; skipping the upgrade script.</span><br><span class="line"></span><br><span class="line">       *.                  *.</span><br><span class="line">      ***                 ***</span><br><span class="line">     *****               *****</span><br><span class="line">    .******             *******</span><br><span class="line">    ********            ********</span><br><span class="line">   ,,,,,,,,,***********,,,,,,,,,</span><br><span class="line">  ,,,,,,,,,,,*********,,,,,,,,,,,</span><br><span class="line">  .,,,,,,,,,,,*******,,,,,,,,,,,,</span><br><span class="line">      ,,,,,,,,,*****,,,,,,,,,.</span><br><span class="line">         ,,,,,,,****,,,,,,</span><br><span class="line">            .,,,***,,,,</span><br><span class="line">                ,*,.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">     _______ __  __          __</span><br><span class="line">    / ____(_) /_/ /   ____ _/ /_</span><br><span class="line">   / / __/ / __/ /   / __ `/ __ \</span><br><span class="line">  / /_/ / / /_/ /___/ /_/ / /_/ /</span><br><span class="line">  \____/_/\__/_____/\__,_/_.___/</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Thank you for installing GitLab!</span><br><span class="line">GitLab was unable to detect a valid hostname for your instance.</span><br><span class="line">Please configure a URL for your GitLab instance by setting `external_url`</span><br><span class="line">configuration in /etc/gitlab/gitlab.rb file.</span><br><span class="line">Then, you can start your GitLab instance by running the following command:</span><br><span class="line">  sudo gitlab-ctl reconfigure</span><br><span class="line"></span><br><span class="line">For a comprehensive list of configuration options please see the Omnibus GitLab readme</span><br><span class="line">https://gitlab.com/gitlab-org/omnibus-gitlab/blob/master/README.md</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">修改配置文件</span><br><span class="line">[root@localhost ~]# vim /etc/gitlab/gitlab.rb</span><br><span class="line">......  //此处为省略内容</span><br><span class="line">external_url &apos;http://172.16.137.11&apos;     //将此处设为gitlab的服务器ip地址亦或域名</span><br><span class="line">......  //此处为省略内容</span><br><span class="line"></span><br><span class="line">重载配置文件并重启gitlab</span><br><span class="line">[root@localhost ~]# gitlab-ctl reconfigure</span><br><span class="line">[root@localhost ~]# gitlab-ctl restart</span><br><span class="line">ok: run: alertmanager: (pid 17305) 0s</span><br><span class="line">ok: run: gitaly: (pid 17318) 0s</span><br><span class="line">ok: run: gitlab-monitor: (pid 17331) 0s</span><br><span class="line">ok: run: gitlab-workhorse: (pid 17335) 0s</span><br><span class="line">ok: run: logrotate: (pid 17363) 1s</span><br><span class="line">ok: run: nginx: (pid 17369) 0s</span><br><span class="line">ok: run: node-exporter: (pid 17380) 1s</span><br><span class="line">ok: run: postgres-exporter: (pid 17386) 0s</span><br><span class="line">ok: run: postgresql: (pid 17396) 1s</span><br><span class="line">ok: run: prometheus: (pid 17405) 0s</span><br><span class="line">ok: run: redis: (pid 17420) 0s</span><br><span class="line">ok: run: redis-exporter: (pid 17425) 0s</span><br><span class="line">ok: run: sidekiq: (pid 17510) 0s</span><br><span class="line">ok: run: unicorn: (pid 17523) 0s</span><br><span class="line"></span><br><span class="line">查看当前的gitlab版本</span><br><span class="line">[root@localhost ~]# head -1 /opt/gitlab/version-manifest.txt</span><br><span class="line">gitlab-ce 11.2.1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">设置管理员密码</span><br><span class="line">[root@localhost ~]# gitlab-rails console production</span><br><span class="line">-------------------------------------------------------------------------------------</span><br><span class="line"> GitLab:       11.2.1 (2d6c1c6)</span><br><span class="line"> GitLab Shell: 8.1.1</span><br><span class="line"> postgresql:   9.6.8</span><br><span class="line">-------------------------------------------------------------------------------------</span><br><span class="line">Loading production environment (Rails 4.2.10)</span><br><span class="line">irb(main):001:0&gt; user = User.where(id: 1).first     //id为1的是超级管理员</span><br><span class="line">=&gt; #&lt;User id:1 @root&gt;</span><br><span class="line">irb(main):002:0&gt; user.password = &apos;itwhs123!&apos;     //密码必须至少8个字符</span><br><span class="line">=&gt; &quot;itwhs123!&quot;</span><br><span class="line">irb(main):003:0&gt; user.save!     //保存修改，若无问题将返回true</span><br><span class="line">Enqueued ActionMailer::DeliveryJob (Job ID: 7feb0464-15aa-4151-be94-2e657a65494e) to Sidekiq(mailers) with arguments: &quot;DeviseMailer&quot;, &quot;password_change&quot;, &quot;deliver_now&quot;, gid://gitlab/User/1</span><br><span class="line">=&gt; true</span><br><span class="line">irb(main):004:0&gt; exit   //退出</span><br></pre></td></tr></table></figure><h2 id="3-gitlab管理"><a href="#3-gitlab管理" class="headerlink" title="3. gitlab管理"></a>3. gitlab管理</h2><p>在浏览器中使用gitlab服务器的IP访问，如下页面所示图产品</p><p><img src="../../img/gitlab_login.png" alt="img1"><br>主页如下图产品所示</p><p><img src="../../img/gitlab_zhuye.jpg" alt="img2"><br>管理页面如下图产品所示</p><p><img src="../../img/gitlab_manager.png" alt="img3"></p><p><strong>gitlab常用管理操作</strong></p><ul><li>项目管理（通常只是创建新项目）</li><li>创建成员组（针对某个项目创建一个成员组）</li><li>用户管理（此用户乃gitlab用户而非系统用户）<ul><li>来了新员工，为其添加gitlab用户</li><li>员工离职，将其gitlab用户禁用或删除</li></ul></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;a id=&quot;more&quot;&gt;&lt;/a&gt;



&lt;h2 id=&quot;1-版本控制介绍&quot;&gt;&lt;a href=&quot;#1-版本控制介绍&quot; class=&quot;headerlink&quot; title=&quot;1.版本控制介绍&quot;&gt;&lt;/a&gt;1.版本控制介绍&lt;/h2&gt;&lt;p&gt;版本控制是指对软件开发过程中各种程序代码，配置文件
      
    
    </summary>
    
      <category term="Linux运维" scheme="http://aiwhs.github.io/categories/Linux%E8%BF%90%E7%BB%B4/"/>
    
    
      <category term="版本控制" scheme="http://aiwhs.github.io/tags/%E7%89%88%E6%9C%AC%E6%8E%A7%E5%88%B6/"/>
    
  </entry>
  
  <entry>
    <title>cobbler</title>
    <link href="http://aiwhs.github.io/2018/12/23/cobbler/"/>
    <id>http://aiwhs.github.io/2018/12/23/cobbler/</id>
    <published>2018-12-23T00:15:57.000Z</published>
    <updated>2019-07-17T11:29:39.319Z</updated>
    
    <content type="html"><![CDATA[<a id="more"></a><h2 id="1-cobbler简介"><a href="#1-cobbler简介" class="headerlink" title="1. cobbler简介"></a>1. cobbler简介</h2><p><code>Cobbler</code>是一个Linux服务器安装的服务，可以通过网络启动(PXE)的方式来快速安装、重装物理服务器和虚拟机，同时还可以管理<code>DHCP</code>，<code>DNS</code>等。</p><p><code>Cobbler</code>可以使用命令行方式管理，也提供了基于Web的界面管理工具(cobbler-web)，还提供了API接口，可以方便二次开发使用。</p><p><code>Cobbler</code>是较早前的kickstart的升级版，优点是比较容易配置，还自带web界面比较易于管理。</p><p><code>Cobbler</code>内置了一个轻量级配置管理系统，但它也支持和其它配置管理系统集成，如Puppet，暂时不支持SaltStack。</p><p><code>Cobbler</code><a href="http://cobbler.github.io/" target="_blank" rel="noopener">官网</a></p><p><strong>cobbler集成的服务</strong></p><ul><li>PXE服务支持</li><li>DHCP服务管理</li><li>DNS服务管理(可选bind,dnsmasq)</li><li>电源管理</li><li>Kickstart服务支持</li><li>YUM仓库管理</li><li>TFTP(PXE启动时需要)</li><li>Apache(提供kickstart的安装源，并提供定制化的kickstart配置)</li></ul><p><strong>cobbler配置文件详解</strong><br><code>cobbler</code>配置文件目录在<code>/etc/cobbler</code></p><table><thead><tr><th align="left">配置文件</th><th align="left">作用</th></tr></thead><tbody><tr><td align="left">/etc/cobbler/settings</td><td align="left">cobbler 主配置文件</td></tr><tr><td align="left">/etc/cobbler/iso/</td><td align="left">iso模板配置文件</td></tr><tr><td align="left">/etc/cobbler/pxe</td><td align="left">pxe模板配置文件</td></tr><tr><td align="left">/etc/cobbler/power</td><td align="left">电源配置文件</td></tr><tr><td align="left">/etc/cobbler/user.conf</td><td align="left">web服务授权配置文件</td></tr><tr><td align="left">/etc/cobbler/users.digest</td><td align="left">web访问的用户名密码配置文件</td></tr><tr><td align="left">/etc/cobbler/dhcp.template</td><td align="left">dhcp服务器的的配置模板</td></tr><tr><td align="left">/etc/cobbler/dnsmasq.template</td><td align="left">dns服务器的配置模板</td></tr><tr><td align="left">/etc/cobbler/tftpd.template</td><td align="left">tftp服务的配置模板</td></tr><tr><td align="left">/etc/cobbler/modules.conf</td><td align="left">模块的配置文件</td></tr></tbody></table><p><strong>cobbler数据目录</strong></p><table><thead><tr><th align="left">目录</th><th align="left">作用</th></tr></thead><tbody><tr><td align="left">/var/lib/cobbler/config/</td><td align="left">用于存放distros，system，profiles等信息配置文件</td></tr><tr><td align="left">/var/lib/cobbler/triggers/</td><td align="left">用于存放用户定义的cobbler命令</td></tr><tr><td align="left">/var/lib/cobbler/kickstart/</td><td align="left">默认存放kickstart文件</td></tr><tr><td align="left">/var/lib/cobbler/loaders/</td><td align="left">存放各种引导程序以及镜像目录</td></tr><tr><td align="left">/var/www/cobbler/ks_mirror/</td><td align="left">导入的发行版系统的所有数据</td></tr><tr><td align="left">/var/www/cobbler/images/</td><td align="left">导入发行版的kernel和initrd镜像用于远程网络启动</td></tr><tr><td align="left">/var/www/cobbler/repo_mirror/</td><td align="left">yum仓库存储目录</td></tr></tbody></table><p><strong>cobbler日志文件</strong></p><table><thead><tr><th align="left">日志文件路径</th><th align="left">说明</th></tr></thead><tbody><tr><td align="left">/var/log/cobbler/installing</td><td align="left">客户端安装日志</td></tr><tr><td align="left">/var/log/cobbler/cobbler.log</td><td align="left">cobbler日志</td></tr></tbody></table><p><code>cobbler</code>命令详解</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cobbler check       //核对当前设置是否有问题</span><br><span class="line">cobbler list        //列出所有的cobbler元素</span><br><span class="line">cobbler report      //列出元素的详细信息</span><br><span class="line">cobbler sync        //同步配置到数据目录,更改配置最好都要执行下</span><br><span class="line">cobbler reposync    //同步yum仓库</span><br><span class="line">cobbler distro      //查看导入的发行版系统信息</span><br><span class="line">cobbler system      //查看添加的系统信息</span><br><span class="line">cobbler profile     //查看配置信息</span><br></pre></td></tr></table></figure><h2 id="2-cobbler服务端部署"><a href="#2-cobbler服务端部署" class="headerlink" title="2. cobbler服务端部署"></a>2. cobbler服务端部署</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br></pre></td><td class="code"><pre><span class="line">配置yum源</span><br><span class="line">[root@localhost ~]# curl -o /etc/yum.repos.d/CentOS7-Base-163.repo http://mirrors.163.com/.help/CentOS7-Base-163.repo</span><br><span class="line">[root@localhost ~]# sed -i &apos;s/\$releasever/7/g&apos; /etc/yum.repos.d/CentOS7-Base-163.repo</span><br><span class="line">[root@localhost ~]# sed -i &apos;s/^enabled=.*/enabled=1/g&apos; /etc/yum.repos.d/CentOS7-Base-163.repo</span><br><span class="line">[root@localhost ~]# yum -y install epel-release</span><br><span class="line">安装过程略。。。。</span><br><span class="line"></span><br><span class="line">安装cobbler以及相关的软件</span><br><span class="line">[root@localhost ~]# yum -y install httpd dhcp tftp python-ctypes cobbler xinetd cobbler-web pykickstart</span><br><span class="line">安装过程略....</span><br><span class="line"></span><br><span class="line">启动服务并设置开机自启</span><br><span class="line">[root@localhost ~]# systemctl start httpd</span><br><span class="line">[root@localhost ~]# systemctl start cobblerd</span><br><span class="line">[root@localhost ~]# systemctl enable httpd</span><br><span class="line">Created symlink from /etc/systemd/system/multi-user.target.wants/httpd.service to /usr/lib/systemd/system/httpd.service.</span><br><span class="line">[root@localhost ~]# systemctl enable cobblerd</span><br><span class="line">Created symlink from /etc/systemd/system/multi-user.target.wants/cobblerd.service to /usr/lib/systemd/system/cobblerd.service.</span><br><span class="line"></span><br><span class="line">修改server的ip地址为本机ip</span><br><span class="line">[root@localhost ~]# sed -i &apos;s/^server: 127.0.0.1/server: 192.168.137.10/&apos; /etc/cobbler/settings</span><br><span class="line"></span><br><span class="line">设置tftp的ip地址为本机ip</span><br><span class="line">[root@localhost ~]# sed -i &apos;s/^next_server: 127.0.0.1/next_server: 192.168.137.10/&apos; /etc/cobbler/settings</span><br><span class="line"></span><br><span class="line">开启tftp</span><br><span class="line">[root@localhost ~]# sed -i &apos;/disable/s/yes/no/g&apos; /etc/xinetd.d/tftp</span><br><span class="line"></span><br><span class="line">下载缺失文件</span><br><span class="line">[root@localhost ~]# cobbler get-loaders</span><br><span class="line">......</span><br><span class="line">downloading https://cobbler.github.io/loaders/grub-0.97-x86_64.efi to /var/lib/cobbler/loaders/grub-x86_64.efi</span><br><span class="line">*** TASK COMPLETE ***</span><br><span class="line"></span><br><span class="line">启动rsync并设置开机自启</span><br><span class="line">[root@localhost ~]# systemctl start rsyncd</span><br><span class="line">[root@localhost ~]# systemctl enable rsyncd</span><br><span class="line">Created symlink from /etc/systemd/system/multi-user.target.wants/rsyncd.service to /usr/lib/systemd/system/rsyncd.service.</span><br><span class="line"></span><br><span class="line">生成加密的密码</span><br><span class="line">[root@localhost ~]# openssl passwd -1 -salt &quot;$RANDOM&quot; &apos;itwhs123!&apos;</span><br><span class="line">$1$8280$A4fc8ZnmQZlZjw/hDcN5Z1         //这是密码加密后的形式</span><br><span class="line"></span><br><span class="line">将新生成的加密密码加入到配置文件</span><br><span class="line">[root@localhost ~]# vim /etc/cobbler/settings</span><br><span class="line">....    //此处为省略内容</span><br><span class="line">default_password_crypted: &quot;$1$8280$A4fc8ZnmQZlZjw/hDcN5Z1&quot;</span><br><span class="line">.....   //此处为省略内容</span><br><span class="line"></span><br><span class="line">重启cobbler</span><br><span class="line">[root@localhost ~]# systemctl restart cobblerd</span><br><span class="line">[root@localhost ~]# ss -antl</span><br><span class="line">State       Recv-Q Send-Q      Local Address:Port                     Peer Address:Port</span><br><span class="line">LISTEN      0      128                     *:22                                  *:*</span><br><span class="line">LISTEN      0      100             127.0.0.1:25                                  *:*</span><br><span class="line">LISTEN      0      5               127.0.0.1:25151                               *:*</span><br><span class="line">LISTEN      0      5                       *:873                                 *:*</span><br><span class="line">LISTEN      0      128                    :::80                                 :::*</span><br><span class="line">LISTEN      0      128                    :::22                                 :::*</span><br><span class="line">LISTEN      0      100                   ::1:25                                 :::*</span><br><span class="line">LISTEN      0      128                    :::443                                :::*</span><br><span class="line">LISTEN      0      5                      :::873                                :::*</span><br><span class="line"></span><br><span class="line">通过cobbler check 核对当前设置是否有问题</span><br><span class="line">[root@localhost ~]# cobbler check</span><br><span class="line">The following are potential configuration items that you may want to fix:</span><br><span class="line"></span><br><span class="line">1 : debmirror package is not installed, it will be required to manage debian deployments and repositories</span><br><span class="line">2 : fencing tools were not found, and are required to use the (optional) power management features. install cman or fence-agents to use them</span><br><span class="line"></span><br><span class="line">Restart cobblerd and then run &apos;cobbler sync&apos; to apply changes.</span><br><span class="line">以上两个是关于debian系统的错误，请忽略</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">配置cobbler dhcp</span><br><span class="line">修改cobbler配置文件，让cobbler控制dhcp</span><br><span class="line">[root@localhost ~]# sed -i &apos;/^manage_dhcp/s/0/1/g&apos; /etc/cobbler/settings</span><br><span class="line">[root@localhost ~]# sed -n &apos;/^manage_dhcp/p&apos; /etc/cobbler/settings</span><br><span class="line">manage_dhcp: 1</span><br><span class="line"></span><br><span class="line">配置dhcp</span><br><span class="line">[root@localhost ~]# vim /etc/cobbler/dhcp.template</span><br><span class="line">....    //此处为省略内容</span><br><span class="line">subnet 192.168.137.0 netmask 255.255.255.0 &#123;</span><br><span class="line">     option routers             192.168.137.10;</span><br><span class="line">     option domain-name-servers 192.168.137.1;        //此处为系统安装好后指定的dns地址</span><br><span class="line">     option subnet-mask         255.255.255.0;</span><br><span class="line">     range dynamic-bootp        192.168.137.100 192.168.137.150;</span><br><span class="line">     default-lease-time         21600;</span><br><span class="line">     max-lease-time             43200;</span><br><span class="line">     next-server                $next_server; </span><br><span class="line">....    //此处为省略内容</span><br><span class="line"></span><br><span class="line">重启服务并同步配置，改完dhcp必须要sync同步配置</span><br><span class="line">[root@localhost ~]# systemctl restart cobblerd</span><br><span class="line">[root@localhost ~]# cobbler sync</span><br><span class="line">......</span><br><span class="line">running python trigger cobbler.modules.scm_track</span><br><span class="line">running shell triggers from /var/lib/cobbler/triggers/change/*</span><br><span class="line">*** TASK COMPLETE ***</span><br><span class="line"></span><br><span class="line">检查dhcp是否正常</span><br><span class="line">[root@localhost ~]# netstat -anulp|grep dhcp</span><br><span class="line">udp        0      0 0.0.0.0:67              0.0.0.0:*                           12692/dhcpd </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">导入redhat7镜像</span><br><span class="line">[root@localhost ~]# mount /dev/cdrom /mnt</span><br><span class="line">mount: /dev/sr0 is write-protected, mounting read-only</span><br><span class="line">[root@localhost ~]# cobbler import --path=/mnt --name=rhel-7 --arch=x86_64</span><br><span class="line">......</span><br><span class="line">Found a candidate signature: breed=redhat, version=rhel6</span><br><span class="line">Found a candidate signature: breed=redhat, version=rhel7</span><br><span class="line">Found a matching signature: breed=redhat, version=rhel7</span><br><span class="line">Adding distros from path /var/www/cobbler/ks_mirror/rhel-7-x86_64:</span><br><span class="line">creating new distro: rhel-7-x86_64</span><br><span class="line">trying symlink: /var/www/cobbler/ks_mirror/rhel-7-x86_64 -&gt; /var/www/cobbler/links/rhel-7-x86_64</span><br><span class="line">creating new profile: rhel-7-x86_64</span><br><span class="line">associating repos</span><br><span class="line">checking for rsync repo(s)</span><br><span class="line">checking for rhn repo(s)</span><br><span class="line">checking for yum repo(s)</span><br><span class="line">starting descent into /var/www/cobbler/ks_mirror/rhel-7-x86_64 for rhel-7-x86_64</span><br><span class="line">processing repo at : /var/www/cobbler/ks_mirror/rhel-7-x86_64     //导入镜像的位置</span><br><span class="line">need to process repo/comps: /var/www/cobbler/ks_mirror/rhel-7-x86_64</span><br><span class="line">looking for /var/www/cobbler/ks_mirror/rhel-7-x86_64/repodata/*comps*.xml</span><br><span class="line">Keeping repodata as-is :/var/www/cobbler/ks_mirror/rhel-7-x86_64/repodata</span><br><span class="line">*** TASK COMPLETE ***</span><br><span class="line"></span><br><span class="line">说明：</span><br><span class="line">    --path      //镜像路径</span><br><span class="line">    --name      //为安装源定义一个名字</span><br><span class="line">    --arch      //指定安装源平台</span><br><span class="line"></span><br><span class="line">安装源的唯一标示就是根据name参数来定义，本例导入成功后，安装源的唯一标示就是：CentOS-7-x86_64，如果重复，系统会提示导入失败</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">查看cobbler镜像列表</span><br><span class="line">[root@localhost ~]# cobbler list</span><br><span class="line">distros:</span><br><span class="line">   rhel-7-x86_64</span><br><span class="line"></span><br><span class="line">profiles:</span><br><span class="line">   rhel-7-x86_64</span><br><span class="line"></span><br><span class="line">systems:</span><br><span class="line"></span><br><span class="line">repos:</span><br><span class="line"></span><br><span class="line">images:</span><br><span class="line"></span><br><span class="line">mgmtclasses:</span><br><span class="line"></span><br><span class="line">packages:</span><br><span class="line"></span><br><span class="line">files:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">创建kickstarts自动安装脚本</span><br><span class="line">[root@localhost ~]# cat &gt; /var/lib/cobbler/kickstarts/Centos-7.6-x86_64.ks &lt;&lt;&apos;EOF&apos;</span><br><span class="line">auth --enableshadow --passalgo=sha512</span><br><span class="line">bootloader --location=mbr</span><br><span class="line">clearpart --all --initlabel</span><br><span class="line">part /boot --asprimary --fstype=&quot;ext4&quot; --size=500</span><br><span class="line">part swap --fstype=&quot;swap&quot; --size=3072</span><br><span class="line">part / --fstype=&quot;ext4&quot; --grow --size=15000</span><br><span class="line">text</span><br><span class="line">firewall --disabled</span><br><span class="line">firstboot --disable</span><br><span class="line">keyboard us</span><br><span class="line">lang en_US</span><br><span class="line">url --url=http://192.168.137.10/cobbler/ks_mirror/Centos-7.6-x86_64</span><br><span class="line">$yum_repo_stanza</span><br><span class="line">reboot</span><br><span class="line"></span><br><span class="line">rootpw --iscrypted $6$1DqmGBTIZJdzSAGN$i/neDtJQxcA5cAdXns6DPjgL6tSJABJIVsVQg/6MQNrF1FoXjjC6wB8M/jLc8vGv.rNVzINL6R9u2TqF3KeOB1</span><br><span class="line"></span><br><span class="line">selinux --disabled</span><br><span class="line">skipx</span><br><span class="line">timezone Asia/Shanghai --isUtc --nontp</span><br><span class="line">install</span><br><span class="line">zerombr</span><br><span class="line"></span><br><span class="line">%packages</span><br><span class="line">@^minimal</span><br><span class="line">@core</span><br><span class="line">kexec-tools</span><br><span class="line"></span><br><span class="line">%end</span><br><span class="line"></span><br><span class="line">%addon com_redhat_kdump --enable --reserve-mb=&apos;auto&apos;</span><br><span class="line"></span><br><span class="line">%end</span><br><span class="line"></span><br><span class="line">%anaconda</span><br><span class="line">pwpolicy root --minlen=6 --minquality=1 --notstrict --nochanges --notempty</span><br><span class="line">pwpolicy user --minlen=6 --minquality=1 --notstrict --nochanges --emptyok</span><br><span class="line">pwpolicy luks --minlen=6 --minquality=1 --notstrict --nochanges --notempty</span><br><span class="line">%end</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">检查ks文件语法是否有误</span><br><span class="line">[root@ct10 ~]# cobbler validateks</span><br><span class="line">task started: 2019-06-26_191758_validateks</span><br><span class="line">task started (id=Kickstart Validation, time=Wed Jun 26 19:17:58 2019)</span><br><span class="line">----------------------------</span><br><span class="line">osversion: rhel6</span><br><span class="line">checking url: http://192.168.137.10/cblr/svc/op/ks/profile/Centos-7.6-x86_64</span><br><span class="line">running: /usr/bin/ksvalidator -v &quot;rhel6&quot; &quot;http://192.168.137.10/cblr/svc/op/ks/profile/Centos-7.6-x86_64&quot;</span><br><span class="line">received on stdout: </span><br><span class="line">received on stderr: </span><br><span class="line">*** all kickstarts seem to be ok ***</span><br><span class="line">*** TASK COMPLETE ***</span><br><span class="line"></span><br><span class="line">查看当前cobbler有哪些配置文件</span><br><span class="line">[root@localhost ~]# cobbler profile list</span><br><span class="line">   Centos-7-x86_64</span><br><span class="line">   </span><br><span class="line">修改profile，将我们新建的ks文件设为默认的kickstarts安装文件</span><br><span class="line">[root@localhost ~]# cobbler profile edit --name Centos-7.6-x86_64 --kickstart=/var/lib/cobbler/kickstarts/Centos-7.6-x86_64.ks</span><br><span class="line"></span><br><span class="line">配置网卡名称为传统网卡名称eth0</span><br><span class="line">[root@localhost ~]# cobbler profile edit --name Centos-7.6-x86_64 --kopts=&apos;net.ifnames=0 biosdevname=0&apos;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">检查当前系统cobbler配置文件信息</span><br><span class="line">[root@localhost ~]# cobbler profile report</span><br><span class="line">Name                           : Centos-7.6-x86_64</span><br><span class="line">TFTP Boot Files                : &#123;&#125;</span><br><span class="line">Comment                        :</span><br><span class="line">DHCP Tag                       : default</span><br><span class="line">Distribution                   : Centos-7.6-x86_64        //仓库名字</span><br><span class="line">Enable gPXE?                   : 0</span><br><span class="line">Enable PXE Menu?               : 1</span><br><span class="line">Fetchable Files                : &#123;&#125;</span><br><span class="line">Kernel Options                 : &#123;&apos;biosdevname&apos;: &apos;0&apos;, &apos;net.ifnames&apos;: &apos;0&apos;&#125;       //网卡设为传统命名方式</span><br><span class="line">Kernel Options (Post Install)  : &#123;&#125;</span><br><span class="line">Kickstart                      : /var/lib/cobbler/kickstarts/Centos-7.6-x86_64.ks     //使用的kickstarts配置文件的路径，必须为我们新建的ks文件的路径</span><br><span class="line">Kickstart Metadata             : &#123;&#125;</span><br><span class="line">Management Classes             : []</span><br><span class="line">Management Parameters          : &lt;&lt;inherit&gt;&gt;</span><br><span class="line">Name Servers                   : []</span><br><span class="line">Name Servers Search Path       : []</span><br><span class="line">Owners                         : [&apos;admin&apos;]</span><br><span class="line">Parent Profile                 :</span><br><span class="line">Internal proxy                 :</span><br><span class="line">Red Hat Management Key         : &lt;&lt;inherit&gt;&gt;</span><br><span class="line">Red Hat Management Server      : &lt;&lt;inherit&gt;&gt;</span><br><span class="line">Repos                          : []</span><br><span class="line">Server Override                : &lt;&lt;inherit&gt;&gt;</span><br><span class="line">Template Files                 : &#123;&#125;</span><br><span class="line">Virt Auto Boot                 : 1</span><br><span class="line">Virt Bridge                    : xenbr0</span><br><span class="line">Virt CPUs                      : 1</span><br><span class="line">Virt Disk Driver Type          : raw</span><br><span class="line">Virt File Size(GB)             : 5</span><br><span class="line">Virt Path                      :</span><br><span class="line">Virt RAM (MB)                  : 512</span><br><span class="line">Virt Type                      : kvm</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">同步cobbler</span><br><span class="line">[root@localhost ~]# cobbler sync</span><br><span class="line">task started: 2019-06-26_192053_sync</span><br><span class="line">task started (id=Sync, time=Wed Jun 26 19:20:53 2019)</span><br><span class="line">running pre-sync triggers</span><br><span class="line">cleaning trees</span><br><span class="line">removing: /var/www/cobbler/images/Centos-7.6-x86_64</span><br><span class="line">removing: /var/lib/tftpboot/pxelinux.cfg/default</span><br><span class="line">removing: /var/lib/tftpboot/grub/images</span><br><span class="line">removing: /var/lib/tftpboot/grub/grub-x86.efi</span><br><span class="line">removing: /var/lib/tftpboot/grub/grub-x86_64.efi</span><br><span class="line">removing: /var/lib/tftpboot/grub/efidefault</span><br><span class="line">removing: /var/lib/tftpboot/images/Centos-7.6-x86_64</span><br><span class="line">removing: /var/lib/tftpboot/s390x/profile_list</span><br><span class="line">copying bootloaders</span><br><span class="line">trying hardlink /var/lib/cobbler/loaders/grub-x86.efi -&gt; /var/lib/tftpboot/grub/grub-x86.efi</span><br><span class="line">trying hardlink /var/lib/cobbler/loaders/grub-x86_64.efi -&gt; /var/lib/tftpboot/grub/grub-x86_64.efi</span><br><span class="line">copying distros to tftpboot</span><br><span class="line">copying files for distro: Centos-7.6-x86_64</span><br><span class="line">trying hardlink /var/www/cobbler/ks_mirror/Centos-7.6-x86_64/images/pxeboot/vmlinuz -&gt; /var/lib/tftpboot/images/Centos-7.6-x86_64/vmlinuz</span><br><span class="line">trying hardlink /var/www/cobbler/ks_mirror/Centos-7.6-x86_64/images/pxeboot/initrd.img -&gt; /var/lib/tftpboot/images/Centos-7.6-x86_64/initrd.img</span><br><span class="line">copying images</span><br><span class="line">generating PXE configuration files</span><br><span class="line">generating PXE menu structure</span><br><span class="line">copying files for distro: Centos-7.6-x86_64</span><br><span class="line">trying hardlink /var/www/cobbler/ks_mirror/Centos-7.6-x86_64/images/pxeboot/vmlinuz -&gt; /var/www/cobbler/images/Centos-7.6-x86_64/vmlinuz</span><br><span class="line">trying hardlink /var/www/cobbler/ks_mirror/Centos-7.6-x86_64/images/pxeboot/initrd.img -&gt; /var/www/cobbler/images/Centos-7.6-x86_64/initrd.img</span><br><span class="line">Writing template files for Centos-7.6-x86_64</span><br><span class="line">rendering DHCP files</span><br><span class="line">generating /etc/dhcp/dhcpd.conf</span><br><span class="line">rendering TFTPD files</span><br><span class="line">generating /etc/xinetd.d/tftp</span><br><span class="line">processing boot_files for distro: Centos-7.6-x86_64</span><br><span class="line">cleaning link caches</span><br><span class="line">running post-sync triggers</span><br><span class="line">running python triggers from /var/lib/cobbler/triggers/sync/post/*</span><br><span class="line">running python trigger cobbler.modules.sync_post_restart_services</span><br><span class="line">running: dhcpd -t -q</span><br><span class="line">received on stdout: </span><br><span class="line">received on stderr: </span><br><span class="line">running: service dhcpd restart</span><br><span class="line">received on stdout: </span><br><span class="line">received on stderr: Redirecting to /bin/systemctl restart dhcpd.service</span><br><span class="line"></span><br><span class="line">running shell triggers from /var/lib/cobbler/triggers/sync/post/*</span><br><span class="line">running python triggers from /var/lib/cobbler/triggers/change/*</span><br><span class="line">running python trigger cobbler.modules.manage_genders</span><br><span class="line">running python trigger cobbler.modules.scm_track</span><br><span class="line">running shell triggers from /var/lib/cobbler/triggers/change/*</span><br><span class="line">*** TASK COMPLETE ***</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">为避免发生未知问题，先把服务端所有服务重启</span><br><span class="line">[root@localhost ~]# systemctl restart xinetd</span><br><span class="line">[root@localhost ~]# systemctl restart cobblerd</span><br><span class="line">[root@localhost ~]# systemctl restart httpd</span><br><span class="line">[root@localhost ~]# ss -antl</span><br><span class="line">State      Recv-Q Send-Q Local Address:Port               Peer Address:Port</span><br><span class="line">LISTEN     0      128            *:22                         *:*</span><br><span class="line">LISTEN     0      100    127.0.0.1:25                         *:*</span><br><span class="line">LISTEN     0      5      127.0.0.1:25151                      *:*</span><br><span class="line">LISTEN     0      5              *:873                        *:*</span><br><span class="line">LISTEN     0      128           :::80                        :::*</span><br><span class="line">LISTEN     0      128           :::22                        :::*</span><br><span class="line">LISTEN     0      100          ::1:25                        :::*</span><br><span class="line">LISTEN     0      128           :::443                       :::*</span><br><span class="line">LISTEN     0      5             :::873                       :::*</span><br></pre></td></tr></table></figure><h2 id="3-客户端安装"><a href="#3-客户端安装" class="headerlink" title="3.客户端安装"></a>3.客户端安装</h2><p>新建虚拟机从PXE启动，若出现以下界面则表示成功：</p><p><img src="../../img/cobbler.png" alt="img"></p><h2 id="4-定制安装"><a href="#4-定制安装" class="headerlink" title="4.定制安装"></a>4.定制安装</h2><p>定制安装步骤：</p><ul><li>统计服务器的MAC地址</li><li>配置皮匠</li><li>安装</li></ul><p>在访问cobbler web界面到时候出现以下提示</p><p><img src="../../img/cobbler2.png" alt="Cobbler登录web界面提示报错“Internal Server Error”"></p><p>ssl的报错日志如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@Cobbler ~]# tail -f /var/log/httpd/ssl_error_log</span><br><span class="line">[Mon Jan 07 16:24:53.363029 2019] [:error] [pid 3383] [remote 10.0.0.1:212]     mod = importlib.import_module(self.SETTINGS_MODULE)</span><br><span class="line">[Mon Jan 07 16:24:53.363032 2019] [:error] [pid 3383] [remote 10.0.0.1:212]   File &quot;/usr/lib64/python2.7/importlib/__init__.py&quot;, line 37, in import_module</span><br><span class="line">[Mon Jan 07 16:24:53.363084 2019] [:error] [pid 3383] [remote 10.0.0.1:212]     __import__(name)</span><br><span class="line">[Mon Jan 07 16:24:53.363089 2019] [:error] [pid 3383] [remote 10.0.0.1:212]   File &quot;/usr/share/cobbler/web/settings.py&quot;, line 89, in &lt;module&gt;</span><br><span class="line">[Mon Jan 07 16:24:53.363097 2019] [:error] [pid 3383] [remote 10.0.0.1:212]     from django.conf.global_settings import TEMPLATE_CONTEXT_PROCESSORS</span><br><span class="line">[Mon Jan 07 16:24:53.363124 2019] [:error] [pid 3383] [remote 10.0.0.1:212] ImportError: cannot import name TEMPLATE_CONTEXT_PROCESSORS</span><br></pre></td></tr></table></figure><p>查看cobbler的py配置文件</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@Cobbler ~]# sed -n &apos;38,41p&apos; /usr/share/cobbler/web/settings.py</span><br><span class="line">if django.VERSION[0] == 1 and django.VERSION[1] &lt; 4:</span><br><span class="line">    ADMIN_MEDIA_PREFIX = &apos;/media/&apos;</span><br><span class="line">else:</span><br><span class="line">    STATIC_URL = &apos;/media/</span><br><span class="line"></span><br><span class="line">[root@Cobbler ~]# sed -n &apos;89p&apos; /usr/share/cobbler/web/settings.py</span><br><span class="line">from django.conf.global_settings import TEMPLATE_CONTEXT_PROCESSORS</span><br></pre></td></tr></table></figure><p>初步判断应该是pythone-django版本问题</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">#下载pip.py</span><br><span class="line">wget https://bootstrap.pypa.io/get-pip.py</span><br><span class="line"></span><br><span class="line">#调用本地python运行pip.py脚本</span><br><span class="line">python get-pip.py</span><br><span class="line"></span><br><span class="line">#安装pip</span><br><span class="line">pip install Django==1.8.9</span><br><span class="line"></span><br><span class="line">#查看pip版本号</span><br><span class="line">python -c &quot;import django; print(django.get_version())&quot;</span><br><span class="line"></span><br><span class="line">#重启httpd</span><br><span class="line">systemctl restart httpd</span><br></pre></td></tr></table></figure><p>最后完美解决</p><p>统计mac地址此处就不赘述了，直接最重要的配置<br>在cobbler的web界面上配置：</p><p><img src="../../img/system_create.png" alt="img"></p><p><img src="../../img/system_config1.png" alt="img"></p><p><img src="../../img/system_config2.png" alt="img"></p><p><img src="../../img/system_config3.png" alt="img"></p><p>同步配置并重启相关服务：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# cobbler sync</span><br><span class="line">[root@localhost ~]# systemctl restart httpd</span><br><span class="line">[root@localhost ~]# systemctl restart cobblerd</span><br><span class="line">[root@localhost ~]# systemctl restart xinetd</span><br></pre></td></tr></table></figure><p>最后开机自动会安装系统</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;a id=&quot;more&quot;&gt;&lt;/a&gt;



&lt;h2 id=&quot;1-cobbler简介&quot;&gt;&lt;a href=&quot;#1-cobbler简介&quot; class=&quot;headerlink&quot; title=&quot;1. cobbler简介&quot;&gt;&lt;/a&gt;1. cobbler简介&lt;/h2&gt;&lt;p&gt;&lt;code&gt;Cobbl
      
    
    </summary>
    
      <category term="Linux运维" scheme="http://aiwhs.github.io/categories/Linux%E8%BF%90%E7%BB%B4/"/>
    
    
      <category term="pxe" scheme="http://aiwhs.github.io/tags/pxe/"/>
    
  </entry>
  
  <entry>
    <title>lamp</title>
    <link href="http://aiwhs.github.io/2018/12/22/lamp/"/>
    <id>http://aiwhs.github.io/2018/12/22/lamp/</id>
    <published>2018-12-22T00:15:57.000Z</published>
    <updated>2019-07-17T10:06:40.397Z</updated>
    
    <content type="html"><![CDATA[<a id="more"></a><h2 id="1-lamp简介"><a href="#1-lamp简介" class="headerlink" title="1. lamp简介"></a>1. lamp简介</h2><p>有了前面学习的知识的铺垫，今天可以来学习下第一个常用的web架构了。</p><p>所谓lamp，其实就是由Linux+Apache+Mysql/MariaDB+Php/Perl/Python的一组动态网站或者服务器的开源软件，除Linux外其它各部件本身都是各自独立的程序，但是因为经常被放在一起使用，拥有了越来越高的兼容度，共同组成了一个强大的Web应用程序平台。</p><p>LAMP指的是Linux（操作系统）、Apache（HTTP服务器）、MySQL（也指MariaDB，数据库软件）和PHP（有时也是指Perl或Python）的第一个字母，一般用来建立web应用平台。</p><h2 id="2-web服务器工作流程"><a href="#2-web服务器工作流程" class="headerlink" title="2. web服务器工作流程"></a>2. web服务器工作流程</h2><p>在说lamp架构平台的搭建前，我们先来了解下什么是CGI，什么是FastCGI，什么是……</p><p>web服务器的资源分为两种，静态资源和动态资源</p><ul><li>静态资源就是指静态内容，客户端从服务器获得的资源的表现形式与原文件相同。可以简单的理解为就是直接存储于文件系统中的资源</li><li>动态资源则通常是程序文件，需要在服务器执行之后，将执行的结果返回给客户端</li></ul><p>那么web服务器如何执行程序并将结果返回给客户端呢？下面通过一张图来说明一下web服务器如何处理客户端的请求</p><p><img src="../../img/web_process.png" alt="img1"></p><p>如上图所示</p><p>阶段①显示的是<strong>httpd服务器（即apache）和php服务器通过FastCGI协议进行通信</strong>，且php作为独立的服务进程运行</p><p>阶段②显示的是<strong>php程序和mysql数据库间通过mysql协议进行通信</strong>。php与mysql本没有什么联系，但是由Php语言写成的程序可以与mysql进行数据交互。同理perl和python写的程序也可以与mysql数据库进行交互</p><h3 id="2-1-cgi与fastcgi"><a href="#2-1-cgi与fastcgi" class="headerlink" title="2.1 cgi与fastcgi"></a>2.1 cgi与fastcgi</h3><p>上图阶段①中提到了FastCGI，下面我们来了解下CGI与FastCGI。</p><blockquote><p>CGI（Common Gateway Interface，通用网关接口），CGI是外部应用程序（CGI程序）与WEB服务器之间的接口标准，是在CGI程序和Web服务器之间传递信息的过程。CGI规范允许Web服务器执行外部程序，并将它们的输出发送给Web浏览器，CGI将web的一组简单的静态超媒体文档变成一个完整的新的交互式媒体。</p><p>FastCGI（Fast Common Gateway Interface）是CGI的改良版，CGI是通过启用一个解释器进程来处理每个请求，耗时且耗资源，而FastCGI则是通过master-worker形式来处理每个请求，即启动一个master主进程，然后根据配置启动几个worker进程，当请求进来时，master会从worker进程中选择一个去处理请求，这样就避免了重复的生成和杀死进程带来的频繁cpu上下文切换而导致耗时</p></blockquote><h3 id="2-2-httpd与php结合的方式"><a href="#2-2-httpd与php结合的方式" class="headerlink" title="2.2 httpd与php结合的方式"></a>2.2 httpd与php结合的方式</h3><p>httpd与php结合的方式有以下三种：</p><ul><li>modules：php将以httpd的扩展模块形式存在，需要加载动态资源时，httpd可以直接通过php模块来加工资源并返回给客户端<ul><li>httpd prefork：libphp5.so（多进程模型的php）</li><li>httpd event or worker：libphp5-zts.so（线程模型的php）</li></ul></li><li>CGI：httpd需要加载动态资源时，通过CGI与php解释器联系，获得php执行的结果，此时httpd负责与php连接的建立和断开等</li><li>FastCGI：利用php-fpm机制，启动为服务进程，php自行运行为一个服务，https通过socket与php通信</li></ul><p><strong>较于CGI方式，FastCGI更为常用，很少有人使用CGI方式来加载动态资源</strong></p><h3 id="2-3-web工作流程"><a href="#2-3-web工作流程" class="headerlink" title="2.3 web工作流程"></a>2.3 web工作流程</h3><p>通过上面的图说明一下web的工作流程：</p><ul><li>客户端通过http协议请求web服务器资源</li><li>web服务器收到请求后判断客户端请求的资源是静态资源或是动态资源<ul><li>若是静态资源则直接从本地文件系统取之返回给客户端。</li><li>否则若为动态资源则通过FastCGI协议与php服务器联系，通过CGI程序的master进程调度worker进程来执行程序以获得客户端请求的动态资源，并将执行的结果通过FastCGI协议返回给httpd服务器，httpd服务器收到php的执行结果后将其封装为http响应报文响应给客户端。在执行程序获取动态资源时若需要获得数据库中的资源时，由Php服务器通过mysql协议与MySQL/MariaDB服务器交互，取之而后返回给httpd，httpd将从php服务器收到的执行结果封装成http响应报文响应给客户端。</li></ul></li></ul><h2 id="3-lamp平台构建"><a href="#3-lamp平台构建" class="headerlink" title="3. lamp平台构建"></a>3. lamp平台构建</h2><p><strong>环境说明：</strong></p><table><thead><tr><th align="left">系统平台</th><th align="left">IP</th><th align="left">需要安装的服务</th></tr></thead><tbody><tr><td align="left">centos7 <br>redhat7</td><td align="left">192.168.161.130</td><td align="left">httpd-2.4 <br>mysql-5.7 <br>php<br> php-mysql</td></tr></tbody></table><p>lamp平台软件安装次序：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">httpd --&gt; mysql --&gt; php</span><br></pre></td></tr></table></figure><p><strong>注意：php要求httpd使用prefork MPM</strong></p><h3 id="3-1-安装httpd"><a href="#3-1-安装httpd" class="headerlink" title="3.1 安装httpd"></a>3.1 安装httpd</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">安装开发工具包</span><br><span class="line">[root@localhost ~]# yum groups mark install &apos;Development Tools&apos;</span><br><span class="line"></span><br><span class="line">创建apache服务的用户和组</span><br><span class="line">[root@localhost ~]# groupadd -r apache</span><br><span class="line">[root@localhost ~]# useradd -r -M -s /sbin/nologin -g apache apache </span><br><span class="line"></span><br><span class="line">安装依赖包</span><br><span class="line">[root@localhost ~]# yum -y install openssl-devel pcre-devel expat-devel libtool</span><br><span class="line"></span><br><span class="line">下载和安装apr以及apr-util</span><br><span class="line">[root@localhost ~]# cd /usr/src/</span><br><span class="line">[root@localhost src]# wget http://mirrors.shu.edu.cn/apache//apr/apr-1.6.5.tar.bz2</span><br><span class="line">[root@localhost src]# wget http://mirrors.shu.edu.cn/apache//apr/apr-util-1.6.1.tar.bz2</span><br><span class="line">[root@localhost src]# ls</span><br><span class="line">apr-1.6.5.tar.bz2  apr-util-1.6.1.tar.bz2  debug  kernels</span><br><span class="line">[root@localhost src]# tar xf apr-1.6.5.tar.bz2</span><br><span class="line">[root@localhost src]# tar xf apr-util-1.6.1.tar.bz2</span><br><span class="line">[root@localhost src]# ls</span><br><span class="line">apr-1.6.5  apr-1.6.5.tar.bz2  apr-util-1.6.1  apr-util-1.6.1.tar.bz2  debug  kernels</span><br><span class="line">[root@localhost src]# cd apr-1.6.5</span><br><span class="line">[root@localhost apr-1.6.5]# vim configure</span><br><span class="line">    cfgfile=&quot;$&#123;ofile&#125;T&quot;</span><br><span class="line">    trap &quot;$RM \&quot;$cfgfile\&quot;; exit 1&quot; 1 2 15</span><br><span class="line">    # $RM &quot;$cfgfile&quot;        //将此行加上注释，或者删除此行</span><br><span class="line"></span><br><span class="line">[root@localhost apr-1.6.5]# ./configure --prefix=/usr/local/apr</span><br><span class="line">[root@localhost apr-1.6.5]# make &amp;&amp; make install</span><br><span class="line">[root@localhost apr-1.6.5]# cd /usr/src/apr-util-1.6.1</span><br><span class="line">[root@localhost apr-util-1.6.1]# ./configure --prefix=/usr/local/apr-util --with-apr=/usr/local/apr</span><br><span class="line">[root@localhost apr-util-1.6.1]# make &amp;&amp; make install</span><br><span class="line"></span><br><span class="line">编译安装httpd</span><br><span class="line">[root@localhost ~]# wget http://mirror.bit.edu.cn/apache//httpd/httpd-2.4.37.tar.bz2</span><br><span class="line"></span><br><span class="line">[root@localhost ~]# ls</span><br><span class="line">httpd-2.4.37.tar.bz2</span><br><span class="line">[root@localhost ~]# tar xf httpd-2.4.37.tar.bz2</span><br><span class="line">[root@localhost ~]# cd httpd-2.4.37</span><br><span class="line">[root@localhost httpd-2.4.37]# ./configure --prefix=/usr/local/apache \</span><br><span class="line">--sysconfdir=/etc/httpd24 \</span><br><span class="line">--enable-so \</span><br><span class="line">--enable-ssl \</span><br><span class="line">--enable-cgi \</span><br><span class="line">--enable-rewrite \</span><br><span class="line">--with-zlib \</span><br><span class="line">--with-pcre \</span><br><span class="line">--with-apr=/usr/local/apr \</span><br><span class="line">--with-apr-util=/usr/local/apr-util/ \</span><br><span class="line">--enable-modules=most \</span><br><span class="line">--enable-mpms-shared=all \</span><br><span class="line">--with-mpm=prefork</span><br><span class="line"></span><br><span class="line">[root@localhost httpd-2.4.37]# make &amp;&amp; make install</span><br><span class="line"></span><br><span class="line">安装后配置</span><br><span class="line">[root@localhost ~]# echo &apos;export PATH=/usr/local/apache/bin:$PATH&apos; &gt; /etc/profile.d/httpd.sh</span><br><span class="line">[root@localhost ~]# source /etc/profile.d/httpd.sh</span><br><span class="line">[root@localhost ~]# ln -s /usr/local/apache/include/ /usr/include/httpd</span><br><span class="line">[root@localhost ~]# echo &apos;MANPATH /usr/local/apache/man&apos; &gt;&gt; /etc/man.config</span><br><span class="line"></span><br><span class="line">取消ServerName前面的注释</span><br><span class="line">[root@localhost ~]# sed -i &apos;/#ServerName/s/#//g&apos; /etc/httpd24/httpd.conf </span><br><span class="line"></span><br><span class="line">启动apache</span><br><span class="line">[root@localhost ~]# apachectl start</span><br><span class="line">[root@localhost ~]# ss -antl</span><br><span class="line">State      Recv-Q Send-Q   Local Address:Port                  Peer Address:Port</span><br><span class="line">LISTEN     0      128                  *:22                               *:*</span><br><span class="line">LISTEN     0      100          127.0.0.1:25                               *:*</span><br><span class="line">LISTEN     0      128                 :::80                              :::*</span><br><span class="line">LISTEN     0      128                 :::22                              :::*</span><br><span class="line">LISTEN     0      100                ::1:25                              :::*</span><br></pre></td></tr></table></figure><h3 id="3-2-安装mysql"><a href="#3-2-安装mysql" class="headerlink" title="3.2 安装mysql"></a>3.2 安装mysql</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br></pre></td><td class="code"><pre><span class="line">安装依赖包</span><br><span class="line">[root@localhost ~]# yum -y install ncurses-devel openssl-devel openssl cmake mariadb-devel</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">创建用户和组</span><br><span class="line">[root@localhost src]# groupadd -r -g 306 mysql</span><br><span class="line">[root@localhost src]# useradd -M -s /sbin/nologin -g 306 -u 306 mysql</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">下载二进制格式的mysql软件包</span><br><span class="line">[root@localhost ~]# cd /usr/src/</span><br><span class="line">[root@localhost src]# wget https://downloads.mysql.com/archives/get/file/mysql-5.7.22-linux-glibc2.12-x86_64.tar.gz</span><br><span class="line">--2018-08-13 23:56:27--  https://downloads.mysql.com/archives/get/file/mysql-5.7.22-linux-glibc2.12-x86_64.tar.gz</span><br><span class="line">Resolving downloads.mysql.com (downloads.mysql.com)... 137.254.60.14</span><br><span class="line">Connecting to downloads.mysql.com (downloads.mysql.com)|137.254.60.14|:443... connected.</span><br><span class="line">HTTP request sent, awaiting response... 302 Found</span><br><span class="line">Location: https://cdn.mysql.com/archives/mysql-5.7/mysql-5.7.22-linux-glibc2.12-x86_64.tar.gz [following]</span><br><span class="line">......</span><br><span class="line">Saving to: ‘mysql-5.7.22-linux-glibc2.12-x86_64.tar.gz’</span><br><span class="line"></span><br><span class="line">100%[=====================================&gt;] 643,790,848 2.46MB/s   in 4m 20s</span><br><span class="line"></span><br><span class="line">2018-08-14 00:00:50 (2.36 MB/s) - ‘mysql-5.7.22-linux-glibc2.12-x86_64.tar.gz’saved [643790848/643790848]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">解压软件至/usr/local/</span><br><span class="line">[root@localhost src]# ls</span><br><span class="line">debug  kernels  mysql-5.7.22-linux-glibc2.12-x86_64.tar.gz</span><br><span class="line">[root@localhost src]# tar xf mysql-5.7.22-linux-glibc2.12-x86_64.tar.gz -C /usr/local/</span><br><span class="line">[root@localhost ~]# ls /usr/local/</span><br><span class="line">bin  games    lib    libexec                              sbin   src</span><br><span class="line">etc  include  lib64  mysql-5.7.22-linux-glibc2.12-x86_64  share</span><br><span class="line">[root@localhost ~]# cd /usr/local/</span><br><span class="line">[root@localhost local]# ln -sv mysql-5.7.22-linux-glibc2.12-x86_64/ mysql</span><br><span class="line">‘mysql’ -&gt; ‘mysql-5.7.22-linux-glibc2.12-x86_64/’</span><br><span class="line">[root@localhost local]# ll</span><br><span class="line">total 0</span><br><span class="line">drwxr-xr-x. 2 root root   6 Mar 10  2016 bin</span><br><span class="line">drwxr-xr-x. 2 root root   6 Mar 10  2016 etc</span><br><span class="line">drwxr-xr-x. 2 root root   6 Mar 10  2016 games</span><br><span class="line">drwxr-xr-x. 2 root root   6 Mar 10  2016 include</span><br><span class="line">drwxr-xr-x. 2 root root   6 Mar 10  2016 lib</span><br><span class="line">drwxr-xr-x. 2 root root   6 Mar 10  2016 lib64</span><br><span class="line">drwxr-xr-x. 2 root root   6 Mar 10  2016 libexec</span><br><span class="line">lrwxrwxrwx  1 root root  36 Aug 14 16:00 mysql -&gt; mysql-5.7.22-linux-glibc2.12-x86_64/</span><br><span class="line">drwxr-xr-x  9 root root 129 Aug 14 00:16 mysql-5.7.22-linux-glibc2.12-x86_64</span><br><span class="line">drwxr-xr-x. 2 root root   6 Mar 10  2016 sbin</span><br><span class="line">drwxr-xr-x. 5 root root  49 Jun 13 19:03 share</span><br><span class="line">drwxr-xr-x. 2 root root   6 Mar 10  2016 src</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">修改目录/usr/local/mysql的属主属组</span><br><span class="line">[root@localhost ~]# chown -R mysql.mysql /usr/local/mysql</span><br><span class="line">[root@localhost ~]# ll /usr/local/mysql -d</span><br><span class="line">lrwxrwxrwx 1 mysql mysql 36 Aug 14 16:00 /usr/local/mysql -&gt; mysql-5.7.22-linux-glibc2.12-x86_64/</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">添加环境变量</span><br><span class="line">[root@localhost ~]# ls /usr/local/mysql</span><br><span class="line">bin  COPYING  docs  include  lib  man  README  share  support-files</span><br><span class="line">[root@localhost ~]# echo &apos;export PATH=/usr/local/mysql/bin:$PATH&apos; &gt; /etc/profile.d/mysql.sh</span><br><span class="line">[root@localhost ~]# . /etc/profile.d/mysql.sh</span><br><span class="line">[root@localhost ~]# echo $PATH</span><br><span class="line">/usr/local/mysql/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/root/bin</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">建立数据存放目录</span><br><span class="line">[root@localhost mysql]# mkdir /opt/data</span><br><span class="line">[root@localhost mysql]# chown -R mysql.mysql /opt/data/</span><br><span class="line">[root@localhost mysql]# ll /opt/</span><br><span class="line">total 0</span><br><span class="line">drwxr-xr-x 2 mysql mysql 6 Aug 14 16:54 data</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">初始化数据库</span><br><span class="line">[root@localhost ~]# /usr/local/mysql/bin/mysqld --initialize --user=mysql --datadir=/opt/data/</span><br><span class="line">.......</span><br><span class="line">temporary password is generatedfor root@localhost: adjceSV12=Sa</span><br><span class="line">请注意，这个命令的最后会生成一个临时密码，此处密码是adjceSV12=Sa</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">配置mysql</span><br><span class="line">[root@localhost ~]# ln -sv /usr/local/mysql/include/ /usr/local/include/mysql</span><br><span class="line">‘/usr/local/include/mysql’ -&gt; ‘/usr/local/mysql/include/’</span><br><span class="line">[root@localhost ~]# echo &apos;/usr/local/mysql/lib&apos; &gt; /etc/ld.so.conf.d/mysql.conf</span><br><span class="line">[root@localhost ~]# ldconfig -v</span><br><span class="line">ldconfig: Can&apos;t stat /libx32: No such file or directory</span><br><span class="line">ldconfig: Path `/usr/lib&apos; given more than once</span><br><span class="line">ldconfig: Path `/usr/lib64&apos; given more than once</span><br><span class="line">ldconfig: Can&apos;t stat /usr/libx32: No such file or directory</span><br><span class="line">/usr/lib64/mysql:</span><br><span class="line">        libmysqlclient.so.18 -&gt; libmysqlclient_r.so</span><br><span class="line">/usr/local/mysql/lib:</span><br><span class="line">        libmysqlclient.so.20 -&gt; libmysqlclient.so.20.3.9 </span><br><span class="line">......</span><br><span class="line">/lib/sse2: (hwcap: 0x0000000004000000)</span><br><span class="line">/lib64/sse2: (hwcap: 0x0000000004000000)</span><br><span class="line">/lib64/tls: (hwcap: 0x8000000000000000)</span><br><span class="line">[root@localhost ~]# ldconfig -p |grep mysql</span><br><span class="line">        libmysqlclient.so.20 (libc6,x86-64) =&gt; /usr/local/mysql/lib/libmysqlclient.so.20</span><br><span class="line">        libmysqlclient.so.18 (libc6,x86-64) =&gt; /usr/lib64/mysql/libmysqlclient.so.18</span><br><span class="line">        libmysqlclient.so (libc6,x86-64) =&gt; /usr/lib64/mysql/libmysqlclient.so</span><br><span class="line">        libmysqlclient.so (libc6,x86-64) =&gt; /usr/local/mysql/lib/libmysqlclient.so</span><br><span class="line">        </span><br><span class="line"></span><br><span class="line">生成配置文件</span><br><span class="line">[root@localhost ~]# cat &gt; /etc/my.cnf &lt;&lt;EOF</span><br><span class="line">[mysqld]</span><br><span class="line">basedir = /usr/local/mysql</span><br><span class="line">datadir = /opt/data</span><br><span class="line">socket = /tmp/mysql.sock</span><br><span class="line">port = 3306</span><br><span class="line">pid-file = /opt/data/mysql.pid</span><br><span class="line">user = mysql</span><br><span class="line">skip-name-resolve</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">配置服务启动脚本</span><br><span class="line">[root@localhost ~]# cp -a /usr/local/mysql/support-files/mysql.server /etc/init.d/mysqld</span><br><span class="line">[root@localhost ~]# sed -ri &apos;s#^(basedir=).*#\1/usr/local/mysql#g&apos; /etc/init.d/mysqld</span><br><span class="line">[root@localhost ~]# sed -ri &apos;s#^(datadir=).*#\1/opt/data#g&apos; /etc/init.d/mysqld</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">启动mysql</span><br><span class="line">[root@localhost ~]# service mysqld start</span><br><span class="line">Starting MySQL.. SUCCESS!  </span><br><span class="line">[root@localhost ~]# ps -ef|grep mysql</span><br><span class="line">root       1521      1  0 01:58 pts/0    00:00:00 /bin/sh /usr/local/mysql/binmysqld_safe --datadir=/opt/data --pid-file=/opt/data/mysql.pid</span><br><span class="line">mysql      1699   1521  0 01:58 pts/0    00:00:00 /usr/local/mysql/bin/mysqld --basedir=/usr/local/mysql --datadir=/opt/data --plugin-dir=/usr/local/mysql/lib/plugin --user=mysql --log-error=localhost.localdomain.err --pid-file=/opt/data/mysql.pid --socket=/tmp/mysql.sock --port=3306</span><br><span class="line">root       1734   1301  0 01:59 pts/0    00:00:00 grep --color=auto mysql</span><br><span class="line">[root@localhost ~]# ss -antl</span><br><span class="line">State       Recv-Q Send-Q Local Address:Port               Peer Address:Port</span><br><span class="line">LISTEN      0      128         *:22                      *:*</span><br><span class="line">LISTEN      0      100    127.0.0.1:25                      *:*</span><br><span class="line">LISTEN      0      128        :::22                     :::*</span><br><span class="line">LISTEN      0      100       ::1:25                     :::*</span><br><span class="line">LISTEN      0      80         :::3306                   :::* </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">修改密码</span><br><span class="line">使用临时密码登录</span><br><span class="line">[root@localhost ~]# mysql -uroot -p</span><br><span class="line">Enter password:</span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 2</span><br><span class="line">Server version: 5.7.22</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2018, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type &apos;help;&apos; or &apos;\h&apos; for help. Type &apos;\c&apos; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">mysql&gt; </span><br><span class="line"></span><br><span class="line">设置新密码</span><br><span class="line">mysql&gt; set password = password(&apos;itwhs123[&apos;);</span><br><span class="line">Query OK, 0 rows affected, 1 warning (0.00 sec)</span><br><span class="line">mysql&gt; quit</span><br><span class="line">Bye</span><br></pre></td></tr></table></figure><h3 id="3-3-安装php"><a href="#3-3-安装php" class="headerlink" title="3.3 安装php"></a>3.3 安装php</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line">配置yum源</span><br><span class="line">[root@localhost ~]# cd /etc/yum.repos.d/</span><br><span class="line">[root@localhost yum.repos.d]# wget http://mirrors.163.com/.help/CentOS7-Base-163.repo</span><br><span class="line">[root@localhost ~]# sed -i &apos;s/\$releasever/7/g&apos; /etc/yum.repos.d/CentOS7-Base-163.repo</span><br><span class="line">[root@localhost ~]# sed -i &apos;s/^enabled=.*/enabled=1/g&apos; /etc/yum.repos.d/CentOS7-Base-163.repo</span><br><span class="line">[root@localhost ~]# yum -y install epel-release</span><br><span class="line">[root@localhost ~]# rpm -Uvh https://mirror.webtatic.com/yum/el7/webtatic-release.rpm</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">安装依赖包</span><br><span class="line">[root@localhost ~]# yum -y install libxml2 libxml2-devel openssl openssl-devel bzip2 bzip2-devel libcurl libcurl-devel libicu-devel libjpeg libjpeg-devel libpng libpng-devel openldap-devel  libpcre-devel freetype freetype-devel gmp gmp-devel libmcrypt libmcrypt-devel readline readline-devel libxslt libxslt-devel mhash mhash-devel php72w-mysqlnd</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">下载php</span><br><span class="line">[root@localhost ~]# cd /usr/src/</span><br><span class="line">[root@localhost src]# wget http://cn.php.net/distributions/php-7.2.8.tar.xz</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">编译安装php</span><br><span class="line">[root@localhost src]# tar xf php-7.2.8.tar.xz</span><br><span class="line">[root@localhost src]# cd php-7.2.8</span><br><span class="line">[root@localhost php-7.2.8]# ./configure --prefix=/usr/local/php7  \</span><br><span class="line">--with-config-file-path=/etc \</span><br><span class="line">--enable-fpm \</span><br><span class="line">--enable-inline-optimization \</span><br><span class="line">--disable-debug \</span><br><span class="line">--disable-rpath \</span><br><span class="line">--enable-shared \</span><br><span class="line">--enable-soap \</span><br><span class="line">--with-openssl \</span><br><span class="line">--enable-bcmath \</span><br><span class="line">--with-iconv \</span><br><span class="line">--with-bz2 \</span><br><span class="line">--enable-calendar \</span><br><span class="line">--with-curl \</span><br><span class="line">--enable-exif  \</span><br><span class="line">--enable-ftp \</span><br><span class="line">--with-gd \</span><br><span class="line">--with-jpeg-dir \</span><br><span class="line">--with-png-dir \</span><br><span class="line">--with-zlib-dir \</span><br><span class="line">--with-freetype-dir \</span><br><span class="line">--with-gettext \</span><br><span class="line">--enable-json \</span><br><span class="line">--enable-mbstring \</span><br><span class="line">--enable-pdo \</span><br><span class="line">--with-mysqli=mysqlnd \</span><br><span class="line">--with-pdo-mysql=mysqlnd \</span><br><span class="line">--with-readline \</span><br><span class="line">--enable-shmop \</span><br><span class="line">--enable-simplexml \</span><br><span class="line">--enable-sockets \</span><br><span class="line">--enable-zip \</span><br><span class="line">--enable-mysqlnd-compression-support \</span><br><span class="line">--with-pear \</span><br><span class="line">--enable-pcntl \</span><br><span class="line">--enable-posix</span><br><span class="line">[root@localhost php-7.2.8]# make -j $(cat /proc/cpuinfo |grep processor|wc -l)</span><br><span class="line">编译过程略</span><br><span class="line">[root@localhost php-7.2.8]# make install</span><br><span class="line">安装过程略</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">安装后配置</span><br><span class="line">[root@localhost ~]# echo &apos;export PATH=/usr/local/php7/bin:$PATH&apos; &gt; /etc/profile.d/php7.sh</span><br><span class="line">[root@localhost ~]# source /etc/profile.d/php7.sh</span><br><span class="line">[root@localhost php-7.2.8]# which php</span><br><span class="line">/usr/local/php7/bin/php</span><br><span class="line">[root@localhost php-7.2.8]# php -v</span><br><span class="line">PHP 7.2.8 (cli) (built: May 14 2019 14:32:34) ( NTS )</span><br><span class="line">Copyright (c) 1997-2018 The PHP Group</span><br><span class="line">Zend Engine v3.2.0, Copyright (c) 1998-2018 Zend Technologies</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">配置php-fpm</span><br><span class="line">[root@localhost php-7.2.8]# cp php.ini-production /etc/php.ini</span><br><span class="line">[root@localhost php-7.2.8]# cp sapi/fpm/init.d.php-fpm /etc/init.d/php-fpm</span><br><span class="line">[root@localhost php-7.2.8]# chmod +x /etc/rc.d/init.d/php-fpm</span><br><span class="line">[root@localhost php-7.2.8]# cp /usr/local/php7/etc/php-fpm.conf.default /usr/local/php7/etc/php-fpm.conf</span><br><span class="line">[root@localhost php-7.2.8]# cp /usr/local/php7/etc/php-fpm.d/www.conf.default /usr/local/php7/etc/php-fpm.d/www.conf</span><br><span class="line"></span><br><span class="line">编辑php-fpm的配置文件（/usr/local/php7/etc/php-fpm.conf）：</span><br><span class="line">配置fpm的相关选项为你所需要的值：</span><br><span class="line">[root@localhost ~]# vim /usr/local/php7/etc/php-fpm.conf</span><br><span class="line">.....</span><br><span class="line">.....</span><br><span class="line">pm.max_children = 50    //最多同时提供50个进程提供50个并发服务</span><br><span class="line">pm.start_servers = 5    //启动时启动5个进程</span><br><span class="line">pm.min_spare_servers = 2    //最小空闲进程数</span><br><span class="line">pm.max_spare_servers = 8    //最大空闲进程数</span><br><span class="line"></span><br><span class="line">[root@localhost ~]# tail /usr/local/php7/etc/php-fpm.conf</span><br><span class="line">; file.</span><br><span class="line">; Relative path can also be used. They will be prefixed by:</span><br><span class="line">;  - the global prefix if it&apos;s been set (-p argument)</span><br><span class="line">;  - /usr/local/php7 otherwise</span><br><span class="line">include=/usr/local/php7/etc/php-fpm.d/*.conf</span><br><span class="line">pm.max_children = 50</span><br><span class="line">pm.start_servers = 5</span><br><span class="line">pm.min_spare_servers = 2</span><br><span class="line">pm.max_spare_servers = 8</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">启动php-fpm</span><br><span class="line">[root@localhost ~]# service php-fpm start</span><br><span class="line">Starting php-fpm  done</span><br><span class="line"></span><br><span class="line">默认情况下，fpm监听在127.0.0.1的9000端口，也可以使用如下命令验证其是否已经监听在相应的套接字</span><br><span class="line">[root@localhost ~]# ss -antl</span><br><span class="line">State      Recv-Q Send-Q           Local Address:Port                          Peer Address:Port</span><br><span class="line">LISTEN     0      128                          *:22                                       *:*</span><br><span class="line">LISTEN     0      100                  127.0.0.1:25                                       *:*</span><br><span class="line">LISTEN     0      128                  127.0.0.1:9000                                     *:*</span><br><span class="line">LISTEN     0      128                         :::80                                      :::*</span><br><span class="line">LISTEN     0      128                         :::22                                      :::*</span><br><span class="line">LISTEN     0      100                        ::1:25                                      :::*</span><br><span class="line">LISTEN     0      80                          :::3306                                    :::*</span><br><span class="line"></span><br><span class="line">[root@localhost ~]# ps -ef|grep php</span><br><span class="line">root      81070      1  0 14:13 ?        00:00:00 php-fpm: master process (/usr/local/php7/etc/php-fpm.conf)</span><br><span class="line">nobody    81071  81070  0 14:13 ?        00:00:00 php-fpm: pool www</span><br><span class="line">nobody    81072  81070  0 14:13 ?        00:00:00 php-fpm: pool www</span><br><span class="line">nobody    81073  81070  0 14:13 ?        00:00:00 php-fpm: pool www</span><br><span class="line">nobody    81074  81070  0 14:13 ?        00:00:00 php-fpm: pool www</span><br><span class="line">nobody    81075  81070  0 14:13 ?        00:00:00 php-fpm: pool www</span><br><span class="line">root      81079  83354  0 14:15 pts/1    00:00:00 grep --color=auto php</span><br></pre></td></tr></table></figure><h3 id="3-4-配置apache"><a href="#3-4-配置apache" class="headerlink" title="3.4 配置apache"></a>3.4 配置apache</h3><h4 id="3-4-1-启用代理模块"><a href="#3-4-1-启用代理模块" class="headerlink" title="3.4.1 启用代理模块"></a>3.4.1 启用代理模块</h4><p>在apache httpd 2.4以后已经专门有一个模块针对FastCGI的实现，此模块为mod_proxy_fcgi.so，它其实是作为mod_proxy.so模块的扩展，因此，这两个模块都要加载，编辑httpd.conf文件，取消以下两行内容的注释:</p><ul><li>LoadModule proxy_module modules/mod_proxy.so</li><li>LoadModule proxy_fcgi_module modules/mod_proxy_fcgi.so</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">//启用httpd的相关模块</span><br><span class="line">[root@localhost ~]# sed -i &apos;/proxy_module/s/#//g&apos; /etc/httpd24/httpd.conf</span><br><span class="line">[root@localhost ~]# sed -i &apos;/proxy_fcgi_module/s/#//g&apos; /etc/httpd24/httpd.conf</span><br></pre></td></tr></table></figure><h4 id="3-4-2-配置虚拟主机"><a href="#3-4-2-配置虚拟主机" class="headerlink" title="3.4.2 配置虚拟主机"></a>3.4.2 配置虚拟主机</h4><p>在需要使用fcgi的虚拟主机中添加类似如下两行：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ProxyRequests Off       //关闭正向代理</span><br><span class="line">ProxyPassMatch ^/(.*\.php)$ fcgi://127.0.0.1:9000/PATH/TO/DOCUMENT_ROOT/$1</span><br></pre></td></tr></table></figure><p><strong>例如：</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ProxyPassMatch ^/(.*\.php)$ fcgi://127.0.0.1:9000/var/www/html/itwhs.com/$1</span><br></pre></td></tr></table></figure><p>以上设置表示把以.php结尾的文件请求发送到php-fpm进程，php-fpm至少需要知道运行的目录和URI，所以这里直接在fcgi://127.0.0.1:9000后指明了这两个参数，其它参数的传递已经被mod_proxy_fcgi.so进行了封装，不需要手动指定。</p><p><strong>注意：</strong></p><blockquote><p>这里写的/var/www/html/是yum源安装方式生成的网页存放目录，这里必须改成你编译安装指定的网页存放路径，禁止直接复制我这里的路径<br>这里的idfsoft.com是域名，你必须改成你所使用的域名，禁止直接复制此处的域名<br>这里的$1表示匹配所有以.php结尾的http请求</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">创建虚拟主机目录并生成php测试页面</span><br><span class="line">[root@localhost ~]# mkdir /usr/local/apache/htdocs/itwhs.com</span><br><span class="line">[root@localhost ~]# cat &gt; /usr/local/apache/htdocs/itwhs.com/index.php &lt;&lt;EOF</span><br><span class="line">&lt;?php</span><br><span class="line">   phpinfo();</span><br><span class="line">?&gt;</span><br><span class="line">EOF</span><br><span class="line">[root@localhost ~]# chown -R apache.apache /usr/local/apache/htdocs/</span><br><span class="line">[root@localhost ~]# ll /usr/local/apache/htdocs/ -d</span><br><span class="line">drwxr-xr-x 3 apache apache 44 Aug 16 14:50 /usr/local/apache/htdocs/</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@localhost ~]# vim /etc/httpd24/httpd.conf</span><br><span class="line">在配置文件的最后加入以下内容</span><br><span class="line">&lt;VirtualHost *:80&gt;</span><br><span class="line">    DocumentRoot &quot;/usr/local/apache/htdocs/itwhs.com&quot;</span><br><span class="line">    ServerName www.itwhs.com</span><br><span class="line">    ProxyRequests Off</span><br><span class="line">    ProxyPassMatch ^/(.*\.php)$ fcgi://127.0.0.1:9000/usr/local/apache/htdocs/itwhs.com/$1</span><br><span class="line">    &lt;Directory &quot;/usr/local/apache/htdocs/itwhs.com&quot;&gt;</span><br><span class="line">        Options none</span><br><span class="line">        AllowOverride none</span><br><span class="line">        Require all granted</span><br><span class="line">    &lt;/Directory&gt;</span><br><span class="line">&lt;/VirtualHost&gt;  </span><br><span class="line"></span><br><span class="line">[root@localhost ~]# vim /etc/httpd24/httpd.conf</span><br><span class="line">搜索AddType，添加以下内容</span><br><span class="line">    # If the AddEncoding directives above are commented-out, then you</span><br><span class="line">    # probably should define those extensions to indicate media types:</span><br><span class="line">    #</span><br><span class="line">    AddType application/x-compress .Z</span><br><span class="line">    AddType application/x-gzip .gz .tgz</span><br><span class="line">    AddType application/x-httpd-php .php        //添加此行</span><br><span class="line">    AddType application/x-httpd-php-source .phps        //添加此行</span><br><span class="line">    </span><br><span class="line">[root@localhost ~]# sed -i &apos;/    DirectoryIndex/s/index.html/index.php index.html/g&apos; /etc/httpd24/httpd.conf</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">重启apache服务</span><br><span class="line">[root@localhost ~]# apachectl stop</span><br><span class="line">[root@localhost ~]# ss -antl</span><br><span class="line">State      Recv-Q Send-Q           Local Address:Port                          Peer Address:Port</span><br><span class="line">LISTEN     0      128                          *:22                                       *:*</span><br><span class="line">LISTEN     0      100                  127.0.0.1:25                                       *:*</span><br><span class="line">LISTEN     0      128                  127.0.0.1:9000                                     *:*</span><br><span class="line">LISTEN     0      128                         :::22                                      :::*</span><br><span class="line">LISTEN     0      100                        ::1:25                                      :::*</span><br><span class="line">LISTEN     0      80                          :::3306                                    :::*</span><br><span class="line">[root@localhost ~]# apachectl start</span><br><span class="line">[root@localhost ~]# ss -antl</span><br><span class="line">State      Recv-Q Send-Q           Local Address:Port                          Peer Address:Port</span><br><span class="line">LISTEN     0      128                          *:22                                       *:*</span><br><span class="line">LISTEN     0      100                  127.0.0.1:25                                       *:*</span><br><span class="line">LISTEN     0      128                  127.0.0.1:9000                                     *:*</span><br><span class="line">LISTEN     0      128                         :::80                                      :::*</span><br><span class="line">LISTEN     0      128                         :::22                                      :::*</span><br><span class="line">LISTEN     0      100                        ::1:25                                      :::*</span><br><span class="line">LISTEN     0      80                          :::3306                                    :::*</span><br></pre></td></tr></table></figure><h3 id="3-5-验证"><a href="#3-5-验证" class="headerlink" title="3.5 验证"></a>3.5 验证</h3><p>1.修改/etc/hosts文件，添加域名与IP的映射<br>2.在浏览器上使用域名访问，若看到以下界面则表示lamp架构搭建成功，否则请检查你的操作</p><p><img src="../../img/1557814453086.png" alt="img2"></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;a id=&quot;more&quot;&gt;&lt;/a&gt;



&lt;h2 id=&quot;1-lamp简介&quot;&gt;&lt;a href=&quot;#1-lamp简介&quot; class=&quot;headerlink&quot; title=&quot;1. lamp简介&quot;&gt;&lt;/a&gt;1. lamp简介&lt;/h2&gt;&lt;p&gt;有了前面学习的知识的铺垫，今天可以来学习下第一
      
    
    </summary>
    
      <category term="Linux运维" scheme="http://aiwhs.github.io/categories/Linux%E8%BF%90%E7%BB%B4/"/>
    
    
      <category term="web" scheme="http://aiwhs.github.io/tags/web/"/>
    
  </entry>
  
  <entry>
    <title>gtid主从与传统主从</title>
    <link href="http://aiwhs.github.io/2018/12/16/GTID%E4%B8%BB%E4%BB%8E%20%E4%B8%8E%20%E4%BC%A0%E7%BB%9F%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6/"/>
    <id>http://aiwhs.github.io/2018/12/16/GTID主从 与 传统主从复制/</id>
    <published>2018-12-16T00:15:57.000Z</published>
    <updated>2019-07-17T10:00:41.656Z</updated>
    
    <content type="html"><![CDATA[<a id="more"></a><h1 id="GTID主从-与-传统主从复制"><a href="#GTID主从-与-传统主从复制" class="headerlink" title="GTID主从 与 传统主从复制"></a>GTID主从 与 传统主从复制</h1><h3 id="1-主从复制"><a href="#1-主从复制" class="headerlink" title="1.主从复制"></a>1.主从复制</h3><h4 id="1-）普通主从复制："><a href="#1-）普通主从复制：" class="headerlink" title="1.）普通主从复制："></a>1.）普通主从复制：</h4><p>普通主从复制主要是基于二进制日志文件位置的复制，因此主必须启动二进制日志记录并建立唯一的服务器ID，复制组中的每个服务器都必须配置唯一的服务器ID。如果您省略server-id（或者明确地将其设置为其默认值0），则主设备将拒绝来自从设备的任何连接。 </p><h4 id="2-）-GTID-主从："><a href="#2-）-GTID-主从：" class="headerlink" title="2.） GTID 主从：　"></a>2.） GTID 主从：　</h4><h5 id="（1-）基本概念"><a href="#（1-）基本概念" class="headerlink" title="（1.）基本概念"></a>（1.）基本概念</h5><p>MySQL 5.6 的新特性之一，全局事务标识符（GTID）是创建的唯一标识符，并与在源（主）服务器上提交的每个事务相关联。此标识符不但是唯一的，而且在给定复制设置中的所有服务器上都是唯一的。所有交易和所有GTID之间都有一对一的映射关系 。它由服务器ID以及事务ID组合而成。这个全局事务ID不仅仅在原始服务器上唯一，在所有存在主从关系 的mysql服务器上也是唯一的。正是因为这样一个特性使得mysql的主从复制变得更加简单，以及数据库一致性更可靠。一个GTID在一个服务器上只执行一次，避免重复执行导致数据混乱或者主从不一致。</p><p>一个GTID被表示为一对坐标，用冒号（:）分隔，如下所示：GTID = source_id:transaction_id，source_id标识的源服务器。通常情况下，服务器 server_uuid用于这个目的。这transaction_id是一个序列号，由在此服务器上提交事务的顺序决定 .</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">3E11FA47-71CA-11E1-9E33-C80AA9429562:23</span><br></pre></td></tr></table></figure><p>在传统的主从复制slave端，binlog是不用开启的，但是在GTID中slave端的binlog是必须开启的，目的是记录执行过的GTID（强制）。GTID用来代替classic的复制方法，不在使用binlog+pos开启复制。而是使用master_auto_postion=1的方式自动匹配GTID断点进行复制。</p><p>mysql的主从复制是十分经典的一个应用，但是主从之间总会有数据一致性（data consistency ）的问题，一般情况从库会落后主库几个小时，而且在传统一主多从(mysql5.6之前)的模型中当master down掉后，我们不只是需要将一个slave提成master就可以，还要将其他slave的同步目的地从以前的master改成现在master，而且bin-log的序号和偏移量也要去查看，这是十分不方便和耗时的，但mysql5.6引入gtid之后解决了这个问题。</p><p>红色代表GTID，绿色代表传统主从：</p><p><img src="../../img/1111526-20171110095743841-1230795343.png" alt="img1"></p><h3 id="2-gtid的生命周期"><a href="#2-gtid的生命周期" class="headerlink" title="2.gtid的生命周期"></a>2.gtid的生命周期</h3><p><strong>gtid的生命周期对于配置和维护基于gtid的复制至关重要</strong>。所以，请尽可能理解以下几个过程。</p><p>gtid在master和slave上是一直<strong>持久化保存</strong>(即使删除了日志，也会记录到Previous_GTID中)的。它在master和slave上的生命周期如下：</p><ol><li>客户端发送DDL/DML给master上，master首先对此事务生成一个唯一的gtid，假如为<code>uuid_xxx:1</code>，然后立即执行该事务中的操作。</li></ol><p>注意，主从复制的情况下，sync-binlog基本上都会设置为1，这表示在每次提交事务时将缓存中的binlog刷盘。所以，在事务提交前，gtid以及事务相关操作的信息都在缓存中，提交后它们才写入到binlog file中，然后才会被dump线程dump出去。</p><p>换句话说，<strong>只有提交了的事务，gtid和对应的事务操作才会记录到binlog文件中。记录的格式是先记录gtid，紧跟着再记录事务相关的操作。</strong></p><ol start="2"><li><p>当binlog传送到relay log中后，slave上的SQL线程首先读取该gtid，并设置变量 <em>gtid_next</em> 的值为该gtid，表示下一个要操作的事务是该gtid。 <em>gtid_next</em> <strong>是基于会话的，不同会话的gtid_next不同。</strong></p></li><li><p>随后slave检测该gtid在自己的binlog中是否存在。如果存在，则放弃此gtid事务；如果不存在，则将此gtid写入到<strong>自己的binlog中</strong>，然后立刻执行该事务，并在自己的binlog中记录该事务相关的操作。</p></li></ol><p>注意，<strong>slave上replay的时候，gtid不是提交后才写到自己的binlog file的，而是判断gtid不存在后立即写入binlog file。</strong></p><p>通过这种在执行事务前先检查并写gtid到binlog的机制，不仅可以保证当前会话在此之前没有执行过该事务，还能保证没有其他会话读取了该gtid却没有提交。因为如果其他会话读取了该gtid会立即写入到binlog(不管是否已经开始执行事务)，所以当前会话总能读取到binlog中的该gtid，于是当前会话就会放弃该事务。总之，一个gtid事务是决不允许多次执行、多个会话并行执行的。</p><ol start="4"><li>slave在重放relay log中的事务时，不会自己生成gtid，所以所有的slave(无论是何种方式的一主一从或一主多从复制架构)通过重放relay log中事务获取的gtid都来源于master，并永久保存在slave上。</li></ol><h4 id="一张图说明GTID复制"><a href="#一张图说明GTID复制" class="headerlink" title="一张图说明GTID复制"></a>一张图说明GTID复制</h4><p>使用xtrabackup备份的方式提供gtid复制的基准数据。其中涉及到一些gtid检查、设置的操作。通过这些操作，大概可以感受的到gtid复制的几个概念。</p><p>用一张图来说明：</p><p><img src="../../img/733013-20180610232911355-1454041164.png" alt="img2"></p><p>假如当前master的gtid为A3，已经purge掉的gtid为”1–&gt;A1”，备份到slave上的数据为1-A2部分。</p><p>如果<code>A1 = 0</code>，表示master的binlog没有被Purge过。slave可以直接开启gtid复制，但这样可能速度较慢，因为slave要复制所有binlog。也可以将master数据备份到slave上，然后设置 <em>gtid_purged</em> 跳过备份结束时的gtid，这样速度较快。</p><p>如果<code>A1 != 0</code>，表示master上的binlog中删除了一部分gtid。此时slave上必须先从master处恢复purge掉的那部分日志对应的数据。上图中备份结束时的GTID为A2。然后slave开启复制，唯一需要考虑的是”是否需要设置 <em>gtid_purged</em> 跳过一部分gtid以避免重复执行”。</p><p>备份数据到slave上，方式可以是mysqldump、冷备份、xtrabackup备份都行。由于gtid复制的特性，所需要的操作都很少，也很简单，前提是理解了”gtid的生命周期”。</p><h3 id="3-基于gtid复制的好处"><a href="#3-基于gtid复制的好处" class="headerlink" title="3.基于gtid复制的好处"></a>3.基于gtid复制的好处</h3><p>从上面可以看出，gtid复制的优点大致有：</p><ol><li><strong>保证同一个事务在某slave上绝对只执行一次，没有执行过的gtid事务总是会被执行。</strong></li><li><strong>不用像传统复制那样保证binlog的坐标准确，因为根本不需要binlog以及坐标。</strong></li><li><strong>故障转移到新的master的时候很方便，简化了很多任务。</strong></li><li><strong>很容易判断master和slave的数据是否一致。只要master上提交的事务在slave上也提交了，那么一定是一致的。</strong></li></ol><p>当然，MySQL提供了选项可以控制跳过某些gtid事务，防止slave第一次启动复制时执行master上的所有事务而导致耗时过久。</p><p>虽然对于row-based和statement-based的格式都能进行gtid复制，但建议采用row-based格式。</p><h3 id="2-）GTID的工作原理："><a href="#2-）GTID的工作原理：" class="headerlink" title="2.）GTID的工作原理："></a>2.）GTID的工作原理：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">1、当一个事务在主库端执行并提交时，产生GTID，一同记录到binlog日志中。</span><br><span class="line">2、binlog传输到slave,并存储到slave的relaylog后，读取这个GTID的这个值设置gtid_next变量，即告诉Slave，下一个要执行的GTID值。</span><br><span class="line">3、sql线程从relay log中获取GTID，然后对比slave端的binlog是否有该GTID。</span><br><span class="line">4、如果有记录，说明该GTID的事务已经执行，slave会忽略。</span><br><span class="line">5、如果没有记录，slave就会执行该GTID事务，并记录该GTID到自身的binlog，在读取执行事务前会先检查其他session持有该GTID，确保不被重复执行。</span><br><span class="line">6、在解析过程中会判断是否有主键，如果有就用二级索引，如果没有就用全部扫描。</span><br></pre></td></tr></table></figure><h2 id="4-MySQL基于GTID主从复制实战"><a href="#4-MySQL基于GTID主从复制实战" class="headerlink" title="4.MySQL基于GTID主从复制实战"></a>4.MySQL基于GTID主从复制实战</h2><h3 id="4-1-前提条件"><a href="#4-1-前提条件" class="headerlink" title="4.1 前提条件"></a>4.1 前提条件</h3><ol><li>准备 3 台服务器</li><li>安装 MySQL 并且运行状态正常，MySQL 安装参考</li><li>两台服务器配置时间同步</li><li>关闭 SELINUX</li><li>防火墙放行 3306 端口</li></ol><h3 id="4-2-配置一主一从的-GTID-复制"><a href="#4-2-配置一主一从的-GTID-复制" class="headerlink" title="4.2 配置一主一从的 GTID 复制"></a>4.2 配置一主一从的 GTID 复制</h3><h4 id="4-2-1-环境说明"><a href="#4-2-1-环境说明" class="headerlink" title="4.2.1 环境说明"></a>4.2.1 环境说明</h4><p><img src="../../img/2019-05-17_150444.png" alt></p><h4 id="4-2-2-修改-master-配置文件"><a href="#4-2-2-修改-master-配置文件" class="headerlink" title="4.2.2 修改 master 配置文件"></a>4.2.2 修改 master 配置文件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@ip-10-0-100-31 ~]# vim /etc/my.cnf</span><br><span class="line"># mysql GTID</span><br><span class="line">log-bin=/var/lib/mysql/mysql-bin # 必须项,这里目录属主和组必须是mysql</span><br><span class="line">binlog_format=row # 建议项</span><br><span class="line">sync-binlog=1 # 建议项</span><br><span class="line">server-id=101 # 必须项</span><br><span class="line">master_info_repository=table # 建议项</span><br><span class="line">relay_log_info_repository=table # 建议项</span><br><span class="line">enforce_gtid_consistency=on # gtid复制需要加上的必须项</span><br><span class="line">gtid_mode=on # gtid复制需要加上的必须项</span><br></pre></td></tr></table></figure><p>修改配置文件后重启 MySQL</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@ip-10-0-100-31 ~]# service mysqld restart</span><br></pre></td></tr></table></figure><h4 id="4-2-3-修改-slave-配置文件"><a href="#4-2-3-修改-slave-配置文件" class="headerlink" title="4.2.3 修改 slave 配置文件"></a>4.2.3 修改 slave 配置文件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@ip-10-0-100-134 ~]# vim /etc/my.cnf </span><br><span class="line"># mysql GTID</span><br><span class="line">log-bin=/var/lib/mysql/slave-bin # mysql 5.6必须项，mysql 5.7非必须项</span><br><span class="line">binlog_format=row # 建议项</span><br><span class="line">relay-log=/var/lib/mysql/relay-bin # 必须项</span><br><span class="line">sync-binlog=1 # 建议项</span><br><span class="line">server-id=182 # 必须项</span><br><span class="line">master_info_repository=table # 建议项 </span><br><span class="line">relay_log_info_repository=table # 建议项 </span><br><span class="line">enforce_gtid_consistency=on # gtid复制需要加上的必须项</span><br><span class="line">gtid_mode=on # gtid复制需要加上的必须项</span><br></pre></td></tr></table></figure><p>修改配置文件后重启 MySQL</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@ip-10-0-100-134 ~]# service mysqld restart</span><br></pre></td></tr></table></figure><h4 id="4-2-4-master-上创建复制用户"><a href="#4-2-4-master-上创建复制用户" class="headerlink" title="4.2.4 master 上创建复制用户"></a>4.2.4 master 上创建复制用户</h4><p>在 master 上执行</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; create user &apos;whs&apos;@&apos;10.0.100.%&apos; identified by &apos;itwhs123!&apos;;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; grant replication slave on *.* to &apos;whs&apos;@&apos;10.0.100.%&apos;;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; flush privileges;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure><h4 id="4-2-5-slave-启用复制线程"><a href="#4-2-5-slave-启用复制线程" class="headerlink" title="4.2.5 slave 启用复制线程"></a>4.2.5 slave 启用复制线程</h4><p>因为全新实例 master 上的 binlog 没有删除过，所以在 slave 上直接change master to 配置连接参数。</p><p>在 slave 上执行</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; CHANGE MASTER TO MASTER_HOST=&apos;10.0.100.31&apos;,MASTER_PORT=3306,MASTER_AUTO_POSITION=1;</span><br><span class="line">Query OK, 0 rows affected (0.03 sec)</span><br></pre></td></tr></table></figure><p>因为是 MySQL 5.7，没有在 change master to 语句中加入 user 和 password 项，而是在 start slave 语句中使用，否则会警告。</p><p>现在启动 slave 上的两个复制线程:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; START SLAVE USER=&apos;whs&apos; PASSWORD=&apos;itwhs123!&apos;;</span><br><span class="line">Query OK, 0 rows affected, 1 warning (0.00 sec)</span><br></pre></td></tr></table></figure><h4 id="4-2-6-验证-GTID-复制是否生效"><a href="#4-2-6-验证-GTID-复制是否生效" class="headerlink" title="4.2.6 验证 GTID 复制是否生效"></a>4.2.6 验证 GTID 复制是否生效</h4><p>查看 io 线程和 sql 线程是否正常。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show processlist;</span><br><span class="line">+----+-------------+-----------+------+---------+------+--------------------------------------------------------+------------------+</span><br><span class="line">| Id | User        | Host      | db   | Command | Time | State                                                  | Info             |</span><br><span class="line">+----+-------------+-----------+------+---------+------+--------------------------------------------------------+------------------+</span><br><span class="line">|  2 | root        | localhost | NULL | Query   |    0 | starting                                               | show processlist |</span><br><span class="line">|  3 | system user |           | NULL | Connect |   29 | Waiting for master to send event                       | NULL             |</span><br><span class="line">|  4 | system user |           | NULL | Connect |  168 | Slave has read all relay log; waiting for more updates | NULL             |</span><br><span class="line">+----+-------------+-----------+------+---------+------+--------------------------------------------------------+------------------+</span><br><span class="line">3 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure><p>在 master 上新增一些测试数据：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">DROP DATABASE IF EXISTS backuptest;</span><br><span class="line">CREATE DATABASE backuptest;</span><br><span class="line">USE backuptest;</span><br><span class="line"></span><br><span class="line"># 创建myisam类型的数值辅助表和插入数据的存储过程</span><br><span class="line">CREATE TABLE num_isam (n INT NOT NULL PRIMARY KEY) ENGINE = MYISAM ;</span><br><span class="line"></span><br><span class="line">DROP PROCEDURE IF EXISTS proc_num1;</span><br><span class="line">DELIMITER $$</span><br><span class="line">CREATE PROCEDURE proc_num1 (num INT) </span><br><span class="line">BEGIN</span><br><span class="line">    DECLARE rn INT DEFAULT 1 ;</span><br><span class="line">    TRUNCATE TABLE backuptest.num_isam ;</span><br><span class="line">    INSERT INTO backuptest.num_isam VALUES(1) ;</span><br><span class="line">    dd: WHILE rn * 2 &lt; num DO </span><br><span class="line">        BEGIN</span><br><span class="line">            INSERT INTO backuptest.num_isam </span><br><span class="line">            SELECT rn + n FROM backuptest.num_isam;</span><br><span class="line">            SET rn = rn * 2 ;</span><br><span class="line">        END ;</span><br><span class="line">    END WHILE dd;</span><br><span class="line">    INSERT INTO backuptest.num_isam </span><br><span class="line">    SELECT n + rn </span><br><span class="line">    FROM backuptest.num_isam </span><br><span class="line">    WHERE n + rn &lt;= num;</span><br><span class="line">END ;</span><br><span class="line">$$</span><br><span class="line">DELIMITER ;</span><br><span class="line"></span><br><span class="line"># 创建innodb类型的数值辅助表和插入数据的存储过程</span><br><span class="line">CREATE TABLE num_innodb (n INT NOT NULL PRIMARY KEY) ENGINE = INNODB ;</span><br><span class="line"></span><br><span class="line">DROP PROCEDURE IF EXISTS proc_num2;</span><br><span class="line">DELIMITER $$</span><br><span class="line">CREATE PROCEDURE proc_num2 (num INT) </span><br><span class="line">BEGIN</span><br><span class="line">    DECLARE rn INT DEFAULT 1 ;</span><br><span class="line">    TRUNCATE TABLE backuptest.num_innodb ;</span><br><span class="line">    INSERT INTO backuptest.num_innodb VALUES(1) ;</span><br><span class="line">    dd: WHILE rn * 2 &lt; num DO </span><br><span class="line">        BEGIN</span><br><span class="line">            INSERT INTO backuptest.num_innodb </span><br><span class="line">            SELECT rn + n FROM backuptest.num_innodb;</span><br><span class="line">            SET rn = rn * 2 ;</span><br><span class="line">        END ;</span><br><span class="line">    END WHILE dd;</span><br><span class="line">    INSERT INTO backuptest.num_innodb </span><br><span class="line">    SELECT n + rn </span><br><span class="line">    FROM backuptest.num_innodb </span><br><span class="line">    WHERE n + rn &lt;= num ;</span><br><span class="line">END ;</span><br><span class="line">$$</span><br><span class="line">DELIMITER ;</span><br><span class="line"></span><br><span class="line"># 分别向两个数值辅助表中插入100W条数据</span><br><span class="line">CALL proc_num1 (1000000) ;</span><br><span class="line">CALL proc_num2 (1000000) ;</span><br></pre></td></tr></table></figure><p>在 slave 上查看 slave 的状态，以下是同步结束后的状态信息：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show slave status\G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">               Slave_IO_State: Waiting for master to send event</span><br><span class="line">                  Master_Host: 10.0.100.31</span><br><span class="line">                  Master_User: whs</span><br><span class="line">                  Master_Port: 3306</span><br><span class="line">                Connect_Retry: 60</span><br><span class="line">              Master_Log_File: mysql-bin.000003</span><br><span class="line">          Read_Master_Log_Pos: 10058377</span><br><span class="line">               Relay_Log_File: relay-bin.000002</span><br><span class="line">                Relay_Log_Pos: 10058590</span><br><span class="line">        Relay_Master_Log_File: mysql-bin.000003</span><br><span class="line">             Slave_IO_Running: Yes</span><br><span class="line">            Slave_SQL_Running: Yes</span><br><span class="line">              Replicate_Do_DB: </span><br><span class="line">          Replicate_Ignore_DB: </span><br><span class="line">           Replicate_Do_Table: </span><br><span class="line">       Replicate_Ignore_Table: </span><br><span class="line">      Replicate_Wild_Do_Table: </span><br><span class="line">  Replicate_Wild_Ignore_Table: </span><br><span class="line">                   Last_Errno: 0</span><br><span class="line">                   Last_Error: </span><br><span class="line">                 Skip_Counter: 0</span><br><span class="line">          Exec_Master_Log_Pos: 10058377</span><br><span class="line">              Relay_Log_Space: 10058791</span><br><span class="line">              Until_Condition: None</span><br><span class="line">               Until_Log_File: </span><br><span class="line">                Until_Log_Pos: 0</span><br><span class="line">           Master_SSL_Allowed: No</span><br><span class="line">           Master_SSL_CA_File: </span><br><span class="line">           Master_SSL_CA_Path: </span><br><span class="line">              Master_SSL_Cert: </span><br><span class="line">            Master_SSL_Cipher: </span><br><span class="line">               Master_SSL_Key: </span><br><span class="line">        Seconds_Behind_Master: 0</span><br><span class="line">Master_SSL_Verify_Server_Cert: No</span><br><span class="line">                Last_IO_Errno: 0</span><br><span class="line">                Last_IO_Error: </span><br><span class="line">               Last_SQL_Errno: 0</span><br><span class="line">               Last_SQL_Error: </span><br><span class="line">  Replicate_Ignore_Server_Ids: </span><br><span class="line">             Master_Server_Id: 101</span><br><span class="line">                  Master_UUID: aece386a-7877-11e9-959a-0a6df75fd3e6</span><br><span class="line">             Master_Info_File: mysql.slave_master_info</span><br><span class="line">                    SQL_Delay: 0</span><br><span class="line">          SQL_Remaining_Delay: NULL</span><br><span class="line">      Slave_SQL_Running_State: Slave has read all relay log; waiting for more updates</span><br><span class="line">           Master_Retry_Count: 86400</span><br><span class="line">                  Master_Bind: </span><br><span class="line">      Last_IO_Error_Timestamp: </span><br><span class="line">     Last_SQL_Error_Timestamp: </span><br><span class="line">               Master_SSL_Crl: </span><br><span class="line">           Master_SSL_Crlpath: </span><br><span class="line">           Retrieved_Gtid_Set: aece386a-7877-11e9-959a-0a6df75fd3e6:1-55</span><br><span class="line">            Executed_Gtid_Set: aece386a-7877-11e9-959a-0a6df75fd3e6:1-55</span><br><span class="line">                Auto_Position: 1</span><br><span class="line">         Replicate_Rewrite_DB: </span><br><span class="line">                 Channel_Name: </span><br><span class="line">           Master_TLS_Version: </span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure><p>至此处一主已从基础 GTID 复制就完成了。</p><h3 id="4-3-添加新的-slave-到-GTID-复制集群中"><a href="#4-3-添加新的-slave-到-GTID-复制集群中" class="headerlink" title="4.3 添加新的 slave 到 GTID 复制集群中"></a>4.3 添加新的 slave 到 GTID 复制集群中</h3><p>上面的实验是基于全新的实例，生产环境中往往 master 数据库已经运行了很久，并且 binlog 可能会定期删除掉一部分，所以，为了配置更通用的 gtid 复制环境，这里把刚才的 master 的 binlog 给 purge 掉一部分。模拟实际环境中定期删除了一部分 binlog 的场景。</p><p>目前 master 上的 binlog 使用情况如下，不难发现绝大多数操作都集中在mysql-bin.000001 这个 binlog 中。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@ip-10-0-100-31 ~]# ll /var/lib/mysql/*bin*</span><br><span class="line">-rw-r-----. 1 mysql mysql      177 May 17 08:17 /var/lib/mysql/mysql-bin.000001</span><br><span class="line">-rw-r-----. 1 mysql mysql      177 May 17 08:18 /var/lib/mysql/mysql-bin.000002</span><br><span class="line">-rw-r-----. 1 mysql mysql 10058377 May 17 08:50 /var/lib/mysql/mysql-bin.000003</span><br><span class="line">-rw-r-----. 1 mysql mysql       96 May 17 08:18 /var/lib/mysql/mysql-bin.index</span><br></pre></td></tr></table></figure><p>purge 已有的 binlog:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; flush logs;</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; purge master logs to &apos;mysql/mysql-bin.000003&apos;;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure><p>查看当前使用的 binlog</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@ip-10-0-100-31 ~]# cat /var/lib/mysql/mysql-bin.index</span><br><span class="line">/var/lib/mysql/mysql-bin.000003</span><br><span class="line">/var/lib/mysql/mysql-bin.000004</span><br></pre></td></tr></table></figure><h4 id="4-3-1-当前环境说明"><a href="#4-3-1-当前环境说明" class="headerlink" title="4.3.1 当前环境说明"></a>4.3.1 当前环境说明</h4><p><img src="../../img/2019-05-17_151306.png" alt></p><h4 id="4-3-2-修改-slave2-节点配置文件"><a href="#4-3-2-修改-slave2-节点配置文件" class="headerlink" title="4.3.2 修改 slave2 节点配置文件"></a>4.3.2 修改 slave2 节点配置文件</h4><p>其中 slave2 节点的配置文件和 slave1 的配置文件完全相同：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@ip-10-0-100-143 ~]# vim /etc/my.cnf </span><br><span class="line"># mysql GTID</span><br><span class="line">log-bin=/var/lib/mysql/slave-bin # mysql 5.6必须项，mysql 5.7非必须项</span><br><span class="line">binlog_format=row # 建议项</span><br><span class="line">relay-log=/var/lib/mysql/relay-bin # 必须项</span><br><span class="line">sync-binlog=1 # 建议项</span><br><span class="line">server-id=183 # 必须项</span><br><span class="line">master_info_repository=table # 建议项 </span><br><span class="line">relay_log_info_repository=table # 建议项 </span><br><span class="line">enforce_gtid_consistency=on # gtid复制需要加上的必须项</span><br><span class="line">gtid_mode=on # gtid复制需要加上的必须项</span><br></pre></td></tr></table></figure><h4 id="4-3-3-备份-master-节点数据"><a href="#4-3-3-备份-master-节点数据" class="headerlink" title="4.3.3 备份 master 节点数据"></a>4.3.3 备份 master 节点数据</h4><p>我这里没有安装 xtrabackup 的 innobackupex 工具，所以使用 mysqldump。</p><p>在 master 节点执行：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@ip-10-0-100-31 ~]# mysqldump -uroot -pjbgsn123! -R --triggers --master-data=2 --single-transaction --set-gtid-purged=OFF --all-databases &gt; all.sql</span><br><span class="line">mysqldump: [Warning] Using a password on the command line interface can be insecure.</span><br></pre></td></tr></table></figure><p>将数据复制到 slave2 节点</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@ip-10-0-100-31 ~]# mv all.sql /nfs/</span><br></pre></td></tr></table></figure><h4 id="4-3-4-将备份恢复到-slave2"><a href="#4-3-4-将备份恢复到-slave2" class="headerlink" title="4.3.4 将备份恢复到 slave2"></a>4.3.4 将备份恢复到 slave2</h4><p>在 slave 2上执行：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@ip-10-0-100-143 ~]# mysql -uroot -pjbgsn123! &lt;/nfs/all.sql </span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br></pre></td></tr></table></figure><h4 id="4-3-5-在-master-查看已经执行过的事务"><a href="#4-3-5-在-master-查看已经执行过的事务" class="headerlink" title="4.3.5 在 master 查看已经执行过的事务"></a>4.3.5 在 master 查看已经执行过的事务</h4><p>查看已经执行过的事务，这部分是不需要再 slave2 上执行了，因为已经都恢复数据过去了。</p><p>在 master 上直接查看 gtid_executed 的值，注意不是 gtid_purged 的值，master 上的 gtid_purged 表示的是曾经删除掉的 binlog。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show global variables like &apos;%gtid%&apos;;</span><br><span class="line">+----------------------------------+-------------------------------------------+</span><br><span class="line">| Variable_name                    | Value                                     |</span><br><span class="line">+----------------------------------+-------------------------------------------+</span><br><span class="line">| binlog_gtid_simple_recovery      | ON                                        |</span><br><span class="line">| enforce_gtid_consistency         | ON                                        |</span><br><span class="line">| gtid_executed                    | aece386a-7877-11e9-959a-0a6df75fd3e6:1-55 |</span><br><span class="line">| gtid_executed_compression_period | 1000                                      |</span><br><span class="line">| gtid_mode                        | ON                                        |</span><br><span class="line">| gtid_owned                       |                                           |</span><br><span class="line">| gtid_purged                      |                                           |</span><br><span class="line">| session_track_gtids              | OFF                                       |</span><br><span class="line">+----------------------------------+-------------------------------------------+</span><br><span class="line">8 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure><h4 id="4-3-6-启用-slave2-上的复制线程"><a href="#4-3-6-启用-slave2-上的复制线程" class="headerlink" title="4.3.6 启用 slave2 上的复制线程"></a>4.3.6 启用 slave2 上的复制线程</h4><p>可以在启动 slave2 线程之前使用 gtid_purged 变量来指定需要跳过的 gtid 集合。但因为要设置 gtid_purged 必须保证全局变量 gtid_executed为空，所以先在 slave2 上执行 reset master(注意，不是 reset slave)，再设置 gtid_purged。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; reset master;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; set @@global.gtid_purged=&apos;aece386a-7877-11e9-959a-0a6df75fd3e6:1-55&apos;;</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br></pre></td></tr></table></figure><p>设置好 gtid_purged 之后，就可以开启复制线程了。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; CHANGE MASTER TO MASTER_HOST=&apos;10.0.100.31&apos;,MASTER_PORT=3306,MASTER_AUTO_POSITION=1;</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; START SLAVE USER=&apos;whs&apos; PASSWORD=&apos;itwhs123!&apos;;</span><br><span class="line">Query OK, 0 rows affected, 1 warning (0.00 sec)</span><br></pre></td></tr></table></figure><p>查看 slave2 的状态，看是否正确启动了复制功能。如果没错，再在 master 上修改一部分数据，检查是否同步到 slave1和 slave2。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show slave status\G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">               Slave_IO_State: Waiting for master to send event</span><br><span class="line">                  Master_Host: 10.0.100.31</span><br><span class="line">                  Master_User: whs</span><br><span class="line">                  Master_Port: 3306</span><br><span class="line">                Connect_Retry: 60</span><br><span class="line">              Master_Log_File: mysql-bin.000004</span><br><span class="line">          Read_Master_Log_Pos: 194</span><br><span class="line">               Relay_Log_File: relay-bin.000002</span><br><span class="line">                Relay_Log_Pos: 367</span><br><span class="line">        Relay_Master_Log_File: mysql-bin.000004</span><br><span class="line">             Slave_IO_Running: Yes</span><br><span class="line">            Slave_SQL_Running: Yes</span><br><span class="line">              Replicate_Do_DB: </span><br><span class="line">          Replicate_Ignore_DB: </span><br><span class="line">           Replicate_Do_Table: </span><br><span class="line">       Replicate_Ignore_Table: </span><br><span class="line">      Replicate_Wild_Do_Table: </span><br><span class="line">  Replicate_Wild_Ignore_Table: </span><br><span class="line">                   Last_Errno: 0</span><br><span class="line">                   Last_Error: </span><br><span class="line">                 Skip_Counter: 0</span><br><span class="line">          Exec_Master_Log_Pos: 194</span><br><span class="line">              Relay_Log_Space: 568</span><br><span class="line">              Until_Condition: None</span><br><span class="line">               Until_Log_File: </span><br><span class="line">                Until_Log_Pos: 0</span><br><span class="line">           Master_SSL_Allowed: No</span><br><span class="line">           Master_SSL_CA_File: </span><br><span class="line">           Master_SSL_CA_Path: </span><br><span class="line">              Master_SSL_Cert: </span><br><span class="line">            Master_SSL_Cipher: </span><br><span class="line">               Master_SSL_Key: </span><br><span class="line">        Seconds_Behind_Master: 0</span><br><span class="line">Master_SSL_Verify_Server_Cert: No</span><br><span class="line">                Last_IO_Errno: 0</span><br><span class="line">                Last_IO_Error: </span><br><span class="line">               Last_SQL_Errno: 0</span><br><span class="line">               Last_SQL_Error: </span><br><span class="line">  Replicate_Ignore_Server_Ids: </span><br><span class="line">             Master_Server_Id: 101</span><br><span class="line">                  Master_UUID: aece386a-7877-11e9-959a-0a6df75fd3e6</span><br><span class="line">             Master_Info_File: mysql.slave_master_info</span><br><span class="line">                    SQL_Delay: 0</span><br><span class="line">          SQL_Remaining_Delay: NULL</span><br><span class="line">      Slave_SQL_Running_State: Slave has read all relay log; waiting for more updates</span><br><span class="line">           Master_Retry_Count: 86400</span><br><span class="line">                  Master_Bind: </span><br><span class="line">      Last_IO_Error_Timestamp: </span><br><span class="line">     Last_SQL_Error_Timestamp: </span><br><span class="line">               Master_SSL_Crl: </span><br><span class="line">           Master_SSL_Crlpath: </span><br><span class="line">           Retrieved_Gtid_Set: </span><br><span class="line">            Executed_Gtid_Set: aece386a-7877-11e9-959a-0a6df75fd3e6:1-55</span><br><span class="line">                Auto_Position: 1</span><br><span class="line">         Replicate_Rewrite_DB: </span><br><span class="line">                 Channel_Name: </span><br><span class="line">           Master_TLS_Version: </span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure><p>在 master 上创建一个测试数据库 mydb 检查 slave1 和 slave2 节点能否同步。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; create database mydb;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br></pre></td></tr></table></figure><p>slave1 节点查看</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show databases;</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| backuptest         |</span><br><span class="line">| mydb               |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| sys                |</span><br><span class="line">+--------------------+</span><br><span class="line">6 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure><p>slave1节点验证数据同步</p><p>slave2 节点查看</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show databases;</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| backuptest         |</span><br><span class="line">| mydb               |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| sys                |</span><br><span class="line">+--------------------+</span><br><span class="line">6 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure><p>slave2节点验证数据同步</p><h4 id="4-3-7-回到-master，purge-掉已同步的-binlog"><a href="#4-3-7-回到-master，purge-掉已同步的-binlog" class="headerlink" title="4.3.7 回到 master，purge 掉已同步的 binlog"></a>4.3.7 回到 master，purge 掉已同步的 binlog</h4><p>当 slave 指定 gtid_purged 并实现了同步之后，为了下次重启 mysqld 实例不用再次设置 gtid_purged(甚至可能会在启动的时候自动开启复制线程)，所以应该去 master 上将已经同步的 binlog 给 purged 掉。</p><p>在 master 上执行</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; flush logs;</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; purge master logs to &apos;mysql-bin.000005&apos;;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; show global variables like &apos;%gtid%&apos;;</span><br><span class="line">+----------------------------------+-------------------------------------------+</span><br><span class="line">| Variable_name                    | Value                                     |</span><br><span class="line">+----------------------------------+-------------------------------------------+</span><br><span class="line">| binlog_gtid_simple_recovery      | ON                                        |</span><br><span class="line">| enforce_gtid_consistency         | ON                                        |</span><br><span class="line">| gtid_executed                    | aece386a-7877-11e9-959a-0a6df75fd3e6:1-56 |</span><br><span class="line">| gtid_executed_compression_period | 1000                                      |</span><br><span class="line">| gtid_mode                        | ON                                        |</span><br><span class="line">| gtid_owned                       |                                           |</span><br><span class="line">| gtid_purged                      | aece386a-7877-11e9-959a-0a6df75fd3e6:1-56 |</span><br><span class="line">| session_track_gtids              | OFF                                       |</span><br><span class="line">+----------------------------------+-------------------------------------------+</span><br><span class="line">8 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure><h3 id="4-4-GTID-复制相关的状态信息和变量"><a href="#4-4-GTID-复制相关的状态信息和变量" class="headerlink" title="4.4 GTID 复制相关的状态信息和变量"></a>4.4 GTID 复制相关的状态信息和变量</h3><h4 id="4-4-1-show-slave-status-中和-gtid-复制相关的状态行"><a href="#4-4-1-show-slave-status-中和-gtid-复制相关的状态行" class="headerlink" title="4.4.1 show slave status 中和 gtid 复制相关的状态行"></a>4.4.1 show slave status 中和 gtid 复制相关的状态行</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Retrieved_Gtid_Set: aece386a-7877-11e9-959a-0a6df75fd3e6:56</span><br><span class="line">Executed_Gtid_Set: aece386a-7877-11e9-959a-0a6df75fd3e6:1-56</span><br><span class="line">Auto_Position: 1</span><br></pre></td></tr></table></figure><ul><li>Retrieved_Gtid_Set：在开启了 gtid 复制(即 gtid_mode=on)时，slave 在启动 io 线程的时候会检查自己的 relay log，并从中检索出gtid 集合。也就是说，这代表的是 slave 已经从 master 中复制了哪些事务过来。检索出来的 gtid 不会再请求 master 发送过来。</li><li>Executed_Gtid_Set：在开启了 gtid 复制(即 gtid_mode=on)时，它表示已经向自己的 binlog 中写入了哪些 gtid 集合。注意，这个值是根据一些状态信息计算出来的，并非 binlog 中能看到的那些。举个特殊一点的例子，可能 slave 的 binlog 还是空的，但这里已经显示一些已执行 gtid 集合了。</li><li>Auto_Position：开启 gtid 时是否自动获取 binlog 坐标。1 表示开启，这是 gtid 复制的默认值。</li></ul><h4 id="4-4-2-一些重要的变量"><a href="#4-4-2-一些重要的变量" class="headerlink" title="4.4.2 一些重要的变量"></a>4.4.2 一些重要的变量</h4><ul><li>gtid_mode：是否开启gtid复制模式。只允许on/off类的布尔值，不允许其他类型(如1/0)的布尔值，实际上这个变量是枚举类型的。要设置 gtid_mode=on ，必须同时设置 enforce_gtid_consistency 开。在MySQL 5.6中，还必须开启 log_slave_updates ，即使是master也要开启。</li><li>enforce_gtid_consistency：强制要求只允许复制事务安全的事务。 gtid_mode=on 时必须显式设置该项，如果不给定值，则默认为 on。应该尽量将该选项放在 gtid_mode 的前面，减少启动 mysqld 时的检查。</li><li>不能在事务内部创建和删除临时表。只能在事务外部进行，且 autocommit 需要设置为 1。</li><li>不能执行 create table … select 语句。该语句除了创建一张新表并填充一些数据，其他什么事也没干。</li><li>不能在事务内既更新事务表又更新非事务表。</li><li>gtid_executed：已经执行过的 GTID。 reset master 会清空该项的全局变量值。</li><li>gtid_purged：已经 purge 掉的 gtid。要设置该项，必须先保证gtid_executed 已经为空，这意味着也一定会同时设置该项为空。在 slave 上设置该项时，表示稍后启动 io 线程和 SQL 线程都跳过这些 gtid，slave 上设置时应该让此项的 gtid 集合等于 master上 gtid_executed 的值。</li><li>gtid_next：表示下一个要执行的gtid事务。</li></ul><p>需要注意，master和slave上都有gtid_executed和gtid_purged，它们代表的意义有时候是不同的。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;a id=&quot;more&quot;&gt;&lt;/a&gt;



&lt;h1 id=&quot;GTID主从-与-传统主从复制&quot;&gt;&lt;a href=&quot;#GTID主从-与-传统主从复制&quot; class=&quot;headerlink&quot; title=&quot;GTID主从 与 传统主从复制&quot;&gt;&lt;/a&gt;GTID主从 与 传统主从复制&lt;/h1&gt;
      
    
    </summary>
    
      <category term="Linux运维" scheme="http://aiwhs.github.io/categories/Linux%E8%BF%90%E7%BB%B4/"/>
    
    
      <category term="MySQL" scheme="http://aiwhs.github.io/tags/MySQL/"/>
    
  </entry>
  
  <entry>
    <title>proxysql中间件</title>
    <link href="http://aiwhs.github.io/2018/12/15/mysql%E4%B8%AD%E9%97%B4%E4%BB%B6proxysql%E5%AE%9E%E7%8E%B0mysql%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB/"/>
    <id>http://aiwhs.github.io/2018/12/15/mysql中间件proxysql实现mysql读写分离/</id>
    <published>2018-12-15T00:15:57.000Z</published>
    <updated>2019-07-17T08:20:00.879Z</updated>
    
    <content type="html"><![CDATA[<a id="more"></a><h2 id="1-mysql实现读写分离的方式"><a href="#1-mysql实现读写分离的方式" class="headerlink" title="1. mysql实现读写分离的方式"></a>1. mysql实现读写分离的方式</h2><p>mysql 实现读写分离的方式有以下几种：</p><ul><li>程序修改mysql操作，直接和数据库通信，简单快捷的读写分离和随机的方式实现的负载均衡，权限独立分配，需要开发人员协助。</li><li>amoeba，直接实现读写分离和负载均衡，不用修改代码，有很灵活的数据解决方案，自己分配账户，和后端数据库权限管理独立，权限处理不够灵活。</li><li>mysql-proxy，直接实现读写分离和负载均衡，不用修改代码，master和slave用一样的帐号，效率低</li><li>mycat中间件</li><li>proxysql中间件（推荐使用）</li></ul><h2 id="2-ProxySQL简介"><a href="#2-ProxySQL简介" class="headerlink" title="2. ProxySQL简介"></a>2. ProxySQL简介</h2><p>ProxySQL 是一款可以实际用于生产环境的 MySQL 中间件，它有官方版和 percona 版两种。percona版是在官方版的基础上修改的，添加了几个比较实用的工具。生产环境建议用官方版。</p><p>ProxySQL 是用 C++ 语言开发的，虽然也是一个轻量级产品，但性能很好(据测试，能处理千亿级的数据)，功能也足够，能满足中间件所需的绝大多数功能，包括：</p><ul><li>最基本的读/写分离，且方式有多种</li><li>可定制基于用户、基于schema、基于语句的规则对SQL语句进行路由。换句话说，规则很灵活。基于schema和与语句级的规则，可以实现简单的sharding(分库分表)</li><li>可缓存查询结果。虽然ProxySQL的缓存策略比较简陋，但实现了基本的缓存功能，绝大多数时候也够用了。此外，作者已经打算实现更丰富的缓存策略</li><li>监控后端节点。ProxySQL可以监控后端节点的多个指标，包括：ProxySQL和后端的心跳信息，后端节点的read-only/read-write，slave和master的数据同步延迟性(replication lag)</li></ul><h2 id="3-ProxySQL安装"><a href="#3-ProxySQL安装" class="headerlink" title="3. ProxySQL安装"></a>3. ProxySQL安装</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">//配置yum源</span><br><span class="line">[root@proxysql ~]# cat &lt;&lt;EOF | tee /etc/yum.repos.d/proxysql.repo</span><br><span class="line">[proxysql_repo]</span><br><span class="line">name= ProxySQL</span><br><span class="line">baseurl=http://repo.proxysql.com/ProxySQL/proxysql-1.4.x/centos/7</span><br><span class="line">gpgcheck=1</span><br><span class="line">gpgkey=http://repo.proxysql.com/ProxySQL/repo_pub_key</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">[root@proxysql ~]# yum -y install proxysql</span><br></pre></td></tr></table></figure><h2 id="4-ProxySQL的Admin管理接口"><a href="#4-ProxySQL的Admin管理接口" class="headerlink" title="4. ProxySQL的Admin管理接口"></a>4. ProxySQL的Admin管理接口</h2><p>当 ProxySQL 启动后，将监听两个端口：</p><ul><li>admin管理接口，默认端口为6032。该端口用于查看、配置ProxySQL</li><li>接收SQL语句的接口，默认端口为6033，这个接口类似于MySQL的3306端口</li></ul><p><img src="../../img/proxysql_admin.png" alt="img"></p><p>ProxySQL 的 admin 管理接口是一个使用 MySQL 协议的接口，所以，可以直接使用 mysql 客户端、navicat 等工具去连接这个管理接口，其默认的用户名和密码均为 admin</p><p>例如，使用 mysql 客户端去连接 ProxySQL 的管理接口：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@proxysql ~]# mysql -uadmin -padmin -h127.0.0.1 -P6032</span><br><span class="line">Welcome to the MariaDB monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 6</span><br><span class="line">Server version: 5.5.30 (ProxySQL Admin Module)</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.</span><br><span class="line"></span><br><span class="line">Type &apos;help;&apos; or &apos;\h&apos; for help. Type &apos;\c&apos; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">MySQL [(none)]&gt; show databases;</span><br><span class="line">+-----+---------------+-------------------------------------+</span><br><span class="line">| seq | name          | file                                |</span><br><span class="line">+-----+---------------+-------------------------------------+</span><br><span class="line">| 0   | main          |                                     |</span><br><span class="line">| 2   | disk          | /var/lib/proxysql/proxysql.db       |</span><br><span class="line">| 3   | stats         |                                     |</span><br><span class="line">| 4   | monitor       |                                     |</span><br><span class="line">| 5   | stats_history | /var/lib/proxysql/proxysql_stats.db |</span><br><span class="line">+-----+---------------+-------------------------------------+</span><br><span class="line">5 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure><p>由于 ProxySQL 的配置全部保存在几个自带的库中，所以通过管理接口，可以非常方便地通过发送一些SQL命令去修改 ProxySQL 的配置。 ProxySQL 会解析通过该接口发送的某些对ProxySQL 有效的特定命令，并将其合理转换后发送给内嵌的 SQLite3 数据库引擎去运行</p><p>ProxySQL 的配置几乎都是通过管理接口来操作的，通过 Admin 管理接口，可以在线修改几乎所有的配置并使其生效。只有两个变量的配置是必须重启 ProxySQL 才能生效的，它们是：<br><strong>mysql-threads 和 mysql-stacksize</strong></p><h2 id="5-和admin管理接口相关的变量"><a href="#5-和admin管理接口相关的变量" class="headerlink" title="5. 和admin管理接口相关的变量"></a>5. 和admin管理接口相关的变量</h2><h3 id="5-1-admin-admin-credentials"><a href="#5-1-admin-admin-credentials" class="headerlink" title="5.1 admin-admin_credentials"></a>5.1 admin-admin_credentials</h3><p>admin-admin_credentials 变量控制的是admin管理接口的管理员账户。默认的管理员账户和密码为admin:admin，但是这个默认的用户只能在本地使用。如果想要远程连接到ProxySQL，例如用windows上的navicat连接Linux上的ProxySQL管理接口，必须自定义一个管理员账户。</p><p><strong>添加管理员帐户</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">MySQL [(none)]&gt; select @@admin-admin_credentials;       //查看当前用户名和密码</span><br><span class="line">+---------------------------+</span><br><span class="line">| @@admin-admin_credentials |</span><br><span class="line">+---------------------------+</span><br><span class="line">| admin:admin               |</span><br><span class="line">+---------------------------+</span><br><span class="line">1 row in set (0.01 sec)</span><br><span class="line"></span><br><span class="line">//设置管理员帐号myadmin,密码wangqing123!</span><br><span class="line">MySQL [(none)]&gt; set admin-admin_credentials=&apos;admin:admin;myadmin:wangqing123!&apos;;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)]&gt; select @@admin-admin_credentials;</span><br><span class="line">+----------------------------------+</span><br><span class="line">| @@admin-admin_credentials        |</span><br><span class="line">+----------------------------------+</span><br><span class="line">| admin:admin;runtime:wangqing123! |</span><br><span class="line">+----------------------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)]&gt; load admin variables to runtime;    //使修改立即生效</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)]&gt; save admin variables to disk;   //使修改永久保存到磁盘</span><br><span class="line">Query OK, 31 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure><p>修改后，就可以使用该用户名和密码连接管理接口</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@proxysql ~]# mysql -umyadmin -pwangqing123! -h172.16.12.128 -P6032</span><br><span class="line">Welcome to the MariaDB monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 7</span><br><span class="line">Server version: 5.5.30 (ProxySQL Admin Module)</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.</span><br><span class="line"></span><br><span class="line">Type &apos;help;&apos; or &apos;\h&apos; for help. Type &apos;\c&apos; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">MySQL [(none)]&gt;</span><br></pre></td></tr></table></figure><p>所有的配置操作都是在修改main库中对应的表</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">MySQL [(none)]&gt; select * from global_variables where variable_name=&apos;admin-admin_credentials&apos;;</span><br><span class="line">+-------------------------+----------------------------------+</span><br><span class="line">| variable_name           | variable_value                   |</span><br><span class="line">+-------------------------+----------------------------------+</span><br><span class="line">| admin-admin_credentials | admin:admin;myadmin:wangqing123! |</span><br><span class="line">+-------------------------+----------------------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure><p><strong>必须要区分admin管理接口的用户名和mysql_users中的用户名</strong></p><ul><li>admin管理接口的用户是连接到管理接口(默认端口6032)上用来管理、配置ProxySQL的</li><li>mysql_users表中的用户名是应用程序连接ProxySQL(默认端口6033)，以及ProxySQL连接后端MySQL Servers使用的用户。它的作用是发送、路由SQL语句，类似于MySQL Server的3306端口。所以，这个表中的用户必须已经在后端MySQL Server上存在且授权了</li></ul><p><strong>admin管理接口的用户必须不能存在于mysql_users中，这是出于安全的考虑，防止通过admin管理接口用户猜出mysql_users中的用户</strong></p><h3 id="5-2-admin-stats-credentials"><a href="#5-2-admin-stats-credentials" class="headerlink" title="5.2 admin-stats_credentials"></a>5.2 admin-stats_credentials</h3><p>admin-stats_credentials 变量控制admin管理接口的普通用户，这个变量中的用户没有超级管理员权限，只能查看monitor库和main库中关于统计的数据，其它库都是不可见的，且没有任何写权限</p><p>默认的普通用户名和密码均为 stats ，与admin一样，它默认也只能用于本地登录，若想让人远程查看则要添加查看的专有用户</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">MySQL [(none)]&gt; select @@admin-stats_credentials;</span><br><span class="line">+---------------------------+</span><br><span class="line">| @@admin-stats_credentials |</span><br><span class="line">+---------------------------+</span><br><span class="line">| stats:stats               |</span><br><span class="line">+---------------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">//添加专有的查看用户</span><br><span class="line">MySQL [(none)]&gt; set admin-stats_credentials=&apos;stats:stats;mystats:wangqing123!&apos;;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)]&gt; select @@admin-stats_credentials;</span><br><span class="line">+----------------------------------+</span><br><span class="line">| @@admin-stats_credentials        |</span><br><span class="line">+----------------------------------+</span><br><span class="line">| stats:stats;mystats:wangqing123! |</span><br><span class="line">+----------------------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)]&gt; load admin variables to runtime;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)]&gt; save admin variables to disk;</span><br><span class="line">Query OK, 31 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure><p>同样，<strong>这个变量中的用户必须不能存在于mysql_users表中</strong><br>使用mystats用户远程连接查看</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[root@proxysql ~]# mysql -umystats -pwangqing123! -h172.16.12.128 -P6032</span><br><span class="line">Welcome to the MariaDB monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 11</span><br><span class="line">Server version: 5.5.30 (ProxySQL Admin Module)</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.</span><br><span class="line"></span><br><span class="line">Type &apos;help;&apos; or &apos;\h&apos; for help. Type &apos;\c&apos; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">MySQL [(none)]&gt;</span><br><span class="line"></span><br><span class="line">MySQL [(none)]&gt; show tables from main;</span><br><span class="line">+--------------------------------------+</span><br><span class="line">| tables                               |</span><br><span class="line">+--------------------------------------+</span><br><span class="line">| global_variables                     |    </span><br><span class="line">| stats_memory_metrics                 |</span><br><span class="line">| stats_mysql_commands_counters        |</span><br><span class="line">| stats_mysql_connection_pool          |</span><br><span class="line">| stats_mysql_connection_pool_reset    |</span><br><span class="line">| stats_mysql_global                   |</span><br><span class="line">| stats_mysql_prepared_statements_info |</span><br><span class="line">| stats_mysql_processlist              |</span><br><span class="line">| stats_mysql_query_digest             |</span><br><span class="line">| stats_mysql_query_digest_reset       |</span><br><span class="line">| stats_mysql_query_rules              |</span><br><span class="line">| stats_mysql_users                    |</span><br><span class="line">| stats_proxysql_servers_checksums     |</span><br><span class="line">| stats_proxysql_servers_metrics       |</span><br><span class="line">| stats_proxysql_servers_status        |</span><br><span class="line">+--------------------------------------+</span><br><span class="line">15 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure><h3 id="5-3-admin-mysql-ifaces"><a href="#5-3-admin-mysql-ifaces" class="headerlink" title="5.3 admin-mysql_ifaces"></a>5.3 admin-mysql_ifaces</h3><p>admin-mysql_ifaces 变量指定admin接口的监听地址，格式为冒号分隔的hostname:port列表。默认监听在 0.0.0.0:6032</p><p>注意，允许使用UNIX的domain socket进行监听，这样本主机内的应用程序就可以直接被处理。<br>例如：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">MySQL [(none)]&gt; SET admin-mysql_ifaces=&apos;0.0.0.0:6032;/tmp/proxysql_admin.sock&apos;;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)]&gt; load admin variables to runtime;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)]&gt; save admin variables to disk;</span><br><span class="line">Query OK, 31 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure><h2 id="6-多层配置系统"><a href="#6-多层配置系统" class="headerlink" title="6. 多层配置系统"></a>6. 多层配置系统</h2><h3 id="6-1-proxysql中的库"><a href="#6-1-proxysql中的库" class="headerlink" title="6.1 proxysql中的库"></a>6.1 proxysql中的库</h3><p><strong>使用ProxySQL的Admin管理接口连上ProxySQL，可查看ProxySQL拥有的库</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@proxysql ~]# mysql -umyadmin -pwangqing123! -h172.16.12.128 -P6032</span><br><span class="line">Welcome to the MariaDB monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 14</span><br><span class="line">Server version: 5.5.30 (ProxySQL Admin Module)</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.</span><br><span class="line"></span><br><span class="line">Type &apos;help;&apos; or &apos;\h&apos; for help. Type &apos;\c&apos; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">MySQL [(none)]&gt; show databases;</span><br><span class="line">+-----+---------------+-------------------------------------+</span><br><span class="line">| seq | name          | file                                |</span><br><span class="line">+-----+---------------+-------------------------------------+</span><br><span class="line">| 0   | main          |                                     |</span><br><span class="line">| 2   | disk          | /var/lib/proxysql/proxysql.db       |</span><br><span class="line">| 3   | stats         |                                     |</span><br><span class="line">| 4   | monitor       |                                     |</span><br><span class="line">| 5   | stats_history | /var/lib/proxysql/proxysql_stats.db |</span><br><span class="line">+-----+---------------+-------------------------------------+</span><br><span class="line">5 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure><p>其中：</p><ul><li>main库是ProxySQL最主要的库，是需要修改配置时使用的库，它其实是一个内存数据库系统。所以，修改main库中的配置后，必须将其持久化到disk上才能永久保存</li><li>disk库是磁盘数据库，该数据库结构和内存数据库完全一致。当持久化内存数据库中的配置时，其实就是写入到disk库中。磁盘数据库的默认路径为 $DATADIR/proxysql.db</li><li>stats库是统计信息库。这个库中的数据一般是在检索其内数据时临时填充的，它保存在内存中。因为没有相关的配置项，所以无需持久化</li><li>monitor库是监控后端MySQL节点相关的库，该库中只有几个log类的表，监控模块收集到的监控信息全都存放到对应的log表中</li><li>stats_history库是1.4.4版新增的库，用于存放历史统计数据。默认路径为 $DATADIR/proxysql_stats.db</li></ul><p>ProxySQL 内部使用的是 SQLite3 数据库，无论是内存数据库还是磁盘数据库，都是通过SQLite3引 擎进行解析、操作的。它和 MySQL 的语法可能稍有不同，但ProxySQL会对不兼容的语法自动进行调整，最大程度上保证MySQL语句的有效率。<br>上面描述main库的时候，只是说了内存数据库需要持久化到disk库才能永久保存配置。但实际上，修改了main库中的配置后，并不会立即生效，它还需要load到runtime的数据结构中才生效，只有在runtime数据结构中的配置才是对ProxySQL当前有效的配置</p><h3 id="6-2-ProxySQL多层配置系统"><a href="#6-2-ProxySQL多层配置系统" class="headerlink" title="6.2 ProxySQL多层配置系统"></a>6.2 ProxySQL多层配置系统</h3><p>ProxySQL 的配置系统非常强大，它能在线修改几乎所有配置(仅有的两个需要重启才能生效的变量为 mysql-threads 和 mysql-stacksize )，并在线生效、持久化保存。这得益于它采用的多层配置系统。<br>多层配置系统结构如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">+-------------------------+</span><br><span class="line">|         RUNTIME         |</span><br><span class="line">+-------------------------+</span><br><span class="line">       /|\          |</span><br><span class="line">        |           |</span><br><span class="line">    [1] |       [2] |</span><br><span class="line">        |          \|/</span><br><span class="line">+-------------------------+</span><br><span class="line">|         MEMORY          |</span><br><span class="line">+-------------------------+ _</span><br><span class="line">       /|\          |      |\</span><br><span class="line">        |           |        \</span><br><span class="line">    [3] |       [4] |         \ [5]</span><br><span class="line">        |          \|/         \</span><br><span class="line">+-------------------------+  +---------------+</span><br><span class="line">|          DISK           |  |  CONFIG FILE  |</span><br><span class="line">+-------------------------+  +---------------+</span><br></pre></td></tr></table></figure><p>最底层的是 disk 库和 config file 。这里需要注意，这里的 config file 就是传统的配置文件，默认为 /etc/proxysql.cnf ， ProxySQL 启动时，主要是从 disk 库中读取配置加载到内存并最终加载到 runtime 生效，只有极少的几个特定配置内容是从 config file 中加载的，除非是第一次初始化 ProxySQL 运行环境(或者disk库为空)。</p><p>中间层的是 memory ，表示的是内存数据库，其实就是 main 库。通过管理接口修改的所有配置，都保存在内存数据库(main)中。当 ProxySQL 重启或者崩溃时，这个内存数据库中的数据会丢失，所以需要 save 到 disk 库中。</p><p>最上层的是 runtime ，它是 ProxySQL 有关线程运行时读取的数据结构。换句话说，该数据结构中的配置都是已生效的配置。所以，修改了 main 库中的配置后，必须 load 到 runtime 数据结构中才能使其生效。<br>在上面的多层配置系统图中，标注了[1]、[2]、[3]、[4]、[5]的序号。每个序号都有两个操作方向from/to，其实只是所站角度不同而已。以下是各序号对应的操作：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[1] ：将内存数据库中的配置加载到RUNTIME数据结构中</span><br><span class="line">        LOAD XXX FROM MEMORY</span><br><span class="line">        LOAD XXX TO RUNTIME</span><br><span class="line"></span><br><span class="line">[2] ：将RUNTIME数据结构中的配置持久化到内存数据库中</span><br><span class="line">        SAVE XXX FROM RUNTIME</span><br><span class="line">        SAVE XXX TO MEMORY</span><br><span class="line"></span><br><span class="line">[3] ：将磁盘数据库中的配置加载到内存数据库中</span><br><span class="line">        LOAD XXX FROM DISK</span><br><span class="line">        LOAD XXX TO MEMORY</span><br><span class="line"></span><br><span class="line">[4] ：将内存数据库中的配置持久化到磁盘数据库中</span><br><span class="line">        SAVE XXX FROM MEMORY</span><br><span class="line">        SAVE XXX TO DISK</span><br><span class="line"></span><br><span class="line">[5] ：从传统配置文件中读取配置加载到内存数据库中</span><br><span class="line">        LOAD XXX FROM CONFIG</span><br></pre></td></tr></table></figure><p><strong>DISK/MEMORY/RUNTIME/CONFIG 可以缩写，只要能识别即可。例如MEMORY可以缩写为MEM，runtime可以缩写为run</strong></p><p>另外，上面的XXX是什么？这表示要加载/保存的是哪类配置。目前的ProxySQL支持以下几种：</p><ul><li>mysql users</li><li>mysql servers</li><li>mysql variables</li><li>mysql query rules</li><li>admin variables</li><li>scheduler</li><li>proxysql_servers：目前ProxySQL集群功能还处于实验阶段，所以该类配置不应该去使用</li></ul><p>这些从main库或disk库中就可以查看到</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">MySQL [(none)]&gt; show tables from disk;</span><br><span class="line">+------------------------------------+</span><br><span class="line">| tables                             |</span><br><span class="line">+------------------------------------+</span><br><span class="line">| global_variables                   |  # (1)</span><br><span class="line">| mysql_collations                   |  # (N)</span><br><span class="line">| mysql_group_replication_hostgroups |  # (2)</span><br><span class="line">| mysql_query_rules                  |  # (3)</span><br><span class="line">| mysql_query_rules_fast_routing     |  # (4)</span><br><span class="line">| mysql_replication_hostgroups       |  # (5)</span><br><span class="line">| mysql_servers                      |  # (6)</span><br><span class="line">| mysql_users                        |  # (7)</span><br><span class="line">| proxysql_servers                   |  # (8)</span><br><span class="line">| scheduler                          |  # (9)</span><br><span class="line">+------------------------------------+</span><br><span class="line">10 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure><p>上面的结果中我给这些表都标注了一些序号，其所对应的表的内容有以下讲究：</p><ul><li>(1)中包含两类变量，以amdin-开头的表示admin variables，以mysql-开头的表示mysql variables。修改哪类变量，前文的XXX就代表哪类</li><li>(2,5,6)对应的都是mysql servers</li><li>(3,4)对应的是mysql query rules</li><li>(7)对应的mysql users</li><li>(9)对应的scheduler</li><li>(N)只是一张表，保存的是ProxySQL支持的字符集和排序规则，它是不用修改的</li><li>(8)是ProxySQL的集群配置表，该功能目前还处于实验阶段。如果想要配置该功能，则load/save proxysql_servers to/from …</li></ul><h3 id="6-3-启动ProxySQL时如何加载配置"><a href="#6-3-启动ProxySQL时如何加载配置" class="headerlink" title="6.3 启动ProxySQL时如何加载配置"></a>6.3 启动ProxySQL时如何加载配置</h3><p>如果 ProxySQL 是刚安装的，或者磁盘数据库文件为空(甚至不存在)，或者启动 ProxySQL 时使用了选项 –initial，这几种情况启动 ProxySQL 时，都会从传统配置文件 config file 中读取配置加载到内存数据库，并自动 load 到 runtime 数据结构、save到磁盘数据库，这是初始化 ProxySQL 运行环境的过程。</p><p>如果不是第一次启动 ProxySQL ，由于已经存在磁盘数据库文件，这时 ProxySQL 会从磁盘数据库中读取几乎所有的配置(即使传统配置文件中配置了某项，也不会去解析)，但有3项是必须从传统配置文件中读取，它们分别是：</p><ul><li>datadir：ProxySQL启动时，必须从配置文件中确定它的数据目录，因为磁盘数据库文件、日志以及其它一些文件是存放在数据目录下的。如果使用/etc/init.d/proxysql管理ProxySQL，则除了修改/etc/proxysql.cnf的datadir，还需要修改该脚本中的datadir。</li><li>restart_on_missing_heartbeats：MySQL线程丢失多少次心跳，就会杀掉这个线程并重启它。默认值为10。</li><li>execute_on_exit_failure：如果设置了该变量，ProxySQL父进程将在每次ProxySQL崩溃的时候执行已经定义好的脚本。建议使用它来生成一些崩溃时的警告和日志。注意，ProxySQL的重启速度可能只有几毫秒，因此很多其它的监控工具可能无法探测到ProxySQL的一次普通故障，此时可使用该变量</li></ul><h2 id="7-不同类型的读写分离方案解析"><a href="#7-不同类型的读写分离方案解析" class="headerlink" title="7. 不同类型的读写分离方案解析"></a>7. 不同类型的读写分离方案解析</h2><p>数据库中间件最基本的功能就是实现读写分离， ProxySQL 当然也支持。而且 ProxySQL 支持的路由规则非常灵活，不仅可以实现最简单的读写分离，还可以将读/写都分散到多个不同的组，以及实现分库 sharding (分表sharding的规则比较难写，但也能实现)。</p><p>本文只描述通过规则制定的语句级读写分离，不讨论通过 ip/port, client, username, schemaname 实现的读写分离。</p><p>下面描述了ProxySQL能实现的常见读写分离类型</p><h3 id="7-1-最简单的读写分离"><a href="#7-1-最简单的读写分离" class="headerlink" title="7.1 最简单的读写分离"></a>7.1 最简单的读写分离</h3><p><img src="../../img/proxysql_read&write1.png" alt="img"></p><p>这种模式的读写分离，严格区分后端的master和slave节点，且slave节点必须设置选项read_only=1</p><p>在ProxySQL上，分两个组，一个写组HG=10，一个读组HG=20。同时在ProxySQL上开启monitor模块的read_only监控功能，让ProxySQL根据监控到的read_only值来自动调整节点放在HG=10(master会放进这个组)还是HG=20(slave会放进这个组)</p><p>这种模式的读写分离是最简单的，只需在mysql_users表中设置用户的默认路由组为写组HG=10，并在mysql_query_rules中加上两条简单的规则(一个select for update，一个select)即可</p><p>这种读写分离模式，在环境较小时能满足绝大多数需求。但是需求复杂、环境较大时，这种模式就太过死板，因为一切都是monitor模块控制的</p><h3 id="7-2-多个读组或写组的分离模式"><a href="#7-2-多个读组或写组的分离模式" class="headerlink" title="7.2 多个读组或写组的分离模式"></a>7.2 多个读组或写组的分离模式</h3><p>前面那种读写分离模式，是通过 monitor 模块监控 read_only 来调整的，所以每一个后端集群必须只能分为一个写组，一个读组。<br>但如果想要区分不同的 select ，并将不同的 select 路由到不同的节点上。例如有些查询语句的开销非常大，想让它们独占一个节点/组，其它查询共享一个节点/组，怎么实现？</p><p>例如，下面这种模式</p><p><img src="../../img/proxysql_read&write2.png" alt="img"></p><p>看上去非常简单。但是却能适应各种需求。例如，后端做了分库，对某库的查询要路由到特定的主机组</p><p>至于各个主机组是同一个主从集群(下图左边)，还是互相独立的主从集群环境(下图右边)，要看具体的需求，不过这种读写分离模式都能应付</p><p><img src="../../img/proxysql_read&write3.png" alt="img"></p><p>在实现这种模式时，前提是不能开启monitor模块的read_only监控功能，也不要设置mysql_replication_hostgroup 表</p><p>例如，下面的配置实现的是上图左边的结构：写请求路由给HG=10，对test1库的select语句路由给HG=20，其它select路由给HG=30</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">mysql_servers: </span><br><span class="line">+--------------+----------+------+--------+--------+</span><br><span class="line">| hostgroup_id | hostname | port | status | weight |</span><br><span class="line">+--------------+----------+------+--------+--------+</span><br><span class="line">| 10           | host1    | 3306 | ONLINE | 1      |</span><br><span class="line">| 20           | host2    | 3306 | ONLINE | 1      |</span><br><span class="line">| 30           | host3    | 3306 | ONLINE | 1      |</span><br><span class="line">+--------------+----------+------+--------+--------+</span><br><span class="line"></span><br><span class="line">mysql_users: </span><br><span class="line">+----------+-------------------+</span><br><span class="line">| username | default_hostgroup |</span><br><span class="line">+----------+-------------------+</span><br><span class="line">| root     | 10                |</span><br><span class="line">+----------+-------------------+</span><br><span class="line"></span><br><span class="line">mysql_query_rules: </span><br><span class="line">+---------+-----------------------+----------------------+</span><br><span class="line">| rule_id | destination_hostgroup | match_digest         |</span><br><span class="line">+---------+-----------------------+----------------------+</span><br><span class="line">| 1       | 10                    | ^SELECT.*FOR UPDATE$ |</span><br><span class="line">| 2       | 20                    | ^SELECT.*test1\..*   |</span><br><span class="line">| 3       | 30                    | ^SELECT              |</span><br><span class="line">+---------+-----------------------+----------------------+</span><br></pre></td></tr></table></figure><p><strong>查看表结构的方式：</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PRAGMA  table_info(&quot;表名&quot;);</span><br></pre></td></tr></table></figure><h2 id="8-ProxySQL实现读写分离示例"><a href="#8-ProxySQL实现读写分离示例" class="headerlink" title="8. ProxySQL实现读写分离示例"></a>8. ProxySQL实现读写分离示例</h2><p><strong>环境说明：</strong></p><table><thead><tr><th align="center">IP</th><th align="center">角色</th><th align="center">应用</th><th align="center">系统平台</th></tr></thead><tbody><tr><td align="center">192.168.153.136</td><td align="center">读写分离解析主机</td><td align="center">proxysql</td><td align="center">centos7.6</td></tr><tr><td align="center">192.168.153.140</td><td align="center">master</td><td align="center">mariadb5.5.6</td><td align="center">centos7.6</td></tr><tr><td align="center">192.168.153.141</td><td align="center">slave</td><td align="center">mariadb5.5.6</td><td align="center">centos7.6</td></tr><tr><td align="center">192.168.153.142</td><td align="center">slave</td><td align="center">mariadb5.5.6</td><td align="center">centos7.6</td></tr></tbody></table><p><strong>准备工作：</strong></p><ul><li>关闭防火墙</li><li>关闭SELINUX</li><li>安装mysql并配置主从</li></ul><h3 id="8-1-安装ProxySQL"><a href="#8-1-安装ProxySQL" class="headerlink" title="8.1 安装ProxySQL"></a>8.1 安装ProxySQL</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">配置proxysql的yum源</span><br><span class="line">[root@ct136 ~]# cat &lt;&lt;EOF | tee /etc/yum.repos.d/proxysql.repo</span><br><span class="line">[proxysql_repo]</span><br><span class="line">name= ProxySQL</span><br><span class="line">baseurl=http://repo.proxysql.com/ProxySQL/proxysql-1.4.x/centos/7</span><br><span class="line">gpgcheck=1</span><br><span class="line">gpgkey=http://repo.proxysql.com/ProxySQL/repo_pub_key</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">安装proxysql</span><br><span class="line">[root@ct136 ~]# yum -y install proxysql</span><br><span class="line"></span><br><span class="line">启动proxysql并设置开机自动启动</span><br><span class="line">proxysql默认只提供了sysv风格的启动脚本，所以想设置开机自启则需借助于chkconfig工具</span><br><span class="line">[root@ct136 ~]# systemctl start proxysql</span><br><span class="line">[root@ct136 ~]# chkconfig proxysql on</span><br></pre></td></tr></table></figure><h3 id="8-2-配置ProxySQL"><a href="#8-2-配置ProxySQL" class="headerlink" title="8.2 配置ProxySQL"></a>8.2 配置ProxySQL</h3><h4 id="8-2-1-mysql主库添加proxysql可以增删改查的账号"><a href="#8-2-1-mysql主库添加proxysql可以增删改查的账号" class="headerlink" title="8.2.1 mysql主库添加proxysql可以增删改查的账号"></a>8.2.1 mysql主库添加proxysql可以增删改查的账号</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@ct140 ~]# mysql</span><br><span class="line">Welcome to the MariaDB monitor.  Commands end with ; or \g.</span><br><span class="line">Your MariaDB connection id is 6</span><br><span class="line">Server version: 5.5.60-MariaDB MariaDB Server</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.</span><br><span class="line"></span><br><span class="line">Type &apos;help;&apos; or &apos;\h&apos; for help. Type &apos;\c&apos; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">MariaDB [(none)]&gt; grant all on *.* to &apos;proxysql&apos;@&apos;192.168.153.136&apos; identified by &apos;pwproxysql&apos;;</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [(none)]&gt; flush privileges;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure><h4 id="8-2-2-登录proxysql管理端"><a href="#8-2-2-登录proxysql管理端" class="headerlink" title="8.2.2 登录proxysql管理端"></a>8.2.2 登录proxysql管理端</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[root@ct136 ~]# yum -y install mariadb</span><br><span class="line">[root@ct136 ~]# export MYSQL_PS1=&quot;(\u@\h:\p) [\d]&gt; &quot;</span><br><span class="line">[root@ct136 ~]# mysql -uadmin -padmin -h127.0.0.1 -P6032</span><br><span class="line">Welcome to the MariaDB monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 1</span><br><span class="line">Server version: 5.5.30 (ProxySQL Admin Module)</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.</span><br><span class="line"></span><br><span class="line">Type &apos;help;&apos; or &apos;\h&apos; for help. Type &apos;\c&apos; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">(admin@127.0.0.1:6032) [(none)]&gt; show databases;</span><br><span class="line">+-----+---------------+-------------------------------------+</span><br><span class="line">| seq | name          | file                                |</span><br><span class="line">+-----+---------------+-------------------------------------+</span><br><span class="line">| 0   | main          |                                     |</span><br><span class="line">| 2   | disk          | /var/lib/proxysql/proxysql.db       |</span><br><span class="line">| 3   | stats         |                                     |</span><br><span class="line">| 4   | monitor       |                                     |</span><br><span class="line">| 5   | stats_history | /var/lib/proxysql/proxysql_stats.db |</span><br><span class="line">+-----+---------------+-------------------------------------+</span><br><span class="line">5 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure><p>数据库说明：</p><ul><li>main 内存配置数据库，表里存放后端db实例、用户验证、路由规则等信息。表名以 runtime开头的表示proxysql当前运行的配置内容，不能通过dml语句修改，只能修改对应的不以 runtime 开头的（在内存）里的表，然后 LOAD 使其生效， SAVE 使其存到硬盘以供下次重启加载</li><li>disk 是持久化到硬盘的配置，sqlite数据文件</li><li>stats 是proxysql运行抓取的统计信息，包括到后端各命令的执行次数、流量、processlist、查询种类汇总/执行时间等等</li><li>monitor 库存储 monitor 模块收集的信息，主要是对后端db的健康/延迟检查</li><li>stats_history 统计信息历史库</li></ul><h4 id="8-2-3-Proxysql管理端添加后端连接mysql主从数据库的配置"><a href="#8-2-3-Proxysql管理端添加后端连接mysql主从数据库的配置" class="headerlink" title="8.2.3 Proxysql管理端添加后端连接mysql主从数据库的配置"></a>8.2.3 Proxysql管理端添加后端连接mysql主从数据库的配置</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">(admin@127.0.0.1:6032) [(none)]&gt; show tables from main;</span><br><span class="line">+--------------------------------------------+</span><br><span class="line">| tables                                     |</span><br><span class="line">+--------------------------------------------+</span><br><span class="line">| global_variables                           |  # ProxySQL的基本配置参数，类似与MySQL</span><br><span class="line">| mysql_collations                           |  # 配置对MySQL字符集的支持</span><br><span class="line">| mysql_group_replication_hostgroups         |  # MGR相关的表，用于实例的读写组自动分配</span><br><span class="line">| mysql_query_rules                          |  # 路由表</span><br><span class="line">| mysql_query_rules_fast_routing             |  # 主从复制相关的表，用于实例的读写组自动分配</span><br><span class="line">| mysql_replication_hostgroups               |  </span><br><span class="line">| mysql_servers                              |  # 存储MySQL实例的信息</span><br><span class="line">| mysql_users                                |  # 存储MySQL用户</span><br><span class="line">| proxysql_servers                           |  # 存储ProxySQL的信息，用于ProxySQL Cluster同步</span><br><span class="line">| runtime_checksums_values                   |  # 运行环境的存储校验值</span><br><span class="line">| runtime_global_variables                   |</span><br><span class="line">| runtime_mysql_group_replication_hostgroups |</span><br><span class="line">| runtime_mysql_query_rules                  |</span><br><span class="line">| runtime_mysql_query_rules_fast_routing     |</span><br><span class="line">| runtime_mysql_replication_hostgroups       |  # 与上面对应，但是运行环境正在使用的配置</span><br><span class="line">| runtime_mysql_servers                      |</span><br><span class="line">| runtime_mysql_users                        |</span><br><span class="line">| runtime_proxysql_servers                   |</span><br><span class="line">| runtime_scheduler                          |</span><br><span class="line">| scheduler                                  |  # 定时任务表</span><br><span class="line">+--------------------------------------------+</span><br><span class="line">20 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure><p>runtime_ 开头的是运行时的配置，这些是不能修改的。要修改 ProxySQL 的配置，需要修改了非 runtime_ 表，修改后必须执行 LOAD … TO RUNTIME 才能加载到 RUNTIME 生效，执行 save … to disk 才能将配置持久化保存到磁盘</p><p>下面语句中没有先切换到 main 库也执行成功了，因为 ProxySQL 内部使用的 SQLite3 数据库引擎，和 MySQL 的解析方式是不一样的。即使执行了 USE main 语句也是无任何效果的，但不会报错</p><p>使用 insert 语句添加 mysql 主机到 mysql_servers 表中，其中：hostgroup_id 1 表示写组，2表示读组</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">(admin@127.0.0.1:6032) [(none)]&gt; insert into mysql_servers(hostgroup_id,hostname,port,weight,comment) values(10,&apos;192.168.153.140&apos;,3306,1,&apos;Write Group&apos;),(20,&apos;192.168.153.141&apos;,3306,1,&apos;Read Group&apos;),(20,&apos;192.168.153.142&apos;,3306,1,&apos;Read Group&apos;);</span><br><span class="line">Query OK, 2 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">(admin@127.0.0.1:6032) [(none)]&gt; select * from mysql_servers;</span><br><span class="line">+--------------+-----------------+------+--------+--------+-------------+-----------------+---------------------+---------+----------------+-------------+</span><br><span class="line">| hostgroup_id | hostname        | port | status | weight | compression | max_connections | max_replication_lag | use_ssl | max_latency_ms | comment     |</span><br><span class="line">+--------------+-----------------+------+--------+--------+-------------+-----------------+---------------------+---------+----------------+-------------+</span><br><span class="line">| 10           | 192.168.153.140 | 3306 | ONLINE | 1      | 0           | 1000            | 0                   | 0       | 0              | Write Group |</span><br><span class="line">| 20           | 192.168.153.141 | 3306 | ONLINE | 1      | 0           | 1000            | 0                   | 0       | 0              | Read Group  |</span><br><span class="line">| 20           | 192.168.153.142 | 3306 | ONLINE | 1      | 0           | 1000            | 0                   | 0       | 0              | Read Group  |</span><br><span class="line">+--------------+-----------------+------+--------+--------+-------------+-----------------+---------------------+---------+----------------+-------------+</span><br><span class="line">3 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure><p>修改后，需要加载到RUNTIME，并保存到disk</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(admin@127.0.0.1:6032) [(none)]&gt; load mysql servers to runtime;</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">(admin@127.0.0.1:6032) [(none)]&gt; save mysql servers to disk;</span><br><span class="line">Query OK, 0 rows affected (0.05 sec)</span><br></pre></td></tr></table></figure><p>在 proxysql 主机的 mysql_users 表中添加刚才在 master 上创建的账号 proxysql，proxysql 客户端需要使用这个账号来访问数据库<br>default_hostgroup 默认组设置为写组，也就是1;<br>当读写分离的路由规则不符合时，会访问默认组的数据库;</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">(admin@127.0.0.1:6032) [(none)]&gt; insert into mysql_users(username,password,default_hostgroup,transaction_persistent) values(&apos;proxysql&apos;,&apos;pwproxysql&apos;,10,1);</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">(admin@127.0.0.1:6032) [(none)]&gt; select * from mysql_users \G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">              username: proxysql        # 后端mysql实例的用户名</span><br><span class="line">              password: pwproxysql      # 后端mysql实例的密码</span><br><span class="line">                active: 1               # active=1表示用户生效，0表示不生效</span><br><span class="line">               use_ssl: 0</span><br><span class="line">     default_hostgroup: 10               # 用户默认登录到哪个hostgroup_id下的实例</span><br><span class="line">        default_schema: NULL            # 用户默认登录后端mysql实例时连接的数据库，这个地方为NULL的话，则由全局变量mysql-default_schema决定，默认是information_schema</span><br><span class="line">         schema_locked: 0</span><br><span class="line">transaction_persistent: 1       # 如果设置为1，连接上ProxySQL的会话后，如果在一个hostgroup上开启了事务，那么后续的sql都继续维持在这个hostgroup上，不论是否会匹配上其它路由规则，直到事务结束。虽然默认是0</span><br><span class="line">          fast_forward: 0       # 忽略查询重写/缓存层，直接把这个用户的请求透传到后端DB。相当于只用它的连接池功能，一般不用，路由规则 .* 就行了</span><br><span class="line">               backend: 1</span><br><span class="line">              frontend: 1</span><br><span class="line">       max_connections: 10000   # 该用户允许的最大连接数</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">(admin@127.0.0.1:6032) [(none)]&gt; load mysql users to runtime;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">(admin@127.0.0.1:6032) [(none)]&gt; save mysql users to disk;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure><h4 id="8-2-4-添加健康检测的帐号"><a href="#8-2-4-添加健康检测的帐号" class="headerlink" title="8.2.4 添加健康检测的帐号"></a>8.2.4 添加健康检测的帐号</h4><p><strong>在mysql的 master 端添加属于proxysql的只读账号</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [(none)]&gt; grant select on *.* to &apos;monitor&apos;@&apos;192.168.153.%&apos; identified by &apos;monitor&apos;;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [(none)]&gt; flush privileges;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure><p><strong>在proxysql主机端修改变量设置健康检测的账号</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">(admin@127.0.0.1:6032) [(none)]&gt; set mysql-monitor_username=&apos;monitor&apos;;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">(admin@127.0.0.1:6032) [(none)]&gt; set mysql-monitor_password=&apos;monitor&apos;;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">(admin@127.0.0.1:6032) [(none)]&gt; load mysql variables to runtime;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">(admin@127.0.0.1:6032) [(none)]&gt; save mysql variables to disk;</span><br><span class="line">Query OK, 97 rows affected (0.01 sec)</span><br></pre></td></tr></table></figure><h4 id="8-2-5-添加读写分离的路由规则"><a href="#8-2-5-添加读写分离的路由规则" class="headerlink" title="8.2.5 添加读写分离的路由规则"></a>8.2.5 添加读写分离的路由规则</h4><p><strong>需求：</strong></p><ul><li>将 select 查询语句全部路由至 hostgroup_id=2 的组(也就是读组)</li><li>但是 select * from tb for update 这样的语句是会修改数据的，所以需要单独定义，将它路由至 hostgroup_id=1 的组(也就是写组)</li><li>其他没有被规则匹配到的组将会被路由至用户默认的组(mysql_users 表中的 default_hostgroup)</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">(admin@127.0.0.1:6032) [(none)]&gt; insert into mysql_query_rules(rule_id,active,match_digest,destination_hostgroup,apply)values(1,1,&apos;^SELECT.*FOR UPDATE$&apos;,1,1);</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">(admin@127.0.0.1:6032) [(none)]&gt; insert into mysql_query_rules(rule_id,active,match_digest,destination_hostgroup,apply)values(2,1,&apos;^SELECT&apos;,2,1);</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">(admin@127.0.0.1:6032) [(none)]&gt; select rule_id,active,match_digest,destination_hostgroup,apply from mysql_query_rules;</span><br><span class="line">+---------+--------+----------------------+-----------------------+-------+</span><br><span class="line">| rule_id | active | match_digest         | destination_hostgroup | apply |</span><br><span class="line">+---------+--------+----------------------+-----------------------+-------+</span><br><span class="line">| 1       | 1      | ^SELECT.*FOR UPDATE$ | 10                    | 1     |</span><br><span class="line">| 2       | 1      | ^SELECT              | 20                    | 1     |</span><br><span class="line">+---------+--------+----------------------+-----------------------+-------+</span><br><span class="line">2 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">(admin@127.0.0.1:6032) [(none)]&gt; load mysql query rules to runtime;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">(admin@127.0.0.1:6032) [(none)]&gt; load admin variables to runtime;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">(admin@127.0.0.1:6032) [(none)]&gt; save mysql query rules to disk;</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">(admin@127.0.0.1:6032) [(none)]&gt; save admin variables to disk;</span><br><span class="line">Query OK, 31 rows affected (0.01 sec)</span><br></pre></td></tr></table></figure><h3 id="8-3-验证读写分离"><a href="#8-3-验证读写分离" class="headerlink" title="8.3 验证读写分离"></a>8.3 验证读写分离</h3><h4 id="8-3-1-登录-proxysql-客户端"><a href="#8-3-1-登录-proxysql-客户端" class="headerlink" title="8.3.1 登录 proxysql 客户端"></a>8.3.1 登录 proxysql 客户端</h4><p>登录用户是刚才我们在 mysql_user 表中创建的用户，端口为6033</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@ct136 ~]# mysql -uproxysql -ppwproxysql -h127.0.0.1 -P6033</span><br><span class="line">Welcome to the MariaDB monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 3</span><br><span class="line">Server version: 5.5.30 (ProxySQL)</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.</span><br><span class="line"></span><br><span class="line">Type &apos;help;&apos; or &apos;\h&apos; for help. Type &apos;\c&apos; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">(proxysql@127.0.0.1:6033) [(none)]&gt; show databases;</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| test               |</span><br><span class="line">| whs                |</span><br><span class="line">+--------------------+</span><br><span class="line">5 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure><h4 id="8-3-2-尝试修改数据库和查询"><a href="#8-3-2-尝试修改数据库和查询" class="headerlink" title="8.3.2 尝试修改数据库和查询"></a>8.3.2 尝试修改数据库和查询</h4><p>创建2个数据库并查询一下表</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">(proxysql@127.0.0.1:6033) [(none)]&gt; create database itwhs;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">(proxysql@127.0.0.1:6033) [(none)]&gt; create database itw;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">(proxysql@127.0.0.1:6033) [(none)]&gt; select user,host from mysql.user;</span><br><span class="line">+----------+-----------------+</span><br><span class="line">| user     | host            |</span><br><span class="line">+----------+-----------------+</span><br><span class="line">| root     | 127.0.0.1       |</span><br><span class="line">| monitor  | 192.168.153.%   |</span><br><span class="line">| proxysql | 192.168.153.136 |</span><br><span class="line">| whs      | 192.168.153.142 |</span><br><span class="line">| root     | ::1             |</span><br><span class="line">|          | ct141           |</span><br><span class="line">| root     | ct141           |</span><br><span class="line">|          | localhost       |</span><br><span class="line">| root     | localhost       |</span><br><span class="line">+----------+-----------------+</span><br><span class="line">9 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure><h4 id="8-3-3-验证读写分离是否成功"><a href="#8-3-3-验证读写分离是否成功" class="headerlink" title="8.3.3 验证读写分离是否成功"></a>8.3.3 验证读写分离是否成功</h4><blockquote><p>proxysql有个类似审计的功能，可以查看各类SQL的执行情况，其需要在proxysql管理端执行</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@ct136 ~]# mysql -uadmin -padmin -h127.0.0.1 -P6032</span><br><span class="line">Welcome to the MariaDB monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 5</span><br><span class="line">Server version: 5.5.30 (ProxySQL Admin Module)</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.</span><br><span class="line"></span><br><span class="line">Type &apos;help;&apos; or &apos;\h&apos; for help. Type &apos;\c&apos; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">(admin@127.0.0.1:6032) [(none)]&gt; select * from stats_mysql_query_digest;</span><br><span class="line">+-----------+--------------------+----------+--------------------+----------------------------------+------------+------------+------------+----------+----------+----------+</span><br><span class="line">| hostgroup | schemaname         | username | digest             | digest_text                      | count_star | first_seen | last_seen  | sum_time | min_time | max_time |</span><br><span class="line">+-----------+--------------------+----------+--------------------+----------------------------------+------------+------------+------------+----------+----------+----------+</span><br><span class="line">| 20        | information_schema | proxysql | 0x0F02B330C823D739 | select user,host from mysql.user | 1          | 1561462395 | 1561462395 | 5578     | 5578     | 5578     |</span><br><span class="line">| 10        | information_schema | proxysql | 0x88DAAF812073F71F | create database itw              | 1          | 1561462378 | 1561462378 | 1870     | 1870     | 1870     |</span><br><span class="line">| 10        | information_schema | proxysql | 0x02033E45904D3DF0 | show databases                   | 1          | 1561462249 | 1561462249 | 5885     | 5885     | 5885     |</span><br><span class="line">| 10        | information_schema | proxysql | 0xFC4D8902AD1850BE | create database itwhs            | 1          | 1561462373 | 1561462373 | 1970     | 1970     | 1970     |</span><br><span class="line">| 10        | information_schema | proxysql | 0x594F2C744B698066 | select USER()                    | 1          | 1561462244 | 1561462244 | 0        | 0        | 0        |</span><br><span class="line">+-----------+--------------------+----------+--------------------+----------------------------------+------------+------------+------------+----------+----------+----------+</span><br><span class="line">9 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure><p>从上面的 hostgroup 和 digest_text 值来看，所有的写操作都被路由至10组，读操作都被路由至20组，其中10组为写组，20组为读组！</p><p>由此可见，读写分离成功！！！</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;a id=&quot;more&quot;&gt;&lt;/a&gt;

&lt;h2 id=&quot;1-mysql实现读写分离的方式&quot;&gt;&lt;a href=&quot;#1-mysql实现读写分离的方式&quot; class=&quot;headerlink&quot; title=&quot;1. mysql实现读写分离的方式&quot;&gt;&lt;/a&gt;1. mysql实现读写分离的方式&lt;
      
    
    </summary>
    
      <category term="Linux运维" scheme="http://aiwhs.github.io/categories/Linux%E8%BF%90%E7%BB%B4/"/>
    
    
      <category term="MySQL" scheme="http://aiwhs.github.io/tags/MySQL/"/>
    
  </entry>
  
  <entry>
    <title>MySQL多实例</title>
    <link href="http://aiwhs.github.io/2018/12/09/mysql%E5%A4%9A%E5%AE%9E%E4%BE%8B%E9%83%A8%E7%BD%B2/"/>
    <id>http://aiwhs.github.io/2018/12/09/mysql多实例部署/</id>
    <published>2018-12-09T00:15:57.000Z</published>
    <updated>2019-07-17T08:14:39.856Z</updated>
    
    <content type="html"><![CDATA[<a id="more"></a><h1 id="mysql多实例部署"><a href="#mysql多实例部署" class="headerlink" title="mysql多实例部署"></a>mysql多实例部署</h1><p>软件下载</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">下载二进制格式的mysql软件包</span><br><span class="line">[root@localhost ~]# cd /usr/src/</span><br><span class="line">[root@localhost src]# wget https://downloads.mysql.com/archives/get/file/mysql-5.7.22-linux-glibc2.12-x86_64.tar.gz</span><br></pre></td></tr></table></figure><p>配置用户和组并解压二进制程序至/usr/local下</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">创建用户和组</span><br><span class="line">[root@localhost src]# groupadd -r mysql</span><br><span class="line">[root@localhost src]# useradd -M -s /sbin/nologin -g mysql mysql</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">解压软件至/usr/local/</span><br><span class="line">[root@localhost src]# ls</span><br><span class="line">debug  kernels  mysql-5.7.22-linux-glibc2.12-x86_64.tar.gz</span><br><span class="line">[root@localhost src]# tar xf mysql-5.7.22-linux-glibc2.12-x86_64.tar.gz -C /usr/local/</span><br><span class="line">[root@localhost ~]# ls /usr/local/</span><br><span class="line">bin  games    lib    libexec                              sbin   src</span><br><span class="line">etc  include  lib64  mysql-5.7.22-linux-glibc2.12-x86_64  share</span><br><span class="line">[root@localhost ~]# cd /usr/local/</span><br><span class="line">[root@localhost local]# ln -sv mysql-5.7.22-linux-glibc2.12-x86_64/ mysql</span><br><span class="line">‘mysql’ -&gt; ‘mysql-5.7.22-linux-glibc2.12-x86_64/’</span><br><span class="line">[root@localhost local]# ll</span><br><span class="line">total 0</span><br><span class="line">drwxr-xr-x. 2 root root   6 4月  11 2018 bin</span><br><span class="line">drwxr-xr-x. 2 root root   6 4月  11 2018 etc</span><br><span class="line">drwxr-xr-x. 2 root root   6 4月  11 2018 games</span><br><span class="line">drwxr-xr-x. 2 root root   6 4月  11 2018 include</span><br><span class="line">drwxr-xr-x. 2 root root   6 4月  11 2018 lib</span><br><span class="line">drwxr-xr-x. 2 root root   6 4月  11 2018 lib64</span><br><span class="line">drwxr-xr-x. 2 root root   6 4月  11 2018 libexec</span><br><span class="line">lrwxrwxrwx  1 root root  36 5月  14 18:07 mysql -&gt; mysql-5.7.22-linux-glibc2.12-x86_64/</span><br><span class="line">drwxr-xr-x  9 root root 129 5月  14 18:06 mysql-5.7.22-linux-glibc2.12-x86_64</span><br><span class="line">drwxr-xr-x. 2 root root   6 4月  11 2018 sbin</span><br><span class="line">drwxr-xr-x. 5 root root  49 5月   3 20:12 share</span><br><span class="line">drwxr-xr-x. 2 root root   6 4月  11 2018 src</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">修改目录/usr/local/mysql的属主属组</span><br><span class="line">[root@localhost ~]# chown -R mysql.mysql /usr/local/mysql</span><br><span class="line">[root@localhost ~]# ll /usr/local/mysql -d</span><br><span class="line">lrwxrwxrwx 1 mysql mysql 36 5月  14 18:07 /usr/local/mysql -&gt; mysql-5.7.22-linux-glibc2.12-x86_64/</span><br><span class="line"></span><br><span class="line">//配置环境变量</span><br><span class="line">[root@localhost ~]# echo &apos;export PATH=/usr/local/mysql/bin:$PATH&apos; &gt; /etc/profile.d/mysql.sh</span><br><span class="line">[root@localhost ~]# . /etc/profile.d/mysql.sh</span><br><span class="line">[root@localhost ~]# echo $PATH</span><br><span class="line">/usr/local/mysql/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/root/bin</span><br></pre></td></tr></table></figure><p>创建各实例数据存放的目录</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# mkdir -p /opt/data/&#123;3306,3307,3308&#125;</span><br><span class="line"></span><br><span class="line">[root@localhost ~]# chown -R mysql.mysql /opt/data/</span><br><span class="line"></span><br><span class="line">[root@localhost ~]# ll /opt/data/</span><br><span class="line">总用量 0</span><br><span class="line">drwxr-xr-x 2 mysql mysql 6 5月  14 18:09 3306</span><br><span class="line">drwxr-xr-x 2 mysql mysql 6 5月  14 18:09 3307</span><br><span class="line">drwxr-xr-x 2 mysql mysql 6 5月  14 18:09 3308</span><br><span class="line"></span><br><span class="line">[root@localhost ~]# tree /opt/data/</span><br><span class="line">/opt/data/</span><br><span class="line">├── 3306</span><br><span class="line">├── 3307</span><br><span class="line">└── 3308</span><br><span class="line"></span><br><span class="line">3 directories, 0 files</span><br></pre></td></tr></table></figure><p>初始化各实例</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">初始化3306实例</span><br><span class="line">[root@localhost ~]# mysqld --initialize --datadir=/opt/data/3306 --user=mysql</span><br><span class="line">2019-05-14T10:21:09.607685Z 0 [Warning] TIMESTAMP with implicit DEFAULT value is deprecated. Please use --explicit_defaults_for_timestamp server option (see documentation for more details).</span><br><span class="line">2019-05-14T10:21:09.822454Z 0 [Warning] InnoDB: New log files created, LSN=45790</span><br><span class="line">2019-05-14T10:21:09.858420Z 0 [Warning] InnoDB: Creating foreign key constraint system tables.</span><br><span class="line">2019-05-14T10:21:09.916381Z 0 [Warning] No existing UUID has been found, so we assume that this is the first time that this server has been started. Generating a new UUID: fe0bac5b-7631-11e9-bec6-000c299f3251.</span><br><span class="line">2019-05-14T10:21:09.917673Z 0 [Warning] Gtid table is not ready to be used. Table &apos;mysql.gtid_executed&apos; cannot be opened.</span><br><span class="line">2019-05-14T10:21:09.918517Z 1 [Note] A temporary password is generated for root@localhost: AG/j:g?ob1CO</span><br><span class="line">[root@localhost ~]# echo &apos;AG/j:g?ob1CO&apos; &gt; 3306_pass</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">初始化3307实例</span><br><span class="line">[root@localhost ~]# mysqld --initialize --datadir=/opt/data/3307 --user=mysql</span><br><span class="line">2019-05-14T10:24:10.367114Z 0 [Warning] TIMESTAMP with implicit DEFAULT value is deprecated. Please use --explicit_defaults_for_timestamp server option (see documentation for more details).</span><br><span class="line">2019-05-14T10:24:10.572462Z 0 [Warning] InnoDB: New log files created, LSN=45790</span><br><span class="line">2019-05-14T10:24:10.610295Z 0 [Warning] InnoDB: Creating foreign key constraint system tables.</span><br><span class="line">2019-05-14T10:24:10.669903Z 0 [Warning] No existing UUID has been found, so we assume that this is the first time that this server has been started. Generating a new UUID: 69c878d3-7632-11e9-82ab-000c299f3251.</span><br><span class="line">2019-05-14T10:24:10.670681Z 0 [Warning] Gtid table is not ready to be used. Table &apos;mysql.gtid_executed&apos; cannot be opened.</span><br><span class="line">2019-05-14T10:24:10.671566Z 1 [Note] A temporary password is generated for root@localhost: rfY5Ys(u:s!s</span><br><span class="line">[root@localhost ~]# echo &apos;rfY5Ys(u:s!s&apos; &gt; 3307_pass</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">初始化3308实例</span><br><span class="line">[root@localhost ~]# mysqld --initialize --datadir=/opt/data/3308 --user=mysql</span><br><span class="line">2019-05-14T10:25:03.584110Z 0 [Warning] TIMESTAMP with implicit DEFAULT value is deprecated. Please use --explicit_defaults_for_timestamp server option (see documentation for more details).</span><br><span class="line">2019-05-14T10:25:03.795984Z 0 [Warning] InnoDB: New log files created, LSN=45790</span><br><span class="line">2019-05-14T10:25:03.832243Z 0 [Warning] InnoDB: Creating foreign key constraint system tables.</span><br><span class="line">2019-05-14T10:25:03.891271Z 0 [Warning] No existing UUID has been found, so we assume that this is the first time that this server has been started. Generating a new UUID: 89816891-7632-11e9-85fa-000c299f3251.</span><br><span class="line">2019-05-14T10:25:03.892710Z 0 [Warning] Gtid table is not ready to be used. Table &apos;mysql.gtid_executed&apos; cannot be opened.</span><br><span class="line">2019-05-14T10:25:03.893870Z 1 [Note] A temporary password is generated for root@localhost: +g9h.g(%g2&gt;E</span><br><span class="line">[root@localhost ~]# echo &apos;+g9h.g(%g2&gt;E&apos; &gt; 3308_pass</span><br></pre></td></tr></table></figure><p>安装perl</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# yum -y install perl</span><br></pre></td></tr></table></figure><p>配置配置文件/etc/my.cnf</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# vim /etc/my.cnf</span><br><span class="line">[mysqld_multi]</span><br><span class="line">mysqld = /usr/local/mysql/bin/mysqld_safe</span><br><span class="line">mysqladmin = /usr/local/mysql/bin/mysqladmin</span><br><span class="line">user = root</span><br><span class="line">password = wangqing123!</span><br><span class="line"></span><br><span class="line">[mysqld3306]</span><br><span class="line">datadir = /opt/data/3306</span><br><span class="line">port = 3306</span><br><span class="line">socket = /tmp/mysql3306.sock</span><br><span class="line">pid-file = /opt/data/3306/mysql_3306.pid</span><br><span class="line">log-error=/var/log/3306.log</span><br><span class="line"></span><br><span class="line">[mysqld3307]</span><br><span class="line">datadir = /opt/data/3307</span><br><span class="line">port = 3307</span><br><span class="line">socket = /tmp/mysql3307.sock</span><br><span class="line">pid-file = /opt/data/3307/mysql_3307.pid</span><br><span class="line">log-error=/var/log/3307.log</span><br><span class="line"></span><br><span class="line">[mysqld3308]</span><br><span class="line">datadir = /opt/data/3308</span><br><span class="line">port = 3308</span><br><span class="line">socket = /tmp/mysql3308.sock</span><br><span class="line">pid-file = /opt/data/3308/mysql_3308.pid</span><br><span class="line">log-error=/var/log/3308.log</span><br></pre></td></tr></table></figure><p>启动各实例</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# mysqld_multi start 3306</span><br><span class="line">[root@localhost ~]# mysqld_multi start 3307</span><br><span class="line">[root@localhost ~]# mysqld_multi start 3308</span><br><span class="line">[root@localhost ~]# ss -antl</span><br><span class="line">State      Recv-Q Send-Q     Local Address:Port                    Peer Address:Port</span><br><span class="line">LISTEN     0      128                    *:22                                 *:*</span><br><span class="line">LISTEN     0      100            127.0.0.1:25                                 *:*</span><br><span class="line">LISTEN     0      80                    :::3307                              :::*</span><br><span class="line">LISTEN     0      80                    :::3308                              :::*</span><br><span class="line">LISTEN     0      128                   :::22                                :::*</span><br><span class="line">LISTEN     0      100                  ::1:25                                :::*</span><br><span class="line">LISTEN     0      80                    :::3306                              :::*</span><br></pre></td></tr></table></figure><p>初始化密码</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# ls</span><br><span class="line">3306_pass  3307_pass  3308_pass  anaconda-ks.cfg</span><br><span class="line">[root@localhost ~]# cat 3306_pass</span><br><span class="line">AG/j:g?ob1CO</span><br><span class="line">[root@localhost ~]# mysql -uroot -p&apos;AG/j:g?ob1CO&apos; -S /tmp/mysql3306.sock</span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 3</span><br><span class="line">Server version: 5.7.22</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2018, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type &apos;help;&apos; or &apos;\h&apos; for help. Type &apos;\c&apos; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">mysql&gt; set password = password(&apos;itwhs123!&apos;);</span><br><span class="line">Query OK, 0 rows affected, 1 warning (0.01 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; quit</span><br><span class="line">Bye</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@localhost ~]# cat 3307_pass</span><br><span class="line">rfY5Ys(u:s!s</span><br><span class="line">[root@localhost ~]# mysql -uroot -p&apos;rfY5Ys(u:s!s&apos; -S /tmp/mysql3307.sock -e &apos;set password = password(&quot;itwhs123!&quot;);&apos; --connect-expired-password</span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@localhost ~]# cat 3308_pass</span><br><span class="line">+g9h.g(%g2&gt;E</span><br><span class="line">[root@localhost ~]# mysql -uroot -p&apos;+g9h.g(%g2&gt;E&apos; -S /tmp/mysql3308.sock -e &apos;set password = password(&quot;itwhs123!&quot;);&apos; --connect-expired-password</span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;a id=&quot;more&quot;&gt;&lt;/a&gt;

&lt;h1 id=&quot;mysql多实例部署&quot;&gt;&lt;a href=&quot;#mysql多实例部署&quot; class=&quot;headerlink&quot; title=&quot;mysql多实例部署&quot;&gt;&lt;/a&gt;mysql多实例部署&lt;/h1&gt;&lt;p&gt;软件下载&lt;/p&gt;
&lt;figure cl
      
    
    </summary>
    
      <category term="Linux运维" scheme="http://aiwhs.github.io/categories/Linux%E8%BF%90%E7%BB%B4/"/>
    
    
      <category term="MySQL" scheme="http://aiwhs.github.io/tags/MySQL/"/>
    
  </entry>
  
  <entry>
    <title>MySQL主从</title>
    <link href="http://aiwhs.github.io/2018/12/08/MySQL%E4%B8%BB%E4%BB%8E/"/>
    <id>http://aiwhs.github.io/2018/12/08/MySQL主从/</id>
    <published>2018-12-08T00:15:57.000Z</published>
    <updated>2019-07-17T08:12:23.549Z</updated>
    
    <content type="html"><![CDATA[<a id="more"></a><h3 id="MySQL主从复制虽好，能完美解决数据库单点问题吗？"><a href="#MySQL主从复制虽好，能完美解决数据库单点问题吗？" class="headerlink" title="MySQL主从复制虽好，能完美解决数据库单点问题吗？"></a>MySQL主从复制虽好，能完美解决数据库单点问题吗？</h3><h4 id="一、单个数据库服务器的缺点"><a href="#一、单个数据库服务器的缺点" class="headerlink" title="一、单个数据库服务器的缺点"></a>一、单个数据库服务器的缺点</h4><ul><li>数据库服务器存在单点问题；</li><li>数据库服务器资源无法满足增长的读写请求；</li><li>高峰时数据库连接数经常超过上限。</li></ul><h4 id="二、如何解决单点问题"><a href="#二、如何解决单点问题" class="headerlink" title="二、如何解决单点问题"></a>二、如何解决单点问题</h4><ul><li>增加额外的数据库服务器，组建数据库集群；</li><li>同一集群中的数据库服务器需要具有相同的数据；</li><li>集群中的任一服务器宕机后，其它服务器可以取代宕机服务器。</li></ul><h4 id="三、MySQL主从复制架构"><a href="#三、MySQL主从复制架构" class="headerlink" title="三、MySQL主从复制架构"></a>三、MySQL主从复制架构</h4><p><strong>1、主库将变更写入到主库的binlog中</strong></p><ul><li>一些MySQL版本并不会开启二进制日志，所以一定要检查是否开启；</li><li>如果刚开始没有开启，后面再进行开启的话，需要重启数据库才能生效，而且数据库的重启往往会对业务造成很大的影响；</li><li>尽管二进制日志对性能有稍许的影响，所以还是建议大家无论是否使用复制功能，都要开启MySQL二进制日志，因为增量备份也需要二进制日志。</li></ul><p><strong>2、从库的IO线程在指定位置读取主库binlog内容存储到本地的中继日志（Relay Log）中</strong></p><p>要完成二进制日志的传输过程，MySQL会在从服务器上启动一个工作线程，称为IO线程，这个IO线程会跟主数据库建立一个普通的客户端连接，然后在主服务器上启动一个特殊的二进制转储线程称为binlogdown线程。</p><p>从库上的IO线程通过这个二进制转储线程来读取主库上的二进制事件，如果该事件追赶上主库，则会进入sleep状态，直到主库发起信号通知有新事件产生时，才会被唤醒，relay log的格式和binlog格式是完全相同的，</p><p>可以使用mysqlbinlog来读取relay log中的内容。</p><p><strong>3、从库的SQL线程读取Relay Log日志中的内容，并在从库中重放</strong></p><p>SQL线程所执行的事件，我们可以通过配置选项来决定是否要写入到从服务器的二进制日志中。</p><p>目前MySQL支持两种复制类型：</p><ul><li>基于二进制日志点的复制</li><li>基于GTID的复制（MySQL&gt;=5.7推荐使用）</li></ul><h4 id="四-主从复制的一些缺点"><a href="#四-主从复制的一些缺点" class="headerlink" title="四. 主从复制的一些缺点"></a>四. 主从复制的一些缺点</h4><p>虽然主从复制增加了一个数据库副本，但从数据库和主数据库的数据最终会是一致的。之所以说是最终一致，因为MySQL复制是异步的，正常情况下主从复制数据之间会有一个微小的延迟。</p><p>通过这个数据库副本看似解决了数据库单点问题，但并不完美：因为这种架构下，如果主服务器宕机，需要手动切换从服务器，业务中断不能忍受，不能满足应用高可用的要求。</p><h2 id="1-主从简介"><a href="#1-主从简介" class="headerlink" title="1.主从简介"></a>1.主从简介</h2><p>在现代企业中，数据显得尤为重要，而存储数据的数据库选择又五花八门，但无论是何种数据库，均存在着一种隐患。</p><p>想几个问题：</p><ul><li>用一台数据库存放数据，若此数据库服务器宕机了导致数据丢失怎么办？</li><li>业务量大了，数据多了，访问的人多了，一台数据库无法保证服务质量了怎么办？</li></ul><h3 id="1-1-主从作用"><a href="#1-1-主从作用" class="headerlink" title="1.1 主从作用"></a>1.1 主从作用</h3><ul><li>实时灾备，用于故障切换</li><li>读写分离，提供查询服务</li><li>备份，避免影响业务(这里说的备份是备份sql服务器,而不是备份数据)</li></ul><h3 id="1-2-主从形式"><a href="#1-2-主从形式" class="headerlink" title="1.2 主从形式"></a>1.2 主从形式</h3><p><img src="../../img/mysql_master_slave02.png" alt="img"></p><ul><li>一主一从</li><li>主主复制</li><li>一主多从—扩展系统读取的性能，因为读是在从库读取的</li><li>多主一从—5.7开始支持</li><li>联级复制</li></ul><h2 id="2-主从复制原理"><a href="#2-主从复制原理" class="headerlink" title="2. 主从复制原理"></a>2. 主从复制原理</h2><p><img src="../../img/mysql_master_slave01.png" alt="img2"></p><p><strong>主从复制步骤：</strong></p><ul><li>主库将所有的写操作记录到binlog日志中并生成一个log dump线程，将binlog日志传给从库的I/O线程</li><li>从库生成两个线程，一个I/O线程，一个SQL线程<ul><li>I/O线程去请求主库的binlog，并将得到的binlog日志写到relay log（中继日志） 文件中</li><li>SQL线程，会读取relay log文件中的日志，并解析成具体操作，来实现主从的操作一致，达到最终数据一致的目的</li></ul></li></ul><h2 id="3-主从复制配置"><a href="#3-主从复制配置" class="headerlink" title="3. 主从复制配置"></a>3. 主从复制配置</h2><p><strong>主从复制配置步骤：</strong></p><ol><li>确保从数据库与主数据库里的数据一样</li><li>在主数据库里创建一个同步账号授权给从数据库使用</li><li>配置主数据库（修改配置文件）</li><li>配置从数据库（修改配置文件）</li></ol><p><strong>需求：</strong><br>搭建两台<code>MySQL</code>服务器，一台作为主服务器，一台作为从服务器，主服务器进行写操作，从服务器进行读操作</p><p><strong>环境说明：</strong>Red Hat Enterprise Linux 8.0 (Ootpa)</p><p><img src="../../img/%E7%8E%AF%E5%A2%83.png" alt="环境"></p><h3 id="3-1-mysql安装"><a href="#3-1-mysql安装" class="headerlink" title="3.1 mysql安装"></a>3.1 mysql安装</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br></pre></td><td class="code"><pre><span class="line">[root@ip-10-0-10-70 ~]# dnf -y install wget vim</span><br><span class="line">[root@ip-10-0-10-70 ~]# groupadd -r mysql</span><br><span class="line">[root@ip-10-0-10-70 ~]# useradd -M -s /sbin/nologin -g mysql mysql</span><br><span class="line">[root@ip-10-0-10-70 ~]# mkdir /opt/data</span><br><span class="line">[root@ip-10-0-10-70 ~]# chown -R mysql.mysql /opt/data/</span><br><span class="line">[root@ip-10-0-10-70 ~]# ll /opt/</span><br><span class="line">total 0</span><br><span class="line">drwxr-xr-x. 2 mysql mysql 6 May 15 04:37 data</span><br><span class="line">[root@ip-10-0-10-70 ~]# wget https://downloads.mysql.com/archives/get/file/mysql-5.7.25-linux-glibc2.12-x86_64.tar.gz</span><br><span class="line">--2019-05-15 04:32:36--  https://downloads.mysql.com/archives/get/file/mysql-5.7.25-linux-glibc2.12-x86_64.tar.gz</span><br><span class="line">Resolving downloads.mysql.com (downloads.mysql.com)... 137.254.60.14</span><br><span class="line">Connecting to downloads.mysql.com (downloads.mysql.com)|137.254.60.14|:443... connected.</span><br><span class="line">HTTP request sent, awaiting response... 302 Found</span><br><span class="line">Location: https://cdn.mysql.com/archives/mysql-5.7/mysql-5.7.25-linux-glibc2.12-x86_64.tar.gz [following]</span><br><span class="line">--2019-05-15 04:32:37--  https://cdn.mysql.com/archives/mysql-5.7/mysql-5.7.25-linux-glibc2.12-x86_64.tar.gz</span><br><span class="line">Resolving cdn.mysql.com (cdn.mysql.com)... 23.35.197.183</span><br><span class="line">Connecting to cdn.mysql.com (cdn.mysql.com)|23.35.197.183|:443... connected.</span><br><span class="line">HTTP request sent, awaiting response... 200 OK</span><br><span class="line">......</span><br><span class="line">成功后615m大小</span><br><span class="line">发现下载速度太慢,决定共享这个二进制的源码包,既然在同一可用区,那么内网互通,就用了nfs,配置简单,快捷</span><br><span class="line">[root@ip-10-0-10-70 ~]# dnf -y install nfs* rpcbind*   //三台都执行这个命令</span><br><span class="line">[root@ip-10-0-10-70 ~]# mkdir /nfs</span><br><span class="line">[root@ip-10-0-10-70 ~]# vim /etc/exports</span><br><span class="line">/nfs *(rw)</span><br><span class="line">[root@ip-10-0-10-70 ~]# systemctl restart rpcbind nfs-server</span><br><span class="line">[root@ip-10-0-10-70 ~]# showmount -e 10.0.10.70</span><br><span class="line">Export list for 10.0.10.70:</span><br><span class="line">/nfs *</span><br><span class="line">[root@ip-10-0-10-70 ~]# mv mysql-5.7.25-linux-glibc2.12-x86_64.tar.gz /nfs/</span><br><span class="line">[root@ip-10-0-10-70 ~]# ls -lh /nfs/</span><br><span class="line">total 615M</span><br><span class="line">-rw-r--r--. 1 root root 615M Dec 21 10:24 mysql-5.7.25-linux-glibc2.12-x86_64.tar.gz</span><br><span class="line">从数据库1:</span><br><span class="line">[root@ip-10-0-10-86 ~]# mkdir /nfs1</span><br><span class="line">[root@ip-10-0-10-86 ~]# systemctl restart rpcbind</span><br><span class="line">[root@ip-10-0-10-86 ~]# mount -t nfs 10.0.10.70:/nfs /nfs1</span><br><span class="line">[root@ip-10-0-10-86 ~]# df -Th</span><br><span class="line">Filesystem      Type      Size  Used Avail Use% Mounted on</span><br><span class="line">devtmpfs        devtmpfs  391M     0  391M   0% /dev</span><br><span class="line">tmpfs           tmpfs     410M     0  410M   0% /dev/shm</span><br><span class="line">tmpfs           tmpfs     410M   11M  400M   3% /run</span><br><span class="line">tmpfs           tmpfs     410M     0  410M   0% /sys/fs/cgroup</span><br><span class="line">/dev/xvda2      xfs        10G  1.2G  8.9G  12% /</span><br><span class="line">tmpfs           tmpfs      82M     0   82M   0% /run/user/0</span><br><span class="line">10.0.10.70:/nfs nfs4       10G  1.8G  8.3G  18% /nfs1</span><br><span class="line">[root@ip-10-0-10-86 ~]# ls -lh /nfs1/</span><br><span class="line">total 615M</span><br><span class="line">-rw-r--r--. 1 root root 615M Dec 21 10:24 mysql-5.7.25-linux-glibc2.12-x86_64.tar.gz</span><br><span class="line">从数据库2:</span><br><span class="line">[root@ip-10-0-10-39 ~]# mkdir /nfs2</span><br><span class="line">[root@ip-10-0-10-39 ~]# systemctl restart rpcbind</span><br><span class="line">[root@ip-10-0-10-39 ~]# mount -t nfs 10.0.10.70:/nfs /nfs2</span><br><span class="line">[root@ip-10-0-10-39 ~]# df -Th</span><br><span class="line">Filesystem      Type      Size  Used Avail Use% Mounted on</span><br><span class="line">devtmpfs        devtmpfs  391M     0  391M   0% /dev</span><br><span class="line">tmpfs           tmpfs     410M     0  410M   0% /dev/shm</span><br><span class="line">tmpfs           tmpfs     410M   11M  400M   3% /run</span><br><span class="line">tmpfs           tmpfs     410M     0  410M   0% /sys/fs/cgroup</span><br><span class="line">/dev/xvda2      xfs        10G  1.2G  8.9G  12% /</span><br><span class="line">tmpfs           tmpfs      82M     0   82M   0% /run/user/0</span><br><span class="line">10.0.10.70:/nfs nfs4       10G  1.8G  8.3G  18% /nfs2</span><br><span class="line">[root@ip-10-0-10-39 ~]# ls -lh /nfs2/</span><br><span class="line">total 615M</span><br><span class="line">-rw-r--r--. 1 root root 615M Dec 21 10:24 mysql-5.7.25-linux-glibc2.12-x86_64.tar.gz</span><br><span class="line"></span><br><span class="line">安装开始:</span><br><span class="line">[root@ip-10-0-10-70 nfs]# tar xf mysql-5.7.25-linux-glibc2.12-x86_64.tar.gz -C /usr/local/</span><br><span class="line">[root@ip-10-0-10-70 nfs]# cd /usr/local/</span><br><span class="line">[root@ip-10-0-10-70 local]# ln -sv mysql-5.7.25-linux-glibc2.12-x86_64/ mysql</span><br><span class="line">&apos;mysql&apos; -&gt; &apos;mysql-5.7.25-linux-glibc2.12-x86_64/&apos;</span><br><span class="line">[root@ip-10-0-10-70 local]# chown -R mysql.mysql /usr/local/mysql</span><br><span class="line">[root@ip-10-0-10-70 local]# ll /usr/local/mysql -d</span><br><span class="line">lrwxrwxrwx. 1 mysql mysql 36 May 15 05:55 /usr/local/mysql -&gt; mysql-5.7.25-linux-glibc2.12-x86_64/</span><br><span class="line">[root@ip-10-0-10-70 local]# ls /usr/local/mysql</span><br><span class="line">bin  COPYING  docs  include  lib  man  README  share  support-files</span><br><span class="line">[root@ip-10-0-10-70 local]# echo &apos;export PATH=/usr/local/mysql/bin:$PATH&apos; &gt; /etc/profile.d/mysql.sh</span><br><span class="line">[root@ip-10-0-10-70 local]# source /etc/profile.d/mysql.sh</span><br><span class="line">[root@ip-10-0-10-70 local]# echo $PATH</span><br><span class="line">/usr/local/mysql/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/root/bin</span><br><span class="line">初始化数据库</span><br><span class="line">[root@ip-10-0-10-70 ~]# /usr/local/mysql/bin/mysqld --initialize --user=mysql --datadir=/opt/data/</span><br><span class="line">/usr/local/mysql/bin/mysqld: error while loading shared libraries: libaio.so.1: cannot open shared object file: No such file or directory</span><br><span class="line">解决方法:</span><br><span class="line">[root@ip-10-0-10-70 ~]# dnf -y install libaio*    //另外2个也要安装</span><br><span class="line">[root@ip-10-0-10-70 ~]# /usr/local/mysql/bin/mysqld --initialize --user=mysql --datadir=/opt/data/</span><br><span class="line">2019-05-15T06:05:26.411877Z 0 [Warning] TIMESTAMP with implicit DEFAULT value is deprecated. Please use --explicit_defaults_for_timestamp server option (see documentation for more details).</span><br><span class="line">2019-05-15T06:05:27.226596Z 0 [Warning] InnoDB: New log files created, LSN=45790</span><br><span class="line">2019-05-15T06:05:27.469528Z 0 [Warning] InnoDB: Creating foreign key constraint system tables.</span><br><span class="line">2019-05-15T06:05:27.532234Z 0 [Warning] No existing UUID has been found, so we assume that this is the first time that this server has been started. Generating a new UUID: 6faf638d-76d7-11e9-a710-061fe46abf16.</span><br><span class="line">2019-05-15T06:05:27.533755Z 0 [Warning] Gtid table is not ready to be used. Table &apos;mysql.gtid_executed&apos; cannot be opened.</span><br><span class="line">2019-05-15T06:05:27.534192Z 1 [Note] A temporary password is generated for root@localhost: dgjdbs6vi.6T</span><br><span class="line">[root@ip-10-0-10-70 ~]# echo &apos;dgjdbs6vi.6T&apos; &gt;pass</span><br><span class="line">[root@ip-10-0-10-70 ~]# cat pass </span><br><span class="line">dgjdbs6vi.6T    //初始密码,要记住,一会要用</span><br><span class="line">生成配置文件</span><br><span class="line">[root@ip-10-0-10-70 ~]# cat &gt;/etc/my.cnf &lt;&lt;EOF</span><br><span class="line">&gt; [mysqld]</span><br><span class="line">&gt; basedir = /usr/local/mysql</span><br><span class="line">&gt; datadir = /opt/data</span><br><span class="line">&gt; socket = /tmp/mysql.sock</span><br><span class="line">&gt; port = 3306</span><br><span class="line">&gt; pid-file = /opt/data/mysql.pid</span><br><span class="line">&gt; user = mysql</span><br><span class="line">&gt; skip-name-resolve</span><br><span class="line">&gt; EOF</span><br><span class="line">配置服务启动脚本</span><br><span class="line">[root@ip-10-0-10-70 ~]# cp -a /usr/local/mysql/support-files/mysql.server /etc/init.d/mysqld</span><br><span class="line">[root@ip-10-0-10-70 ~]# sed -ri &apos;s#^(basedir=).*#\1/usr/local/mysql#g&apos; /etc/init.d/mysqld</span><br><span class="line">[root@ip-10-0-10-70 ~]# sed -ri &apos;s#^(datadir=).*#\1/opt/data#g&apos; /etc/init.d/mysqld</span><br><span class="line">启动mysql</span><br><span class="line">[root@ip-10-0-10-70 ~]# /etc/init.d/mysqld start</span><br><span class="line">Starting MySQL.Logging to &apos;/opt/data/ip-10-0-10-70.ap-northeast-1.compute.internal.err&apos;.</span><br><span class="line"> SUCCESS! </span><br><span class="line">[root@ip-10-0-10-70 ~]# ps -ef|grep mysql</span><br><span class="line">root     15530     1  0 06:13 pts/1    00:00:00 /bin/sh /usr/local/mysql/bin/mysqld_safe --datadir=/opt/data --pid-file=/opt/data/mysql.pid</span><br><span class="line">mysql    15718 15530  2 06:13 pts/1    00:00:00 /usr/local/mysql/bin/mysqld --basedir=/usr/local/mysql --datadir=/opt/data --plugin-dir=/usr/local/mysql/lib/plugin --user=mysql --log-error=ip-10-0-10-70.ap-northeast-1.compute.internal.err --pid-file=/opt/data/mysql.pid --socket=/tmp/mysql.sock --port=3306</span><br><span class="line">root     15748 15355  0 06:13 pts/1    00:00:00 grep --color=auto mysql</span><br><span class="line">[root@ip-10-0-10-70 ~]# ss -antl</span><br><span class="line">State     Recv-Q     Send-Q           Local Address:Port            Peer Address:Port     </span><br><span class="line">LISTEN    0          128                    0.0.0.0:22                   0.0.0.0:*        </span><br><span class="line">LISTEN    0          64                     0.0.0.0:39517                0.0.0.0:*        </span><br><span class="line">LISTEN    0          64                     0.0.0.0:2049                 0.0.0.0:*        </span><br><span class="line">LISTEN    0          128                    0.0.0.0:48229                0.0.0.0:*        </span><br><span class="line">LISTEN    0          128                    0.0.0.0:111                  0.0.0.0:*        </span><br><span class="line">LISTEN    0          128                    0.0.0.0:20048                0.0.0.0:*        </span><br><span class="line">LISTEN    0          128                       [::]:22                      [::]:*        </span><br><span class="line">LISTEN    0          64                        [::]:2049                    [::]:*        </span><br><span class="line">LISTEN    0          128                       [::]:48385                   [::]:*        </span><br><span class="line">LISTEN    0          80                           *:3306                       *:*        </span><br><span class="line">LISTEN    0          64                        [::]:40523                   [::]:*        </span><br><span class="line">LISTEN    0          128                       [::]:111                     [::]:*        </span><br><span class="line">LISTEN    0          128                       [::]:20048                   [::]:*</span><br><span class="line">修改密码</span><br><span class="line">使用临时密码登录</span><br><span class="line">[root@ip-10-0-10-70 ~]# /usr/local/mysql/bin/mysql -uroot -p</span><br><span class="line">/usr/local/mysql/bin/mysql: error while loading shared libraries: libncurses.so.5: cannot open shared object file: No such file or directory</span><br><span class="line">解决方法</span><br><span class="line">[root@ip-10-0-10-70 ~]# dnf -y install libncurses*</span><br><span class="line">[root@ip-10-0-10-70 ~]# /usr/local/mysql/bin/mysql -uroot -p</span><br><span class="line">Enter password: </span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 2</span><br><span class="line">Server version: 5.7.25</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2019, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type &apos;help;&apos; or &apos;\h&apos; for help. Type &apos;\c&apos; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">mysql&gt; set password = password(&apos;jbgsn123!&apos;);</span><br><span class="line">Query OK, 0 rows affected, 1 warning (0.01 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; exit</span><br><span class="line">Bye</span><br><span class="line">[root@ip-10-0-10-70 ~]# cp /etc/my.cnf /nfs/</span><br><span class="line">[root@ip-10-0-10-70 ~]# cp /etc/init.d/mysqld /nfs/</span><br><span class="line">[root@ip-10-0-10-70 ~]# ll /nfs/</span><br><span class="line">total 629768</span><br><span class="line">-rw-r--r--. 1 root root        155 May 15 06:20 my.cnf</span><br><span class="line">-rw-r--r--. 1 7161 31415 644862820 Dec 21 11:23 mysql-5.7.25-linux-glibc2.12-x86_64.tar.gz</span><br><span class="line">-rwxr-xr-x. 1 root root      10601 May 15 06:20 mysqld</span><br><span class="line">从服务器方法一样,特此写一个</span><br><span class="line">[root@ip-10-0-10-86 nfs1]# tar xf mysql-5.7.25-linux-glibc2.12-x86_64.tar -C /usr/local/</span><br><span class="line">[root@ip-10-0-10-86 nfs1]# cd /usr/local/</span><br><span class="line">[root@ip-10-0-10-86 local]# ln -sv mysql-5.7.25-linux-glibc2.12-x86_64/ mysql</span><br><span class="line">&apos;mysql&apos; -&gt; &apos;mysql-5.7.25-linux-glibc2.12-x86_64/&apos;</span><br><span class="line">[root@ip-10-0-10-86 local]# chown -R mysql.mysql /usr/local/mysql</span><br><span class="line">[root@ip-10-0-10-86 local]# echo &apos;export PATH=/usr/local/mysql/bin:$PATH&apos; &gt; /etc/profile.d/mysql.sh</span><br><span class="line">[root@ip-10-0-10-86 local]# source /etc/profile.d/mysql.sh</span><br><span class="line">[root@ip-10-0-10-86 local]# /usr/local/mysql/bin/mysqld --initialize --user=mysql --datadir=/opt/data/</span><br><span class="line">2019-05-15T06:25:33.161453Z 0 [Warning] TIMESTAMP with implicit DEFAULT value is deprecated. Please use --explicit_defaults_for_timestamp server option (see documentation for more details).</span><br><span class="line">2019-05-15T06:25:33.981113Z 0 [Warning] InnoDB: New log files created, LSN=45790</span><br><span class="line">2019-05-15T06:25:34.223408Z 0 [Warning] InnoDB: Creating foreign key constraint system tables.</span><br><span class="line">2019-05-15T06:25:34.284942Z 0 [Warning] No existing UUID has been found, so we assume that this is the first time that this server has been started. Generating a new UUID: 3ef73d2c-76da-11e9-bea1-06dc2c9b3f12.</span><br><span class="line">2019-05-15T06:25:34.286543Z 0 [Warning] Gtid table is not ready to be used. Table &apos;mysql.gtid_executed&apos; cannot be opened.</span><br><span class="line">2019-05-15T06:25:34.286983Z 1 [Note] A temporary password is generated for root@localhost: q%_H12.OAvta</span><br><span class="line">[root@ip-10-0-10-86 local]# echo &apos;q%_H12.OAvta&apos;&gt;pass</span><br><span class="line">[root@ip-10-0-10-86 local]# cp /nfs1/my.cnf /etc/</span><br><span class="line">[root@ip-10-0-10-86 local]# cp /nfs1/mysqld /etc/init.d/</span><br><span class="line">[root@ip-10-0-10-86 local]# /etc/init.d/mysqld start</span><br><span class="line">Starting MySQL.Logging to &apos;/opt/data/ip-10-0-10-86.ap-northeast-1.compute.internal.err&apos;.</span><br><span class="line"> SUCCESS! </span><br><span class="line">[root@ip-10-0-10-86 local]# /usr/local/mysql/bin/mysql -uroot -p</span><br><span class="line">Enter password: </span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 2</span><br><span class="line">Server version: 5.7.25</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2019, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type &apos;help;&apos; or &apos;\h&apos; for help. Type &apos;\c&apos; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">mysql&gt; set password = password(&apos;jbgsn123!&apos;);</span><br><span class="line">Query OK, 0 rows affected, 1 warning (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; quit</span><br><span class="line">Bye</span><br><span class="line">三个服务器上MySQL密码都是jbgsn123!,配置一样</span><br></pre></td></tr></table></figure><h3 id="3-2-mysql主从配置-2个新的mysql服务器"><a href="#3-2-mysql主从配置-2个新的mysql服务器" class="headerlink" title="3.2 mysql主从配置(2个新的mysql服务器)"></a>3.2 mysql主从配置(2个新的mysql服务器)</h3><h4 id="3-2-1-在主数据库里创建一个同步账号授权给从数据库使用"><a href="#3-2-1-在主数据库里创建一个同步账号授权给从数据库使用" class="headerlink" title="3.2.1 在主数据库里创建一个同步账号授权给从数据库使用"></a>3.2.1 在主数据库里创建一个同步账号授权给从数据库使用</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; create user &apos;whs&apos;@&apos;10.0.10.86&apos; identified by &apos;itwhs1&apos;;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; grant replication slave on *.* to &apos;whs&apos;@&apos;10.0.10.86&apos;;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; flush privileges;</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br></pre></td></tr></table></figure><h4 id="3-2-2-配置主数据库"><a href="#3-2-2-配置主数据库" class="headerlink" title="3.2.2 配置主数据库"></a>3.2.2 配置主数据库</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[root@ip-10-0-10-70 ~]# vim /etc/my.cnf </span><br><span class="line">在[mysqld]这段的后面加上如下内容</span><br><span class="line">[mysqld]</span><br><span class="line">basedir = /usr/local/mysql</span><br><span class="line">datadir = /opt/data</span><br><span class="line">socket = /tmp/mysql.sock</span><br><span class="line">port = 3306</span><br><span class="line">pid-file = /opt/data/mysql.pid</span><br><span class="line">user = mysql</span><br><span class="line">skip-name-resolve</span><br><span class="line">log-bin = mysql-bin    //启用binlog日志</span><br><span class="line">server-id = 1    //数据库服务器唯一标识符，主库的server-id值必须比从库的大</span><br><span class="line">log-error = /var/log/mysqld.log   //记录错误日志</span><br><span class="line"></span><br><span class="line">重启mysql服务</span><br><span class="line">[root@ip-10-0-10-70 ~]# /etc/init.d/mysqld restart</span><br><span class="line">Shutting down MySQL.. SUCCESS! </span><br><span class="line">Starting MySQL. SUCCESS!</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">查看主库的状态</span><br><span class="line">[root@ip-10-0-10-70 ~]# /usr/local/mysql/bin/mysql -uroot -pjbgsn123! -e &apos;show master status;&apos;</span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">+------------------+----------+--------------+------------------+-------------------+</span><br><span class="line">| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |</span><br><span class="line">+------------------+----------+--------------+------------------+-------------------+</span><br><span class="line">| mysql-bin.000001 |      154 |              |                  |                   |</span><br><span class="line">+------------------+----------+--------------+------------------+-------------------+</span><br></pre></td></tr></table></figure><h4 id="3-2-3-配置从数据库"><a href="#3-2-3-配置从数据库" class="headerlink" title="3.2.3 配置从数据库"></a>3.2.3 配置从数据库</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">[root@ip-10-0-10-86 ~]# vim /etc/my.cnf</span><br><span class="line">添加如下内容</span><br><span class="line">[mysqld]</span><br><span class="line">basedir = /usr/local/mysql</span><br><span class="line">datadir = /opt/data</span><br><span class="line">socket = /tmp/mysql.sock</span><br><span class="line">port = 3306</span><br><span class="line">pid-file = /opt/data/mysql.pid</span><br><span class="line">user = mysql</span><br><span class="line">skip-name-resolve</span><br><span class="line">server-id=2    //设置从库的唯一标识符，从库的server-id值必须小于主库的该值</span><br><span class="line">relay-log=mysql-relay-bin    //启用中继日志relay-log     </span><br><span class="line">symbolic-links=0</span><br><span class="line">log-error=/var/log/mysqld.log</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">重启从库的mysql服务</span><br><span class="line">[root@ip-10-0-10-86 ~]# /etc/init.d/mysqld restart</span><br><span class="line">Shutting down MySQL.. SUCCESS! </span><br><span class="line">Starting MySQL. SUCCESS!</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">配置并启动主从复制</span><br><span class="line">[root@ip-10-0-10-86 ~]# /usr/local/mysql/bin/mysql -uroot -pjbgsn123!</span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 2</span><br><span class="line">Server version: 5.7.25 MySQL Community Server (GPL)</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2019, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type &apos;help;&apos; or &apos;\h&apos; for help. Type &apos;\c&apos; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">mysql&gt; change master to</span><br><span class="line">    -&gt; master_host=&apos;10.0.10.70&apos;,</span><br><span class="line">    -&gt; master_user=&apos;whs&apos;,</span><br><span class="line">    -&gt; master_password=&apos;itwhs1&apos;,</span><br><span class="line">    -&gt; master_log_file=&apos;mysql-bin.000001&apos;,</span><br><span class="line">    -&gt; master_log_pos=154;</span><br><span class="line">Query OK, 0 rows affected, 2 warnings (0.02 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; start slave;</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; show slave status \G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">               Slave_IO_State: Waiting for master to send event</span><br><span class="line">                  Master_Host: 10.0.10.70</span><br><span class="line">                  Master_User: whs</span><br><span class="line">                  Master_Port: 3306</span><br><span class="line">                Connect_Retry: 60</span><br><span class="line">              Master_Log_File: mysql-bin.000001</span><br><span class="line">          Read_Master_Log_Pos: 154</span><br><span class="line">               Relay_Log_File: mysql-relay-bin.000002</span><br><span class="line">                Relay_Log_Pos: 320</span><br><span class="line">        Relay_Master_Log_File: mysql-bin.000001</span><br><span class="line">             Slave_IO_Running: Yes      //此处必须为Yes</span><br><span class="line">            Slave_SQL_Running: Yes      //此处必须为Yes</span><br><span class="line">              Replicate_Do_DB:</span><br><span class="line">          Replicate_Ignore_DB:</span><br></pre></td></tr></table></figure><h4 id="3-2-4-测试验证"><a href="#3-2-4-测试验证" class="headerlink" title="3.2.4 测试验证"></a>3.2.4 测试验证</h4><p><strong>在主服务器创建aiwhs库和it表并插入数据：</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; create database aiwhs;</span><br><span class="line">Query OK, 1 row affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; use aiwhs;</span><br><span class="line">Database changed</span><br><span class="line">mysql&gt; create table it (id mediumint not null auto_increment,name char(30) not null,age tinyint,primary key (id));</span><br><span class="line">Query OK, 0 rows affected (0.02 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; insert into it(name,age) values(&apos;zhangshan&apos;,26),(&apos;zhangshan&apos;,20),(&apos;lisi&apos;,null),(&apos;chenshuo&apos;,10),(&apos;wangwu&apos;,3);</span><br><span class="line">Query OK, 5 rows affected (0.01 sec)</span><br><span class="line">Records: 5  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from it;</span><br><span class="line">+----+-----------+------+</span><br><span class="line">| id | name      | age  |</span><br><span class="line">+----+-----------+------+</span><br><span class="line">|  1 | zhangshan |   26 |</span><br><span class="line">|  2 | zhangshan |   20 |</span><br><span class="line">|  3 | lisi      | NULL |</span><br><span class="line">|  4 | chenshuo  |   10 |</span><br><span class="line">|  5 | wangwu    |    3 |</span><br><span class="line">+----+-----------+------+</span><br><span class="line">5 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure><p><strong>在从数据库中查看数据是否同步：</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@ip-10-0-10-86 ~]# /usr/local/mysql/bin/mysql -uroot -pjbgsn123! -e &apos;select * from aiwhs.it;&apos;</span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">+----+-----------+------+</span><br><span class="line">| id | name      | age  |</span><br><span class="line">+----+-----------+------+</span><br><span class="line">|  1 | zhangshan |   26 |</span><br><span class="line">|  2 | zhangshan |   20 |</span><br><span class="line">|  3 | lisi      | NULL |</span><br><span class="line">|  4 | chenshuo  |   10 |</span><br><span class="line">|  5 | wangwu    |    3 |</span><br><span class="line">+----+-----------+------+</span><br></pre></td></tr></table></figure><h3 id="3-3-mysql主从配置"><a href="#3-3-mysql主从配置" class="headerlink" title="3.3 mysql主从配置"></a>3.3 mysql主从配置</h3><h4 id="3-3-1-确保从数据库与主数据库里的数据一样"><a href="#3-3-1-确保从数据库与主数据库里的数据一样" class="headerlink" title="3.3.1 确保从数据库与主数据库里的数据一样"></a>3.3.1 确保从数据库与主数据库里的数据一样</h4><p>为确保从数据库与主数据库里的数据一样，先全备主数据库并还原到从数据库中</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">先查看主库有哪些库</span><br><span class="line">[root@ip-10-0-10-70 ~]# mysql -uroot -pjbgsn123! -e &apos;show databases;&apos;</span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| aiwhs              |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| sys                |</span><br><span class="line">+--------------------+</span><br><span class="line"></span><br><span class="line">再查看从库有哪些库</span><br><span class="line">[root@ip-10-0-10-39 ~]# mysql -uroot -pjbgsn123! -e &apos;show databases;&apos;</span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| sys                |</span><br><span class="line">+--------------------+</span><br><span class="line"></span><br><span class="line">全备主库</span><br><span class="line">全备主库时需要另开一个终端，给数据库加上读锁，避免在备份期间有其他人在写入导致数据不一致</span><br><span class="line">mysql&gt; flush tables with read lock;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line">此锁表的终端必须在备份完成以后才能退出</span><br><span class="line"></span><br><span class="line">备份主库并将备份文件传送到从库</span><br><span class="line">[root@ip-10-0-10-70 ~]# mysqldump -uroot -pjbgsn123! --all-databases &gt;/nfs/all-201905151548.sql</span><br><span class="line">mysqldump: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">[root@ip-10-0-10-70 ~]# ls /nfs/</span><br><span class="line">all-201905151548.sql  my.cnf  mysql-5.7.25-linux-glibc2.12-x86_64.tar.gz  mysqld</span><br><span class="line"></span><br><span class="line">解除主库的锁表状态，直接退出交互式界面即可</span><br><span class="line">mysql&gt; quit</span><br><span class="line">Bye</span><br><span class="line"></span><br><span class="line">在从库上恢复主库的备份并查看从库有哪些库，确保与主库一致</span><br><span class="line">[root@ip-10-0-10-39 ~]# cd /nfs2/</span><br><span class="line">[root@ip-10-0-10-39 nfs2]# ll</span><br><span class="line">total 630544</span><br><span class="line">-rw-r--r--. 1 root root     792967 May 15 07:50 all-201905151548.sql</span><br><span class="line">-rw-r--r--. 1 root root        155 May 15 06:20 my.cnf</span><br><span class="line">-rw-r--r--. 1 7161 31415 644862820 Dec 21 11:23 mysql-5.7.25-linux-glibc2.12-x86_64.tar.gz</span><br><span class="line">-rwxr-xr-x. 1 root root      10601 May 15 06:20 mysqld</span><br><span class="line">[root@ip-10-0-10-39 nfs2]# mysql -uroot -pjbgsn123! &lt; all-201905151548.sql </span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">[root@ip-10-0-10-39 nfs2]# mysql -uroot -pjbgsn123! -e &apos;show databases;&apos;</span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| aiwhs              |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| sys                |</span><br><span class="line">+--------------------+</span><br></pre></td></tr></table></figure><h4 id="3-3-2-在主数据库里创建一个同步账号授权给从数据库使用"><a href="#3-3-2-在主数据库里创建一个同步账号授权给从数据库使用" class="headerlink" title="3.3.2 在主数据库里创建一个同步账号授权给从数据库使用"></a>3.3.2 在主数据库里创建一个同步账号授权给从数据库使用</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; create user &apos;whs&apos;@&apos;10.0.10.39&apos; identified by &apos;itwhs2&apos;;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; grant replication slave on *.* to &apos;whs&apos;@&apos;10.0.10.39&apos;;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; flush privileges;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure><h4 id="3-3-3-配置主数据库"><a href="#3-3-3-配置主数据库" class="headerlink" title="3.3.3 配置主数据库"></a>3.3.3 配置主数据库</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[root@ip-10-0-10-70 ~]# /etc/init.d/mysqld restart</span><br><span class="line">Shutting down MySQL............ SUCCESS! </span><br><span class="line">Starting MySQL. SUCCESS!</span><br><span class="line"></span><br><span class="line">查看主库的状态</span><br><span class="line">mysql&gt; show master status;</span><br><span class="line">+------------------+----------+--------------+------------------+-------------------+</span><br><span class="line">| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |</span><br><span class="line">+------------------+----------+--------------+------------------+-------------------+</span><br><span class="line">| mysql-bin.000003 |      154 |              |                  |                   |</span><br><span class="line">+------------------+----------+--------------+------------------+-------------------+</span><br><span class="line">1 row in set (0.00 sec)  //发现,重启mysql后log-bin会变,position也会变,之前配的从服务器大约10秒后会同步状态</span><br><span class="line"></span><br><span class="line">上一个从服务器同步状态</span><br><span class="line">mysql&gt; show slave status \G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">               Slave_IO_State: Waiting for master to send event</span><br><span class="line">                  Master_Host: 10.0.10.70</span><br><span class="line">                  Master_User: whs</span><br><span class="line">                  Master_Port: 3306</span><br><span class="line">                Connect_Retry: 60</span><br><span class="line">              Master_Log_File: mysql-bin.000003</span><br><span class="line">          Read_Master_Log_Pos: 154</span><br><span class="line">               Relay_Log_File: mysql-relay-bin.000006</span><br><span class="line">                Relay_Log_Pos: 367</span><br><span class="line">        Relay_Master_Log_File: mysql-bin.000003</span><br><span class="line">             Slave_IO_Running: Yes</span><br><span class="line">            Slave_SQL_Running: Yes</span><br></pre></td></tr></table></figure><h4 id="3-3-4-配置从数据库"><a href="#3-3-4-配置从数据库" class="headerlink" title="3.3.4 配置从数据库"></a>3.3.4 配置从数据库</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">[root@ip-10-0-10-39 ~]# vim /etc/my.cnf</span><br><span class="line">添加如下内容</span><br><span class="line">[mysqld]</span><br><span class="line">basedir = /usr/local/mysql</span><br><span class="line">datadir = /opt/data</span><br><span class="line">socket = /tmp/mysql.sock</span><br><span class="line">port = 3306</span><br><span class="line">pid-file = /opt/data/mysql.pid</span><br><span class="line">user = mysql</span><br><span class="line">skip-name-resolve</span><br><span class="line">server-id = 3   //设置从库的唯一标识符，从库的server-id值必须小于主库的该值</span><br><span class="line">relay-log = mysql-relay-bin    //启用中继日志relay-log     </span><br><span class="line">symbolic-links = 0</span><br><span class="line">log-error = /var/log/mysqld.log</span><br><span class="line"></span><br><span class="line">重启从库的mysql服务</span><br><span class="line">[root@ip-10-0-10-39 ~]# /etc/init.d/mysqld restart</span><br><span class="line">Shutting down MySQL.. SUCCESS! </span><br><span class="line">Starting MySQL. SUCCESS!</span><br><span class="line"></span><br><span class="line">配置并启动主从复制</span><br><span class="line">mysql&gt; change master to</span><br><span class="line">    -&gt; master_host=&apos;10.0.10.70&apos;,</span><br><span class="line">    -&gt; master_user=&apos;whs&apos;,</span><br><span class="line">    -&gt; master_password=&apos;itwhs2&apos;,</span><br><span class="line">    -&gt; master_log_file=&apos;mysql-bin.000003&apos;,</span><br><span class="line">    -&gt; master_log_pos=154;</span><br><span class="line">Query OK, 0 rows affected, 2 warnings (0.02 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; start slave;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; show slave status \G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">               Slave_IO_State: Waiting for master to send event</span><br><span class="line">                  Master_Host: 10.0.10.70</span><br><span class="line">                  Master_User: whs</span><br><span class="line">                  Master_Port: 3306</span><br><span class="line">                Connect_Retry: 60</span><br><span class="line">              Master_Log_File: mysql-bin.000003</span><br><span class="line">          Read_Master_Log_Pos: 154</span><br><span class="line">               Relay_Log_File: mysql-relay-bin.000002</span><br><span class="line">                Relay_Log_Pos: 320</span><br><span class="line">        Relay_Master_Log_File: mysql-bin.000003</span><br><span class="line">             Slave_IO_Running: Yes</span><br><span class="line">            Slave_SQL_Running: Yes</span><br></pre></td></tr></table></figure><h4 id="3-3-5-测试验证"><a href="#3-3-5-测试验证" class="headerlink" title="3.3.5 测试验证"></a>3.3.5 测试验证</h4><p><strong>在主服务器的aiwhs库的it表中插入数据：</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; insert into it(name,age) values(&apos;dbf&apos;,26),(&apos;nfgb&apos;,56),(&apos;gsd&apos;,54),(&apos;sfs&apos;,33); </span><br><span class="line">Query OK, 4 rows affected (0.01 sec)</span><br><span class="line">Records: 4  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from it;</span><br><span class="line">+----+-----------+------+</span><br><span class="line">| id | name      | age  |</span><br><span class="line">+----+-----------+------+</span><br><span class="line">|  1 | zhangshan |   26 |</span><br><span class="line">|  2 | zhangshan |   20 |</span><br><span class="line">|  3 | lisi      | NULL |</span><br><span class="line">|  4 | chenshuo  |   10 |</span><br><span class="line">|  5 | wangwu    |    3 |</span><br><span class="line">|  6 | dbf       |   26 |</span><br><span class="line">|  7 | nfgb      |   56 |</span><br><span class="line">|  8 | gsd       |   54 |</span><br><span class="line">|  9 | sfs       |   33 |</span><br><span class="line">+----+-----------+------+</span><br><span class="line">9 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure><p><strong>在从数据库中查看数据是否同步：</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@ip-10-0-10-39 ~]# mysql -uroot -pjbgsn123! -e &apos;select * from aiwhs.it;&apos;</span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">+----+-----------+------+</span><br><span class="line">| id | name      | age  |</span><br><span class="line">+----+-----------+------+</span><br><span class="line">|  1 | zhangshan |   26 |</span><br><span class="line">|  2 | zhangshan |   20 |</span><br><span class="line">|  3 | lisi      | NULL |</span><br><span class="line">|  4 | chenshuo  |   10 |</span><br><span class="line">|  5 | wangwu    |    3 |</span><br><span class="line">|  6 | dbf       |   26 |</span><br><span class="line">|  7 | nfgb      |   56 |</span><br><span class="line">|  8 | gsd       |   54 |</span><br><span class="line">|  9 | sfs       |   33 |</span><br><span class="line">+----+-----------+------+</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;a id=&quot;more&quot;&gt;&lt;/a&gt;

&lt;h3 id=&quot;MySQL主从复制虽好，能完美解决数据库单点问题吗？&quot;&gt;&lt;a href=&quot;#MySQL主从复制虽好，能完美解决数据库单点问题吗？&quot; class=&quot;headerlink&quot; title=&quot;MySQL主从复制虽好，能完美解决数据库单
      
    
    </summary>
    
      <category term="Linux运维" scheme="http://aiwhs.github.io/categories/Linux%E8%BF%90%E7%BB%B4/"/>
    
    
      <category term="MySQL" scheme="http://aiwhs.github.io/tags/MySQL/"/>
    
  </entry>
  
  <entry>
    <title>三种代理</title>
    <link href="http://aiwhs.github.io/2018/12/02/%E4%B8%89%E7%A7%8D%E4%BB%A3%E7%90%86%E7%9A%84%E7%AE%80%E5%8D%95%E6%80%BB%E7%BB%93/"/>
    <id>http://aiwhs.github.io/2018/12/02/三种代理的简单总结/</id>
    <published>2018-12-02T00:15:57.000Z</published>
    <updated>2019-07-11T12:22:10.874Z</updated>
    
    <content type="html"><![CDATA[<a id="more"></a><h2 id="正向代理、反向代理以及透明代理的简单总结"><a href="#正向代理、反向代理以及透明代理的简单总结" class="headerlink" title="正向代理、反向代理以及透明代理的简单总结"></a>正向代理、反向代理以及透明代理的简单总结</h2><p>代理服务技术是一门很古老的技术，是在互联网早期出现就使用的技术。一般实现代理技术的方式就是在服务器上安装代理服务软件，让其成为一个代理服务器，从而实现代理技术。常用的代理技术分为正向代理、反向代理和透明代理。</p><h3 id="1-正向代理服务器"><a href="#1-正向代理服务器" class="headerlink" title="1.正向代理服务器"></a>1.正向代理服务器</h3><p>正向代理服务器位于用户与目标服务器之间，用户通过对代理服务器发送指向目标服务器的请求来获得资源。用户端需要作一些设定才可以使用正向代理服务器，而反向/透明代理服务器是不需要对用户端进行任何设定的。</p><p><img src="../../img/1559291821892525.png" alt="正向代理服务器"></p><h3 id="2-反向代理服务器"><a href="#2-反向代理服务器" class="headerlink" title="2.反向代理服务器"></a>2.反向代理服务器</h3><p>反向代理服务器同样位于用户与目标服务器之间，但对于用户而言，反向代理服务器就相当于目标服务器，即用户直接访问反向代理服务器就可以获得目标服务器的资源。同时，用户不需要知道目标服务器地址，也无需在用户端作任何设定。反向代理服务器通常可用来作Web加速，即使用反向代理作为Web服务器的前置机来降低网络和服务器的负载，提高访问效率。</p><p><img src="../../img/1559291828305494.png" alt="反向代理服务器"></p><h3 id="3-透明代理服务器"><a href="#3-透明代理服务器" class="headerlink" title="3.透明代理服务器"></a>3.透明代理服务器</h3><p>透明代理服务器位于于用户与目标服务器之间.和前两种服务器不同的是，用户即不需要对客户端进行任何设定，也无需知道代理服务器的地址。用户只需要向目标服务器上的资源发起请求即可，然后透明代理服务器会将系统的请求重新定向到代理服务器，然后由代理服务器获得目标资源并返回给用户端。通常，透明代理服务器在局域网中应用。</p><p><img src="../../img/1559291831121815.png" alt="透明代理服务器 "></p><h3 id="正向代理-Forward-Proxy-代理端代理的是客户端"><a href="#正向代理-Forward-Proxy-代理端代理的是客户端" class="headerlink" title="正向代理(Forward Proxy)-代理端代理的是客户端"></a>正向代理(Forward Proxy)-代理端代理的是客户端</h3><p>一般情况下，如果没有特别说明，代理技术默认说的是正向代理技术。关于正向代理的概念如下： 正向代理(forward)是一个位于客户端【用户A】和原始服务器(origin server)【服务器B】之间的服务器【代理服务器Z】，为了从原始服务器取得内容，用户A向代理服务器Z发送一个请求并指定目标(服务器B)，然后代理服务器Z向服务器B转交请求并将获得的内容返回给客户端。客户端必须要进行一些特别的设置才能使用正向代理。 </p><p><img src="../../img/16adfd339dd7624b.jpg" alt="正向代理与反向代理示意图1"></p><p>从上面的概念中，我们看出，文中所谓的<strong>正向代理就是代理服务器替代访问方【用户】去访问目标服务器【服务器】</strong></p><h4 id="使用正向代理服务器的作用如下："><a href="#使用正向代理服务器的作用如下：" class="headerlink" title="使用正向代理服务器的作用如下："></a>使用正向代理服务器的作用如下：</h4><p><strong>1.翻墙</strong></p><p>国内用浏览器访问某些被强网站时，被残忍的拒绝了，于是你可以在国外搭建一台代理服务器，让代理帮我去请求，代理把请求返回的相应结构再返回给我。</p><p><img src="../../img/16adfd339e4caeda.jpg" alt="翻墙"></p><p><strong>2.Cache作用</strong></p><p>数据缓存在代理服务器上，如果客户端请求的内容在缓存中则不去访问目标主机。 Cache（缓存）技术和代理服务技术是紧密联系的（不光是正向代理，反向代理也使用了Cache（缓存）技术。如果在用户A访问服务器B某数据J之前，已经有人通过代理服务器Z访问过服务器B上得数据J，那么代理服务器Z会把数据J保存一段时间，如果有人正好取该数据J，那么代理服务器Z不再访问服务器B，而把缓存的数据J直接发给用户A。这一技术在Cache中术语就叫Cache命中。如果有更多的像用户A的用户来访问代理服务器Z，那么这些用户都可以直接从代理服务器Z中取得数据J，而不用千里迢迢的去服务器B下载数据了。</p><p><strong>3.客户端访问授权</strong></p><p>这方面的内容现今使用的还是比较多的，例如一些公司采用ISA SERVER做为正向代理服务器来授权用户是否有权限访问互联网。</p><p><img src="../../img/16adfd339debb546.jpg" alt="客户端访问授权"></p><p>防火墙作为网关，用来过滤外网对其的访问。假设用户A和用户B都设置了代理服务器，用户A允许访问互联网，而用户B不允许访问互联网（这个在代理服务器Z上做限制）这样用户A因为授权，可以通过代理服务器访问到服务器B，而用户B因为没有被代理服务器Z授权，所以访问服务器B时，数据包会被直接丢弃。</p><p><strong>4.隐藏访问者</strong></p><p>通过配置，目标服务器无法获取真实客户端信息，只能获取到代理服务器的信息</p><p>##反向代理(Forward Proxy)-代理端代理的是服务端</p><p>反向代理正好与正向代理相反，对于客户端而言<strong>代理服务器就像是原始服务器</strong>，并且客户端不需要进行任何特别的设置。客户端向反向代理的命名空间(name-space)中的内容发送普通请求，接着反向代理将判断向何处(原始服务器)转交请求，并将获得的内容返回给客户端。</p><h4 id="使用反向代理服务器的作用如下："><a href="#使用反向代理服务器的作用如下：" class="headerlink" title="使用反向代理服务器的作用如下："></a>使用反向代理服务器的作用如下：</h4><p><strong>1.保护和隐藏原始资源服务器</strong></p><p><img src="../../img/16adfd339e359655.jpg" alt="保护和隐藏原始资源服务器"></p><p>如上图所示，用户A始终认为它访问的是原始服务器B而不是代理服务器Z，但实用际上反向代理服务器接受用户A的应答，从原始资源服务器B中取得用户A的需求资源，然后发送给用户A。由于防火墙的作用，只允许代理服务器Z访问原始资源服务器B。尽管在这个虚拟的环境下，防火墙和反向代理的共同作用保护了原始资源服务器B，但用户A并不知情。</p><p><strong>2.负载均衡</strong></p><p><img src="../../img/16adfd339ebeed4b.jpg" alt="负载均衡"></p><p>当反向代理服务器不止一个的时候，我们甚至可以把它们做成集群，当更多的用户访问资源服务器B的时候，让不同的代理服务器Z(x)去应答不同的用户，然后发送不同用户需要的资源。</p><p><strong>3.cache缓存</strong></p><p>当然反向代理服务器像正向代理服务器一样拥有cache的作用，它可以缓存原始资源服务器B的资源，而不是每次都要向原始资源服务器B请求数据，特别是一些静态的数据，比如图片和文件，如果这些反向代理服务器能够做到和用户X来自同一个网络，那么用户X访问反向代理服务器X，就会得到很高质量的速度。这正是CDN技术的核心。如下图所示</p><p><img src="../../img/16adfd33cadfe378.jpg" alt="image.png"></p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><h4 id="正向代理"><a href="#正向代理" class="headerlink" title="正向代理"></a>正向代理</h4><p>正向代理位于客户端和源服务器之间的服务器<strong>（代理客户端）</strong>；</p><ul><li><strong>隐藏客户端</strong>：由代理服务器代替客户端去访问目标服务器，用户需要设置代理服务器的IP和端口；</li><li>每一次请求是到代理服务器，代理服务器转发请求到真实服务器并获取结果返回给客户端</li></ul><p><strong>作用：</strong></p><ul><li>翻墙：绕过无法访问的结点，从另外一条路由路径进行目标服务器的访问；</li><li>缓存：数据缓存在代理服务器上，如果客户端请求的内容在缓存中则不去访问目标主机；</li><li>权限控制：防火墙授权代理服务器访问权限，客户端通过正向代理可以通过防火墙；</li><li>隐藏访问者：通过配置，目标服务器无法获取真实客户端信息，只能获取到代理服务器的信息</li></ul><h4 id="反向代理"><a href="#反向代理" class="headerlink" title="反向代理"></a>反向代理</h4><p>对于客户端而言，反向代理服务器像是原始服务器<strong>（代理服务端）</strong>；</p><ul><li><strong>隐藏真实服务器</strong>：代理服务器代替目标服务器去接受并返回客户端的请求</li></ul><p><strong>作用：</strong></p><ul><li>隐藏真实服务器：防止服务器恶意攻击等；</li><li>缓存作用：数据缓存在代理服务器上，如果客户端请求的内容在缓存中则不去访问目标主机；</li><li>负载均衡：如nginx</li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;a id=&quot;more&quot;&gt;&lt;/a&gt;

&lt;h2 id=&quot;正向代理、反向代理以及透明代理的简单总结&quot;&gt;&lt;a href=&quot;#正向代理、反向代理以及透明代理的简单总结&quot; class=&quot;headerlink&quot; title=&quot;正向代理、反向代理以及透明代理的简单总结&quot;&gt;&lt;/a&gt;正向代理、反向
      
    
    </summary>
    
      <category term="Linux运维" scheme="http://aiwhs.github.io/categories/Linux%E8%BF%90%E7%BB%B4/"/>
    
    
      <category term="proxy" scheme="http://aiwhs.github.io/tags/proxy/"/>
    
  </entry>
  
  <entry>
    <title>xtrabackup</title>
    <link href="http://aiwhs.github.io/2018/12/01/xtrabackup/"/>
    <id>http://aiwhs.github.io/2018/12/01/xtrabackup/</id>
    <published>2018-12-01T00:15:57.000Z</published>
    <updated>2019-07-09T11:28:45.245Z</updated>
    
    <content type="html"><![CDATA[<a id="more"></a><h2 id="xtrabackup的安装-centos-rhel系列"><a href="#xtrabackup的安装-centos-rhel系列" class="headerlink" title="xtrabackup的安装(centos/rhel系列)"></a>xtrabackup的安装(centos/rhel系列)</h2><p><a href="https://www.percona.com/doc/percona-xtrabackup/2.4/installation/yum_repo.html" target="_blank" rel="noopener">想要支持5.7版本的备份至少得2.4的，然后8.0的只支持mysql8</a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum -y install https://repo.percona.com/yum/percona-release-latest.noarch.rpm</span><br><span class="line">yum -y list | grep percona</span><br><span class="line">yum -y install percona-xtrabackup-24</span><br></pre></td></tr></table></figure><p><strong>xtrabackup的特性：</strong></p><p>使用innobakupex备份时，其会调用xtrabackup备份所有的InnoDB表，复制所有关于表结构定义的相关文件(.frm)、以及MyISAM、MERGE、CSV和ARCHIVE表的相关文件，同时还会备份触发器和数据库配置信息相关的文件。这些文件会被保存至一个以时间命名的目录中,在备份时，innobackupex还会在备份目录中创建如下文件：</p><ol><li>xtrabackup_checkpoints：备份类型（如完全或增量）、备份状态（如是否已经为prepared状态）和LSN(日志序列号)范围信息,每个InnoDB页(通常为16k大小)都会包含一个日志序列号，即LSN。LSN是整个数据库系统的系统版本号，每个页面相关的LSN能够表明此页面最近是如何发生改变的</li><li>xtrabackup_binlog_info：mysql服务器当前正在使用的二进制日志文件及至备份这一刻为止二进制日志事件的位置</li><li>xtrabackup_binlog_pos_innodb：二进制日志文件及用于InnoDB或XtraDB表的二进制日志文件的当position</li><li>xtrabackup_binary：备份中用到的xtrabackup的可执行文件</li><li>backup-my.cnf：备份命令用到的配置选项信息在使用innobackupex进行备份时，还可以使用–no-timestamp选项来阻止命令自动创建一个以时间命名的目录；innobackupex命令将会创建一个BACKUP-DIR目录来存储备份数据</li></ol><h3 id="该xtrabackup2-4选项参考"><a href="#该xtrabackup2-4选项参考" class="headerlink" title="该xtrabackup2.4选项参考"></a>该<strong>xtrabackup2.4</strong>选项参考</h3><p>此页面记录了<strong>xtrabackup</strong>二进制文件的所有命令行选项 。</p><h3 id="选项"><a href="#选项" class="headerlink" title="选项"></a>选项</h3><p>–apply-log-only</p><p>此选项仅在准备备份时执行重做阶段。这对增量备份非常重要。</p><p>–backup</p><p>进行备份并将其放入。</p><p>请参阅 <a href="https://www.percona.com/doc/percona-xtrabackup/2.4/backup_scenarios/full_backup.html#creating-a-backup" target="_blank" rel="noopener">创建备份</a>。<a href="https://www.percona.com/doc/percona-xtrabackup/2.4/xtrabackup_bin/xbk_option_reference.html#cmdoption-xtrabackup-target-dir" target="_blank" rel="noopener"><code>xtrabackup --target-dir</code></a></p><p>–binlog-info</p><p>此选项控制<em>Percona XtraBackup</em>应如何检索与备份对应的服务器二进制日志坐标。可能的值是 <code>OFF</code>，<code>ON</code>，<code>LOCKLESS</code>和<code>AUTO</code>。</p><p>有关 详细信息，请参阅<em>Percona XtraBackup无</em> <a href="https://www.percona.com/doc/percona-xtrabackup/2.4/advanced/lockless_bin-log.html#lockless-bin-log" target="_blank" rel="noopener">锁二进制日志信息</a>手册页。</p><p>–check-privileges</p><p>此选项检查<em>Percona XtraBackup</em>是否具有所有必需的权限。如果当前操作需要缺少权限，它将终止并打印出错误消息。如果当前操作不需要缺少权限，但某些其他XtraBackup操作可能需要该权限，则不会中止该过程并打印警告。<code>xtrabackup：错误：*。*上缺少必需的权限LOCK TABLES xtrabackup：警告：在*。*上缺少必需的权限复制客户端</code></p><p>–close-files</p><p>不要保持文件打开。当<strong>xtrabackup</strong>打开表空间时，它通常不会关闭其文件句柄以正确处理DDL操作。但是，如果表空间的数量非常大并且不能满足任何限制，则可以选择在不再访问文件句柄时关闭它们。<em>Percona XtraBackup</em>可以在启用此选项的情况下生成不一致的备份。使用风险由您自己承担。</p><p>–compact</p><p>通过跳过辅助索引页来创建压缩备份。</p><p>–compress</p><p>此选项告诉<strong>xtrabackup</strong>使用指定的压缩算法压缩所有输出数据，包括事务日志文件和元数据文件。目前唯一支持的算法是<code>quicklz</code>。生成的文件具有qpress存档格式，即<code>*.qp</code>xtrabackup生成的每个文件本质上都是一个文件的qpress存档，可以通过<a href="http://www.quicklz.com/" target="_blank" rel="noopener">qpress</a> 文件存档提取<a href="http://www.quicklz.com/" target="_blank" rel="noopener">和解</a>压缩。</p><p>–compress-chunk-size=#</p><p>压缩线程的工作缓冲区大小（以字节为单位）。默认值为64K。</p><p>–compress-threads=#</p><p>此选项指定<strong>xtrabackup</strong>用于并行数据压缩的工作线程数。此选项默认为<code>1</code>。并行压缩（：选项：<code>xtrabackup -compress-threads</code>）可以与并行文件复制（）一起使用。</p><p>例如， 将创建4个I / O线程，这些线程将读取数据并将其传递给2个压缩线程。<a href="https://www.percona.com/doc/percona-xtrabackup/2.4/xtrabackup_bin/xbk_option_reference.html#cmdoption-xtrabackup-parallel" target="_blank" rel="noopener"><code>xtrabackup --parallel</code></a><code>--parallel=4 --compress --compress-threads=2</code></p><p>–copy-back</p><p>将先前制作的备份中的所有文件从备份目录复制到其原始位置。除非指定了选项，否则此选项不会复制现有文件。<a href="https://www.percona.com/doc/percona-xtrabackup/2.4/xtrabackup_bin/xbk_option_reference.html#cmdoption-xtrabackup-force-non-empty-directories" target="_blank" rel="noopener"><code>xtrabackup --force-non-empty-directories</code></a></p><p>–create-ib-logfile</p><p>此选项目前尚未实施。要创建InnoDB日志文件，您必须准备两次备份。</p><p>–databases=#</p><p>此选项指定应备份的数据库和表的列表。该选项接受表单列表。<code>&quot;databasename1[.table_name1] databasename2[.table_name2] . . .&quot;</code></p><p>–databases-exclude=name</p><p>根据名称排除数据库，操作方式与备份相同，但匹配的名称将从备份中排除。请注意，此选项的优先级高于 。<a href="https://www.percona.com/doc/percona-xtrabackup/2.4/xtrabackup_bin/xbk_option_reference.html#cmdoption-xtrabackup-databases" target="_blank" rel="noopener"><code>xtrabackup --databases</code></a><a href="https://www.percona.com/doc/percona-xtrabackup/2.4/xtrabackup_bin/xbk_option_reference.html#cmdoption-xtrabackup-databases" target="_blank" rel="noopener"><code>xtrabackup --databases</code></a></p><p>–databases-file=#</p><p>此选项指定包含应备份的数据库和表列表的文件的路径。该文件可以包含表单的列表元素，<code>databasename1[.table_name1]</code>每行一个元素。</p><p>–datadir=DIRECTORY</p><p>备份的源目录。这应该与<em>MySQL</em>服务器的datadir相同，因此<code>my.cnf</code>如果存在则应该从中读取; 否则你必须在命令行上指定它。</p><p>–decompress</p><p>使用<code>.qp</code>以前使用该选项进行的备份中的扩展名解压缩所有文件。该 选项将允许同时解密多个文件。为了解压缩，必须在路径中安装和访问qpress实用程序。<em>Percona XtraBackup</em>不会自动删除压缩文件。为了清理备份目录，用户应该使用选项。<a href="https://www.percona.com/doc/percona-xtrabackup/2.4/xtrabackup_bin/xbk_option_reference.html#cmdoption-xtrabackup-compress" target="_blank" rel="noopener"><code>xtrabackup --compress</code></a><a href="https://www.percona.com/doc/percona-xtrabackup/2.4/xtrabackup_bin/xbk_option_reference.html#cmdoption-xtrabackup-parallel" target="_blank" rel="noopener"><code>xtrabackup --parallel</code></a><a href="https://www.percona.com/doc/percona-xtrabackup/2.4/xtrabackup_bin/xbk_option_reference.html#cmdoption-xtrabackup-remove-original" target="_blank" rel="noopener"><code>xtrabackup --remove-original</code></a></p><p>–decrypt=ENCRYPTION-ALGORITHM</p><p><code>.xbcrypt</code>在先前使用选项进行的备份中解密具有扩展名的所有文件。该 选项将允许同时解密多个文件。<em>Percona XtraBackup</em>不会自动删除加密文件。为了清理备份目录，用户应该使用选项。<a href="https://www.percona.com/doc/percona-xtrabackup/2.4/xtrabackup_bin/xbk_option_reference.html#cmdoption-xtrabackup-encrypt" target="_blank" rel="noopener"><code>xtrabackup --encrypt</code></a><a href="https://www.percona.com/doc/percona-xtrabackup/2.4/xtrabackup_bin/xbk_option_reference.html#cmdoption-xtrabackup-parallel" target="_blank" rel="noopener"><code>xtrabackup --parallel</code></a><a href="https://www.percona.com/doc/percona-xtrabackup/2.4/xtrabackup_bin/xbk_option_reference.html#cmdoption-xtrabackup-remove-original" target="_blank" rel="noopener"><code>xtrabackup --remove-original</code></a>`</p><p>–defaults-extra-file=[MY.CNF]</p><p>读取全局文件后读取此文件。必须作为命令行上的第一个选项。</p><p>–defaults-file=[MY.CNF]</p><p>仅读取给定文件中的默认选项。必须作为命令行上的第一个选项。必须是真实的文件; 它不能成为一种象征性的联系。</p><p>–defaults-group=GROUP-NAME</p><p>此选项用于设置应从配置文件中读取的组。如果您使用该选项，<strong>innobackupex</strong>将使用此 选项。部署需要它 。<a href="https://www.percona.com/doc/percona-xtrabackup/2.4/xtrabackup_bin/xbk_option_reference.html#cmdoption-xtrabackup-defaults-group" target="_blank" rel="noopener"><code>xtrabackup --defaults-group</code></a><code>mysqld_multi</code></p><p>–dump-innodb-buffer-pool</p><p>此选项控制是否应该执行缓冲池内容的新转储。使用<code>--dump-innodb-buffer-pool</code>，<strong>xtrabackup</strong> 向服务器发出请求以在<strong>备份</strong>开始时启动缓冲池转储（需要一些时间才能完成并在后台完成），前提是状态变量 <code>innodb_buffer_pool_dump_status</code>报告转储已完成。<code>$ xtrabackup --backup --dump-innodb-buffer-pool --target-dir = / home / user / backup</code>默认情况下，此选项设置为OFF。如果<code>innodb_buffer_pool_dump_status</code>报告存在正在运行的缓冲池转储，则<strong>xtrabackup</strong>将使用值等待转储完成<a href="https://www.percona.com/doc/percona-xtrabackup/2.4/xtrabackup_bin/xbk_option_reference.html#cmdoption-xtrabackup-dump-innodb-buffer-pool-timeout" target="_blank" rel="noopener"><code>--dump-innodb-buffer-pool-timeout</code></a>该文件<code>ib_buffer_pool</code>存储用于更快地预热缓冲池的表空间ID和页面ID数据。也可以看看<em>MySQL</em>文档：保存和恢复缓冲池状态<a href="https://dev.mysql.com/doc/refman/5.7/en/innodb-preload-buffer-pool.html" target="_blank" rel="noopener">https://dev.mysql.com/doc/refman/5.7/en/innodb-preload-buffer-pool.html</a></p><p>–dump-innodb-buffer-pool-timeout</p><p>此选项包含<strong>xtrabackup</strong>应监视其值<code>innodb_buffer_pool_dump_status</code>以确定缓冲池转储是否已完成的秒数。此选项与<a href="https://www.percona.com/doc/percona-xtrabackup/2.4/xtrabackup_bin/xbk_option_reference.html#cmdoption-xtrabackup-dump-innodb-buffer-pool" target="_blank" rel="noopener"><code>--dump-innodb-buffer-pool</code></a>。结合使用 。默认情况下，它设置为10 秒。</p><p>–dump-innodb-buffer-pool-pct</p><p>此选项包含要转储的最近使用的缓冲池页面的百分比。如果<a href="https://www.percona.com/doc/percona-xtrabackup/2.4/xtrabackup_bin/xbk_option_reference.html#cmdoption-xtrabackup-dump-innodb-buffer-pool" target="_blank" rel="noopener"><code>--dump-innodb-buffer-pool</code></a>选项设置为ON，则此选项有效。如果此选项包含值，则<strong>xtrabackup会</strong>设置<em>MySQL</em> 系统变量<code>innodb_buffer_pool_dump_pct</code>。缓冲池转储完成或停止（请参阅 <a href="https://www.percona.com/doc/percona-xtrabackup/2.4/xtrabackup_bin/xbk_option_reference.html#cmdoption-xtrabackup-dump-innodb-buffer-pool-timeout" target="_blank" rel="noopener"><code>--dump-innodb-buffer-pool-timeout</code></a>）后，将恢复<em>MySQL</em>系统变量的值。也可以看看更改缓冲池转储的超时<a href="https://www.percona.com/doc/percona-xtrabackup/2.4/xtrabackup_bin/xbk_option_reference.html#cmdoption-xtrabackup-dump-innodb-buffer-pool-timeout" target="_blank" rel="noopener"><code>--dump-innodb-buffer-pool-timeout</code></a><em>MySQL</em>文档：innodb_buffer_pool_dump_pct系统变量<a href="https://dev.mysql.com/doc/refman/8.0/en/innodb-parameters.html#sysvar_innodb_buffer_pool_dump_pct" target="_blank" rel="noopener">https://dev.mysql.com/doc/refman/8.0/en/innodb-parameters.html#sysvar_innodb_buffer_pool_dump_pct</a></p><p>–encrypt=ENCRYPTION_ALGORITHM</p><p>此选项指示xtrabackup使用ENCRYPTION_ALGORITHM中指定的算法加密InnoDB数据文件的备份副本。它直接传递给xtrabackup子进程。有关更多详细信息，请参阅 <strong>xtrabackup</strong> <a href="https://www.percona.com/doc/percona-xtrabackup/2.4/xtrabackup_bin/xtrabackup_binary.html" target="_blank" rel="noopener">文档</a>。</p><p>–encrypt-key=ENCRYPTION_KEY</p><p>此选项指示xtrabackup <code>ENCRYPTION_KEY</code>在使用该选项时使用给定的。它直接传递给xtrabackup子进程。有关更多详细信息，请参阅<strong>xtrabackup</strong> <a href="https://www.percona.com/doc/percona-xtrabackup/2.4/xtrabackup_bin/xtrabackup_binary.html" target="_blank" rel="noopener">文档</a>。<a href="https://www.percona.com/doc/percona-xtrabackup/2.4/xtrabackup_bin/xbk_option_reference.html#cmdoption-xtrabackup-encrypt" target="_blank" rel="noopener"><code>xtrabackup --encrypt</code></a></p><p>–encrypt-key-file=ENCRYPTION_KEY_FILE</p><p>此选项指示xtrabackup <code>ENCRYPTION_KEY_FILE</code>在使用该 选项时使用存储在给定中的加密密钥。它直接传递给xtrabackup子进程。有关更多详细信息，请参阅 <strong>xtrabackup</strong> <a href="https://www.percona.com/doc/percona-xtrabackup/2.4/xtrabackup_bin/xtrabackup_binary.html" target="_blank" rel="noopener">文档</a>。<a href="https://www.percona.com/doc/percona-xtrabackup/2.4/xtrabackup_bin/xbk_option_reference.html#cmdoption-xtrabackup-encrypt" target="_blank" rel="noopener"><code>xtrabackup --encrypt</code></a></p><p>–encrypt-threads=#</p><p>此选项指定将用于并行加密/解密的工作线程数。有关更多详细信息，请参阅<strong>xtrabackup</strong> <a href="https://www.percona.com/doc/percona-xtrabackup/2.4/xtrabackup_bin/xtrabackup_binary.html" target="_blank" rel="noopener">文档</a>。</p><p>–encrypt-chunk-size=#</p><p>此选项指定每个加密线程的内部工作缓冲区的大小（以字节为单位）。它直接传递给xtrabackup子进程。有关更多详细信息，请参阅<strong>xtrabackup</strong> <a href="https://www.percona.com/doc/percona-xtrabackup/2.4/xtrabackup_bin/xtrabackup_binary.html" target="_blank" rel="noopener">文档</a>。</p><p>–export</p><p>创建导出表所需的文件。请参阅<a href="https://www.percona.com/doc/percona-xtrabackup/2.4/xtrabackup_bin/restoring_individual_tables.html" target="_blank" rel="noopener">恢复单个表</a>。</p><p>–extra-lsndir=DIRECTORY</p><p>（for -backup）：在此目录中保存<code>xtrabackup_checkpoints</code> 和<code>xtrabackup_info</code>文件的额外副本。</p><p>–force-non-empty-directories</p><p>如果指定，它会：选项<code>xtrabackup -copy-back</code>和 选项将文件传输到非空目录。不会覆盖现有文件。如果需要从备份目录中复制/移动的文件已存在于目标目录中，则它仍将失败并显示错误。<a href="https://www.percona.com/doc/percona-xtrabackup/2.4/xtrabackup_bin/xbk_option_reference.html#cmdoption-xtrabackup-move-back" target="_blank" rel="noopener"><code>xtrabackup --move-back</code></a></p><p>–ftwrl-wait-timeout=SECONDS</p><p>此选项指定xtrabackup应等待在运行之前阻塞的查询的时间（以秒为单位）。如果超时到期时仍有此类查询，则xtrabackup将终止并显示错误。默认是，在这种情况下，它不会等待查询完成并 立即启动。如果支持（Percona Server 5.6+），则xtrabackup将自动使用<a href="https://www.percona.com/doc/percona-server/5.6/management/backup_locks.html#backup-locks" target="_blank" rel="noopener">备份锁</a> 作为复制非InnoDB数据的轻量级替代方法，以避免阻止修改InnoDB表的DML查询。<code>FLUSH TABLES WITH READ LOCK``0``FLUSH TABLESWITH READ LOCK``FLUSH TABLES WITH READ LOCK</code></p><p>–ftwrl-wait-threshold=SECONDS</p><p>此选项指定查询运行时阈值，该阈值由xtrabackup用于检测具有非零值的长时间运行的查询 。 在存在长时间运行的查询之前不会启动。如果是，则此选项无效。默认值为秒。如果支持（Percona Server 5.6+），则xtrabackup将自动使用<a href="https://www.percona.com/doc/percona-server/5.6/management/backup_locks.html#backup-locks" target="_blank" rel="noopener">备份锁</a> 作为复制非InnoDB数据的轻量级替代方法，以避免阻止修改InnoDB表的DML查询。<a href="https://www.percona.com/doc/percona-xtrabackup/2.4/xtrabackup_bin/xbk_option_reference.html#cmdoption-xtrabackup-ftwrl-wait-timeout" target="_blank" rel="noopener"><code>xtrabackup --ftwrl-wait-timeout</code></a><code>FLUSH TABLES WITH READLOCK</code><a href="https://www.percona.com/doc/percona-xtrabackup/2.4/xtrabackup_bin/xbk_option_reference.html#cmdoption-xtrabackup-ftwrl-wait-timeout" target="_blank" rel="noopener"><code>xtrabackup --ftwrl-wait-timeout</code></a><code>0``60``FLUSH TABLES WITH READ LOCK</code></p><p>–ftwrl-wait-query-type=all|update</p><p>此选项指定在xtrabackup发出全局锁之前允许完成哪些类型的查询。默认是<code>all</code>。</p><p>–galera-info</p><p>此选项创建<code>xtrabackup_galera_info</code>包含备份时本地节点状态的文件。在执行<em>Percona XtraDB Cluster</em>的备份时应使用选项。使用备份锁创建备份时，它不起作用。</p><p>–incremental-basedir=DIRECTORY</p><p>创建增量备份时，这是包含完整备份的目录，该备份是增量备份的基础数据集。</p><p>–incremental-dir=DIRECTORY</p><p>准备增量备份时，这是增量备份与完整备份组合的目录，以进行新的完整备份。</p><p>–incremental-force-scan</p><p>创建增量备份时，即使完整更改的页面位图数据可用，也强制对正在备份的实例中的数据页进行完全扫描。</p><p>–incremental-lsn=LSN</p><p>创建增量备份时，可以指定日志序列号（<a href="https://www.percona.com/doc/percona-xtrabackup/2.4/glossary.html#term-lsn" target="_blank" rel="noopener">LSN</a>）而不是指定 。对于在5.1及更高版本中创建的数据库，请将<a href="https://www.percona.com/doc/percona-xtrabackup/2.4/glossary.html#term-lsn" target="_blank" rel="noopener">LSN</a>指定为单个64位整数。<strong>注意</strong>：如果指定了错误的LSN值（<em>Percona XtraBackup</em>无法检测到的用户错误），则备份将无法使用。小心！<a href="https://www.percona.com/doc/percona-xtrabackup/2.4/xtrabackup_bin/xbk_option_reference.html#cmdoption-xtrabackup-incremental-basedir" target="_blank" rel="noopener"><code>xtrabackup --incremental-basedir</code></a></p><p>–innodb-log-arch-dir=DIRECTORY</p><p>此选项用于指定包含存档日志的目录。它只能与选项一起使用。<a href="https://www.percona.com/doc/percona-xtrabackup/2.4/xtrabackup_bin/xbk_option_reference.html#cmdoption-xtrabackup-prepare" target="_blank" rel="noopener"><code>xtrabackup --prepare</code></a></p><p>–innodb-miscellaneous</p><p>有一大组InnoDB选项通常从<code>my.cnf</code>配置文件中读取 ，因此<strong>xtrabackup</strong>以与当前服务器相同的配置启动其嵌入式InnoDB。您通常不需要明确指定这些。这些选项与InnoDB或XtraDB中的选项具有相同的行为。</p><p>它们如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">-innodb-adaptive-hash-index </span><br><span class="line">-innodb-additional-mem-pool-size  </span><br><span class="line">-innodb-autoextend-increment </span><br><span class="line">-innodb-buffer-pool-size  </span><br><span class="line">-innodb-checksums  </span><br><span class="line">-innodb-data-file-path</span><br><span class="line">-innodb-数据-主页-目录</span><br><span class="line">-innodb-doublewrite-file</span><br><span class="line">-innodb-doublewrite</span><br><span class="line">-innodb-extra-undoslots</span><br><span class="line">-innodb-fast-checksum</span><br><span class="line">-innodb-file-io-threads</span><br><span class="line">-innodb-file-per-table</span><br><span class="line">-innodb-flush-log-at-trx-commit</span><br><span class="line">-innodb-flush-method</span><br><span class="line">-innodb-force-recovery</span><br><span class="line">-innodb-io-capacity</span><br><span class="line">-innodb-lock-wait-timeout</span><br><span class="line">-innodb-log-buffer-size</span><br><span class="line">-innodb-log- files-in-group</span><br><span class="line">-innodb-日志-文件-大小</span><br><span class="line">-innodb-log-group-home-dir</span><br><span class="line">-innodb-max-dirty-pages- pct</span><br><span class="line">-innodb-open-files</span><br><span class="line">-innodb-page-size</span><br><span class="line">-innodb-read-io-threads</span><br><span class="line">-innodb-write-io-threads</span><br></pre></td></tr></table></figure><p>–keyring-file-data=FILENAME</p><p>密钥环文件的路径。</p><p>–lock-ddl</p><p>如果备份开始时服务器支持阻止所有DDL操作，则发出问题。<code>LOCK TABLES FOR BACKUP</code></p><p>–lock-ddl-per-table</p><p>在xtrabackup开始复制之前锁定每个表的DDL，直到备份完成。</p><p>–lock-ddl-timeout</p><p>如果在给定的超时内没有返回，则中止备份。<code>LOCK TABLES FOR BACKUP</code></p><p>–log-copy-interval=#</p><p>此选项指定日志复制线程执行的检查之间的时间间隔（以毫秒为单位）（默认值为1秒）。</p><p>–move-back</p><p>将先前制作的备份中的所有文件从备份目录移动到其原始位置。由于此选项会删除备份文件，因此必须谨慎使用。</p><p>–no-defaults</p><p>不要从任何选项文件中读取默认选项。必须作为命令行上的第一个选项。</p><p>–no-version-check</p><p>此选项禁用版本检查。如果未通过此选项，则在模式下运行<strong>xtrabackup</strong>时<strong>会</strong>隐式启用自动版本检查<code>--backup</code>。要禁用版本检查，应<code>--no-version-check</code>在envoking <strong>xtrabackup</strong>时显式传递该选项。启用自动版本检查后，<strong>xtrabackup</strong>会在创建服务器连接后对备份阶段的服务器执行版本检查。<strong>xtrabackup</strong>将以下信息发送到服务器：MySQL的味道和版本操作系统名称Percona Toolkit版本Perl版本每条信息都有唯一的标识符。这是一个MD5哈希值，Percona Toolkit用它来获取有关如何使用它的统计信息。这是一个随机的UUID; 没有收集或存储客户信息。</p><p>–parallel=#</p><p>此选项指定在创建备份时用于同时复制多个数据文件的线程数。默认值为1（即没有并发传输）。在<em>Percona XtraBackup</em> 2.3.10及更高版本中，此选项可与选项一起使用以并行复制用户数据文件（重做日志和系统表空间在主线程中复制）。<a href="https://www.percona.com/doc/percona-xtrabackup/2.4/xtrabackup_bin/xbk_option_reference.html#cmdoption-xtrabackup-copy-back" target="_blank" rel="noopener"><code>xtrabackup --copy-back</code></a></p><p>–password=PASSWORD</p><p>此选项指定连接到数据库时要使用的密码。它接受一个字符串参数。有关详细信息，请参阅mysql -help。</p><p>–prepare</p><p>使<strong>xtrabackup</strong>对使用创建的备份执行恢复 ，以便可以使用它。请参阅 <a href="https://www.percona.com/doc/percona-xtrabackup/2.4/backup_scenarios/full_backup.html#preparing-a-backup" target="_blank" rel="noopener">准备备份</a>。<a href="https://www.percona.com/doc/percona-xtrabackup/2.4/xtrabackup_bin/xbk_option_reference.html#cmdoption-xtrabackup-backup" target="_blank" rel="noopener"><code>xtrabackup --backup</code></a></p><p>–print-defaults</p><p>打印程序参数列表并退出。必须作为命令行上的第一个选项。</p><p>–print-param</p><p>使<strong>xtrabackup</strong>打印出可用于将数据文件复制回原始位置以恢复它们的参数。请参阅 <a href="https://www.percona.com/doc/percona-xtrabackup/2.4/xtrabackup_bin/scripting_backups_xbk.html#scripting-xtrabackup" target="_blank" rel="noopener">使用xtrabackup编写备份脚本</a>。</p><p>–reencrypt-for-server-id=<new_server_id></new_server_id></p><p>使用此选项可以使用与从中获取加密备份的server_id不同的server_id启动服务器实例，例如复制从属节点或galera节点。使用此选项时，作为准备步骤，xtrabackup将根据新的server_id生成具有ID的新主密钥，将其存储到密钥环文件中并重新加密表空间标头内的表空间密钥。选项应该通过<a href="https://www.percona.com/doc/percona-xtrabackup/2.4/xtrabackup_bin/xbk_option_reference.html#cmdoption-xtrabackup-prepare" target="_blank" rel="noopener"><code>--prepare</code></a>（最后一步）。</p><p>–remove-original</p><p>在<em>Percona XtraBackup</em> 2.4.6中实现，指定时将删除此选项<code>.qp</code>，<code>.xbcrypt</code>并<code>.qp.xbcrypt</code>在解密和解压缩后删除文件。</p><p>–safe-slave-backup</p><p>指定后，xtrabackup将在运行之前停止从属SQL线程，并等待启动备份直到 in 为零。如果没有打开的临时表，则会进行备份，否则将启动并停止SQL线程，直到没有打开的临时表为止。如果在几秒钟后没有变为零， 则备份将失败。备份完成后，将重新启动从属SQL线程。实现此选项是为了处理<a href="https://dev.mysql.com/doc/refman/5.7/en/replication-features-temptables.html" target="_blank" rel="noopener">复制临时表</a> ，而不是基于行的复制。<code>FLUSH TABLES WITH READ LOCK``Slave_open_temp_tables``SHOWSTATUS``Slave_open_temp_tables</code><a href="https://www.percona.com/doc/percona-xtrabackup/2.4/xtrabackup_bin/xbk_option_reference.html#cmdoption-xtrabackup-safe-slave-backup-timeout" target="_blank" rel="noopener"><code>xtrabackup --safe-slave-backup-timeout</code></a></p><p>–safe-slave-backup-timeout=SECONDS</p><p>应该等待 多少秒才能变为零。默认为300秒。<a href="https://www.percona.com/doc/percona-xtrabackup/2.4/xtrabackup_bin/xbk_option_reference.html#cmdoption-xtrabackup-safe-slave-backup" target="_blank" rel="noopener"><code>xtrabackup --safe-slave-backup</code></a><code>Slave_open_temp_tables</code></p><p>–secure-auth</p><p>如果客户端使用旧的（4.1.1之前的）协议，则拒绝客户端连接到服务器。（默认情况下启用;使用-skip-secure-auth禁用。）</p><p>–server-id=#</p><p>正在备份的服务器实例。</p><p>–slave-info</p><p>备份复制从属服务器时，此选项很有用。它打印主服务器的二进制日志位置。它还将此信息<code>xtrabackup_slave_info</code>作为 命令写入文件。可以通过在此备份上启动从属服务器并发出保存在文件中的二进制日志位置的命令来设置此主站的新从站。<code>CHANGE MASTER``CHANGEMASTER``xtrabackup_slave_info</code></p><p>–ssl</p><p> 启用安全连接。更多信息可以在<a href="https://dev.mysql.com/doc/refman/5.7/en/secure-connection-options.html#option_general_ssl" target="_blank" rel="noopener">-ssl</a> MySQL服务器文档中找到。</p><p>–ssl-ca</p><p>包含受信任SSL CA列表的文件路径。更多信息可以在<a href="https://dev.mysql.com/doc/refman/5.7/en/secure-connection-options.html#option_general_ssl-ca" target="_blank" rel="noopener">-ssl-ca</a> MySQL服务器文档中找到。</p><p>–ssl-capath</p><p>包含PEM格式的受信任SSL CA证书的目录路径。更多信息可以在<a href="https://dev.mysql.com/doc/refman/5.7/en/secure-connection-options.html#option_general_ssl-capath" target="_blank" rel="noopener">-ssl-capath</a> MySQL服务器文档中找到。</p><p>–ssl-cert</p><p>包含PEM格式的X509证书的文件的路径。更多信息可以在<a href="https://dev.mysql.com/doc/refman/5.7/en/secure-connection-options.html#option_general_ssl-cert" target="_blank" rel="noopener">-ssl-cert</a> MySQL服务器文档中找到。</p><p>–ssl-cipher</p><p>用于连接加密的允许密码列表。更多信息可以在<a href="https://dev.mysql.com/doc/refman/5.7/en/secure-connection-options.html#option_general_ssl-cipher" target="_blank" rel="noopener">-ssl-cipher</a> MySQL服务器文档中找到。</p><p>–ssl-crl</p><p>包含证书吊销列表的文件的路径。更多信息可以在<a href="https://dev.mysql.com/doc/refman/5.7/en/secure-connection-options.html#option_general_ssl-crl" target="_blank" rel="noopener">-ssl-crl</a> MySQL服务器文档中找到。</p><p>–ssl-crlpath</p><p> 包含证书吊销列表文件的目录路径。更多信息可以在<a href="https://dev.mysql.com/doc/refman/5.7/en/secure-connection-options.html#option_general_ssl-crlpath" target="_blank" rel="noopener">-ssl-crlpath</a> MySQL服务器文档中找到。</p><p>–ssl-key</p><p>包含PEM格式的X509密钥的文件路径。更多信息可以在<a href="https://dev.mysql.com/doc/refman/5.7/en/secure-connection-options.html#option_general_ssl-key" target="_blank" rel="noopener">-ssl-key</a> MySQL服务器文档中找到。</p><p>–ssl-mode</p><p>与服务器连接的安全状态。更多信息可以在 <a href="https://dev.mysql.com/doc/refman/5.7/en/secure-connection-options.html#option_general_ssl-mode" target="_blank" rel="noopener">-ssl-mode</a> MySQL服务器文档中找到。</p><p>–ssl-verify-server-cert</p><p>验证服务器证书Common Name值与连接到服务器时使用的主机名。更多信息可以在 <a href="https://dev.mysql.com/doc/refman/5.6/en/secure-connection-options.html#option_general_ssl-verify-server-cert" target="_blank" rel="noopener">-ssl-verify-server-cert</a> MySQL服务器文档中找到。</p><p>–stats</p><p>使<strong>xtrabackup</strong>扫描指定的数据文件并打印出索引统计信息。</p><p>–stream=name</p><p>将所有备份文件以指定格式流式传输到标准输出。目前支持的格式是<code>xbstream</code>和<code>tar</code>。</p><p>–tables=name</p><p>正则表达式，与<code>databasename.tablename</code>格式的完整表名 匹配。如果名称匹配，则备份表。查看<a href="https://www.percona.com/doc/percona-xtrabackup/2.4/xtrabackup_bin/partial_backups.html" target="_blank" rel="noopener">部分备份</a>。</p><p>–tables-exclude=name</p><p>通过regexp过滤表名。操作方式与备份相同，但匹配的名称不在备份中。请注意，此选项的优先级高于 。<a href="https://www.percona.com/doc/percona-xtrabackup/2.4/xtrabackup_bin/xbk_option_reference.html#cmdoption-xtrabackup-tables" target="_blank" rel="noopener"><code>xtrabackup --tables</code></a><a href="https://www.percona.com/doc/percona-xtrabackup/2.4/xtrabackup_bin/xbk_option_reference.html#cmdoption-xtrabackup-tables" target="_blank" rel="noopener"><code>xtrabackup --tables</code></a></p><p>–tables-file=name</p><p>每行包含一个表名的文件，格式为databasename.tablename。备份将仅限于指定的表。请参阅 <a href="https://www.percona.com/doc/percona-xtrabackup/2.4/xtrabackup_bin/scripting_backups_xbk.html#scripting-xtrabackup" target="_blank" rel="noopener">使用xtrabackup编写备份脚本</a>。</p><p>–target-dir=DIRECTORY</p><p>此选项指定备份的目标目录。如果目录不存在，则<strong>xtrabackup</strong>会创建它。如果该目录确实存在且为空，则<strong>xtrabackup</strong>将成功。 但是，<strong>xtrabackup</strong>不会覆盖现有文件; 它将因操作系统错误17而失败。<code>file exists</code>如果此选项是相对路径，则将其解释为相对于执行<strong>xtrabackup</strong>的当前工作目录。</p><p>–throttle=#</p><p>此选项限制每秒复制的块数。块大小为 <em>10 MB</em>。要将带宽限制为<em>10 MB / s</em>，请将选项设置为<em>1</em>： -throttle = 1。也可以看看有关如何限制备份的详细信息<a href="https://www.percona.com/doc/percona-xtrabackup/2.4/advanced/throttling_backups.html#throttling-backups" target="_blank" rel="noopener">限制备份</a></p><p>–tmpdir=name</p><p>除了在使用时打印出正确的tmpdir参数，此选项当前不用于任何内容。<a href="https://www.percona.com/doc/percona-xtrabackup/2.4/xtrabackup_bin/xbk_option_reference.html#cmdoption-xtrabackup-print-param" target="_blank" rel="noopener"><code>xtrabackup --print-param</code></a></p><p>–to-archived-lsn=LSN</p><p>此选项用于指定在准备备份时应将日志应用到的LSN。它只能与选项一起使用 。<a href="https://www.percona.com/doc/percona-xtrabackup/2.4/xtrabackup_bin/xbk_option_reference.html#cmdoption-xtrabackup-prepare" target="_blank" rel="noopener"><code>xtrabackup --prepare</code></a></p><p>–transition-key</p><p>此选项用于在不访问密钥环保管库服务器的情况下启用备份处理。在这种情况下，<strong>xtrabackup</strong>从指定的密码短语中派生AES加密密钥，并使用它来加密正在备份的表空间的表空间密钥。如果<a href="https://www.percona.com/doc/percona-xtrabackup/2.4/xtrabackup_bin/xbk_option_reference.html#cmdoption-xtrabackup-transition-key" target="_blank" rel="noopener"><code>--transition-key</code></a>没有任何价值，<strong>xtrabackup</strong>会要求它。应为该命令指定相同的密码。<a href="https://www.percona.com/doc/percona-xtrabackup/2.4/xtrabackup_bin/xbk_option_reference.html#cmdoption-xtrabackup-prepare" target="_blank" rel="noopener"><code>xtrabackup --prepare</code></a></p><p>–use-memory=#</p><p>此选项会影响为备份或使用分析统计分配的内存 量 。其目的与<a href="https://www.percona.com/doc/percona-xtrabackup/2.4/glossary.html#term-innodb-buffer-pool-size" target="_blank" rel="noopener">innodb_buffer_pool_size</a>类似。它与Oracle的InnoDB热备份工具中的类似命名选项不同。默认值为100MB，如果您有足够的可用内存，1GB到2GB是一个很好的推荐值。提供单元支持倍数（例如1MB，1M，1GB，1G）。<a href="https://www.percona.com/doc/percona-xtrabackup/2.4/xtrabackup_bin/xbk_option_reference.html#cmdoption-xtrabackup-prepare" target="_blank" rel="noopener"><code>xtrabackup --prepare</code></a><a href="https://www.percona.com/doc/percona-xtrabackup/2.4/xtrabackup_bin/xbk_option_reference.html#cmdoption-xtrabackup-stats" target="_blank" rel="noopener"><code>xtrabackup --stats</code></a></p><p>–user=USERNAME</p><p>此选项指定连接到服务器时使用的MySQL用户名（如果不是当前用户）。该选项接受字符串参数。有关详细信息，请参阅mysql -help。</p><p>–version</p><p>此选项打印<strong>xtrabackup</strong>版本并退出</p><p><strong>xtrabackup用法</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">备份：innobackupex [option] BACKUP-ROOT-DIR</span><br><span class="line">选项说明：</span><br><span class="line">--user：该选项表示备份账号</span><br><span class="line">--password：该选项表示备份的密码</span><br><span class="line">--host：该选项表示备份数据库的地址</span><br><span class="line">--databases：该选项接受的参数为数据名，如果要指定多个数据库，彼此间需要以空格隔开；如：&quot;xtra_test dba_test&quot;，同时，在指定某数据库时，也可以只指定其中的某张表。如：&quot;mydatabase.mytable&quot;。该选项对innodb引擎表无效，还是会备份所有innodb表</span><br><span class="line">--defaults-file：该选项指定了从哪个文件读取MySQL配置，必须放在命令行第一个选项的位置</span><br><span class="line">--incremental：该选项表示创建一个增量备份，需要指定--incremental-</span><br><span class="line">basedir</span><br><span class="line">--incremental-basedir：该选项表示接受了一个字符串参数指定含有full backup的目录为增量备份的base目录，与--incremental同时使用</span><br><span class="line">--incremental-dir：该选项表示增量备份的目录</span><br><span class="line">--include=name：指定表名，格式：databasename.tablename</span><br><span class="line">Prepare：innobackupex --apply-log [option] BACKUP-DIR</span><br><span class="line">选项说明：</span><br><span class="line">--apply-log：一般情况下,在备份完成后，数据尚且不能用于恢复操作，因为备份的数据中可能会包含尚未提交的事务或已经提交但尚未同步至数据文件中的事务。因此，此时数据文件仍处理不一致状态。此选项作用是通过回滚未提交的事务及同步已经提交的事务至数据文件使数据文件处于一致性状态</span><br><span class="line">--use-memory：该选项表示和--apply-log选项一起使用，prepare 备份的时候，xtrabackup做crash recovery分配的内存大小，单位字节。也可(1MB,1M,1G,1GB)，推荐1G</span><br><span class="line">--defaults-file：该选项指定了从哪个文件读取MySQL配置，必须放在命令行第一个选项的位置</span><br><span class="line">-export：表示开启可导出单独的表之后再导入其他Mysql中</span><br><span class="line">--redo-only：这个选项在prepare base full backup，往其中merge增量备份时候使用</span><br><span class="line">还原：innobackupex --copy-back [选项] BACKUP-DIR</span><br><span class="line">innobackupex --move-back [选项] [--defaults-group=GROUP-NAME] BACKUP-DIR</span><br><span class="line">选项说明：</span><br><span class="line">--copy-back：做数据恢复时将备份数据文件拷贝到MySQL服务器的datadir</span><br><span class="line">--move-back：这个选项与--copy-back相似，唯一的区别是它不拷贝文件，而是移动文件到目的地。这个选项移除backup文件，用时候必须小心。使用场景：没有足够的磁盘空间同事保留数据文件和Backup副本</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">cat xtrabackup.sh</span><br><span class="line">#!/bin/bash</span><br><span class="line">[ -d /root/increment/ ] || mkdir -p /root/increment/</span><br><span class="line">mysql_path=/opt/data</span><br><span class="line">mysql_increment_path=/root/increment/</span><br><span class="line">#mysql全备</span><br><span class="line">mysql_backup() &#123;</span><br><span class="line">innobackupex --defaults-file=/etc/my.cnf --user=root --password=&apos;jbgsn123!&apos; --backup $mysql_path/mysql-`date +%Y%m%d`/  --no-timestamp</span><br><span class="line">exit 0</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#恢复</span><br><span class="line">mysql_recovery() &#123;</span><br><span class="line">systemctl stop mysqld</span><br><span class="line">mv /var/lib/mysql  /var/lib/mysql2</span><br><span class="line">innobackupex --apply-log $mysql_path/mysql-`date +%Y%m%d`/</span><br><span class="line">innobackupex --defaults-file=/etc/my.cnf --copy-back $mysql_path/mysql-`date +%Y%m%d`/</span><br><span class="line">chown -R mysql.mysql /var/lib/mysql</span><br><span class="line">systemctl start mysqld</span><br><span class="line">exit 0</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#增量备份</span><br><span class="line">mysql_increment() &#123;</span><br><span class="line">innobackupex --defaults-file=/etc/my.cnf --user=root --password=&apos;jbgsn123!&apos; --incremental $mysql_increment_path/mysql-`date +%Y%m%d`/ --incremental-basedir=$mysql_path/mysql-`date +%Y%m%d`/ --no-timestamp</span><br><span class="line">exit 0</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#增量恢复</span><br><span class="line">mysql_increment_recovery() &#123;</span><br><span class="line">innobackupex --apply-log --redo-only $mysql_path/mysql-`date +%Y%m%d`/</span><br><span class="line">innobackupex --apply-log --redo-only $mysql_path/mysql-`date +%Y%m%d`/  --incremental-dir=$mysql_path/mysql-`date +%Y%m%d`/</span><br><span class="line">systemctl stop mysqld</span><br><span class="line">mv /var/lib/mysql  /var/lib/mysql2</span><br><span class="line">innobackupex --defaults-file=/etc/my.cnf --copy-back $mysql_path/mysql-`date +%Y%m%d`/</span><br><span class="line">chown -R mysql.mysql /var/lib/mysql</span><br><span class="line">systemctl start mysqld</span><br><span class="line">exit 0</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">man() &#123;</span><br><span class="line">mysql_backup</span><br><span class="line">#mysql_recovery</span><br><span class="line">mysql_increment</span><br><span class="line">#mysql_increment_recovery</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">man</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;a id=&quot;more&quot;&gt;&lt;/a&gt;

&lt;h2 id=&quot;xtrabackup的安装-centos-rhel系列&quot;&gt;&lt;a href=&quot;#xtrabackup的安装-centos-rhel系列&quot; class=&quot;headerlink&quot; title=&quot;xtrabackup的安装(cento
      
    
    </summary>
    
      <category term="Linux运维" scheme="http://aiwhs.github.io/categories/Linux%E8%BF%90%E7%BB%B4/"/>
    
    
      <category term="sql" scheme="http://aiwhs.github.io/tags/sql/"/>
    
  </entry>
  
  <entry>
    <title>MySQL进阶</title>
    <link href="http://aiwhs.github.io/2018/11/25/MySQL2/"/>
    <id>http://aiwhs.github.io/2018/11/25/MySQL2/</id>
    <published>2018-11-25T00:15:57.000Z</published>
    <updated>2019-07-10T06:42:08.319Z</updated>
    
    <content type="html"><![CDATA[<a id="more"></a><h1 id="1-二进制格式mysql安装"><a href="#1-二进制格式mysql安装" class="headerlink" title="1. 二进制格式mysql安装"></a>1. 二进制格式mysql安装</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br></pre></td><td class="code"><pre><span class="line">下载二进制格式的mysql软件包</span><br><span class="line">[root@wenhs5479 ~]# wget https://downloads.mysql.com/archives/get/file/mysql-5.7.25-linux-glibc2.12-x86_64.tar</span><br><span class="line"></span><br><span class="line">创建用户和组</span><br><span class="line">[root@wenhs5479 ~]# groupadd -r mysql</span><br><span class="line">[root@wenhs5479 ~]# useradd -M -s /sbin/nologin -g mysql mysql</span><br><span class="line"></span><br><span class="line">解压软件至/usr/local/</span><br><span class="line">[root@wenhs5479 ~]# tar xf mysql-5.7.25-linux-glibc2.12-x86_64.tar -C /usr/local/</span><br><span class="line">[root@wenhs5479 ~]# ls /usr/local/</span><br><span class="line">apache    games    mysql-5.7.25-linux-glibc2.12-x86_64.tar.gz</span><br><span class="line">apr       include  mysql-test-5.7.25-linux-glibc2.12-x86_64.tar.gz</span><br><span class="line">apr-util  lib      sbin</span><br><span class="line">bin       lib64    share</span><br><span class="line">etc       libexec  src</span><br><span class="line">[root@wenhs5479 ~]# tar xf /usr/local/mysql-5.7.25-linux-glibc2.12-x86_64.tar.gz -C /usr/local/</span><br><span class="line">[root@wenhs5479 ~]# ls /usr/local/</span><br><span class="line">apache    lib64</span><br><span class="line">apr       libexec</span><br><span class="line">apr-util  mysql-5.7.25-linux-glibc2.12-x86_64</span><br><span class="line">bin       mysql-5.7.25-linux-glibc2.12-x86_64.tar.gz</span><br><span class="line">etc       mysql-test-5.7.25-linux-glibc2.12-x86_64.tar.gz</span><br><span class="line">games     sbin</span><br><span class="line">include   share</span><br><span class="line">lib       src</span><br><span class="line">[root@wenhs5479 ~]# cd /usr/local/</span><br><span class="line">[root@wenhs5479 local]# ln -sv mysql-5.7.25-linux-glibc2.12-x86_64/ mysql</span><br><span class="line">&quot;mysql&quot; -&gt; &quot;mysql-5.7.25-linux-glibc2.12-x86_64/&quot;</span><br><span class="line">[root@wenhs5479 local]# ll</span><br><span class="line">总用量 658620</span><br><span class="line">drwxr-xr-x. 13 root root        152 4月  29 09:08 apache</span><br><span class="line">drwxr-xr-x.  6 root root         58 4月  29 09:06 apr</span><br><span class="line">drwxr-xr-x.  5 root root         43 4月  29 09:07 apr-util</span><br><span class="line">drwxr-xr-x.  2 root root          6 4月  11 2018 bin</span><br><span class="line">drwxr-xr-x.  2 root root          6 4月  11 2018 etc</span><br><span class="line">drwxr-xr-x.  2 root root          6 4月  11 2018 games</span><br><span class="line">drwxr-xr-x.  2 root root          6 4月  11 2018 include</span><br><span class="line">drwxr-xr-x.  2 root root          6 4月  11 2018 lib</span><br><span class="line">drwxr-xr-x.  2 root root          6 4月  11 2018 lib64</span><br><span class="line">drwxr-xr-x.  2 root root          6 4月  11 2018 libexec</span><br><span class="line">lrwxrwxrwx.  1 root root         36 4月  29 11:59 mysql -&gt; mysql-5.7.25-linux-glibc2.12-x86_64/</span><br><span class="line">drwxr-xr-x.  9 root root        129 4月  29 11:58 mysql-5.7.25-linux-glibc2.12-x86_64</span><br><span class="line">-rw-r--r--.  1 7161 31415 644862820 12月 21 19:23 mysql-5.7.25-linux-glibc2.12-x86_64.tar.gz</span><br><span class="line">-rw-r--r--.  1 7161 31415  29556980 12月 21 19:21 mysql-test-5.7.25-linux-glibc2.12-x86_64.tar.gz</span><br><span class="line">drwxr-xr-x.  2 root root          6 4月  11 2018 sbin</span><br><span class="line">drwxr-xr-x.  5 root root         49 3月   6 20:35 share</span><br><span class="line">drwxr-xr-x.  5 root root        145 4月  29 09:06 src</span><br><span class="line"></span><br><span class="line">修改目录/usr/local/mysql的属主属组</span><br><span class="line">[root@wenhs5479 ~]# chown -R mysql.mysql /usr/local/mysql</span><br><span class="line">[root@wenhs5479 ~]# ll /usr/local/mysql -d</span><br><span class="line">lrwxrwxrwx. 1 mysql mysql 36 4月  29 11:59 /usr/local/mysql -&gt; mysql-5.7.25-linux-glibc2.12-x86_64/</span><br><span class="line"></span><br><span class="line">添加环境变量</span><br><span class="line">[root@wenhs5479 ~]# ls /usr/local/mysql</span><br><span class="line">bin  COPYING  docs  include  lib  man  README  share  support-files</span><br><span class="line">[root@wenhs5479 ~]# echo &apos;export PATH=/usr/local/mysql/bin:$PATH&apos; &gt; /etc/profile.d/mysql.sh </span><br><span class="line">[root@wenhs5479 ~]# source /etc/profile.d/mysql.sh </span><br><span class="line">[root@wenhs5479 ~]# echo $PATH</span><br><span class="line">/usr/local/mysql/bin:/usr/local/apache/bin:/usr/lib64/qt-3.3/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/root/bin:/root/bin</span><br><span class="line"></span><br><span class="line">建立数据存放目录</span><br><span class="line">[root@wenhs5479 ~]# mkdir /opt/data</span><br><span class="line">[root@wenhs5479 ~]# chown -R mysql.mysql /opt/data/</span><br><span class="line">[root@wenhs5479 ~]# ll /opt/</span><br><span class="line">总用量 0</span><br><span class="line">drwxr-xr-x. 2 mysql mysql 6 4月  29 12:07 data</span><br><span class="line">drwxr-xr-x. 2 root  root  6 10月 31 03:17 rh</span><br><span class="line"></span><br><span class="line">初始化数据库</span><br><span class="line">[root@wenhs5479 ~]# /usr/local/mysql/bin/mysqld --initialize --user=mysql --datadir=/opt/data/</span><br><span class="line">2019-04-29T04:25:29.411729Z 0 [Warning] TIMESTAMP with implicit DEFAULT value is deprecated. Please use --explicit_defaults_for_timestamp server option (see documentation for more details).</span><br><span class="line">2019-04-29T04:25:29.801636Z 0 [Warning] InnoDB: New log files created, LSN=45790</span><br><span class="line">2019-04-29T04:25:29.881540Z 0 [Warning] InnoDB: Creating foreign key constraint system tables.</span><br><span class="line">2019-04-29T04:25:29.952437Z 0 [Warning] No existing UUID has been found, so we assume that this is the first time that this server has been started. Generating a new UUID: d23d56a4-6a36-11e9-af12-000c298a2a2e.</span><br><span class="line">2019-04-29T04:25:29.953823Z 0 [Warning] Gtid table is not ready to be used. Table &apos;mysql.gtid_executed&apos; cannot be opened.</span><br><span class="line">2019-04-29T04:25:29.955744Z 1 [Note] A temporary password is generated for root@localhost: gQBy9Sq(dr&gt;h</span><br><span class="line">请注意，这个命令的最后会生成一个临时密码，此处密码是gQBy9Sq(dr&gt;h</span><br><span class="line">再次注意，这个密码是随机的，你的不会跟我一样，一定要记住这个密码，因为一会登录时会用到</span><br><span class="line"></span><br><span class="line">生成配置文件</span><br><span class="line">[root@wenhs5479 ~]# cat &gt;/etc/my.cnf &lt;&lt;EOF</span><br><span class="line">&gt; [mysqld]</span><br><span class="line">&gt; basedir = /usr/local/mysql</span><br><span class="line">&gt; datadir = /opt/data</span><br><span class="line">&gt; socket = /tmp/mysql.sock</span><br><span class="line">&gt; port = 3306</span><br><span class="line">&gt; pid-file = /opt/data/mysql.pid</span><br><span class="line">&gt; user = mysql</span><br><span class="line">&gt; skip-name-resolve</span><br><span class="line">&gt; EOF</span><br><span class="line">&gt; </span><br><span class="line">[root@wenhs5479 ~]# cat /etc/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">basedir = /usr/local/mysql</span><br><span class="line">datadir = /opt/data</span><br><span class="line">socket = /tmp/mysql.sock</span><br><span class="line">port = 3306</span><br><span class="line">pid-file = /opt/data/mysql.pid</span><br><span class="line">user = mysql</span><br><span class="line">skip-name-resolve</span><br><span class="line"></span><br><span class="line">配置服务启动脚本</span><br><span class="line">[root@wenhs5479 ~]# cp -a /usr/local/mysql/support-files/mysql.server /etc/init.d/mysqld</span><br><span class="line">[root@wenhs5479 ~]# sed -ri &apos;s#^(basedir=).*#\1/usr/local/mysql#g&apos; /etc/init.d/mysqld</span><br><span class="line">[root@wenhs5479 ~]# sed -ri &apos;s#^(datadir=).*#\1/opt/data#g&apos; /etc/init.d/mysqld</span><br><span class="line"></span><br><span class="line">启动mysql</span><br><span class="line">[root@wenhs5479 ~]# /etc/init.d/mysqld start</span><br><span class="line">Starting MySQL.Logging to &apos;/opt/data/wenhs5479.err&apos;.</span><br><span class="line"> SUCCESS! </span><br><span class="line">[root@wenhs5479 ~]# ps -ef|grep mysql</span><br><span class="line">root      90916      1  0 13:55 pts/1    00:00:00 /bin/sh /usr/local/mysql/bin/mysqld_safe --datadir=/opt/data --pid-file=/opt/data/mysql.pid</span><br><span class="line">mysql     91094  90916  2 13:55 pts/1    00:00:00 /usr/local/mysql/binmysqld --basedir=/usr/local/mysql --datadir=/opt/data --plugin-dir=/usr/local/mysql/lib/plugin --user=mysql --log-error=wenhs5479.err --pid-file=/opt/data/mysql.pid --socket=/tmp/mysql.sock --port=3306</span><br><span class="line">root      91132  53676  0 13:55 pts/1    00:00:00 grep --color=auto mysql</span><br><span class="line">[root@wenhs5479 ~]# ss -antl</span><br><span class="line">State       Recv-Q Send-Q Local Address:Port               Peer Address:Port              </span><br><span class="line">LISTEN      0      128     *:111                 *:*                  </span><br><span class="line">LISTEN      0      5      192.168.122.1:53                  *:*                  </span><br><span class="line">LISTEN      0      128     *:22                  *:*                  </span><br><span class="line">LISTEN      0      128    127.0.0.1:631                 *:*                  </span><br><span class="line">LISTEN      0      100    127.0.0.1:25                  *:*                  </span><br><span class="line">LISTEN      0      128    127.0.0.1:6010                *:*                  </span><br><span class="line">LISTEN      0      80     :::3306               :::*                  </span><br><span class="line">LISTEN      0      128    :::111                :::*                  </span><br><span class="line">LISTEN      0      128    :::80                 :::*                  </span><br><span class="line">LISTEN      0      128    :::22                 :::*                  </span><br><span class="line">LISTEN      0      128       ::1:631                :::*                  </span><br><span class="line">LISTEN      0      100       ::1:25                 :::*                  </span><br><span class="line">LISTEN      0      128       ::1:6010               :::*</span><br><span class="line"></span><br><span class="line">修改密码</span><br><span class="line">使用临时密码登录</span><br><span class="line">[root@wenhs5479 ~]# /usr/local/mysql/bin/mysql -uroot -p</span><br><span class="line">Enter password: </span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 2</span><br><span class="line">Server version: 5.7.25</span><br><span class="line">Copyright (c) 2000, 2019, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line">Type &apos;help;&apos; or &apos;\h&apos; for help. Type &apos;\c&apos; to clear the current input statement.</span><br><span class="line">mysql&gt;</span><br><span class="line"></span><br><span class="line">设置新密码</span><br><span class="line">mysql&gt; set password = password(&apos;jbgsn123!&apos;);</span><br><span class="line">Query OK, 0 rows affected, 1 warning (0.00 sec)</span><br></pre></td></tr></table></figure><h1 id="2-mysql配置文件"><a href="#2-mysql配置文件" class="headerlink" title="2. mysql配置文件"></a>2. mysql配置文件</h1><p><code>mysql</code>的配置文件为<code>/etc/my.cnf</code></p><p>配置文件查找次序：若在多个配置文件中均有设定，则最后找到的最终生效</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/etc/my.cnf --&gt; /etc/mysql/my.cnf --&gt; --default-extra-file=/PATH/TO/CONF_FILE --&gt; ~/.my.cnf</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">配置免密登录</span><br><span class="line">[root@wenhs5479 ~]# cat &gt;.my.cnf &lt;&lt;EOF</span><br><span class="line">&gt; [client]</span><br><span class="line">&gt; user=root</span><br><span class="line">&gt; password=jbgsn123!</span><br><span class="line">&gt; EOF</span><br><span class="line">[root@wenhs5479 ~]# mysql</span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 8</span><br><span class="line">Server version: 5.7.25 MySQL Community Server (GPL)</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2019, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type &apos;help;&apos; or &apos;\h&apos; for help. Type &apos;\c&apos; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">mysql&gt;</span><br></pre></td></tr></table></figure><p><strong>mysql常用配置文件参数：</strong></p><table><thead><tr><th>参数</th><th>说明</th></tr></thead><tbody><tr><td>port = 3306</td><td>设置监听端口</td></tr><tr><td>socket = /tmp/mysql.sock</td><td>指定套接字文件位置</td></tr><tr><td>basedir = /usr/local/mysql</td><td>指定MySQL的安装路径</td></tr><tr><td>datadir = /data/mysql</td><td>指定MySQL的数据存放路径</td></tr><tr><td>pid-file = /data/mysql/mysql.pid</td><td>指定进程ID文件存放路径</td></tr><tr><td>user = mysql</td><td>指定MySQL以什么用户的身份提供服务</td></tr><tr><td>skip-name-resolve</td><td>禁止MySQL对外部连接进行DNS解析<br>使用这一选项可以消除MySQL进行DNS解析的时间。<br>若开启该选项，则所有远程主机连接授权都要使用IP地址方<br>式否则MySQL将无法正常处理连接请求</td></tr></tbody></table><h1 id="3-mysql数据库备份与恢复"><a href="#3-mysql数据库备份与恢复" class="headerlink" title="3. mysql数据库备份与恢复"></a>3. mysql数据库备份与恢复</h1><h3 id="3-1-数据库常用备份方案"><a href="#3-1-数据库常用备份方案" class="headerlink" title="3.1 数据库常用备份方案"></a>3.1 数据库常用备份方案</h3><p><strong>数据库备份方案：</strong></p><ul><li>全量备份</li><li>增量备份</li><li>差异备份</li></ul><table><thead><tr><th>备份方案</th><th>特点</th></tr></thead><tbody><tr><td>全量备份</td><td>全量备份就是指对某一个时间点上的所有数据或应用进行的一个完全拷贝。<br>数据恢复快。<br>备份时间长</td></tr><tr><td>增量备份</td><td>增量备份是指在一次全备份或上一次增量备份后，以后每次的备份只需备份<br>与前一次相比增加和者被修改的文件。这就意味着，第一次增量备份的对象<br>是进行全备后所产生的增加和修改的文件；第二次增量备份的对象是进行第一次增量<br>备份后所产生的增加和修改的文件，如此类推。<br>没有重复的备份数据<br>备份时间短<br>恢复数据时必须按一定的顺序进行</td></tr><tr><td>差异备份</td><td>备份上一次的完全备份后发生变化的所有文件。<br>差异备份是指在一次全备份后到进行差异备份的这段时间内<br>对那些增加或者修改文件的备份。在进行恢复时，我们只需对第一次全量备份和最后一次差异备份进行恢复。</td></tr></tbody></table><h3 id="3-2-mysql备份工具mysqldump"><a href="#3-2-mysql备份工具mysqldump" class="headerlink" title="3.2 mysql备份工具mysqldump"></a>3.2 mysql备份工具mysqldump</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line">语法：</span><br><span class="line">    mysqldump [OPTIONS] database [tables ...]</span><br><span class="line">    mysqldump [OPTIONS] --all-databases [OPTIONS]</span><br><span class="line">    mysqldump [OPTIONS] --databases [OPTIONS] DB1 [DB2 DB3...]</span><br><span class="line">    </span><br><span class="line">常用的OPTIONS：</span><br><span class="line">    -uUSERNAME      //指定数据库用户名</span><br><span class="line">    -hHOST          //指定服务器主机，请使用ip地址</span><br><span class="line">    -pPASSWORD      //指定数据库用户的密码</span><br><span class="line">    -P#             //指定数据库监听的端口，这里的#需用实际的端口号代替，如-P3307</span><br><span class="line"> </span><br><span class="line">备份整个数据库(全备)</span><br><span class="line">mysql&gt; show databases;</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| sys                |</span><br><span class="line">| wenhs              |</span><br><span class="line">+--------------------+</span><br><span class="line">5 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; use wenhs;</span><br><span class="line">Database changed</span><br><span class="line">mysql&gt; show tables;</span><br><span class="line">+-----------------+</span><br><span class="line">| Tables_in_wenhs |</span><br><span class="line">+-----------------+</span><br><span class="line">| student         |</span><br><span class="line">| teacher         |</span><br><span class="line">+-----------------+</span><br><span class="line">2 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; exit</span><br><span class="line">Bye</span><br><span class="line">[root@wenhs5479 ~]# mysqldump -uroot -p -hlocalhost --all-databases &gt;all-$(date +%F_%T).sql</span><br><span class="line">Enter password: </span><br><span class="line">[root@wenhs5479 ~]# ls</span><br><span class="line">all-2019-04-29_14:44:04.sql              公共  下载</span><br><span class="line">anaconda-ks.cfg                          模板  音乐</span><br><span class="line">apache                                   视频  桌面</span><br><span class="line">initial-setup-ks.cfg                     图片</span><br><span class="line">mysql-5.7.25-linux-glibc2.12-x86_64.tar  文档</span><br><span class="line"></span><br><span class="line">备份wenhs库的student表和teacher表</span><br><span class="line">[root@wenhs5479 ~]# mysqldump -uroot -p -hlocalhost wenhs student teacher &gt;table-$(date +%F_%T).sql</span><br><span class="line">Enter password: </span><br><span class="line">[root@wenhs5479 ~]# ls</span><br><span class="line">all-2019-04-29_14:44:04.sql              模板</span><br><span class="line">anaconda-ks.cfg                          视频</span><br><span class="line">apache                                   图片</span><br><span class="line">initial-setup-ks.cfg                     文档</span><br><span class="line">mysql-5.7.25-linux-glibc2.12-x86_64.tar  下载</span><br><span class="line">table-2019-04-29_14:45:41.sql            音乐</span><br><span class="line">公共                                     桌面</span><br><span class="line"></span><br><span class="line">备份wenhs库</span><br><span class="line">[root@wenhs5479 ~]# mysqldump -uroot -p -hlocalhost --databases wenhs &gt;wenhs-$(date +%F_%T).sql</span><br><span class="line">Enter password: </span><br><span class="line">[root@wenhs5479 ~]# ls</span><br><span class="line">all-2019-04-29_14:44:04.sql              模板</span><br><span class="line">anaconda-ks.cfg                          视频</span><br><span class="line">apache                                   图片</span><br><span class="line">initial-setup-ks.cfg                     文档</span><br><span class="line">mysql-5.7.25-linux-glibc2.12-x86_64.tar  下载</span><br><span class="line">table-2019-04-29_14:45:41.sql            音乐</span><br><span class="line">wenhs-2019-04-29_14:46:35.sql            桌面</span><br><span class="line">公共</span><br><span class="line"></span><br><span class="line">模拟误删wenhs数据库</span><br><span class="line">mysql&gt; drop database wenhs;</span><br><span class="line">Query OK, 2 rows affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; show databases;</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| sys                |</span><br><span class="line">+--------------------+</span><br><span class="line">4 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure><h3 id="3-3-mysql数据恢复"><a href="#3-3-mysql数据恢复" class="headerlink" title="3.3 mysql数据恢复"></a>3.3 mysql数据恢复</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">恢复wenhs数据库</span><br><span class="line">[root@wenhs5479 ~]# ls</span><br><span class="line">all-2019-04-29_14:44:04.sql              模板</span><br><span class="line">anaconda-ks.cfg                          视频</span><br><span class="line">apache                                   图片</span><br><span class="line">initial-setup-ks.cfg                     文档</span><br><span class="line">mysql-5.7.25-linux-glibc2.12-x86_64.tar  下载</span><br><span class="line">table-2019-04-29_14:45:41.sql            音乐</span><br><span class="line">wenhs-2019-04-29_14:46:35.sql            桌面</span><br><span class="line">公共</span><br><span class="line">[root@wenhs5479 ~]# mysql &lt;all-2019-04-29_14\:44\:04.sql 配置了免密登录</span><br><span class="line">[root@wenhs5479 ~]# mysql -e &apos;show databases;&apos;</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| sys                |</span><br><span class="line">| wenhs              |</span><br><span class="line">+--------------------+</span><br><span class="line"></span><br><span class="line">恢复wenhs数据库的student表和teacher表</span><br><span class="line">mysql&gt; use wenhs;</span><br><span class="line">Reading table information for completion of table and column names</span><br><span class="line">You can turn off this feature to get a quicker startup with -A</span><br><span class="line"></span><br><span class="line">mysql&gt; source table-2019-04-29_14:45:41.sql</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line">......</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; show tables;</span><br><span class="line">+-----------------+</span><br><span class="line">| Tables_in_wenhs |</span><br><span class="line">+-----------------+</span><br><span class="line">| student         |</span><br><span class="line">| teacher         |</span><br><span class="line">+-----------------+</span><br><span class="line">2 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">模拟删除整个数据库</span><br><span class="line">mysql&gt; drop database wenhs;</span><br><span class="line">Query OK, 2 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; show databases;</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| sys                |</span><br><span class="line">+--------------------+</span><br><span class="line">4 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">恢复整个数据库</span><br><span class="line">[root@wenhs5479 ~]# mysql &lt; all-2019-04-29_14\:44\:04.sql </span><br><span class="line">[root@wenhs5479 ~]# mysql wenhs &lt; table-2019-04-29_14\:45\:41.sql    此步多余,第一次全备中,库里面数据都已经备份,不需要这步</span><br><span class="line">[root@wenhs5479 ~]# mysql -e &apos;select * from wenhs.student;&apos;</span><br><span class="line">+----+-------------+------+</span><br><span class="line">| id | name        | age  |</span><br><span class="line">+----+-------------+------+</span><br><span class="line">|  1 | tom         |   20 |</span><br><span class="line">|  2 | jerry       |   23 |</span><br><span class="line">|  3 | wangqing    |   25 |</span><br><span class="line">|  4 | sean        |   28 |</span><br><span class="line">|  5 | zhangshan   |   26 |</span><br><span class="line">|  7 | lisi        |   50 |</span><br><span class="line">|  8 | chenshuo    |   10 |</span><br><span class="line">|  9 | wangwu      |    3 |</span><br><span class="line">| 10 | qiuyi       |   15 |</span><br><span class="line">| 11 | qiuxiaotian |   20 |</span><br><span class="line">+----+-------------+------+</span><br></pre></td></tr></table></figure><h3 id="3-4-差异备份与恢复"><a href="#3-4-差异备份与恢复" class="headerlink" title="3.4 差异备份与恢复"></a>3.4 差异备份与恢复</h3><h4 id="3-4-1-MySQL的差异备份"><a href="#3-4-1-MySQL的差异备份" class="headerlink" title="3.4.1 MySQL的差异备份"></a>3.4.1 MySQL的差异备份</h4><p><strong>开启的MySQL服务器的二进制日志功能</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@wenhs5479 ~]# vim /etc/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">basedir = /usr/local/mysql</span><br><span class="line">datadir = /opt/data</span><br><span class="line">socket = /tmp/mysql.sock</span><br><span class="line">port = 3306</span><br><span class="line">pid-file = /opt/data/mysql.pid</span><br><span class="line">user = mysql</span><br><span class="line">skip-name-resolve</span><br><span class="line"></span><br><span class="line">server-id=1设置服务器标识符</span><br><span class="line">log-bin=mysql_bin开启二进制日志功能</span><br><span class="line">[root@wenhs5479 ~]# service mysqld restart</span><br><span class="line">Shutting down MySQL.. SUCCESS! </span><br><span class="line">Starting MySQL. SUCCESS!</span><br></pre></td></tr></table></figure><p><strong>对数据库进行完全备份</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line">[root@wenhs5479 ~]# mysql配置了免密登录</span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 2</span><br><span class="line">Server version: 5.7.25-log MySQL Community Server (GPL)</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2019, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type &apos;help;&apos; or &apos;\h&apos; for help. Type &apos;\c&apos; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">mysql&gt; show databases;</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| sys                |</span><br><span class="line">| wenhs              |</span><br><span class="line">+--------------------+</span><br><span class="line">5 rows in set (0.01 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; show tables from wenhs;</span><br><span class="line">+-----------------+</span><br><span class="line">| Tables_in_wenhs |</span><br><span class="line">+-----------------+</span><br><span class="line">| student         |</span><br><span class="line">| teacher         |</span><br><span class="line">+-----------------+</span><br><span class="line">2 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from wenhs.student;</span><br><span class="line">+----+-------------+------+</span><br><span class="line">| id | name        | age  |</span><br><span class="line">+----+-------------+------+</span><br><span class="line">|  1 | tom         |   20 |</span><br><span class="line">|  2 | jerry       |   23 |</span><br><span class="line">|  3 | wangqing    |   25 |</span><br><span class="line">|  4 | sean        |   28 |</span><br><span class="line">|  5 | zhangshan   |   26 |</span><br><span class="line">|  7 | lisi        |   50 |</span><br><span class="line">|  8 | chenshuo    |   10 |</span><br><span class="line">|  9 | wangwu      |    3 |</span><br><span class="line">| 10 | qiuyi       |   15 |</span><br><span class="line">| 11 | qiuxiaotian |   20 |</span><br><span class="line">+----+-------------+------+</span><br><span class="line">10 rows in set (0.01 sec)</span><br><span class="line"></span><br><span class="line">完全备份</span><br><span class="line">[root@wenhs5479 ~]# mysqldump --single-transaction --flush-logs --master-data=2 --all-databases --delete-master-logs &gt; all-$(date +%F_%T).sql</span><br><span class="line">[root@wenhs5479 ~]# ll</span><br><span class="line">总用量 660192</span><br><span class="line">-rw-r--r--. 1 root root    794130 4月  30 09:43 all-2019-04-30_09:43:24.sql</span><br><span class="line"></span><br><span class="line">增加新内容</span><br><span class="line">mysql&gt; use wenhs;</span><br><span class="line">Reading table information for completion of table and column names</span><br><span class="line">You can turn off this feature to get a quicker startup with -A</span><br><span class="line"></span><br><span class="line">Database changed</span><br><span class="line">mysql&gt; insert into student values(100,&apos;hehe&apos;,20),(200,&apos;xixi&apos;,34);</span><br><span class="line">Query OK, 2 rows affected (0.00 sec)</span><br><span class="line">Records: 2  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">mysql&gt; </span><br><span class="line">mysql&gt; select * from student;</span><br><span class="line">+-----+-------------+------+</span><br><span class="line">| id  | name        | age  |</span><br><span class="line">+-----+-------------+------+</span><br><span class="line">|   1 | tom         |   20 |</span><br><span class="line">|   2 | jerry       |   23 |</span><br><span class="line">|   3 | wangqing    |   25 |</span><br><span class="line">|   4 | sean        |   28 |</span><br><span class="line">|   5 | zhangshan   |   26 |</span><br><span class="line">|   7 | lisi        |   50 |</span><br><span class="line">|   8 | chenshuo    |   10 |</span><br><span class="line">|   9 | wangwu      |    3 |</span><br><span class="line">|  10 | qiuyi       |   15 |</span><br><span class="line">|  11 | qiuxiaotian |   20 |</span><br><span class="line">| 100 | hehe        |   20 |</span><br><span class="line">| 200 | xixi        |   34 |</span><br><span class="line">+-----+-------------+------+</span><br><span class="line">12 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; update student set age = 100 where id = 100;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line">Rows matched: 1  Changed: 1  Warnings: 0</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from student;</span><br><span class="line">+-----+-------------+------+</span><br><span class="line">| id  | name        | age  |</span><br><span class="line">+-----+-------------+------+</span><br><span class="line">|   1 | tom         |   20 |</span><br><span class="line">|   2 | jerry       |   23 |</span><br><span class="line">|   3 | wangqing    |   25 |</span><br><span class="line">|   4 | sean        |   28 |</span><br><span class="line">|   5 | zhangshan   |   26 |</span><br><span class="line">|   7 | lisi        |   50 |</span><br><span class="line">|   8 | chenshuo    |   10 |</span><br><span class="line">|   9 | wangwu      |    3 |</span><br><span class="line">|  10 | qiuyi       |   15 |</span><br><span class="line">|  11 | qiuxiaotian |   20 |</span><br><span class="line">| 100 | hehe        |  100 |</span><br><span class="line">| 200 | xixi        |   34 |</span><br><span class="line">+-----+-------------+------+</span><br><span class="line">12 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure><h4 id="3-4-2-mysql差异备份恢复"><a href="#3-4-2-mysql差异备份恢复" class="headerlink" title="3.4.2. mysql差异备份恢复"></a>3.4.2. mysql差异备份恢复</h4><p>模拟误删数据库</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@wenhs5479 ~]# mysql -e &apos;drop database wenhs;&apos;</span><br><span class="line">[root@wenhs5479 ~]# mysql -e &apos;show databases;&apos;</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| sys                |</span><br><span class="line">+--------------------+</span><br><span class="line">由上可以看到wenhs这个数据库已被删除</span><br></pre></td></tr></table></figure><p>刷新创建新的二进制日志</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[root@wenhs5479 ~]# ll /opt/data/</span><br><span class="line">总用量 122944</span><br><span class="line">-rw-r-----. 1 mysql mysql       56 4月  29 12:25 auto.cnf</span><br><span class="line">-rw-r-----. 1 mysql mysql     1008 4月  30 09:38 ib_buffer_pool</span><br><span class="line">-rw-r-----. 1 mysql mysql 12582912 4月  30 09:58 ibdata1</span><br><span class="line">-rw-r-----. 1 mysql mysql 50331648 4月  30 09:58 ib_logfile0</span><br><span class="line">-rw-r-----. 1 mysql mysql 50331648 4月  29 12:25 ib_logfile1</span><br><span class="line">-rw-r-----. 1 mysql mysql 12582912 4月  30 09:43 ibtmp1</span><br><span class="line">drwxr-x---. 2 mysql mysql     4096 4月  29 15:09 mysql</span><br><span class="line">-rw-r-----. 1 mysql mysql      877 4月  30 09:58 mysql_bin.000002</span><br><span class="line">-rw-r-----. 1 mysql mysql       19 4月  30 09:43 mysql_bin.index</span><br><span class="line">-rw-r-----. 1 mysql mysql        6 4月  30 09:38 mysql.pid</span><br><span class="line">drwxr-x---. 2 mysql mysql     8192 4月  29 12:25 performance_schema</span><br><span class="line">drwxr-x---. 2 mysql mysql     8192 4月  29 12:25 sys</span><br><span class="line">-rw-r-----. 1 mysql mysql    12748 4月  30 09:38 wenhs5479.err</span><br><span class="line">[root@wenhs5479 ~]# mysqladmin flush-logs</span><br><span class="line">[root@wenhs5479 ~]# ll /opt/data/</span><br><span class="line">总用量 122948</span><br><span class="line">-rw-r-----. 1 mysql mysql       56 4月  29 12:25 auto.cnf</span><br><span class="line">-rw-r-----. 1 mysql mysql     1008 4月  30 09:38 ib_buffer_pool</span><br><span class="line">-rw-r-----. 1 mysql mysql 12582912 4月  30 09:58 ibdata1</span><br><span class="line">-rw-r-----. 1 mysql mysql 50331648 4月  30 09:58 ib_logfile0</span><br><span class="line">-rw-r-----. 1 mysql mysql 50331648 4月  29 12:25 ib_logfile1</span><br><span class="line">-rw-r-----. 1 mysql mysql 12582912 4月  30 09:43 ibtmp1</span><br><span class="line">drwxr-x---. 2 mysql mysql     4096 4月  29 15:09 mysql</span><br><span class="line">-rw-r-----. 1 mysql mysql      924 4月  30 09:59 mysql_bin.000002</span><br><span class="line">-rw-r-----. 1 mysql mysql      154 4月  30 09:59 mysql_bin.000003</span><br><span class="line">-rw-r-----. 1 mysql mysql       38 4月  30 09:59 mysql_bin.index</span><br><span class="line">-rw-r-----. 1 mysql mysql        6 4月  30 09:38 mysql.pid</span><br><span class="line">drwxr-x---. 2 mysql mysql     8192 4月  29 12:25 performance_schema</span><br><span class="line">drwxr-x---. 2 mysql mysql     8192 4月  29 12:25 sys</span><br><span class="line">-rw-r-----. 1 mysql mysql    12748 4月  30 09:38 wenhs5479.err</span><br></pre></td></tr></table></figure><p>恢复完全备份</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">[root@wenhs5479 ~]# mysql &lt;all-2019-04-30_09\:43\:24.sql </span><br><span class="line">[root@wenhs5479 ~]# mysql -e &apos;show databases;&apos;</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| sys                |</span><br><span class="line">| wenhs              |</span><br><span class="line">+--------------------+</span><br><span class="line">[root@wenhs5479 ~]# mysql -e &apos;show tables from wenhs;&apos;</span><br><span class="line">+-----------------+</span><br><span class="line">| Tables_in_wenhs |</span><br><span class="line">+-----------------+</span><br><span class="line">| student         |</span><br><span class="line">| teacher         |</span><br><span class="line">+-----------------+</span><br><span class="line">[root@wenhs5479 ~]# mysql -e &apos;select * from wenhs.student;&apos;</span><br><span class="line">+----+-------------+------+</span><br><span class="line">| id | name        | age  |</span><br><span class="line">+----+-------------+------+</span><br><span class="line">|  1 | tom         |   20 |</span><br><span class="line">|  2 | jerry       |   23 |</span><br><span class="line">|  3 | wangqing    |   25 |</span><br><span class="line">|  4 | sean        |   28 |</span><br><span class="line">|  5 | zhangshan   |   26 |</span><br><span class="line">|  7 | lisi        |   50 |</span><br><span class="line">|  8 | chenshuo    |   10 |</span><br><span class="line">|  9 | wangwu      |    3 |</span><br><span class="line">| 10 | qiuyi       |   15 |</span><br><span class="line">| 11 | qiuxiaotian |   20 |</span><br><span class="line">+----+-------------+------+</span><br><span class="line">[root@wenhs5479 ~]# mysql -e &apos;select * from wenhs.teacher;&apos;</span><br><span class="line">+----+-------------+------+</span><br><span class="line">| id | name        | age  |</span><br><span class="line">+----+-------------+------+</span><br><span class="line">|  1 | tom         |   20 |</span><br><span class="line">|  2 | jerry       |   23 |</span><br><span class="line">|  3 | wangqing    |   25 |</span><br><span class="line">|  4 | sean        |   28 |</span><br><span class="line">|  5 | zhangshan   |   26 |</span><br><span class="line">|  6 | zhangshan   |   20 |</span><br><span class="line">|  7 | lisi        | NULL |</span><br><span class="line">|  8 | chenshuo    |   10 |</span><br><span class="line">|  9 | wangwu      |    3 |</span><br><span class="line">| 10 | qiuyi       |   15 |</span><br><span class="line">| 11 | qiuxiaotian |   20 |</span><br><span class="line">+----+-------------+------+</span><br></pre></td></tr></table></figure><p>恢复差异备份</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">[root@wenhs5479 ~]# ll /opt/data/</span><br><span class="line">总用量 123704</span><br><span class="line">-rw-r-----. 1 mysql mysql       56 4月  29 12:25 auto.cnf</span><br><span class="line">-rw-r-----. 1 mysql mysql     1008 4月  30 09:38 ib_buffer_pool</span><br><span class="line">-rw-r-----. 1 mysql mysql 12582912 4月  30 10:00 ibdata1</span><br><span class="line">-rw-r-----. 1 mysql mysql 50331648 4月  30 10:00 ib_logfile0</span><br><span class="line">-rw-r-----. 1 mysql mysql 50331648 4月  29 12:25 ib_logfile1</span><br><span class="line">-rw-r-----. 1 mysql mysql 12582912 4月  30 09:43 ibtmp1</span><br><span class="line">drwxr-x---. 2 mysql mysql     4096 4月  30 10:00 mysql</span><br><span class="line">-rw-r-----. 1 mysql mysql      924 4月  30 09:59 mysql_bin.000002</span><br><span class="line">-rw-r-----. 1 mysql mysql   776980 4月  30 10:00 mysql_bin.000003</span><br><span class="line">-rw-r-----. 1 mysql mysql       38 4月  30 09:59 mysql_bin.index</span><br><span class="line">-rw-r-----. 1 mysql mysql        6 4月  30 09:38 mysql.pid</span><br><span class="line">drwxr-x---. 2 mysql mysql     8192 4月  29 12:25 performance_schema</span><br><span class="line">drwxr-x---. 2 mysql mysql     8192 4月  29 12:25 sys</span><br><span class="line">drwxr-x---. 2 mysql mysql       96 4月  30 10:00 wenhs</span><br><span class="line">-rw-r-----. 1 mysql mysql    12748 4月  30 09:38 wenhs5479.err</span><br><span class="line">[root@wenhs5479 ~]# mysql</span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 13</span><br><span class="line">Server version: 5.7.25-log MySQL Community Server (GPL)</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2019, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type &apos;help;&apos; or &apos;\h&apos; for help. Type &apos;\c&apos; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">mysql&gt; show binlog events in &apos;mysql_bin.000002&apos;;</span><br><span class="line">+------------------+-----+----------------+-----------+-------------+---------------------------------------+</span><br><span class="line">| Log_name         | Pos | Event_type     | Server_id | End_log_pos | Info                                  |</span><br><span class="line">+------------------+-----+----------------+-----------+-------------+---------------------------------------+</span><br><span class="line">| mysql_bin.000002 |   4 | Format_desc    |         1 |         123 | Server ver: 5.7.25-log, Binlog ver: 4 |</span><br><span class="line">| mysql_bin.000002 | 123 | Previous_gtids |         1 |         154 |                                       |</span><br><span class="line">| mysql_bin.000002 | 154 | Anonymous_Gtid |         1 |         219 | SET @@SESSION.GTID_NEXT= &apos;ANONYMOUS&apos;  |</span><br><span class="line">| mysql_bin.000002 | 219 | Query          |         1 |         292 | BEGIN                                 |</span><br><span class="line">| mysql_bin.000002 | 292 | Table_map      |         1 |         347 | table_id: 141 (wenhs.student)         |</span><br><span class="line">| mysql_bin.000002 | 347 | Write_rows     |         1 |         404 | table_id: 141 flags: STMT_END_F       |</span><br><span class="line">| mysql_bin.000002 | 404 | Xid            |         1 |         435 | COMMIT /* xid=487 */                  |</span><br><span class="line">| mysql_bin.000002 | 435 | Anonymous_Gtid |         1 |         500 | SET @@SESSION.GTID_NEXT= &apos;ANONYMOUS&apos;  |</span><br><span class="line">| mysql_bin.000002 | 500 | Query          |         1 |         573 | BEGIN                                 |</span><br><span class="line">| mysql_bin.000002 | 573 | Table_map      |         1 |         628 | table_id: 141 (wenhs.student)         |</span><br><span class="line">| mysql_bin.000002 | 628 | Update_rows    |         1 |         686 | table_id: 141 flags: STMT_END_F       |</span><br><span class="line">| mysql_bin.000002 | 686 | Xid            |         1 |         717 | COMMIT /* xid=489 */                  |</span><br><span class="line">| mysql_bin.000002 | 717 | Anonymous_Gtid |         1 |         782 | SET @@SESSION.GTID_NEXT= &apos;ANONYMOUS&apos;  |</span><br><span class="line">| mysql_bin.000002 | 782 | Query          |         1 |         877 | drop database wenhs                   |</span><br><span class="line">| mysql_bin.000002 | 877 | Rotate         |         1 |         924 | mysql_bin.000003;pos=4                |</span><br><span class="line">+------------------+-----+----------------+-----------+-------------+---------------------------------------+</span><br><span class="line">15 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">使用mysqlbinlog恢复差异备份</span><br><span class="line">[root@wenhs5479 ~]# mysqlbinlog --stop-position=782 /opt/data/mysql_bin.000002 |mysql-----配置了密码登录,否则要-u和-p</span><br><span class="line">[root@wenhs5479 ~]# mysql -e &apos;select * from wenhs.student;&apos;</span><br><span class="line">+-----+-------------+------+</span><br><span class="line">| id  | name        | age  |</span><br><span class="line">+-----+-------------+------+</span><br><span class="line">|   1 | tom         |   20 |</span><br><span class="line">|   2 | jerry       |   23 |</span><br><span class="line">|   3 | wangqing    |   25 |</span><br><span class="line">|   4 | sean        |   28 |</span><br><span class="line">|   5 | zhangshan   |   26 |</span><br><span class="line">|   7 | lisi        |   50 |</span><br><span class="line">|   8 | chenshuo    |   10 |</span><br><span class="line">|   9 | wangwu      |    3 |</span><br><span class="line">|  10 | qiuyi       |   15 |</span><br><span class="line">|  11 | qiuxiaotian |   20 |</span><br><span class="line">| 100 | hehe        |  100 |</span><br><span class="line">| 200 | xixi        |   34 |</span><br><span class="line">+-----+-------------+------+</span><br></pre></td></tr></table></figure><h1 id="4-xtrabackup"><a href="#4-xtrabackup" class="headerlink" title="4.xtrabackup"></a>4.xtrabackup</h1><p>Percona XtraBackup工具提供了一种在系统运行时执行MySQL数据热备份的方法。Percona XtraBackup是一款免费的在线开源完整数据库备份解决方案，适用于所有版本的Percona Server for MySQL和MySQL®。Percona XtraBackup在事务性系统上执行在线非阻塞，紧密压缩，高度安全的完整备份，以便应用程序在计划维护窗口期间保持完全可用。</p><p>可在事务系统上执行在线无阻塞，紧密压缩，高度安全的完整MySQL备份，以便在计划维护窗口期间完全可用任务关键型应用程序。</p><p>在本地和云中工作</p><ul><li>Percona XtraBackup与当今的云提供商（如AWS，Google Cloud，Microsoft<br>Azure等）完全兼容，完全部署在云中或作为混合解决方案。</li></ul><p>保持数据库的实时</p><ul><li>企业准备就绪 Percona XtraBackup具有企业所需的所有工具和功能，可确保数据文件的一致性和安全性。</li></ul><p>保持数据库的实时</p><ul><li>简化操作 </li><li>通过使用Percona XtraBackup加速数据库操作并将数据复制到新的复制从属，可以节省时间和金钱。</li></ul><p>保持数据库的实时</p><ul><li>非阻塞备份 </li><li>Percona XtraBackup允许您在生产中备份数据库，而不会影响正常运行时间或数据更改。</li></ul><p>保持数据库的实时</p><ul><li>备份自动化 </li><li>您可以自动执行备份过程并验证自动备份。</li></ul><p>当与Percona Server for MySQL结合使用时，Percona XtraBackup为当前可用的事务系统提供唯一真正的非阻塞在线实时MySQL备份。</p><p><strong>Percona XtraBackup提供：</strong></p><ul><li>快速可靠的数据库备份（例如热备份，增量备份，bacula备份等）</li><li>备份期间不间断的事务处理</li><li>通过更好的压缩节省磁盘空间和网络带宽</li><li>自动备份验证</li><li>由于更快的恢复时间，正常运行时间更长</li><li>时间点恢复</li></ul><p><a href="https://www.cnblogs.com/f-ck-need-u/p/9018716.html" target="_blank" rel="noopener">点这里,了解此工具详解</a></p><h1 id="5-冷备-温备-热备详解"><a href="#5-冷备-温备-热备详解" class="headerlink" title="5.冷备,温备,热备详解"></a>5.冷备,温备,热备详解</h1><p><strong>按备份系统的准备程度，可将其分为 冷备份、温备份和热备份三大类 :</strong></p><ul><li><p><strong>冷备份</strong> : 备份系统未安装或未配置成与当前使用的系统相同或相似的运行环境，应用系统数据没有及时装入备份系统。一旦发生灾难，需安装配置所需的运行环境，用数据备份介质(磁带或光盘)<br>恢复应用数据，手工逐笔或自动批量追补孤立数据，将终端用户通过通讯线路切换到备份系统，恢复业务运行</p><ul><li><input disabled type="checkbox"> 优点 : 设备投资较少，节省通信费用，通信环境要求不高</li><li><input disabled type="checkbox"> 缺点 : 恢复时间较长，一般要数天至1周，数据完整性与一致性较差</li></ul></li><li><p><strong>温备份</strong> : 将备份系统已安装配置成与当前使用的系统相同或相似的系统和网络运行环境，安装应用系统业务定期备份数据。一旦发生灾难，直接使用定期备份数据，手工逐笔或自动批量追补孤立数据或将终端用户通过通讯线路切换到备份系统，恢复业务运行</p><ul><li><input disabled type="checkbox"> 优点 : 设备投资较少，通信环境要求不高</li><li><input disabled type="checkbox"> 缺点 : 恢复时间长，一般要十几个小时至数天，数据完整性与一致性较差</li></ul></li><li><p><strong>热备份</strong> : 备份处于联机状态，当前应用系统通过高速通信线路将数据实时传送到备份系统，保持备份系统与当前应用系统数据的同步；也可定时在备份系统上恢复应用系统的数据。一旦发生灾难，不用追补或只需追补很少的孤立数据，备份系统可快速接替生产系统运行，恢复营业</p><ul><li><input disabled type="checkbox"> 优点 : 恢复时间短，一般几十分钟到数小时，数据完整性与一致性最好，数据丢失可能性最小</li><li><input disabled type="checkbox"> 缺点 : 设备投资大，通信费用高，通信环境要求高，平时运行管理较复杂</li></ul></li></ul><p><strong>在计算机服务器备份和恢复中</strong>　</p><ul><li>冷备份服务器(cold server)<br>是在主服务器丢失的情况下才使用的备份服务器。冷备份服务器基本上只在软件安装和配置的情况下打开，然后关闭直到需要时再打开</li><li>温备份服务器(warm server) 一般都是周期性开机，根据主服务器内容进行更新，然后关机。经常用温备份服务器来进行复制和镜像操作</li><li>热备份服务器(hot server) 时刻处于开机状态，同主机保持同步。当主机失灵时，可以随时启用热备份服务器来代替</li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;a id=&quot;more&quot;&gt;&lt;/a&gt;

&lt;h1 id=&quot;1-二进制格式mysql安装&quot;&gt;&lt;a href=&quot;#1-二进制格式mysql安装&quot; class=&quot;headerlink&quot; title=&quot;1. 二进制格式mysql安装&quot;&gt;&lt;/a&gt;1. 二进制格式mysql安装&lt;/h1&gt;&lt;fig
      
    
    </summary>
    
      <category term="Linux运维" scheme="http://aiwhs.github.io/categories/Linux%E8%BF%90%E7%BB%B4/"/>
    
    
      <category term="sql" scheme="http://aiwhs.github.io/tags/sql/"/>
    
  </entry>
  
  <entry>
    <title>MySQL基础</title>
    <link href="http://aiwhs.github.io/2018/11/24/MYSQL1/"/>
    <id>http://aiwhs.github.io/2018/11/24/MYSQL1/</id>
    <published>2018-11-24T00:15:57.000Z</published>
    <updated>2019-07-10T06:40:33.639Z</updated>
    
    <content type="html"><![CDATA[<a id="more"></a><h1 id="1-关系型数据库介绍"><a href="#1-关系型数据库介绍" class="headerlink" title="1. 关系型数据库介绍"></a>1. 关系型数据库介绍</h1><h3 id="1-1-数据结构模型"><a href="#1-1-数据结构模型" class="headerlink" title="1.1 数据结构模型"></a>1.1 数据结构模型</h3><p>数据结构模型主要有：</p><ul><li>层次模型</li><li>网状结构</li><li>关系模型</li></ul><p>关系模型：<br>二维关系：row，column</p><p>数据库管理系统：DBMS<br>关系：Relational，RDBMS</p><h3 id="1-2-RDBMS专业名词"><a href="#1-2-RDBMS专业名词" class="headerlink" title="1.2 RDBMS专业名词"></a>1.2 RDBMS专业名词</h3><p><strong>常见的关系型数据库管理系统：</strong></p><ul><li>MySQL：MySQL，MariaDB，Percona-Server</li><li>PostgreSQL：简称为pgsql</li><li>Oracle</li><li>MSSQL</li></ul><p><strong>记录</strong>:数据库中表的每行是一条记录</p><p><strong>事务</strong>：多个操作被当作一个整体对待就称为一个事务</p><p>要看一个关系型数据库是否支持事务，需要看其是否支持并满足ACID测试<br>ACID：ACID是事务的一个基本标准</p><ul><li>A：Automicity，原子性</li><li>C：Consistency，一致性</li><li>I：Isolation，隔离性</li><li>D：Durability，持久性</li></ul><p>ACID，可以查看<a href="https://baike.baidu.com/item/acid/10738" target="_blank" rel="noopener">这里</a>了解详细说明，</p><p><strong>SQL</strong>：Structure Query Language，结构化查询语言</p><p><strong>约束</strong>：constraint，向数据表提供的数据要遵守的限制</p><ul><li>主键约束：一个或多个字段的组合，填入的数据必须能在本表中唯一标识本行。且必须提供数据，不能为空（NOT NULL）。<ul><li><input disabled type="checkbox"> 一个表只能存在一个</li></ul></li><li>惟一键约束：一个或多个字段的组合，填入的数据必须能在本表中唯一标识本行。允许为空（NULL）<ul><li><input disabled type="checkbox"> 一个表可以存在多个</li></ul></li><li>外键约束：一个表中的某字段可填入数据取决于另一个表的主键已有的数据</li><li>检查性约束</li></ul><p><strong>索引</strong>：将表中的一个或多个字段中的数据复制一份另存，并且这些数据需要按特定次序排序存储</p><p><strong>关系运算</strong>：</p><ul><li>选择：挑选出符合条件的行（部分行）</li><li>投影：挑选出需要的字段</li><li>连接</li></ul><p><strong>数据抽象方式</strong>：</p><ul><li>物理层：决定数据的存储格式，即RDBMS在磁盘上如何组织文件</li><li>逻辑层：描述DB存储什么数据，以及数据间存在什么样的关系</li><li>视图层：描述DB中的部分数据</li></ul><h3 id="1-3-关系型数据库的常见组件"><a href="#1-3-关系型数据库的常见组件" class="headerlink" title="1.3 关系型数据库的常见组件"></a>1.3 关系型数据库的常见组件</h3><p>关系型数据库的常见组件有：</p><ul><li>数据库：database</li><li>表：table，由行（row）和列（column）组成</li><li>索引：index</li><li>视图：view</li><li>用户：user</li><li>权限：privilege</li><li>存储过程：procedure</li><li>存储函数：function</li><li>触发器：trigger</li><li>事件调度器：event scheduler</li></ul><h3 id="1-4-SQL语句"><a href="#1-4-SQL语句" class="headerlink" title="1.4 SQL语句"></a>1.4 SQL语句</h3><p>SQL语句有三种类型：</p><ul><li>DDL：Data Defination Language，数据定义语言</li><li>DML：Data Manipulation Language，数据操纵语言</li><li>DCL：Data Control Language，数据控制语言</li></ul><table><thead><tr><th>SQL语句类型</th><th>对应操作</th></tr></thead><tbody><tr><td>DDL</td><td>CREATE：创建<br>DROP：删除<br>ALTER：修改</td></tr><tr><td>DML</td><td>INSERT：向表中插入数据<br>DELETE：删除表中数据<br>UPDATE：更新表中数据<br>SELECT：查询表中数据</td></tr><tr><td>DCL</td><td>GRANT：授权<br>REVOKE：移除授权</td></tr></tbody></table><h1 id="2-mysql安装与配置"><a href="#2-mysql安装与配置" class="headerlink" title="2. mysql安装与配置"></a>2. mysql安装与配置</h1><h3 id="2-1-mysql安装"><a href="#2-1-mysql安装" class="headerlink" title="2.1 mysql安装"></a>2.1 mysql安装</h3><p>mysql安装方式有三种：</p><ul><li>源代码：编译安装</li><li>二进制格式的程序包：展开至特定路径，并经过简单配置后即可使用</li><li>程序包管理器管理的程序包：<ul><li><input disabled type="checkbox"> rpm：有两种<ul><li>OS Vendor：操作系统发行商提供的</li><li>项目官方提供的<ul><li><input disabled type="checkbox"> deb</li></ul></li></ul></li></ul></li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">配置MySQL安装源:</span><br><span class="line">[root@ip-10-0-100-141 ~]# cd /usr/src/</span><br><span class="line">[root@ip-10-0-100-141 src]# ls</span><br><span class="line">debug  kernels</span><br><span class="line">[root@ip-10-0-100-141 src]# wget http://dev.mysql.com/get/mysql57-community-release-el7-10.noarch.rpm</span><br><span class="line">--2019-04-22 15:04:45--  http://dev.mysql.com/get/mysql57-community-release-el7-10.noarch.rpm</span><br><span class="line">正在解析主机 dev.mysql.com (dev.mysql.com)... 137.254.60.11</span><br><span class="line">......</span><br><span class="line"></span><br><span class="line">100%[=============================================&gt;] 25,548      --.-K/s 用时 0.04s   </span><br><span class="line"></span><br><span class="line">2019-04-22 15:04:55 (572 KB/s) - 已保存 “mysql57-community-release-el7-10.noarch.rpm” [25548/25548])</span><br><span class="line"></span><br><span class="line">[root@ip-10-0-100-141 src]# ls</span><br><span class="line">debug  kernels  mysql57-community-release-el7-10.noarch.rpm</span><br><span class="line">[root@ip-10-0-100-141 src]# rpm -ivh mysql57-community-release-el7-10.noarch.rpm </span><br><span class="line">警告：mysql57-community-release-el7-10.noarch.rpm: 头V3 DSA/SHA1 Signature, 密钥 ID 5072e1f5: NOKEY</span><br><span class="line">准备中...                          ################################# [100%]</span><br><span class="line">正在升级/安装...</span><br><span class="line">   1:mysql57-community-release-el7-10 ################################# [100%]</span><br><span class="line">[root@ip-10-0-100-141 src]# ls /etc/yum.repos.d/</span><br><span class="line">mysql-community.repo         redhat-rhui-client-config.repo  rhui-load-balancers.conf</span><br><span class="line">mysql-community-source.repo  redhat-rhui.repo</span><br><span class="line">[root@ip-10-0-100-141 src]#</span><br><span class="line"></span><br><span class="line">安装MySQL5.7</span><br><span class="line">[root@ip-10-0-100-141 ~]# yum -y install mysql-community-server mysql-community-client mysql-community-common mysql-community-devel</span><br><span class="line">......</span><br><span class="line">Installed:</span><br><span class="line">  mysql-community-client.x86_64 0:5.7.25-1.el7                                         </span><br><span class="line">  mysql-community-common.x86_64 0:5.7.25-1.el7                                         </span><br><span class="line">  mysql-community-devel.x86_64 0:5.7.25-1.el7                                          </span><br><span class="line">  mysql-community-libs.x86_64 0:5.7.25-1.el7                                           </span><br><span class="line">  mysql-community-libs-compat.x86_64 0:5.7.25-1.el7                                    </span><br><span class="line">  mysql-community-server.x86_64 0:5.7.25-1.el7                                         </span><br><span class="line"></span><br><span class="line">Dependency Installed:</span><br><span class="line">  libaio.x86_64 0:0.3.109-13.el7                                                       </span><br><span class="line"></span><br><span class="line">Replaced:</span><br><span class="line">  mariadb-libs.x86_64 1:5.5.60-1.el7_5                                                 </span><br><span class="line"></span><br><span class="line">Complete!</span><br></pre></td></tr></table></figure><h3 id="2-2MySQL配置"><a href="#2-2MySQL配置" class="headerlink" title="2.2MySQL配置"></a>2.2MySQL配置</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line">启动MySQL</span><br><span class="line">[root@ip-10-0-100-141 ~]# systemctl start mysqld</span><br><span class="line">[root@ip-10-0-100-141 ~]# systemctl status mysqld</span><br><span class="line">● mysqld.service - MySQL Server</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/mysqld.service; enabled; vendor preset: disabled)</span><br><span class="line">   Active: active (running) since Mon 2019-04-22 07:46:26 UTC; 11s ago</span><br><span class="line">     Docs: man:mysqld(8)</span><br><span class="line">           http://dev.mysql.com/doc/refman/en/using-systemd.html</span><br><span class="line">  Process: 4802 ExecStart=/usr/sbin/mysqld --daemonize --pid-file=/var/run/mysqld/mysqld.pid $MYSQLD_OPTS (code=exited, status=0/SUCCESS)</span><br><span class="line">  Process: 4725 ExecStartPre=/usr/bin/mysqld_pre_systemd (code=exited, status=0/SUCCESS)</span><br><span class="line"> Main PID: 4805 (mysqld)</span><br><span class="line">   CGroup: /system.slice/mysqld.service</span><br><span class="line">           └─4805 /usr/sbin/mysqld --daemonize --pid-file=/var/run/mysqld/mysqld.pid...</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Apr 22 07:46:21 ip-10-0-100-141.ap-northeast-1.compute.internal systemd[1]: Starting...</span><br><span class="line">Apr 22 07:46:26 ip-10-0-100-141.ap-northeast-1.compute.internal systemd[1]: Started ...</span><br><span class="line">Hint: Some lines were ellipsized, use -l to show in full.</span><br><span class="line"></span><br><span class="line">确认3306端口已经监听起来</span><br><span class="line">[root@ip-10-0-100-141 ~]# ss -aultn</span><br><span class="line">Netid State      Recv-Q Send-Q Local Address:Port               Peer Address:Port              </span><br><span class="line">udp   UNCONN     0      0             *:68                        *:*                  </span><br><span class="line">udp   UNCONN     0      0      127.0.0.1:323                       *:*                  </span><br><span class="line">udp   UNCONN     0      0           ::1:323                      :::*                  </span><br><span class="line">tcp   LISTEN     0      128           *:22                        *:*                  </span><br><span class="line">tcp   LISTEN     0      100    127.0.0.1:25                        *:*                  </span><br><span class="line">tcp   LISTEN     0      80           :::3306                     :::*                  </span><br><span class="line">tcp   LISTEN     0      128          :::80                       :::*                  </span><br><span class="line">tcp   LISTEN     0      128          :::22                       :::*                  </span><br><span class="line">tcp   LISTEN     0      100         ::1:25                       :::*                  </span><br><span class="line">tcp   LISTEN     0      128          :::443                      :::*</span><br><span class="line"></span><br><span class="line">在日志文件中找出临时密码</span><br><span class="line">[root@ip-10-0-100-141 ~]# grep password /var/log/mysqld.log </span><br><span class="line">2019-04-22T07:46:24.034205Z 1 [Note] A temporary password is generated for root@localhost: HtCqw44K),Li</span><br><span class="line">[root@ip-10-0-100-141 ~]# grep password /var/log/mysqld.log |awk &apos;&#123;print $NF&#125;&apos; </span><br><span class="line">HtCqw44K),Li</span><br><span class="line"></span><br><span class="line">使用获取到的临时密码登录MySQL</span><br><span class="line">[root@ip-10-0-100-141 ~]# mysql -uroot -p&apos;HtCqw44K),Li&apos;</span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 3</span><br><span class="line">Server version: 5.7.25</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2019, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type &apos;help;&apos; or &apos;\h&apos; for help. Type &apos;\c&apos; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">mysql&gt; 看到有这样的标识符则表示成功登录了</span><br><span class="line">注意事项:密码有特殊字符的话,必须要用&apos;&apos;,就像上面那样,否则不能登录</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">修改mysql登录密码</span><br><span class="line">mysql&gt; set global validate_password_policy=0;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; set global validate_password_length=1;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; ALTER USER &apos;root&apos;@&apos;localhost&apos; IDENTIFIED BY &apos;wenhs5479!&apos;;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; quit</span><br><span class="line">Bye</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">为避免mysql自动升级，这里需要卸载最开始安装的yum源</span><br><span class="line">[root@ip-10-0-100-141 ~]# rpm -qa|grep mysql</span><br><span class="line">mysql-community-libs-5.7.25-1.el7.x86_64</span><br><span class="line">mysql-community-libs-compat-5.7.25-1.el7.x86_64</span><br><span class="line">mysql57-community-release-el7-10.noarch</span><br><span class="line">mysql-community-client-5.7.25-1.el7.x86_64</span><br><span class="line">mysql-community-devel-5.7.25-1.el7.x86_64</span><br><span class="line">mysql-community-common-5.7.25-1.el7.x86_64</span><br><span class="line">mysql-community-server-5.7.25-1.el7.x86_64</span><br><span class="line">[root@ip-10-0-100-141 ~]# yum -y remove mysql57-community-release-el7-10.noarch</span><br><span class="line">Loaded plugins: amazon-id, rhui-lb, search-disabled-repos</span><br><span class="line">Resolving Dependencies</span><br><span class="line">--&gt; Running transaction check</span><br><span class="line">---&gt; Package mysql57-community-release.noarch 0:el7-10 will be erased</span><br><span class="line">--&gt; Finished Dependency Resolution</span><br><span class="line">......</span><br><span class="line">  Erasing    : mysql57-community-release-el7-10.noarch                             1/1 </span><br><span class="line">  Verifying  : mysql57-community-release-el7-10.noarch                             1/1 </span><br><span class="line"></span><br><span class="line">Removed:</span><br><span class="line">  mysql57-community-release.noarch 0:el7-10                                            </span><br><span class="line"></span><br><span class="line">Complete!</span><br></pre></td></tr></table></figure><h1 id="3-mysql的程序组成"><a href="#3-mysql的程序组成" class="headerlink" title="3. mysql的程序组成"></a>3. mysql的程序组成</h1><ul><li>客户端<ul><li><input disabled type="checkbox"> mysql：CLI交互式客户端程序</li><li><input disabled type="checkbox"> mysql_secure_installation：安全初始化，强烈建议安装完以后执行此命令</li><li><input disabled type="checkbox"> mysqldump：mysql备份工具</li><li><input disabled type="checkbox"> mysqladmin</li></ul></li><li>服务器端<ul><li><input disabled type="checkbox"> mysqld</li></ul></li></ul><h3 id="3-1-mysql工具使用"><a href="#3-1-mysql工具使用" class="headerlink" title="3.1 mysql工具使用"></a>3.1 mysql工具使用</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">语法：mysql [OPTIONS] [database]</span><br><span class="line">常用的OPTIONS：</span><br><span class="line">    -uUSERNAME      指定用户名，默认为root</span><br><span class="line">    -hHOST          指定服务器主机，默认为localhost，推荐使用ip地址</span><br><span class="line">    -pPASSWORD      指定用户的密码</span><br><span class="line">    -P#             指定数据库监听的端口，这里的#需用实际的端口号代替，如-P3307</span><br><span class="line">    -V              查看当前使用的mysql版本</span><br><span class="line">    -e          不登录mysql执行sql语句后退出，常用于脚本</span><br><span class="line"></span><br><span class="line">[root@ip-10-0-100-141 ~]# mysql -V</span><br><span class="line">mysql  Ver 14.14 Distrib 5.7.25, for Linux (x86_64) using  EditLine wrapper</span><br><span class="line"></span><br><span class="line">[root@ip-10-0-100-141 ~]# mysql -uroot -pwenhs5479! -h127.0.0.1</span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 5</span><br><span class="line">Server version: 5.7.25 MySQL Community Server (GPL)</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2019, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type &apos;help;&apos; or &apos;\h&apos; for help. Type &apos;\c&apos; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">mysql&gt;</span><br><span class="line"></span><br><span class="line">注意，不推荐直接在命令行里直接用-pPASSWORD的方式登录，而是使用-p选项，然后交互式输入密码</span><br><span class="line">[root@ip-10-0-100-141 ~]# mysql -uroot -p -h 127.0.0.1 -e &apos;SHOW DATABASES;&apos;</span><br><span class="line">Enter password: -----&gt;密码不会回显</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| sys                |</span><br><span class="line">+--------------------+</span><br></pre></td></tr></table></figure><h3 id="3-2-服务器监听的两种socket地址"><a href="#3-2-服务器监听的两种socket地址" class="headerlink" title="3.2 服务器监听的两种socket地址"></a>3.2 服务器监听的两种socket地址</h3><p><strong>socket类型</strong></p><ul><li><strong>ip socket</strong>    :默认监听在tcp的3306端口，支持远程通信</li><li><strong>unix sock</strong>    :监听在sock文件上（/tmp/mysql.sock，/var/lib/mysql/mysql.sock） 仅支持本地通信 server地址只能是：localhost，127.0.0.1</li></ul><h1 id="4-mysql数据库操作"><a href="#4-mysql数据库操作" class="headerlink" title="4.mysql数据库操作"></a>4.mysql数据库操作</h1><h3 id="4-1-DDL操作"><a href="#4-1-DDL操作" class="headerlink" title="4.1 DDL操作"></a>4.1 DDL操作</h3><h4 id="4-1-1-数据库操作"><a href="#4-1-1-数据库操作" class="headerlink" title="4.1.1 数据库操作"></a>4.1.1 数据库操作</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">创建数据库</span><br><span class="line">语法：CREATE DATABASE [IF NOT EXISTS] &apos;DB_NAME&apos;;</span><br><span class="line">创建数据库wenhs</span><br><span class="line">mysql&gt; CREATE DATABASE IF NOT EXISTS wenhs;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">查看当前有哪些数据库</span><br><span class="line">mysql&gt; SHOW DATABASES;</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| sys                |</span><br><span class="line">| wenhs              |</span><br><span class="line">+--------------------+</span><br><span class="line">5 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">删除数据库</span><br><span class="line">语法：DROP DATABASE [IF EXISTS] &apos;DB_NAME&apos;;</span><br><span class="line">删除数据库wenhs</span><br><span class="line">mysql&gt; DROP DATABASE IF EXISTS wenhs;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; SHOW DATABASES;</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| sys                |</span><br><span class="line">+--------------------+</span><br><span class="line">4 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure><h4 id="4-1-2-表操作"><a href="#4-1-2-表操作" class="headerlink" title="4.1.2 表操作"></a>4.1.2 表操作</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">创建表</span><br><span class="line">语法：CREATE TABLE table_name (col1 datatype 修饰符,col2 datatype 修饰符) ENGINE=&apos;存储引擎类型&apos;;</span><br><span class="line">在数据库wenhs里创建表jbgsn</span><br><span class="line">mysql&gt; CREATE DATABASE wenhs;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; USE wenhs;进入wenhs数据库</span><br><span class="line">Database changed</span><br><span class="line"></span><br><span class="line">mysql&gt; CREATE TABLE jbgsn (id int NOT NULL,name VARCHAR(100) NOT NULL,age tinyint);</span><br><span class="line">Query OK, 0 rows affected (0.02 sec)</span><br><span class="line"></span><br><span class="line">查看当前数据库有哪些表</span><br><span class="line">mysql&gt; SHOW TABLES;</span><br><span class="line">+-----------------+</span><br><span class="line">| Tables_in_wenhs |</span><br><span class="line">+-----------------+</span><br><span class="line">| jbgsn           |</span><br><span class="line">+-----------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">删除表</span><br><span class="line">语法：DROP TABLE [ IF EXISTS ] &apos;table_name&apos;;</span><br><span class="line">删除表jbgsn</span><br><span class="line">mysql&gt; DROP TABLE jbgsn;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; SHOW TABLES;</span><br><span class="line">Empty set (0.00 sec)</span><br></pre></td></tr></table></figure><h4 id="4-1-3-用户操作"><a href="#4-1-3-用户操作" class="headerlink" title="4.1.3 用户操作"></a>4.1.3 用户操作</h4><blockquote><p>mysql用户帐号由两部分组成，如‘USERNAME’@’HOST’，表示此USERNAME只能从此HOST上远程登录</p></blockquote><p>这里（‘USERNAME’@’HOST’）的HOST用于限制此用户可通过哪些主机远程连接mysql程序，其值可为：</p><ul><li>IP地址，如：10.0.100.141</li><li>通配符<ul><li><input disabled type="checkbox"> %：匹配任意长度的任意字符，常用于设置允许从任何主机登录</li><li><input disabled type="checkbox"> _：匹配任意单个字符</li></ul></li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">数据库用户创建</span><br><span class="line">语法：CREATE USER &apos;username&apos;@&apos;host&apos; [IDENTIFIED BY &apos;password&apos;];</span><br><span class="line">创建数据库用户wenhs</span><br><span class="line">mysql&gt; CREATE USER &apos;wenhs&apos;@&apos;127.0.0.1&apos; IDENTIFIED BY &apos;wenhs5479!&apos;;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">使用新创建的用户和密码登录</span><br><span class="line">[root@ip-10-0-100-141 ~]# mysql -uwenhs -pwenhs5479! -h127.0.0.1</span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 9</span><br><span class="line">Server version: 5.7.25 MySQL Community Server (GPL)</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2019, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type &apos;help;&apos; or &apos;\h&apos; for help. Type &apos;\c&apos; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">mysql&gt;</span><br><span class="line"></span><br><span class="line">删除数据库用户</span><br><span class="line">语法：DROP USER &apos;username&apos;@&apos;host&apos;; </span><br><span class="line">mysql&gt; DROP USER &apos;wenhs&apos;@&apos;127.0.0.1&apos;;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line">注意:自己不能删自己,所以要换root账号登录数据库</span><br></pre></td></tr></table></figure><h4 id="4-1-4-查看命令SHOW"><a href="#4-1-4-查看命令SHOW" class="headerlink" title="4.1.4 查看命令SHOW"></a>4.1.4 查看命令SHOW</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SHOW CHARACTER SET;查看支持的所有字符集</span><br><span class="line">+----------+---------------------------------+---------------------+--------+</span><br><span class="line">| Charset  | Description                     | Default collation   | Maxlen |</span><br><span class="line">+----------+---------------------------------+---------------------+--------+</span><br><span class="line">| big5     | Big5 Traditional Chinese        | big5_chinese_ci     |      2 |</span><br><span class="line">| dec8     | DEC West European               | dec8_swedish_ci     |      1 |</span><br><span class="line">| cp850    | DOS West European               | cp850_general_ci    |      1 |</span><br><span class="line">| hp8      | HP West European                | hp8_english_ci      |      1 |</span><br><span class="line">| koi8r    | KOI8-R Relcom Russian           | koi8r_general_ci    |      1 |</span><br><span class="line">| latin1   | cp1252 West European            | latin1_swedish_ci   |      1 |</span><br><span class="line">| latin2   | ISO 8859-2 Central European     | latin2_general_ci   |      1 |</span><br><span class="line">| swe7     | 7bit Swedish                    | swe7_swedish_ci     |      1 |</span><br><span class="line">| ascii    | US ASCII                        | ascii_general_ci    |      1 |</span><br><span class="line">| ujis     | EUC-JP Japanese                 | ujis_japanese_ci    |      3 |</span><br><span class="line">| sjis     | Shift-JIS Japanese              | sjis_japanese_ci    |      2 |</span><br><span class="line">| hebrew   | ISO 8859-8 Hebrew               | hebrew_general_ci   |      1 |</span><br><span class="line">| tis620   | TIS620 Thai                     | tis620_thai_ci      |      1 |</span><br><span class="line">| euckr    | EUC-KR Korean                   | euckr_korean_ci     |      2 |</span><br><span class="line">| koi8u    | KOI8-U Ukrainian                | koi8u_general_ci    |      1 |</span><br><span class="line">| gb2312   | GB2312 Simplified Chinese       | gb2312_chinese_ci   |      2 |</span><br><span class="line">| greek    | ISO 8859-7 Greek                | greek_general_ci    |      1 |</span><br><span class="line">| cp1250   | Windows Central European        | cp1250_general_ci   |      1 |</span><br><span class="line">| gbk      | GBK Simplified Chinese          | gbk_chinese_ci      |      2 |</span><br><span class="line">| latin5   | ISO 8859-9 Turkish              | latin5_turkish_ci   |      1 |</span><br><span class="line">| armscii8 | ARMSCII-8 Armenian              | armscii8_general_ci |      1 |</span><br><span class="line">| utf8     | UTF-8 Unicode                   | utf8_general_ci     |      3 |</span><br><span class="line">| ucs2     | UCS-2 Unicode                   | ucs2_general_ci     |      2 |</span><br><span class="line">| cp866    | DOS Russian                     | cp866_general_ci    |      1 |</span><br><span class="line">| keybcs2  | DOS Kamenicky Czech-Slovak      | keybcs2_general_ci  |      1 |</span><br><span class="line">| macce    | Mac Central European            | macce_general_ci    |      1 |</span><br><span class="line">| macroman | Mac West European               | macroman_general_ci |      1 |</span><br><span class="line">| cp852    | DOS Central European            | cp852_general_ci    |      1 |</span><br><span class="line">| latin7   | ISO 8859-13 Baltic              | latin7_general_ci   |      1 |</span><br><span class="line">| utf8mb4  | UTF-8 Unicode                   | utf8mb4_general_ci  |      4 |</span><br><span class="line">| cp1251   | Windows Cyrillic                | cp1251_general_ci   |      1 |</span><br><span class="line">| utf16    | UTF-16 Unicode                  | utf16_general_ci    |      4 |</span><br><span class="line">| utf16le  | UTF-16LE Unicode                | utf16le_general_ci  |      4 |</span><br><span class="line">| cp1256   | Windows Arabic                  | cp1256_general_ci   |      1 |</span><br><span class="line">| cp1257   | Windows Baltic                  | cp1257_general_ci   |      1 |</span><br><span class="line">| utf32    | UTF-32 Unicode                  | utf32_general_ci    |      4 |</span><br><span class="line">| binary   | Binary pseudo charset           | binary              |      1 |</span><br><span class="line">| geostd8  | GEOSTD8 Georgian                | geostd8_general_ci  |      1 |</span><br><span class="line">| cp932    | SJIS for Windows Japanese       | cp932_japanese_ci   |      2 |</span><br><span class="line">| eucjpms  | UJIS for Windows Japanese       | eucjpms_japanese_ci |      3 |</span><br><span class="line">| gb18030  | China National Standard GB18030 | gb18030_chinese_ci  |      4 |</span><br><span class="line">+----------+---------------------------------+---------------------+--------+</span><br><span class="line">41 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; SHOW ENGINES;查看当前数据库支持的所有存储引擎</span><br><span class="line">+--------------------+---------+----------------------------------------------------------------+--------------+------+------------+</span><br><span class="line">| Engine             | Support | Comment                                                        | Transactions | XA   | Savepoints |</span><br><span class="line">+--------------------+---------+----------------------------------------------------------------+--------------+------+------------+</span><br><span class="line">| InnoDB             | DEFAULT | Supports transactions, row-level locking, and foreign keys     | YES          | YES  | YES        |</span><br><span class="line">| MRG_MYISAM         | YES     | Collection of identical MyISAM tables                          | NO           | NO   | NO         |</span><br><span class="line">| MEMORY             | YES     | Hash based, stored in memory, useful for temporary tables      | NO           | NO   | NO         |</span><br><span class="line">| BLACKHOLE          | YES     | /dev/null storage engine (anything you write to it disappears) | NO           | NO   | NO         |</span><br><span class="line">| MyISAM             | YES     | MyISAM storage engine                                          | NO           | NO   | NO         |</span><br><span class="line">| CSV                | YES     | CSV storage engine                                             | NO           | NO   | NO         |</span><br><span class="line">| ARCHIVE            | YES     | Archive storage engine                                         | NO           | NO   | NO         |</span><br><span class="line">| PERFORMANCE_SCHEMA | YES     | Performance Schema                                             | NO           | NO   | NO         |</span><br><span class="line">| FEDERATED          | NO      | Federated MySQL storage engine                                 | NULL         | NULL | NULL       |</span><br><span class="line">+--------------------+---------+----------------------------------------------------------------+--------------+------+------------+</span><br><span class="line">9 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; SHOW DATABASES;查看数据库信息</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| sys                |</span><br><span class="line">| wenhs              |</span><br><span class="line">+--------------------+</span><br><span class="line">5 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; SHOW TABLES FROM wenhs;不进入某数据库而列出其包含的所有表</span><br><span class="line">+-----------------+</span><br><span class="line">| Tables_in_wenhs |</span><br><span class="line">+-----------------+</span><br><span class="line">| jbgsn           |</span><br><span class="line">+-----------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">查看表结构</span><br><span class="line">语法：DESC [db_name.]table_name;</span><br><span class="line">mysql&gt; DESC wenhs.jbgsn;</span><br><span class="line">+-------+--------------+------+-----+---------+-------+</span><br><span class="line">| Field | Type         | Null | Key | Default | Extra |</span><br><span class="line">+-------+--------------+------+-----+---------+-------+</span><br><span class="line">| id    | int(11)      | NO   |     | NULL    |       |</span><br><span class="line">| name  | varchar(100) | NO   |     | NULL    |       |</span><br><span class="line">| age   | tinyint(4)   | YES  |     | NULL    |       |</span><br><span class="line">+-------+--------------+------+-----+---------+-------+</span><br><span class="line">3 rows in set (0.01 sec)</span><br><span class="line"></span><br><span class="line">查看某表的创建命令</span><br><span class="line">语法：SHOW CREATE TABLE table_name;</span><br><span class="line">mysql&gt; SHOW CREATE TABLE wenhs.jbgsn;</span><br><span class="line">+-------+--------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| Table | Create Table                                                                                                                                           |</span><br><span class="line">+-------+--------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| jbgsn | CREATE TABLE `jbgsn` (</span><br><span class="line">  `id` int(11) NOT NULL,</span><br><span class="line">  `name` varchar(100) NOT NULL,</span><br><span class="line">  `age` tinyint(4) DEFAULT NULL</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=latin1 |</span><br><span class="line">+-------+--------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">查看某表的状态</span><br><span class="line">语法：SHOW TABLE STATUS LIKE &apos;table_name&apos;\G</span><br><span class="line">mysql&gt; SHOW TABLE STATUS LIKE &apos;jbgsn&apos;\G;</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">           Name: jbgsn</span><br><span class="line">         Engine: InnoDB</span><br><span class="line">        Version: 10</span><br><span class="line">     Row_format: Dynamic</span><br><span class="line">           Rows: 0</span><br><span class="line"> Avg_row_length: 0</span><br><span class="line">    Data_length: 16384</span><br><span class="line">Max_data_length: 0</span><br><span class="line">   Index_length: 0</span><br><span class="line">      Data_free: 0</span><br><span class="line"> Auto_increment: NULL</span><br><span class="line">    Create_time: 2019-04-22 10:54:02</span><br><span class="line">    Update_time: NULL</span><br><span class="line">     Check_time: NULL</span><br><span class="line">      Collation: latin1_swedish_ci</span><br><span class="line">       Checksum: NULL</span><br><span class="line"> Create_options: </span><br><span class="line">        Comment: </span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure><h4 id="4-1-5-获取帮助"><a href="#4-1-5-获取帮助" class="headerlink" title="4.1.5 获取帮助"></a>4.1.5 获取帮助</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">获取命令使用帮助</span><br><span class="line">语法：HELP keyword;</span><br><span class="line"></span><br><span class="line">mysql&gt; HELP CREATE TABLE;获取创建表的帮助</span><br><span class="line">Name: &apos;CREATE TABLE&apos;</span><br><span class="line">Description:</span><br><span class="line">Syntax:</span><br><span class="line">CREATE [TEMPORARY] TABLE [IF NOT EXISTS] tbl_name</span><br><span class="line">    (create_definition,...)</span><br><span class="line">    [table_options]</span><br><span class="line">    [partition_options]</span><br><span class="line"></span><br><span class="line">CREATE [TEMPORARY] TABLE [IF NOT EXISTS] tbl_name</span><br><span class="line">    [(create_definition,...)]</span><br><span class="line">    [table_options]</span><br><span class="line">    [partition_options]</span><br><span class="line">    [IGNORE | REPLACE]</span><br><span class="line">    [AS] query_expression</span><br><span class="line"></span><br><span class="line">CREATE [TEMPORARY] TABLE [IF NOT EXISTS] tbl_name</span><br><span class="line">    &#123; LIKE old_tbl_name | (LIKE old_tbl_name) &#125;</span><br><span class="line">.......</span><br></pre></td></tr></table></figure><h3 id="4-2-DML操作"><a href="#4-2-DML操作" class="headerlink" title="4.2 DML操作"></a>4.2 DML操作</h3><p><strong>DML操作包括增(INSERT)、删(DELETE)、改(UPDATE)、查(SELECT)，均属针对表的操作。</strong></p><h4 id="4-2-1-INSERT语句"><a href="#4-2-1-INSERT语句" class="headerlink" title="4.2.1 INSERT语句"></a>4.2.1 INSERT语句</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">DML操作之增操作insert</span><br><span class="line">修改字段类型:alter table tb_name modify column 字段名 data_type;</span><br><span class="line">语法：INSERT [INTO] table_name [(column_name,...)] &#123;VALUES | VALUE&#125; (value1,...),(...),...;</span><br><span class="line">INSERT INTO tb_name VALUE(value1,value2,...);完整插入一条记录</span><br><span class="line">INSERT INTO tb_name VALUES(value1,value2,...),(value1,value2,...),...;完整插入多条记录</span><br><span class="line">INSERT INTO tb_name(key1,key2,...) VALUE(value1,value2,...);给指定字段插入一条记录</span><br><span class="line">INSERT INTO tb_name(key1,key2,...) VALUES(value1,value2,...),(value1,value2,...),...;给指定字段插入多条记录</span><br><span class="line">mysql&gt; USE wenhs;</span><br><span class="line">Database changed</span><br><span class="line">mysql&gt; INSERT INTO jbgsn (id,name,age) VALUE (1,&apos;tom&apos;,20);一次插入一条记录</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line">mysql&gt; INSERT INTO jbgsn (id,name,age) VALUES (2,&apos;nbhr&apos;,23),(3,&apos;whs&apos;,25),(4,&apos;wen&apos;,28),(55,&apos;ym&apos;,26),(6,&apos;wuym&apos;,20),(7,&apos;expl&apos;,NULL);</span><br><span class="line">Query OK, 6 rows affected (0.00 sec)</span><br><span class="line">Records: 6  Duplicates: 0  Warnings: 0一次插入多条记录</span><br><span class="line">mysql&gt; INSERT INTO jbgsn(name,id) VALUES(&apos;bhg&apos;,93),(&apos;mnb&apos;,67),(&apos;jkl&apos;,85),(&apos;fg&apos;,75),(&apos;dbffd&apos;,27),(&apos;fsdf&apos;,43);</span><br><span class="line">Query OK, 6 rows affected (0.01 sec)</span><br><span class="line">Records: 6  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from jbgsn;</span><br><span class="line">+----+------+------+</span><br><span class="line">| id | name | age  |</span><br><span class="line">+----+------+------+</span><br><span class="line">|  1 | tom  |   20 |</span><br><span class="line">|  2 | nbhr |   23 |</span><br><span class="line">|  3 | whs  |   25 |</span><br><span class="line">|  4 | wen  |   28 |</span><br><span class="line">|  5 | ym   |   26 |</span><br><span class="line">|  6 | wuym |   20 |</span><br><span class="line">|  7 | expl | NULL |</span><br><span class="line">| 93 | bhg  | NULL |</span><br><span class="line">| 67 | mnb  | NULL |</span><br><span class="line">| 85 | jkl  | NULL |</span><br><span class="line">| 75 | fg   | NULL |</span><br><span class="line">| 27 | dbfd | NULL |</span><br><span class="line">| 43 | fsdf | NULL |</span><br><span class="line">+----+------+------+</span><br><span class="line">13 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure><h4 id="4-2-2-SELECT语句"><a href="#4-2-2-SELECT语句" class="headerlink" title="4.2.2 SELECT语句"></a>4.2.2 SELECT语句</h4><p><strong>字段column表示法</strong></p><table><thead><tr><th>表示符</th><th>代表什么？</th></tr></thead><tbody><tr><td>*</td><td>所有字段</td></tr><tr><td>as</td><td>字段别名，如col1 AS alias1<br>当表名很长时用别名代替</td></tr></tbody></table><p><strong>条件判断语句WHERE</strong></p><table><thead><tr><th>操作类型</th><th>常用操作符</th></tr></thead><tbody><tr><td>操作符</td><td>&gt;，&lt;，&gt;=，&lt;=，=，!=<br>BETWEEN column# AND column#<br>LIKE：模糊匹配<br>RLIKE：基于正则表达式进行模式匹配<br>ISNOT NULL：非空<br>IS NULL：空</td></tr><tr><td>条件逻辑操作</td><td>AND<br>OR<br>NOT</td></tr></tbody></table><p><strong>ORDER BY：排序，默认为升序（ASC）</strong></p><table><thead><tr><th>ORDER BY语句</th><th>意义</th></tr></thead><tbody><tr><td>ORDER BY ‘column_name’</td><td>根据column_name进行升序排序</td></tr><tr><td>ORDER BY ‘column_name’ DESC</td><td>根据column_name进行降序排序</td></tr><tr><td>ORDER BY ’column_name’ LIMIT 2</td><td>根据column_name进行升序排序<br>并只取前2个结果</td></tr><tr><td>ORDER BY ‘column_name’ LIMIT 1,2</td><td>根据column_name进行升序排序<br>并且略过第1个结果取后面的2个结果</td></tr></tbody></table><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br></pre></td><td class="code"><pre><span class="line">DML操作之查操作select</span><br><span class="line">语法：SELECT column1,column2,... FROM table_name [WHERE clause] [ORDER BY &apos;column_name&apos; [DESC]] [LIMIT [m,]n];</span><br><span class="line"></span><br><span class="line">mysql&gt; SELECT * FROM jbgsn;原表情况,下列查询语句均为此表操作</span><br><span class="line">+----+------+------+</span><br><span class="line">| id | name | age  |</span><br><span class="line">+----+------+------+</span><br><span class="line">|  1 | tom  |   20 |</span><br><span class="line">|  2 | nbhr |   23 |</span><br><span class="line">|  3 | whs  |   25 |</span><br><span class="line">|  4 | wen  |   28 |</span><br><span class="line">|  5 | ym   |   26 |</span><br><span class="line">|  6 | wuym |   20 |</span><br><span class="line">|  7 | expl | NULL |</span><br><span class="line">| 93 | bhg  | NULL |</span><br><span class="line">| 67 | mnb  | NULL |</span><br><span class="line">| 85 | jkl  | NULL |</span><br><span class="line">| 75 | fg   | NULL |</span><br><span class="line">| 27 | dbfd | NULL |</span><br><span class="line">| 43 | fsdf | NULL |</span><br><span class="line">+----+------+------+</span><br><span class="line">13 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; SELECT name,age FROM jbgsn WHERE age BETWEEN 21 AND 27;</span><br><span class="line">+------+------+</span><br><span class="line">| name | age  |</span><br><span class="line">+------+------+</span><br><span class="line">| nbhr |   23 |</span><br><span class="line">| whs  |   25 |</span><br><span class="line">| ym   |   26 |</span><br><span class="line">+------+------+</span><br><span class="line">3 rows in set (0.01 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; SELECT * FROM jbgsn WHERE name LIKE &apos;y&apos;;</span><br><span class="line">Empty set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; SELECT * FROM jbgsn WHERE name LIKE &apos;y%&apos;;</span><br><span class="line">+----+------+------+</span><br><span class="line">| id | name | age  |</span><br><span class="line">+----+------+------+</span><br><span class="line">|  5 | ym   |   26 |</span><br><span class="line">+----+------+------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; SELECT * FROM jbgsn WHERE name LIKE &apos;w%&apos;;</span><br><span class="line">+----+------+------+</span><br><span class="line">| id | name | age  |</span><br><span class="line">+----+------+------+</span><br><span class="line">|  3 | whs  |   25 |</span><br><span class="line">|  4 | wen  |   28 |</span><br><span class="line">|  6 | wuym |   20 |</span><br><span class="line">+----+------+------+</span><br><span class="line">3 rows in set (0.01 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; SELECT * FROM jbgsn WHERE name LIKE &apos;w*&apos;;</span><br><span class="line">Empty set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; SELECT * FROM jbgsn WHERE name RLIKE &apos;w*&apos;;</span><br><span class="line">+----+------+------+</span><br><span class="line">| id | name | age  |</span><br><span class="line">+----+------+------+</span><br><span class="line">|  1 | tom  |   20 |</span><br><span class="line">|  2 | nbhr |   23 |</span><br><span class="line">|  3 | whs  |   25 |</span><br><span class="line">|  4 | wen  |   28 |</span><br><span class="line">|  5 | ym   |   26 |</span><br><span class="line">|  6 | wuym |   20 |</span><br><span class="line">|  7 | expl | NULL |</span><br><span class="line">| 93 | bhg  | NULL |</span><br><span class="line">| 67 | mnb  | NULL |</span><br><span class="line">| 85 | jkl  | NULL |</span><br><span class="line">| 75 | fg   | NULL |</span><br><span class="line">| 27 | dbfd | NULL |</span><br><span class="line">| 43 | fsdf | NULL |</span><br><span class="line">+----+------+------+</span><br><span class="line">13 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; SELECT * FROM jbgsn WHERE name RLIKE &apos;w%&apos;;</span><br><span class="line">Empty set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; SELECT * FROM jbgsn WHERE age IS null;</span><br><span class="line">+----+------+------+</span><br><span class="line">| id | name | age  |</span><br><span class="line">+----+------+------+</span><br><span class="line">|  7 | expl | NULL |</span><br><span class="line">| 93 | bhg  | NULL |</span><br><span class="line">| 67 | mnb  | NULL |</span><br><span class="line">| 85 | jkl  | NULL |</span><br><span class="line">| 75 | fg   | NULL |</span><br><span class="line">| 27 | dbfd | NULL |</span><br><span class="line">| 43 | fsdf | NULL |</span><br><span class="line">+----+------+------+</span><br><span class="line">7 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; SELECT * FROM jbgsn WHERE age IS NOT null;</span><br><span class="line">+----+------+------+</span><br><span class="line">| id | name | age  |</span><br><span class="line">+----+------+------+</span><br><span class="line">|  1 | tom  |   20 |</span><br><span class="line">|  2 | nbhr |   23 |</span><br><span class="line">|  3 | whs  |   25 |</span><br><span class="line">|  4 | wen  |   28 |</span><br><span class="line">|  5 | ym   |   26 |</span><br><span class="line">|  6 | wuym |   20 |</span><br><span class="line">+----+------+------+</span><br><span class="line">6 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; SELECT * FROM jbgsn ORDER BY id;按id字段升序排序</span><br><span class="line">+----+------+------+</span><br><span class="line">| id | name | age  |</span><br><span class="line">+----+------+------+</span><br><span class="line">|  1 | tom  |   20 |</span><br><span class="line">|  2 | nbhr |   23 |</span><br><span class="line">|  3 | whs  |   25 |</span><br><span class="line">|  4 | wen  |   28 |</span><br><span class="line">|  5 | ym   |   26 |</span><br><span class="line">|  6 | wuym |   20 |</span><br><span class="line">|  7 | expl | NULL |</span><br><span class="line">| 27 | dbfd | NULL |</span><br><span class="line">| 43 | fsdf | NULL |</span><br><span class="line">| 67 | mnb  | NULL |</span><br><span class="line">| 75 | fg   | NULL |</span><br><span class="line">| 85 | jkl  | NULL |</span><br><span class="line">| 93 | bhg  | NULL |</span><br><span class="line">+----+------+------+</span><br><span class="line">13 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; SELECT * FROM jbgsn ORDER BY id DESC;按id字段降序排序</span><br><span class="line">+----+------+------+</span><br><span class="line">| id | name | age  |</span><br><span class="line">+----+------+------+</span><br><span class="line">| 93 | bhg  | NULL |</span><br><span class="line">| 85 | jkl  | NULL |</span><br><span class="line">| 75 | fg   | NULL |</span><br><span class="line">| 67 | mnb  | NULL |</span><br><span class="line">| 43 | fsdf | NULL |</span><br><span class="line">| 27 | dbfd | NULL |</span><br><span class="line">|  7 | expl | NULL |</span><br><span class="line">|  6 | wuym |   20 |</span><br><span class="line">|  5 | ym   |   26 |</span><br><span class="line">|  4 | wen  |   28 |</span><br><span class="line">|  3 | whs  |   25 |</span><br><span class="line">|  2 | nbhr |   23 |</span><br><span class="line">|  1 | tom  |   20 |</span><br><span class="line">+----+------+------+</span><br><span class="line">13 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; SELECT * FROM jbgsn WHERE age IS NOT NULL ORDER BY id DESC;取出age非空的字段并对id进行降序排序</span><br><span class="line">+----+------+------+</span><br><span class="line">| id | name | age  |</span><br><span class="line">+----+------+------+</span><br><span class="line">|  6 | wuym |   20 |</span><br><span class="line">|  5 | ym   |   26 |</span><br><span class="line">|  4 | wen  |   28 |</span><br><span class="line">|  3 | whs  |   25 |</span><br><span class="line">|  2 | nbhr |   23 |</span><br><span class="line">|  1 | tom  |   20 |</span><br><span class="line">+----+------+------+</span><br><span class="line">6 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; SELECT * FROM jbgsn WHERE age IS NOT NULL ORDER BY age DESC LIMIT 1,3;</span><br><span class="line">+----+------+------+取出age字段非空的记录并对其进行降序排序,然后跳过第一条记录,取3条记录</span><br><span class="line">| id | name | age  |order by 必须放在where语句后面</span><br><span class="line">+----+------+------+</span><br><span class="line">|  5 | ym   |   26 |</span><br><span class="line">|  3 | whs  |   25 |</span><br><span class="line">|  2 | nbhr |   23 |</span><br><span class="line">+----+------+------+</span><br><span class="line">3 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure><h4 id="4-2-3-update语句"><a href="#4-2-3-update语句" class="headerlink" title="4.2.3 update语句"></a>4.2.3 update语句</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">DML操作之改操作update</span><br><span class="line">语法：UPDATE table_name SET column1 = new_value1[,column2 = new_value2,...] [WHERE clause] [ORDER BY &apos;column_name&apos; [DESC]] [LIMIT [m,]n];</span><br><span class="line">mysql&gt; select * from jbgsn;</span><br><span class="line">+----+------+------+</span><br><span class="line">| id | name | age  |</span><br><span class="line">+----+------+------+</span><br><span class="line">|  1 | tom  |   20 |</span><br><span class="line">|  2 | nbhr |   23 |</span><br><span class="line">|  3 | whs  |   25 |</span><br><span class="line">|  4 | wen  |   28 |</span><br><span class="line">|  5 | ym   |   26 |</span><br><span class="line">|  6 | wuym |   20 |</span><br><span class="line">|  7 | expl | NULL |</span><br><span class="line">| 93 | bhg  | NULL |</span><br><span class="line">| 67 | mnb  | NULL |</span><br><span class="line">| 85 | jkl  | NULL |</span><br><span class="line">| 75 | fg   | NULL |</span><br><span class="line">| 27 | dbfd | NULL |</span><br><span class="line">| 43 | fsdf | NULL |</span><br><span class="line">+----+------+------+</span><br><span class="line">13 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; UPDATE jbgsn SET age = 88 WHERE name = &apos;tom&apos;;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line">Rows matched: 1  Changed: 1  Warnings: 0</span><br><span class="line"></span><br><span class="line">mysql&gt; UPDATE jbgsn SET age = 66,id = 66  WHERE name = &apos;whs&apos;;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)更新一条记录里面的多个字段</span><br><span class="line">Rows matched: 1  Changed: 1  Warnings: 0</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from jbgsn;</span><br><span class="line">+----+------+------+</span><br><span class="line">| id | name | age  |</span><br><span class="line">+----+------+------+</span><br><span class="line">|  1 | tom  |   88 |</span><br><span class="line">|  2 | nbhr |   23 |</span><br><span class="line">| 66 | whs  |   66 |</span><br><span class="line">|  4 | wen  |   28 |</span><br><span class="line">|  5 | ym   |   26 |</span><br><span class="line">|  6 | wuym |   20 |</span><br><span class="line">|  7 | expl | NULL |</span><br><span class="line">| 93 | bhg  | NULL |</span><br><span class="line">| 67 | mnb  | NULL |</span><br><span class="line">| 85 | jkl  | NULL |</span><br><span class="line">| 75 | fg   | NULL |</span><br><span class="line">| 27 | dbfd | NULL |</span><br><span class="line">| 43 | fsdf | NULL |</span><br><span class="line">+----+------+------+</span><br><span class="line">13 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure><h4 id="4-2-4-delete语句"><a href="#4-2-4-delete语句" class="headerlink" title="4.2.4 delete语句"></a>4.2.4 delete语句</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">DML操作之删操作delete</span><br><span class="line">语法：DELETE FROM table_name [WHERE clause] [ORDER BY &apos;column_name&apos; [DESC]] [LIMIT [m,]n];</span><br><span class="line">mysql&gt; DELETE FROM jbgsn WHERE id = 1;删除某条记录</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from jbgsn;</span><br><span class="line">+----+------+------+</span><br><span class="line">| id | name | age  |</span><br><span class="line">+----+------+------+</span><br><span class="line">|  2 | nbhr |   23 |</span><br><span class="line">| 66 | whs  |   66 |</span><br><span class="line">|  4 | wen  |   28 |</span><br><span class="line">|  5 | ym   |   26 |</span><br><span class="line">|  6 | wuym |   20 |</span><br><span class="line">|  7 | expl | NULL |</span><br><span class="line">| 93 | bhg  | NULL |</span><br><span class="line">| 67 | mnb  | NULL |</span><br><span class="line">| 85 | jkl  | NULL |</span><br><span class="line">| 75 | fg   | NULL |</span><br><span class="line">| 27 | dbfd | NULL |</span><br><span class="line">| 43 | fsdf | NULL |</span><br><span class="line">+----+------+------+</span><br><span class="line">12 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; DELETE FROM jbgsn;删除整张表的内容</span><br><span class="line">Query OK, 12 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from jbgsn;</span><br><span class="line">Empty set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; SHOW TABLES;</span><br><span class="line">+-----------------+</span><br><span class="line">| Tables_in_wenhs |</span><br><span class="line">+-----------------+</span><br><span class="line">| jbgsn           |</span><br><span class="line">+-----------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; DESC jbgsn;</span><br><span class="line">+-------+--------------+------+-----+---------+-------+</span><br><span class="line">| Field | Type         | Null | Key | Default | Extra |</span><br><span class="line">+-------+--------------+------+-----+---------+-------+</span><br><span class="line">| id    | int(11)      | NO   |     | NULL    |       |</span><br><span class="line">| name  | varchar(100) | NO   |     | NULL    |       |</span><br><span class="line">| age   | tinyint(4)   | YES  |     | NULL    |       |</span><br><span class="line">+-------+--------------+------+-----+---------+-------+</span><br><span class="line">3 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure><h4 id="4-2-5-truncate语句"><a href="#4-2-5-truncate语句" class="headerlink" title="4.2.5 truncate语句"></a>4.2.5 truncate语句</h4><p><strong>truncate与delete的区别：</strong></p><table><thead><tr><th>语句类型</th><th>特点</th></tr></thead><tbody><tr><td>delete</td><td>DELETE删除表内容时仅删除内容，但会保留表结构<br>DELETE语句每次删除一行，并在事务日志中为所删除的每行记录一项<br>可以过回滚事务日志恢复数据<br>非常占用空间</td></tr><tr><td>truncate</td><td>删除表中所有数据，且无法恢复<br>表结构、约束和索引等保持不变，新添加的行计数值重置为初始值<br>执行速度比DELETE快，且使用的系统和事务日志资源少<br>通过释放存储表数据所用的数据页来删除数据，并且只在事务日志中记录页的释放<br>对于有外键约束引用的表，不能使用TRUNCATE TABLE删除数据<br>不能用于加入了索引视图的表</td></tr></tbody></table><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">语法：TRUNCATE table_name;</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from jbgsn;</span><br><span class="line">+----+-----------+------+</span><br><span class="line">| id | name      | age  |</span><br><span class="line">+----+-----------+------+</span><br><span class="line">|  1 | tom       |   20 |</span><br><span class="line">|  2 | jerry     |   23 |</span><br><span class="line">|  3 | whs       |   25 |</span><br><span class="line">|  4 | shen      |   28 |</span><br><span class="line">|  5 | zsdfcddan |   26 |</span><br><span class="line">|  6 | adwffdsan |   20 |</span><br><span class="line">|  7 | scfs      | NULL |</span><br><span class="line">+----+-----------+------+</span><br><span class="line">7 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; truncate table jbgsn;这个table可加可不加</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from jbgsn;</span><br><span class="line">Empty set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; DESC jbgsn;                                                                  </span><br><span class="line">+-------+--------------+------+-----+---------+-------+</span><br><span class="line">| Field | Type         | Null | Key | Default | Extra |</span><br><span class="line">+-------+--------------+------+-----+---------+-------+</span><br><span class="line">| id    | int(11)      | NO   |     | NULL    |       |</span><br><span class="line">| name  | varchar(100) | NO   |     | NULL    |       |</span><br><span class="line">| age   | tinyint(4)   | YES  |     | NULL    |       |</span><br><span class="line">+-------+--------------+------+-----+---------+-------+</span><br><span class="line">3 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure><h3 id="4-3-DCL操作"><a href="#4-3-DCL操作" class="headerlink" title="4.3 DCL操作"></a>4.3 DCL操作</h3><h4 id="4-3-1-创建授权grant"><a href="#4-3-1-创建授权grant" class="headerlink" title="4.3.1 创建授权grant"></a>4.3.1 创建授权grant</h4><p><strong>权限类型(priv_type)</strong></p><table><thead><tr><th>权限类型</th><th>代表什么？</th></tr></thead><tbody><tr><td>ALL</td><td>所有权限</td></tr><tr><td>SELECT</td><td>读取内容的权限</td></tr><tr><td>INSERT</td><td>插入内容的权限</td></tr><tr><td>UPDATE</td><td>更新内容的权限</td></tr><tr><td>DELETE</td><td>删除内容的权限</td></tr></tbody></table><p><strong>指定要操作的对象db_name.table_name</strong></p><table><thead><tr><th>表示方式</th><th>意义</th></tr></thead><tbody><tr><td>*.*</td><td>所有库的所有表</td></tr><tr><td>db_name</td><td>指定库的所有表</td></tr><tr><td>db_name.table_name</td><td>指定库的指定表</td></tr></tbody></table><blockquote><p>WITH GRANT OPTION：被授权的用户可将自己的权限副本转赠给其他用户，说白点就是将自己的权限完全复制给另一个用户。不建议使用。</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">语法:GRANT priv_type,... ON [object_type] db_name.table_name TO ‘username&apos;@&apos;host&apos; [IDENTIFIED BY &apos;password&apos;] [WITH GRANT OPTION];</span><br><span class="line">mysql&gt; SHOW DATABASES;</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| sys                |</span><br><span class="line">| wenhs              |</span><br><span class="line">+--------------------+</span><br><span class="line">5 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">授权wenhs用户在数据库本机上登录访问所有数据库</span><br><span class="line">mysql&gt; GRANT ALL ON *.* TO &apos;wenhs&apos;@&apos;localhost&apos; IDENTIFIED BY &apos;WSFwdaSDFF3232?:&quot;&lt;&gt;&apos;;</span><br><span class="line">Query OK, 0 rows affected, 1 warning (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; GRANT ALL ON *.* TO &apos;wenhs&apos;@&apos;127.0.0.1&apos; IDENTIFIED BY &apos;WSFwdaSDFF3232?:&quot;&lt;&gt;&apos;;</span><br><span class="line">Query OK, 0 rows affected, 1 warning (0.00 sec)</span><br><span class="line"></span><br><span class="line">授权wenhs用户在10.0.100.111上远程登录访问wenhs数据库</span><br><span class="line">mysql&gt; GRANT ALL ON wenhs.* TO &apos;wenhs&apos;@&apos;10.0.100.111&apos; IDENTIFIED BY &apos;WSFwdaSDFF3232?:&quot;&lt;&gt;&apos;; </span><br><span class="line">Query OK, 0 rows affected, 1 warning (0.00 sec)</span><br><span class="line"></span><br><span class="line">授权wenhs用户在所有位置上远程登录访问wenhs数据库</span><br><span class="line">mysql&gt; GRANT ALL ON *.* TO &apos;wenhs&apos;@&apos;%&apos; IDENTIFIED BY &apos;WSFwdaSDFF3232?:&quot;&lt;&gt;&apos;;</span><br><span class="line">Query OK, 0 rows affected, 1 warning (0.00 sec)</span><br></pre></td></tr></table></figure><h4 id="4-3-2-查看授权"><a href="#4-3-2-查看授权" class="headerlink" title="4.3.2 查看授权"></a>4.3.2 查看授权</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">查看当前登录用户的授权信息</span><br><span class="line">mysql&gt; SHOW GRANTS;</span><br><span class="line">+---------------------------------------------------------------------+</span><br><span class="line">| Grants for root@localhost                                           |</span><br><span class="line">+---------------------------------------------------------------------+</span><br><span class="line">| GRANT ALL PRIVILEGES ON *.* TO &apos;root&apos;@&apos;localhost&apos; WITH GRANT OPTION |</span><br><span class="line">| GRANT PROXY ON &apos;&apos;@&apos;&apos; TO &apos;root&apos;@&apos;localhost&apos; WITH GRANT OPTION        |</span><br><span class="line">+---------------------------------------------------------------------+</span><br><span class="line">2 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">查看指定用户wenhs的授权信息</span><br><span class="line">mysql&gt; SHOW GRANTS FOR wenhs;</span><br><span class="line">+--------------------------------------------+</span><br><span class="line">| Grants for wenhs@%                         |</span><br><span class="line">+--------------------------------------------+</span><br><span class="line">| GRANT ALL PRIVILEGES ON *.* TO &apos;wenhs&apos;@&apos;%&apos; |</span><br><span class="line">+--------------------------------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line">mysql&gt; SHOW GRANTS FOR &apos;wenhs&apos;@&apos;127.0.0.1&apos;;</span><br><span class="line">+----------------------------------------------------+</span><br><span class="line">| Grants for wenhs@127.0.0.1                         |</span><br><span class="line">+----------------------------------------------------+</span><br><span class="line">| GRANT ALL PRIVILEGES ON *.* TO &apos;wenhs&apos;@&apos;127.0.0.1&apos; |</span><br><span class="line">+----------------------------------------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; SHOW GRANTS FOR &apos;wenhs&apos;@&apos;localhost&apos;;</span><br><span class="line">+----------------------------------------------------+</span><br><span class="line">| Grants for wenhs@localhost                         |</span><br><span class="line">+----------------------------------------------------+</span><br><span class="line">| GRANT ALL PRIVILEGES ON *.* TO &apos;wenhs&apos;@&apos;localhost&apos; |</span><br><span class="line">+----------------------------------------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure><h4 id="4-3-3-取消授权REVOKE"><a href="#4-3-3-取消授权REVOKE" class="headerlink" title="4.3.3 取消授权REVOKE"></a>4.3.3 取消授权REVOKE</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">语法：REVOKE priv_type,... ON db_name.table_name FROM &apos;username&apos;@&apos;host&apos;;</span><br><span class="line">mysql&gt; REVOKE ALL ON *.* FROM &apos;wenhs&apos;@&apos;10.0.100.111&apos;;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; FLUSH PRIVILEGES;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure><p><strong>注意：mysql服务进程启动时会读取mysql库中的所有授权表至内存中：</strong></p><ul><li>GRANT或REVOKE等执行权限操作会保存于表中，mysql的服务进程会自动重读授权表，并更新至内存中</li><li>对于不能够或不能及时重读授权表的命令，可手动让mysql的服务进程重读授权表</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; FLUSH PRIVILEGES;</span><br></pre></td></tr></table></figure><h2 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h2><h5 id="1-创建一个以你名字为名的数据库，并创建一张表student，该表包含三个字段（id，name，age），表结构如下："><a href="#1-创建一个以你名字为名的数据库，并创建一张表student，该表包含三个字段（id，name，age），表结构如下：" class="headerlink" title="1.创建一个以你名字为名的数据库，并创建一张表student，该表包含三个字段（id，name，age），表结构如下："></a>1.创建一个以你名字为名的数据库，并创建一张表student，该表包含三个字段（id，name，age），表结构如下：</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; CREATE DATABASE IF NOT EXISTS wenhongsheng;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; USE wenhongsheng;</span><br><span class="line">Database changed</span><br><span class="line">mysql&gt; CREATE TABLE student (id int primary key auto_increment NOT NULL,name VARCHAR(100) NOT NULL,age tinyint);</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; DESC student;</span><br><span class="line">+-------+--------------+------+-----+---------+-------+</span><br><span class="line">| Field | Type         | Null | Key | Default | Extra |</span><br><span class="line">+-------+--------------+------+-----+---------+-------+</span><br><span class="line">| id    | int(11)      | NO   |     | NULL    |       |</span><br><span class="line">| name  | varchar(100) | NO   |     | NULL    |       |</span><br><span class="line">| age   | tinyint(4)   | YES  |     | NULL    |       |</span><br><span class="line">+-------+--------------+------+-----+---------+-------+</span><br><span class="line">3 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure><h5 id="2-查看下该新建的表有无内容（用select语句）"><a href="#2-查看下该新建的表有无内容（用select语句）" class="headerlink" title="2.查看下该新建的表有无内容（用select语句）"></a>2.查看下该新建的表有无内容（用select语句）</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT * FROM student;</span><br><span class="line">Empty set (0.00 sec)</span><br></pre></td></tr></table></figure><h5 id="3-往新建的student表中插入数据（用insert语句），结果应如下所示："><a href="#3-往新建的student表中插入数据（用insert语句），结果应如下所示：" class="headerlink" title="3.往新建的student表中插入数据（用insert语句），结果应如下所示："></a>3.往新建的student表中插入数据（用insert语句），结果应如下所示：</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; insert into student values(1,&apos;tom&apos;,20),(2,&apos;jerry&apos;,23),(3,&apos;wangqing&apos;,25),(4,&apos;sean&apos;,28),</span><br><span class="line">    -&gt; (5,&apos;zhangshan&apos;,26),(6,&apos;zhangshan&apos;,20),(7,&apos;lisi&apos;,null),(8,&apos;chenshuo&apos;,10),(9,&apos;wangwu&apos;,3),</span><br><span class="line">    -&gt; (10,&apos;qiuyi&apos;,15),(11,&apos;qiuxiaotian&apos;,20);</span><br><span class="line">Query OK, 11 rows affected (0.00 sec)</span><br><span class="line">Records: 11  Duplicates: 0  Warnings: 0</span><br><span class="line">mysql&gt; select * from student;     #查询表内容</span><br><span class="line">+----+-------------+------+</span><br><span class="line">| id | name        | age  |</span><br><span class="line">+----+-------------+------+</span><br><span class="line">|  1 | tom         |   20 |</span><br><span class="line">|  2 | jerry       |   23 |</span><br><span class="line">|  3 | wangqing    |   25 |</span><br><span class="line">|  4 | sean        |   28 |</span><br><span class="line">|  5 | zhangshan   |   26 |</span><br><span class="line">|  6 | zhangshan   |   20 |</span><br><span class="line">|  7 | lisi        | NULL |</span><br><span class="line">|  8 | chenshuo    |   10 |</span><br><span class="line">|  9 | wangwu      |    3 |</span><br><span class="line">| 10 | qiuyi       |   15 |</span><br><span class="line">| 11 | qiuxiaotian |   20 |</span><br><span class="line">+----+-------------+------+</span><br><span class="line">11 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure><h5 id="4-修改lisi的年龄为50"><a href="#4-修改lisi的年龄为50" class="headerlink" title="4.修改lisi的年龄为50"></a>4.修改lisi的年龄为50</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; UPDATE student SET age = 50 WHERE name = &apos;lisi&apos;;                                        </span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line">Rows matched: 1  Changed: 1  Warnings: 0</span><br><span class="line"></span><br><span class="line">mysql&gt; SELECT * FROM student;</span><br><span class="line">+----+-------------+------+</span><br><span class="line">| id | name        | age  |</span><br><span class="line">+----+-------------+------+</span><br><span class="line">|  1 | tom         |   20 |</span><br><span class="line">|  2 | jerry       |   23 |</span><br><span class="line">|  3 | wangqing    |   25 |</span><br><span class="line">|  4 | sean        |   28 |</span><br><span class="line">|  5 | zhangshan   |   26 |</span><br><span class="line">|  6 | zhangshan   |   20 |</span><br><span class="line">|  7 | lisi        |   50 |</span><br><span class="line">|  8 | chenshuo    |   10 |</span><br><span class="line">|  9 | wangwu      |    3 |</span><br><span class="line">| 10 | qiuyi       |   15 |</span><br><span class="line">| 11 | qiuxiaotian |   20 |</span><br><span class="line">+----+-------------+------+</span><br><span class="line">11 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure><h5 id="5-以age字段降序排序"><a href="#5-以age字段降序排序" class="headerlink" title="5.以age字段降序排序"></a>5.以age字段降序排序</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT * FROM student ORDER BY age DESC;</span><br><span class="line">+----+-------------+------+</span><br><span class="line">| id | name        | age  |</span><br><span class="line">+----+-------------+------+</span><br><span class="line">|  7 | lisi        |   50 |</span><br><span class="line">|  4 | sean        |   28 |</span><br><span class="line">|  5 | zhangshan   |   26 |</span><br><span class="line">|  3 | wangqing    |   25 |</span><br><span class="line">|  2 | jerry       |   23 |</span><br><span class="line">|  1 | tom         |   20 |</span><br><span class="line">|  6 | zhangshan   |   20 |</span><br><span class="line">| 11 | qiuxiaotian |   20 |</span><br><span class="line">| 10 | qiuyi       |   15 |</span><br><span class="line">|  8 | chenshuo    |   10 |</span><br><span class="line">|  9 | wangwu      |    3 |</span><br><span class="line">+----+-------------+------+</span><br><span class="line">11 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure><h5 id="6-查询student表中年龄最小的3位同学"><a href="#6-查询student表中年龄最小的3位同学" class="headerlink" title="6.查询student表中年龄最小的3位同学"></a>6.查询student表中年龄最小的3位同学</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT * FROM student ORDER BY age LIMIT 3;</span><br><span class="line">+----+----------+------+</span><br><span class="line">| id | name     | age  |</span><br><span class="line">+----+----------+------+</span><br><span class="line">|  9 | wangwu   |    3 |</span><br><span class="line">|  8 | chenshuo |   10 |</span><br><span class="line">| 10 | qiuyi    |   15 |</span><br><span class="line">+----+----------+------+</span><br><span class="line">3 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure><h5 id="7-查询student表中年龄最大的4位同学"><a href="#7-查询student表中年龄最大的4位同学" class="headerlink" title="7.查询student表中年龄最大的4位同学"></a>7.查询student表中年龄最大的4位同学</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT * FROM student ORDER BY age DESC LIMIT 4;</span><br><span class="line">+----+-----------+------+</span><br><span class="line">| id | name      | age  |</span><br><span class="line">+----+-----------+------+</span><br><span class="line">|  7 | lisi      |   50 |</span><br><span class="line">|  4 | sean      |   28 |</span><br><span class="line">|  5 | zhangshan |   26 |</span><br><span class="line">|  3 | wangqing  |   25 |</span><br><span class="line">+----+-----------+------+</span><br><span class="line">4 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure><h5 id="8-查询student表中名字叫zhangshan的记录"><a href="#8-查询student表中名字叫zhangshan的记录" class="headerlink" title="8.查询student表中名字叫zhangshan的记录"></a>8.查询student表中名字叫zhangshan的记录</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT * FROM student WHERE name = &apos;zhangshan&apos;;</span><br><span class="line">+----+-----------+------+</span><br><span class="line">| id | name      | age  |</span><br><span class="line">+----+-----------+------+</span><br><span class="line">|  5 | zhangshan |   26 |</span><br><span class="line">|  6 | zhangshan |   20 |</span><br><span class="line">+----+-----------+------+</span><br><span class="line">2 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure><h5 id="9-查询student表中名字叫zhangshan且年龄大于20岁的记录"><a href="#9-查询student表中名字叫zhangshan且年龄大于20岁的记录" class="headerlink" title="9.查询student表中名字叫zhangshan且年龄大于20岁的记录"></a>9.查询student表中名字叫zhangshan且年龄大于20岁的记录</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT * FROM student WHERE name = &apos;zhangshan&apos; AND age &gt; 20;</span><br><span class="line">+----+-----------+------+</span><br><span class="line">| id | name      | age  |</span><br><span class="line">+----+-----------+------+</span><br><span class="line">|  5 | zhangshan |   26 |</span><br><span class="line">+----+-----------+------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure><h5 id="10-查询student表中年龄在23到30之间的记录"><a href="#10-查询student表中年龄在23到30之间的记录" class="headerlink" title="10.查询student表中年龄在23到30之间的记录"></a>10.查询student表中年龄在23到30之间的记录</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT * FROM student WHERE age BETWEEN 23 AND 30;</span><br><span class="line">+----+-----------+------+</span><br><span class="line">| id | name      | age  |</span><br><span class="line">+----+-----------+------+</span><br><span class="line">|  3 | wangqing  |   25 |</span><br><span class="line">|  4 | sean      |   28 |</span><br><span class="line">|  5 | zhangshan |   26 |</span><br><span class="line">+----+-----------+------+</span><br><span class="line">3 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure><h5 id="11-修改wangwu的年龄为100"><a href="#11-修改wangwu的年龄为100" class="headerlink" title="11.修改wangwu的年龄为100"></a>11.修改wangwu的年龄为100</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; UPDATE student SET age = 100 WHERE name = &apos;wangwu&apos;;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line">Rows matched: 1  Changed: 1  Warnings: 0</span><br><span class="line"></span><br><span class="line">mysql&gt; SELECT * FROM student;</span><br><span class="line">+----+-------------+------+</span><br><span class="line">| id | name        | age  |</span><br><span class="line">+----+-------------+------+</span><br><span class="line">|  1 | tom         |   20 |</span><br><span class="line">|  2 | jerry       |   23 |</span><br><span class="line">|  3 | wangqing    |   25 |</span><br><span class="line">|  4 | sean        |   28 |</span><br><span class="line">|  5 | zhangshan   |   26 |</span><br><span class="line">|  6 | zhangshan   |   20 |</span><br><span class="line">|  7 | lisi        |   50 |</span><br><span class="line">|  8 | chenshuo    |   10 |</span><br><span class="line">|  9 | wangwu      |  100 |</span><br><span class="line">| 10 | qiuyi       |   15 |</span><br><span class="line">| 11 | qiuxiaotian |   20 |</span><br><span class="line">+----+-------------+------+</span><br><span class="line">11 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure><h5 id="12-删除student中名字叫zhangshan且年龄小于等于20的记录"><a href="#12-删除student中名字叫zhangshan且年龄小于等于20的记录" class="headerlink" title="12.删除student中名字叫zhangshan且年龄小于等于20的记录"></a>12.删除student中名字叫zhangshan且年龄小于等于20的记录</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; DELETE FROM student WHERE name = &apos;zhangshan&apos; AND age &lt;= 20;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; SELECT * FROM student;</span><br><span class="line">+----+-------------+------+</span><br><span class="line">| id | name        | age  |</span><br><span class="line">+----+-------------+------+</span><br><span class="line">|  1 | tom         |   20 |</span><br><span class="line">|  2 | jerry       |   23 |</span><br><span class="line">|  3 | wangqing    |   25 |</span><br><span class="line">|  4 | sean        |   28 |</span><br><span class="line">|  5 | zhangshan   |   26 |</span><br><span class="line">|  7 | lisi        |   50 |</span><br><span class="line">|  8 | chenshuo    |   10 |</span><br><span class="line">|  9 | wangwu      |  100 |</span><br><span class="line">| 10 | qiuyi       |   15 |</span><br><span class="line">| 11 | qiuxiaotian |   20 |</span><br><span class="line">+----+-------------+------+</span><br><span class="line">10 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;a id=&quot;more&quot;&gt;&lt;/a&gt;

&lt;h1 id=&quot;1-关系型数据库介绍&quot;&gt;&lt;a href=&quot;#1-关系型数据库介绍&quot; class=&quot;headerlink&quot; title=&quot;1. 关系型数据库介绍&quot;&gt;&lt;/a&gt;1. 关系型数据库介绍&lt;/h1&gt;&lt;h3 id=&quot;1-1-数据结构模型&quot;&gt;
      
    
    </summary>
    
      <category term="Linux运维" scheme="http://aiwhs.github.io/categories/Linux%E8%BF%90%E7%BB%B4/"/>
    
    
      <category term="sql" scheme="http://aiwhs.github.io/tags/sql/"/>
    
  </entry>
  
</feed>
